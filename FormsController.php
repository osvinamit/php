<?php
class FormsController extends Zend_Controller_Action{
	
	public function init(){	
		global $systemusers;
		$this->SuperModel= new Application_Model_SuperModel();
		$this->view->SuperModel= new Application_Model_SuperModel();
		$this->modelEmail = new Application_Model_Email();
		$this->_helper->layout->setLayout('agent_dashboard_layout');
		if($this->view->user){
			$Front_User = Zend_Session::namespaceGet(DEFAULT_AUTH_NAMESPACE);
			$Front_User['storage']->visiting_user_id=$this->view->user->agency_id;
		}
		global $healthSession;
		if($this->view->user->agency_user_type!="Agency" && !in_array($this->view->user->agency_user_type,$systemusers)){
		   $healthSession->errorMsg="You don't have permission to access this page.";
		   $this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		if($this->view->current_action!="getincidentreport" && $this->view->current_action!="incidentreport" && $this->view->current_action!="formlist" && $this->view->current_action!="getformlist" && $this->view->current_action!="getnewform" && $this->view->current_action!="savenewform" && $this->view->current_action!="savefooddocument" && $this->view->current_action!="checktimerecord" && $this->view->current_action!="savegroceriesdocument" && $this->view->current_action!="digestlist" && $this->view->current_action!="getdigestlists" && $this->view->current_action!="adddailyactvity" && $this->view->current_action!="savedailyactivity" && $this->view->current_action!="viewdailyactivity" && $this->view->current_action!="getdailyactivity" && $this->view->current_action!="removedailyactivity" && $this->view->current_action!="adddad" && $this->view->current_action!="savedad" && $this->view->current_action!="viewdad" && $this->view->current_action!="getdad" && $this->view->current_action!="removedad" && $this->view->current_action!="addcarinspection" && $this->view->current_action!="savecarinspection" && $this->view->current_action!="viewcarinspection" && $this->view->current_action!="removecarinspection" && $this->view->current_action!="getcarinspection" && $this->view->current_action!="editvehicle" && $this->view->current_action!="removevehicle" && $this->view->current_action!="getvehicles" && $this->view->current_action!="vehicles" && $this->view->current_action!="addvehicle" && $this->view->current_action!="saverecordatrip" && $this->view->current_action!="removerecordatrip" && $this->view->current_action!="getrecordsatrip" && $this->view->current_action!="addrecordatrip" && $this->view->current_action!="recordatrip" && $this->view->current_action!="clockin" && $this->view->current_action!="clockout" && $this->view->current_action!="saveclockin" && $this->view->current_action!="grouptimingsheets" && $this->view->current_action!="getgroputimingsheets" && $this->view->current_action!="removegrouptimingsheets" && $this->view->current_action!="grouptimingsheetreport" && $this->view->current_action!="incidenttrendreport" && $this->view->current_action!="getincidenttrendreport" && $this->view->current_action!="incidenttrendreportexport" && $this->view->current_action!="incidenttrendreportprint" && $this->view->current_action!="incidenttrendreportemailform" && $this->view->current_action!="sendincidenttrendreportemail" && $this->view->current_action!="gettaskdata" && $this->view->current_action!="incidenttrendreportcommentform" && $this->view->current_action!="saveincidenttrendreportcomment" && $this->view->current_action!="getincidenttrendreportfilter" && $this->view->current_action!="getincidenttrendreportfilterdivdata" && $this->view->current_action!="getincidenttrendreportcomment" && $this->view->current_action!="getdad" && $this->view->current_action!="removedad" && $this->view->current_action!="getalldad" && $this->view->current_action!="viewalldad" && $this->view->current_action!="dadreports" && $this->view->current_action!="dailyactivityreport" && $this->view->current_action!="vehicleinspectionreports" && $this->view->current_action!="ratreports" && $this->view->current_action!="recordatripreports" && $this->view->current_action!="viewallrecordatrip" && $this->view->current_action!="getrecordatrip"){ 
			$indid=$this->_getParam("indid");
			if(empty($indid)){
				$healthSession->errorMsg="Invalid Access";
				$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
			}
			$indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
			if(empty($indData)){
				$healthSession->errorMsg="No Individual Found.";
				$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
			}
			$permissions=isSharedModule("individual",$this->view->user->agency_id);
			$dataArr=explode(",",$permissions);
			if((empty($permissions) || !in_array($indData['agency_id'],$dataArr)) && $indData['agency_user_agency_id']!=$this->view->user->agency_id){
				$healthSession->errorMsg="You don't have permission to access this page.";
				$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");	
			}
		}
		
		$actionsArr=array("clockin"=>"clockin");
		$indParentUsers="";
		if($this->view->user->agency_user_type=="Agency"){
			$systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_id,"fetchAll",array("fields"=>"agency_id"));
			$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
			$indParentUsers=implode_r(",",$systemUsers);
			if($this->view->user->agency_user_agency_id!=0){
				$sharedUsers=isSharedModule("individual");
				if(!empty($sharedUsers)){
					$indParentUsers.=$this->view->user->agency_id.",".$sharedUsers;
				}
			}
		}
		else{
			$sharedUsers=isSharedModule("individual");
			if(!empty($sharedUsers)){
				$indParentUsers.=$this->view->user->agency_id.",".$sharedUsers;
			}
			else{
				$indParentUsers=$this->view->user->agency_id;
			}
			$statusWhere.="  and agency_status='1' "; 
		}
		
		$individual=$this->SuperModel->Super_Get("_uhs_agency","(agency_user_agency_id IN(".$indParentUsers.") OR agency_id IN(".$indParentUsers.")) and agency_user_type='Individual'","fetchAll");		
                if(in_array($this->view->current_action,$actionsArr) && empty($individual)){
		   global $healthSession;
		   $healthSession->errorMsg="No Individual Found.";
		   $this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
  	}
	
	public function indexAction(){
		global $healthSession; 
		if($this->view->user->agency_user_type!="Agency"){
			$healthSession->errorMsg="You don't have permission to access this page.";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
  		$this->view->pageHeading = "Assign Forms To";
		$indid=$this->_getParam("indid");
		if(empty($indid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		$indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
		if(empty($indData)){
			$healthSession->errorMsg="No Individual Found.";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		// print_r(this->view->indData);die;
                
                $isExists=$this->SuperModel->Super_Get("_uhs_xoomia_services","service_indid_id=".$indid." and service_code='ads' and service_added_user_id=".$this->view->user->subuser_id,"fetch");
                if(!empty($isExists)){
                    $ads_check_val=1;
                } else {
                    $ads_check_val=0;
                }
                $isExistNmtRec=$this->SuperModel->Super_Get("_uhs_xoomia_services","service_indid_id=".$indid." and service_code='nmt' and service_added_user_id=".$this->view->user->subuser_id,"fetch");
                if(!empty($isExistNmtRec)){
                    $nmt_check_val=1;
                } else {
                    $nmt_check_val=0;
                }
		$this->view->indData=$indData;
		$this->view->indid=$indid;
		$this->view->type=$this->view->user->agency_user_type;
                $this->view->ads_check_val=$ads_check_val;
                $this->view->nmt_check_val=$nmt_check_val;
                $this->view->show_more_val=$this->_getParam("show_more_val");
                
               
  	}
	
	//Form Library
	public function formlistAction(){
		global $healthSession; 
		if($this->view->user->agency_user_type!="Agency"){
			$healthSession->errorMsg="You don't have permission to access this page.";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
  		$this->view->pageHeading = "Forms Library";
  	}
	
	public function getformlistAction(){
		if(check_is_ajax($this->_request)){
			$this->_redirect(APPLICATION_URL);
		}
 		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('form_id','form_number','form_title');
		$sIndexColumn = 'form_id';
		$sTable = '_uhs_agency_forms';
		$sLimit = "";
		if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' ){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		if ( isset( $_GET['iSortCol_0'] ) )
		{
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
			{
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
				{
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
 		$qry = $this->dbObj->query($sQuery)->fetchAll();
		$sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
		$output = array(
 				"iTotalRecords" => $iTotal,
				"iTotalDisplayRecords" => $iFilteredTotal,
				"aaData" => array()
			);
		$j=0;
		foreach($qry as $row1){
			$row=array();
 			$row[] = $j+1;
		    $row[]=ucwords($row1['form_number']); 
  			$row[]=ucwords($row1['form_title']);
 			$output['aaData'][] = $row;
			$j++;
		}
		echo json_encode($output);
		exit();
	}
	
	public function getnewformAction(){
		global $healthSession;
		if(check_is_ajax($this->_request) || $this->view->user->agency_user_type!="Agency"){
			$this->_redirect(APPLICATION_URL);
		}
		$form=new Application_Form_Agency();
		$form->formLibrary();
		$userArr=array("agency_name"=>$this->view->user->agency_first_name." ".$this->view->user->agency_last_name,"provider_name"=>$this->view->user->agency_company_name,"agency_number"=>$this->view->user->agency_contact);
		$form->populate($userArr);
		echo "Submit Your Form "."~~".$form;
		exit();
	}
	
	public function savenewformAction(){
		global $healthSession;
		$form=new Application_Form_Agency();
		$form->formLibrary();
		if($this->getRequest()->isPost()){
			$posted_data = $this->getRequest()->getPost();
			unset($posted_data['btnsubmit']);
			unset($posted_data['MAX_FILE_SIZE']);
			if($form->isValid($posted_data)){
				$is_uploaded = $this->_handle_newform_document();
				unset($posted_data['agency_name']);
				unset($posted_data['agency_number']);
				unset($posted_data['provider_name']);
				$posted_data['freq_agency_id']=$this->view->user->agency_id;
				$posted_data['freq_uploaded_date']=date("Y-m-d H:i:s");
				if(count($is_uploaded->media_path)>0){
					$posted_data['freq_uploaded_form']=$is_uploaded->media_path;
				}
				$isIns=$this->SuperModel->Super_Insert("_uhs_forms_requests",$posted_data);
				if($isIns->success){
					$healthSession->successMsg="Your form has been submitted successfully.";
			    	$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_forms_library");
				}
			}
			else{
				$healthSession->errorMsg="Please check information again.";
			}	
	    }
		exit();
	}

   // Get Diffrent Forms & Assigned to Individuals
	public function getformsAction(){
		if(check_is_ajax($this->_request)){
			$this->_redirect(APPLICATION_URL);
		}
		// echo"<pre>";print_r($this->indi_data);die;
		$indid=$this->_getParam("indid");
		$ads_check_val=$this->_getParam("ads_check_val");
		$nmt_check_val=$this->_getParam("nmt_check_val");
		$show_more_val=$this->_getParam("show_more_val");
               // prd($nmt_check_val);
		//$service_type=$this->_getParam("type");
                //prd($indid);
 		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('form_id','form_number','form_title');
		$sIndexColumn = 'form_id';
		$sTable = '_uhs_agency_forms';
		$sLimit = "";
		if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' ){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "ORDER BY form_id";
		if ( isset( $_GET['iSortCol_0'] ) )
		{
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
			{
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
				{
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
 		$qry = $this->dbObj->query($sQuery)->fetchAll();
                //prd($qry);
		$sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
		$output = array(
 				"iTotalRecords" => $iTotal,
				"iTotalDisplayRecords" => $iFilteredTotal,
				"aaData" => array()
			);
		$j=0;
                $index=0;
                $indexnmt=0;
		foreach($qry as $row1){
			$text='"Assign Form To Individual First"';
			$mileClass=$viewLink=$notify="";
			$checkClass=""; $href="javascript:void(1);";$onclickText="onClick='showCustomAlert(".$text.")';";
			$assignedForms=$this->SuperModel->Super_Get("_uhs_individual_assigned_forms","assigned_form_id=".$row1['form_id']." and form_individual_id=".$indid,"fetch");
			$clickBtn=""; $href="javascript:void(1);";
                        if($row1['form_number'] == "DD 103" || $row1['form_number']== "DD 123" || $row1['form_number']== "DD 125" || $row1['form_number'] == "DD 52" || $row1['form_number'] == "DD 53") {
                            continue;
                        }
			if(!empty($assignedForms)){ 
				$checkClass="checked=true"; 
				if($row1['form_number']=="DD 114" || $row1['form_number']=="DD 116" || $row1['form_number']=="DD 118" || $row1['form_number']=="DD 120" || $row1['form_number']=="DD 128" || $row1['form_number']=="DD 106" || $row1['form_number']=="DD 122" || $row1['form_number']=="DD 126" || $row1['form_number']=="DD 144"){
					$clickBtn=getFormLinks($row1['form_id'],$indid,"Add",true);
				}
				else if($row1['form_number']=="DD 108"){
					$getAssignedMileage=$this->SuperModel->Super_Get("_uhs_assigned_miles","m_form_id=".$row1['form_id']." and m_individual_id=".$indid,"fetch",array("order"=>"mid DESC"));
					if(empty($getAssignedMileage)){
						$notify="&nbsp;<span class='badge badge-danger badge_pulsate pull-right'>Miles not assigned yet </span>";
					}
					$type='"AssignedMileage"';
					$nullVal='""';
					$clickBtn="OnClick='showDiffrentForms(".$indid.",".$row1['form_id'].",".$nullVal.",".$type.");'";
					$viewLink="<a href='".APPLICATION_URL."/view-assigned-mileage/".$indid."/".$row1['form_id']."' style='margin-top:5px;' class='btn btn-xs btn-default'>View Miles Assigned</a>&nbsp;";
				}
				else if($row1['form_number']=="DD 112"){
					
					$getAssignedBalance=$this->SuperModel->Super_Get("_uhs_financial_initial_balance","balance_form_id=".$row1['form_id']." and balance_individual_id=".$indid,"fetch",array("order"=>"balance_id DESC"));
					if(empty($getAssignedBalance)){
						$notify="&nbsp;<span class='badge badge-danger badge_pulsate pull-right'>Initial Balance is not setup yet.</span>";
					}
					$type='"AssignedCredit"';
					$nullVal='""';
					$clickBtn="OnClick='showDiffrentForms(".$indid.",".$row1['form_id'].",".$nullVal.",".$type.");'";
					$viewLink="<a href='".APPLICATION_URL."/view-assigned-balance/".$indid."/".$row1['form_id']."' style='margin-top:5px;' class='btn btn-xs btn-default'>View Accounts Balance</a>&nbsp;";
				}
				else if($row1['form_number']=="DD 124"){
					$getAssignedBalance=$this->SuperModel->Super_Get("_uhs_food_initial_balance","fb_form_id=".$row1['form_id']." and fb_individual_id=".$indid,"fetch",array("order"=>"fbid DESC"));
					if(empty($getAssignedBalance)){
						$notify="&nbsp;<span class='badge badge-danger badge_pulsate pull-right'>Initial Balance is not setup yet.</span>";
					}
					$type='"AssignedFoodBalance"';
					$nullVal='""';
					$clickBtn="OnClick='showDiffrentForms(".$indid.",".$row1['form_id'].",".$nullVal.",".$type.");'";
					$viewLink="<a href='".APPLICATION_URL."/view-assigned-food-balance/".$indid."/".$row1['form_id']."' style='margin-top:5px;' class='btn btn-xs btn-default'>View Intial Balance</a>&nbsp;";
				}
				else if($row1['form_number']=="DD 138"){
					$getAssignedGroceriesBalance=$this->SuperModel->Super_Get("_uhs_groceries_initial_balance","gr_form_id=".$row1['form_id']." and gr_individual_id=".$indid,"fetch",array("order"=>"grid DESC"));
					if(empty($getAssignedGroceriesBalance)){
						$notify="&nbsp;<span class='badge badge-danger badge_pulsate pull-right'>Initial Balance is not setup yet.</span>";
					}
					$type='"AssignedGroceriesBalance"';
					$nullVal='""';
					$clickBtn="OnClick='showDiffrentForms(".$indid.",".$row1['form_id'].",".$nullVal.",".$type.");'";
					$viewLink="<a href='".APPLICATION_URL."/view-assigned-groceries-balance/".$indid."/".$row1['form_id']."' style='margin-top:5px;' class='btn btn-xs btn-default'>View Intial Balance</a>&nbsp;";
				}
				else{
					$href=getFormLinks($row1['form_id'],$indid,"Add");
                                if($row1['form_number']=="DD 132"){

					$viewLink="<a href='".APPLICATION_URL."/edit-behavoir-supports/".$indid."/".$row1['form_id']."' style='margin-top:5px;' class='btn btn-xs btn-default'>Edit Log</a>&nbsp;";

					}
				}

				if ($row1['form_number'] == "DD 104") {
                                    $viewLink = "<a href='" . APPLICATION_URL . "/calender-view/" . $indid . "/" . $row1['form_id'] . "' style='margin-top:5px;' class='btn btn-xs btn-default'>Calendar View</a>&nbsp;";
                                }
				$onclickText="";
                        }else{
//                            if($row1['form_number'] == "DD 103" || $row1['form_number']== "DD 123" || $row1['form_number']== "DD 125") {
//                                if(empty($ads_check_val)){
//                                    continue;
//                                }
//                            } else if($row1['form_number'] == "DD 52" || $row1['form_number']== "DD 53"){
//                                if(empty($nmt_check_val)){
//                                    continue;
//                                }
//                            } else {
//                                if(empty($show_more_val)){
//                                    continue;
//                                }
//                            }
                            if(empty($show_more_val)){
                                continue;
                            }
                         }
                        
			$row=array();
//                        $clsads="";
//                        $clsnmt="";
//                        $clsadschk="";
//                        $clsnmtchk="";
                            $xoomia_show_more_form="xoomia_show_more_form";
//                        if($row1['form_number'] == "DD 103" || $row1['form_number']== "DD 123" || $row1['form_number']== "DD 125"){
//                            if(empty($ads_check_val)){
//                                continue;
//                            }
//                            $index++;
//                            if($index == 1){
//                                $clsads="clsads";
//                            }
//                            $xoomia_show_more_form="";
//                            $clsadschk="clsadschk";
//                        }
//                        if($row1['form_number'] == "DD 52" || $row1['form_number']== "DD 53"){
//                            if(empty($nmt_check_val)){
//                                continue;
//                            }
//                            $indexnmt++;
//                            if($indexnmt == 1){
//                                $clsnmt="clsnmt";
//                            }
//                            $xoomia_show_more_form="";
//                            $clsnmtchk="clsnmtchk";
//                        }
 			$row[] = $j+1;
			$row[]='<input class="elem_ids checkboxes '.$xoomia_show_more_form.' " '.$checkClass.' type="checkbox" name="'.$sTable.'['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'" id="formid_'.$row1[$sIndexColumn].'">';
                        $row[]=ucwords($row1['form_number']); 
  			$row[]=ucwords($row1['form_title']).$notify;
                        
                        
                        
                        
                        
			if($row1['form_number'] == "DD 106") {
                            $linkText = "Clock In";
                        }
                        else {
                            $linkText = "Add New";
                        }
			if($row1['form_number']=="DD 104" || $row1['form_number']=="DD 110" || $row1['form_number']=="DD 130"){
				$linkText="Add Support";
			}
			if($row1['form_number']=="DD 108"){
				$linkText="Add Initial Mileage";
			}

			if($row1['form_number']=="DD 100"){
				$linkText="Add ISP";
			}
//                        if($row1['form_number']=="DD 103"){
//				$linkText="Add Daily Activity Documentation";
//			}
//			if($row1['form_number']=="DD 123"){
//				$linkText="Add Daily Activity";
//			}
//                        if($row1['form_number']=="DD 52"){
//				$linkText="Vehicle Inspection";
//			}
//			if($row1['form_number']=="DD 53"){
//				$linkText="Record a trip";
//			}

			if($row1['form_number']=="DD 124" || $row1['form_number']=="DD 138"){
				$linkText="Add Initial Balance";
			}

			if($row1['form_number']=="DD 112"){
				$linkText="Add Credit";
			}
           
			$agency_id = $_SESSION['UHS_AUTH']['storage']->agency_id;
                        $indid = $indid;
                        $check_view = $this->SuperModel->Super_Get("_uhs_caregiver_view", "agency_id=$agency_id AND indid=$indid AND is_ads=0", "fetch");

                        if($check_view) {
                            $view_id = $check_view['view_id'];
                            $list_view = $check_view['caregiver_view'] == 1 ? 'selected' : '';
                            $calendar_view = $check_view['caregiver_view'] == 2 ? 'selected' : '';
                        }
                        else {
                            $view_id = '';
                            $list_view = '';
                            $calendar_view = '';
                        }

			if($row1['form_number'] == "DD 104") {
				$caregiver_view = "<span class='caregiver-view-wrapper'>"
                        . "<select name='if-cgsv' id='' class='if-caregiver-view'>"
                        . "<option value=''>Set caregiver view</option>"
                        . "<option value='1' $list_view>List</option>"
                        . "<option value='2' $calendar_view>Calendar</option>"
                        . "</select>"
                        . "<input id='caregiver-view-id' type='hidden' value='".$view_id."'>"
                        . "</span>";
				$row[] = "<a href='" . $href . "' " . $onclickText . " " . $clickBtn . " " . $mileClass . " class='btn btn-xs btn-default' style='margin-top:5px;'>" . $linkText . "</a> &nbsp; " . $viewLink . " <a href='" . getFormLinks($row1['form_id'], $indid, "View") . "' class='btn btn-xs btn-default' style='margin-top:5px;'>Listing View</a>".$caregiver_view;
			}
			elseif ($row1['form_number'] == "DD 136") {
                            $add_url = APPLICATION_URL . "/add-outcome-form/" . $indid . "/" . $row1['form_id'];
                            //$view_url = APPLICATION_URL . "/outcome-log/" . $indid . "/" . $row1['form_id'];
                            $view_url = APPLICATION_URL . "/record-outcome-log-view/" . $indid . "/" . $row1['form_id'];
                            $add_record_outcome_actions_url = APPLICATION_URL . "/add-outcome-form/" . $indid . "/" . $row1['form_id'];
                            $row[] = "<a href='" . $add_url . "' class='btn btn-xs btn-default' style='margin-top:5px;'>Create Outcome</a> &nbsp; " . $viewLink . " <a href='" . $view_url . "' class='btn btn-xs btn-default' style='margin-top:5px;'>View Logs</a>&nbsp;&nbsp; <a href='" . $add_record_outcome_actions_url . "' class='btn btn-xs btn-default' style='margin-top:5px;'>Record Outcome Actions</a>";
                        }
			elseif($row1['form_number'] !="DD 100"){
				if($row1['form_number'] == "DD 106") {
					if($this->view->user->agency_user_type=="Agency"){
						$type='"TimingSheet"';
						$formid=3;
						$agency_id= $this->view->user->agency_id;
						if($this->view->user->is_subuser == 1){
							$agency_id= $this->view->user->agency_user_agency_id;
						}
						$rec = $this->SuperModel->Super_Get("_uhs_timing_sheets","service_individual_id='".$indid."' and service_agency_id='".$agency_id."' and service_added_user='".$this->view->user->agency_id."' and service_type != 'Group'","fetch",array("order"=>"sheet_id DESC",'limit'=>1));
						//prd($rec);
						$sheet_id=-1;
						if(!empty($rec)){
						   $sheet_id = $rec['sheet_id'];
					     } 
				          $editLink="<a style='margin-top:5px;' href='javascript:void(1);' onclick='showDiffrentForms(".$indid.",".$formid.",".$sheet_id.",".$type.");' class='btn btn-xs red'>Clock Out</a>";
			           }
					$row[]="<a href='".$href."' ".$onclickText." ".$clickBtn." ".$mileClass." class='btn btn-xs btn-default clock-in-green-btn' style='margin-top:5px;'>".$linkText."</a> &nbsp; ".$editLink."&nbsp;".$viewLink." <a href='".getFormLinks($row1['form_id'],$indid,"View")."' class='btn btn-xs btn-default' style='margin-top:5px;'>View Logs</a>";
                                }elseif($row1['form_number'] == "DD 108"){
                                        if(!empty($viewLink)){
                                            $url = APPLICATION_URL."/add-initial-mileage/".$indid."/".$row1['form_id']."/"."0"."/"."AssignedMileage";
                                            $row[]="<a href='".$url."' ".$clickBtn." ".$mileClass." class='btn btn-xs btn-default' style='margin-top:5px;'>".$linkText."</a> &nbsp; ".$viewLink." <a href='".getFormLinks($row1['form_id'],$indid,"View")."' class='btn btn-xs btn-default' style='margin-top:5px;'>View Logs</a>";
                                        }else{
                                            $row[]="<a href='".$href."' ".$onclickText." ".$clickBtn." ".$mileClass." class='btn btn-xs btn-default' style='margin-top:5px;'>".$linkText."</a> &nbsp; ".$viewLink." <a href='".getFormLinks($row1['form_id'],$indid,"View")."' class='btn btn-xs btn-default' style='margin-top:5px;'>View Logs</a>";
                                        }
                                
                                } elseif($row1['form_number'] == "DD 112"){
                                    $user_type=$this->view->user->agency_user_type;
                                    if($user_type=='Staff'||$user_type=='Guardians'||$user_type=='SupportAdministrators'|| $user_type=='HealthcareProfessional' ){
                                	 $type='"Financial"';
					                 $nullVal='""';
					                 $clickBtn="OnClick='showDiffrentForms(".$indid.",".$row1['form_id'].",".$nullVal.",".$type.");'";
                                	 $row[]="<a href='javascript:void(1);' ".$clickBtn." class='btn btn-xs btn-default' style='margin-top:5px;'>Add New Transaction </a> &nbsp;<a href='".getFormLinks($row1['form_id'],$indid,"View")."' class='btn btn-xs btn-default' style='margin-top:5px;'>View Transactions</a>";	

                                	} 
                                	else{
                                		
                                		$row[]="<a href='".$href."' ".$onclickText." ".$clickBtn." ".$mileClass." class='btn btn-xs btn-default' style='margin-top:5px;'>".$linkText."</a> &nbsp; ".$viewLink." <a href='".getFormLinks($row1['form_id'],$indid,"View")."' class='btn btn-xs btn-default' style='margin-top:5px;'>View Transactions</a>";
                                	}
                                }else {
//                                    if($row1['form_number'] == "DD 103" || $row1['form_number']== "DD 123" || $row1['form_number']== "DD 52" || $row1['form_number']== "DD 53"){
//                                        
//                                        $row[]="<a href='".getFormLinks($row1['form_id'],$indid,"View")."' class='btn btn-xs btn-default' style='margin-top:5px;'>View Logs</a>";
//                                        
//                                    } else {
                                            $row[]="<a href='".$href."' ".$onclickText." ".$clickBtn." ".$mileClass." class='btn btn-xs btn-default' style='margin-top:5px;'>".$linkText."</a> &nbsp; ".$viewLink." <a href='".getFormLinks($row1['form_id'],$indid,"View")."' class='btn btn-xs btn-default' style='margin-top:5px;'>View Logs</a>";
                                   //}
                                }
			} else {

				$row[]="<a href='".$href."' ".$onclickText." ".$clickBtn." ".$mileClass." class='btn btn-xs btn-default' style='margin-top:5px;'>".$linkText."</a> &nbsp; ".$viewLink." <a href='".getFormLinks($row1['form_id'],$indid,"View")."' class='btn btn-xs btn-default' style='margin-top:5px;'>Read ISP</a>";
			}


 			$output['aaData'][] = $row;
			$j++;
		}
                
                //////////////// ads
                
                
                foreach($qry as $row1){
			$text='"Assign Form To Individual First"';
			$mileClass=$viewLink=$notify="";
			$checkClass=""; $href="javascript:void(1);";$onclickText="onClick='showCustomAlert(".$text.")';";
			$assignedForms=$this->SuperModel->Super_Get("_uhs_individual_assigned_forms","assigned_form_id=".$row1['form_id']." and form_individual_id=".$indid,"fetch");
			$clickBtn=""; $href="javascript:void(1);";
			if($row1['form_number'] == "DD 103" || $row1['form_number']== "DD 123" || $row1['form_number']== "DD 125"||$row1['form_number'] == "DD 136") {
                        } else {
                            continue;
                        }
                        if(!empty($assignedForms)){ 
				$checkClass="checked=true"; 
                                $href=getFormLinks($row1['form_id'],$indid,"Add");
                                if ($row1['form_number'] == "DD 125") {
                                    $viewLink = "<a href='" . APPLICATION_URL . "/calender-view/" . $indid . "/" . $row1['form_id'] . "' style='margin-top:5px;' class='btn btn-xs btn-default'>Calendar View</a>&nbsp;";
                                }
				$onclickText="";
                        }else{
                            if($row1['form_number'] == "DD 103" || $row1['form_number']== "DD 123" || $row1['form_number']== "DD 125") {
                                if(empty($ads_check_val)){
                                    continue;
                                }
                            } else {
                                if(empty($show_more_val)){
                                    continue;
                                }
                            }
                         }
                        
			$row=array();
                        $clsads="";
                        $clsnmt="";
                        $clsadschk="";
                        $clsnmtchk="";
                        $xoomia_show_more_form="xoomia_show_more_form";
                        if($row1['form_number'] == "DD 103" || $row1['form_number']== "DD 123" || $row1['form_number']== "DD 125"||$row1['form_number'] == "DD 136"){
                            if(empty($ads_check_val)){
                                continue;
                            }
                            $index++;
                            if($index == 1){
                                $clsads="clsads";
                            }
                            $xoomia_show_more_form="";
                            $clsadschk="clsadschk";
                        }
                        
 			$row[] = $j;
			$row[]='<input class="elem_ids checkboxes '.$xoomia_show_more_form.' '.$clsads.' '.$clsadschk.'" '.$checkClass.' type="checkbox" name="'.$sTable.'['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'" id="formid_'.$row1[$sIndexColumn].'">';
                        $row[]=ucwords($row1['form_number']); 
  			$row[]=ucwords($row1['form_title']).$notify;
                        
                        if($row1['form_number']=="DD 103"){
				$linkText="Add Group Activity Documentation";
			}
			if($row1['form_number']=="DD 123"){
				$linkText="Add List of Activity";
			}
                        if($row1['form_number']=="DD 125"){
				$linkText="Add Support";
			}
			
                        $agency_id = $_SESSION['UHS_AUTH']['storage']->agency_id;
                        $indid = $indid;
                        $check_view = $this->SuperModel->Super_Get("_uhs_caregiver_view", "agency_id=$agency_id AND indid=$indid AND is_ads=1", "fetch");

                        if($check_view) {
                            $view_id = $check_view['view_id'];
                            $list_view = $check_view['caregiver_view'] == 1 ? 'selected' : '';
                            $calendar_view = $check_view['caregiver_view'] == 2 ? 'selected' : '';
                        }
                        else {
                            $view_id = '';
                            $list_view = '';
                            $calendar_view = '';
                        }

			if($row1['form_number'] == "DD 125") {
			$caregiver_view = "<span class='caregiver-view-wrapper'>"
                        . "<select name='if-cgsv' id='' class='if-caregiver-view-ads'>"
                        . "<option value=''>Set caregiver view</option>"
                        . "<option value='1' $list_view>List</option>"
                        . "<option value='2' $calendar_view>Calendar</option>"
                        . "</select>"
                        . "<input id='caregiver-view-id-ads' type='hidden' value='".$view_id."'>"
                        . "</span>";
				$row[] = "<a href='" . $href . "' " . $onclickText . " " . $clickBtn . " " . $mileClass . " class='btn btn-xs btn-default' style='margin-top:5px;'>" . $linkText . "</a> &nbsp; " . $viewLink . " <a href='" . getFormLinks($row1['form_id'], $indid, "View") . "' class='btn btn-xs btn-default' style='margin-top:5px;'>Listing View</a>".$caregiver_view;
			}
			if($row1['form_number'] == "DD 103" || $row1['form_number']== "DD 123"){
                            $row[]="<a href='".getFormLinks($row1['form_id'],$indid,"View")."' class='btn btn-xs btn-default' style='margin-top:5px;'>View Logs</a>";
                        } 
            if ($row1['form_number'] == "DD 136") {
                            $add_url = APPLICATION_URL . "/add-outcome-form/" . $indid . "/" . $row1['form_id'];
                            //$view_url = APPLICATION_URL . "/outcome-log/" . $indid . "/" . $row1['form_id'];
                            $view_url = APPLICATION_URL . "/record-outcome-log-view/" . $indid . "/" . $row1['form_id'];
                            $add_record_outcome_actions_url = APPLICATION_URL . "/add-outcome-form/" . $indid . "/" . $row1['form_id'];
                            $row[] = "<a href='" . $add_url . "' class='btn btn-xs btn-default' style='margin-top:5px;'>Create Outcome</a> &nbsp; " . $viewLink . " <a href='" . $view_url . "' class='btn btn-xs btn-default' style='margin-top:5px;'>View Logs</a>&nbsp;&nbsp; <a href='" . $add_record_outcome_actions_url . "' class='btn btn-xs btn-default' style='margin-top:5px;'>Record Outcome Actions</a>";
                        }
                        $output['aaData'][] = $row;
			$j++;
		}
                
                /////////////////////
                
                foreach($qry as $row1){
			$text='"Assign Form To Individual First"';
			$mileClass=$viewLink=$notify="";
			$checkClass=""; $href="javascript:void(1);";$onclickText="onClick='showCustomAlert(".$text.")';";
			$assignedForms=$this->SuperModel->Super_Get("_uhs_individual_assigned_forms","assigned_form_id=".$row1['form_id']." and form_individual_id=".$indid,"fetch");
			$clickBtn=""; $href="javascript:void(1);";
			if($row1['form_number'] == "DD 52" || $row1['form_number']== "DD 53") {
                        } else {
                            continue;
                        }
                            if(!empty($assignedForms)){ 
				$checkClass="checked=true"; 
				$onclickText="";
                        }else{
                             if($row1['form_number'] == "DD 52" || $row1['form_number']== "DD 53"){
                                if(empty($nmt_check_val)){
                                    continue;
                                }
                            } else {
                                if(empty($show_more_val)){
                                    continue;
                                }
                            }
                         }
                        
			$row=array();
                        $clsads="";
                        $clsnmt="";
                        $clsadschk="";
                        $clsnmtchk="";
                        $xoomia_show_more_form="xoomia_show_more_form";
                       
                        if($row1['form_number'] == "DD 52" || $row1['form_number']== "DD 53"){
                            if(empty($nmt_check_val)){
                                continue;
                            }
                            $indexnmt++;
                            if($indexnmt == 1){
                                $clsnmt="clsnmt";
                            }
                            $xoomia_show_more_form="";
                            $clsnmtchk="clsnmtchk";
                        }
 			$row[] = $j;
			$row[]='<input class="elem_ids checkboxes '.$xoomia_show_more_form.' '.$clsnmt.' '.$clsnmtchk.' " '.$checkClass.' type="checkbox" name="'.$sTable.'['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'" id="formid_'.$row1[$sIndexColumn].'">';
                        $row[]=ucwords($row1['form_number']); 
  			$row[]=ucwords($row1['form_title']).$notify;
                        
                        if($row1['form_number']=="DD 52"){
				$linkText="Vehicle Inspection";
			}
			if($row1['form_number']=="DD 53"){
				$linkText="Record a trip";
			}

			
                        if($row1['form_number']== "DD 52" || $row1['form_number']== "DD 53"){

                            $row[]="<a href='".getFormLinks($row1['form_id'],$indid,"View")."' class='btn btn-xs btn-default' style='margin-top:5px;'>View Logs</a>";
                        } 
                        $output['aaData'][] = $row;
			$j++;
		}
                //////////////////////////
                
                echo json_encode($output);
		exit();
	}

	public function setviewcaregiverAction() {
        $posted_data['caregiver_view'] = $_POST['caregiver_view'];
        $posted_data['indid'] = $_POST['indid'];
        $posted_data['is_ads'] = $_POST['is_ads'];
        $posted_data['agency_id'] = $_SESSION['UHS_AUTH']['storage']->agency_id;
        
        if($_POST['view_id'] != '') {
            $view_id = $_POST['view_id'];
            $isInserted = $this->SuperModel->Super_Insert("_uhs_caregiver_view", $posted_data, "view_id = $view_id");
        }
        else {
            $isInserted = $this->SuperModel->Super_Insert("_uhs_caregiver_view", $posted_data);
        }
        
        if ($isInserted->success) {
            $healthSession->successMsg = "Caregiver view has been updated successfully.";
        } else {
            $healthSession->errorMsg = $isInserted->message;
        }
        
        $res['status'] = 'true';
        echo json_encode($res);die;
    }

	public function custom_array_column(array $input, $columnKey, $indexKey = null) {
        $array = array();
        foreach ($input as $value) {
            if ( !array_key_exists($columnKey, $value)) {
                trigger_error("Key \"$columnKey\" does not exist in array");
                return false;
            }
            if (is_null($indexKey)) {
                $array[] = $value[$columnKey];
            }
            else {
                if ( !array_key_exists($indexKey, $value)) {
                    trigger_error("Key \"$indexKey\" does not exist in array");
                    return false;
                }
                if ( ! is_scalar($value[$indexKey])) {
                    trigger_error("Key \"$indexKey\" does not contain scalar value");
                    return false;
                }
                $array[$value[$indexKey]] = $value[$columnKey];
            }
        }
        return $array;
    }

    public function calenderviewAction() {
    	global $healthSession, $systemusers;
    	// echo $this->view->user->agency_id;
    	// die;
        if ($this->view->user->agency_user_type != "Agency") {
            if($this->view->user->agency_user_type == "Staff") {
                
            }
            else {
                $healthSession->errorMsg = "You don't have permission to access this page.";
                $this->_helper->getHelper("Redirector")->gotoRoute(array(), "front_agency_dashboard");
            }
        }
        $this->view->pageHeading = "Assign Forms To";
        $indid = $this->_getParam("indid");
        if (empty($indid)) {
            $healthSession->errorMsg = "Invalid Access";
            $this->_helper->getHelper("Redirector")->gotoRoute(array(), "front_agency_dashboard");
        }
        $formid = $this->_getParam('formid');
        $indData = $this->SuperModel->Super_Get("_uhs_supports", "support_individual_id=$indid AND support_form_id=$formid", "fetchAll", ['order' => 'support_frequency']);

        /* Start Pagination */
        $page = $this->_request->getParam('page');
        $page = $this->_request->getParam('page',1);

        $paginator = Zend_Paginator::factory($indData);
        $paginator->setItemCountPerPage(4);
        $paginator->setCurrentPageNumber($page);
        $this->view->paginator=$paginator;

        $start = 0;
        $limit = 4;
        $page = $this->_getParam('page');
        if(!empty($page)){
         $start = ($page-1) * $limit;
        }
        $indData = $this->SuperModel->Super_Get("_uhs_supports", "support_individual_id=$indid AND support_form_id=$formid", "fetchAll",['order' => 'support_frequency','offset'=>$start,'limit'=>$limit]);

        /* End Pagination */

        $i = 0;
        if($formid==27){
            $this->view->pageHeading = "Documentation of Adult Day Support To";
            $type="Ads";
        } else {
            $this->view->pageHeading = "Assign Forms To";
            $type="Care";
        }
        foreach ($indData as $indRawData) {
            $support_id = $indRawData['support_id'];
            
            $first_day_this_month = "'".date("Y-m-01 00:00:01")."'";
            $current_day_this_month = "'".date("Y-m-d H:i:s", strtotime("+1 day"))."'";
            
            $this->dbObj = Zend_Registry::get('db');
            $aColumns = array('IF("task_id"="",1,0) as is_amended','shift','task_id as usc_id','task_form_id as formid','task_agency_id as usc_id','task_individual_id as indid','task_added_user as added_by','task_support_id as support_id','IF(is_task_done = "Yes", "C",IF(is_task_done = "No", "NC",IF(is_task_done = "Administered", "A",IF(is_task_done = "Not Administered", "NA",IF(is_task_done = "Refused", "R",IF(is_task_done = "+", "+","-")))))) as shift_option','task_comments as comment','task_results as usc_id','task_added_date as created_at','task_type as usc_id','task_start_time as start_time','task_end_time as end_time','task_total_service_time as total_units','is_task_entry_completed as usc_id','task_staff_no as staff_ration','task_individual_no as individual_ration','task_modified_by as modified_by','task_modified_on as modified_on','task_type');
            $sTable = '_uhs_task_entries';
            
            $sWhere=" where task_type='".$type."' AND task_support_id=$support_id AND (task_added_date BETWEEN $first_day_this_month AND $current_day_this_month)";
            $sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere";
            $task_view_data = $this->dbObj->query($sQuery)->fetchAll();
            
            $calendar_view_data = $this->SuperModel->Super_Get("_uhs_supports_charting", "support_id=$support_id AND formid=$formid AND (created_at BETWEEN $first_day_this_month AND $current_day_this_month)", "fetchAll");
            
            $calendar_view_datas=array();
            if(!empty($task_view_data) && !empty($calendar_view_data)){
                $calendar_view_datas = array_merge($task_view_data,$calendar_view_data);
            } elseif(!empty($task_view_data)) {
                $calendar_view_datas=$task_view_data;
            }elseif(!empty($calendar_view_data)) {
                $calendar_view_datas=$calendar_view_data;
            }
            
            $indData[$i]['calender_view_data'] = $calendar_view_datas;
            $i++;
        }
        
        
        date_default_timezone_set('America/New_York');
        //$date = date('Y-m-d H:i:s');
        //echo '<h1>'.$date.'</h1 >';
        $current_date = date('d');
        $current_month = date('m');
        $current_year = date('Y');
        $current_day = date('D');
        //$total_days_in_current_month = cal_days_in_month(CAL_GREGORIAN, $current_month, $current_year);
        $i = 0;
        $j = 0;
        foreach ($indData as $indRawData) {
            if($indRawData['calender_view_data'] == '' || $indRawData['calender_view_data'] == NULL) {
                $i++;
                continue;
            }
            else {
                foreach ($indRawData['calender_view_data'] as $rawCalendarData) {
                    $calendar_date = strtotime($rawCalendarData['created_at']);
                    $calendar_date = date('d', $calendar_date);
                    $indData[$i]['shift'][$rawCalendarData['shift']][$calendar_date] = $rawCalendarData;
                    
                    $added_by_id = $indData[$i]['shift'][$rawCalendarData['shift']][$calendar_date]['added_by'];
                    $added_by = $this->SuperModel->Super_Get("_uhs_agency", "agency_id=$added_by_id", "fetch");
                    
                    $created_at = $indData[$i]['shift'][$rawCalendarData['shift']][$calendar_date]['created_at'];
                    $added_by_amend="";
                    if($rawCalendarData['is_amended']){
                        $added_by_amend=$added_by['agency_first_name']." ".$added_by['agency_last_name'];
                        $assigned_by_detail = "Amended By ".$added_by['agency_first_name']." ".$added_by['agency_last_name']." On ".date("F d,Y, h:i a", strtotime($created_at))." .Click here to see the comment.";
                    } else {
                        $assigned_by_detail = "Documented By ".$added_by['agency_first_name']." ".$added_by['agency_last_name']." On ".date("F d,Y, h:i a", strtotime($created_at))." .Click here to see the comment.";
                    }
                    
                    
                    $indData[$i]['shift'][$rawCalendarData['shift']][$calendar_date]['added_by_detail'] = $assigned_by_detail;
                    $indData[$i]['shift'][$rawCalendarData['shift']][$calendar_date]['added_by_amend'] = $added_by_amend;
                }
            }
            $i++;
        }
        unset($i);
        //prd($indData);
//        echo '<pre>';
//        print_r($indData);die;
        if (empty($indData)) {
            $healthSession->errorMsg = "No Support Found.";
            $this->_helper->getHelper("Redirector")->gotoRoute(array(), "front_agency_dashboard");
        }
        //print_r(this->view->indData);die;
        
        unset($added_by_id);
        
        $document_by_data = $this->SuperModel->Super_Get("_uhs_supports_charting", "indid=$indid AND formid=$formid AND (MONTH(modified_on)=MONTH(CURDATE()) OR MONTH(created_at)=MONTH(CURDATE()))", "fetchAll");
        $added_by_id = $this->custom_array_column($document_by_data, 'added_by');
        $added_by_id = array_unique($added_by_id);
        //echo '<pre>';print_r($added_by_id);die;
        
        if(count($added_by_id) > 0) {
        	$added_by_name_list = '';
            foreach ($added_by_id as $added_by_id_raw) {
                $added_by_data = $this->SuperModel->Super_Get("_uhs_agency", "agency_id=$added_by_id_raw", "fetch");

                $added_by_name_list .= $added_by_data['agency_first_name']." ".$added_by_data['agency_last_name'].", ";
            }
    	}
    	else {
            $added_by_name_list = ", ";	
    	}
        
        $agency_id = $_SESSION['UHS_AUTH']['storage']->agency_user_agency_id;
        $agency_data = $this->SuperModel->Super_Get("_uhs_agency", "agency_id=$agency_id", "fetch");
        $agency_name = $agency_data['agency_company_name'];

        if(!empty($page)){
            $this->view->page = $page;
        }
        
        if($this->view->user->agency_user_type == "Agency") {
             $agencyid=$this->view->user->agency_id;
             $amendview_data = $this->SuperModel->Super_Get("_uhs_amend_view", "am_agency_id='".$agencyid."' AND am_indid='".$indid."' AND am_form_id='".$formid."' ", "fetch");
             if(!empty($amendview_data)){
                 $this->view->am_status = $amendview_data['am_status'];
                 $this->view->am_id = $amendview_data['am_id'];
             }else {
                 $this->view->am_status = 0;
                 $this->view->am_id = 0;
              }
        }elseif(in_array($this->view->user->agency_user_type,$systemusers)) {
                $agencyid=$this->view->user->agency_user_agency_id;
                $amendview_data = $this->SuperModel->Super_Get("_uhs_amend_view", "am_agency_id='".$agencyid."' AND am_indid='".$indid."' AND am_form_id='".$formid."' ", "fetch");
                if(!empty($amendview_data)){
                   $this->view->am_status = $amendview_data['am_status'];
                } else {
                 $this->view->am_status = 0;
                }
        }
        
        if($this->view->user->agency_user_type == "Agency") {
             $agencyid=$this->view->user->agency_id;
             $ratioview_data = $this->SuperModel->Super_Get("_uhs_ratio_view", "ratio_agency_id='".$agencyid."' AND ratio_indid='".$indid."' AND ratio_form_id='".$formid."' ", "fetch");
             if(!empty($ratioview_data)){
                 $this->view->ratio_status = $ratioview_data['ratio_status'];
                 $this->view->ratio_id = $ratioview_data['ratio_id'];
             }else {
                 $this->view->ratio_status = 0;
                 $this->view->ratio_id = 0;
              }
        } elseif(in_array($this->view->user->agency_user_type,$systemusers)) {
                $agencyid=$this->view->user->agency_user_agency_id;
                $ratioview_data = $this->SuperModel->Super_Get("_uhs_ratio_view", "ratio_agency_id='".$agencyid."' AND ratio_indid='".$indid."' AND ratio_form_id='".$formid."' ", "fetch");
                if(!empty($ratioview_data)){
                   $this->view->ratio_status = $ratioview_data['ratio_status'];
                } else {
                 $this->view->ratio_status = 0;
                }
        }
        $this->view->agency_name = $agency_name;
        $this->view->indData = $indData;
        $this->view->indid = $indid;
        $this->view->formid = $formid;
        $this->view->documented_by_list = rtrim($added_by_name_list, ", ");
        $this->view->super_model = $this->SuperModel;
        $this->view->agency_user_type = $this->view->user->agency_user_type;
        
        
        //prd($indData);
    }
    
    public function viewhistoryAction() {
        global $healthSession,$systemusers;
        if ($this->view->user->agency_user_type != "Agency") {
            if($this->view->user->agency_user_type == "Staff") {
                
            }
            else {
                $healthSession->errorMsg = "You don't have permission to access this page.";
                $this->_helper->getHelper("Redirector")->gotoRoute(array(), "front_agency_dashboard");
            }
        }
        $this->view->pageHeading = "Assign Forms To";
        $indid = $this->_getParam("indid");
        if (empty($indid)) {
            $healthSession->errorMsg = "Invalid Access";
            $this->_helper->getHelper("Redirector")->gotoRoute(array(), "front_agency_dashboard");
        }
        $formid = $this->_getParam('formid');
        $indData = $this->SuperModel->Super_Get("_uhs_supports", "support_individual_id=$indid AND support_form_id=$formid", "fetchAll", ['order' => 'support_frequency']);
        $i = 0;
        
        if($formid==27){
            $type="Ads";
        } else {
            $type="Care";
        }
        $search_year = $this->_getParam("year");
        $search_month = $this->_getParam("month");
        $search_date = strtotime($search_year."-".$search_month."-01");
        
        if(empty($search_year) && empty($search_month)) {
            $first_day_this_month = "'".date("Y-m-d 00:00:01", strtotime("first day of last month"))."'";
            $last_day_this_month = "'".date("Y-m-d 23:59:59", strtotime("last day of last month"))."'";
        }
        else {
            $first_day_this_month = "'".date("Y-m-d 00:00:01", $search_date)."'";
            $last_day_this_month = "'".date("Y-m-t 23:59:59", $search_date)."'";
        }
        
        foreach ($indData as $indRawData) {
            $support_id = $indRawData['support_id'];
            
            $this->dbObj = Zend_Registry::get('db');
            $aColumns = array('IF("task_id"="",1,0) as is_amended','shift','task_id as usc_id','task_form_id as formid','task_agency_id as usc_id','task_individual_id as indid','task_added_user as added_by','task_support_id as support_id','IF(is_task_done = "Yes", "C",IF(is_task_done = "No", "NC",IF(is_task_done = "Administered", "A",IF(is_task_done = "Not Administered", "NA",IF(is_task_done = "Refused", "R",IF(is_task_done = "+", "+","-")))))) as shift_option','task_comments as comment','task_results as usc_id','task_added_date as created_at','task_type as usc_id','task_start_time as start_time','task_end_time as end_time','task_total_service_time as total_units','is_task_entry_completed as usc_id','task_staff_no as staff_ration','task_individual_no as individual_ration','task_modified_by as modified_by','task_modified_on as modified_on','task_type');
            $sTable = '_uhs_task_entries';
            $sWhere=" where task_type='".$type."' AND task_support_id=$support_id AND (task_added_date BETWEEN $first_day_this_month AND $last_day_this_month)";
            $sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere";
            $task_view_data = $this->dbObj->query($sQuery)->fetchAll();
            
            $calendar_view_data = $this->SuperModel->Super_Get("_uhs_supports_charting", "support_id=$support_id AND formid=$formid AND (created_at BETWEEN $first_day_this_month AND $last_day_this_month)", "fetchAll");
            
            $calendar_view_datas=array();
            if(!empty($task_view_data) && !empty($calendar_view_data)){
                $calendar_view_datas = array_merge($task_view_data,$calendar_view_data);
            } elseif(!empty($task_view_data)) {
                $calendar_view_datas=$task_view_data;
            }elseif(!empty($calendar_view_data)) {
                $calendar_view_datas=$calendar_view_data;
            }
            
            $indData[$i]['calender_view_data'] = $calendar_view_datas;
            $i++;
        }
        unset($i);
        
        
        date_default_timezone_set('America/New_York');
        //$date = date('Y-m-d H:i:s');
        //echo '<h1>'.$date.'</h1 >';
        $current_date = date('d');
        $current_month = date('m');
        $current_year = date('Y');
        $current_day = date('D');
        //$total_days_in_current_month = cal_days_in_month(CAL_GREGORIAN, $current_month, $current_year);
        $i = 0;
        $j = 0;
        foreach ($indData as $indRawData) {
            if($indRawData['calender_view_data'] == '' || $indRawData['calender_view_data'] == NULL) {
                $i++;
                continue;
            }
            else {
                foreach ($indRawData['calender_view_data'] as $rawCalendarData) {
                    $calendar_date = strtotime($rawCalendarData['created_at']);
                    $calendar_date = date('d', $calendar_date);
                    $indData[$i]['shift'][$rawCalendarData['shift']][$calendar_date] = $rawCalendarData;
                    
                    $added_by_id = $indData[$i]['shift'][$rawCalendarData['shift']][$calendar_date]['added_by'];
                    $added_by = $this->SuperModel->Super_Get("_uhs_agency", "agency_id=$added_by_id", "fetch");
                    
                    $created_at = $indData[$i]['shift'][$rawCalendarData['shift']][$calendar_date]['created_at'];
                    $assigned_by_detail = "Documented By ".$added_by['agency_first_name']." ".$added_by['agency_last_name']." On ".date("F d,Y, h:i a", strtotime($created_at));
                    
                    
                    $added_by_amend="";
                    if($rawCalendarData['is_amended']){
                        $added_by_amend=$added_by['agency_first_name']." ".$added_by['agency_last_name'];
                        $assigned_by_detail = "Amended By ".$added_by['agency_first_name']." ".$added_by['agency_last_name']." On ".date("F d,Y, h:i a", strtotime($created_at))." .Click here to see the comment.";
                    } else {
                        $assigned_by_detail = "Documented By ".$added_by['agency_first_name']." ".$added_by['agency_last_name']." On ".date("F d,Y, h:i a", strtotime($created_at))." .Click here to see the comment.";
                    }
                    $indData[$i]['shift'][$rawCalendarData['shift']][$calendar_date]['added_by_detail'] = $assigned_by_detail;
                    $indData[$i]['shift'][$rawCalendarData['shift']][$calendar_date]['added_by_amend'] = $added_by_amend;
                    
                }
            }
            $i++;
        }
        
//        echo '<pre>';
//        print_r($indData);die;
        if (empty($indData)) {
            $healthSession->errorMsg = "No Individual Found.";
            $this->_helper->getHelper("Redirector")->gotoRoute(array(), "front_agency_dashboard");
        }
        //print_r(this->view->indData);die;
        
        unset($added_by_id);
        
        $document_by_data = $this->SuperModel->Super_Get("_uhs_supports_charting", "indid=$indid AND formid=$formid", "fetchAll");
        $added_by_id = $this->custom_array_column($document_by_data, 'added_by');
        $added_by_id = array_unique($added_by_id);
        //echo '<pre>';print_r($added_by_id);die;
        
        if(count($added_by_id) > 0) {
        	$added_by_name_list = '';
            foreach ($added_by_id as $added_by_id_raw) {
                $added_by_data = $this->SuperModel->Super_Get("_uhs_agency", "agency_id=$added_by_id_raw", "fetch");

                $added_by_name_list .= $added_by_data['agency_first_name']." ".$added_by_data['agency_last_name'].", ";
            }
    	}
    	else {
            $added_by_name_list = ", ";	
    	}
        
        if(empty($search_year) && empty($search_month)) {
            $this->view->search_year = date("Y", strtotime('last month'));
            $this->view->search_month = date("m", strtotime('last month'));
            $this->view->search_date_timestamp = strtotime('last month');
            
            $this->view->redirect_search_year = '';
            $this->view->redirect_search_month = '';
        }
        else {
            $this->view->search_year = $search_year;
            $this->view->search_month = $search_month;
            $this->view->search_date_timestamp = $search_date;
            
            $this->view->redirect_search_year = $search_year;
            $this->view->redirect_search_month = $search_month;
        }
        
        $agency_id = $_SESSION['UHS_AUTH']['storage']->agency_user_agency_id;
        $agency_data = $this->SuperModel->Super_Get("_uhs_agency", "agency_id=$agency_id", "fetch");
        $agency_name = $agency_data['agency_company_name'];
        
        
        if(in_array($this->view->user->agency_user_type,$systemusers)) {
                $agencyid=$this->view->user->agency_user_agency_id;
                $amendview_data = $this->SuperModel->Super_Get("_uhs_amend_view", "am_agency_id='".$agencyid."' AND am_indid='".$indid."' AND am_form_id='".$formid."' ", "fetch");
                if(!empty($amendview_data)){
                   $this->view->am_status = $amendview_data['am_status'];
                } else {
                 $this->view->am_status = 0;
                }
        }
        if($this->view->user->agency_user_type == "Agency") {
             $agencyid=$this->view->user->agency_id;
             $ratioview_data = $this->SuperModel->Super_Get("_uhs_ratio_view", "ratio_agency_id='".$agencyid."' AND ratio_indid='".$indid."' AND ratio_form_id='".$formid."' ", "fetch");
             if(!empty($ratioview_data)){
                 $this->view->ratio_status = $ratioview_data['ratio_status'];
                 $this->view->ratio_id = $ratioview_data['ratio_id'];
             }else {
                 $this->view->ratio_status = 0;
                 $this->view->ratio_id = 0;
              }
        } elseif(in_array($this->view->user->agency_user_type,$systemusers)) {
                $agencyid=$this->view->user->agency_user_agency_id;
                $ratioview_data = $this->SuperModel->Super_Get("_uhs_ratio_view", "ratio_agency_id='".$agencyid."' AND ratio_indid='".$indid."' AND ratio_form_id='".$formid."' ", "fetch");
                if(!empty($ratioview_data)){
                   $this->view->ratio_status = $ratioview_data['ratio_status'];
                } else {
                 $this->view->ratio_status = 0;
                }
        }
        
        
        
        $this->view->agency_name = $agency_name;
        $this->view->indData = $indData;
        $this->view->indid = $indid;
        $this->view->formid = $formid;
        $this->view->documented_by_list = rtrim($added_by_name_list, ", ");
        $this->view->super_model = $this->SuperModel;
        $this->view->agency_user_type = $this->view->user->agency_user_type;
    }
    
    public function savesupports1Action() {
        global $healthSession;
//        echo"<pre>";

        
        $indid = $this->_getParam('indid');
        $formid = $this->_getParam('formid');
        $posted_data['support_id'] = $_POST['support_id'];
        $posted_data['shift'] = $_POST['shift'];
        $posted_data['comment'] = $_POST['calendar_view_comment'] != '' ? $_POST['calendar_view_comment'] : '';
        $posted_data['shift_option'] = $_POST['shift_option'];
        $posted_data['is_amended'] = $_POST['is_amended'];
        $posted_data['created_at'] = $_POST['date'];
        $posted_data['added_by'] = $_SESSION['UHS_AUTH']['storage']->subuser_id;
        $posted_data['indid'] = $_POST['indid'];
        $posted_data['formid'] = $_POST['formid'];
        if(!($_POST['shift_option'] == "NC" || $_POST['shift_option']=="NA" || $_POST['shift_option']=="R" || $_POST['shift_option']=="-")){
            $posted_data['start_time'] = $_POST['calendar_start_time'];
            $posted_data['end_time'] = $_POST['calendar_end_time'];
            $posted_data['total_units'] = $_POST['calendar_total_units'];
            $posted_data['staff_ration'] = $_POST['calendar_staff_ration'];
            $posted_data['individual_ration'] = $_POST['calendar_individual_ration'];
            $posted_data['modified_on']=date('Y-m-d H:i:s');
        }
        if($_POST['usc_id'] == 0) {
            $isInserted = $this->SuperModel->Super_Insert("_uhs_supports_charting", $posted_data);
        }
        else {
            $usc_id = $_POST['usc_id'];
            
            $updated_data['shift_option'] = $_POST['shift_option'];
            $updated_data['comment'] = $_POST['calendar_view_comment'];
            
            if($_POST['shift_option'] == "NC" || $_POST['shift_option']=="NA" || $_POST['shift_option']=="R" || $_POST['shift_option']=="-"){
                $updated_data['start_time'] ="";
                $updated_data['end_time'] = "";
                $updated_data['total_units'] = 0;
                $updated_data['staff_ration'] = 0;
                $updated_data['individual_ration'] =0;
            }else {
                $updated_data['start_time'] = $_POST['calendar_start_time'];
                $updated_data['end_time'] = $_POST['calendar_end_time'];
                $updated_data['total_units'] = $_POST['calendar_total_units'];
                $updated_data['staff_ration'] = $_POST['calendar_staff_ration'];
                $updated_data['individual_ration'] = $_POST['calendar_individual_ration'];
            }
            $updated_data['modified_by']=$this->view->user->subuser_id;
            $updated_data['modified_on']=date('Y-m-d H:i:s');
            
            $isInserted = $this->SuperModel->Super_Insert("_uhs_supports_charting", $updated_data, "usc_id = $usc_id");
        }
        
        if ($isInserted->success) {
            $healthSession->successMsg = "Supports has been updated successfully.";
        } else {
            $healthSession->errorMsg = $isInserted->message;
        }
        //echo $_SERVER['HTTP_REFERER'];die;
        
        $redirect_search_year = $_POST['search_year'];
        $redirect_search_month = $_POST['search_month'];
        
        if($redirect_search_year == '' && $redirect_search_month == '') {
            exit;
            //$this->_helper->getHelper("Redirector")->gotoRoute(array("indid" => $indid, "formid" => $formid), "forms_calender_view");
        }
        else {
            
            $this->_helper->getHelper("Redirector")->gotoRoute(array("indid" => $indid, "formid" => $formid, 'year' => $redirect_search_year, 'month' => $redirect_search_month), "forms_calender_view_history");
        }

    }

    public function savesupportsv2Action() {

        global $healthSession;

        $indid = $this->_getParam('indid');
        $formid = $this->_getParam('formid');
        foreach ($_POST['postData'] as $_POST){


            $posted_data['support_id'] = $_POST['support_id'];
            $posted_data['shift'] = $_POST['shift'];
            $posted_data['comment'] = $_POST['calendar_view_comment'] != '' ? $_POST['calendar_view_comment'] : '';
            $posted_data['shift_option'] = $_POST['shift_option'];
            $posted_data['is_amended'] = $_POST['is_amended'];
            $posted_data['created_at'] = $_POST['date'];
            $posted_data['added_by'] = $_SESSION['UHS_AUTH']['storage']->subuser_id;
            $posted_data['indid'] = $_POST['indid'];
            $posted_data['formid'] = $_POST['formid'];
            if(!($_POST['shift_option'] == "NC" || $_POST['shift_option']=="NA" || $_POST['shift_option']=="R" || $_POST['shift_option']=="-")){
                $posted_data['start_time'] = $_POST['calendar_start_time'];
                $posted_data['end_time'] = $_POST['calendar_end_time'];
                $posted_data['total_units'] = $_POST['calendar_total_units'];
                $posted_data['staff_ration'] = $_POST['calendar_staff_ration'];
                $posted_data['individual_ration'] = $_POST['calendar_individual_ration'];
                $posted_data['modified_on']=date('Y-m-d H:i:s');
            }

            if ($_POST['usc_id'] == 0) {
                $isInserted = $this->SuperModel->Super_Insert("_uhs_supports_charting", $posted_data);
            } else {
                $usc_id = $_POST['usc_id'];

                $updated_data['shift_option'] = $_POST['shift_option'];
                $updated_data['comment'] = $_POST['calendar_view_comment'];
                
                
                if($_POST['shift_option'] == "NC" || $_POST['shift_option']=="NA" || $_POST['shift_option']=="R" || $_POST['shift_option']=="-"){
                $updated_data['start_time'] ="";
                $updated_data['end_time'] = "";
                $updated_data['total_units'] = 0;
                $updated_data['staff_ration'] = 0;
                $updated_data['individual_ration'] =0;
            }else {
                $updated_data['start_time'] = $_POST['calendar_start_time'];
                $updated_data['end_time'] = $_POST['calendar_end_time'];
                $updated_data['total_units'] = $_POST['calendar_total_units'];
                $updated_data['staff_ration'] = $_POST['calendar_staff_ration'];
                $updated_data['individual_ration'] = $_POST['calendar_individual_ration'];
            }

                $isInserted = $this->SuperModel->Super_Insert("_uhs_supports_charting", $updated_data, "usc_id = $usc_id");
            }

            $redirect_search_year = $_POST['search_year'];
            $redirect_search_month = $_POST['search_month'];

        }
        
        if ($isInserted->success) {
            //$healthSession->successMsg = "Supports has been updated successfully.";
            if(!empty($redirect_search_year) && !empty($redirect_search_month)){
                $data = array('year' => $redirect_search_year,
                    'month' => $redirect_search_month);

                echo json_encode($data); die;
            }else{
                echo "Supports has been updated successfully.";
            }
        } else {
            echo $isInserted->message;
            //$healthSession->errorMsg = $isInserted->message;
        }
        
        if ($redirect_search_year == '' && $redirect_search_month == '') {
            $this->_helper->getHelper("Redirector")->gotoRoute(array("indid" => $indid, "formid" => $formid), "forms_calender_view");
        } else {
            $this->_helper->getHelper("Redirector")->gotoRoute(array("indid" => $indid, "formid" => $formid, 'year' => $redirect_search_year, 'month' => $redirect_search_month), "forms_calender_view_history");
        }
    }
	
	public function assignformsAction(){
		global $healthSession;
		if($this->view->user->agency_user_type!="Agency"){
			$healthSession->errorMsg="You don't have permission to access this page.";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		$indid=$this->_getParam('indid');
		$this->_helper->layout->disableLayout();
		$this->_helper->viewRenderer->setNoRender(true);
		$formData = $this->getRequest()->getPost();
                $ads_check_val = $formData['ads_check_val'];
                $nmt_check_val = $formData['nmt_check_val'];
                $show_more_val = $formData['show_more_val'];
                if(isset($formData['_uhs_agency_forms']) && count($formData['_uhs_agency_forms'])){
		  if(empty($formData['smart_print'])){
					$data=array();
					$data_service=array();
					$isExist=$this->SuperModel->Super_Get("_uhs_individual_assigned_forms","form_individual_id=".$indid,"fetchAll");
					if(count($isExist)>0){
						foreach($isExist as $values){
							if(!in_array($values['assigned_form_id'],$formData['_uhs_agency_forms'])){
								$isRemoved=$this->SuperModel->Super_Delete("_uhs_individual_assigned_forms","afid=".$values['afid']);
							}
						}
					}
					foreach($formData['_uhs_agency_forms'] as $key=>$values){
						$isExist=$this->SuperModel->Super_Get("_uhs_individual_assigned_forms","form_individual_id=".$indid." and assigned_form_id=".$values,"fetch");
						if(empty($isExist)){
							$data=array("form_agency_id"=>$this->view->user->agency_id,"form_individual_id"=>$indid,"assigned_form_id"=>$values,"assigned_form_date"=>date('Y-m-d H:i:s'));
							$isAdd=$this->SuperModel->Super_Insert('_uhs_individual_assigned_forms',$data);
							$healthSession->successMsg="Form(s) assigned to individual successfully.";
						}
					}
                                        
                                        // Start code added by amit on 21-may-2018 with save record _uhs_xoomia_services 
                                        $data_service['service_agency_id']=$this->view->user->agency_id;
                                        $data_service['service_added_user_id']=$this->view->user->subuser_id;
                                        $data_service['service_indid_id']=$indid;
                                        $data_service['service_added_on']=date('Y-m-d H:i:s');
                                        
                                        $isExists=$this->SuperModel->Super_Get("_uhs_xoomia_services","service_indid_id=".$indid." and service_code='ads' and service_added_user_id=".$this->view->user->subuser_id,"fetch");
                                        if($isExists){
                                                if(empty($ads_check_val)){
                                                    $this->SuperModel->Super_Delete("_uhs_xoomia_services","service_id=".$isExists['service_id']);
                                                }
                                        } else {
                                            if(!empty($ads_check_val)){
                                                $data_service['service_code']='ads';
                                                $this->SuperModel->Super_Insert('_uhs_xoomia_services',$data_service);
                                            }
                                        }
                                        
                                        $isExistNmtRec=$this->SuperModel->Super_Get("_uhs_xoomia_services","service_indid_id=".$indid." and service_code='nmt' and service_added_user_id=".$this->view->user->subuser_id,"fetch");
                                        if($isExistNmtRec){
                                                if(empty($nmt_check_val)){
                                                    $this->SuperModel->Super_Delete("_uhs_xoomia_services","service_id=".$isExistNmtRec['service_id']);
                                                }
                                        } else {
                                            if(!empty($nmt_check_val)){
                                                $data_service['service_code']='nmt';
                                                $this->SuperModel->Super_Insert('_uhs_xoomia_services',$data_service);
                                            }
                                        }
                                        
                                        // End code added by amit on 21-may-2018 with save record _uhs_xoomia_services 
                                 }
		  else{
					$res="";
					foreach($formData['_uhs_agency_forms'] as $value){
						$res.=$this->_smartPrint($indid,$value,$formData['months'],$formData['years']);
					}

					if(!empty($res)){
						$indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid);
						require_once ROOT_PATH.'/private/mpdf/mpdf.php';
						$mpdf=new mPDF('utf-8', 'A4-L');	
						// $stylesheet = file_get_contents(APPLICATION_URL.'/public/plugins/bootstrap/css/bootstrap.css'); 
						$url = APPLICATION_URL.'/public/plugins/bootstrap/css/bootstrap.css';
						$curl = curl_init();
						curl_setopt($curl, CURLOPT_URL, $url);
						curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
						curl_setopt($curl, CURLOPT_HEADER, false);
						$stylesheet = curl_exec($curl);
						curl_close($curl);

						$mpdf->SetTitle($this->view->site_configs['site_name']." | ".ucwords($indData['agency_first_name']." ".$indData['agency_last_name'])." Forms");

						$mpdf->WriteHTML($stylesheet,1);
//echo "<pre>";print_r($res);die;
						//die($res);
						//$mpdf->WriteHTML('<h1> ok </h1>');
//error_reporting(E_ALL);
//ini_set('display_errors', 1);
//ini_set('display_startup_errors', 1);
                        $mpdf->setFooter("Page {PAGENO} of {nb}");
						$mpdf->WriteHTML($res,2);
						$mpdf->Output();
						exit();
					}
					else{
						$healthSession->errorMsg = "No logs found.";
					}
				}
		}
		else{
			//prd($formData);
			if(isset($formData) && !empty($formData) && empty($formData['smart_print'])){
				$isExist=$this->SuperModel->Super_Get("_uhs_individual_assigned_forms","form_individual_id=".$indid,"fetchAll");
				if(count($isExist)>0){
					foreach($isExist as $values){
						$isRemoved=$this->SuperModel->Super_Delete("_uhs_individual_assigned_forms","afid=".$values['afid']);
					}
					$healthSession->successMsg="Selected forms has been refused successfully";
				}else{$healthSession->errorMsg = "Invalid Request.";}
			}
			/*else{
				$healthSession->errorMsg = "Invalid Request.";
			}*/
                                        // Start code added by amit on 21-may-2018 with save record _uhs_xoomia_services 
                                        $data_service=array();
                                        $data_service['service_agency_id']=$this->view->user->agency_id;
                                        $data_service['service_added_user_id']=$this->view->user->subuser_id;
                                        $data_service['service_indid_id']=$indid;
                                        $data_service['service_added_on']=date('Y-m-d H:i:s');
                                        $isExists=$this->SuperModel->Super_Get("_uhs_xoomia_services","service_indid_id=".$indid." and service_code='ads' and service_added_user_id=".$this->view->user->subuser_id,"fetch");
                                        if($isExists){
                                                if(empty($ads_check_val)){
                                                    $this->SuperModel->Super_Delete("_uhs_xoomia_services","service_id=".$isExists['service_id']);
                                                }
                                        } else {
                                            if(!empty($ads_check_val)){
                                                $data_service['service_code']='ads';
                                                $this->SuperModel->Super_Insert('_uhs_xoomia_services',$data_service);
                                            }
                                        }
                                        
                                        $isExistNmtRec=$this->SuperModel->Super_Get("_uhs_xoomia_services","service_indid_id=".$indid." and service_code='nmt' and service_added_user_id=".$this->view->user->subuser_id,"fetch");
                                        if($isExistNmtRec){
                                                if(empty($nmt_check_val)){
                                                    $this->SuperModel->Super_Delete("_uhs_xoomia_services","service_id=".$isExistNmtRec['service_id']);
                                                }
                                        } else {
                                            if(!empty($nmt_check_val)){
                                                $data_service['service_code']='nmt';
                                                $this->SuperModel->Super_Insert('_uhs_xoomia_services',$data_service);
                                            }
                                        }
                                        // End code added by amit on 21-may-2018 with save record _uhs_xoomia_services 
		}
 	    $this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid, "ads_check_val"=>$ads_check_val, "nmt_check_val"=>$nmt_check_val, "show_more_val"=>$show_more_val),"front_forms");	 
	}

	public function calenderviewprintAction() {


        global $healthSession;
        if ($this->view->user->agency_user_type != "Agency") {
            if($this->view->user->agency_user_type == "Staff") {
                
            }
            else {
                $healthSession->errorMsg = "You don't have permission to access this page.";
                $this->_helper->getHelper("Redirector")->gotoRoute(array(), "front_agency_dashboard");
            }
        }
        $this->view->pageHeading = "Assign Forms To";
        $indid = $this->_getParam("indid");
        if (empty($indid)) {
            $healthSession->errorMsg = "Invalid Access";
            $this->_helper->getHelper("Redirector")->gotoRoute(array(), "front_agency_dashboard");
        }
        $formid = $this->_getParam('formid');
        if($formid==27){
            $type="Ads";
        }else {
            $type="Care";
        }
        $indData = $this->SuperModel->Super_Get("_uhs_supports", "support_individual_id=$indid AND support_form_id=$formid", "fetchAll",['order' => 'support_frequency']);
        //$indData = array_slice($indData,0,22);
        $i = 0;
        
        $choose_year = $this->_getParam('year');
        $choose_month = $this->_getParam('month');
        if(!empty($choose_year) && !empty($choose_month)){
            
            $d = date('t', mktime(0, 0, 0, $choose_month, 1, $choose_year));
            $calendar_dates=$choose_year."-".$choose_month."-".$d;
            
            $first_day_this_month  = "'".date('Y-m-01 00:00:01', strtotime($calendar_dates))."'";
            $current_day_this_month  = "'".date('Y-m-d H:i:s', strtotime($calendar_dates))."'";
        }else{
            $first_day_this_month = "'".date("Y-m-01 00:00:01")."'";
            $current_day_this_month = "'".date("Y-m-d H:i:s")."'";
        }
        
        foreach ($indData as $indRawData) {
            $support_id = $indRawData['support_id'];
            
            $this->dbObj = Zend_Registry::get('db');
            $aColumns = array('IF("task_id"="",1,0) as is_amended','shift','task_id as usc_id','task_form_id as formid','task_agency_id as usc_id','task_individual_id as indid','task_added_user as added_by','task_support_id as support_id','IF(is_task_done = "Yes", "C",IF(is_task_done = "No", "NC",IF(is_task_done = "Administered", "A",IF(is_task_done = "Not Administered", "NA",IF(is_task_done = "Refused", "R",IF(is_task_done = "+", "+","-")))))) as shift_option','task_comments as comment','task_results as usc_id','task_added_date as created_at','task_type as usc_id','task_start_time as start_time','task_end_time as end_time','task_total_service_time as total_units','is_task_entry_completed as usc_id','task_staff_no as staff_ration','task_individual_no as individual_ration','task_modified_by as modified_by','task_modified_on as modified_on','task_type');
            $sTable = '_uhs_task_entries';
            $sWhere=" where task_type='".$type."' AND task_support_id=$support_id AND (task_added_date BETWEEN $first_day_this_month AND $current_day_this_month)";
            $sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere";
            $task_view_data = $this->dbObj->query($sQuery)->fetchAll();
            
            $calendar_view_data = $this->SuperModel->Super_Get("_uhs_supports_charting", "support_id=$support_id AND formid='".$formid."' AND (created_at BETWEEN $first_day_this_month AND $current_day_this_month)", "fetchAll");
            
            $calendar_view_datas=array();
            if(!empty($task_view_data) && !empty($calendar_view_data)){
                $calendar_view_datas = array_merge($task_view_data,$calendar_view_data);
            } elseif(!empty($task_view_data)) {
                $calendar_view_datas=$task_view_data;
            }elseif(!empty($calendar_view_data)) {
                $calendar_view_datas=$calendar_view_data;
            }
            
            $indData[$i]['calender_view_data'] = $calendar_view_datas;
            $i++;
        }
        unset($i);
        
        
        date_default_timezone_set('America/New_York');
        //$date = date('Y-m-d H:i:s');
        //echo '<h1>'.$date.'</h1 >';

        
        $current_date = date('d');
        $current_month = date('m');
        $current_year = date('Y');
        $current_day = date('D');
        //echo "ddd";  die;
        //$total_days_in_current_month = cal_days_in_month(CAL_GREGORIAN, $current_month, $current_year);
        
        $i = 0;
        $j = 0;
       

        foreach ($indData as $indRawData) {
            if($indRawData['calender_view_data'] == '' || $indRawData['calender_view_data'] == NULL) {
                $i++;
                continue;
            }
            else {
                foreach ($indRawData['calender_view_data'] as $rawCalendarData) {
                    $calendar_date = strtotime($rawCalendarData['created_at']);
                    $calendar_date = date('d', $calendar_date);
                    $indData[$i][shift][$rawCalendarData['shift']][$calendar_date] = $rawCalendarData;
                    
                    $added_by_id = $indData[$i][shift][$rawCalendarData['shift']][$calendar_date]['added_by'];
                    $added_by = $this->SuperModel->Super_Get("_uhs_agency", "agency_id=$added_by_id", "fetch");
                    
                    $created_at = $indData[$i][shift][$rawCalendarData['shift']][$calendar_date]['created_at'];
                    $assigned_by_detail = "Assigned By ".$added_by['agency_first_name']." ".$added_by['agency_last_name']." On ".date("F d,Y, h:i a", strtotime($created_at));
                    
                    $indData[$i][shift][$rawCalendarData['shift']][$calendar_date]['added_by_detail'] = $assigned_by_detail;
                }
            }
            $i++;
        }

        	
      /*  echo '<pre>';
        print_r($indData);die;*/

        if (empty($indData)) {
            $healthSession->errorMsg = "No Individual Found.";
            $this->_helper->getHelper("Redirector")->gotoRoute(array(), "front_agency_dashboard");
        }
       //echo "Hello"; print_r($indData);die;

        
        unset($added_by_id);
        
        $document_by_data = $this->SuperModel->Super_Get("_uhs_supports_charting", "indid=$indid AND formid=$formid", "fetchAll");
        //echo '<pre>';print_r($document_by_data);die;
        
        //echo '<pre>';print_r($document_by_data);die;
        //echo "sdadasd"; die;
       
    	if(count($document_by_data) > 0) {
    		
    			/*$added_by_id = array_column($document_by_data, 'added_by');
    			$added_by_id = array_unique($added_by_id);*/
    			$added_by_id = $this->custom_array_column($document_by_data, 'added_by');
        		$added_by_id = array_unique($added_by_id);
	
    		
    		
    		//echo "sdadasd"; die;	
    		$added_by_name_list = '';

        foreach ($added_by_id as $added_by_id_raw) {
            $added_by_data = $this->SuperModel->Super_Get("_uhs_agency", "agency_id=$added_by_id_raw", "fetch");

            $added_by_name_list .= $added_by_data['agency_first_name']." ".$added_by_data['agency_last_name'].", ";
        }
    	}
    	else {
            $added_by_name_list = ", ";	
    	}

        
    	//echo "2"; echo '<pre>';print_r($indData);die;
        
        /*foreach ($added_by_id as $added_by_id_raw) {
            $added_by_data = $this->SuperModel->Super_Get("_uhs_agency", "agency_id=$added_by_id_raw", "fetch");
            
            $added_by_name_list .= $added_by_data['agency_first_name']." ".$added_by_data['agency_last_name'].", ";
        }*/
        
        $this->view->indData = $indData;
        $this->view->indid = $indid;
        $this->view->formid = $formid;
        $this->view->documented_by_list = rtrim($added_by_name_list, ", ");
        //$this->view->super_model = $this->SuperModel;
        
        $documented_by_list = rtrim($added_by_name_list, ", ");
       

        //echo $this->getprinthtmlAction($indData, $indid, $formid, $documented_by_list);die;
        
        if(!empty($choose_year) && !empty($choose_month)){
            $html = $this->getprinthtmlAction($indData, $indid, $formid, $documented_by_list, $calendar_dates);
        } else{
            $html = $this->getprinthtmlAction($indData, $indid, $formid, $documented_by_list);
        }
        
        $indData = $this->SuperModel->Super_Get("_uhs_agency", "agency_id=" . $indid);
        //echo $html;die;
        
        try{

        
       require_once ROOT_PATH.'/private/mpdf/mpdf.php';
		$mpdf= new mPDF('utf-8', 'A4-L');

		//$stylesheet = file_get_contents(APPLICATION_URL.'/public/plugins/bootstrap/css/bootstrap.min.css');
		ini_set("memory_limit","500M");
		$stylesheet = file_get_contents(APPLICATION_URL.'/public/front_css/style_custom.css');
		$mpdf->SetTitle($this->view->site_configs['site_name'] . " | " . ucwords($indData['agency_first_name'] . " " . $indData['agency_last_name']) . " Forms");
		$mpdf->WriteHTML($stylesheet,1);
		//$mpdf->WriteHTML($pdfHtml,2);
		$mpdf->WriteHTML($html, 2);
		//$mpdf->WriteHTML($html);

		$mpdf->Output();

		}catch(Exception $e){
			exit();
        }
        
		exit();
    }


    public function calenderpdfmailAction(){
        if($this->getRequest()->isPost()){
            $data = $this->getRequest()->getPost();
            ini_set('memory_limit', '-1');
            ini_set('max_execution_time', 500);
            global $healthSession;
            if ($this->view->user->agency_user_type != "Agency") {
                if($this->view->user->agency_user_type == "Staff") {

                }
                else {
                    $healthSession->errorMsg = "You don't have permission to access this page.";
                    $this->_helper->getHelper("Redirector")->gotoRoute(array(), "front_agency_dashboard");
                }
            }
            $this->view->pageHeading = "Assign Forms To";
            $indid = $this->_getParam("indid");
            if (empty($indid)) {
                $healthSession->errorMsg = "Invalid Access";
                $this->_helper->getHelper("Redirector")->gotoRoute(array(), "front_agency_dashboard");
            }
            $formid = $this->_getParam('formid');
            
                
                if($formid==27){
                    $type="Ads";
                }else{
                    $type="Care";
                }
            $indData = $this->SuperModel->Super_Get("_uhs_supports", "support_individual_id=$indid AND support_form_id=$formid", "fetchAll",['order' => 'support_frequency']);
            //$indData = array_slice($indData,0,22);
            $i = 0;

            $choose_year = $this->_getParam('year');
            $choose_month = $this->_getParam('month');
            if(!empty($choose_year) && !empty($choose_month)){
                $d = date('t', mktime(0, 0, 0, $choose_month, 1, $choose_year));

                $calendar_dates=$choose_year."-".$choose_month."-".$d;

                $first_day_this_month  = "'".date('Y-m-01 00:00:01', strtotime($calendar_dates))."'";
                $current_day_this_month  = "'".date('Y-m-d H:i:s', strtotime($calendar_dates))."'";
            }else{
                $first_day_this_month = "'".date("Y-m-01 00:00:01")."'";
                $current_day_this_month = "'".date("Y-m-d H:i:s")."'";
            }
            foreach ($indData as $indRawData) {
                $support_id = $indRawData['support_id'];

                $this->dbObj = Zend_Registry::get('db');
                $aColumns = array('IF("task_id"="",1,0) as is_amended','shift','task_id as usc_id','task_form_id as formid','task_agency_id as usc_id','task_individual_id as indid','task_added_user as added_by','task_support_id as support_id','IF(is_task_done = "Yes", "C",IF(is_task_done = "No", "NC",IF(is_task_done = "Administered", "A",IF(is_task_done = "Not Administered", "NA",IF(is_task_done = "Refused", "R",IF(is_task_done = "+", "+","-")))))) as shift_option','task_comments as comment','task_results as usc_id','task_added_date as created_at','task_type as usc_id','task_start_time as start_time','task_end_time as end_time','task_total_service_time as total_units','is_task_entry_completed as usc_id','task_staff_no as staff_ration','task_individual_no as individual_ration','task_modified_by as modified_by','task_modified_on as modified_on','task_type');
                $sTable = '_uhs_task_entries';
                $sWhere=" where task_type='".$type."' AND task_support_id=$support_id AND (task_added_date BETWEEN $first_day_this_month AND $current_day_this_month)";
                $sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere";
                $task_view_data = $this->dbObj->query($sQuery)->fetchAll();

                $calendar_view_data = $this->SuperModel->Super_Get("_uhs_supports_charting", "support_id=$support_id AND formid='".$formid."' AND (created_at BETWEEN $first_day_this_month AND $current_day_this_month)", "fetchAll");

                $calendar_view_datas=array();
                if(!empty($task_view_data) && !empty($calendar_view_data)){
                    $calendar_view_datas = array_merge($task_view_data,$calendar_view_data);
                } elseif(!empty($task_view_data)) {
                    $calendar_view_datas=$task_view_data;
                }elseif(!empty($calendar_view_data)) {
                    $calendar_view_datas=$calendar_view_data;
                }

                $indData[$i]['calender_view_data'] = $calendar_view_datas;
                $i++;
            }
            unset($i);
            date_default_timezone_set('America/New_York');
            $current_date = date('d');
            $current_month = date('m');
            $current_year = date('Y');
            $current_day = date('D');
            $i = 0;
            $j = 0;
            foreach ($indData as $indRawData) {
                if($indRawData['calender_view_data'] == '' || $indRawData['calender_view_data'] == NULL) {
                    $i++;
                    continue;
                }
                else {
                    foreach ($indRawData['calender_view_data'] as $rawCalendarData) {
                        $calendar_date = strtotime($rawCalendarData['created_at']);
                        $calendar_date = date('d', $calendar_date);
                        $indData[$i]['shift'][$rawCalendarData['shift']][$calendar_date] = $rawCalendarData;

                        $added_by_id = $indData[$i]['shift'][$rawCalendarData['shift']][$calendar_date]['added_by'];
                        $added_by = $this->SuperModel->Super_Get("_uhs_agency", "agency_id=$added_by_id", "fetch");

                        $created_at = $indData[$i]['shift'][$rawCalendarData['shift']][$calendar_date]['created_at'];
                        $assigned_by_detail = "Assigned By ".$added_by['agency_first_name']." ".$added_by['agency_last_name']." On ".date("F d,Y, h:i a", strtotime($created_at));

                        $indData[$i]['shift'][$rawCalendarData['shift']][$calendar_date]['added_by_detail'] = $assigned_by_detail;
                    }
                }
                $i++;
            }
            if (empty($indData)) {
                $healthSession->errorMsg = "No Individual Found.";
                $this->_helper->getHelper("Redirector")->gotoRoute(array(), "front_agency_dashboard");
            }
            unset($added_by_id);
            $document_by_data = $this->SuperModel->Super_Get("_uhs_supports_charting", "indid=$indid AND formid=$formid", "fetchAll");
            if(count($document_by_data) > 0) {
                foreach($document_by_data as $document){
                    $temp[]=$document['added_by'];
                }
                    $added_by_id = $temp;
                    $added_by_id = array_unique($added_by_id);
                    $added_by_name_list = '';
                foreach ($added_by_id as $added_by_id_raw) {
                    $added_by_data = $this->SuperModel->Super_Get("_uhs_agency", "agency_id=$added_by_id_raw", "fetch");

                    $added_by_name_list .= $added_by_data['agency_first_name']." ".$added_by_data['agency_last_name'].", ";
                }
            }
            else {
                $added_by_name_list = ", ";	
            }
        
            $this->view->indData = $indData;
            $this->view->indid = $indid;
            $this->view->formid = $formid;
            $this->view->documented_by_list = rtrim($added_by_name_list, ", ");

            $documented_by_list = rtrim($added_by_name_list, ", ");
           if(!empty($choose_year) && !empty($choose_month)){
                $html = $this->getprinthtmlAction($indData, $indid, $formid, $documented_by_list, $calendar_dates);
           }else {
               $html = $this->getprinthtmlAction($indData, $indid, $formid, $documented_by_list);
           }
        
        
            $indData = $this->SuperModel->Super_Get("_uhs_agency", "agency_id=" . $indid);
            
                require_once ROOT_PATH.'/private/mpdf/mpdf.php';
                $mpdf=new mPDF('utf-8', 'A2');
                //$mpdf->showImageErrors = true;
                ini_set("memory_limit","500M");
                $stylesheet = file_get_contents(APPLICATION_URL.'/public/front_css/style_custom.css');
                $mpdf->SetTitle($this->view->site_configs['site_name'] . " | " . ucwords($indData['agency_first_name'] . " " . $indData['agency_last_name']) . " Forms");
                $mpdf->WriteHTML($stylesheet,1);
                $mpdf->WriteHTML($html,2);
                $mpdf->Output('/home/xoomia/public_html/public/pdf/calendar.pdf','F'); 
                //$mpdf->Output('/var/www/html/xoomia/branches/public/pdf/calendar.pdf','F'); 
		
                $recipients = $data['msg_to'];
		$email_to = explode(',', $recipients);
                $count = count($email_to);
//              $config = array('ssl' => 'tls','port' => 587,'auth'=>'login','username'=>'test4rvtech@gmail.com','password'=>'RVtechtest#123');
//              $transport = new Zend_Mail_Transport_Smtp('smtp.gmail.com', $config);
                $config=array('auth'=>'login','username'=>'rv_test@xoomia.com','password'=>'rvtech@123');
                $transport=new Zend_Mail_Transport_Smtp('xoomia.com',$config);
                    
                $Mc = 1;
		foreach ($email_to as $toemail) {
                    if($Mc >= $count) 
		       {
                                
                            $maildddd = str_replace(' ', '', $toemail);
                            $ReceiverName = str_replace(' ', '', $toemail);
                            $mail = new Zend_Mail();
                            $mail->setBodyHtml($data['msg_text']);
                            $mail->setFrom('client@xoomia.com', 'xoomia.com');
                            $mail->addTo($maildddd,$ReceiverName);
                            $mail->setSubject($data['msg_subject']);
                            $content = file_get_contents("/home/xoomia/public_html/public/pdf/calendar.pdf"); 
                            //$content = file_get_contents("/var/www/html/xoomia/branches/public/pdf/calendar.pdf"); 
                            $attachment = new Zend_Mime_Part($content);
                            $attachment->type = 'application/pdf';
                            $attachment->disposition = Zend_Mime::DISPOSITION_ATTACHMENT;
                            $attachment->encoding = Zend_Mime::ENCODING_BASE64;
                            $attachment->filename = 'calendar.pdf'; // name of file
                            $mail->addAttachment($attachment);                  
                            $transport->send($mail);
                            echo 'done';
                        }  
                    $Mc++;
		}

                $healthSession->successMsg="Data has been email successfully";
                if(!empty($choose_year) && !empty($choose_month)){
                    $this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid,"year"=>$choose_year,"month"=>$choose_month),"forms_calender_view_history");
                } else {
                        $this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"forms_calender_view");
                }
                exit();
            }
        
        exit();
    }
    
    public function getprinthtmlAction125($indData, $indid, $formid, $documented_by_list) {
        $this->indData = $indData;
        $html = '';
        
        $modelSuper=new Application_Model_SuperModel();
        $indData_agencyData=$modelSuper->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
        $this->indData_agencyData = $indData_agencyData;
        $agencyData=$modelSuper->Super_Get("_uhs_agency","agency_id=".$indData_agencyData['agency_user_agency_id'],"fetch");
        $this->agencyData = $agencyData;
        $spanData=$modelSuper->Super_Get("_uhs_spend_dates","agency_id=".$indid." AND spend_status = 1","fetch");
        $this->agencyData = $agencyData;
        
        $agency_information_data = '';
        $agency_information_data .= "<div class='well'>
            <div class='col-lg-6 col-md-6 col-sm-6 col-xs-12'>
                <h4 class='magin0'>Company Information</h4><br/>
                <p><b>Company:</b>".$this->agencyData['agency_company_name']."</p>";
        if(!empty($this->agencyData['agency_address1']) && !empty($this->agencyData['agency_city']) && !empty($this->agencyData['agency_state']) && !empty($this->agencyData['agency_zip'])){
        $address_data = "<p><b>Provider No:</b>".$this->agencyData['agency_provider_number']."</p>
                <p><b>Name:</b>".ucwords($this->agencyData['agency_first_name'].' '.$this->agencyData['agency_last_name'])."</p>
                <p><b>Address: </b>".ucwords($this->agencyData['agency_address1'].','.$this->agencyData['agency_city'].','.$this->agencyData['agency_state'].','.$this->agencyData['agency_zip']); 
        }
        else {
            $address_data = '<p><b>Address: </b>NA</p>';
        }
        $agency_information_data .= $address_data;
        
        $agency_information_data .= "</p>
                <p><b>Contact: </b>".$this->agencyData['agency_contact']."</p>
            </div>
            <hr class='visible-xs clearfix'  />
            <div class='col-lg-6 col-md-6 col-sm-6 col-xs-12'>
                <h4 class='magin0'>Individual Information</h4><br/>
                <div class='row'>
                    <div class='col-lg-6 col-md-6 col-sm-6 col-xs-12'>
                        <p><b>Individual Id:</b>".$this->indData_agencyData['agency_individual_assign_code']."</p>
                    </div>
                    <div class='col-lg-6 col-md-6 col-sm-6 col-xs-12'>";
        $agency_information_data .= "<p><b>Medicaid Number:</b>".isEmpty($this->indData_agencyData['agency_medicaid_number'],$print='-')."</p>
                    </div>
                </div>
                <p><b>Name:</b>".ucwords($this->indData_agencyData['agency_first_name']." ".$this->indData_agencyData['agency_last_name'])."</p>
                <p><b>Address: </b>";
         if(!empty($this->indData_agencyData['agency_address1']) && !empty($this->indData_agencyData['agency_city']) && !empty($this->indData_agencyData['agency_state']) && !empty($this->indData_agencyData['agency_zip'])) {
                        $individual_address = ucwords($this->indData_agencyData['agency_address1'].','.$this->indData_agencyData['agency_city'].','.$this->indData_agencyData['agency_state'].','.$this->indData_agencyData['agency_zip']);
                 }
                 else {
                     $individual_address = 'NA';
                 }
         if(!empty($this->indData_agencyData['agency_latitude']) && !empty($this->indData_agencyData['agency_longitude'])){
           $agency_information_data .= "<i class='fa fa-map-marker markers' title='View Address on Map' onclick='showMap('','')'></i>";
             } 
         $agency_information_data .= "$individual_address</p>

                <div class='row'>
                    <div class='col-lg-6 col-md-6 col-sm-6 col-xs-12'>
                        <p><b>County of Services: </b>";
            if(!empty($this->indData_agencyData['agency_county'])) {
                $individual_country_of_service = $this->indData_agencyData['agency_county'];
            }
            else {
                $individual_country_of_service = 'NA';
            }   
           $agency_information_data .= "$individual_country_of_service</p>
                    </div>

                    <div class='col-lg-6 col-md-6 col-sm-6 col-xs-12'>
                        <p><b>Contact: </b>";
           if(!empty($this->indData_agencyData['agency_contact'])) {
               $individual_contact = $this->indData_agencyData['agency_contact'];
           }
           else {
               $individual_contact = 'NA';
           }
           $agency_information_data .= "$individual_contact</p>
                    </div>
                </div>        

                <p><b>Individual Service Plan: </b>";
                if(isset($this->spanData['spend_id'])){ 
                            if(!empty($this->spanData['spend_from_date']) && !empty($this->spanData['spend_to_date'])){
                                $individual_service_plan = $this->spanData['spend_from_date'].' - '.$this->spanData['spend_to_date'];
                            }
                            else {
                                $individual_service_plan = 'NA';
                            }
                        }
                        else {
                            $individual_service_plan = 'NA';
                        }
            $agency_information_data .= "$individual_service_plan</p>";
        $agency_information_data .= "</div>
            <div class='clearfix'>&nbsp;</div>
        </div>";
        //$agency_information = $this->getHelper("CommonCodes")->indAgencyInformation($this->indid);
        
        $html = '';
$html .= "<div class='col-lg-12 col-md-12 col-sm-12 col-xs-12 profile-container calendar-view-clone-wrapper'>"
. "<div class='clearfix'></div>"
. "<h3>$this->pageHeading</h3>"
. "<div class='row'>"
. "<div class='col-md-12'>"
. "<div class='portlet box yellow'>"
. "<div class='portlet-body'>"
. "$agency_information_data"
. "<div class='clearfix'>&nbsp;</div>"
. "<div class='col-lg-10 col-md-10 col-sm-10 col-xs-12 padding0'>"
. "<div class='col-lg-9 col-md-9 col-sm-9 col-xs-12 text-left padding0'>"
. "<span style='color:#13bca6'>'A'</span>=Administered &nbsp;"
. "<span style='color:#13bca6'>'NA'</span>=Not Administered &nbsp;"
. "<span style='color:#13bca6'> 'R'</span>=Refuse &nbsp;"
. "</div>"
. "</div>"
. "<div class='col-lg-2 col-md-2 col-sm-2 col-xs-12'>"
. "<button id='calendar-view-smart-print' style='display:none' type='button' class='btn btn-sm red' onclick=''>Print</button>"
. "</div>"
. "<div class='clearfix'>&nbsp;</div>"
. "<div class='col-lg-12 col-md-12 col-sm-12 col-xs-12 padding0 newscontent'>"
. "<button class='btn btn-xs grey-gallery' style='display:none'>View History</button>"
. "<div class='clearfix'>&nbsp;</div>"
. "<table id='' width='100%' border='0' cellpadding='0' cellspacing='0' class=''>"
. "<tbody>"
. "<tr>"
. "<td>"
. "<table width='100%' border='0' cellpadding='0' cellspacing='0' class='boldfont'>"
. "<tr>"
. "<td style='width:35%'> ABOVE AND BEYOND CAREGIVERS </td>"
. "<td style='width:65%'>";

$date_1 = date('F/Y');

$html .= "$date_1</td>"
. "</tr>"
. "</table>"
. "</td>"
. "</tr>";

date_default_timezone_set('America/New_York');
//$date = date('Y-m-d H:i:s');
//echo '<h1>'.$date.'</h1 >';
$current_date = date('d');
$current_month = date('m');
$current_year = date('Y');
$current_day = date('D');
$total_days_in_current_month = date('t', mktime(0, 0, 0, $current_month, 1, $current_year));

if (count($this->indData) > 0) :
$charting_form_id = 1;
$amend_id = 1;
foreach ($this->indData as $data) :
if ($data['support_shift'] == '') {
continue;
}

$html .= "<tr class='support-calendar-data'>"
. "<td>"
. "<table width='100%' border='0' cellpadding='0' cellspacing='0' class='bordertopmar textuppercase cv-data-wrapper'>"
. "<tbody>"
. "<tr>"
. "<td style='width:25%;' class='cv-data-caregiver-wrapper'>"
. "<table width='100%' border='0' cellpadding='0' cellspacing='0'>"
. "<tbody>"
. "<tr class='boldfont'>"
. "<td width='75%' colspan='2' valign='top'>Frequency: ";
$var_1 = $data['support_frequency'];
$html .= "$var_1</td>"
. "</tr>"
. "<tr>"
. "<td width='75%' valign='top'></td>"
. "<td valign='top'></td>"
. "</tr>"
. "<tr>"
. "<td colspan='2'> Support: ";
$var_2 = $data['support_description'];
$html .= "$var_2</td>"
. "</tr>"
. "</tbody>"
. "</table>"
. "</td>"
. "<td style='width:75%' class='verticle_align_top'>"
. "<table width='100%' border='0' cellpadding='0' cellspacing='0' class=''>"
. "<tbody>"
. "<tr class='marborderclass' style='border-top:none !important'>"
. "<td class='marborderrightclass' style='width:7%;'> SHIFT </td>";

for ($i = 1; $i <= $total_days_in_current_month; $i++) :
$timestamp = strtotime($current_year . "-" . $current_month . "-" . $i);
if ($i == $current_date) {
$var = 'today_date_class';
}
else {
$var = '';
}
$var_1 = date('D', $timestamp);
$html .= "<td class='marborderrightclass ".$var."'> $i<br> <small style='font-size:50% !important;'>$var_1</small> </td>";
endfor;
$html .= "</tr>";
$shift_data = json_decode($data['support_shift']);
foreach ($shift_data as $shifts_data) :
if ($shifts_data == '' || $shifts_data == NULL) :
continue;
endif;
$html .= "<tr class='marborderclass'>"
. "<td class='marborderrightclass' style='width:7%;'>&nbsp;</td>";
for ($i = 1; $i <= $total_days_in_current_month; $i++) :
if ($i < 10) {
$date_checker = '0' . $i;
} else {
$date_checker = $i;
}
if (empty($data['shift'][$shifts_data][$date_checker])) :
$html .= "<td class='marborderrightclass'>&nbsp;</td>";
else :
$getdet = $data['shift'][$shifts_data][$date_checker]['added_by_detail'];
$abname = explode(' ', $getdet, 5);
$fn = substr($abname[2], 0, 1);
$ln = substr($abname[3], 0, 1);
$html .= "<td class='marborderrightclass'>"
        . "</td>";
endif;
endfor;
$html .= "</tr>"
        . "<tr class='marborderclass'>"
        . "<td class='marborderrightclass' style='width:7%; background:transparent;'>$shifts_data</td>";
for ($i = 1; $i <= $total_days_in_current_month; $i++) :
if ($i < 10) {
    $date_checker = '0' . $i;
} else {
    $date_checker = $i;
}
if ($i == $current_date) :
    if (empty($data['shift'][$shifts_data][$date_checker])) :
$html .= "<td class='marborderrightclass'></td>"
            . "";
    else :
$html .= "<td class='marborderrightclass'></td>";
    endif;
    $charting_form_id++;
    else :
        if ($data['calender_view_data'] == '' || $data['calender_view_data'] == NULL) :
            if ($i < $current_date) :
$html .= "<td class='marborderrightclass'></td>";
else :
    $html .= "<td class='marborderrightclass'></td>";
endif;
else :
if (empty($data['shift'][$shifts_data][$date_checker])) :
    if ($i < $current_date) :
$html .= "<td class='marborderrightclass'></td>";
else :
$html .= "<td class='marborderrightclass'></td>";
endif;
else :
$var_1 = $data['shift'][$shifts_data][$date_checker]['is_amended'] == 1 ? 'darkgoldenrod' : 'gray';
$html .= "<td class='marborderrightclass' style='background-color: ".$var_1."'>";
$var_1 = $data['shift'][$shifts_data][$date_checker]['added_by_detail'];
$var_2 = $data['shift'][$shifts_data][$date_checker]['shift_option'];
$html .= "<span data-toggle='tooltip' title='".$var_1."' style='color: white'>$var_2</span>"
        . "</td>";
endif;
endif;
endif;
endfor;
$html .= "</tr>";
endforeach;
$html .= "</tbody>"
        . "</table>"
        . "</td>"
        . "</tr>"
        . "</tbody>"
        . "</table>"
        . "<div style='float: right; margin-top: 5px;'>"
        . "<a style='display:none' class='calendar-view-amend-btn' data-amend_id=''>Amend </a>"
        . "</div>"
        . "</td>"
        . "</tr>"
        . "<tr class=''>"
        . "<td style='height:15px;'></td>"
        . "</tr>"
        . "";
$amend_id++;
endforeach;
endif;
$html .= "</tbody>"
        . "</table>"
        . "<table style='width: 100%'>"
        . "<tbody>"
        . "<tr style='border-top: 2px solid'>"
        . "<th>Documenting By</th>"
        . "</tr>"
        . "<tr>"
        . "<td>$documented_by_list<br>"
        . "<span class='agcd'>Agency</span>"
        . "</td>"
        . "</tr>"
        . "</tbody>"
        . "</table>"
        . "<div class='clearfix'>&nbsp;</div>"
        . "</div>"
        . "</div>"
        . "</div>"
        . "</div>"
        . "</div>"
        . "<div class='clearfix'></div>"
        . "</div>";

        $html .= '<style>';
        $html .= file_get_contents(APPLICATION_URL.'/public/plugins/bootstrap/css/bootstrap.min.css');
        $html .= file_get_contents(APPLICATION_URL.'/public/front_css/style_custom.css');
        $html .= '</style>';
        
        return $html;
        
    }



    public function getprinthtmlAction($indData, $indid, $formid, $documented_by_list, $calendar_dates="") {
        $this->indData = $indData;
        $html = '';

        $modelSuper = new Application_Model_SuperModel();
        $indData_agencyData = $modelSuper->Super_Get("_uhs_agency", "agency_id=" . $indid, "fetch");
        $this->indData_agencyData = $indData_agencyData;
        $agencyData = $modelSuper->Super_Get("_uhs_agency", "agency_id=" . $indData_agencyData['agency_user_agency_id'], "fetch");
        $this->agencyData = $agencyData;
        $spanData = $modelSuper->Super_Get("_uhs_spend_dates", "agency_id=" . $indid . " AND spend_status = 1", "fetch");
        $this->agencyData = $agencyData;
        $this->spanData = $spanData;
        $this->pageHeading = "Calender Logs";

        $agency_information_data = '';
//        $agency_information_data .= "<div class='well' style='    min-height: 20px;
//    padding: 19px;
//    margin-bottom: 15px;
//    background-color: #f5f5f5;
//    border: 1px solid #e3e3e3;
//    border-radius: 4px;
//    -webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,.05);
//    box-shadow: inset 0 1px 1px rgba(0,0,0,.05);'>
//            <div class='col-lg-6 col-md-6 col-sm-6 col-xs-12' style='    width: 50%;
//    float: left;'>
//                <h4 class='magin0'>Company Information</h4><br/>
//                <p><b>Company:</b>" . $this->agencyData['agency_company_name'] . "</p>";
//        if (!empty($this->agencyData['agency_address1']) && !empty($this->agencyData['agency_city']) && !empty($this->agencyData['agency_state']) && !empty($this->agencyData['agency_zip'])) {
//            $address_data = "<p><b>Provider No:</b>" . $this->agencyData['agency_provider_number'] . "</p>
//                <p><b>Name:</b>" . ucwords($this->agencyData['agency_first_name'] . ' ' . $this->agencyData['agency_last_name']) . "</p>
//                <p><b>Address: </b>" . ucwords($this->agencyData['agency_address1'] . ',' . $this->agencyData['agency_city'] . ',' . $this->agencyData['agency_state'] . ',' . $this->agencyData['agency_zip']);
//        } else {
//            $address_data = '<p><b>Address: </b>NA</p>';
//        }
//        $agency_information_data .= $address_data;
//
//        $agency_information_data .= "</p>
//                <p><b>Contact: </b>" . $this->agencyData['agency_contact'] . "</p>
//            </div>
//            <!--<hr class='visible-xs clearfix'  />-->
//            <div class='col-lg-6 col-md-6 col-sm-6 col-xs-12' style='width: 50%;
//    float: left;'>
//                <h4 class='magin0'>Individual Information</h4><br/>
//                <div class='row'>
//                    <div class='col-lg-6 col-md-6 col-sm-6 col-xs-12' style='width: 50%;float: left;'>
//                        <p><b>Individual Id:</b>" . $this->indData_agencyData['agency_individual_assign_code'] . "</p>
//                    </div>
//                    <div class='col-lg-6 col-md-6 col-sm-6 col-xs-12' style='width: 50%;float: left;'>";
//        $agency_information_data .= "<p><b>Medicaid Number:</b>" . isEmpty($this->indData_agencyData['agency_medicaid_number'], $print = '-') . "</p>
//                    </div>
//                </div>
//                <p><b>Name:</b>" . ucwords($this->indData_agencyData['agency_first_name'] . " " . $this->indData_agencyData['agency_last_name']) . "</p>
//                <p><b>Address: </b>";
//        if (!empty($this->indData_agencyData['agency_address1']) && !empty($this->indData_agencyData['agency_city']) && !empty($this->indData_agencyData['agency_state']) && !empty($this->indData_agencyData['agency_zip'])) {
//            $individual_address = ucwords($this->indData_agencyData['agency_address1'] . ',' . $this->indData_agencyData['agency_city'] . ',' . $this->indData_agencyData['agency_state'] . ',' . $this->indData_agencyData['agency_zip']);
//        } else {
//            $individual_address = 'NA';
//        }
//        if (!empty($this->indData_agencyData['agency_latitude']) && !empty($this->indData_agencyData['agency_longitude'])) {
//            $agency_information_data .= "<i class='fa fa-map-marker markers' title='View Address on Map' onclick='showMap('','')'></i>";
//        }
//        $agency_information_data .= "$individual_address</p>
//
//                <div class='row'>
//                    <div class='col-lg-6 col-md-6 col-sm-6 col-xs-12' style='width: 50%;float: left;'>
//                        <p><b>County of Services: </b>";
//        if (!empty($this->indData_agencyData['agency_county'])) {
//            $individual_country_of_service = $this->indData_agencyData['agency_county'];
//        } else {
//            $individual_country_of_service = 'NA';
//        }
//        $agency_information_data .= "$individual_country_of_service</p>
//                    </div>
//
//                    <div class='col-lg-6 col-md-6 col-sm-6 col-xs-12' style='width: 50%;float: left;'>
//                        <p><b>Contact: </b>";
//        if (!empty($this->indData_agencyData['agency_contact'])) {
//            $individual_contact = $this->indData_agencyData['agency_contact'];
//        } else {
//            $individual_contact = 'NA';
//        }
//        $agency_information_data .= "$individual_contact</p>
//                    </div>
//                </div>        
//
//                <p><b>Individual Service Plan: </b>";
//        if (isset($this->spanData['spend_id'])) {
//            if (!empty($this->spanData['spend_from_date']) && !empty($this->spanData['spend_to_date'])) {
//                $individual_service_plan = $this->spanData['spend_from_date'] . ' - ' . $this->spanData['spend_to_date'];
//            } else {
//                $individual_service_plan = 'NA';
//            }
//        } else {
//            $individual_service_plan = 'NA';
//        }
//        $agency_information_data .= "$individual_service_plan</p>";
//        $agency_information_data .= "</div>
//            <div class='clearfix'>&nbsp;</div>
//        </div>";
       /////////////////////////////////////
        
        $agency_information_data .="
            <div class='col-lg-6 col-md-6 col-sm-6 col-xs-12' style='width: 50%;float: left;'>
                <h4>Company Information</h4>
                <b>Company:</b>" . $this->agencyData['agency_company_name'] . "<BR>";
        if (!empty($this->agencyData['agency_address1']) && !empty($this->agencyData['agency_city']) && !empty($this->agencyData['agency_state']) && !empty($this->agencyData['agency_zip'])) {
            $address_data = "<b>Provider No:</b>" . $this->agencyData['agency_provider_number'] . "<BR>
                <b>Name:</b>" . ucwords($this->agencyData['agency_first_name'] . ' ' . $this->agencyData['agency_last_name']) . "<BR>
                <b>Address: </b>" . ucwords($this->agencyData['agency_address1'] . ',' . $this->agencyData['agency_city'] . ',' . $this->agencyData['agency_state'] . ',' . $this->agencyData['agency_zip']);
        } else {
            $address_data = '<b>Address: </b>NA';
        }
        $agency_information_data .= $address_data;

        $agency_information_data .= "<BR>
                <b>Contact: </b>" . $this->agencyData['agency_contact'] . "<BR>
            </div>
            
            <div class='col-lg-6 col-md-6 col-sm-6 col-xs-12' style='width: 50%;float: left;'>
                <h4>Individual Information</h4>
                
                        <b>Individual Id:</b>" . $this->indData_agencyData['agency_individual_assign_code'] . "<BR>";
                    
        $agency_information_data .= "<b>Medicaid Number:</b>" . isEmpty($this->indData_agencyData['agency_medicaid_number'], $print = '-') . "<BR>
                    
                
                <b>Name:</b>" . ucwords($this->indData_agencyData['agency_first_name'] . " " . $this->indData_agencyData['agency_last_name']) . "<BR>
                <b>Address: </b>";
        if (!empty($this->indData_agencyData['agency_address1']) && !empty($this->indData_agencyData['agency_city']) && !empty($this->indData_agencyData['agency_state']) && !empty($this->indData_agencyData['agency_zip'])) {
            $individual_address = ucwords($this->indData_agencyData['agency_address1'] . ',' . $this->indData_agencyData['agency_city'] . ',' . $this->indData_agencyData['agency_state'] . ',' . $this->indData_agencyData['agency_zip']);
        } else {
            $individual_address = 'NA';
        }
        if (!empty($this->indData_agencyData['agency_latitude']) && !empty($this->indData_agencyData['agency_longitude'])) {
            $agency_information_data .= "<i class='fa fa-map-marker markers' title='View Address on Map' onclick='showMap('','')'></i>";
        }
        $agency_information_data .= "$individual_address<BR>

                
                        <b>County of Services: </b>";
        if (!empty($this->indData_agencyData['agency_county'])) {
            $individual_country_of_service = $this->indData_agencyData['agency_county'];
        } else {
            $individual_country_of_service = 'NA';
        }
        $agency_information_data .= "$individual_country_of_service<BR>
                    

                    
                        <b>Contact: </b>";
        if (!empty($this->indData_agencyData['agency_contact'])) {
            $individual_contact = $this->indData_agencyData['agency_contact'];
        } else {
            $individual_contact = 'NA';
        }
        $agency_information_data .= "$individual_contact<BR>
                         

                <b>Individual Service Plan: </b>";
        if (isset($this->spanData['spend_id'])) {
            if (!empty($this->spanData['spend_from_date']) && !empty($this->spanData['spend_to_date'])) {
                $individual_service_plan = $this->spanData['spend_from_date'] . ' - ' . $this->spanData['spend_to_date'];
            } else {
                $individual_service_plan = 'NA';
            }
        } else {
            $individual_service_plan = 'NA';
        }
        $agency_information_data .= "$individual_service_plan";
        $agency_information_data .= "
            
        </div>
         ";

        //////////////////
        //$agency_information = $this->getHelper("CommonCodes")->indAgencyInformation($this->indid);

        $html = '';
        $html .= $agency_information_data;
        $html .= "<div class='col-lg-12 col-md-12 col-sm-12 col-xs-12 profile-container calendar-view-clone-wrapper' style='
    position: relative;
    min-height: 1px;
    padding-right: 15px;
    padding-left: 15px;'>"
                . "<div class='clearfix'></div>"
                . "<h3>$this->pageHeading</h3>"
                . "<div class='row'>"
                . "<div class='col-md-12'>"
                . "<div class='portlet box yellow'>"
                . "<div class='portlet-body'>"
                . "<div class='clearfix'>&nbsp;</div>"
                . "<div class='col-lg-10 col-md-10 col-sm-10 col-xs-12 padding0'>"
                . "<div class='col-lg-9 col-md-9 col-sm-9 col-xs-12 text-left padding0'>"
                . "<span style='color:#13bca6'>'C'</span>=Completed &nbsp;"
                . "<span style='color:#13bca6'>'NC'</span>=Not Completed &nbsp;"
                . "<span style='color:#13bca6'>'A'</span>=Administered &nbsp;"
                . "<span style='color:#13bca6'>'NA'</span>=Not Administered &nbsp;"
                . "<span style='color:#13bca6'> 'R'</span>=Refuse &nbsp;"
                . "</div>"
                . "</div>"
                . "<div class='clearfix'>&nbsp;</div>"
                . "<table id='' width='100%' border='0' cellpadding='0' cellspacing='0' class=''>"
                . "<tbody>"
                . "<tr>"
                . "<td>"
                . "<table width='100%' border='0' cellpadding='0' cellspacing='0' class='boldfont'>"
                . "<tr>"
                . "<td style='width:35%'>" . $this->agencyData['agency_company_name'] . "</td>"
                . "<td style='width:65%'>";
        if(!empty($calendar_dates)){
            $date_1 = date('F/Y', strtotime($calendar_dates));
        } else {
            $date_1 = date('F/Y');
        }
        

        $html .= "$date_1</td>"
                . "</tr>"
                . "</table>"
                . "</td>"
                . "</tr>";

        date_default_timezone_set('America/New_York');
//$date = date('Y-m-d H:i:s');
//echo '<h1>'.$date.'</h1 >';
        
        
        if(!empty($calendar_dates)){
            $current_date = date('d', strtotime($calendar_dates));
            $current_month = date('m', strtotime($calendar_dates));
            $current_year = date('Y', strtotime($calendar_dates));
            $current_day = date('D', strtotime($calendar_dates));
        } else {
            $current_date = date('d');
            $current_month = date('m');
            $current_year = date('Y');
            $current_day = date('D');
        }
        
        
        
        $total_days_in_current_month = date('t', mktime(0, 0, 0, $current_month, 1, $current_year));

        if (count($this->indData) > 0) :
            $charting_form_id = 1;
            $amend_id = 1;
            foreach ($this->indData as $data) :
                if ($data['support_shift'] == '') {
                    continue;
                }

                $html .= "<tr class='support-calendar-data'>"
                        . "<td>"
                        . "<table width='100%' border='0' cellpadding='0' cellspacing='0' class='bordertopmar textuppercase cv-data-wrapper' style='border-top: 1px solid #000;'>"
                        . "<tbody>"
                        . "<tr>"
                        . "<td style='width:25%;vertical-align: top;' class='cv-data-caregiver-wrapper'>"
                        . "<table width='50%' border='0' cellpadding='0' cellspacing='0'>"
                        . "<tbody>"
                        . "<tr class='boldfont' style='font-weight: 700'>"
                        . "<td width='75%' colspan='2' valign='top'>Frequency: ";
                $var_1 = $data['support_frequency'];
                $html .= "$var_1</td>"
                        . "</tr>"
                        . "<tr>"
                        . "<td width='75%' valign='top'></td>"
                        . "<td valign='top'></td>"
                        . "</tr>"
                        . "<tr>"
                        . "<td colspan='2'> Support: ";
                $var_2 = $data['support_description'];
                $html .= "$var_2</td>"
                        . "</tr>"
                        . "</tbody>"
                        . "</table>"
                        . "</td>"
                        . "<td style='width:75%' class='verticle_align_top'>"
                        . "<table width='100%' border='1' cellpadding='0' cellspacing='0' class=''>"
                        . "<tbody>"
                        . "<tr class='marborderclass' style='border-top:none !important;'>"
                        . "<td class='marborderrightclass' style='width:7%;'> SHIFT </td>";

                for ($i = 1; $i <= $total_days_in_current_month; $i++) :
                    $timestamp = strtotime($current_year . "-" . $current_month . "-" . $i);
                    if ($i == $current_date) {
                        if(!empty($calendar_dates)){
                            $var = '';
                        }else{
                            $var = 'today_date_class';
                        }
                        
                    } else {
                        $var = '';
                    }
                    $var_1 = date('D', $timestamp);
                    $html .= "<td class='marborderrightclass " . $var . "'> $i<br> <small style='font-size:50% !important;'>$var_1</small> </td>";
                endfor;
                $html .= "</tr>";
                $shift_data = json_decode($data['support_shift']);
                foreach ($shift_data as $shifts_data) :
                    if ($shifts_data == '' || $shifts_data == NULL) :
                        continue;
                    endif;
                    $html .= "<tr class='marborderclass'>"
                            . "<td class='marborderrightclass' style='width:7%;'>&nbsp;</td>";
                    for ($i = 1; $i <= $total_days_in_current_month; $i++) :
                        if ($i < 10) {
                            $date_checker = '0' . $i;
                        } else {
                            $date_checker = $i;
                        }
                        if (empty($data['shift'][$shifts_data][$date_checker])) :
                            $html .= "<td class='marborderrightclass'>&nbsp;</td>";
                        else :
                            $getdet = $data['shift'][$shifts_data][$date_checker]['added_by_detail'];
                            $abname = explode(' ', $getdet, 5);
                            $fn = substr($abname[2], 0, 1);
                            $ln = substr($abname[3], 0, 1);
                            $html .= "<td class='marborderrightclass'>"
                                    . "</td>";
                        endif;
                    endfor;
                    $html .= "</tr>"
                            . "<tr class='marborderclass'>"
                            . "<td class='marborderrightclass' style='width:7%; background:transparent;'>$shifts_data</td>";
                    for ($i = 1; $i <= $total_days_in_current_month; $i++) :
                        if ($i < 10) {
                            $date_checker = '0' . $i;
                        } else {
                            $date_checker = $i;
                        }
                        if ($i == $current_date) :
                            if (empty($data['shift'][$shifts_data][$date_checker])) :
                                $html .= "<td class='marborderrightclass'></td>"
                                        . "";
                            else :
                                $html .= "<td class='marborderrightclass'></td>";
                            endif;
                            $charting_form_id++;
                        else :
                            if ($data['calender_view_data'] == '' || $data['calender_view_data'] == NULL) :
                                if ($i < $current_date) :
                                    $html .= "<td class='marborderrightclass'></td>";
                                else :
                                    $html .= "<td class='marborderrightclass'></td>";
                                endif;
                            else :
                                if (empty($data['shift'][$shifts_data][$date_checker])) :
                                    if ($i < $current_date) :
                                        $html .= "<td class='marborderrightclass'></td>";
                                    else :
                                        $html .= "<td class='marborderrightclass'></td>";
                                    endif;
                                else :
                                    $var_1 = $data['shift'][$shifts_data][$date_checker]['is_amended'] == 1 ? 'darkgoldenrod' : 'gray';
                                    $html .= "<td class='marborderrightclass' style='background-color: " . $var_1 . "'>";
                                    $var_1 = $data['shift'][$shifts_data][$date_checker]['added_by_detail'];
                                    $var_2 = $data['shift'][$shifts_data][$date_checker]['shift_option'];
                                    $html .= "<span data-toggle='tooltip' title='" . $var_1 . "' style='color: white'>$var_2</span>"
                                            . "</td>";
                                endif;
                            endif;
                        endif;
                    endfor;
                    $html .= "</tr>";
                endforeach;
                $html .= "</tbody>"
                        . "</table>"
                        . "</td>"
                        . "</tr>"
                        . "</tbody>"
                        . "</table>"
                        . "</td>"
                        . "</tr>"
                        . "<tr class=''>"
                        . "<td style='height:25px;text-align:right;color:blue;'>Amend</td>"
                        . "</tr>"
                        . "";
                $amend_id++;
            endforeach;
        endif;
        $html .= "</tbody>"
                . "</table>"
                . "<table style='width: 100%'>"
                . "<tr style='border-top: 2px solid'>"
                . "<th style='float:left;'></th>"
                . "</tr>"
                . "<tr>"
                . "<td>Documenting By<br>$documented_by_list<br>"
                . "<span class='agcd' style='background: #47bca6;color: white;padding: 3px;font-size: 12px;border-radius: 2px;'>Agency</span>"
                . "</td>"
                . "</tr>"
                
                . "</table>"
                . "<div class='clearfix'>&nbsp;</div>"
                . "</div>"
                . "</div>"
                . "</div>"
                . "</div>"
                . "</div>"
                . "<div class='clearfix'></div>"
                . "</div>";

//        $html .= '<style>';
//        $html .= file_get_contents(APPLICATION_URL.'/public/plugins/bootstrap/css/bootstrap.min.css');
//        $html .= file_get_contents(APPLICATION_URL.'/public/front_css/style_custom.css');
//        $html .= '</style>';

        return $html;
    }
	
   // Get Assigned Forms in Business Users Dashboard
	public function individualassignedformsAction(){
		global $systemusers,$healthSession; 
		if(!in_array($this->view->user->agency_user_type,$systemusers)){
		   global $healthSession;
		   $healthSession->errorMsg="You don't have permission to access this page.";
		   $this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
  		$this->view->pageHeading = "Assigned Forms";
		$indid=$this->_getParam("indid");
		
		if(empty($indid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		$indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
		
		$this->view->indData=$indData;
		$this->view->indid=$indid;
  	
	}
	
	public function getassignedformsAction(){
		if(check_is_ajax($this->_request)){
			$this->_redirect(APPLICATION_URL);
		}
		$indid=$this->_getParam("indid");
 		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('afid','form_agency_id','form_individual_id','assigned_form_id');
		$sIndexColumn = 'afid';
		$sTable = '_uhs_individual_assigned_forms';
		$sLimit = "";
		if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' ){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		if ( isset( $_GET['iSortCol_0'] ) )
		{
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
			{
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
				{
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
		if($sWhere){
			$sWhere.=" and form_individual_id=".$indid;
		}
		else{
			$sWhere.=" Where form_individual_id=".$indid;
		}
		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
 		$qry = $this->dbObj->query($sQuery)->fetchAll();
		$sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
		$output = array(
 				"iTotalRecords" => $iTotal,
				"iTotalDisplayRecords" => $iFilteredTotal,
				"aaData" => array()
			);
		$j=0;
		// foreach($qry as $row1){
		//  $assignedForms[]=$this->SuperModel->Super_Get("_uhs_agency_forms","form_id=".$row1['assigned_form_id'],"fetch");
		// }
		// print_r($assignedForms);
		// die;
		foreach($qry as $row1){
			$clickBtn=""; $href="javascript:void(1);"; 
			$clk_Btn=$linkText=$viewLink=$notify=$addlink=$hreff="";
			$assignedForms=$this->SuperModel->Super_Get("_uhs_agency_forms","form_id=".$row1['assigned_form_id'],"fetch");
			$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
                        if($assignedForms['form_number'] == "DD 123"){
                            continue;
                        }
         //    if($assignedForms['form_number']=="DD 52"){
        	//   $row[] = "<a href='" . getFormLinks($row1['assigned_form_id'], $indid, "View") . "' class='btn btn-xs btn-default'>View Logs</a>";
        	// }
            if($assignedForms['form_number']=="DD 112"){ 
            	
				$hreff="javascript:void(1);";
				$type='"AssignedCredit"';
				$nullVal='""';
				$clk_Btn="OnClick='showDiffrentForms(".$indid.",".$row1['assigned_form_id'].",".$nullVal.",".$type.");'";
				$viewLink="<a href='".APPLICATION_URL."/view-assigned-balance/".$indid."/".$row1['assigned_form_id']."' class='btn btn-xs btn-default'>View Accounts Balance</a>&nbsp;";
				$linkText="Add Credit";
				$addlink = "<a href='" . $hreff . "' " . $clk_Btn . " class='btn btn-xs btn-default'>".$linkText."</a>&nbsp;"; 
				$getAssignedBalance=$this->SuperModel->Super_Get("_uhs_financial_initial_balance","balance_form_id='".$assignedForms['form_id']."' and balance_individual_id='".$indid."' and Month(balance_added_date)=MONTH(CURDATE())","fetch");
				if(empty($getAssignedBalance)){
				  $notify="&nbsp;<span class='badge badge-danger badge_pulsate pull-right'>Initial Balance is not setup yet.</span>";
			    }
			}
			if($assignedForms['form_number']=="DD 124"){ 
				$hreff="javascript:void(1);";
				$type='"AssignedFoodBalance"';
				$nullVal='""';
				$clk_Btn="OnClick='showDiffrentForms(".$indid.",".$row1['assigned_form_id'].",".$nullVal.",".$type.");'";
				$viewLink="<a href='".APPLICATION_URL."/view-assigned-food-balance/".$indid."/".$row1['assigned_form_id']."' style='margin-top:5px;' class='btn btn-xs btn-default'>View Intial Balance</a>&nbsp;";
				$linkText="Add Initial Balance";
				$addlink = "<a href='" . $hreff . "' " . $clk_Btn . " class='btn btn-xs btn-default'>".$linkText."</a>&nbsp;"; 
				$getAssignedBalance=$this->SuperModel->Super_Get("_uhs_food_initial_balance","fb_form_id=".$row1['assigned_form_id']." and fb_individual_id=".$indid,"fetch",array("order"=>"fbid DESC"));
					if(empty($getAssignedBalance)){
						$notify="&nbsp;<span class='badge badge-danger badge_pulsate pull-right'>Initial Balance is not setup yet.</span>";
					}
			}
			if($assignedForms['form_number']=="DD 138"){ 
				$hreff="javascript:void(1);";
				$type='"AssignedGroceriesBalance"';
				$nullVal='""';
				$clk_Btn="OnClick='showDiffrentForms(".$indid.",".$row1['assigned_form_id'].",".$nullVal.",".$type.");'";
				$viewLink="<a href='".APPLICATION_URL."/view-assigned-groceries-balance/".$indid."/".$row1['assigned_form_id']."' style='margin-top:5px;' class='btn btn-xs btn-default'>View Intial Balance</a>&nbsp;";
				$linkText="Add Initial Balance";
				$addlink = "<a href='" . $hreff . "' " . $clk_Btn . " class='btn btn-xs btn-default'>".$linkText."</a>&nbsp;"; 
				$getAssignedGroceriesBalance=$this->SuperModel->Super_Get("_uhs_groceries_initial_balance","gr_form_id=".$row1['assigned_form_id']." and gr_individual_id=".$indid,"fetch",array("order"=>"grid DESC"));
					if(empty($getAssignedGroceriesBalance)){
						$notify="&nbsp;<span class='badge badge-danger badge_pulsate pull-right'>Initial Balance is not setup yet.</span>";
					}
			}
            $row=array();
 			$row[] = $j+1;
			$row[]='<input class="elem_ids checkboxes" type="checkbox" name="records['.$row1['assigned_form_id'].']"  value="'.$row1['assigned_form_id'].'">';
		    $row[]=ucwords($assignedForms['form_number']); 
  			$row[]=ucwords($assignedForms['form_title']).$notify;
			
			if($assignedForms['form_number']=="DD 114" || $assignedForms['form_number']=="DD 116" || $assignedForms['form_number']=="DD 118" || $assignedForms['form_number']=="DD 120" || $assignedForms['form_number']=="DD 128" || $assignedForms['form_number']=="DD 106"  || $assignedForms['form_number']=="DD 108" || $assignedForms['form_number']=="DD 122" || $assignedForms['form_number']=="DD 126" || $assignedForms['form_number']=="DD 112" || $assignedForms['form_number']=="DD 124" || $assignedForms['form_number']=="DD 144" || $assignedForms['form_number']=="DD 138"){
				$clickBtn=getFormLinks($row1['assigned_form_id'],$indid,"Add",true);
			}
			else{
				$href=getFormLinks($row1['assigned_form_id'],$indid,"Add");
			}
			if($assignedForms['form_number']=="DD 108"){ 
				$getAssignedMileage=$this->SuperModel->Super_Get("_uhs_assigned_miles","m_form_id='".$assignedForms['form_id']."' and m_individual_id='".$indid."' and Month(miles_added_date)=MONTH(CURDATE())","fetch");
				if(empty($getAssignedMileage)){
					$text='"You can not add record."';
					$clickBtn="onClick='showCustomAlert(".$text.")';";
				}
			}
			if($assignedForms['form_number']=="DD 112"){ 
			   $getAssignedBalance=$this->SuperModel->Super_Get("_uhs_financial_initial_balance","balance_form_id='".$assignedForms['form_id']."' and balance_individual_id='".$indid."' and Month(balance_added_date)=MONTH(CURDATE())","fetch");
				if(empty($getAssignedBalance)){
					$text='"You can not add record."';
					$clickBtn="onClick='showCustomAlert(".$text.")';";
				}
			}
			if($assignedForms['form_number']=="DD 124"){ 
				$getAssignedFoodBal=$this->SuperModel->Super_Get("_uhs_food_initial_balance","fb_form_id='".$assignedForms['form_id']."' and fb_individual_id='".$indid."' and Month(fb_added_date)=MONTH(CURDATE())","fetch");
				if(empty($getAssignedFoodBal)){
					$text='"You can not add record."';
					$clickBtn="onClick='showCustomAlert(".$text.")';";
				}
			}
			
			if($assignedForms['form_number']=="DD 138"){ 
				$getAssignedGroceriesBal=$this->SuperModel->Super_Get("_uhs_groceries_initial_balance","gr_form_id='".$assignedForms['form_id']."' and gr_individual_id='".$indid."' and Month(gr_added_date)=MONTH(CURDATE())","fetch");
				if(empty($getAssignedGroceriesBal)){
					$text='"You can not add record."';
					$clickBtn="onClick='showCustomAlert(".$text.")';";
				}
			}
			
			if($permissions=="Edit" || $permissions=="Both"){
				if($assignedForms['form_number'] == "DD 104") {
                    //$row[] = "<a href='" . $href . "' " . $clickBtn . " class='btn btn-xs btn-default'>Add New</a> &nbsp; <a href='" . getFormLinks($row1['assigned_form_id'], $indid, "View") . "' class='btn btn-xs btn-default'>View Logs</a>";
                    //$viewLink = "<a href='" . APPLICATION_URL . "/calender-view/" . $indid . "/" . $row1['form_id'] . "' style='margin-top:5px;' class='btn btn-xs btn-default'>Calendar View</a>&nbsp;";
                    
                    $agency_id = $_SESSION['UHS_AUTH']['storage']->agency_user_agency_id;
                    $indid = $indid;
                    $check_view = $this->SuperModel->Super_Get("_uhs_caregiver_view", "agency_id=$agency_id AND indid=$indid AND is_ads=0", "fetch");
                    
                    // if($check_view) {
                    //     if($check_view['caregiver_view'] == 1) {
                    //         $row[] = "<a href='" . $href . "' " . $clickBtn . " class='btn btn-xs btn-default'>Add New</a> &nbsp; <a href='" . getFormLinks($row1['assigned_form_id'], $indid, "View") . "' class='btn btn-xs btn-default'>View Logs</a> &nbsp;";
                    //     }
                    //     else {
                    //         $row[] = "<a href='" . $href . "' " . $clickBtn . " class='btn btn-xs btn-default'>Add New</a> &nbsp; <a href='" . APPLICATION_URL . "/calender-view/" . $indid . "/" . $assignedForms['form_id'] . "' style='margin-top:5px;' class='btn btn-xs btn-default'>Calendar View</a>&nbsp;";
                    //     }
                    // }
                    // else {
                    //     $row[] = "<a href='" . $href . "' " . $clickBtn . " class='btn btn-xs btn-default'>Add New</a> &nbsp; <a href='" . getFormLinks($row1['assigned_form_id'], $indid, "View") . "' class='btn btn-xs btn-default'>View Logs</a> &nbsp;";
                    // }

                    if($check_view) {
                        if($check_view['caregiver_view'] == 1) {
                            $row[] = "<a href='" . $href . "' " . $clickBtn . " class='btn btn-xs btn-default'>Add New</a> &nbsp; <a href='" . getFormLinks($row1['assigned_form_id'], $indid, "View") . "' class='btn btn-xs btn-default'>View Logs</a> &nbsp;";
                        }
                        else {
                            $row[] = "<a href='" . APPLICATION_URL . "/calender-view/" . $indid . "/" . $assignedForms['form_id'] . "' style='margin-top:5px;' class='btn btn-xs btn-default'>Document On Calendar View</a>&nbsp;";
                        }
                    }
                    else {
                        $row[] = "<a href='" . $href . "' " . $clickBtn . " class='btn btn-xs btn-default'>Add New</a> &nbsp; <a href='" . getFormLinks($row1['assigned_form_id'], $indid, "View") . "' class='btn btn-xs btn-default'>View Logs</a> &nbsp;";
                    }
                    
                    //$row[] = "<a href='" . $href . "' " . $clickBtn . " class='btn btn-xs btn-default'>Add New</a> &nbsp; <a href='" . getFormLinks($row1['assigned_form_id'], $indid, "View") . "' class='btn btn-xs btn-default'>View Logs</a> &nbsp; <a href='" . APPLICATION_URL . "/calender-view/" . $indid . "/" . $assignedForms['form_id'] . "' style='margin-top:5px;' class='btn btn-xs btn-default'>Calendar View</a>&nbsp;";
                }
                elseif($assignedForms['form_number'] == "DD 125") {
                    $agency_id = $_SESSION['UHS_AUTH']['storage']->agency_user_agency_id;
                    $indid = $indid;
                    $check_view = $this->SuperModel->Super_Get("_uhs_caregiver_view", "agency_id=$agency_id AND indid=$indid AND is_ads=1", "fetch");
                    
                    if($check_view) {
                        if($check_view['caregiver_view'] == 1) {
                            $row[] = "<a href='" . $href . "' " . $clickBtn . " class='btn btn-xs btn-default'>Add New</a> &nbsp; <a href='" . getFormLinks($row1['assigned_form_id'], $indid, "View") . "' class='btn btn-xs btn-default'>View Logs</a> &nbsp;";
                        }
                        else {
                            $row[] = "<a href='" . APPLICATION_URL . "/calender-view/" . $indid . "/" . $assignedForms['form_id'] . "' style='margin-top:5px;' class='btn btn-xs btn-default'>Document On Calendar View</a>&nbsp;";
                        }
                    }
                    else {
                        $row[] = "<a href='" . $href . "' " . $clickBtn . " class='btn btn-xs btn-default'>Add New</a> &nbsp; <a href='" . getFormLinks($row1['assigned_form_id'], $indid, "View") . "' class='btn btn-xs btn-default'>View Logs</a> &nbsp;";
                    }
                    
                    //$row[] = "<a href='" . $href . "' " . $clickBtn . " class='btn btn-xs btn-default'>Add New</a> &nbsp; <a href='" . getFormLinks($row1['assigned_form_id'], $indid, "View") . "' class='btn btn-xs btn-default'>View Logs</a> &nbsp; <a href='" . APPLICATION_URL . "/calender-view/" . $indid . "/" . $assignedForms['form_id'] . "' style='margin-top:5px;' class='btn btn-xs btn-default'>Calendar View</a>&nbsp;";
                }elseif ($assignedForms['form_number'] == "DD 136") {
                    $view_url = APPLICATION_URL . "/record-outcome-log/$indid/" . $assignedForms['form_id'];
                    $view_log_url = APPLICATION_URL . "/record-outcome-log-view/" . $indid . "/" . $assignedForms['form_id'];
                    $add_url = '#';
                    //$row[] = "<a id='record-outcome-form' href='" . $add_url . "' class='btn btn-xs btn-default'>Record Outcome</a> &nbsp; <a href='" . $view_url . "' class='btn btn-xs btn-default'>View Logs</a>";
                    if($this->view->user->agency_user_type=="Staff"){
                        $record_outcome = "<a href='" . $view_url . "' class='btn btn-xs btn-default'>Record Outcome Actions</a>";
                    } else { 
                        $record_outcome = "<a href='" . $view_url . "' class='btn btn-xs btn-default'>Record Outcome</a>";
                    }
                    
                    $view_log = "<a href='" . $view_log_url . "' class='btn btn-xs btn-default'>View Log</a>";
                    $row[] = $record_outcome."&nbsp;&nbsp;".$view_log;
                }
                else {
                	if($assignedForms['form_number'] == "DD 106") {
						$type='"TimingSheet"';
						$formid=3;
						$agency_id= $this->view->user->agency_user_agency_id;
						$rec = $this->SuperModel->Super_Get("_uhs_timing_sheets","service_individual_id='".$indid."' and service_agency_id='".$agency_id."' and service_added_user='".$this->view->user->agency_id."' and service_type != 'Group'","fetch",array("order"=>"sheet_id DESC",'limit'=>1));
						$sheet_id=-1;
						if(!empty($rec)){
						   $sheet_id = $rec['sheet_id'];
					     } 
				        $editLink="<a href='javascript:void(1);' onclick='showDiffrentForms(".$indid.",".$formid.",".$sheet_id.",".$type.");' class='btn btn-xs red'>Clock Out</a>";
                		$row[] = "<a href='" . $href . "' " . $clickBtn . " class='btn btn-xs btn-default clock-in-green-btn'>Clock In</a> &nbsp;".$editLink."&nbsp;"." <a href='" . getFormLinks($row1['assigned_form_id'], $indid, "View") . "' class='btn btn-xs btn-default'>View Logs</a>";
                        }
                	else {
                    
	                	if($assignedForms['form_number'] == "DD 100") {
	                		$row[] = "<a href='".getFormLinks($row1['assigned_form_id'],$indid,"View")."' class='btn btn-xs btn-default'>Read ISP</a>";
	                	}elseif($assignedForms['form_number'] == "DD 108"){
	                            $url = APPLICATION_URL."/add-new-mileage/".$indid."/".$row1['assigned_form_id']."/"."0"."/"."Mileage";
	                            $row[] = "<a href='" . $url . "' class='btn btn-xs btn-default'>Add New</a> &nbsp; <a href='" . getFormLinks($row1['assigned_form_id'], $indid, "View") . "' class='btn btn-xs btn-default'>View Logs</a>";	
	                        }elseif($assignedForms['form_number'] == "DD 103" || $assignedForms['form_number'] == "DD 123" || $assignedForms['form_number'] == "DD 52" || $assignedForms['form_number'] == "DD 53"){
	                                $row[] = "<a href='" . getFormLinks($row1['assigned_form_id'], $indid, "View") . "' class='btn btn-xs btn-default'>View Logs</a>";	
	                        }
	                        else{
								if($assignedForms['form_number'] == "DD 124" || $assignedForms['form_number'] == "DD 138" ){
									$row[] = $addlink." &nbsp; ".$viewLink."  <a href='" . getFormLinks($row1['assigned_form_id'], $indid, "View") . "' class='btn btn-xs btn-default'>View Logs</a>";	
								}elseif($assignedForms['form_number'] == "DD 112"){
									$user_type=$this->view->user->agency_user_type;
	                                if($user_type=='Staff'||$user_type=='Guardians'||$user_type=='SupportAdministrators'|| $user_type=='HealthcareProfessional' ){
	                                	 $type='"Financial"';
						                 $nullVal='""';
						                 $clickBtn="OnClick='showDiffrentForms(".$indid.",".$row1['assigned_form_id'].",".$nullVal.",".$type.");'";
	                                	 $row[]="<a href='javascript:void(1);' ".$clickBtn." class='btn btn-xs btn-default' style='margin-top:5px;'>Add New Transaction </a> &nbsp;<a href='".getFormLinks($row1['assigned_form_id'],$indid,"View")."' class='btn btn-xs btn-default' style='margin-top:5px;'>View Transactions</a>";	

	                                } else{
									     $row[] = $addlink." &nbsp; ".$viewLink."  <a href='" . getFormLinks($row1['assigned_form_id'], $indid, "View") . "' class='btn btn-xs btn-default'>View Transactions</a>";
							     	}
								} else{
	                            $row[] = "<a href='" . $href . "' " . $clickBtn . " class='btn btn-xs btn-default'>Add New</a> &nbsp; <a href='" . getFormLinks($row1['assigned_form_id'], $indid, "View") . "' class='btn btn-xs btn-default'>View Logs</a>";	
							    }
	                        }
                	}
                	
                	
                }
			}
			else{
							$user_type=$this->view->user->agency_user_type;
                            if($assignedForms['form_number'] == "DD 100") {
                                $row[] = "<a href='".getFormLinks($row1['assigned_form_id'],$indid,"View")."' class='btn btn-xs btn-default'>Read ISP</a>";
                            }elseif($assignedForms['form_number'] == "DD 103" || $assignedForms['form_number'] == "DD 123" || $assignedForms['form_number'] == "DD 52" || $assignedForms['form_number'] == "DD 53"){
                                $row[] = "<a href='" . getFormLinks($row1['assigned_form_id'], $indid, "View") . "' class='btn btn-xs btn-default'>View Logs</a>";	
                            }
                            elseif($assignedForms['form_number'] == "DD 112" && $user_type=='SupportAdministrators'){

                                	 $type='"Financial"';
					                 $nullVal='""';
					                 $clickBtn="OnClick='showDiffrentForms(".$indid.",".$row1['assigned_form_id'].",".$nullVal.",".$type.");'";
                                	 $row[]="<a href='javascript:void(1);' ".$clickBtn." class='btn btn-xs btn-default' style='margin-top:5px;'>Add New Transaction </a> &nbsp;<a href='".getFormLinks($row1['assigned_form_id'],$indid,"View")."' class='btn btn-xs btn-default' style='margin-top:5px;'>View Transactions</a>";	

                               
                            }
                            else{
                                $row[]="<a href='".getFormLinks($row1['assigned_form_id'],$indid,"View")."' class='btn btn-xs btn-default'>View Logs</a>";		
                            }

                        }
 			$output['aaData'][] = $row;
			$j++;
		}
		echo json_encode($output);
		exit();
	}
	
	public function getassignedformsoldAction(){
		if(check_is_ajax($this->_request)){
			$this->_redirect(APPLICATION_URL);
		}
		$indid=$this->_getParam("indid");
 		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('afid','form_agency_id','form_individual_id','assigned_form_id');
		$sIndexColumn = 'afid';
		$sTable = '_uhs_individual_assigned_forms';
		$sLimit = "";
		if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' ){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		if ( isset( $_GET['iSortCol_0'] ) )
		{
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
			{
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
				{
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
		if($sWhere){
			$sWhere.=" and form_individual_id=".$indid;
		}
		else{
			$sWhere.=" Where form_individual_id=".$indid;
		}
		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
 		$qry = $this->dbObj->query($sQuery)->fetchAll();
		$sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
		$output = array(
 				"iTotalRecords" => $iTotal,
				"iTotalDisplayRecords" => $iFilteredTotal,
				"aaData" => array()
			);
		$j=0;
		foreach($qry as $row1){
			$assignedForms=$this->SuperModel->Super_Get("_uhs_agency_forms","form_id=".$row1['assigned_form_id'],"fetch");
			$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
			$row=array();
 			$row[] = $j+1;
			$row[]='<input class="elem_ids checkboxes" type="checkbox" name="records['.$row1['assigned_form_id'].']"  value="'.$row1['assigned_form_id'].'">';
		    $row[]=ucwords($assignedForms['form_number']); 
  			$row[]=ucwords($assignedForms['form_title']);
			$clickBtn=""; $href="javascript:void(1);";
			if($assignedForms['form_number']=="DD 114" || $assignedForms['form_number']=="DD 116" || $assignedForms['form_number']=="DD 118" || $assignedForms['form_number']=="DD 120" || $assignedForms['form_number']=="DD 128" || $assignedForms['form_number']=="DD 106"  || $assignedForms['form_number']=="DD 108" || $assignedForms['form_number']=="DD 122" || $assignedForms['form_number']=="DD 126" || $assignedForms['form_number']=="DD 112" || $assignedForms['form_number']=="DD 124"){
				$clickBtn=getFormLinks($row1['assigned_form_id'],$indid,"Add",true);
			}
			else{
				$clickBtn=getFormLinks($row1['assigned_form_id'],$indid,"Add");
			}
			if($assignedForms['form_number']=="DD 108"){ 
				$getAssignedMileage=$this->SuperModel->Super_Get("_uhs_assigned_miles","m_form_id='".$assignedForms['form_id']."' and m_individual_id='".$indid."' and Month(miles_added_date)=MONTH(CURDATE())","fetch");
				if(empty($getAssignedMileage)){
					$text='"You can not add record."';
					$clickBtn="onClick='showCustomAlert(".$text.")';";
				}
			}
			if($assignedForms['form_number']=="DD 124"){ 
				$getAssignedFoodBal=$this->SuperModel->Super_Get("_uhs_food_initial_balance","fb_form_id='".$assignedForms['form_id']."' and fb_individual_id='".$indid."' and Month(fb_added_date)=MONTH(CURDATE())","fetch");
				if(empty($getAssignedFoodBal)){
					$text='"You can not add record."';
					$clickBtn="onClick='showCustomAlert(".$text.")';";
				}
			}
			if($assignedForms['form_number']=="DD 112"){ 
				$getAssignedBalance=$this->SuperModel->Super_Get("_uhs_financial_initial_balance","balance_form_id='".$assignedForms['form_id']."' and balance_individual_id='".$indid."' and Month(balance_added_date)=MONTH(CURDATE())","fetch");
				if(empty($getAssignedBalance)){
					$text='"You can not add record."';
					$clickBtn="onClick='showCustomAlert(".$text.")';";
				}
			}
			if($permissions=="Edit" || $permissions=="Both"){
				if($assignedForms['form_number'] == "DD 104") {
                    //$row[] = "<a href='" . $href . "' " . $clickBtn . " class='btn btn-xs btn-default'>Add New</a> &nbsp; <a href='" . getFormLinks($row1['assigned_form_id'], $indid, "View") . "' class='btn btn-xs btn-default'>View Logs</a>";
                    //$viewLink = "<a href='" . APPLICATION_URL . "/calender-view/" . $indid . "/" . $row1['form_id'] . "' style='margin-top:5px;' class='btn btn-xs btn-default'>Calendar View</a>&nbsp;";
                    
                    $agency_id = $_SESSION['UHS_AUTH']['storage']->agency_user_agency_id;
                    $indid = $indid;
                    $check_view = $this->SuperModel->Super_Get("_uhs_caregiver_view", "agency_id=$agency_id AND indid=$indid", "fetch");
                    
                    // if($check_view) {
                    //     if($check_view['caregiver_view'] == 1) {
                    //         $row[] = "<a href='" . $href . "' " . $clickBtn . " class='btn btn-xs btn-default'>Add New</a> &nbsp; <a href='" . getFormLinks($row1['assigned_form_id'], $indid, "View") . "' class='btn btn-xs btn-default'>View Logs</a> &nbsp;";
                    //     }
                    //     else {
                    //         $row[] = "<a href='" . $href . "' " . $clickBtn . " class='btn btn-xs btn-default'>Add New</a> &nbsp; <a href='" . APPLICATION_URL . "/calender-view/" . $indid . "/" . $assignedForms['form_id'] . "' style='margin-top:5px;' class='btn btn-xs btn-default'>Calendar View</a>&nbsp;";
                    //     }
                    // }
                    // else {
                    //     $row[] = "<a href='" . $href . "' " . $clickBtn . " class='btn btn-xs btn-default'>Add New</a> &nbsp; <a href='" . getFormLinks($row1['assigned_form_id'], $indid, "View") . "' class='btn btn-xs btn-default'>View Logs</a> &nbsp;";
                    // }

                    if($check_view) {
                        if($check_view['caregiver_view'] == 1) {
                            $row[] = "<a href='" . $href . "' " . $clickBtn . " class='btn btn-xs btn-default'>Add New</a> &nbsp; <a href='" . getFormLinks($row1['assigned_form_id'], $indid, "View") . "' class='btn btn-xs btn-default'>View Logs</a> &nbsp;";
                        }
                        else {
                            $row[] = "<a href='" . APPLICATION_URL . "/calender-view/" . $indid . "/" . $assignedForms['form_id'] . "' style='margin-top:5px;' class='btn btn-xs btn-default'>Document On Calendar View</a>&nbsp;";
                        }
                    }
                    else {
                        $row[] = "<a href='" . $href . "' " . $clickBtn . " class='btn btn-xs btn-default'>Add New</a> &nbsp; <a href='" . getFormLinks($row1['assigned_form_id'], $indid, "View") . "' class='btn btn-xs btn-default'>View Logs</a> &nbsp;";
                    }
                    
                    //$row[] = "<a href='" . $href . "' " . $clickBtn . " class='btn btn-xs btn-default'>Add New</a> &nbsp; <a href='" . getFormLinks($row1['assigned_form_id'], $indid, "View") . "' class='btn btn-xs btn-default'>View Logs</a> &nbsp; <a href='" . APPLICATION_URL . "/calender-view/" . $indid . "/" . $assignedForms['form_id'] . "' style='margin-top:5px;' class='btn btn-xs btn-default'>Calendar View</a>&nbsp;";
                }
                else {
                	if($assignedForms['form_number'] == "DD 106") {
                		$row[] = "<a href='" . $href . "' " . $clickBtn . " class='btn btn-xs btn-default clock-in-green-btn'>Clock In</a> &nbsp; <a href='" . getFormLinks($row1['assigned_form_id'], $indid, "View") . "' class='btn btn-xs btn-default'>View Logs</a>";
                        }
                	else {
                    
                	if($assignedForms['form_number'] == "DD 100") {
                		$row[] = "<a href='".getFormLinks($row1['assigned_form_id'],$indid,"View")."' class='btn btn-xs btn-default'>Read ISP</a>";
                	}elseif($assignedForms['form_number'] == "DD 108"){
                            $url = APPLICATION_URL."/add-new-mileage/".$indid."/".$row1['assigned_form_id']."/"."0"."/"."Mileage";
                            $row[] = "<a href='" . $url . "' class='btn btn-xs btn-default'>Add New</a> &nbsp; <a href='" . getFormLinks($row1['assigned_form_id'], $indid, "View") . "' class='btn btn-xs btn-default'>View Logs</a>";	
                        }
                        else{
                            $row[] = "<a href='" . $href . "' " . $clickBtn . " class='btn btn-xs btn-default'>Add New</a> &nbsp; <a href='" . getFormLinks($row1['assigned_form_id'], $indid, "View") . "' class='btn btn-xs btn-default'>View Logs</a>";	
                        }
                	}
                	
                	
                }
			}
			else{
				
				if($assignedForms['form_number'] == "DD 100") {
                		$row[] = "<a href='".getFormLinks($row1['assigned_form_id'],$indid,"View")."' class='btn btn-xs btn-default'>Read ISP</a>";
                	}else{
				$row[]="<a href='".getFormLinks($row1['assigned_form_id'],$indid,"View")."' class='btn btn-xs btn-default'>View Logs</a>";		
						}
				
			}
 			$output['aaData'][] = $row;
			$j++;
		}
		echo json_encode($output);
		exit();
	}
	
	
	public function businessformsprintAction(){
		global $healthSession;
		$indid=$this->_getParam('indid');
 		$this->_helper->layout->disableLayout();
		$this->_helper->viewRenderer->setNoRender(true);
		$formData = $this->getRequest()->getPost();
		if(isset($formData['records']) && count($formData['records'])){
				$res="";
				foreach($formData['records'] as $value){
					$res.=$this->_smartPrint($indid,$value,$formData['months'],$formData['years']);
				}
				if(!empty($res)){
					$indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid);
					require_once ROOT_PATH.'/private/mpdf/mpdf.php';
					$mpdf=new mPDF('utf-8', 'A4-L');
					$mpdf->SetTitle($this->view->site_configs['site_name']." | ".ucwords($indData['agency_first_name']." ".$indData['agency_last_name'])." Forms");
					$stylesheet = file_get_contents(APPLICATION_URL.'/public/plugins/bootstrap/css/bootstrap.css');
					$mpdf->WriteHTML($stylesheet,1);
					$mpdf->WriteHTML($res,2);
					$mpdf->Output();
					exit();
				}
				else{
					$healthSession->errorMsg = "No logs found.";
				}
		}
		else{
			$healthSession->errorMsg = "Invalid Request.";
		}
 		$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid),"front_staff_assigned_forms");	 
	}
	
	// Incident Form
	public function incidentsAction(){	
		global $healthSession; 
  		$this->view->pageHeading = "Incident Reports";
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$rid=$this->_getParam("rid");
		if(empty($indid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		$this->view->permissions=$permissions;
		$this->view->indid=$indid;
		$this->view->formid=$formid;
		$this->view->rid=$rid;
  	}

	public function getincidentsAction(){
		if(check_is_ajax($this->_request)){
			$this->_redirect(APPLICATION_URL);
		}
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$rid=$this->_getParam("rid");
		$subuser=$dstarts=$dends=$county="";
		if(isset($_REQUEST['subuser']) && !empty($_REQUEST['subuser'])){
			$subuser=$_REQUEST['subuser'];
		}
		if(isset($_REQUEST['county']) && !empty($_REQUEST['county'])){
			$county=$_REQUEST['county'];
		}
		if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
			$month=$_REQUEST['month'];
		}
		if(isset($_REQUEST['year']) && !empty($_REQUEST['year'])){
			$year=$_REQUEST['year'];
		}
		if(isset($_REQUEST['dstarts']) && !empty($_REQUEST['dstarts'])){
			$dstarts=$_REQUEST['dstarts'];
		}
		if(isset($_REQUEST['dends']) && !empty($_REQUEST['dends'])){
			$dends=$_REQUEST['dends'];
		}
 		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('incident_id','incident_added_user','incident_tracking_number','incident_date','incident_time','incident_location','report_created_on','is_report_completed','incident_modified_by','incident_modified_on');
		$sIndexColumn = 'incident_id';
		$sTable = '_uhs_incidents_reports';
		$sLimit = "";
		if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' ){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		if(isset($_GET['iSortCol_0'])){
			$sOrder = "ORDER BY  ";
			for($i=0;$i<intval( $_GET['iSortingCols']);$i++){
				if($_GET['bSortable_'.intval($_GET['iSortCol_'.$i])]=="true"){
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
		
		if(empty($subuser)){
			$indParentUsers="";
			if($this->view->user->agency_user_type=="Agency"){
				$systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_id,"fetchAll",array("fields"=>"agency_id"));
				$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
				$indParentUsers=implode_r(",",$systemUsers);
				if($sWhere){
                                    $sWhere.=" and incident_added_user IN(".$indParentUsers.") and incident_individual_id='".$indid."'"; 
				}
                                else{
                                    $sWhere.=" where incident_added_user IN(".$indParentUsers.") and incident_individual_id='".$indid."'"; 
                                }
			}
			else{
                                $indParentUsers=$this->view->user->agency_id;
                                if($sWhere){
                                    $sWhere.=" and incident_individual_id='".$indid."'"; 
				}
                                else{
                                    $sWhere.=" where incident_individual_id='".$indid."'"; 
                                }
			}
		}
		else{
			if($sWhere){
				$sWhere.=" and incident_added_user IN(".$subuser.") and incident_individual_id='".$indid."'"; 
			}
			else{
				$sWhere.=" where incident_added_user IN(".$subuser.") and incident_individual_id='".$indid."'"; 
			}
		}
		if(!empty($dstarts)){
			$sWhere.=" and DATE(incident_date) >='".$dstarts."'";
		}
		if(!empty($dends)){
			$sWhere.=" and DATE(incident_date) <='".$dends."'";
		}
		
		if(!empty($month)){
			$sWhere.=" and MONTH(incident_date)='".$month."'";
		}
		if(!empty($year)){
			$sWhere.=" and YEAR(incident_date)='".$year."'";
		}
		if(!empty($rid) && $rid!=0){
			$sWhere.=" and incident_id=".$rid;
		}
		if(!empty($county)){
			$systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_county='".$county."'","fetchAll",array("fields"=>"agency_id"));
			if(count($systemUsers) > 0){
				$indParentUsers=implode_r(",",$systemUsers);
				$sWhere.=" and 	incident_individual_id IN(".$indParentUsers.")"; 
			}
		}
		
		if(empty($month) && empty($year)){
                    if(!empty($sWhere)){
                        $sWhere.=" and MONTH(report_created_on)=MONTH(CURDATE()) and YEAR(report_created_on)=YEAR(CURDATE())";
                    }else{
                        $sWhere.=" where MONTH(report_created_on)=MONTH(CURDATE()) and YEAR(report_created_on)=YEAR(CURDATE())";
                    }
                }
		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
 		$qry = $this->dbObj->query($sQuery)->fetchAll();
		$sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
		$output = array(
 				"iTotalRecords" => $iTotal,
				"iTotalDisplayRecords" => $iFilteredTotal,
				"aaData" => array()
			);
		$j=0;
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		foreach($qry as $row1){
			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['incident_added_user']."'","fetch");
			$modifierData=array();
			if($row1['incident_modified_by']!=0){
				$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$row1['incident_modified_by']);
			}
			$row=array();
 			$row[] = $j+1;
			$row[]='<input class="elem_ids checkboxes" type="checkbox" name="records['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';
		    $row[]=$row1['incident_tracking_number']; 
			$row[]=formatDate($row1['incident_date']);
			$row[]=$row1['incident_time'];
			$row[]=ucwords($row1['incident_location']);
			$userType=printUserType($creatorData); 
  			$row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
			$row[]=formatDateTimeNew($row1['report_created_on']);
			if(!empty($modifierData)){
				$userType=printUserType($modifierData);
				$row[]=ucwords($modifierData['agency_first_name']." ".$modifierData['agency_last_name'])."&nbsp;".$userType;
				$row[]=formatDateTime($row1['incident_modified_on']);
			}
			else{
				$row[]="-";
				$row[]="-";
			}
			$emailLink="";
			if($this->view->user->agency_user_type=="Agency"){
				$emailLink="<a href='javascript:void(1);' style='margin-top:5px;' onclick='emailIncident(".$indid.",".$formid.",".$row1['incident_id'].");' class='btn btn-xs btn-default'>Email this form</a>";
			}
			$editLink=$viewLink="";
			if ($permissions=="Edit" || $permissions=="Both"){
				$editLink="<a style='margin-top:5px;' href='".APPLICATION_URL."/edit-incident-report/".$indid."/".$formid."/".$row1['incident_id']."' class='btn btn-xs btn-default'>Edit</a>&nbsp;";
			}
			if($row1['is_report_completed']=='1'){
				$viewLink="<a style='margin-top:5px;' href='".APPLICATION_URL."/view-incident-report/".$indid."/".$formid."/".$row1['incident_id']."' class='btn btn-xs btn-default'>View</a>&nbsp;";
			}
			if(!isFormAssigned($formid,$indid)){
				$row[]=$editLink.$viewLink.$emailLink;
			}
			else{
				$row[]=$viewLink;
			}
 			$output['aaData'][] = $row;
			$j++;
		}
		echo json_encode($output);
		exit();
	}
	
	public function addincidentAction(){
		global $healthSession,$systemusers;
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$rid=$this->_getParam("rid");
		if(isFormAssigned($formid,$indid)){
			$healthSession->errorMsg="Please assign form to individual first";
			$this->_helper->getHelper('Redirector')->gotoRoute(array('indid'=>$indid,'formid'=>$formid),"front_incident_reports");
		}
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		if($permissions=="View Only"){
			$healthSession->errorMsg="You don't have permission to access this page.";
			$this->_helper->getHelper('Redirector')->gotoRoute(array('indid'=>$indid,'formid'=>$formid),"front_incident_reports");
		}
		if(empty($rid)){
			$this->view->pageHeading="Add Incident Report";
		}
		else{
			$this->view->pageHeading="Edit Incident Report";
		}
		$this->view->rid=$rid;
		$this->view->indid=$indid;
		$this->view->formid=$formid;
		$form=new Application_Form_CustomForms();
		$form->incident();
		$incidentData=array();
		if(!empty($rid)){
			$incidentData=$this->SuperModel->Super_Get("_uhs_incidents_reports","incident_id=".$rid,"fetch");
			$this->view->incident_e_sig=$incidentData['incident_e_sig'];
			$this->view->incident_e_sig_reviewer=$incidentData['incident_e_sig_reviewer'];
			if(empty($incidentData)){
				$healthSession->errorMsg="No incident report exists";
				$this->_helper->getHelper('Redirector')->gotoRoute(array('indid'=>$indid,'formid'=>$formid),"front_incident_reports");
			}
			// if(!empty($incidentData) && $incidentData['is_report_completed']=='1'){
			// 	$healthSession->errorMsg="You can't edit incident report.";
			// 	$this->_helper->getHelper('Redirector')->gotoRoute(array('indid'=>$indid,'formid'=>$formid),"front_incident_reports");
			// }
			$incidentData['incident_date']=date("m/d/y",strtotime($incidentData['incident_date']));
			if(!empty($incidentData['report_filling_date'])){
				$incidentData['report_filling_date']=date("m/d/y",strtotime($incidentData['report_filling_date']));
			}
			if(!empty($incidentData['reviewer_date'])){
				$incidentData['reviewer_date']=date("m/d/y",strtotime($incidentData['reviewer_date']));
			}
			if(!empty($incidentData['report_sent_date'])){
				$incidentData['report_sent_date']=date("m/d/y",strtotime($incidentData['report_sent_date']));
			}
			if(empty($incidentData)){
				$healthSession->errorMsg="Requested record not found.";
				$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_incident_reports");	
			}
			if(!empty($incidentData['incident_types'])){ $incidentData['incident_types']=unserialize($incidentData['incident_types']); }
			if(!empty($incidentData['nature_of_injury'])){ $incidentData['nature_of_injury']=unserialize($incidentData['nature_of_injury']);}
			if(!empty($incidentData['location_of_injury'])){ $incidentData['location_of_injury']=unserialize($incidentData['location_of_injury']);}
			
			if(!empty($incidentData['location_of_injury_by_humanavtar_male'])){ $incidentData['location_of_injury_by_humanavtar_male']=unserialize($incidentData['location_of_injury_by_humanavtar_male']); $this->view->gender='male';}
			if(!empty($incidentData['location_of_injury_by_humanavtar_female'])){ $incidentData['location_of_injury_by_humanavtar_female']=unserialize($incidentData['location_of_injury_by_humanavtar_female']); $this->view->gender='female';}
			
			if(!empty($incidentData['injury_area'])){ $incidentData['injury_area']=unserialize($incidentData['injury_area']);}
			if(!empty($incidentData['is_included_claims'])){ $incidentData['is_included_claims']=unserialize($incidentData['is_included_claims']);}
			
			$notifyData=$this->SuperModel->Super_Get("_uhs_incident_notifications","incident_report_id=".$rid,"fetchAll");
			foreach($notifyData as $notify){
				switch($notify['incident_recipient']){
					case "Home Manager":
						$incidentData['incident_recipient1']=$notify['incident_recipient'];
						$incidentData['recipient_printed_name1']=$notify['recipient_printed_name'];
						$incidentData['incident_notify_via1']=$notify['incident_notify_via'];
						$incidentData['incident_notify_date1']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$incidentData['incident_notify_time1']=$notify['incident_notify_time'];
					break;
					
					case "On-Call (Emergency Only)":
						$incidentData['incident_recipient2']=$notify['incident_recipient'];
						$incidentData['recipient_printed_name2']=$notify['recipient_printed_name'];
						$incidentData['incident_notify_via2']=$notify['incident_notify_via'];
						$incidentData['incident_notify_date2']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$incidentData['incident_notify_time2']=$notify['incident_notify_time'];
					break;
					
					case "Nurse (medical incident)":
						$incidentData['incident_recipient3']=$notify['incident_recipient'];
						$incidentData['recipient_printed_name3']=$notify['recipient_printed_name'];
						$incidentData['incident_notify_via3']=$notify['incident_notify_via'];
						$incidentData['incident_notify_date3']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$incidentData['incident_notify_time3']=$notify['incident_notify_time'];
					break;
					
					case "Program Specialist":
						$incidentData['incident_recipient4']=$notify['incident_recipient'];
						$incidentData['recipient_printed_name4']=$notify['recipient_printed_name'];
						$incidentData['incident_notify_via4']=$notify['incident_notify_via'];
						$incidentData['incident_notify_date4']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$incidentData['incident_notify_time4']=$notify['incident_notify_time'];
					break;
					
					case "Guardian (if applicable)":
						$incidentData['incident_recipient5']=$notify['incident_recipient'];
						$incidentData['recipient_printed_name5']=$notify['recipient_printed_name'];
						$incidentData['incident_notify_via5']=$notify['incident_notify_via'];
						$incidentData['incident_notify_date5']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$incidentData['incident_notify_time5']=$notify['incident_notify_time'];
					break;
					
					case "Advocate (if applicable)":
						$incidentData['incident_recipient6']=$notify['incident_recipient'];
						$incidentData['recipient_printed_name6']=$notify['recipient_printed_name'];
						$incidentData['incident_notify_via6']=$notify['incident_notify_via'];
						$incidentData['incident_notify_date6']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$incidentData['incident_notify_time6']=$notify['incident_notify_time'];
					break;
					
					case "County Service Coordinator":
						$incidentData['incident_recipient7']=$notify['incident_recipient'];
						$incidentData['recipient_printed_name7']=$notify['recipient_printed_name'];
						$incidentData['incident_notify_via7']=$notify['incident_notify_via'];
						$incidentData['incident_notify_date7']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$incidentData['incident_notify_time7']=$notify['incident_notify_time'];
					break;
					
					case "MUI Investigator":
						$incidentData['incident_recipient8']=$notify['incident_recipient'];
						$incidentData['recipient_printed_name8']=$notify['recipient_printed_name'];
						$incidentData['incident_notify_via8']=$notify['incident_notify_via'];
						$incidentData['incident_notify_date8']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$incidentData['incident_notify_time8']=$notify['incident_notify_time'];
					break;
					
					case "Others":
						$incidentData['incident_recipient9']=$notify['incident_recipient'];
						$incidentData['recipient_printed_name9']=$notify['recipient_printed_name'];
						$incidentData['incident_notify_via9']=$notify['incident_notify_via'];
						$incidentData['incident_notify_date9']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$incidentData['incident_notify_time9']=$notify['incident_notify_time'];
					break;
					
					case "Other":
						$incidentData['incident_recipient10']=$notify['incident_recipient'];
						$incidentData['recipient_printed_name10']=$notify['recipient_printed_name'];
						$incidentData['incident_notify_via10']=$notify['incident_notify_via'];
						$incidentData['incident_notify_date10']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$incidentData['incident_notify_time10']=$notify['incident_notify_time'];
					break;
				}
			}
			$form->populate($incidentData);
		}
		$this->view->incidentData=$incidentData;
   		if($this->getRequest()->isPost()){
 			$posted_data = $this->getRequest()->getPost();
			if($form->isValid($posted_data)){
				unset($posted_data['bttnsubmit']);
				$blankimg="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA6IAAADpCAYAAAA+j4q1AAARW0lEQVR4Xu3aUVFcURBFUUZB3IGIRE4iAtxFATFAPtkcuhYCpu9b3T+7iseTPwIECBAgQIAAAQIECBAgEAo8wllGESBAgAABAgQIECBAgACBJyHqCAgQIECAAAECBAgQIEAgFRCiKbdhBAgQIECAAAECBAgQICBE3QABAgQIECBAgAABAgQIpAJCNOU2jAABAgQIECBAgAABAgSEqBsgQIAAAQIECBAgQIAAgVRAiKbchhEgQIAAAQIECBAgQICAEHUDBAgQIECAAAECBAgQIJAKCNGU2zACBAgQIECAAAECBAgQEKJugAABAgQIECBAgAABAgRSASGachtGgAABAgQIECBAgAABAkLUDRAgQIAAAQIECBAgQIBAKiBEU27DCBAgQIAAAQIECBAgQECIugECBAgQIECAAAECBAgQSAWEaMptGAECBAgQIECAAAECBAgIUTdAgAABAgQIECBAgAABAqmAEE25DSNAgAABAgQIECBAgAABIeoGCBAgQIAAAQIECBAgQCAVEKIpt2EECBAgQIAAAQIECBAgIETdAAECBAgQIECAAAECBAikAkI05TaMAAECBAgQIECAAAECBISoGyBAgAABAgQIECBAgACBVECIptyGESBAgAABAgQIECBAgIAQdQMECBAgQIAAAQIECBAgkAoI0ZTbMAIECBAgQIAAAQIECBAQom6AAAECBAgQIECAAAECBFIBIZpyG0aAAAECBAgQIECAAAECQtQNECBAgAABAgQIECBAgEAqIERTbsMIECBAgAABAgQIECBAQIi6AQIECBAgQIAAAQIECBBIBYRoym0YAQIECBAgQIAAAQIECAhRN0CAAAECBAgQIECAAAECqYAQTbkNI0CAAAECBAgQIECAAAEh6gYIECBAgAABAgQIECBAIBUQoim3YQQIECBAgAABAgQIECAgRN0AAQIECBAgQIAAAQIECKQCQjTlNowAAQIECBAgQIAAAQIEhKgbIECAAAECBAgQIECAAIFUQIim3IYRIECAAAECBAgQIECAgBB1AwQIECBAgAABAgQIECCQCgjRlNswAgQIECBAgAABAgQIEBCiboAAAQIECBAgQIAAAQIEUgEhmnIbRoAAAQIECBAgQIAAAQJC1A0QIECAAAECBAgQIECAQCogRFNuwwgQIECAAAECBAgQIEBAiLoBAgQIECBAgAABAgQIEEgFhGjKbRgBAgQIECBAgAABAgQICFE3QIAAAQIECBAgQIAAAQKpgBBNuQ0jQIAAAQIECBAgQIAAASHqBggQIECAAAECBAgQIEAgFRCiKbdhBAgQIECAAAECBAgQICBE3QABAgQIECBAgAABAgQIpAJCNOU2jAABAgQIECBAgAABAgSEqBsgQIAAAQIECBAgQIAAgVRAiKbchhEgQIAAAQIECBAgQICAEHUDBAgQIECAAAECBAgQIJAKCNGU2zACBAgQIECAAAECBAgQEKJugAABAgQIECBAgAABAgRSASGachtGgAABAgQIECBAgAABAkLUDRAgQIAAAQIECBAgQIBAKiBEU27DCBAgQIAAAQIECBAgQECIugECBAgQIECAAAECBAgQSAWEaMptGAECBAgQIECAAAECBAgIUTdAgAABAgQIECBAgAABAqmAEE25DSNAgAABAgQIECBAgAABIeoGCBAgQIAAAQIECBAgQCAVEKIpt2EECBAgQIAAAQIECBAgIETdAAECBAgQIECAAAECBAikAkI05TaMAAECBAgQIECAAAECBISoGyBAgAABAgQIECBAgACBVECIptyGESBAgAABAgQIECBAgIAQdQMECBAgQIAAAQIECBAgkAoI0ZTbMAIECBAgQIAAAQIECBAQom6AAAECBAgQIECAAAECBFIBIZpyG0aAAAECBAgQIECAAAECQtQNECBAgAABAgQIECBAgEAqIERTbsMIECBAgAABAgQIECBAQIi6AQIECBAgQIAAAQIECBBIBYRoym0YAQIECBAgQIAAAQIECAhRN0CAAAECBAgQIECAAAECqYAQTbkNI0CAAAECBAgQIECAAAEh6gYIECBAgAABAgQIECBAIBUQoim3YQQIECBAgAABAgQIECAgRN0AAQIECBAgQIAAAQIECKQCQjTlNowAAQIECBAgQIAAAQIEhKgbIECAAAECBAgQIECAAIFUQIim3IYRIECAAAECBAgQIECAgBB1AwQIECBAgAABAgQIECCQCgjRlNswAgQIECBAgAABAgQIEBCiboAAAQIECBAgQIAAAQIEUgEhmnIbRoAAAQIECBAgQIAAAQJC1A0QIECAAAECBAgQIECAQCogRFNuwwgQIECAAAECBAgQIEBAiLoBAgQIECBAgAABAgQIEEgFhGjKbRgBAgQIECBAgAABAgQICFE3QIAAAQIECBAgQIAAAQKpgBBNuQ0jQIAAAQIECBAgQIAAASHqBggQIECAAAECBAgQIEAgFRCiKbdhBAgQIECAAAECBAgQICBE3QABAgQIECBAgAABAgQIpAJCNOU2jAABAgQIECBAgAABAgSEqBsgQIAAAQIECBAgQIAAgVRAiKbchhEgQIAAAQIECBAgQICAEHUDBAgQIECAAAECBAgQIJAKCNGU2zACBAgQIECAAAECBAgQEKJugAABAgQIECBAgAABAgRSASGachtGgAABAgQIECBAgAABAkLUDRAgQIAAAQIECBAgQIBAKiBEU27DCBAgQIAAAQIECBAgQECIugECBAgQIECAAAECBAgQSAWEaMptGAECBAgQIECAAAECBAgIUTdAgAABAgQIECBAgAABAqmAEE25DSNAgAABAgQIECBAgAABIeoGCBAgQIAAAQIECBAgQCAVEKIpt2EECBAgQIAAAQIECBAgIETdAAECBAgQIECAAAECBAikAkI05TaMAAECBAgQIECAAAECBISoGyBAgAABAgQIECBAgACBVECIptyGESBAgAABAgQIECBAgIAQdQMECBAgQIAAAQIECBAgkAoI0ZTbMAIECBAgQIAAAQIECBAQom6AAAECBAgQIECAAAECBFIBIZpyG0aAAAECBAgQIECAAAECQtQNECBAgAABAgQIECBAgEAqIERTbsMIECBAgAABAgQIECBAQIi6AQIECBAgQIAAAQIECBBIBYRoym0YAQIECBAgQIAAAQIECAhRN0CAAAECBAgQIECAAAECqYAQTbkNI0CAAAECBAgQIECAAAEh6gYIECBAgAABAgQIECBAIBUQoim3YQQIECBAgAABAgQIECAgRN0AAQIECBAgQIAAAQIECKQCQjTlNowAAQIECBAgQIAAAQIEhKgbIECAAAECBAgQIECAAIFUQIim3IYRIECAAAECBAgQIECAgBB1AwQIECBAgAABAgQIECCQCgjRlNswAgQIECBAgAABAgQIEBCiboAAAQIECBAgQIAAAQIEUgEhmnIbRoAAAQIECBAgQIAAAQJC1A0QIECAAAECBAgQIECAQCogRFNuwwgQIECAAAECBAgQIEBAiLoBAgQIECBAgAABAgQIEEgFhGjKbRgBAgQIECBAgAABAgQICFE3QIAAAQIECBAgQIAAAQKpgBBNuQ0jQIAAAQIECBAgQIAAASHqBggQIECAAAECBAgQIEAgFRCiKbdhBAgQIECAAAECBAgQICBE3QABAgQIECBAgAABAgQIpAJCNOU2jAABAgQIECBAgAABAgSEqBsgQIAAAQIECBAgQIAAgVRAiKbchhEgQIAAAQIECBAgQICAEHUDBAgQIECAAAECBAgQIJAKCNGU2zACBAgQIECAAAECBAgQEKJugAABAgQIECBAgAABAgRSASGachtGgAABAgQIECBAgAABAkLUDRAgQIAAAQIECBAgQIBAKiBEU27DCBAgQIAAAQIECBAgQECIugECBAgQIECAAAECBAgQSAWEaMptGAECBAgQIECAAAECBAgIUTdAgAABAgQIECBAgAABAqmAEE25DSNAgAABAgQIECBAgAABIeoGCBAgQIAAAQIECBAgQCAVEKIpt2EECBAgQIAAAQIECBAgIETdAAECBAgQIECAAAECBAikAkI05TaMAAECBAgQIECAAAECBISoGyBAgAABAgQIECBAgACBVECIptyGESBAgAABAgQIECBAgIAQdQMECBAgQIAAAQIECBAgkAoI0ZTbMAIECBAgQIAAAQIECBAQom6AAAECBAgQIECAAAECBFIBIZpyG0aAAAECBAgQIECAAAECQtQNECBAgAABAgQIECBAgEAqIERTbsMIECBAgAABAgQIECBAQIi6AQIECBAgQIAAAQIECBBIBYRoym0YAQIECBAgQIAAAQIECAhRN0CAAAECBAgQIECAAAECqYAQTbkNI0CAAAECBAgQIECAAAEh6gYIECBAgAABAgQIECBAIBUQoim3YQQIECBAgAABAgQIECAgRN0AAQIECBAgQIAAAQIECKQCQjTlNowAAQIECBAgQIAAAQIEhKgbIECAAAECBAgQIECAAIFUQIim3IYRIECAAAECBAgQIECAgBB1AwQIECBAgAABAgQIEPgEgbe3tx/Pz89/P+Gnv/1PCtEPVvj6+vrz/f3997ffrg8gQIAAAQIECBAgQOBLBR6Px6+Xl5c/X/qIweFCVIgOnqUnESBAgAABAgQIELghIEQ/3qMQvXHfvoIAAQIECBAgQIAAgTEB/5r7/4UI0bFj9RwCBAgQIECAAAECBAhcFxCi1zfs+wgQIECAAAECBAgQIDAmIETHFuI5BAgQIECAAAECBAgQuC4gRK9v2PcRIECAAAECBAgQIEBgTECIji3EcwgQIECAAAECBAgQIHBdQIhe37DvI0CAAAECBAgQIECAwJiAEB1biOcQIECAAAECBAgQIEDguoAQvb5h30eAAAECBAgQIECAAIExASE6thDPIUCAAAECBAgQIECAwHUBIXp9w76PAAECBAgQIECAAAECYwJCdGwhnkOAAAECBAgQIECAAIHrAkL0+oZ9HwECBAgQIECAAAECBMYEhOjYQjyHAAECBAgQIECAAAEC1wWE6PUN+z4CBAgQIECAAAECBAiMCQjRsYV4DgECBAgQIECAAAECBK4LCNHrG/Z9BAgQIECAAAECBAgQGBMQomML8RwCBAgQIECAAAECBAhcFxCi1zfs+wgQIECAAAECBAgQIDAmIETHFuI5BAgQIECAAAECBAgQuC4gRK9v2PcRIECAAAECBAgQIEBgTECIji3EcwgQIECAAAECBAgQIHBdQIhe37DvI0CAAAECBAgQIECAwJiAEB1biOcQIECAAAECBAgQIEDguoAQvb5h30eAAAECBAgQIECAAIExASE6thDPIUCAAAECBAgQIECAwHUBIXp9w76PAAECBAgQIECAAAECYwJCdGwhnkOAAAECBAgQIECAAIHrAkL0+oZ9HwECBAgQIECAAAECBMYEhOjYQjyHAAECBAgQIECAAAEC1wWE6PUN+z4CBAgQIECAAAECBAiMCQjRsYV4DgECBAgQIECAAAECBK4LCNHrG/Z9BAgQIECAAAECBAgQGBMQomML8RwCBAgQIECAAAECBAhcFxCi1zfs+wgQIECAAAECBAgQIDAmIETHFuI5BAgQIECAAAECBAgQuC4gRK9v2PcRIECAAAECBAgQIEBgTECIji3EcwgQIECAAAECBAgQIHBdQIhe37DvI0CAAAECBAgQIECAwJiAEB1biOcQIECAAAECBAgQIEDguoAQvb5h30eAAAECBAgQIECAAIExASE6thDPIUCAAAECBAgQIECAwHUBIXp9w76PAAECBAgQIECAAAECYwJCdGwhnkOAAAECBAgQIECAAIHrAkL0+oZ9HwECBAgQIECAAAECBMYEhOjYQjyHAAECBAgQIECAAAEC1wX+Adp3GOodWRJQAAAAAElFTkSuQmCC";
                                if(!empty($posted_data['incident_e_sig'])){
                                    if($posted_data['incident_e_sig'] === $blankimg){
                                        unset($posted_data['incident_e_sig']);
                                    }
                                    
                                    unset($posted_data['person_signature']);
                                
                                }
                                if(empty($rid)) {
	if(!empty($posted_data['incident_e_sig_reviewer'])){
		if($posted_data['incident_e_sig_reviewer'] === $blankimg){
			unset($posted_data['incident_e_sig_reviewer']);
		}
		unset($posted_data['reviewer_signature']);
	}
}
else {
	if(!empty($posted_data['incident_e_sig_reviewer'])){
		if($posted_data['incident_e_sig_reviewer'] === $blankimg){
			unset($posted_data['incident_e_sig_reviewer']);
		}
		if(!empty($posted_data['reviewer_signature'])){
			
		}else{
			 unset($posted_data['reviewer_signature']);
		}
	   
	}
}            
				$posted_data['incident_date']=date("Y-m-d",strtotime($posted_data['incident_date']));
				if(empty($rid)){
					$posted_data['incident_individual_id']=$indid;
					$posted_data['incident_form_id']=$formid;
					$posted_data['incident_added_user']=$this->view->user->subuser_id; //$this->view->user->agency_id;
					$posted_data['incident_agency_id']=$this->view->user->agency_id;
					$posted_data['report_created_on']=date('Y-m-d H:i:s');
				}
				if(isset($posted_data['is_included_claims'])){
					$posted_data['is_included_claims']=serialize($posted_data['is_included_claims']);
				}
				if(!empty($posted_data['incident_types'])){
					$posted_data['incident_types']=serialize($posted_data['incident_types']);
				}
				if(!empty($posted_data['nature_of_injury'])){
					$posted_data['nature_of_injury']=serialize($posted_data['nature_of_injury']);
				}
				if(!empty($posted_data['location_of_injury'])){
					$posted_data['location_of_injury']=serialize($posted_data['location_of_injury']);
				}
				
				if(!empty($posted_data['location_of_injury_by_humanavtar_male'])){
					$posted_data['location_of_injury_by_humanavtar_male']=serialize($posted_data['location_of_injury_by_humanavtar_male']);
				}
				
				if(!empty($posted_data['location_of_injury_by_humanavtar_female'])){
					$posted_data['location_of_injury_by_humanavtar_female']=serialize($posted_data['location_of_injury_by_humanavtar_female']);
				}
				
				if(!empty($posted_data['injury_area'])){
					$posted_data['injury_area']=serialize($posted_data['injury_area']);
				}
				if(!empty($posted_data['report_filling_date'])){
					$posted_data['report_filling_date']=date("Y-m-d",strtotime($posted_data['report_filling_date']));
				}else{
					$posted_data['report_filling_date']=NULL;
				}
				if(!empty($posted_data['reviewer_date'])){
					$posted_data['reviewer_date']=date("Y-m-d",strtotime($posted_data['reviewer_date']));
				}else{
					$posted_data['reviewer_date']=NULL;
				}
				if(!empty($posted_data['report_sent_date'])){
					$posted_data['report_sent_date']=date("Y-m-d",strtotime($posted_data['report_sent_date']));
				}else{
					$posted_data['report_sent_date']=NULL;
				}
				$notifyData['incident_recipient1']=$posted_data['incident_recipient1'];
				$notifyData['recipient_printed_name1']=$posted_data['recipient_printed_name1'];
				$notifyData['incident_notify_via1']=$posted_data['incident_notify_via1'];
				$notifyData['incident_notify_date1']=date("Y-m-d",strtotime($posted_data['incident_notify_date1']));
				$notifyData['incident_notify_time1']=$posted_data['incident_notify_time1'];
				
				unset($posted_data['incident_recipient1']);
				unset($posted_data['recipient_printed_name1']);
				unset($posted_data['incident_notify_via1']);
				unset($posted_data['incident_notify_date1']);
				unset($posted_data['incident_notify_time1']);
				
				$notifyData['incident_recipient2']=$posted_data['incident_recipient2'];
				$notifyData['recipient_printed_name2']=$posted_data['recipient_printed_name2'];
				$notifyData['incident_notify_via2']=$posted_data['incident_notify_via2'];
				$notifyData['incident_notify_date2']=date("Y-m-d",strtotime($posted_data['incident_notify_date2']));
				$notifyData['incident_notify_time2']=$posted_data['incident_notify_time2'];
				
				unset($posted_data['incident_recipient2']);
				unset($posted_data['recipient_printed_name2']);
				unset($posted_data['incident_notify_via2']);
				unset($posted_data['incident_notify_date2']);
				unset($posted_data['incident_notify_time2']);
				
				$notifyData['incident_recipient3']=$posted_data['incident_recipient3'];
				$notifyData['recipient_printed_name3']=$posted_data['recipient_printed_name3'];
				$notifyData['incident_notify_via3']=$posted_data['incident_notify_via3'];
				$notifyData['incident_notify_date3']=date("Y-m-d",strtotime($posted_data['incident_notify_date3']));
				$notifyData['incident_notify_time3']=$posted_data['incident_notify_time3'];
				
				unset($posted_data['incident_recipient3']);
				unset($posted_data['recipient_printed_name3']);
				unset($posted_data['incident_notify_via3']);
				unset($posted_data['incident_notify_date3']);
				unset($posted_data['incident_notify_time3']);
				
				$notifyData['incident_recipient4']=$posted_data['incident_recipient4'];
				$notifyData['recipient_printed_name4']=$posted_data['recipient_printed_name4'];
				$notifyData['incident_notify_via4']=$posted_data['incident_notify_via4'];
				$notifyData['incident_notify_date4']=date("Y-m-d",strtotime($posted_data['incident_notify_date4']));
				$notifyData['incident_notify_time4']=$posted_data['incident_notify_time4'];
				
				unset($posted_data['incident_recipient4']);
				unset($posted_data['recipient_printed_name4']);
				unset($posted_data['incident_notify_via4']);
				unset($posted_data['incident_notify_date4']);
				unset($posted_data['incident_notify_time4']);
				
				$notifyData['incident_recipient5']=$posted_data['incident_recipient5'];
				$notifyData['recipient_printed_name5']=$posted_data['recipient_printed_name5'];
				$notifyData['incident_notify_via5']=$posted_data['incident_notify_via5'];
				$notifyData['incident_notify_date5']=date("Y-m-d",strtotime($posted_data['incident_notify_date5']));
				$notifyData['incident_notify_time5']=$posted_data['incident_notify_time5'];
				
				unset($posted_data['incident_recipient5']);
				unset($posted_data['recipient_printed_name5']);
				unset($posted_data['incident_notify_via5']);
				unset($posted_data['incident_notify_date5']);
				unset($posted_data['incident_notify_time5']);
				
				$notifyData['incident_recipient6']=$posted_data['incident_recipient6'];
				$notifyData['recipient_printed_name6']=$posted_data['recipient_printed_name6'];
				$notifyData['incident_notify_via6']=$posted_data['incident_notify_via6'];
				$notifyData['incident_notify_date6']=date("Y-m-d",strtotime($posted_data['incident_notify_date6']));
				$notifyData['incident_notify_time6']=$posted_data['incident_notify_time6'];
				
				unset($posted_data['incident_recipient6']);
				unset($posted_data['recipient_printed_name6']);
				unset($posted_data['incident_notify_via6']);
				unset($posted_data['incident_notify_date6']);
				unset($posted_data['incident_notify_time6']);
				
				$notifyData['incident_recipient7']=$posted_data['incident_recipient7'];
				$notifyData['recipient_printed_name7']=$posted_data['recipient_printed_name7'];
				$notifyData['incident_notify_via7']=$posted_data['incident_notify_via7'];
				$notifyData['incident_notify_date7']=date("Y-m-d",strtotime($posted_data['incident_notify_date7']));
				$notifyData['incident_notify_time7']=$posted_data['incident_notify_time7'];
				
				unset($posted_data['incident_recipient7']);
				unset($posted_data['recipient_printed_name7']);
				unset($posted_data['incident_notify_via7']);
				unset($posted_data['incident_notify_date7']);
				unset($posted_data['incident_notify_time7']);
				
				$notifyData['incident_recipient8']=$posted_data['incident_recipient8'];
				$notifyData['recipient_printed_name8']=$posted_data['recipient_printed_name8'];
				$notifyData['incident_notify_via8']=$posted_data['incident_notify_via8'];
				$notifyData['incident_notify_date8']=date("Y-m-d",strtotime($posted_data['incident_notify_date8']));
				$notifyData['incident_notify_time8']=$posted_data['incident_notify_time8'];
				
				unset($posted_data['incident_recipient8']);
				unset($posted_data['recipient_printed_name8']);
				unset($posted_data['incident_notify_via8']);
				unset($posted_data['incident_notify_date8']);
				unset($posted_data['incident_notify_time8']);
				
				$notifyData['incident_recipient9']=$posted_data['incident_recipient9'];
				$notifyData['recipient_printed_name9']=$posted_data['recipient_printed_name9'];
				$notifyData['incident_notify_via9']=$posted_data['incident_notify_via9'];
				$notifyData['incident_notify_date9']=date("Y-m-d",strtotime($posted_data['incident_notify_date9']));
				$notifyData['incident_notify_time9']=$posted_data['incident_notify_time9'];
				
				unset($posted_data['incident_recipient9']);
				unset($posted_data['recipient_printed_name9']);
				unset($posted_data['incident_notify_via9']);
				unset($posted_data['incident_notify_date9']);
				unset($posted_data['incident_notify_time9']);
				
				$notifyData['incident_recipient10']=$posted_data['incident_recipient10'];
				$notifyData['recipient_printed_name10']=$posted_data['recipient_printed_name10'];
				$notifyData['incident_notify_via10']=$posted_data['incident_notify_via10'];
				$notifyData['incident_notify_date10']=date("Y-m-d",strtotime($posted_data['incident_notify_date10']));
				$notifyData['incident_notify_time10']=$posted_data['incident_notify_time10'];
				
				unset($posted_data['incident_recipient10']);
				unset($posted_data['recipient_printed_name10']);
				unset($posted_data['incident_notify_via10']);
				unset($posted_data['incident_notify_date10']);
				unset($posted_data['incident_notify_time10']);
   				$incidentId="";
				if(empty($rid)){
					$isIns=$this->SuperModel->Super_Insert("_uhs_incidents_reports",$posted_data);
					if($this->view->user->agency_user_type!="Agency" && in_array($this->view->user->agency_user_type,$systemusers)){
						
						$posted_data['system_user']=ucwords($this->view->user->agency_first_name." ".$this->view->user->agency_last_name);
						$posted_data['system_user_type']=ucwords($this->view->user->agency_user_type);
						
						$indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid);
						$agencyData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indData['agency_user_agency_id']);
						
						$posted_data['individual_name']=ucwords($indData['agency_first_name']." ".$indData['agency_last_name']);
						$posted_data['agency_name']=ucwords($agencyData['agency_first_name']." ".$agencyData['agency_last_name']);
						$posted_data['agency_user_email']=$agencyData['agency_email'];
						
						if(in_array($this->view->user->agency_user_type,$systemusers) && checkNotifySettings($this->view->user->agency_user_agency_id,"incident-report")){
							$nData=array("notification_user_id"=>$this->view->user->agency_user_agency_id,"notification_type"=>"incident-report","notification_type_id"=>$isIns->inserted_id,"notification_by_user_id"=>$this->view->user->agency_id,"notification_date"=>date("Y-m-d H:i:s"));
							$isNotify=$this->SuperModel->Super_Insert("_uhs_notifications",$nData);
							$isSend=$this->modelEmail->sendEmail("incident_report_creation_notification_to_agency",$posted_data);
						}
					}
					$incidentId=$isIns->inserted_id;
				}
				else{
					$posted_data['incident_modified_by']=$this->view->user->subuser_id;
					$posted_data['incident_modified_on']=date("Y-m-d H:i:s");
					$isIns=$this->SuperModel->Super_Insert("_uhs_incidents_reports",$posted_data,"incident_id=".$rid);
					$incidentId=$rid;
				}
				if(is_object($isIns) and $isIns->success){
					$isExists=$this->SuperModel->Super_Get("_uhs_incident_notifications","incident_report_id=".$incidentId);
					if(!empty($isExists)){
						$isDel=$this->SuperModel->Super_Delete("_uhs_incident_notifications","incident_report_id=".$incidentId);
					}
					for($i=1;$i<=10;$i++){
						if(!empty($notifyData['incident_recipient'.$i])){
							$notifyArr['incident_report_id']=$incidentId;
							$notifyArr['incident_recipient']=$notifyData['incident_recipient'.$i];
							$notifyArr['recipient_printed_name']=$notifyData['recipient_printed_name'.$i];
							$notifyArr['incident_notify_via']=$notifyData['incident_notify_via'.$i];
							$notifyArr['incident_notify_date']=$notifyData['incident_notify_date'.$i];
							$notifyArr['incident_notify_time']=$notifyData['incident_notify_time'.$i];
							$ntyIns=$this->SuperModel->Super_Insert("_uhs_incident_notifications",$notifyArr);
						}
					}
					if(empty($rid)){
						$healthSession->successMsg="Incident Report has been added successfully.";
					}
					else{
						$healthSession->successMsg="Incident Report has been updated successfully.";
					}
					$this->_helper->getHelper('Redirector')->gotoRoute(array('indid'=>$indid,'formid'=>$formid),"front_incident_reports");
 				}else{
					$healthSession->errorMsg=$isIns->message; 
				}
			}else{
				$healthSession->errorMsg="Please check information again.";	
			}
  		}
		$this->view->form = $form;
	}
	
	public function addincident_backupAction(){
		global $healthSession,$systemusers;
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$rid=$this->_getParam("rid");
		if(isFormAssigned($formid,$indid)){
			$healthSession->errorMsg="Please assign form to individual first";
			$this->_helper->getHelper('Redirector')->gotoRoute(array('indid'=>$indid,'formid'=>$formid),"front_incident_reports");
		}
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		if($permissions=="View Only"){
			$healthSession->errorMsg="You don't have permission to access this page.";
			$this->_helper->getHelper('Redirector')->gotoRoute(array('indid'=>$indid,'formid'=>$formid),"front_incident_reports");
		}
		if(empty($rid)){
			$this->view->pageHeading="Add Incident Report";
		}
		else{
			$this->view->pageHeading="Edit Incident Report";
		}
		$this->view->rid=$rid;
		$this->view->indid=$indid;
		$this->view->formid=$formid;
		$form=new Application_Form_CustomForms();
		$form->incident();
		$incidentData=array();
		if(!empty($rid)){
			$incidentData=$this->SuperModel->Super_Get("_uhs_incidents_reports","incident_id=".$rid,"fetch");
			if(empty($incidentData)){
				$healthSession->errorMsg="No incident report exists";
				$this->_helper->getHelper('Redirector')->gotoRoute(array('indid'=>$indid,'formid'=>$formid),"front_incident_reports");
			}
			if(!empty($incidentData) && $incidentData['is_report_completed']=='1'){
				$healthSession->errorMsg="You can't edit incident report.";
				$this->_helper->getHelper('Redirector')->gotoRoute(array('indid'=>$indid,'formid'=>$formid),"front_incident_reports");
			}
			$incidentData['incident_date']=date("m/d/y",strtotime($incidentData['incident_date']));
			if(!empty($incidentData['report_filling_date'])){
				$incidentData['report_filling_date']=date("m/d/y",strtotime($incidentData['report_filling_date']));
			}
			if(!empty($incidentData['reviewer_date'])){
				$incidentData['reviewer_date']=date("m/d/y",strtotime($incidentData['reviewer_date']));
			}
			if(!empty($incidentData['report_sent_date'])){
				$incidentData['report_sent_date']=date("m/d/y",strtotime($incidentData['report_sent_date']));
			}
			if(empty($incidentData)){
				$healthSession->errorMsg="Requested record not found.";
				$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_incident_reports");	
			}
			if(!empty($incidentData['incident_types'])){ $incidentData['incident_types']=unserialize($incidentData['incident_types']); }
			if(!empty($incidentData['nature_of_injury'])){ $incidentData['nature_of_injury']=unserialize($incidentData['nature_of_injury']);}
			if(!empty($incidentData['location_of_injury'])){ $incidentData['location_of_injury']=unserialize($incidentData['location_of_injury']);}
			if(!empty($incidentData['injury_area'])){ $incidentData['injury_area']=unserialize($incidentData['injury_area']);}
			if(!empty($incidentData['is_included_claims'])){ $incidentData['is_included_claims']=unserialize($incidentData['is_included_claims']);}
			
			$notifyData=$this->SuperModel->Super_Get("_uhs_incident_notifications","incident_report_id=".$rid,"fetchAll");
			foreach($notifyData as $notify){
				switch($notify['incident_recipient']){
					case "Home Manager":
						$incidentData['incident_recipient1']=$notify['incident_recipient'];
						$incidentData['recipient_printed_name1']=$notify['recipient_printed_name'];
						$incidentData['incident_notify_via1']=$notify['incident_notify_via'];
						$incidentData['incident_notify_date1']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$incidentData['incident_notify_time1']=$notify['incident_notify_time'];
					break;
					
					case "On-Call (Emergency Only)":
						$incidentData['incident_recipient2']=$notify['incident_recipient'];
						$incidentData['recipient_printed_name2']=$notify['recipient_printed_name'];
						$incidentData['incident_notify_via2']=$notify['incident_notify_via'];
						$incidentData['incident_notify_date2']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$incidentData['incident_notify_time2']=$notify['incident_notify_time'];
					break;
					
					case "Nurse (medical incident)":
						$incidentData['incident_recipient3']=$notify['incident_recipient'];
						$incidentData['recipient_printed_name3']=$notify['recipient_printed_name'];
						$incidentData['incident_notify_via3']=$notify['incident_notify_via'];
						$incidentData['incident_notify_date3']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$incidentData['incident_notify_time3']=$notify['incident_notify_time'];
					break;
					
					case "Program Specialist":
						$incidentData['incident_recipient4']=$notify['incident_recipient'];
						$incidentData['recipient_printed_name4']=$notify['recipient_printed_name'];
						$incidentData['incident_notify_via4']=$notify['incident_notify_via'];
						$incidentData['incident_notify_date4']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$incidentData['incident_notify_time4']=$notify['incident_notify_time'];
					break;
					
					case "Guardian (if applicable)":
						$incidentData['incident_recipient5']=$notify['incident_recipient'];
						$incidentData['recipient_printed_name5']=$notify['recipient_printed_name'];
						$incidentData['incident_notify_via5']=$notify['incident_notify_via'];
						$incidentData['incident_notify_date5']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$incidentData['incident_notify_time5']=$notify['incident_notify_time'];
					break;
					
					case "Advocate (if applicable)":
						$incidentData['incident_recipient6']=$notify['incident_recipient'];
						$incidentData['recipient_printed_name6']=$notify['recipient_printed_name'];
						$incidentData['incident_notify_via6']=$notify['incident_notify_via'];
						$incidentData['incident_notify_date6']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$incidentData['incident_notify_time6']=$notify['incident_notify_time'];
					break;
					
					case "County Service Coordinator":
						$incidentData['incident_recipient7']=$notify['incident_recipient'];
						$incidentData['recipient_printed_name7']=$notify['recipient_printed_name'];
						$incidentData['incident_notify_via7']=$notify['incident_notify_via'];
						$incidentData['incident_notify_date7']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$incidentData['incident_notify_time7']=$notify['incident_notify_time'];
					break;
					
					case "MUI Investigator":
						$incidentData['incident_recipient8']=$notify['incident_recipient'];
						$incidentData['recipient_printed_name8']=$notify['recipient_printed_name'];
						$incidentData['incident_notify_via8']=$notify['incident_notify_via'];
						$incidentData['incident_notify_date8']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$incidentData['incident_notify_time8']=$notify['incident_notify_time'];
					break;
				}
			}
			$form->populate($incidentData);
		}
		$this->view->incidentData=$incidentData;
   		if($this->getRequest()->isPost()){
 			$posted_data = $this->getRequest()->getPost();
			if($form->isValid($posted_data)){
				unset($posted_data['bttnsubmit']);
				$posted_data['incident_date']=date("Y-m-d",strtotime($posted_data['incident_date']));
				if(empty($rid)){
					$posted_data['incident_individual_id']=$indid;
					$posted_data['incident_form_id']=$formid;
					$posted_data['incident_added_user']=$this->view->user->subuser_id; //$this->view->user->agency_id;
					$posted_data['incident_agency_id']=$this->view->user->agency_id;
					$posted_data['report_created_on']=date('Y-m-d H:i:s');
				}
				if(isset($posted_data['is_included_claims'])){
					$posted_data['is_included_claims']=serialize($posted_data['is_included_claims']);
				}
				if(!empty($posted_data['incident_types'])){
					$posted_data['incident_types']=serialize($posted_data['incident_types']);
				}
				if(!empty($posted_data['nature_of_injury'])){
					$posted_data['nature_of_injury']=serialize($posted_data['nature_of_injury']);
				}
				if(!empty($posted_data['location_of_injury'])){
					$posted_data['location_of_injury']=serialize($posted_data['location_of_injury']);
				}
				if(!empty($posted_data['injury_area'])){
					$posted_data['injury_area']=serialize($posted_data['injury_area']);
				}
				if(!empty($posted_data['report_filling_date'])){
					$posted_data['report_filling_date']=date("Y-m-d",strtotime($posted_data['report_filling_date']));
				}else{
					$posted_data['report_filling_date']=NULL;
				}
				if(!empty($posted_data['reviewer_date'])){
					$posted_data['reviewer_date']=date("Y-m-d",strtotime($posted_data['reviewer_date']));
				}else{
					$posted_data['reviewer_date']=NULL;
				}
				if(!empty($posted_data['report_sent_date'])){
					$posted_data['report_sent_date']=date("Y-m-d",strtotime($posted_data['report_sent_date']));
				}else{
					$posted_data['report_sent_date']=NULL;
				}
				$notifyData['incident_recipient1']=$posted_data['incident_recipient1'];
				$notifyData['recipient_printed_name1']=$posted_data['recipient_printed_name1'];
				$notifyData['incident_notify_via1']=$posted_data['incident_notify_via1'];
				$notifyData['incident_notify_date1']=date("Y-m-d",strtotime($posted_data['incident_notify_date1']));
				$notifyData['incident_notify_time1']=$posted_data['incident_notify_time1'];
				
				unset($posted_data['incident_recipient1']);
				unset($posted_data['recipient_printed_name1']);
				unset($posted_data['incident_notify_via1']);
				unset($posted_data['incident_notify_date1']);
				unset($posted_data['incident_notify_time1']);
				
				$notifyData['incident_recipient2']=$posted_data['incident_recipient2'];
				$notifyData['recipient_printed_name2']=$posted_data['recipient_printed_name2'];
				$notifyData['incident_notify_via2']=$posted_data['incident_notify_via2'];
				$notifyData['incident_notify_date2']=date("Y-m-d",strtotime($posted_data['incident_notify_date2']));
				$notifyData['incident_notify_time2']=$posted_data['incident_notify_time2'];
				
				unset($posted_data['incident_recipient2']);
				unset($posted_data['recipient_printed_name2']);
				unset($posted_data['incident_notify_via2']);
				unset($posted_data['incident_notify_date2']);
				unset($posted_data['incident_notify_time2']);
				
				$notifyData['incident_recipient3']=$posted_data['incident_recipient3'];
				$notifyData['recipient_printed_name3']=$posted_data['recipient_printed_name3'];
				$notifyData['incident_notify_via3']=$posted_data['incident_notify_via3'];
				$notifyData['incident_notify_date3']=date("Y-m-d",strtotime($posted_data['incident_notify_date3']));
				$notifyData['incident_notify_time3']=$posted_data['incident_notify_time3'];
				
				unset($posted_data['incident_recipient3']);
				unset($posted_data['recipient_printed_name3']);
				unset($posted_data['incident_notify_via3']);
				unset($posted_data['incident_notify_date3']);
				unset($posted_data['incident_notify_time3']);
				
				$notifyData['incident_recipient4']=$posted_data['incident_recipient4'];
				$notifyData['recipient_printed_name4']=$posted_data['recipient_printed_name4'];
				$notifyData['incident_notify_via4']=$posted_data['incident_notify_via4'];
				$notifyData['incident_notify_date4']=date("Y-m-d",strtotime($posted_data['incident_notify_date4']));
				$notifyData['incident_notify_time4']=$posted_data['incident_notify_time4'];
				
				unset($posted_data['incident_recipient4']);
				unset($posted_data['recipient_printed_name4']);
				unset($posted_data['incident_notify_via4']);
				unset($posted_data['incident_notify_date4']);
				unset($posted_data['incident_notify_time4']);
				
				$notifyData['incident_recipient5']=$posted_data['incident_recipient5'];
				$notifyData['recipient_printed_name5']=$posted_data['recipient_printed_name5'];
				$notifyData['incident_notify_via5']=$posted_data['incident_notify_via5'];
				$notifyData['incident_notify_date5']=date("Y-m-d",strtotime($posted_data['incident_notify_date5']));
				$notifyData['incident_notify_time5']=$posted_data['incident_notify_time5'];
				
				unset($posted_data['incident_recipient5']);
				unset($posted_data['recipient_printed_name5']);
				unset($posted_data['incident_notify_via5']);
				unset($posted_data['incident_notify_date5']);
				unset($posted_data['incident_notify_time5']);
				
				$notifyData['incident_recipient6']=$posted_data['incident_recipient6'];
				$notifyData['recipient_printed_name6']=$posted_data['recipient_printed_name6'];
				$notifyData['incident_notify_via6']=$posted_data['incident_notify_via6'];
				$notifyData['incident_notify_date6']=date("Y-m-d",strtotime($posted_data['incident_notify_date6']));
				$notifyData['incident_notify_time6']=$posted_data['incident_notify_time6'];
				
				unset($posted_data['incident_recipient6']);
				unset($posted_data['recipient_printed_name6']);
				unset($posted_data['incident_notify_via6']);
				unset($posted_data['incident_notify_date6']);
				unset($posted_data['incident_notify_time6']);
				
				$notifyData['incident_recipient7']=$posted_data['incident_recipient7'];
				$notifyData['recipient_printed_name7']=$posted_data['recipient_printed_name7'];
				$notifyData['incident_notify_via7']=$posted_data['incident_notify_via7'];
				$notifyData['incident_notify_date7']=date("Y-m-d",strtotime($posted_data['incident_notify_date7']));
				$notifyData['incident_notify_time7']=$posted_data['incident_notify_time7'];
				
				unset($posted_data['incident_recipient7']);
				unset($posted_data['recipient_printed_name7']);
				unset($posted_data['incident_notify_via7']);
				unset($posted_data['incident_notify_date7']);
				unset($posted_data['incident_notify_time7']);
				
				$notifyData['incident_recipient8']=$posted_data['incident_recipient8'];
				$notifyData['recipient_printed_name8']=$posted_data['recipient_printed_name8'];
				$notifyData['incident_notify_via8']=$posted_data['incident_notify_via8'];
				$notifyData['incident_notify_date8']=date("Y-m-d",strtotime($posted_data['incident_notify_date8']));
				$notifyData['incident_notify_time8']=$posted_data['incident_notify_time8'];
				
				unset($posted_data['incident_recipient8']);
				unset($posted_data['recipient_printed_name8']);
				unset($posted_data['incident_notify_via8']);
				unset($posted_data['incident_notify_date8']);
				unset($posted_data['incident_notify_time8']);
   				$incidentId="";
				if(empty($rid)){
					$isIns=$this->SuperModel->Super_Insert("_uhs_incidents_reports",$posted_data);
					if($this->view->user->agency_user_type!="Agency" && in_array($this->view->user->agency_user_type,$systemusers)){
						
						$posted_data['system_user']=ucwords($this->view->user->agency_first_name." ".$this->view->user->agency_last_name);
						$posted_data['system_user_type']=ucwords($this->view->user->agency_user_type);
						
						$indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid);
						$agencyData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indData['agency_user_agency_id']);
						
						$posted_data['individual_name']=ucwords($indData['agency_first_name']." ".$indData['agency_last_name']);
						$posted_data['agency_name']=ucwords($agencyData['agency_first_name']." ".$agencyData['agency_last_name']);
						$posted_data['agency_user_email']=$agencyData['agency_email'];
						
						if(in_array($this->view->user->agency_user_type,$systemusers) && checkNotifySettings($this->view->user->agency_user_agency_id,"incident-report")){
							$nData=array("notification_user_id"=>$this->view->user->agency_user_agency_id,"notification_type"=>"incident-report","notification_type_id"=>$isIns->inserted_id,"notification_by_user_id"=>$this->view->user->agency_id,"notification_date"=>date("Y-m-d H:i:s"));
							$isNotify=$this->SuperModel->Super_Insert("_uhs_notifications",$nData);
							$isSend=$this->modelEmail->sendEmail("incident_report_creation_notification_to_agency",$posted_data);
						}
					}
					$incidentId=$isIns->inserted_id;
				}
				else{
					$posted_data['incident_modified_by']=$this->view->user->subuser_id;
					$posted_data['incident_modified_on']=date("Y-m-d H:i:s");
					$isIns=$this->SuperModel->Super_Insert("_uhs_incidents_reports",$posted_data,"incident_id=".$rid);
					$incidentId=$rid;
				}
				if(is_object($isIns) and $isIns->success){
					$isExists=$this->SuperModel->Super_Get("_uhs_incident_notifications","incident_report_id=".$incidentId);
					if(!empty($isExists)){
						$isDel=$this->SuperModel->Super_Delete("_uhs_incident_notifications","incident_report_id=".$incidentId);
					}
					for($i=1;$i<=8;$i++){
						if(!empty($notifyData['incident_recipient'.$i])){
							$notifyArr['incident_report_id']=$incidentId;
							$notifyArr['incident_recipient']=$notifyData['incident_recipient'.$i];
							$notifyArr['recipient_printed_name']=$notifyData['recipient_printed_name'.$i];
							$notifyArr['incident_notify_via']=$notifyData['incident_notify_via'.$i];
							$notifyArr['incident_notify_date']=$notifyData['incident_notify_date'.$i];
							$notifyArr['incident_notify_time']=$notifyData['incident_notify_time'.$i];
							$ntyIns=$this->SuperModel->Super_Insert("_uhs_incident_notifications",$notifyArr);
						}
					}
					if(empty($rid)){
						$healthSession->successMsg="Incident Report has been added successfully.";
					}
					else{
						$healthSession->successMsg="Incident Report has been updated successfully.";
					}
					$this->_helper->getHelper('Redirector')->gotoRoute(array('indid'=>$indid,'formid'=>$formid),"front_incident_reports");
 				}else{
					$healthSession->errorMsg=$isIns->message; 
				}
			}else{
				$healthSession->errorMsg="Please check information again.";	
			}
  		}
		$this->view->form = $form;
	}
	
	public function showincidenttrendsAction(){
		global $healthSession;
		$this->view->pageHeading="Incident Trends";
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$this->view->indid=$indid;
		$this->view->formid=$formid;
		$agency_type = $this->view->user->agency_user_type;
		$this->view->agency_type=$agency_type;
	}
	
	public function getincidenttrendsAction(){
		global $healthSession;
		$indid=$_REQUEST['indid'];
		$formid=$_REQUEST['formid'];
		$month=$_REQUEST['month'];
		$year=$_REQUEST['year'];
		$incidentData=$this->SuperModel->Super_Get("_uhs_incidents_reports","MONTH(report_created_on)='".$month."' and YEAR(report_created_on)='".$year."' and incident_individual_id=".$indid." and incident_form_id=".$formid, "fetchAll");
		$trends=array();
		if(count($incidentData)>0){
			$a=$as=$ia=$me=$e=$d=$s=$all=$an=$mp=$l=$ita=$mt=$me=$rl=$rc=$ns=$rf=$ot=0;
			$insArr=array();
			foreach($incidentData as $incident){
			    /* if(!empty($incident['incident_types'])){
			   	  $insArr[]=unserialize($incident['incident_types']);
			   }*/
			  if(!empty($incident['incident_types'])){
					$incidentTypes=unserialize($incident['incident_types']);
					if(in_array("Abuse",$incidentTypes)){
						$trends[]=array("name"=>"Abuse","y"=>$a+1);
					}
					if(in_array("Attempted Suicide",$incidentTypes)){
						$trends[]=array("name"=>"Attempted Suicide","y"=>$as+1);
					}
					if(in_array("Individual Aggression toward Staff",$incidentTypes)){
						$trends[]=array("name"=>"Individual Aggression toward Staff","y"=>$ia+1);
					}
					if(in_array("Medical Emergency",$incidentTypes)){ 
						$trends[]=array("name"=>"Medical Emergency","y"=>$me+1);
					}
					if(in_array("Exploitation",$incidentTypes)){
						$trends[]=array("name"=>"Exploitation","y"=>$e+1);
					}
					if(in_array("Seizure",$incidentTypes)){
						$trends[]=array("name"=>"Seizure","y"=>$s+1);
					}
					if(in_array("Death",$incidentTypes)){
						$trends[]=array("name"=>"Death","y"=>$d+1);
					}
					if(in_array("Alleged Abuse",$incidentTypes)){
						$trends[]=array("name"=>"Alleged Abuse","y"=>$all+1);
					}
					if(in_array("Alleged Neglect",$incidentTypes)){
						$trends[]=array("name"=>"Alleged Neglect","y"=>$an+1);
					}
					if(in_array("Missing Person",$incidentTypes)){
						$trends[]=array("name"=>"Missing Person","y"=>$mp+1);
					}
					if(in_array("Law Enforcement Involvement",$incidentTypes)){
						$trends[]=array("name"=>"Law Enforcement Involvement","y"=>$l+1);
					}
					if(in_array("Individual to Individual Aggression",$incidentTypes)){
						$trends[]=array("name"=>"Individual to Individual Aggression","y"=>$ita+1);
					}
					if(in_array("Misappropriation (Theft / Fraud)",$incidentTypes)){
						$trends[]=array("name"=>"Misappropriation (Theft / Fraud)","y"=>$mt+1);
					}
					if(in_array("Medication Error",$incidentTypes)){
						$trends[]=array("name"=>"Medication Error","y"=>$me+1);
					}
					if(in_array("Relocation",$incidentTypes)){
						$trends[]=array("name"=>"Relocation","y"=>$rl+1);
					}
					if(in_array("Right Code Violation",$incidentTypes)){
						$trends[]=array("name"=>"Right Code Violation","y"=>$rc+1);
					}
					if(in_array("No Shows (Transportation Only)",$incidentTypes)){
						$trends[]=array("name"=>"No Shows (Transportation Only)","y"=>$ns+1);
					}
					if(in_array("Refusal",$incidentTypes)){
						$trends[]=array("name"=>"Refusal","y"=>$rf+1);
					}
					if(in_array("Other",$incidentTypes)){
						$trends[]=array("name"=>"Other","y"=>$ot+1);
					}
			  }   
			}
			$results=array();
			foreach($trends as $value){
			  if(!isset($results[$value['name']])){
				 $results[$value['name']]=0;
			  }
			  $results[$value['name']]+=$value['y'];
			}
			$resArr=array();
			foreach($results as $key=>$res){
				$resArr[]=array("name"=>$key,"y"=>$res);
			}
			echo json_encode($resArr);
		}
		else{
			echo json_encode("No Record");
		}
		exit();
	}
	
	public function viewincidentAction(){
		global $healthSession;
		$rid=$this->_getParam('rid');
		$indid=$this->_getParam('indid');
		$formid=$this->_getParam('formid');
		$this->view->rid=$rid;
		$this->view->formid=$formid;
		$this->view->indid=$indid;
		$data=$this->SuperModel->Super_Get("_uhs_incidents_reports","incident_id=".$rid,"fetch");
		
		$data['incident_date']=date("m/d/y",strtotime($data['incident_date']));
		if(!empty($data['report_filling_date'])){
			$data['report_filling_date']=date("m/d/y",strtotime($data['report_filling_date']));
		}
		if(!empty($data['report_sent_date'])){
			$data['report_sent_date']=date("m/d/y",strtotime($data['report_sent_date']));
		}
		if(!empty($data['reviewer_date'])){
			$data['reviewer_date']=date("m/d/y",strtotime($data['reviewer_date']));
		}
		$incTypes=$injuryNature=$injuryLoc=$injuryArea="NA";
		$data['incident_recipient1']="Home Manager";
		$data['recipient_printed_name1']="";
		$data['incident_notify_via1']="";
		$data['incident_notify_date1']="";
		$data['incident_notify_time1']="";
		
		$data['incident_recipient2']="On-Call (Emergency Only)";
		$data['recipient_printed_name2']="";
		$data['incident_notify_via2']="";
		$data['incident_notify_date2']="";
		$data['incident_notify_time2']="";
		
		$data['incident_recipient3']="Nurse (medical incident)";
		$data['recipient_printed_name3']="";
		$data['incident_notify_via3']="";
		$data['incident_notify_date3']="";
		$data['incident_notify_time3']="";
		
		$data['incident_recipient4']="Program Specialist";
		$data['recipient_printed_name4']="";
		$data['incident_notify_via4']="";
		$data['incident_notify_date4']="";
		$data['incident_notify_time4']="";
		
		$data['incident_recipient5']="Guardian (if applicable)";
		$data['recipient_printed_name5']="";
		$data['incident_notify_via5']="";
		$data['incident_notify_date5']="";
		$data['incident_notify_time5']="";
		
		$data['incident_recipient6']="Advocate (if applicable)";
		$data['recipient_printed_name6']="";
		$data['incident_notify_via6']="";
		$data['incident_notify_date6']="";
		$data['incident_notify_time6']="";
		
		$data['incident_recipient7']="County Service Coordinator";
		$data['recipient_printed_name7']="";
		$data['incident_notify_via7']="";
		$data['incident_notify_date7']="";
		$data['incident_notify_time7']="";
		
		$data['incident_recipient8']="MUI Investigator";
		$data['recipient_printed_name8']="";
		$data['incident_notify_via8']="";
		$data['incident_notify_date8']="";
		$data['incident_notify_time8']="";

		$notifyData=$this->SuperModel->Super_Get("_uhs_incident_notifications","incident_report_id=".$data['incident_id'],"fetchAll");
		foreach($notifyData as $notify){
			switch($notify['incident_recipient']){
					case "Home Manager":
						$data['incident_recipient1']=$notify['incident_recipient'];
						$data['recipient_printed_name1']=$notify['recipient_printed_name'];
						$data['incident_notify_via1']=$notify['incident_notify_via'];
						$data['incident_notify_date1']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$data['incident_notify_time1']=$notify['incident_notify_time'];
					break;
					
					case "On-Call (Emergency Only)":
						$data['incident_recipient2']=$notify['incident_recipient'];
						$data['recipient_printed_name2']=$notify['recipient_printed_name'];
						$data['incident_notify_via2']=$notify['incident_notify_via'];
						$data['incident_notify_date2']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$data['incident_notify_time2']=$notify['incident_notify_time'];
					break;
					
					case "Nurse (medical incident)":
						$data['incident_recipient3']=$notify['incident_recipient'];
						$data['recipient_printed_name3']=$notify['recipient_printed_name'];
						$data['incident_notify_via3']=$notify['incident_notify_via'];
						$data['incident_notify_date3']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$data['incident_notify_time3']=$notify['incident_notify_time'];
					break;
					
					case "Program Specialist":
						$data['incident_recipient4']=$notify['incident_recipient'];
						$data['recipient_printed_name4']=$notify['recipient_printed_name'];
						$data['incident_notify_via4']=$notify['incident_notify_via'];
						$data['incident_notify_date4']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$data['incident_notify_time4']=$notify['incident_notify_time'];
					break;
					
					case "Guardian (if applicable)":
						$data['incident_recipient5']=$notify['incident_recipient'];
						$data['recipient_printed_name5']=$notify['recipient_printed_name'];
						$data['incident_notify_via5']=$notify['incident_notify_via'];
						$data['incident_notify_date5']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$data['incident_notify_time5']=$notify['incident_notify_time'];
					break;
					
					case "Advocate (if applicable)":
						$data['incident_recipient6']=$notify['incident_recipient'];
						$data['recipient_printed_name6']=$notify['recipient_printed_name'];
						$data['incident_notify_via6']=$notify['incident_notify_via'];
						$data['incident_notify_date6']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$data['incident_notify_time6']=$notify['incident_notify_time'];
					break;
					
					case "County Service Coordinator":
						$data['incident_recipient7']=$notify['incident_recipient'];
						$data['recipient_printed_name7']=$notify['recipient_printed_name'];
						$data['incident_notify_via7']=$notify['incident_notify_via'];
						$data['incident_notify_date7']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$data['incident_notify_time7']=$notify['incident_notify_time'];
					break;
					
					case "MUI Investigator":
						$data['incident_recipient8']=$notify['incident_recipient'];
						$data['recipient_printed_name8']=$notify['recipient_printed_name'];
						$data['incident_notify_via8']=$notify['incident_notify_via'];
						$data['incident_notify_date8']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$data['incident_notify_time8']=$notify['incident_notify_time'];
					break;
				}
		}
		$this->view->data=$data;
	}
	
	public function viewincidentreportAction(){
		global $healthSession;
		$loggedUser=getFromView('user',true);
		$rid=$this->_getParam('rid');
		$indid=$this->_getParam('indid');
		$formid=$this->_getParam('formid');
		$this->view->rid=$rid;
		$this->view->formid=$formid;
		$this->view->indid=$indid;
		$data=$this->SuperModel->Super_Get("_uhs_incidents_reports","incident_id=".$rid,"fetch");
		$indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$data['incident_individual_id'],"fetch");
		$data['incident_date']=date("m/d/y",strtotime($data['incident_date']));
		if(!empty($data['report_filling_date'])){
			$data['report_filling_date']=date("m/d/y",strtotime($data['report_filling_date']));
		}
		if(!empty($data['report_sent_date'])){
			$data['report_sent_date']=date("m/d/y",strtotime($data['report_sent_date']));
		}
		if(!empty($data['reviewer_date'])){
			$data['reviewer_date']=date("m/d/y",strtotime($data['reviewer_date']));
		}
		$incTypes=$injuryNature=$injuryLoc=$injuryArea="NA";
		if(!empty($data['incident_types'])){
			$incTypes=implode(",",unserialize($data['incident_types']));
			$incTypes=str_replace("Other","Other-".$data['incident_other_type'],$incTypes);
					
		} else{

            $incTypes= "NA"; 
		} 

		if(!empty($data['nature_of_injury'])){
			$injuryNature=implode(",",unserialize($data['nature_of_injury']));
			$injuryNature=str_replace("Other","Other-".$data['incident_other_nature'],$injuryNature);
					
		} else{
            $injuryNature= "NA"; 
		} 

		if(!empty($data['location_of_injury'])){
			$injuryLoc=implode(",",unserialize($data['location_of_injury']));

		} else{

			$injuryLoc="NA"; 
		}

		if(!empty($data['injury_area'])){
			$injuryArea=implode(",",unserialize($data['injury_area']));
			$injuryArea=str_replace("Other","Other-".$data['incident_other_area'],$injuryArea);
					
		} else{

		    $injuryArea="NA"; 
		}

		$pinvolvement=isEmpty($data['is_police_involvement']);

		$pdepartment= isEmpty($data['police_department']);

		$data['incident_recipient1']="Home Manager";
		$data['recipient_printed_name1']="";
		$data['incident_notify_via1']="";
		$data['incident_notify_date1']="";
		$data['incident_notify_time1']="";
		
		$data['incident_recipient2']="On-Call (Emergency Only)";
		$data['recipient_printed_name2']="";
		$data['incident_notify_via2']="";
		$data['incident_notify_date2']="";
		$data['incident_notify_time2']="";
		
		$data['incident_recipient3']="Nurse (medical incident)";
		$data['recipient_printed_name3']="";
		$data['incident_notify_via3']="";
		$data['incident_notify_date3']="";
		$data['incident_notify_time3']="";
		
		$data['incident_recipient4']="Program Specialist";
		$data['recipient_printed_name4']="";
		$data['incident_notify_via4']="";
		$data['incident_notify_date4']="";
		$data['incident_notify_time4']="";
		
		$data['incident_recipient5']="Guardian (if applicable)";
		$data['recipient_printed_name5']="";
		$data['incident_notify_via5']="";
		$data['incident_notify_date5']="";
		$data['incident_notify_time5']="";
		
		$data['incident_recipient6']="Advocate (if applicable)";
		$data['recipient_printed_name6']="";
		$data['incident_notify_via6']="";
		$data['incident_notify_date6']="";
		$data['incident_notify_time6']="";
		
		$data['incident_recipient7']="County Service Coordinator";
		$data['recipient_printed_name7']="";
		$data['incident_notify_via7']="";
		$data['incident_notify_date7']="";
		$data['incident_notify_time7']="";
		
		$data['incident_recipient8']="MUI Investigator";
		$data['recipient_printed_name8']="";
		$data['incident_notify_via8']="";
		$data['incident_notify_date8']="";
		$data['incident_notify_time8']="";

		$notifyData=$this->SuperModel->Super_Get("_uhs_incident_notifications","incident_report_id=".$data['incident_id'],"fetchAll");
		foreach($notifyData as $notify){
			switch($notify['incident_recipient']){
					case "Home Manager":
						$data['incident_recipient1']=$notify['incident_recipient'];
						$data['recipient_printed_name1']=$notify['recipient_printed_name'];
						$data['incident_notify_via1']=$notify['incident_notify_via'];
						$data['incident_notify_date1']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$data['incident_notify_time1']=$notify['incident_notify_time'];
					break;
					
					case "On-Call (Emergency Only)":
						$data['incident_recipient2']=$notify['incident_recipient'];
						$data['recipient_printed_name2']=$notify['recipient_printed_name'];
						$data['incident_notify_via2']=$notify['incident_notify_via'];
						$data['incident_notify_date2']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$data['incident_notify_time2']=$notify['incident_notify_time'];
					break;
					
					case "Nurse (medical incident)":
						$data['incident_recipient3']=$notify['incident_recipient'];
						$data['recipient_printed_name3']=$notify['recipient_printed_name'];
						$data['incident_notify_via3']=$notify['incident_notify_via'];
						$data['incident_notify_date3']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$data['incident_notify_time3']=$notify['incident_notify_time'];
					break;
					
					case "Program Specialist":
						$data['incident_recipient4']=$notify['incident_recipient'];
						$data['recipient_printed_name4']=$notify['recipient_printed_name'];
						$data['incident_notify_via4']=$notify['incident_notify_via'];
						$data['incident_notify_date4']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$data['incident_notify_time4']=$notify['incident_notify_time'];
					break;
					
					case "Guardian (if applicable)":
						$data['incident_recipient5']=$notify['incident_recipient'];
						$data['recipient_printed_name5']=$notify['recipient_printed_name'];
						$data['incident_notify_via5']=$notify['incident_notify_via'];
						$data['incident_notify_date5']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$data['incident_notify_time5']=$notify['incident_notify_time'];
					break;
					
					case "Advocate (if applicable)":
						$data['incident_recipient6']=$notify['incident_recipient'];
						$data['recipient_printed_name6']=$notify['recipient_printed_name'];
						$data['incident_notify_via6']=$notify['incident_notify_via'];
						$data['incident_notify_date6']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$data['incident_notify_time6']=$notify['incident_notify_time'];
					break;
					
					case "County Service Coordinator":
						$data['incident_recipient7']=$notify['incident_recipient'];
						$data['recipient_printed_name7']=$notify['recipient_printed_name'];
						$data['incident_notify_via7']=$notify['incident_notify_via'];
						$data['incident_notify_date7']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$data['incident_notify_time7']=$notify['incident_notify_time'];
					break;
					
					case "MUI Investigator":
						$data['incident_recipient8']=$notify['incident_recipient'];
						$data['recipient_printed_name8']=$notify['recipient_printed_name'];
						$data['incident_notify_via8']=$notify['incident_notify_via'];
						$data['incident_notify_date8']=date("m/d/y",strtotime($notify['incident_notify_date']));
						$data['incident_notify_time8']=$notify['incident_notify_time'];
					break;
				}
		}
		
		$pdfHtml="";
		$pdfHtml="<div class='alert alert-info text-center'>
					<h3>Incident Report</h3>
				 </div>
				   <div class='well'>
					<div class='col-xs-5'>
						<h4 class='magin0'>Agency Information</h4><br/>
						<p><b>Company:</b> ".$loggedUser->agency_company_name."</p>
						<p><b>Name:</b> ".ucwords($loggedUser->agency_first_name." ".$loggedUser->agency_last_name)."</p>
						<p><b>Address: </b>".ucwords($loggedUser->agency_address1.",".$loggedUser->agency_city.",".$loggedUser->agency_state.",".$loggedUser->agency_zip)."</p>
						<p><b>Contact: </b>".$loggedUser->agency_contact."</p>
					</div>
					<div class='col-xs-5'>
						<h4 class='magin0'>Individual Information</h4><br/>
						<p><b>Name:</b> ".ucwords($indData['agency_first_name']." ".$indData['agency_last_name'])."</p>
						<p><b>Address: </b>".ucwords($indData['agency_address1'].",".$indData['agency_city'].",".$indData['agency_state'].",".$indData['agency_zip'])."</p>
						<p><b>Contact: </b>".$indData['agency_contact']."</p>
					</div>
					<div class='clearfix'>&nbsp;</div>
				</div>
				  <div class='col-xs-12 well'>
         				<h3 style='margin-top:0px !important;'>Office Use Only</h3>
						 <div class='col-xs-12 padding0'>
						 	<label>Incident Tracking #</label><br/>
							".$data['incident_tracking_number']."
						 </div>
						 <div class='clearfix'></div>
						 <div class='col-xs-12'>".implode(",",unserialize($data['is_included_claims']))."</div>
						 <div class='clearfix'></div>
				  </div>
				  <div class='col-xs-12 form-container pdf-inline' style='padding:0px;'>
						<div style='background:#EAEAEA;padding:10px 15px;vertical-align:top;'>Basic Details</div>
						<div class='col-xs-3'>
							<label>Date of Incident</label><br/>
							".$data['incident_date']."
						</div>
						<div class='col-xs-3'>
							<label>Time of Incident</label><br/>
							".$data['incident_time']."
						</div>
						<div class='col-xs-3'>
							<label>Incident Location</label><br/>
							".$data['incident_location']."
						</div>
						<div class='clearfix'>&nbsp;</div>
				   </div> 
				  <div class='clearfix'>&nbsp;</div>
				  <div class='col-xs-12 form-container pdf-inline' style='padding:0px;'>
        		   		<div style='background:#EAEAEA;padding:10px 15px;vertical-align:top;'> Type Of Incident / Accident (Check all that apply)</div>
						<div class='col-xs-12'>
							".$incTypes."
					   </div>
				 </div>
           		 <div class='clearfix'>&nbsp;</div>
				 <div class='col-xs-12 form-container pdf-inline' style='padding:0px;'>
				    <div style='background:#EAEAEA;padding:10px 15px;vertical-align:top;'>Police Involvement</div>
					<div class='col-xs-3'>
						".$pinvolvement."
					</div>
					<div class='col-xs-3'>
						Department: ".$pdepartment."
					</div>
					<div class='clearfix'></div>
				 </div>
			     <div class='clearfix'>&nbsp;</div>
				 <div class='col-xs-12 form-container pdf-inline' style='padding:0px;'>
					<div style='background:#EAEAEA;padding:10px 15px;vertical-align:top;'>Nature Of Injury (If Any)</div>
					<div class='col-xs-12'>
						".$injuryNature."
					</div>
			     </div>
				 <div class='clearfix'>&nbsp;</div>
					<div style='background:#EAEAEA;padding:10px 15px;vertical-align:top;'>Location Of Injury (Check those that apply)</div>
					<div class='col-xs-12'>
						".$injuryLoc."
					</div>
					<div class='clearfix'>&nbsp;</div>
					<div style='background:#EAEAEA;padding:10px 15px;vertical-align:top;'>Injury Area</div>
					<div class='col-xs-12'>
						".$injuryArea."
					</div>
					<div class='clearfix'>&nbsp;</div>
					<div class='col-xs-12 well' style='padding:0px;'>
						<div class='clearfix'>&nbsp;</div>
            			<div class='col-xs-12' style='padding:0px;'>
						<div class='col-xs-3'>
							<label>Name(s) of P.P.I.(s)</label><br/>
							".isEmpty($data['names_of_ppi'])."
						</div>
						<div class='col-xs-6'>
							<label>Relationship to Individual</label><br/>
							".isEmpty($data['relation_to_individual'])."
						</div>
						<div class='clearfix'>&nbsp;</div>
					</div>
						<div class='col-xs-12' style='padding:0px;'>
						<div class='col-xs-3'>
							<label>Witness to Incident</label><br/>
							".isEmpty($data['witness_to_incident'])."
						</div>
						<div class='col-xs-3'>
							<label>Others Involved</label><br/>
							".isEmpty($data['other_involved'])."
						</div>
						<div class='clearfix'>&nbsp;</div>
					</div>
					</div>
					<div class='clearfix'>&nbsp;</div>
					<div style='background:#EAEAEA;padding:10px 15px;vertical-align:top;'>Details Of Incident</div>
						<div class='clearfix'>&nbsp;</div>
						<div class='col-xs-12'>
							<label>Before — Contributing Factors</label><br/>
							".isEmpty($data['incident_before_desc'])."
						</div>
						<div class='clearfix'>&nbsp;</div>
						<div class='col-xs-12'>
							<label>During- Description Of Incident (Who, What, When, Where)</label><br/>
							".isEmpty($data['incident_during_desc'])."
						</div>
						<div class='clearfix'>&nbsp;</div>
						<div class='col-xs-12'>
							<label>After- Immediate Action Taken to Ensure Health and Safety of Individual</label><br/>
							".isEmpty($data['incident_after_desc'])."
						</div>
					</div>
					<div class='clearfix'>&nbsp;</div>
           			<div style='background:#EAEAEA;padding:10px 15px;vertical-align:top;'>Notifications</div>
				    <table class='table table-bordered'>
					 	<tr>
							<th style='padding:0.5%; text-align:center;' width='20%'></th>
							<th style='padding:0.5%; text-align:center;' width='20%'>Printed Name</th>
							<th style='padding:0.5%; text-align:center;' width='20%'>Via</th>
							<th style='padding:0.5%; text-align:center;' width='20%'>Date</th>
							<th style='padding:0.5%; text-align:center;' width='20%'>Time</th>
						</tr>
						<tr>
							<td style='padding:0.5%; text-align:center;'>".$data['incident_recipient1']."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['recipient_printed_name1'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['incident_notify_via1'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['incident_notify_date1'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['incident_notify_time1'])."</td>
						</tr>
						<tr>
							<td style='padding:0.5%; text-align:center;'>".$data['incident_recipient2']."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['recipient_printed_name2'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['incident_notify_via2'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['incident_notify_date2'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['incident_notify_time2'])."</td>
						</tr>
						<tr>
							<td style='padding:0.5%; text-align:center;'>".$data['incident_recipient3']."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['recipient_printed_name3'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['incident_notify_via3'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['incident_notify_date3'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['incident_notify_time3'])."</td>
						</tr>
						<tr>
							<td style='padding:0.5%; text-align:center;'>".$data['incident_recipient4']."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['recipient_printed_name4'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['incident_notify_via4'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['incident_notify_date4'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['incident_notify_time4'])."</td>
						</tr>
					 </table>
					<div class='clearfix'>&nbsp;</div>
					<div style='background:#EAEAEA;padding:10px 15px;vertical-align:top;'>Person Completing Form</div>
					<table class='table table-bordered'>
					 	<tr>
							<th style='padding:0.5%; text-align:center;' width='25%'>Signature</th>
							<th style='padding:0.5%; text-align:center;' width='25%'>Printed Name</th>
							<th style='padding:0.5%; text-align:center;' width='25%'>Date</th>
							<th style='padding:0.5%; text-align:center;' width='25%'>Time</th>
						</tr>
						<tr>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['person_signature'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['person_printed_name'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['report_filling_date'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['report_filling_time'])."</td>
						</tr>
					 </table>
					<div class='clearfix'>&nbsp;</div>
        			<div style='background:#EAEAEA;padding:10px 15px;vertical-align:top;'> Office Use Only </div>
					<div class='clearfix'>&nbsp;</div>
					<div class='col-xs-12'>
						<label>Follow-Up – Medical, Modifications to Physical Environment</label><br/>
						 ".isEmpty($data['incident_followup'])."
					</div>
					<div class='clearfix'>&nbsp;</div>
					<div class='col-xs-12'>
						<label>Prevention – Actions to prevent Future Incidents</label><br/>
						 ".isEmpty($data['incident_prevention'])."
					</div>
					<div class='clearfix'>&nbsp;</div>
					<div class='col-xs-12'>
						<label>Administrative Action – Comments</label><br/>
						 ".isEmpty($data['incident_admin_actions'])."
					</div>
				</div>
					<div class='clearfix'>&nbsp;</div>
           			<div style='background:#EAEAEA;padding:10px 15px;vertical-align:top;'>Notifications</div>
				    	<table class='table table-bordered'>
					 	<tr>
							<th style='padding:0.5%; text-align:center;' width='20%'></th>
							<th style='padding:0.5%; text-align:center;' width='20%'>Printed Name</th>
							<th style='padding:0.5%; text-align:center;' width='20%'>Via</th>
							<th style='padding:0.5%; text-align:center;' width='20%'>Date</th>
							<th style='padding:0.5%; text-align:center;' width='20%'>Time</th>
						</tr>
						<tr>
							<td style='padding:0.5%; text-align:center;'>".$data['incident_recipient5']."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['recipient_printed_name5'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['incident_notify_via5'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['incident_notify_date5'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['incident_notify_time5'])."</td>
						</tr>
						<tr>
							<td style='padding:0.5%; text-align:center;'>".$data['incident_recipient6']."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['recipient_printed_name6'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['incident_notify_via6'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['incident_notify_date6'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['incident_notify_time6'])."</td>
						</tr>
						<tr>
							<td style='padding:0.5%; text-align:center;'>".$data['incident_recipient7']."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['recipient_printed_name7'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['incident_notify_via7'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['incident_notify_date7'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['incident_notify_time7'])."</td>
						</tr>
						<tr>
							<td style='padding:0.5%; text-align:center;'>".$data['incident_recipient8']."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['recipient_printed_name8'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['incident_notify_via8'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['incident_notify_date8'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['incident_notify_time8'])."</td>
						</tr>
					 </table>
					<div class='clearfix'>&nbsp;</div>
					<div style='background:#EAEAEA;padding:10px 15px;vertical-align:top;'>Incident Reviewed</div>
				    <table class='table table-bordered'>

					 	<tr>
							<th style='padding:0.5%; text-align:center;' width='25%'>Signature</th>
							<th style='padding:0.5%; text-align:center;' width='25%'>Printed Name</th>
							<th style='padding:0.5%; text-align:center;' width='25%'>Date</th>
							<th style='padding:0.5%; text-align:center;' width='25%'>Time</th>
						</tr>
						<tr>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['reviewer_signature'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['reviewer_printed_name'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['reviewer_date'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['reviewer_time'])."</td>
						</tr>
					 </table>
					<div class='clearfix'>&nbsp;</div>
				    <div style='background:#EAEAEA;padding:10px 15px;vertical-align:top;'>Report Sent</div>
				  	 <table class='table table-bordered'>
					 	<tr>
							<th style='padding:0.5%; text-align:center;' width='20%'>MUI Unit</th>
							<th style='padding:0.5%; text-align:center;' width='20%'>Sender Name</th>
							<th style='padding:0.5%; text-align:center;' width='20%'>Via</th>
							<th style='padding:0.5%; text-align:center;' width='20%'>Date</th>
							<th style='padding:0.5%; text-align:center;' width='20%'>Time</th>
						</tr>
						<tr>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['mui_unit'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['report_sender_name'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['report_sent_via'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['report_sent_date'])."</td>
							<td style='padding:0.5%; text-align:center;'>".isEmpty($data['report_sent_time'])."</td>
						</tr>
					 </table>
					<div class='clearfix'>&nbsp;</div>
				 </div>
				";
		require_once ROOT_PATH.'/private/mpdf/mpdf.php';
		$mpdf=new mPDF('utf-8', 'A4-L');
		$stylesheet = file_get_contents(APPLICATION_URL.'/public/plugins/bootstrap/css/bootstrap.min.css');
		$stylesheet1 = file_get_contents(APPLICATION_URL.'/public/front_css/style_custom.css');
		$mpdf->SetTitle($this->view->site_configs['site_name']." | ".ucwords($indData['agency_first_name']." ".$indData['agency_last_name'])." Incident Report");
		$res=$mpdf->WriteHTML($stylesheet,1);
		$mpdf->WriteHTML($pdfHtml,2);
		$mpdf->WriteHTML($html);
		$res=$mpdf->Output();
		exit();
	}
	
	public function incidentemailformAction(){
		global $healthSesion;
		$indid=$_REQUEST['indid'];
		$formid=$_REQUEST['formid'];
		$incid=$_REQUEST['incidentid'];
		$form=new Application_Form_CustomForms();
		$form->incidentEmail($indid,$formid,$incid);
		echo "Send Incident Report"."~~".$form;
		exit();
	}
	
	public function sendincidentemailAction(){
		global $healthSession;
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$incid=$this->_getParam("incid");
		$form=new Application_Form_CustomForms();
		$form->incidentEmail($indid,$formid,$incid);
		if($this->getRequest()->isPost()){
			$posted_data = $this->getRequest()->getPost();
   			if($form->isValid($posted_data)){ 
				$incidentData=$this->SuperModel->Super_Get("_uhs_incidents_reports","incident_id=".$incid,"fetch");
			    $agency_email=$this->view->user->agency_email; //19-feb-2018
				$incidentData['receiver_emails']=$posted_data['receiver_emails'];
				$incidentData['email_subject']=$posted_data['email_subject'];
				$incidentData['email_msg']=$posted_data['email_msg'];
				$incidentData['agency_email'] = $agency_email;//19-feb-2018
				$isSend=$this->modelEmail->sendIncidentReport($incidentData);
				if($isSend->success){
					$indData=$this->SuperModel->Super_Get("_uhs_incidents_reports","incident_id=".$incid." and is_report_completed='1'");
					if(empty($indData)){
						$updateArr=array("is_report_completed"=>'1');
						$isupdated=$this->SuperModel->Super_Insert("_uhs_incidents_reports",$updateArr,"incident_id=".$incid);
					}
					
					//Start code added by amit on 07-may-2018 with save send email info
                                        if(!empty($posted_data['receiver_emails'])){
                                            $receiver_emails= $posted_data['receiver_emails'];
                                            $receiver_emails= explode(",", $receiver_emails);
                                            $msg_group_code=getRandomString(6);
                                            foreach ($receiver_emails as $key => $receiver_email) {
                                                $receiver_email = trim($receiver_email);
                                                $agencyData=$this->SuperModel->Super_Get("_uhs_agency","agency_email='".$receiver_email."'","fetch");
                                                if(!empty($agencyData)){
                                                    $msg_receiver_id="";
                                                    $msg_receiver_id = $agencyData['agency_id'];
                                                    $posted_data_msg['msg_sender_id']=$this->view->user->subuser_id;
                                                    $posted_data_msg['msg_send_date']=date('Y-m-d H:i:s');
                                                    $posted_data_msg['msg_receiver_id']=$msg_receiver_id;
                                                    $posted_data_msg['msg_group_code'] = $msg_group_code;
                                                    $posted_data_msg['msg_subject'] = $posted_data['email_subject'];
                                                    $posted_data_msg['msg_text'] = $posted_data['email_msg'];
                                                    $isInserted = $this->SuperModel->Super_Insert("_uhs_messages",$posted_data_msg);
                                                    if($isInserted->success){
                                                         $healthSession->successMsg="Message has been sent successfully.";
                                                    }else{
                                                           $healthSession->errorMsg  = $isInserted->message;
                                                    }
                                                }
                                            }
                                        }
					$healthSession->successMsg  = "Incident report has been sent successfully.";
				}
				else{
					$healthSession->errorMsg = " Please check information again.";
				}
   			}else{
				$healthSession->errorMsg = " Please check information again.";
 			}
		 }
		 $this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_incident_reports");
	}	
	
	public function removeincidentAction(){
		global $healthSession;
		$indid=$this->_getParam('indid');
		$formid=$this->_getParam('formid');
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		if($permissions=="View Only"){
			$healthSession->errorMsg="You don't have permission to access this page.";
			$this->_helper->getHelper('Redirector')->gotoRoute(array('indid'=>$indid,'formid'=>$formid),"front_incident_reports");
		}
 		$this->_helper->layout->disableLayout();
		$this->_helper->viewRenderer->setNoRender(true);
		$formData = $this->getRequest()->getPost();
		if(isset($formData['records']) && count($formData['records'])) {
			foreach($formData['records'] as $key=>$values){
  				$isAdd=$this->SuperModel->Super_Delete('_uhs_incidents_reports',"incident_id=".$values);
 				$healthSession->successMsg="Incident Report(s) has been deleted successfully.";
			}
		}
		else{
			$healthSession->errorMsg = "Invalid Request.";
		}
 		$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_incident_reports");
	} 	
	
	//Documentation of Homemaker Personal Care Form	
	public function personalcareAction(){
		global $healthSession,$systemusers; 
  		
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		if(empty($indid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		$this->view->permissions=$permissions;
		$this->view->indid=$indid;
		$this->view->formid=$formid;
		$this->view->id=$id;
                if($formid == 2){
                    $this->view->pageHeading = "Documentation of Homemaker Personal Care";
                    $this->view->type="Care";
                }elseif($formid == 27){
                    $this->view->pageHeading = "Documentation of Adult Day Support";
                    $this->view->type="Ads";
                }
                if($this->view->user->agency_user_type == "Agency") {
                    $agencyid=$this->view->user->agency_id;
                    $ratioview_data = $this->SuperModel->Super_Get("_uhs_ratio_view", "ratio_agency_id='".$agencyid."' AND ratio_indid='".$indid."' AND ratio_form_id='".$formid."' ", "fetch");
                    if(!empty($ratioview_data)){
                        $this->view->ratio_status = $ratioview_data['ratio_status'];
                        $this->view->ratio_id = $ratioview_data['ratio_id'];
                    }else {
                        $this->view->ratio_status = 0;
                        $this->view->ratio_id = 0;
                     }
               } elseif(in_array($this->view->user->agency_user_type,$systemusers)) {
                       $agencyid=$this->view->user->agency_user_agency_id;
                       $ratioview_data = $this->SuperModel->Super_Get("_uhs_ratio_view", "ratio_agency_id='".$agencyid."' AND ratio_indid='".$indid."' AND ratio_form_id='".$formid."' ", "fetch");
                       if(!empty($ratioview_data)){
                          $this->view->ratio_status = $ratioview_data['ratio_status'];
                       } else {
                        $this->view->ratio_status = 0;
                       }
               }
                if($this->view->user->agency_user_type == "Agency") {
                    $agencyid=$this->view->user->agency_id;
                    $ratioview_data = $this->SuperModel->Super_Get("_uhs_ratio_view", "ratio_agency_id='".$agencyid."' AND ratio_indid='".$indid."' AND ratio_form_id='".$formid."' ", "fetch");
                    if(!empty($ratioview_data)){
                        $this->view->ratio_status = $ratioview_data['ratio_status'];
                        $this->view->ratio_id = $ratioview_data['ratio_id'];
                    }else {
                        $this->view->ratio_status = 0;
                        $this->view->ratio_id = 0;
                    }
                } elseif(in_array($this->view->user->agency_user_type,$systemusers)) {
                    $agencyid=$this->view->user->agency_user_agency_id;
                    $ratioview_data = $this->SuperModel->Super_Get("_uhs_ratio_view", "ratio_agency_id='".$agencyid."' AND ratio_indid='".$indid."' AND ratio_form_id='".$formid."' ", "fetch");
                    if(!empty($ratioview_data)){
                       $this->view->ratio_status = $ratioview_data['ratio_status'];
                    } else {
                     $this->view->ratio_status = 0;
                    }
                }
               $this->view->agency_user_type=$this->view->user->agency_user_type;
                
	}
	
	//PRN Form
	public function prnrecordsAction(){
		global $healthSession; 
  		$this->view->pageHeading = "PRN Medication Administration Record";
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		if(empty($indid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		$this->view->permissions=$permissions;
		$this->view->indid=$indid;
		$this->view->formid=$formid;
		$this->view->id=$id;
		$this->view->type="MAR";
	}
	
	//Cleaning Form
	public function cleaningrecordsAction(){ 
		global $healthSession; 
  		$this->view->pageHeading = "CLEANING CHART";
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		if(empty($indid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		$this->view->permissions=$permissions;
		$this->view->indid=$indid;
		$this->view->formid=$formid;
		$this->view->id=$id;
		$this->view->type="Cleaning";
	}
	
	// Diffrent Task Forms 	
	public function addtasksAction(){
		global $healthSession; 
		$type=$this->_getParam("type");
              
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
                
                if($type=="Care"){
                    if($formid==2){
                       $type = "Care";
                    }elseif($formid==27) {
                       $type = "Ads";
                    }
                } 
		if(isFormAssigned($formid,$indid)){
			$healthSession->errorMsg="Please assign form to individual first.";
			if($type=="Care"){
				$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_personal_care");
			}
			if($type=="Ads"){
				$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_personal_care");
			}
			if($type=="MAR"){
				$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_prn_record");
			}
			if($type=="Cleaning"){
				$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_cleaning_record");
			}
		}
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		if($permissions=="View Only"){
			$healthSession->errorMsg="You don't have permission to access this page.";
			if($type=="Care"){
				$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_personal_care");
			}
			if($type=="Ads"){
				$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_personal_care");
			}
			if($type=="MAR"){
				$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_prn_record");
			}
			if($type=="Cleaning"){
				$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_cleaning_record");
			}
		}
		if(empty($indid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		switch($type){
			case "Care":
  				$this->view->pageHeading = "Documentation of Homemaker Personal Care";
				break;
			case "Ads":
  				$this->view->pageHeading = "Documentation of Adult Day Support";
				break;
			case "MAR":
				$this->view->pageHeading = "PRN - Medication Administration Record";
				break;
			case "Cleaning":
				$this->view->pageHeading = "Cleaning Chart";
				break;
		}
		$this->view->indid=$indid;
		$this->view->formid=$formid;
		$this->view->type=$type;
	}

	public function addtasksformAction() {
        $form = new Application_Form_CustomForms();
        $form->supports();
        $indid = $this->_getParam("indid");
        $formid = $this->_getParam("formid");
        $type = $this->_getParam("type");
        if($type=="Care"){
            if($formid==2){
               $type = "Care";
            }elseif($formid==27) {
               $type = "Ads";
            }
        } 
        $this->view->indid = $indid;
        $this->view->formid = $formid;
        $this->view->form = $form;
        $this->view->type = $type;
        
    }
    
    public function edittasksformAction() {
        $form = new Application_Form_CustomForms();
        $form->supports();
        $indid = $this->_getParam("indid");
        $formid = $this->_getParam("formid");
        $supportid = $this->_getParam("supportid");
        $type = $this->_getParam("type");
        if($type=="Care"){
            if($formid==2){
               $type = "Care";
            }elseif($formid==27) {
               $type = "Ads";
            }
        } 
        
        $task_data = $this->SuperModel->Super_Get('_uhs_supports', "support_id=$supportid", 'fetch');
        
        $shift_data = $task_data['support_shift'];
        $shift_data = json_decode($shift_data);
        
        $shift = 0;
        $shift_name = 'support_shift';
        foreach ($shift_data as $raw_shift_data) {
            if(empty($raw_shift_data)) {
                $shift == 0 ? $task_data['shift_check'][$shift_name] = 'not' : $task_data['shift_check'][$shift_name.$shift] = 'not';
            }
            else {
                $shift == 0 ? $task_data['shift_check'][$shift_name] = 'checked' : $task_data['shift_check'][$shift_name.$shift] = 'checked';
            }
            $shift++;
        }
        
        $this->view->indid = $indid;
        $this->view->formid = $formid;
        $this->view->supportid = $supportid;
        $this->view->form = $form;
        $this->view->type = $type;
        
        $this->view->task_data = $task_data;
    }
	
	public function gettasksAction(){
		if(check_is_ajax($this->_request)){
			$this->_redirect(APPLICATION_URL);
		}
		$type=$this->_getParam('type');
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		$subuser=$dstarts=$dends="";
		if(isset($_REQUEST['subuser']) && !empty($_REQUEST['subuser'])){
			$subuser=$_REQUEST['subuser'];
		}
		if(isset($_REQUEST['dstarts']) && !empty($_REQUEST['dstarts'])){
			$dstarts=$_REQUEST['dstarts'];
		}
		if(isset($_REQUEST['dends']) && !empty($_REQUEST['dends'])){
			$dends=$_REQUEST['dends'];
		}
		if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
			$month=$_REQUEST['month'];
		}
		if(isset($_REQUEST['year']) && !empty($_REQUEST['year'])){
			$year=$_REQUEST['year'];
		}
 		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('task_id','task_form_id','task_agency_id','task_individual_id','task_added_user','task_support_id','is_task_done','task_comments','task_added_date','task_type','task_results','is_task_entry_completed','task_total_service_time','task_start_time','task_end_time','task_modified_by','task_modified_on','task_staff_no','task_individual_no');
		$sIndexColumn = 'task_id';
		$sTable = '_uhs_task_entries';
		$sLimit = "";
		if(isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength']!='-1'){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		if ( isset( $_GET['iSortCol_0'] ) ){
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
			{
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
				{
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
		if(empty($subuser)){
			$indParentUsers="";
			if($this->view->user->agency_user_type=="Agency"){
				$systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_id,"fetchAll",array("fields"=>"agency_id"));
				$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
				$indParentUsers=implode_r(",",$systemUsers);
			}
			else{
				$systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_user_agency_id,"fetchAll",array("fields"=>"agency_id"));
				$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
				$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_user_agency_id;
				$indParentUsers=implode_r(",",$systemUsers);
				//$indParentUsers=$this->view->user->agency_id.",".$this->view->user->agency_user_agency_id;
			}
			if($sWhere){
				$sWhere.=" and task_added_user IN(".$indParentUsers.") and task_individual_id='".$indid."' and task_type='".$type."'"; 
			}
			else{
				$sWhere.=" where task_added_user IN(".$indParentUsers.") and task_individual_id='".$indid."' and task_type='".$type."'"; 
			}
		}
		else{
			if($sWhere){
				$sWhere.=" and task_added_user IN(".$subuser.") and task_individual_id='".$indid."' and task_type='".$type."'"; 
			}
			else{
				$sWhere.=" where task_added_user IN(".$subuser.") and task_individual_id='".$indid."' and task_type='".$type."'"; 
			}
		}
		if(!empty($dstarts)){
			$sWhere.=" and DATE(task_added_date) >='".$dstarts."'";
		}
		if(!empty($dends)){
			$sWhere.=" and DATE(task_added_date) <='".$dends."'";
		}
		if(!empty($month)){
			$sWhere.=" and MONTH(task_added_date)='".$month."'";
		}
		if(!empty($year)){
			$sWhere.=" and YEAR(task_added_date)='".$year."'";
		}
		if(!empty($id) && $id!=0){
			$sWhere.=" and task_id=".$id;
		}
		if(empty($month) && empty($year)){
                    if(!empty($sWhere)){
                        $sWhere.=" and MONTH(task_added_date)=MONTH(CURDATE()) and YEAR(task_added_date)=YEAR(CURDATE())";
                    }else{
                        $sWhere.=" where MONTH(task_added_date)=MONTH(CURDATE()) and YEAR(task_added_date)=YEAR(CURDATE())";
                    }
                }
		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
 		$qry = $this->dbObj->query($sQuery)->fetchAll();
		$sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
		$output = array(
 				"iTotalRecords" => $iTotal,
				"iTotalDisplayRecords" => $iFilteredTotal,
				"aaData" => array()
			);
		$j=0;
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		foreach($qry as $row1){
			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['task_added_user']."'","fetch");
			$suportData=$this->SuperModel->Super_Get("_uhs_supports","support_id=".$row1['task_support_id'],"fetch");
			$modifierData=array();
			if($row1['task_modified_by']!=0){
				$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['task_modified_by']."'","fetch");
			}
			$taskStatus="";
			if($row1['is_task_entry_completed']=='0'){ $taskStatus="<br/><span class='badge badge-danger'>Not Completed</span>";}
			$row=array();
 			$row[] = $j+1;
			$row[]='<input class="elem_ids checkboxes" type="checkbox" name="records['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';
		    $row[]=$suportData['support_description'].$taskStatus;
			if($suportData['support_frequency']=="Other"){ 
				$row[]=ucwords($suportData['support_frequency']."-".$suportData['support_other_frequency']); 
			}
			else{
				$row[]=ucwords($suportData['support_frequency']);
			}
			if($formid==2){
				$row[]=isEmpty($row1['task_start_time'],"-");
				$row[]=isEmpty($row1['task_end_time'],"-");
				$row[]=isEmpty($row1['task_total_service_time'],'-');
			}
			$bclass="";
			if($row1['is_task_done']=="Yes"){ $bclass="badge-success";}else{ $bclass="badge-danger";}
			$row[]="<span class='badges badge ".$bclass."'>".ucwords($row1['is_task_done'])."</span>";
			$row[]=isEmpty($row1['task_comments']);
			if($type=="MAR"){
				$row[]=isEmpty($row1['task_results']);
			}
			$userType=printUserType($creatorData); 
			$row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
			$row[]=formatDateTimeNew($row1['task_added_date'])."<span style='display:none;'>".$row1['task_added_date']."</span>"; 
			
			$shift_data = json_decode($suportData['support_shift']);
			$shift="";
			foreach($shift_data as $sh_data){
				if($sh_data){
					$shift.= $sh_data.', ';
				}
			}
			if($formid==2){
                            $row[]=rtrim($shift,',');
                            $row[]=$row1['task_staff_no']." : ".$row1['task_individual_no'];
                        }
			if(!empty($modifierData)){
				$userType=printUserType($modifierData);
				$row[]=ucwords($modifierData['agency_first_name']." ".$modifierData['agency_last_name'])."&nbsp;".$userType;
				$row[]=formatDateTime($row1['task_modified_on']);
			}else{
				$row[]="-";
				$row[]="-";
			}
			$rtype='"'.$type.'"';
			$supportname='"'.trim(preg_replace('/\s\s[^a-zA-Z0-9]+/', ' ',str_replace("'",'',$suportData['support_description']))).'"';
			if($this->view->user->agency_user_type=="Agency"){
				$row[]="<a href='javascript:void(1);' style='margin-top:5px;' class='btn btn-xs btn-default' onClick='recordTodayTask(".$indid.",".$formid.",".$row1['task_support_id'].",".$row1['task_id'].",".$rtype.",".$supportname.",1);'>Edit </a>";
			}
			else{
				$row[]="<b>NA</b>";
			}
 			$output['aaData'][] = $row;
			$j++;
		}
		echo json_encode($output);
		exit();
	}
        
        
        public function gettasksndchartAction(){
                global $systemusers;
		if(check_is_ajax($this->_request)){
			$this->_redirect(APPLICATION_URL);
		}
		$type=$this->_getParam('type');
                
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
                
                if($this->view->user->agency_user_type=="Agency"){
                    $ratioview_status=0;
                    $agencyid=$this->view->user->agency_id;
                    $ratioview_data = $this->SuperModel->Super_Get("_uhs_ratio_view", "ratio_agency_id='".$agencyid."' AND ratio_indid='".$indid."' AND ratio_form_id='".$formid."' ", "fetch");
                    if(!empty($ratioview_data) && !empty($ratioview_data['ratio_status'])){
                            $ratioview_status=$ratioview_data['ratio_status'];
                    }
                }elseif(in_array($this->view->user->agency_user_type,$systemusers)) {
                    $ratioview_status=0;
                    $agencyid=$this->view->user->agency_user_agency_id;
                    $ratioview_data = $this->SuperModel->Super_Get("_uhs_ratio_view", "ratio_agency_id='".$agencyid."' AND ratio_indid='".$indid."' AND ratio_form_id='".$formid."' ", "fetch");
                    if(!empty($ratioview_data) && !empty($ratioview_data['ratio_status'])){
                            $ratioview_status=$ratioview_data['ratio_status'];
                    } 
                }
		$subuser=$dstarts=$dends="";
		if(isset($_REQUEST['subuser']) && !empty($_REQUEST['subuser'])){
			$subuser=$_REQUEST['subuser'];
		}
		if(isset($_REQUEST['dstarts']) && !empty($_REQUEST['dstarts'])){
			$dstarts=$_REQUEST['dstarts'];
		}
		if(isset($_REQUEST['dends']) && !empty($_REQUEST['dends'])){
			$dends=$_REQUEST['dends'];
		}
		if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
			$month=$_REQUEST['month'];
		}
		if(isset($_REQUEST['year']) && !empty($_REQUEST['year'])){
			$year=$_REQUEST['year'];
		}
 		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('task_id','shift','task_form_id','task_agency_id','task_individual_id','task_added_user','task_support_id','is_task_done','task_comments','task_added_date','task_type','task_results','is_task_entry_completed','task_total_service_time','task_start_time','task_end_time','task_modified_by','task_modified_on','task_staff_no','task_individual_no');
		$sIndexColumn = 'task_id';
		$sTable = '_uhs_task_entries';
		$sLimit = "";
		if(isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength']!='-1'){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		if ( isset( $_GET['iSortCol_0'] ) ){
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
			{
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
				{
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
		if(empty($subuser)){
			$indParentUsers="";
			if($this->view->user->agency_user_type=="Agency"){
				$systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_id,"fetchAll",array("fields"=>"agency_id"));
				$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
				$indParentUsers=implode_r(",",$systemUsers);
			}
			else{
				$systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_user_agency_id,"fetchAll",array("fields"=>"agency_id"));
				$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
				$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_user_agency_id;
				$indParentUsers=implode_r(",",$systemUsers);
				//$indParentUsers=$this->view->user->agency_id.",".$this->view->user->agency_user_agency_id;
			}
			if($sWhere){
				$sWhere.=" and task_added_user IN(".$indParentUsers.") and task_individual_id='".$indid."' and task_type='".$type."'"; 
			}
			else{
				$sWhere.=" where task_added_user IN(".$indParentUsers.") and task_individual_id='".$indid."' and task_type='".$type."'"; 
			}
		}
		else{
			if($sWhere){
				$sWhere.=" and task_added_user IN(".$subuser.") and task_individual_id='".$indid."' and task_type='".$type."'"; 
			}
			else{
				$sWhere.=" where task_added_user IN(".$subuser.") and task_individual_id='".$indid."' and task_type='".$type."'"; 
			}
		}
		if(!empty($dstarts)){
			$sWhere.=" and DATE(task_added_date) >='".$dstarts."'";
		}
		if(!empty($dends)){
			$sWhere.=" and DATE(task_added_date) <='".$dends."'";
		}
		if(!empty($month)){
			$sWhere.=" and MONTH(task_added_date)='".$month."'";
		}
		if(!empty($year)){
			$sWhere.=" and YEAR(task_added_date)='".$year."'";
		}
		if(!empty($id) && $id!=0){
			$sWhere.=" and task_id=".$id;
		}
		if(empty($month) && empty($year)){
                    if(!empty($sWhere)){
                        $sWhere.=" and MONTH(task_added_date)=MONTH(CURDATE()) and YEAR(task_added_date)=YEAR(CURDATE())";
                    }else{
                        $sWhere.=" where MONTH(task_added_date)=MONTH(CURDATE()) and YEAR(task_added_date)=YEAR(CURDATE())";
                    }
                }
		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
 		$qry = $this->dbObj->query($sQuery)->fetchAll();
		$sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
		$output = array(
 				"iTotalRecords" => $iTotal,
				"iTotalDisplayRecords" => $iFilteredTotal,
				"aaData" => array()
			);
		$j=0;
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		foreach($qry as $row1){
			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['task_added_user']."'","fetch");
			$suportData=$this->SuperModel->Super_Get("_uhs_supports","support_id=".$row1['task_support_id'],"fetch");
			$modifierData=array();
			if($row1['task_modified_by']!=0){
				$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['task_modified_by']."'","fetch");
			}
			$taskStatus="";
			if($row1['is_task_entry_completed']=='0'){ $taskStatus="<br/><span class='badge badge-danger'>Not Completed</span>";}
			$row=array();
 			$row[] = $j+1;
			$row[]='<input class="elem_ids checkboxes" type="checkbox" name="_uhs_task_entries['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';
		
                        
		    $row[]=$suportData['support_description'].$taskStatus;
			if($suportData['support_frequency']=="Other"){ 
				$row[]=ucwords($suportData['support_frequency']."-".$suportData['support_other_frequency']); 
			}
			else{
				$row[]=ucwords($suportData['support_frequency']);
			}
                        
                        if($this->view->user->agency_user_type=="Agency" || (in_array($this->view->user->agency_user_type,$systemusers))){
                            if(!empty($ratioview_status)){
                                if($formid==2){
                                    $row[]=isEmpty($row1['task_start_time'],"-");
                                    $row[]=isEmpty($row1['task_end_time'],"-");
                                    $row[]=isEmpty($row1['task_total_service_time'],'-');
                                }
                                if($formid==27){
                                    $row[]=isEmpty($row1['task_start_time'],"-");
                                    $row[]=isEmpty($row1['task_end_time'],"-");
                                    $row[]=isEmpty($row1['task_total_service_time'],'-');
                                }
                            }
                        }
			
			$bclass="";
			if($row1['is_task_done']=="Yes" || $row1['is_task_done']=="Administered" || $row1['is_task_done']=="+"){ 
                            $bclass="badge-success";
                        }
                        else{
                            $bclass="badge-danger";
                        }
                        if($row1['is_task_done']=="Yes"){
                                $is_task_done_val = "Completed";
                        } else if($row1['is_task_done']=="No"){
                                $is_task_done_val = "Not Completed";
                        } else{
                            $is_task_done_val = $row1['is_task_done'];
                        }
                        
			$row[]="<span class='badges badge ".$bclass."'>".ucwords($is_task_done_val)."</span>";
			$row[]=isEmpty($row1['task_comments']);
			if($type=="MAR"){
				$row[]=isEmpty($row1['task_results']);
			}
			$userType=printUserType($creatorData); 
			$row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
			//$row[]=formatDateTimeNew($row1['task_added_date'])."<span style='display:none;'>".$row1['task_added_date']."</span>"; 
			$row[]=formatDate(date('Y-m-d', strtotime($row1['task_added_date'])));
			
                        if($formid==27){
                            $row[]=date('H:i a', strtotime($row1['task_added_date']));
                        } else {
                            $row[]=date('H:i:s', strtotime($row1['task_added_date']));
                        }
			$row[]=$row1['shift'];
                        if($this->view->user->agency_user_type=="Agency" || (in_array($this->view->user->agency_user_type,$systemusers))){
                            if(!empty($ratioview_status)){
                                $row[]="Staff"." ".$row1['task_staff_no']." :  Individual ".$row1['task_individual_no'];
                            }
                        }
			
			
			if(!empty($modifierData)){
				$userType=printUserType($modifierData);
				$row[]=ucwords($modifierData['agency_first_name']." ".$modifierData['agency_last_name'])."&nbsp;".$userType;
				$row[]=formatDateTime($row1['task_modified_on']);
			}else{
				$row[]="-";
				$row[]="-";
			}
			$rtype='"'.$type.'"';
			$supportname='"'.trim(preg_replace('/\s\s[^a-zA-Z0-9]+/', ' ',str_replace("'",'',$suportData['support_description']))).'"';
			if($this->view->user->agency_user_type=="Agency"){
				$row[]="<a href='javascript:void(1);' style='margin-top:5px;' class='btn btn-xs btn-default' onClick='recordTodayTask(".$indid.",".$formid.",".$row1['task_support_id'].",".$row1['task_id'].",".$rtype.",".$supportname.");'>Edit </a>";
			}
			else{
				$row[]="<b>NA</b>";
			}
                        $row[]=$row1['task_added_date'];
 			$output['aaData'][] = $row;
			$j++;
		}
                
                
               
                
                ///////////////////////////////////////////////////  BY amit
                
                
                
                $type=$this->_getParam('type');
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		$subuser=$dstarts=$dends="";
		if(isset($_REQUEST['subuser']) && !empty($_REQUEST['subuser'])){
			$subuser=$_REQUEST['subuser'];
		}
		if(isset($_REQUEST['dstarts']) && !empty($_REQUEST['dstarts'])){
			$dstarts=$_REQUEST['dstarts'];
		}
		if(isset($_REQUEST['dends']) && !empty($_REQUEST['dends'])){
			$dends=$_REQUEST['dends'];
		}
		if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
			$month=$_REQUEST['month'];
		}
		if(isset($_REQUEST['year']) && !empty($_REQUEST['year'])){
			$year=$_REQUEST['year'];
		}
 		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('usc_id','support_id','shift','comment','shift_option','is_amended','indid','formid','start_time','end_time','total_units','staff_ration','individual_ration','added_by','created_at','modified_by','modified_on');
		$sIndexColumn = 'usc_id';
		$sTable = '_uhs_supports_charting';
		$sLimit = "";
		if(isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength']!='-1'){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		if ( isset( $_GET['iSortCol_0'] ) ){
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
			{
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
				{
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
		if(empty($subuser)){
			$indParentUsers="";
			if($this->view->user->agency_user_type=="Agency"){
				$systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_id,"fetchAll",array("fields"=>"agency_id"));
				$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
				$indParentUsers=implode_r(",",$systemUsers);
			}
			else{
				$systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_user_agency_id,"fetchAll",array("fields"=>"agency_id"));
				$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
				$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_user_agency_id;
				$indParentUsers=implode_r(",",$systemUsers);
				//$indParentUsers=$this->view->user->agency_id.",".$this->view->user->agency_user_agency_id;
			}
			if($sWhere){
				$sWhere.=" and added_by IN(".$indParentUsers.") and indid='".$indid."' and formid='".$formid."'"; 
			}
			else{
				$sWhere.=" where added_by IN(".$indParentUsers.") and indid='".$indid."' and formid='".$formid."'"; 
			}
		}
		else{
			if($sWhere){
				$sWhere.=" and added_by IN(".$subuser.") and indid='".$indid."' and formid='".$formid."'"; 
			}
			else{
				$sWhere.=" where added_by IN(".$subuser.") and indid='".$indid."' and formid='".$formid."'"; 
			}
		}
		if(!empty($dstarts)){
			$sWhere.=" and DATE(created_at) >='".$dstarts."'";
		}
		if(!empty($dends)){
			$sWhere.=" and DATE(created_at) <='".$dends."'";
		}
		if(!empty($month)){
			$sWhere.=" and MONTH(created_at)='".$month."'";
		}
		if(!empty($year)){
			$sWhere.=" and YEAR(created_at)='".$year."'";
		}
		if(!empty($id) && $id!=0){
			$sWhere.=" and task_id=".$id;
		}
		if(empty($month) && empty($year)){
                    if(!empty($sWhere)){
                        $sWhere.=" and MONTH(created_at)=MONTH(CURDATE()) and YEAR(created_at)=YEAR(CURDATE())";
                    }else{
                        $sWhere.=" where MONTH(created_at)=MONTH(CURDATE()) and YEAR(created_at)=YEAR(CURDATE())";
                    }
                }
		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
 		$qry = $this->dbObj->query($sQuery)->fetchAll();
		$sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
//		$output = array(
// 				"iTotalRecords" => $iTotal,
//				"iTotalDisplayRecords" => $iFilteredTotal,
//				"aaData" => array()
//			);
                
                
                
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		foreach($qry as $row1){
			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['added_by']."'","fetch");
			$suportData=$this->SuperModel->Super_Get("_uhs_supports","support_id=".$row1['support_id'],"fetch");
			$modifierData=array();
			if($row1['modified_by']!=0){
				$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['modified_by']."'","fetch");
			}
			$taskStatus="";
			//if($row1['is_task_entry_completed']=='0'){ $taskStatus="<br/><span class='badge badge-danger'>Not Completed</span>";}
			$row=array();
 			$row[] = $j+1;
			$row[]='<input class="elem_ids checkboxes" type="checkbox" name="_uhs_supports_charting['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';
			
                        
		    $row[]=$suportData['support_description'].$taskStatus;
			if($suportData['support_frequency']=="Other"){ 
				$row[]=ucwords($suportData['support_frequency']."-".$suportData['support_other_frequency']); 
			}
			else{
				$row[]=ucwords($suportData['support_frequency']);
			}
                        if($this->view->user->agency_user_type=="Agency" || (in_array($this->view->user->agency_user_type,$systemusers))){
                            if(!empty($ratioview_status)){
                                if($formid==2){
                                    $row[]=isEmpty($row1['start_time'],"-");
                                    $row[]=isEmpty($row1['end_time'],"-");
                                    $row[]=isEmpty($row1['total_units'],'-');
                                }
                                if($formid==27){
                                    $row[]=isEmpty($row1['start_time'],"-");
                                    $row[]=isEmpty($row1['end_time'],"-");
                                    $row[]=isEmpty($row1['total_units'],'-');
                                }
                            }
                        }
			
			$bclass="";
			
                        if($row1['shift_option']=="C" || $row1['shift_option']=="A" || $row1['shift_option']=="+"){ 
                            $bclass="badge-success";
                        }
                        else{
                            $bclass="badge-danger";
                        }
                        if($row1['shift_option']=="C"){
                                $shift_option_val = "Completed";
                        } else if($row1['shift_option']=="NC"){
                                $shift_option_val = "Not Completed";
                        }
                        else if($row1['shift_option']=="A"){
                                $shift_option_val = "Administered";
                        }
                         else if($row1['shift_option']=="NA"){
                                $shift_option_val = "Not Administered";
                        }
                        else if($row1['shift_option']=="R"){
                                $shift_option_val = "Refuse";
                        }
                        else{
                            $shift_option_val = $row1['shift_option'];
                        }
                        $is_amended="";
                        if($row1['is_amended'] == 1){
                            $is_amended="Amended";
                        }
                        $row[]="<span class='badges badge ".$bclass."'>".ucwords($shift_option_val)."</span><BR>$is_amended";
			$row[]=isEmpty($row1['comment']);
			if($type=="MAR"){
				$row[]=isEmpty($row1['task_results']);
			}
			$userType=printUserType($creatorData); 
			$row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
			//$row[]=formatDateTimeNew($row1['created_at'])."<span style='display:none;'>".$row1['created_at']."</span>"; 
			$row[]=formatDate(date('Y-m-d', strtotime($row1['created_at'])));
			
                        
                        if($formid==27){
                            $row[]=date('H:i a', strtotime($row1['created_at']));
                        } else {
                            $row[]=date('H:i:s', strtotime($row1['created_at']));
                        }
			$row[]=$row1['shift'];
                        if($this->view->user->agency_user_type=="Agency" || (in_array($this->view->user->agency_user_type,$systemusers))){
                            if(!empty($ratioview_status)){
                                $row[]="Staff ".$row1['staff_ration']." :  Individual ".$row1['individual_ration'];
                            }
                        }
			
			
			if(!empty($modifierData)){
				$userType=printUserType($modifierData);
				$row[]=ucwords($modifierData['agency_first_name']." ".$modifierData['agency_last_name'])."&nbsp;".$userType;
				$row[]=formatDateTime($row1['modified_on']);
			}else{
				$row[]="-";
                                if(!empty($row1['modified_on'])){
                                    $row[]=formatDateTime($row1['modified_on']);
                                } else {
                                    $row[]="-";
                                }
				
			}
			$rtype='"'.$type.'"';
			$supportname='"'.trim(preg_replace('/\s\s[^a-zA-Z0-9]+/', ' ',str_replace("'",'',$suportData['support_description']))).'"';
			if($this->view->user->agency_user_type=="Agency"){
				$row[]="<a href='javascript:void(1);' style='margin-top:5px;' class='btn btn-xs btn-default' onClick='recordTodayChart(".$indid.",".$formid.",".$row1['support_id'].",".$row1['usc_id'].",".$rtype.",".$supportname.");'>Edit </a>";
			}
			else{
				$row[]="<b>NA</b>";
			}
                        $row[]=$row1['created_at'];
 			$output['aaData'][] = $row;
			$j++;
		}
                
                
                $sortarray = array();
                
                foreach ($output['aaData'] as $key => $row)
                {
                    $sortarray[$key] = $row[17];
                }
                array_multisort($sortarray, SORT_DESC, $output['aaData']);
                
                
                //prd($output);
                
                
                
                ///////////////////////////////////////////////////  BY amit
                echo json_encode($output);
		exit();
	}
	
	public function gettaskformAction(){
		global $healthSession;
		$indid=$this->_getParam('indid');
		$formid=$this->_getParam('formid');
		$supportid=$this->_getParam('supportid');
		$editid=$this->_getParam('editid');
		$type=$this->_getParam('type');
		$page=$this->_getParam('page');
                
                if($this->view->user->agency_user_type =="Agency"){
                    $addeduserid=$this->view->user->subuser_id;
                } else {
                    $addeduserid=$this->view->user->agency_id;
                }
		$form=new Application_Form_CustomForms();
		$form->task($indid,$formid,$supportid,$editid,$type,$page,$addeduserid);
                $is_task_done="";
		if(!empty($editid)){
			$taskData=$this->SuperModel->Super_Get("_uhs_task_entries","task_id=".$editid,"fetch");
                        $is_task_done=$taskData['is_task_done'];
                        
                        $form->populate($taskData);
			//~ if($formid==2){
				//~ $form->task_total_service_time->setValue($taskData['task_total_service_time']);
			//~ }
		}
		$helper='<div id="flash-message" class="alert alert-danger flash-message-alert-container" style="display:none;"></div>';
		echo "Task Of The Day"."~~".$helper."~~".$form."~~".$is_task_done;
		exit();
	}
	
	public function savetaskformAction(){ 
            
		global $healthSession,$systemusers;
		$indid=$this->_getParam('indid');
		$formid=$this->_getParam('formid');
		$supportid=$this->_getParam('supportid');
		$editid=$this->_getParam('editid');
		$type=$this->_getParam('type');
                
		$page=$this->_getParam('page');
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		if($permissions=="View Only"){
			$healthSession->errorMsg="You don't have permission to access this page.";
			if($type=="Care"){
				$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_personal_care");
			}
			if($type=="Ads"){
				$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_personal_care");
			}
			if($type=="MAR"){
				$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_prn_record");
			}
			if($type=="Cleaning"){
				$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_cleaning_record");
			}
		}
                
                
                if($this->view->user->agency_user_type =="Agency"){
                    $addeduserid=$this->view->user->subuser_id;
                } else {
                    $addeduserid=$this->view->user->agency_id;
                }
		$form=new Application_Form_CustomForms();
		$form->task($indid,$formid,$supportid,$editid,$type,$page,$addeduserid);
		
		if($this->getRequest()->isPost()){
			$posted_data = $this->getRequest()->getPost();
                        unset($posted_data['bttnsubmit']);
                        if($form->isValid($posted_data)){
				if(empty($editid)){
					 $indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
					 $agencyData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indData['agency_user_agency_id']);
					 $posted_data['task_agency_id']=$agencyData['agency_id'];
					 $posted_data['task_form_id']=$formid;
					 $posted_data['task_individual_id']=$indid;
					 $posted_data['task_support_id']=$supportid;
					 $posted_data['task_type']=$type;
                                        if($posted_data['task_ads_location'] == "Other"){
                                            $posted_data['task_ads_location']=$posted_data['task_ads_location'];
                                            $posted_data['task_ads_location_other']=$posted_data['task_ads_location_other'];
                                        }else{
                                            $posted_data['task_ads_location']=$posted_data['task_ads_location'];
                                        }
					 if(isset($posted_data['task_results']) && empty($posted_data['task_results']) && $type=="MAR"){
						$posted_data['is_task_entry_completed']=0;	
					 }
					 else{
					 	$posted_data['is_task_entry_completed']=1;	
					 }
					 $posted_data['task_added_date']=date('Y-m-d H:i:s');
					 $posted_data['task_added_user']=$this->view->user->subuser_id;  //$this->view->user->agency_id;
					 // code added by Amit on 26 April 2018 for support shift update 
					 
//                                         if(!empty($posted_data['support_shift'])){
//                                            $arr=array();
//                                            foreach($posted_data['support_shift'] as $key=>$val){
//                                                $arr[$val]=$val;
//                                            }
//                                            $posted_d = array();
//                                            $posted_dt = array();
//                                            $posted_dt['support_shift'][0] = "";
//                                            if(in_array(1, $arr)){
//                                                $posted_dt['support_shift'][1] = 1;
//                                            }else{
//                                               $posted_dt['support_shift'][1] = "";
//                                            }
//                                            if(in_array(2, $arr)){
//                                                $posted_dt['support_shift'][2] = 2;
//                                            }else{
//                                               $posted_dt['support_shift'][2] = "";
//                                            }
//                                            if(in_array(3, $arr)){
//                                                $posted_dt['support_shift'][3] = 3;
//                                            }else{
//                                               $posted_dt['support_shift'][3] = "";
//                                            }
//
//
//                                            $posted_d['support_shift'] = json_encode($posted_dt['support_shift']);
//                                           // $this->SuperModel->Super_Insert("_uhs_supports", $posted_d, "support_id=" . $supportid);
//                                       }else{
//                                            $posted_d = array();
//                                            $posted_dt = array();
//                                            $posted_dt['support_shift'][0] = "";
//                                            $posted_dt['support_shift'][1] = "";
//                                            $posted_dt['support_shift'][2] = "";
//                                            $posted_dt['support_shift'][3] = "";
//                                            $posted_d['support_shift'] = json_encode($posted_dt['support_shift']);
//                                            //$this->SuperModel->Super_Insert("_uhs_supports", $posted_d, "support_id=" . $supportid);
//                                       }
                                         //unset($posted_data['support_shift']);
                                         
                                         $isInserted = $this->SuperModel->Super_Insert("_uhs_task_entries",$posted_data);
                                         
                    
					 if($isInserted->success){
						if(in_array($this->view->user->agency_user_type,$systemusers) && checkNotifySettings($this->view->user->agency_user_agency_id,"form-".$formid)){
							$notifyData=array("notification_user_id"=>$this->view->user->agency_user_agency_id,"notification_type"=>"form-".$formid,"notification_type_id"=>$isInserted->inserted_id,"notification_by_user_id"=>$this->view->user->agency_id,"notification_date"=>date("Y-m-d H:i:s"));
							$isNotify=$this->SuperModel->Super_Insert("_uhs_notifications",$notifyData);
						}
						$healthSession->successMsg  = "Task of the day has been added successfully.";
					 }else{
						$healthSession->errorMsg  = $isInserted->message;
					 }
				}
				else{
					$posted_data['task_modified_by']=$this->view->user->subuser_id;
					$posted_data['task_modified_on']=date('Y-m-d H:i:s');
                                        if($posted_data['task_ads_location'] == "Other"){
                                            $posted_data['task_ads_location']=$posted_data['task_ads_location'];
                                            $posted_data['task_ads_location_other']=$posted_data['task_ads_location_other'];
                                        }else{
                                            $posted_data['task_ads_location']=$posted_data['task_ads_location'];
                                        }
					if(isset($posted_data['task_results']) && empty($posted_data['task_results']) && $type=="MAR"){
						$posted_data['is_task_entry_completed']=0;	
					}
					else{
					 	$posted_data['is_task_entry_completed']=1;	
					}
					
//					  if(!empty($posted_data['support_shift'])){
//                                            $arr=array();
//                                            foreach($posted_data['support_shift'] as $key=>$val){
//                                                $arr[$val]=$val;
//                                            }
//                                            $posted_d = array();
//                                            $posted_dt = array();
//                                            $posted_dt['support_shift'][0] = "";
//                                            if(in_array(1, $arr)){
//                                                $posted_dt['support_shift'][1] = 1;
//                                            }else{
//                                               $posted_dt['support_shift'][1] = "";
//                                            }
//                                            if(in_array(2, $arr)){
//                                                $posted_dt['support_shift'][2] = 2;
//                                            }else{
//                                               $posted_dt['support_shift'][2] = "";
//                                            }
//                                            if(in_array(3, $arr)){
//                                                $posted_dt['support_shift'][3] = 3;
//                                            }else{
//                                               $posted_dt['support_shift'][3] = "";
//                                            }
//
//
//                                            $posted_d['support_shift'] = json_encode($posted_dt['support_shift']);
//                                           // $this->SuperModel->Super_Insert("_uhs_supports", $posted_d, "support_id=" . $supportid);
//                                       }else{
//                                            $posted_d = array();
//                                            $posted_dt = array();
//                                            $posted_dt['support_shift'][0] = "";
//                                            $posted_dt['support_shift'][1] = "";
//                                            $posted_dt['support_shift'][2] = "";
//                                            $posted_dt['support_shift'][3] = "";
//                                            $posted_d['support_shift'] = json_encode($posted_dt['support_shift']);
//                                            //$this->SuperModel->Super_Insert("_uhs_supports", $posted_d, "support_id=" . $supportid);
//                                       }
                                        
                                        // code added by Amit on 26 April 2018 for support shift update 
                                       
                                       
                                        if($type=="Care"){
                                            if($posted_data['is_task_done'] == "No" || $posted_data['is_task_done'] == "Not Administered" || $posted_data['is_task_done'] == "Refused" || $posted_data['is_task_done'] == "-"){
                                                 $posted_data['task_start_time']="";
                                                 $posted_data['task_end_time']="";
                                                 $posted_data['task_total_service_time']=0;
                                                 $posted_data['task_staff_no']=0;
                                                 $posted_data['task_individual_no']=0;
                                            }
                                        }
                                        if($type=="Ads"){
                                            if($posted_data['is_task_done'] == "No" || $posted_data['is_task_done'] == "Not Administered" || $posted_data['is_task_done'] == "Refused" || $posted_data['is_task_done'] == "-"){
                                                 $posted_data['task_start_time']="";
                                                 $posted_data['task_end_time']="";
                                                 $posted_data['task_total_service_time']=0;
                                                 $posted_data['task_staff_no']=0;
                                                 $posted_data['task_individual_no']=0;
                                            }
                                        }
                                        //unset($posted_data['support_shift']);
					$isInserted = $this->SuperModel->Super_Insert("_uhs_task_entries",$posted_data,"task_id=".$editid);
					if($isInserted->success){
						if($page==2){
							$healthSession->successMsg="Task of the day has been updated successfully.";
						}
						else{
							$healthSession->successMsg="Task entry has been updated successfully.";
						}
					 }else{
						$healthSession->errorMsg  = $isInserted->message;
					 }
				}
   			}else{
				$healthSession->errorMsg = " Please check information again.";
 			}
		 }
		if($type=="Ads"){
			if($page==2){
				$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_add_personal_care");
			}
			else{
				$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_personal_care");
			}
		}
		if($type=="Care"){
			if($page==2){
				$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_add_personal_care");
			}
			else{
				$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_personal_care");
			}
		}
		if($type=="MAR"){
			if($page==2){
				$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_add_prn_record");
			}
			else{
				$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_prn_record");
			}
		}
		if($type=="Cleaning"){
			if($page==2){
				$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_add_cleaning_record");
			}
			else{
				$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_cleaning_record");
			}
		}
		exit();
	}
	
	public function removetasksAction(){
		global $healthSession;
		if($this->view->user->agency_user_type!="Agency"){
			$healthSession->errorMsg="You don't have permission to access this page.";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		$indid=$this->_getParam('indid');
		$formid=$this->_getParam('formid');
		$type=$this->_getParam('type');
 		$this->_helper->layout->disableLayout();
		$this->_helper->viewRenderer->setNoRender(true);
		$formData = $this->getRequest()->getPost();
		if(isset($formData['records']) && count($formData['records'])) { 
			foreach($formData['records'] as $key=>$values){
  				$isAdd=$this->SuperModel->Super_Delete('_uhs_task_entries',"task_id=".$values);
 				$healthSession->successMsg="Task(s) has been deleted successfully.";
			}
		}
		else{
			$healthSession->errorMsg = "Invalid Request.";
		}
 		if($type=="Ads"){
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_add_personal_care");
		}
 		if($type=="Care"){
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_add_personal_care");
		}
		if($type=="MAR"){
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_add_prn_record");
		}
		if($type=="Cleaning"){
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_add_cleaning_record");
		}
	}

	// Add Supports for diffrent Forms
	public function getsupportsAction(){
		if(check_is_ajax($this->_request)){
			$this->_redirect(APPLICATION_URL);
		}
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$type=$this->_getParam("type");
 		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('support_id','support_agency_id','support_form_id','support_individual_id','support_frequency','support_description','support_added_date','support_other_frequency','support_group_size','support_added_by','support_modified_by','support_modified_on');
		$sIndexColumn='support_id';
		$sTable='_uhs_supports';
		$sLimit="";
		if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' ){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		if ( isset( $_GET['iSortCol_0'] ) ){
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
			{
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
				{
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
		if($sWhere){
            $sWhere.=" and support_form_id=".$formid." and support_individual_id='".$indid."'"; 
        }
      	else{
        	$sWhere.=" where support_form_id=".$formid." and support_individual_id='".$indid."'"; 
        }
		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
 		$qry = $this->dbObj->query($sQuery)->fetchAll();
		$sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
		$output = array(
 				"iTotalRecords" => $iTotal,
				"iTotalDisplayRecords" => $iFilteredTotal,
				"aaData" => array()
			);
		$j=0;
		foreach($qry as $row1){
			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$row1['support_added_by']);
			$modifierData=array();
			if($row1['support_modified_by']!=0){
				$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['support_modified_by']."'","fetch");
			}
			$taskData=$this->SuperModel->Super_Get("_uhs_task_entries","task_support_id=".$row1['support_id']." and task_type='".$type."' and task_added_user='".$this->view->user->agency_id."' and DATE(task_added_date)='".date('Y-m-d')."'","fetch");
			$row=array();
 			$row[] = $j+1;
			$row[]='<input class="elem_ids checkboxes" type="checkbox" name="'.$sTable.'['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';
		    $row[]=$row1['support_description']; 
			if($row1['support_frequency']=="Other"){
				$row[]=ucwords($row1['support_frequency']."-".$row1['support_other_frequency']); 
			}
			else{
				$row[]=ucwords($row1['support_frequency']);
			}
			if($formid==2){
				$row[]=isEmpty($row1['support_group_size']);
			}
			if($formid==27){
				$row[]=isEmpty($row1['support_group_size']);
			}
			$userType=printUserType($creatorData);
			$row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
			$row[]=formatDateTime($row1['support_added_date']);
			$row[]=formatDate(date('Y-m-d'));
			if(!empty($modifierData)){
				$userType=printUserType($modifierData);
				$row[]=ucwords($modifierData['agency_first_name']." ".$modifierData['agency_last_name'])."&nbsp;".$userType;
				$row[]=formatDateTime($row1['support_modified_on']);
			}
			else{
				$row[]="-";
				$row[]="-";
			}
			$editLink="";
			if($this->view->user->agency_user_type=="Agency"){
				//$editLink = "&nbsp;<a href='javascript:void(1);' style='margin-top:5px;' onClick='showSupportForm(" . $indid . "," . $formid . "," . $row1['support_id'] . ");' class='btn btn-xs btn-default'>Edit Support</a>";
                $editLink = "&nbsp;<a href=".APPLICATION_URL . "/edit-personal-care-form/" . $indid . "/" . $formid . "/" . $row1['support_id']." style='margin-top:5px;' class='btn btn-xs btn-default'>Edit Support</a>";

			}
			/*
			if(empty($taskData)){
				$nullString='""';
				$taskType='"'.$type.'"';
				$supDes = str_replace("'", '`', $row1['support_description']);
                $supDes = str_replace('"', '`', $supDes);
                $supDes = '"' . $supDes . '"';
				$row[]="<a href='javascript:void(1);' style='margin-top:5px;' class='btn btn-xs btn-default atc-btn' onClick='recordTodayTask(".$indid.",".$formid.",".$row1['support_id'].",".$nullString.",".$taskType.",2);'>Add Today Chart</a>".$editLink;
			}else{
				$taskType='"'.$type.'"';
				$taskCreator=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$taskData['task_added_user'],"fetch");
				$row[]="<a href='javascript:void(1);' style='margin-top:5px;' class='btn btn-xs btn-default' onClick='recordTodayTask(".$indid.",".$formid.",".$row1['support_id'].",".$taskData['task_id'].",".$taskType.",2);'>Edit Today Chart </a>&nbsp; <i style='vertical-align:middle;' class='fa fa-info-circle' data-toggle='tooltip' title='Task added by ".ucwords($taskCreator['agency_first_name']." ".$taskCreator['agency_last_name'])."'></i> ".$editLink;
			}*/
			//if(empty($taskData)){
				$nullString='""';
				$taskType='"'.$type.'"';
				$row1['support_description'] = str_replace("/",' ',$row1['support_description']);
				$supportname='"'.trim(preg_replace('/\s\s[^a-zA-Z0-9]+/', ' ',str_replace("'",'',$row1['support_description']))).'"';

				$row[]="<a href='javascript:void(1);' style='margin-top:5px;' class='btn btn-xs btn-default support' supportname='".$row1['support_description']."' onClick='recordTodayTask(".$indid.",".$formid.",".$row1['support_id'].",".$nullString.",".$taskType.",".$supportname.",2);'>Add to Today’s Chart</a>".$editLink;
//			}else{
//				$taskType='"'.$type.'"';
//				$supportname='"'.trim(preg_replace('/\s\s[^a-zA-Z0-9]+/', ' ',str_replace("'",'',$row1['support_description']))).'"';
//				$taskCreator=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$taskData['task_added_user'],"fetch");
//				$row[]="<a href='javascript:void(1);' style='margin-top:5px;' class='btn btn-xs btn-default ' supportname='".$row1['support_description']."' onClick='recordTodayTask(".$indid.",".$formid.",".$row1['support_id'].",".$taskData['task_id'].",".$taskType.",".$supportname.",2);'>Edit Today Chart </a>&nbsp; <i style='vertical-align:middle;' class='fa fa-info-circle' data-toggle='tooltip' title='Task added by ".ucwords($taskCreator['agency_first_name']." ".$taskCreator['agency_last_name'])."'></i> ".$editLink;
//			}
			$output['aaData'][] = $row;
			$j++;
		}
		echo json_encode($output);
		exit();
	}	
	
	public function getcustomformsAction(){ 
	    $this->_helper->layout->disableLayout();
		global $healthSession;
		$formid=$_REQUEST['formid'];
		$editid=$_REQUEST['editid'];
		$indid=$_REQUEST['indid'];
		$form=new Application_Form_CustomForms();
		$form->supports($formid,$indid,$editid);
		if(empty($editid)){
			$heading="Add Support";
		}
		else{
			$heading="Edit Support";
			$supportData=$this->SuperModel->Super_Get("_uhs_supports","support_id=".$editid,"fetch");
			$form->populate($supportData);
		}
		echo $heading."~~".$form;
		exit();
	}
	
	public function savesupportsAction() {
        global $healthSession;
//        echo"<pre>";
//        print_r($_POST);
        $formid = $this->_getParam('formid');
        $editid = $this->_getParam('editid');
        $indid = $this->_getParam('indid');

        $form = new Application_Form_CustomForms();
        $form->supports($formid, $indid, $editid);

        if ($this->getRequest()->isPost()) {
            $temp = $this->getRequest()->getPost();
            $posted_data = array();
            foreach ($_POST['support_frequency'] as $key => $value) {
                 if($formid == 27) {
                    $posted_data[$key]['support_ads_location'] = $_POST['support_ads_location'][$key];
                    $posted_data[$key]['support_ads_location_other'] = $_POST['support_ads_location_other'][$key];
                }
                $posted_data[$key]['support_frequency'] = $_POST['support_frequency'][$key];
                $posted_data[$key]['support_description'] = $_POST['support_description'][$key];
                $posted_data[$key]['support_other_frequency'] = $_POST['other_frequency_detail'][$key];
                $posted_data[$key]['support_shift'][0] = isset($_POST['support_shift'][$key]) ? $_POST['support_shift'][$key] : "";
                $posted_data[$key]['support_shift'][1] = isset($_POST['support_shift1'][$key]) ? $_POST['support_shift1'][$key] : "";
                $posted_data[$key]['support_shift'][2] = isset($_POST['support_shift2'][$key]) ? $_POST['support_shift2'][$key] : "";
                $posted_data[$key]['support_shift'][3] = isset($_POST['support_shift3'][$key]) ? $_POST['support_shift3'][$key] : "";
            }
            // print_r($posted_data);die;
            // if($form->isValid($temp)){
            if (empty($editid)) {
                foreach ($posted_data as $key => $value) {
                    $posted_d = $value;
                    $posted_d = $value;
                    $posted_d['support_shift'] = json_encode($value['support_shift']);
                    $posted_d['support_added_date'] = date('Y-m-d H:i:s');
                    $posted_d['support_agency_id'] = $this->view->user->agency_id;
                    $posted_d['support_form_id'] = $formid;
                    $posted_d['support_individual_id'] = $indid;
                    $posted_d['support_added_by'] = $this->view->user->agency_id;
                    // print_r($posted_d);die;
                    $isInserted = $this->SuperModel->Super_Insert("_uhs_supports", $posted_d);
                    if ($isInserted->success) {
                        $healthSession->successMsg = "Supports has been added successfully.";
                    } else {
                        $healthSession->errorMsg = $isInserted->message;
                    }
                }
            } else {
                $posted_data['support_modified_by'] = $this->view->user->subuser_id;
                $posted_data['support_modified_on'] = date('Y-m-d H:i:s');
                $isInserted = $this->SuperModel->Super_Insert("_uhs_supports", $posted_data, "support_id=" . $editid);
                if ($isInserted->success) {
                    $healthSession->successMsg = "Supports has been updated successfully.";
                } else {
                    $healthSession->errorMsg = $isInserted->message;
                }
            }

            // }else{
            // 	$healthSession->errorMsg = " Please check information again.";
            // }
        }
        if ($formid == 2) {
            $this->_helper->getHelper("Redirector")->gotoRoute(array("indid" => $indid, "formid" => $formid), "front_add_personal_care");
        }
        if ($formid == 27) {
            $this->_helper->getHelper("Redirector")->gotoRoute(array("indid" => $indid, "formid" => $formid), "front_add_personal_care");
        }
        if ($formid == 5) {
            $this->_helper->getHelper("Redirector")->gotoRoute(array("indid" => $indid, "formid" => $formid), "front_add_prn_record");
        }
        if ($formid == 15) {
            $this->_helper->getHelper("Redirector")->gotoRoute(array("indid" => $indid, "formid" => $formid), "front_add_cleaning_record");
        }
    }
    
    public function editsupportsAction() {
        global $healthSession;
        
        $formid = $this->_getParam('formid');
        $editid = $this->_getParam('editid');
        $indid = $this->_getParam('indid');

        $form = new Application_Form_CustomForms();
        $form->supports($formid, $indid, $editid);

        if ($this->getRequest()->isPost()) {
            $temp = $this->getRequest()->getPost();
            $posted_data = array();
            
            if ($formid == 27) {
                $posted_data['support_ads_location_other'] = $_POST['support_ads_location_other'];
                $posted_data['support_ads_location'] = $_POST['support_ads_location'];
            }
            $posted_data['support_frequency'] = $_POST['support_frequency'];
            $posted_data['support_description'] = $_POST['support_description'];
            $posted_data['support_other_frequency'] = $_POST['other_frequency_detail'];
            $posted_data['support_shift'][0] = isset($_POST['support_shift']) ? $_POST['support_shift'] : "";
            $posted_data['support_shift'][1] = isset($_POST['support_shift1']) ? $_POST['support_shift1'] : "";
            $posted_data['support_shift'][2] = isset($_POST['support_shift2']) ? $_POST['support_shift2'] : "";
            $posted_data['support_shift'][3] = isset($_POST['support_shift3']) ? $_POST['support_shift3'] : "";
            
            $posted_d = $posted_data;
            $posted_d['support_shift'] = json_encode($posted_data['support_shift']);
            
            $posted_d['support_modified_by'] = $this->view->user->subuser_id;
            $posted_d['support_modified_on'] = date('Y-m-d H:i:s');
            
            $isInserted = $this->SuperModel->Super_Insert("_uhs_supports", $posted_d, "support_id=" . $editid);
            if ($isInserted->success) {
                $healthSession->successMsg = "Supports has been updated successfully.";
            } else {
                $healthSession->errorMsg = $isInserted->message;
            }
        }
        if ($formid == 2) {
            $this->_helper->getHelper("Redirector")->gotoRoute(array("indid" => $indid, "formid" => $formid), "front_add_personal_care");
        }
        if ($formid == 27) {
            $this->_helper->getHelper("Redirector")->gotoRoute(array("indid" => $indid, "formid" => $formid), "front_add_personal_care");
        }
        if ($formid == 5) {
            $this->_helper->getHelper("Redirector")->gotoRoute(array("indid" => $indid, "formid" => $formid), "front_add_prn_record");
        }
        if ($formid == 15) {
            $this->_helper->getHelper("Redirector")->gotoRoute(array("indid" => $indid, "formid" => $formid), "front_add_cleaning_record");
        }
    }
	
	public function removesupportsAction(){
		global $healthSession;
		if($this->view->user->agency_user_type!="Agency"){
			$healthSession->errorMsg="You don't have permission to access this page.";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		$indid=$this->_getParam('indid');
		$formid=$this->_getParam('formid');
		$type=$this->_getParam('type');
 		$this->_helper->layout->disableLayout();
		$this->_helper->viewRenderer->setNoRender(true);
		$formData = $this->getRequest()->getPost();
		if(isset($formData['_uhs_supports']) && count($formData['_uhs_supports'])) { 
			foreach($formData['_uhs_supports'] as $key=>$values){
  				$isAdd=$this->SuperModel->Super_Delete('_uhs_supports',"support_id=".$values);
 				$healthSession->successMsg="Support(s) has been deleted successfully.";
			}
		}
		else{
			$healthSession->errorMsg = "Invalid Request.";
		}
 		if($type=="Care"){
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_add_personal_care");
		}
 		if($type=="Ads"){
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_add_personal_care");
		}
		if($type=="MAR"){
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_add_prn_record");
		}
		if($type=="Cleaning"){
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_add_cleaning_record");
		}
	}
	
	// Get Diffrent Forms
	public function getdifferformsAction(){ 
		global $healthSession;
		$type=$this->_getParam("type");
		$formid=$this->_getParam("formid");
		$indid=$this->_getParam("indid");
		$year=$this->_getParam("year");
		$month=$this->_getParam("month");
		$id=$this->_getParam("id");
		$form=new Application_Form_CustomForms();
		$headingText="Add";
		$document="";
		if(!empty($id) && $id != -1){
			$headingText="Edit";
		}
		$helper='<div id="flash-message" class="alert alert-danger flash-message-alert-container" style="display:none;"></div>';
		switch($type){
			case "IncidentLog":
				$headingText.=" Incident Log";
				$form->incidentLog($indid,$formid,$id);
				if(!empty($id)){
					$logData=$this->SuperModel->Super_Get("_uhs_incident_logs","inc_log_id=".$id,"fetch");
					if(!empty($logData)){
						$logData['inc_service_date']=date('m/d/Y',strtotime($logData['inc_service_date']));
						$form->populate($logData);
					}
				}
			break;
			
			case "TornadoLog":
				$headingText.=" Tornado Log";
				$form->drillLog($indid,$formid,$type,$id);
				$currentmonth = date('m');
				if(!empty($id)){
					$logData=$this->SuperModel->Super_Get("_uhs_drills_logs","drill_id=".$id,"fetch");
					$monthmodified = date('m',strtotime($logData['drill_modified_on']));

					if(!empty($logData)){
						if ($monthmodified != $currentmonth ){
							$logData['drill_service_date']=date('m/d/Y',strtotime($logData['drill_service_date']));
							$form->populate($logData);	
						}else{
								echo 0;exit;
						}
					}
				}else{
					
					$logData=$this->SuperModel->Get_fireloglatestadd($indid,$formid);
					$count = count($logData) -1;
					$addDate = date('m',strtotime($logData[$count]['drill_added_date']));
					
						if ($addDate == $currentmonth ){
							echo 1;exit;
						}
					}
			break;
			
			case "FireLog":
				$headingText.=" Fire Log";
				$form->drillLog($indid,$formid,$type,$id);
				$currentmonth = date('m');
				if(!empty($id)){
					$logData=$this->SuperModel->Super_Get("_uhs_drills_logs","drill_id=".$id,"fetch");
					$monthmodified = date('m',strtotime($logData['drill_modified_on']));

					if(!empty($logData)){
						if ($monthmodified != $currentmonth ){
							$logData['drill_service_date']=date('m/d/Y',strtotime($logData['drill_service_date']));
							$form->populate($logData);	
						}else{
								echo 0;exit;
						}
					}
				}else{
					$logData=$this->SuperModel->Get_fireloglatestadd($indid,$formid);
					$count = count($logData) -1;
					$addDate = date('m',strtotime($logData[$count]['drill_added_date']));
						if ($addDate == $currentmonth ){
							echo 1;exit;
						}
					}
			break;
			
			case "IntakeLog":
				$headingText.=" Food Intake Log";
				$form->intakeLog($indid,$formid,$id);
				if(!empty($id)){
					$logData=$this->SuperModel->Super_Get("_uhs_intake_logs","intake_id=".$id,"fetch");
					if(!empty($logData)){
						$logData['intake_added_user']=date('m/d/Y',strtotime($logData['intake_added_user']));
						$form->populate($logData);
					}
				}
			break;

			case "BlowForm":
				$headingText.=" Bowel movement";
				$form->blowmovement($indid,$formid,$id);
				if(!empty($id)){
					$logData=$this->SuperModel->Super_Get("_uhs_bow_movement_logs","bow_movement_id=".$id,"fetch");
					if(!empty($logData)){
						$logData['bow_added_user']=date('m/d/Y',strtotime($logData['bow_added_user']));
						$form->populate($logData);
					}
				}
			break;

			case "sendbehavoirform":
				$headingText.=" Send this form";
				$form->sendbehavoirform($indid,$formid,$id);
                                
				/*if(!empty($id)){
					$logData=$this->SuperModel->Super_Get("_uhs_intake_logs","intake_id=".$id,"fetch");
					if(!empty($logData)){
						$logData['intake_added_user']=date('m/d/Y',strtotime($logData['intake_added_user']));
						$form->populate($logData);
					}
				}*/
			break;

			case "sendbehavoirformhistory":
                            $headingText.=" Send this form";
                            $year=$this->_getParam("year");           
                            $month=$this->_getParam("month");
                            if(empty($id)){
                                $id=0;
                            }
                            $form->sendbehavoirhistoryform($indid,$formid,$id,$year,$month);
                        break;
                        
			case "calendarviewform":
                            $headingText.=" Send this form";
                            $year=$this->_getParam("year");           
                            $month=$this->_getParam("month");
                            if(empty($id)){
                                $id=0;
                            }
                            $form->calendarviewform($indid,$formid,$id,$year,$month);
                        break;
                        
			case "hpcnoteform":
                            $headingText.=" Send this form";
                            if(empty($id)){
                                $id=0;
                            }
                            $form->hpcNoteEmail($indid,$formid,$id);
                        break;
			case "outcomerecordemailform":
                            $headingText.=" Send this form";
                            if(empty($id)){
                                $id=0;
                            }
                            $form->outcomeRecordEmail($indid,$formid,$id);
                        break;
                        
			case "sendsleepmailform":
                            $headingText.=" Send this form";
                            if(empty($id)){
                                $id=0;
                            }
                            $form->sleeppdfEmail($indid,$formid,$id);
                        break;
			
			case "ShiftLog":
				$headingText.=" Shift Summary";
				$form->shiftSummary($indid,$formid,$id);
				if(!empty($id)){
					$logData=$this->SuperModel->Super_Get("_uhs_shift_summary","shift_id=".$id,"fetch");
					if(!empty($logData)){
						$form->populate($logData);
					}
				}
			break;
			
			case "TimingSheet":
		      if($this->view->user->agency_user_type =="Agency"){ 
				$agency_id= $this->view->user->agency_id;
				if($this->view->user->is_subuser == 1){
					$agency_id= $this->view->user->agency_user_agency_id;
				}
			  }
			  else{
				$agency_id= $this->view->user->agency_user_agency_id;
			  } 
 
			  $rec = $this->SuperModel->Super_Get("_uhs_timing_sheets","service_individual_id='".$indid."' and service_agency_id='".$agency_id."' and service_added_user='".$this->view->user->agency_id."' and service_type != 'Group'","fetch",array("order"=>"sheet_id DESC",'limit'=>1));
			  if(!empty($id) && $id != -1){
				    $headingText.=" Clock In Sheet";
					$form->timingSheets($indid,$formid,$id);
					$logData=$this->SuperModel->Super_Get("_uhs_timing_sheets","sheet_id=".$id,"fetch");
					if(!empty($logData)){
						$logData['service_date']=date('m/d/Y',strtotime($logData['service_date']));
						$form->populate($logData);
					}
			  }else{
				  if($id == -1){
					echo "ClockIn"; 
					exit;
				  }else{
				  if($rec['is_sheet_completed'] == "1" || empty($rec)){
					$headingText.=" Clock In Sheet";
					$form->timingSheets($indid,$formid,$id);
				  }else{
					echo "ClockOut"; 
					exit;
				  }
			     }
			  }
		  
			break;
			
			case "Mileage":
				$headingText.=" Mileage Log";
				$form->Mileage($indid,$formid,$id);
				if(!empty($id)){
					$logData=$this->SuperModel->Super_Get("_uhs_mileage_logs","mlog_id=".$id,"fetch");
					if(!empty($logData)){
						unset($logData['mlog_remaining_mileage']);
						$logData['mlog_service_date']=date('m/d/Y',strtotime($logData['mlog_service_date']));
						$form->populate($logData);
					}
				}
			break;
			case "AssignedMileage":
				$headingText.=" Total Mileage";
				$mileageData=$this->SuperModel->Super_Get("_uhs_mileage_logs","mlog_form_id=".$formid.' and mlog_individual_id='.$indid.' and MONTH(mlog_added_date)=MONTH(CURDATE())',"fetch",array("fields"=>"SUM(mlog_total_miles) as totalDriven"));
				$mileageVal=round($mileageData['totalDriven']);
				$form->assignedMileage($indid,$formid,$id,$mileageVal);
				if(!empty($id)){
					$logData=$this->SuperModel->Super_Get("_uhs_assigned_miles","mid=".$id,"fetch");
					if(!empty($logData)){
						$form->populate($logData);
					}
				}
			break;
			case "Appointment":
				$headingText.=" Appointment";
				$form->appointments($indid,$formid,$id);
				if(!empty($id)){
					$logData=$this->SuperModel->Super_Get("_uhs_appointments","appoint_id=".$id,"fetch");
					if(!empty($logData)){
						$logData['appoint_date']=date('m/d/Y',strtotime($logData['appoint_date']));
						$form->populate($logData);
					}
				}
			break;
			case "Medical":
				$headingText.=" Medical Concern";
				$form->medicalConcerns($indid,$formid,$id);
				if(!empty($id)){
					$logData=$this->SuperModel->Super_Get("_uhs_medical_concerns","med_id=".$id,"fetch");
					if(!empty($logData)){
						$logData['med_service_date']=date('m/d/Y',strtotime($logData['med_service_date']));
						$form->populate($logData);
					}
				}
			break;
			case "Financial":
				$headingText.=" Financial Ledger";
				$form->Financial($indid,$formid,$id);
				if(!empty($id)){
					$logData=$this->SuperModel->Super_Get("_uhs_financial_ledger","flid=".$id,"fetch");
					if(!empty($logData)){
						$logData['fl_service_date']=date('m/d/Y',strtotime($logData['fl_service_date']));
						//unset($logData['fl_remaining_balance']);
						$form->populate($logData);
						$document="<p id='insertedvideo'><a target='_blank' href='".HTTP_FINANCIAL_PATH."/".$logData['fl_uploads']."'>".formatDocumentName($logData['fl_uploads'])."</a></p>";
					}
				}
			break;
			case "Financialcredit":
				$headingText.=" Financial Ledger";
				$form->Financial($indid,$formid,$id);
				if(!empty($id)){
					$logData=$this->SuperModel->Super_Get("_uhs_financial_ledger","flid=".$id,"fetch");
					if(!empty($logData)){
						$logData['fl_service_date']=date('m/d/Y',strtotime($logData['fl_service_date']));
						//unset($logData['fl_remaining_balance']);
						$form->populate($logData);
						$document="<p id='insertedvideo'><a target='_blank' href='".HTTP_FINANCIAL_PATH."/".$logData['fl_uploads']."'>".formatDocumentName($logData['fl_uploads'])."</a></p>";
					}
				}
			break;
			case "Financialgift":
				$headingText.=" Financial Ledger";
				$form->Financial($indid,$formid,$id);
				if(!empty($id)){
					$logData=$this->SuperModel->Super_Get("_uhs_financial_ledger","flid=".$id,"fetch");
					if(!empty($logData)){
						$logData['fl_service_date']=date('m/d/Y',strtotime($logData['fl_service_date']));
						//unset($logData['fl_remaining_balance']);
						$form->populate($logData);
						$document="<p id='insertedvideo'><a target='_blank' href='".HTTP_FINANCIAL_PATH."/".$logData['fl_uploads']."'>".formatDocumentName($logData['fl_uploads'])."</a></p>";
					}
				}
			break;
			case "Financialspending":
				$headingText.=" Financial Ledger";
				$form->Financial($indid,$formid,$id);
				if(!empty($id)){
					$logData=$this->SuperModel->Super_Get("_uhs_financial_ledger","flid=".$id,"fetch");
					if(!empty($logData)){
						$logData['fl_service_date']=date('m/d/Y',strtotime($logData['fl_service_date']));
						//unset($logData['fl_remaining_balance']);
						$form->populate($logData);
						$document="<p id='insertedvideo'><a target='_blank' href='".HTTP_FINANCIAL_PATH."/".$logData['fl_uploads']."'>".formatDocumentName($logData['fl_uploads'])."</a></p>";
					}
				}
			break;
			case "AssignedBalance":
				$headingText.=" Initial Balance";
				$amtData=$this->SuperModel->Super_Get("_uhs_financial_ledger","fl_form_id=".$formid.' and fl_individual_id='.$indid.'',"fetch",array("fields"=>"SUM(fl_amt_spend) as totalSpent"));
				$totalSpent=$amtData['totalSpent'];
				$form->assignedBalance($indid,$formid,$id,$totalSpent);
				if(!empty($id)){
					$logData=$this->SuperModel->Super_Get("_uhs_financial_initial_balance","balance_id=".$id,"fetch");
					if(!empty($logData)){
						$form->populate($logData);
					}
				}
			break;
			case "AssignedCredit":
				$headingText.=" Credit";
				$amtData=$this->SuperModel->Super_Get("_uhs_financial_ledger","fl_form_id=".$formid.' and fl_individual_id='.$indid.'',"fetch",array("fields"=>"SUM(fl_amt_spend) as totalSpent"));
				$totalSpent=$amtData['totalSpent'];
				$form->assignedCredit($indid,$formid,$id,$totalSpent);
				if(!empty($id)){
					$logData=$this->SuperModel->Super_Get("_uhs_financial_initial_balance","balance_id=".$id,"fetch");
					if(!empty($logData)){
						$form->populate($logData);
					}
				}
			break;
			case "getcreditbalance":
				$headingText.=" Credit";
				$amtData=$this->SuperModel->Super_Get("_uhs_financial_ledger","fl_form_id=".$formid.' and fl_individual_id='.$indid.'',"fetch",array("fields"=>"SUM(fl_amt_spend) as totalSpent"));
				$totalSpent=$amtData['totalSpent'];
				$form->assignedCredit($indid,$formid,$id,$totalSpent);
				if(!empty($id)){
					$logData=$this->SuperModel->Super_Get("_uhs_financial_credit_balance","balance_id=".$id,"fetch");
					if(!empty($logData)){
						$form->populate($logData);
					}
				}
			break;
			case "getgiftbalance":
				$headingText.=" Credit";
				$amtData=$this->SuperModel->Super_Get("_uhs_financial_ledger","fl_form_id=".$formid.' and fl_individual_id='.$indid.'',"fetch",array("fields"=>"SUM(fl_amt_spend) as totalSpent"));
				$totalSpent=$amtData['totalSpent'];
				$form->assignedCredit($indid,$formid,$id,$totalSpent);
				if(!empty($id)){
					$logData=$this->SuperModel->Super_Get("_uhs_financial_gift_balance","balance_id=".$id,"fetch");
					if(!empty($logData)){
						$form->populate($logData);
					}
				}
			break;
			case "getspendingbalance":
				$headingText.=" Credit";
				$amtData=$this->SuperModel->Super_Get("_uhs_financial_ledger","fl_form_id=".$formid.' and fl_individual_id='.$indid.'',"fetch",array("fields"=>"SUM(fl_amt_spend) as totalSpent"));
				$totalSpent=$amtData['totalSpent'];
				$form->assignedCredit($indid,$formid,$id,$totalSpent);
				if(!empty($id)){
					$logData=$this->SuperModel->Super_Get("_uhs_financial_spending_balance","balance_id=".$id,"fetch");
					if(!empty($logData)){
						$form->populate($logData);
					}
				}
			break;
			case "FOOD":
				// $headingText.=" Food Stamp Ledger";
				// $form->FoodStamp($indid,$formid,$id);
				// if(!empty($id)){
				// 	$logData=$this->SuperModel->Super_Get("_uhs_food_stamp","food_id=".$id,"fetch");
				// 	if(!empty($logData)){
				// 		$logData['food_service_date']=date('m/d/Y',strtotime($logData['food_service_date']));
				// 		unset($logData['food_remaining_balance']);
				// 		$form->populate($logData);
				// 		$document="<p id='insertedvideo'><a target='_blank' href='".HTTP_STAMP_PATH."/".$logData['food_upload']."'>".formatDocumentName($logData['food_upload'])."</a></p>";
				// 	}
				// }
			    $headingText.=" Financial Ledger";
				$form->FoodStamp($indid,$formid,$id);
				if(!empty($id)){
					$logData=$this->SuperModel->Super_Get("_uhs_food_stamp","food_id=".$id,"fetch");
					if(!empty($logData)){
						$logData['food_service_date']=date('m/d/Y',strtotime($logData['food_service_date']));
						//unset($logData['fl_remaining_balance']);
						$form->populate($logData);
						$document="<p id='insertedvideo'><a target='_blank' href='".HTTP_FINANCIAL_PATH."/".$logData['fl_uploads']."'>".formatDocumentName($logData['fl_uploads'])."</a></p>";
					}
				}
			break;
			case "GROCERIES":
				//$headingText.=" Groceries/Household";
			    $headingText.=" Financial Ledger";
				$form->Groceries($indid,$formid,$id);
				if(!empty($id)){
					$logData=$this->SuperModel->Super_Get("_uhs_groceries","groceries_id=".$id,"fetch");
					if(!empty($logData)){
						$logData['groceries_service_date']=date('m/d/Y',strtotime($logData['groceries_service_date']));
						//unset($logData['groceries_remaining_balance']);
						$form->populate($logData);
						$document="<p id='insertedvideo'><a target='_blank' href='".HTTP_STAMP_PATH."/".$logData['groceries_upload']."'>".formatDocumentName($logData['groceries_upload'])."</a></p>";
					}
				}
			break;
			case "AssignedFoodBalance":
				//$headingText.=" Initial Balance";
			    $headingText.=" Credit";
				$amtData=$this->SuperModel->Super_Get("_uhs_food_stamp","food_form_id=".$formid.' and food_individual_id='.$indid.'',"fetch",array("fields"=>"SUM(food_amt_spend) as totalSpent"));
				$totalSpent=$amtData['totalSpent'];
				$form->assignedFoodBalance($indid,$formid,$id,$totalSpent);
				//$form->assignedCredit($indid,$formid,$id,$totalSpent);
				if(!empty($id)){
					$logData=$this->SuperModel->Super_Get("_uhs_food_initial_balance","fbid=".$id,"fetch");
					if(!empty($logData)){
						$form->populate($logData);
					}
				}
			break;
			case "AssignedGroceriesBalance":
				//$headingText.=" Initial Balance";
			    $headingText.=" Credit";
				$amtData=$this->SuperModel->Super_Get("_uhs_groceries","groceries_form_id=".$formid.' and groceries_individual_id='.$indid.'',"fetch",array("fields"=>"SUM(groceries_amt_spend) as totalSpent"));
				$totalSpent=$amtData['totalSpent'];
				$form->assignedGroceriesBalance($indid,$formid,$id,$totalSpent);
				if(!empty($id)){
					$logData=$this->SuperModel->Super_Get("_uhs_groceries_initial_balance","grid=".$id,"fetch");
					if(!empty($logData)){
						$form->populate($logData);
					}
				}
			break;
		}
		echo $headingText."~~".$helper.$form."~~".$document;
		exit();
	}
	
	// Incident Log Form
	public function incidentlogsAction(){	
		global $healthSession; 
  		$this->view->pageHeading = "Incident Logs";
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		if(empty($indid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		$this->view->permissions=$permissions;
		$this->view->indid=$indid;
		$this->view->formid=$formid;
		$this->view->id=$id;
  	}

	public function getincidentlogsAction(){
		if(check_is_ajax($this->_request)){
			$this->_redirect(APPLICATION_URL);
		}
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		
		$subuser=$dstarts=$dends=$wcode="";
		if(isset($_REQUEST['subuser']) && !empty($_REQUEST['subuser'])){
			$subuser=$_REQUEST['subuser'];
		}
		if(isset($_REQUEST['dstarts']) && !empty($_REQUEST['dstarts'])){
			$dstarts=$_REQUEST['dstarts'];
		}
		if(isset($_REQUEST['dends']) && !empty($_REQUEST['dends'])){
			$dends=$_REQUEST['dends'];
		}	
		if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
			$month=$_REQUEST['month'];
		}
		if(isset($_REQUEST['year']) && !empty($_REQUEST['year'])){
			$year=$_REQUEST['year'];
		}	
		
 		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('inc_log_id','inc_log_added_user','inc_service_date','inc_country','inc_desc','is_injured','inc_time','inc_location','inc_preventative_measure','inc_added_date','inc_modified_by','inc_modified_on');
		$sIndexColumn = 'inc_log_id';
		$sTable = '_uhs_incident_logs';
		$sLimit = "";
		if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' ){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		if ( isset( $_GET['iSortCol_0'] ) )
		{
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
			{
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
				{
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
		
	if(empty($subuser)){
			$indParentUsers="";
			if($this->view->user->agency_user_type=="Agency"){
				$systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_id,"fetchAll",array("fields"=>"agency_id"));
				$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
				$indParentUsers=implode_r(",",$systemUsers);
                                if($sWhere){
                                    $sWhere.=" and inc_log_added_user IN(".$indParentUsers.") and inc_log_individual_id='".$indid."'";
                                }
                                else{
                                    $sWhere.=" where inc_log_added_user IN(".$indParentUsers.") and inc_log_individual_id='".$indid."'"; 
                                }
			}
			else{
                            $indParentUsers=$this->view->user->agency_id;
                            if($sWhere){
                                $sWhere.=" and inc_log_individual_id='".$indid."'"; 
                            }
                            else{
                                    $sWhere.=" where inc_log_individual_id='".$indid."'"; 
                            }
			}
			
		}
		else{
			if($sWhere){
				$sWhere.=" and inc_log_added_user IN(".$subuser.") and inc_log_individual_id='".$indid."'"; 
			}
			else{
				$sWhere.=" where inc_log_added_user IN(".$subuser.") and inc_log_individual_id='".$indid."'"; 
			}
		}	
		if(!empty($dstarts)){
			$sWhere.=" and DATE(inc_service_date) >='".$dstarts."'";
		}
		if(!empty($dends)){
			$sWhere.=" and DATE(inc_service_date) <='".$dends."'";
		}	
		if(!empty($month)){
			$sWhere.=" and MONTH(inc_service_date)='".$month."'";
		}
		if(!empty($year)){
			$sWhere.=" and YEAR(inc_service_date)='".$year."'";
		}
		if(!empty($id) && $id!=0){
			$sWhere.=" and inc_log_id=".$id;
		}
		if(empty($month) && empty($year)){
                    if(!empty($sWhere)){
                        $sWhere.=" and MONTH(inc_added_date)=MONTH(CURDATE()) and YEAR(inc_added_date)=YEAR(CURDATE())";
                    }else{
                        $sWhere.=" where MONTH(inc_added_date)=MONTH(CURDATE()) and YEAR(inc_added_date)=YEAR(CURDATE())";
                    }
                }
		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
 		$qry = $this->dbObj->query($sQuery)->fetchAll();
		$sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
		$output = array(
 				"iTotalRecords" => $iTotal,
				"iTotalDisplayRecords" => $iFilteredTotal,
				"aaData" => array()
			);
		$j=0;
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		foreach($qry as $row1){
			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['inc_log_added_user']."'","fetch");
			$modifierData=array();
			if($row1['inc_modified_by']!=0){
				$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['inc_modified_by']."'","fetch");
			}
			$row=array();
 			$row[] = $j+1;
			$row[]='<input class="elem_ids checkboxes" type="checkbox" name="records['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';
			$row[]=formatDate($row1['inc_service_date']); 
			$row[]=ucwords($row1['inc_country']);
			$row[]=$row1['inc_time']; 
			$row[]=ucwords($row1['inc_location']); 
			$row[]=$row1['inc_desc'];
			$row[]=$row1['is_injured'];
			$row[]=ucwords($row1['inc_preventative_measure']); 
			$userType=printUserType($creatorData);
  			$row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
			$row[]=formatDateTimeNew($row1['inc_added_date']);
			if(!empty($modifierData)){
				$userType=printUserType($modifierData);
				$row[]=ucwords($modifierData['agency_first_name']." ".$modifierData['agency_last_name'])."&nbsp;".$userType;
				$row[]=formatDateTime($row1['inc_modified_on']);
			}
			else{
				$row[]="-";
				$row[]="-";
			}
			$type='"IncidentLog"';
			if(($permissions=="Edit" || $permissions=="Both") && !isFormAssigned($formid,$indid)){
				$row[]="<a style='margin-top:5px;' href='javascript:void(1);' onclick='showDiffrentForms(".$indid.",".$formid.",".$row1[$sIndexColumn].",".$type.");' class='btn btn-xs btn-default'>Edit</a>";
			}
			else{
				$row[]="-";
			}
 			$output['aaData'][] = $row;
			$j++;
		}
		echo json_encode($output);
		exit();
	}
	
	public function saveincidentlogAction(){
		global $healthSession,$systemusers;
		$formid=$this->_getParam("formid");
		$indid=$this->_getParam("indid");
		$id=$this->_getParam("id");
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		if($permissions=="View Only"){
			$healthSession->errorMsg="You don't have permission to access this page.";
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_incident_logs");
		}
		$form=new Application_Form_CustomForms();
		$form->incidentLog($indid,$formid,$id);
		if($this->getRequest()->isPost()){
			$posted_data = $this->getRequest()->getPost();
   			if($form->isValid($posted_data)){
				$posted_data['inc_service_date']=date("Y-m-d",strtotime($posted_data['inc_service_date']));
				if(empty($id)){
					 $indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
					 $agencyData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indData['agency_user_agency_id']);
					 $posted_data['inc_log_agency_id']=$agencyData['agency_id'];
					 $posted_data['inc_log_individual_id']=$indid;
					 $posted_data['inc_log_form_id']=$formid;
					 $posted_data['inc_added_date']=date('Y-m-d H:i:s');
					 $posted_data['inc_log_added_user']=$this->view->user->subuser_id; //$this->view->user->agency_id;
					 $isInserted = $this->SuperModel->Super_Insert("_uhs_incident_logs",$posted_data);
					 if($isInserted->success){
						if(in_array($this->view->user->agency_user_type,$systemusers) && checkNotifySettings($this->view->user->agency_user_agency_id,"form-".$formid)){
							$notifyData=array("notification_user_id"=>$this->view->user->agency_user_agency_id,"notification_type"=>"form-".$formid,"notification_type_id"=>$isInserted->inserted_id,"notification_by_user_id"=>$this->view->user->agency_id,"notification_date"=>date("Y-m-d H:i:s"));
							$isNotify=$this->SuperModel->Super_Insert("_uhs_notifications",$notifyData);
						}
						$healthSession->successMsg  = "Incident log has been added successfully.";
						if($posted_data['is_injured']=="Yes"){
							$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_add_reports");
						}
					 }else{
						$healthSession->errorMsg  = $isInserted->message;
					 }
				}
				else{
					$posted_data['inc_modified_by']=$this->view->user->subuser_id;
					$posted_data['inc_modified_on']=date('Y-m-d H:i:s');
					$isInserted = $this->SuperModel->Super_Insert("_uhs_incident_logs",$posted_data,"inc_log_id=".$id);
					if($isInserted->success){
						$healthSession->successMsg  = "Incident log has been updated successfully.";
						if($posted_data['is_injured']=="Yes"){
							$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_add_reports");
						}
					 }else{
						$healthSession->errorMsg  = $isInserted->message;
					 }
				}
				 
   			}else{
				$healthSession->errorMsg = " Please check information again.";
 			}
		 }
		$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_incident_logs");
	}
	
	public function removeincidentlogsAction(){
		global $healthSession;
		$indid=$this->_getParam('indid');
		$formid=$this->_getParam('formid');
 		$this->_helper->layout->disableLayout();
		$this->_helper->viewRenderer->setNoRender(true);
		$formData = $this->getRequest()->getPost();
		if(isset($formData['records']) && count($formData['records'])) {
			foreach($formData['records'] as $key=>$values){
  				$isDel=$this->SuperModel->Super_Delete('_uhs_incident_logs',"inc_log_id=".$values);
 				$healthSession->successMsg="Incident Log(s) has been deleted successfully.";
			}
		}
		else{
			$healthSession->errorMsg = "Invalid Request.";
		}
 		$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_incident_logs");
	} 
	
	// Tornado / Fire Log Form
	public function tornadologsAction(){	
		global $healthSession; 
  		$this->view->pageHeading = "Tornado Drill Logs";
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		if(empty($indid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		$this->view->permissions=$permissions;
		$this->view->indid=$indid;
		$this->view->formid=$formid;
		$this->view->id=$id;
  	}
	
	public function firelogsAction(){	
		global $healthSession; 
  		$this->view->pageHeading = "Fire Drill Logs";
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		$this->view->permissions=$permissions;
		if(empty($indid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		$this->view->indid=$indid;
		$this->view->formid=$formid;
		$this->view->id=$id;
  	}

	public function getdrillsAction(){
		if(check_is_ajax($this->_request)){
			$this->_redirect(APPLICATION_URL);
		}
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		
		$subuser=$dstarts=$dends="";
		if(isset($_REQUEST['subuser']) && !empty($_REQUEST['subuser'])){
			$subuser=$_REQUEST['subuser'];
		}
		if(isset($_REQUEST['dstarts']) && !empty($_REQUEST['dstarts'])){
			$dstarts=$_REQUEST['dstarts'];
		}
		if(isset($_REQUEST['dends']) && !empty($_REQUEST['dends'])){
			$dends=$_REQUEST['dends'];
		}
		if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
			$month=$_REQUEST['month'];
		}
		if(isset($_REQUEST['year']) && !empty($_REQUEST['year'])){
			$year=$_REQUEST['year'];
		}
		
 		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('drill_id','drill_added_user','drill_form_id','drill_service_date','drill_start_time','drill_end_time','drill_participant_names','drill_added_date','drill_comments','drill_modified_by','drill_modified_on');
		$sIndexColumn = 'drill_id';
		$sTable = '_uhs_drills_logs';
		$sLimit = "";
		if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' ){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		if ( isset( $_GET['iSortCol_0'] ) )
		{
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
			{
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
				{
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
		
	if(empty($subuser)){
			$indParentUsers="";
			if($this->view->user->agency_user_type=="Agency"){
                            $systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_id,"fetchAll",array("fields"=>"agency_id"));
                            $systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
                            $indParentUsers=implode_r(",",$systemUsers);
                            if($sWhere){
                                $sWhere.=" and drill_added_user IN(".$indParentUsers.") and drill_form_id='".$formid."' and drill_individual_id='".$indid."'"; 
                            }
                            else{
                                    $sWhere.=" where drill_added_user IN(".$indParentUsers.") and drill_form_id='".$formid."' and drill_individual_id='".$indid."'"; 
                            }
			}
			else{
                            $indParentUsers=$this->view->user->agency_id;
                            if($sWhere){
                                $sWhere.=" and drill_individual_id='".$indid."' and drill_form_id='".$formid."'"; 
                            }
                            else{
                                $sWhere.=" where drill_individual_id='".$indid."' and drill_form_id='".$formid."'"; 
                            }
			}
			
		}
		else{
			if($sWhere){
				$sWhere.=" and drill_added_user IN(".$subuser.") and drill_form_id='".$formid."' and drill_individual_id='".$indid."'"; 
			}
			else{
				$sWhere.=" where drill_added_user IN(".$subuser.") and drill_form_id='".$formid."' and drill_individual_id='".$indid."'"; 
			}
		}
		if(!empty($dstarts)){
			$sWhere.=" and DATE(drill_service_date) >='".$dstarts."'";
		}
		if(!empty($dends)){
			$sWhere.=" and DATE(drill_service_date) <='".$dends."'";
		}
		if(!empty($month)){
			$sWhere.=" and MONTH(drill_service_date)='".$month."'";
		}
		if(!empty($year)){
			$sWhere.=" and YEAR(drill_service_date)='".$year."'";
		}
		if(!empty($id) && $id!=0){
			$sWhere.=" and drill_id=".$id;
		}
		 if(empty($month) && empty($year)){
                    if(!empty($sWhere)){
                            $sWhere.=" and MONTH(drill_added_date)=MONTH(CURDATE()) and YEAR(drill_added_date)=YEAR(CURDATE())";
                    }else{
                            $sWhere.=" where MONTH(drill_added_date)=MONTH(CURDATE()) and YEAR(drill_added_date)=YEAR(CURDATE())";
                    }
                }
		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
 		$qry = $this->dbObj->query($sQuery)->fetchAll();
		$sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
		$output = array(
 				"iTotalRecords" => $iTotal,
				"iTotalDisplayRecords" => $iFilteredTotal,
				"aaData" => array()
			);
		$j=0;
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		foreach($qry as $row1){
			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['drill_added_user']."'","fetch");
			$modifierData=array();
			if($row1['drill_modified_by']!=0){
				$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['drill_modified_by']."'","fetch");
			}
			$row=array();
 			$row[] = $j+1;
			$row[]='<input class="elem_ids checkboxes" type="checkbox" name="records['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';
			$row[]=formatDate($row1['drill_service_date']); 
			$row[]=$row1['drill_start_time'];
			$row[]=$row1['drill_end_time']; 
			$row[]=ucwords($row1['drill_participant_names']); 
			$row[]=$row1['drill_comments']; 
			$userType=printUserType($creatorData);
  			$row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
			$row[]=formatDateTimeNew($row1['drill_added_date']); 
			if(!empty($modifierData)){
				$userType=printUserType($modifierData);
				$row[]=ucwords($row1['agency_first_name']." ".$row1['agency_last_name'])."&nbsp;".$userType;
				$row[]=formatDateTimeNew($row1['drill_modified_on']);
			}
			else{
				$row[]="-";
				$row[]="-";
			}
			if($row1['drill_form_id']==8){
				$type='"TornadoLog"';
			}
			else{
				$type='"FireLog"';
			}
			if(($permissions=="Edit" || $permissions=="Both") && !isFormAssigned($formid,$indid)){
				$row[]="<a style='margin-top:5px;' href='javascript:void(1);' onclick='showDiffrentForms(".$indid.",".$formid.",".$row1[$sIndexColumn].",".$type.");' class='btn btn-xs btn-default'>Edit</a>";
			}
			else{
				$row[]="-";
			}
 			$output['aaData'][] = $row;
			$j++;
		}
		echo json_encode($output);
		exit();
	}
	
	public function savedrillAction(){
		global $healthSession,$systemusers;
		$formid=$this->_getParam("formid");
		$indid=$this->_getParam("indid");
		$type=$this->_getParam("type");
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		if($permissions=="View Only"){
			$healthSession->errorMsg="You don't have permission to access this page.";
			if($type=="TornadoLog"){
				$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_tornado_logs");
			}
			else{
				$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_fire_logs");
			}
		}
		$id=$this->_getParam("id");
		$form=new Application_Form_CustomForms();
		$form->drillLog($indid,$formid,$type,$id);
		$msgText="";
		if($type=="TornadoLog"){ $msgText="Tornado";}else{$msgText="Fire";}
		if($this->getRequest()->isPost()){
			$posted_data = $this->getRequest()->getPost();
   			if($form->isValid($posted_data)){
				$posted_data['drill_service_date']=date("Y-m-d",strtotime($posted_data['drill_service_date']));
				if(empty($id)){
					 $indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
					 $agencyData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indData['agency_user_agency_id']);
					 $posted_data['drill_agency_id']=$agencyData['agency_id'];
					 $posted_data['drill_individual_id']=$indid;
					 $posted_data['drill_form_id']=$formid;
					 $posted_data['drill_added_date']=date('Y-m-d H:i:s');
					 $posted_data['drill_added_user']=$this->view->user->subuser_id; //$this->view->user->agency_id;
					 $isInserted = $this->SuperModel->Super_Insert("_uhs_drills_logs",$posted_data);
					 if($isInserted->success){
						if(in_array($this->view->user->agency_user_type,$systemusers) && checkNotifySettings($this->view->user->agency_user_agency_id,"form-".$formid)){
							$notifyData=array("notification_user_id"=>$this->view->user->agency_user_agency_id,"notification_type"=>"form-".$formid,"notification_type_id"=>$isInserted->inserted_id,"notification_by_user_id"=>$this->view->user->agency_id,"notification_date"=>date("Y-m-d H:i:s"));
							$isNotify=$this->SuperModel->Super_Insert("_uhs_notifications",$notifyData);
						}
						$healthSession->successMsg  = $msgText." log has been added successfully.";
					 }else{
						$healthSession->errorMsg  = $isInserted->message;
					 }
				}
				else{
					$posted_data['drill_modified_by']=$this->view->user->subuser_id;
					$posted_data['drill_modified_on']=date('Y-m-d H:i:s');
					$isInserted = $this->SuperModel->Super_Insert("_uhs_drills_logs",$posted_data,"drill_id=".$id);
					if($isInserted->success){
						$healthSession->successMsg  = $msgText." log has been updated successfully.";
					 }else{
						$healthSession->errorMsg  = $isInserted->message;
					 }
				}
				 
   			}else{
				$healthSession->errorMsg = " Please check information again.";
 			}
		 }
		if($type=="TornadoLog"){
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_tornado_logs");
		}
		else{
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_fire_logs");
		}
	}
	
	public function removedrillAction(){
		global $healthSession;
		$indid=$this->_getParam('indid');
		$formid=$this->_getParam('formid');
		$type=$this->_getParam("type");
 		$this->_helper->layout->disableLayout();
		$this->_helper->viewRenderer->setNoRender(true);
		$formData = $this->getRequest()->getPost();
		if(isset($formData['records']) && count($formData['records'])) {
			foreach($formData['records'] as $key=>$values){
  				$isDel=$this->SuperModel->Super_Delete('_uhs_drills_logs',"drill_id=".$values);
 				$healthSession->successMsg=$type." Drill Log(s) has been deleted successfully.";
			}
		}
		else{
			$healthSession->errorMsg = "Invalid Request.";
		}
		if($type=="Tornado"){
 			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_tornado_logs");
		}
		else{
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_fire_logs");
		}
	} 
	
	// Intake Form
	public function intakelogsAction(){	
		global $healthSession; 
  		$this->view->pageHeading = "Food Intake Logs";
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		$this->view->permissions=$permissions;
		if(empty($indid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		$this->view->indid=$indid;
		$this->view->id=$id;
		$this->view->formid=$formid;
  	}
	
	public function getintakeAction(){
		if(check_is_ajax($this->_request)){
			$this->_redirect(APPLICATION_URL);
		}
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		
		$subuser=$dstarts=$dends="";
		if(isset($_REQUEST['subuser']) && !empty($_REQUEST['subuser'])){
			$subuser=$_REQUEST['subuser'];
		}
		if(isset($_REQUEST['dstarts']) && !empty($_REQUEST['dstarts'])){
			$dstarts=$_REQUEST['dstarts'];
		}
		if(isset($_REQUEST['dends']) && !empty($_REQUEST['dends'])){
			$dends=$_REQUEST['dends'];
		}
		if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
			$month=$_REQUEST['month'];
		}
		if(isset($_REQUEST['year']) && !empty($_REQUEST['year'])){
			$year=$_REQUEST['year'];
		}
		
 		$this->dbObj = Zend_Registry::get('db');
	$aColumns = array('intake_id','intake_added_user','intake_service_date','intake_service_time','intake_meal_category','intake_percentage','intake_meal_desc','intake_comments','intake_added_date','intake_modified_by','intake_modified_on' , 'intake_cabra_count', 'intake_ounces');
			


		$sIndexColumn = 'intake_id';
		$sTable = '_uhs_intake_logs';
		$sLimit = "";
		if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' ){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		if ( isset( $_GET['iSortCol_0'] ) )
		{
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
			{
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
				{
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
		
	if(empty($subuser)){
			$indParentUsers="";
			if($this->view->user->agency_user_type=="Agency"){
				$systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_id,"fetchAll",array("fields"=>"agency_id"));
				$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
				$indParentUsers=implode_r(",",$systemUsers);
                                if($sWhere){
                                    $sWhere.=" and intake_added_user IN(".$indParentUsers.") and intake_individual_id='".$indid."'"; 
                                }
                                else{
                                    $sWhere.=" where intake_added_user IN(".$indParentUsers.") and intake_individual_id='".$indid."'"; 
                                }
			}
			else{
				$indParentUsers=$this->view->user->agency_id;
                                if($sWhere){
                                    $sWhere.=" and intake_individual_id='".$indid."'"; 
                                }
                                else{
                                    $sWhere.=" where intake_individual_id='".$indid."'"; 
                                }
			}
			
		}
		else{
			if($sWhere){
				$sWhere.=" and intake_added_user IN(".$subuser.") and intake_individual_id='".$indid."'"; 
			}
			else{
				$sWhere.=" where intake_added_user IN(".$subuser.") and intake_individual_id='".$indid."'"; 
			}
		}
		if(!empty($dstarts)){
			$sWhere.=" and DATE(intake_service_date) >='".$dstarts."'";
		}
		if(!empty($dends)){
			$sWhere.=" and DATE(intake_service_date) <='".$dends."'";
		}
		if(!empty($month)){
			$sWhere.=" and MONTH(intake_service_date)='".$month."'";
		}
		if(!empty($year)){
			$sWhere.=" and YEAR(intake_service_date)='".$year."'";
		}
		if(!empty($id) && $id!=0){
			$sWhere.=" and intake_id=".$id;
		}
		if(empty($month) && empty($year)){
                    if(!empty($sWhere)){
                            $sWhere.=" and MONTH(intake_added_date)=MONTH(CURDATE()) and YEAR(intake_added_date)=YEAR(CURDATE())";
                    }else{
                            $sWhere.=" where MONTH(intake_added_date)=MONTH(CURDATE()) and YEAR(intake_added_date)=YEAR(CURDATE())";
                    }
                }
		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
 		$qry = $this->dbObj->query($sQuery)->fetchAll();
		$sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
		$output = array(
 				"iTotalRecords" => $iTotal,
				"iTotalDisplayRecords" => $iFilteredTotal,
				"aaData" => array()
			);
		$j=0;
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		foreach($qry as $row1){
			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['intake_added_user']."'","fetch");
			$modifierData=array();
			if($row1['intake_modified_by']!=0){
				$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['intake_modified_by']."'","fetch");
			}
			$row=array();
 			$row[] = $j+1;
			$row[]='<input class="elem_ids checkboxes" type="checkbox" name="records['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';
			$row[]=formatDate($row1['intake_service_date']);  
			$row[]=$row1['intake_service_time'];
			$row[]=ucwords($row1['intake_meal_category']); 
			$row[]=$row1['intake_percentage']; 
			$row[]=$row1['intake_meal_desc'];
			$row[]=isEmpty($row1['intake_comments']);
			$userType=printUserType($creatorData);
  			$row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
			$row[]=formatDateTimeNew($row1['intake_added_date']);
			if(!empty($modifierData)){
				$userType=printUserType($modifierData);
				$row[]=ucwords($modifierData['agency_first_name']." ".$modifierData['agency_last_name'])."&nbsp;".$userType;
				$row[]=formatDateTimeNew($row1['intake_modified_on']);
			}else{
				$row[]="-";
				$row[]="-";
			}

			$row[]=$row1['intake_ounces'];
			$row[]=$row1['intake_cabra_count'];

			$type='"IntakeLog"';
			if(($permissions=="Edit" || $permissions=="Both") && !isFormAssigned($formid,$indid)){
				$row[]="<a style='margin-top:5px;' href='javascript:void(1);' onclick='showDiffrentForms(".$indid.",".$formid.",".$row1[$sIndexColumn].",".$type.");' class='btn btn-xs btn-default'>Edit</a>";
			}
			else{
				$row[]="-";
			}
 			$output['aaData'][] = $row;
			$j++;
		}
		echo json_encode($output);
		exit();
	}
	
	public function saveintakeAction(){
		global $healthSession,$systemusers;
		$formid=$this->_getParam("formid");
		$indid=$this->_getParam("indid");
		$id=$this->_getParam("id");
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		if($permissions=="View Only"){
			$healthSession->errorMsg="You don't have permission to access this page.";
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_intake_logs");
		}
		$form=new Application_Form_CustomForms();
		$form->intakeLog($indid,$formid,$id);
		if($this->getRequest()->isPost()){
			$posted_data = $this->getRequest()->getPost();
   			if($form->isValid($posted_data)){
				$posted_data['intake_service_date']=date("Y-m-d",strtotime($posted_data['intake_service_date']));
				if(empty($id)){
					 $indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
					 $agencyData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indData['agency_user_agency_id']);
					 $posted_data['intake_agency_id']=$agencyData['agency_id'];
					 $posted_data['intake_individual_id']=$indid;
					 $posted_data['intake_form_id']=$formid;
					 $posted_data['intake_added_date']=date('Y-m-d H:i:s');
					 $posted_data['intake_added_user']=$this->view->user->subuser_id;
					 $isInserted = $this->SuperModel->Super_Insert("_uhs_intake_logs",$posted_data);
					 if($isInserted->success){
						if(in_array($this->view->user->agency_user_type,$systemusers) && checkNotifySettings($this->view->user->agency_user_agency_id,"form-".$formid)){
							$notifyData=array("notification_user_id"=>$this->view->user->agency_user_agency_id,"notification_type"=>"form-".$formid,"notification_type_id"=>$isInserted->inserted_id,"notification_by_user_id"=>$this->view->user->agency_id,"notification_date"=>date("Y-m-d H:i:s"));
							$isNotify=$this->SuperModel->Super_Insert("_uhs_notifications",$notifyData);
						}
						$healthSession->successMsg  = "Food Intake log has been added successfully.";
					 }else{
						$healthSession->errorMsg  = $isInserted->message;
					 }
				}
				else{
					$posted_data['intake_modified_by']=$this->view->user->subuser_id;
					$posted_data['intake_modified_on']=date('Y-m-d H:i:s');
					$isInserted = $this->SuperModel->Super_Insert("_uhs_intake_logs",$posted_data,"intake_id=".$id);
					if($isInserted->success){
						$healthSession->successMsg  =" Food Intake log has been updated successfully.";
					 }else{
						$healthSession->errorMsg  = $isInserted->message;
					 }
				}
				 
   			}else{
				$healthSession->errorMsg = " Please check information again.";
 			}
		 }
		 $this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_intake_logs");
	}
	
	public function removeintakelogsAction(){
		global $healthSession;
		$indid=$this->_getParam('indid');
		$formid=$this->_getParam('formid');
 		$this->_helper->layout->disableLayout();
		$this->_helper->viewRenderer->setNoRender(true);
		$formData = $this->getRequest()->getPost();
		if(isset($formData['records']) && count($formData['records'])) {
			foreach($formData['records'] as $key=>$values){
  				$isDel=$this->SuperModel->Super_Delete('_uhs_intake_logs',"intake_id=".$values);
 				$healthSession->successMsg=" Food Intake Log(s) has been deleted successfully.";
			}
		}
		else{
			$healthSession->errorMsg = "Invalid Request.";
		}
		$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_intake_logs");
	}
	
	// Shift Summary Form
	public function shiftsummaryAction(){	
		global $healthSession; 
  		$this->view->pageHeading = "Shift Summary";
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		$page=$this->_getParam("page");
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		$this->view->permissions=$permissions;
		if(empty($indid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		$where="";
		if(!empty($id) && $id!=0){
			$where=" and shift_id=".$id;
		}
		$shiftData=$this->SuperModel->Super_Get("_uhs_shift_summary","shift_individual_id=".$indid." and shift_form_id=".$formid.$where,"fetchAll",array("order"=>"shift_id DESC"));
		$paginator = Zend_Paginator::factory($shiftData);
	    $paginator->setItemCountPerPage(10);
   		$paginator->setCurrentPageNumber($page);
		$this->view->paginator=$paginator;
		$this->view->page=$page;
		$this->view->indid=$indid;
		$this->view->formid=$formid;
		$this->view->id=$id;
		$this->view->ajax = 0;
        $this->view->url = 'listing';
  	}
	
	public function getshiftsAction(){
	    $this->_helper->layout->disableLayout();
		global $healthSession;
		$page=$_REQUEST['page'];
		$formid=$_REQUEST['formid'];
		$indid=$this->_getParam('indid');
		$id=$this->_getParam('id');
		$subuser=$_REQUEST['sub_user'];
		$month=$_REQUEST['months'];
		$year=$_REQUEST['years'];
		$dstarts=$_REQUEST['dstarts'];
		$dends=$_REQUEST['dends'];
		$where="shift_individual_id=".$indid." and shift_form_id=".$formid; 
		if(!empty($subuser)){
			$where.=" and shift_added_user IN(".$subuser.")"; 
		}
		if(!empty($dstarts)){
			$where.=" and DATE(shift_added_date)>='".$dstarts."'";
		}
		if(!empty($dends)){
			$where.=" and DATE(shift_added_date)<='".$dends."'";
		}
		if(!empty($month)){
			$where.=" and MONTH(shift_added_date)='".$month."'";
		}
		if(!empty($year)){
			$where.=" and YEAR(shift_added_date)='".$year."'";
		}
		if(!empty($id) && $id!=0){
			$where.=" and shift_id=".$id;
		}
		$shiftData=$this->SuperModel->Super_Get("_uhs_shift_summary",$where,"fetchAll",array("order"=>"shift_id DESC"));
		$paginator = Zend_Paginator::factory($shiftData);
	    $paginator->setItemCountPerPage(10);
   		$paginator->setCurrentPageNumber($page);
		$this->view->paginator=$paginator;
		$this->view->page=$page;
		$this->view->indid=$indid;
		$this->view->formid=$formid;
		$this->view->ajax = 1;
        $this->view->url = "";
		$this->_helper->getHelper('viewRenderer')->renderScript('layouts/_shift_listing.phtml');
	}
	
	public function saveshiftAction(){
		global $healthSession,$systemusers;
		$formid=$this->_getParam("formid");
		$indid=$this->_getParam("indid");
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		if($permissions=="View Only"){
			$healthSession->errorMsg="You don't have permission to access this page.";
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_shift_logs");
		}
		$id=$this->_getParam("id");
		$form=new Application_Form_CustomForms();
		$form->shiftSummary($indid,$formid,$id);
		if($this->getRequest()->isPost()){
			$posted_data = $this->getRequest()->getPost();
   			if($form->isValid($posted_data)){
				$posted_data['shift_notes']=strip_tags($posted_data['shift_notes'],"<br>");
				if(empty($id)){
					 $indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
					 $agencyData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indData['agency_user_agency_id']);
					 $posted_data['shift_agency_id']=$agencyData['agency_id'];
					 $posted_data['shift_individual_id']=$indid;
					 $posted_data['shift_form_id']=$formid;
					 $posted_data['shift_added_date']=date('Y-m-d H:i:s');
					 $posted_data['shift_added_user']=$this->view->user->subuser_id; //$this->view->user->agency_id;
					 $isInserted = $this->SuperModel->Super_Insert("_uhs_shift_summary",$posted_data);
					 if($isInserted->success){
						if(in_array($this->view->user->agency_user_type,$systemusers) && checkNotifySettings($this->view->user->agency_user_agency_id,"form-".$formid)){
							$notifyData=array("notification_user_id"=>$this->view->user->agency_user_agency_id,"notification_type"=>"form-".$formid,"notification_type_id"=>$isInserted->inserted_id,"notification_by_user_id"=>$this->view->user->agency_id,"notification_date"=>date("Y-m-d H:i:s"));
							$isNotify=$this->SuperModel->Super_Insert("_uhs_notifications",$notifyData);
						}
						$healthSession->successMsg  = "Shift summary has been added successfully.";
					 }else{
						$healthSession->errorMsg  = $isInserted->message;
					 }
				}
				else{
					$posted_data['shift_added_date']=date('Y-m-d H:i:s');
					$isInserted = $this->SuperModel->Super_Insert("_uhs_shift_summary",$posted_data,"shift_id=".$id);
					if($isInserted->success){
						$healthSession->successMsg  =" Shift Summary has been updated successfully.";
					 }else{
						$healthSession->errorMsg  = $isInserted->message;
					 }
				}
				 
   			}else{
				$healthSession->errorMsg = " Please check information again.";
 			}
		 }
		 $this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_shift_logs");
	}
	
	public function removeshiftsAction(){
		global $healthSession;
		$indid=$this->_getParam('indid');
		$formid=$this->_getParam('formid');
		$shiftid=$this->_getParam('shiftid');
		if(empty($shiftid)){
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_shift_logs");
		}
 		$this->_helper->layout->disableLayout();
		$this->_helper->viewRenderer->setNoRender(true);
		$isDel=$this->SuperModel->Super_Delete('_uhs_shift_summary',"shift_id=".$shiftid);
 		$healthSession->successMsg=" Shift Summary Note has been deleted successfully.";
		$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_shift_logs");
	}
	
	public function viewshiftAction(){
		global $healthSession;
		$id=$_REQUEST['val'];
		$shiftData=$this->SuperModel->Super_Get("_uhs_shift_summary","shift_id=".$id,"fetch");
		$this->view->shiftData=$shiftData;
	}
	
	// Time Sheet Form
	public function timingsheetsAction(){	
		global $healthSession; 
  		$this->view->pageHeading = "Time Sheet";
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		if(empty($indid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		$this->view->permissions=$permissions;
		$this->view->indid=$indid;
		$this->view->formid=$formid;
		$this->view->id=$id;
  	}
	
	public function gettimingsheetsAction(){
		if(check_is_ajax($this->_request)){
			$this->_redirect(APPLICATION_URL);
		}
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		$subuser=$dstarts=$dends=$wcode="";
		if(isset($_REQUEST['subuser']) && !empty($_REQUEST['subuser'])){
			$subuser=$_REQUEST['subuser'];
		}
		if(isset($_REQUEST['dstarts']) && !empty($_REQUEST['dstarts'])){
			$dstarts=$_REQUEST['dstarts'];
			//$dstarts = date("Y-m-d", strtotime($_REQUEST['dstarts']));
		}
		if(isset($_REQUEST['dends']) && !empty($_REQUEST['dends'])){
			$dends=$_REQUEST['dends'];
			//$dends = date("Y-m-d", strtotime($_REQUEST['dends']));
		}	
		if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
			$month=$_REQUEST['month'];
		}
		if(isset($_REQUEST['year']) && !empty($_REQUEST['year'])){
			$year=$_REQUEST['year'];
		}	
		if(isset($_REQUEST['wcode']) && !empty($_REQUEST['wcode'])){
			$wcode=$_REQUEST['wcode'];
		}	
 		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('sheet_id','service_added_user','service_date','service_start_time','service_end_time','service_work_code','service_total_hours','total_miles_used','sheet_added_date','is_sheet_completed','service_other_work_code','sheet_modified_by','sheet_modified_on');
		$sIndexColumn = 'sheet_id';
		$sTable = '_uhs_timing_sheets';
		$sLimit = "";
		if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' ){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		
		if ( isset( $_GET['iSortCol_0'] ) )
		{
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
			{
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
				{
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		
		$sWhere = "";
		
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
		
		if(empty($subuser)){
			
                    $indParentUsers="";
                    if($this->view->user->agency_user_type=="Agency"){
			$systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_id,"fetchAll",array("fields"=>"agency_id"));
			$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
			$indParentUsers=implode_r(",",$systemUsers);
                        
                        if($sWhere){
				$sWhere.=" and service_added_user IN(".$indParentUsers.") and service_individual_id='".$indid."'"; 
			}
			else{
				$sWhere.=" where service_added_user IN(".$indParentUsers.") and service_individual_id='".$indid."'"; 
			}
                    }
                    else {
			$indParentUsers=$this->view->user->agency_id;
                        if($sWhere){
				$sWhere.=" and service_individual_id='".$indid."'"; 
			}
			else{
				$sWhere.=" where service_individual_id='".$indid."'"; 
			}
                    }
		}
		else{
			if($sWhere){
				$sWhere.=" and service_added_user IN(".$subuser.") and service_individual_id='".$indid."'"; 
			}
			else{
				$sWhere.=" where service_added_user IN(".$subuser.") and service_individual_id='".$indid."'"; 
			}
		}
		if(!empty($wcode)){
			$sWhere.=" and service_work_code='".$wcode."'";
		}
		if(!empty($dstarts)){
			$sWhere.=" and DATE(service_date) >='".$dstarts."'";
		}
		if(!empty($dends)){
			$sWhere.=" and DATE(service_date) <='".$dends."'";
		}
		if(!empty($month)){
			$sWhere.=" and MONTH(service_date)='".$month."'";
		}
		if(!empty($year)){
			$sWhere.=" and YEAR(service_date)='".$year."'";
		}
		if(!empty($id) && $id!=0){
			$sWhere.=" and sheet_id=".$id;
		}
		if(empty($month) && empty($year)){
                    if(!empty($sWhere)){
                    	if(empty($dstarts) && empty($dends)){
                            $sWhere.=" and MONTH(sheet_added_date)=MONTH(CURDATE()) and YEAR(sheet_added_date)=YEAR(CURDATE())";
                        }
                    }else{
                        $sWhere.=" where MONTH(sheet_added_date)=MONTH(CURDATE()) and YEAR(sheet_added_date)=YEAR(CURDATE())";
                    }
                }
		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
 		$qry = $this->dbObj->query($sQuery)->fetchAll();
		$sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
		$output = array(
 				"iTotalRecords" => $iTotal,
				"iTotalDisplayRecords" => $iFilteredTotal,
				"aaData" => array()
			);
		$j=0;
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		foreach($qry as $row1){
			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['service_added_user']."'","fetch");
			$modifierData=array();
			if($row1['sheet_modified_by']!=0){
				$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['sheet_modified_by']."'","fetch");
			}
			$row=array();
 			$row[] = $j+1;
			$row[]='<input class="elem_ids checkboxes" type="checkbox" name="records['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';
			$row[]=formatDate($row1['service_date']);
			if($row1['service_work_code']=="Other"){
				$row[]=ucwords($row1['service_work_code']."-".$row1['service_other_work_code']);
			}
			else{
				$row[]=ucwords($row1['service_work_code']);
			}
			$row[]=$row1['service_start_time'];
			$row[]=isEmpty($row1['service_end_time'],"-"); 
		    $row[]=isEmpty($row1['service_total_hours'],"-");
			$row[]=round($row1['total_miles_used'],2);
			$userType=printUserType($creatorData);
  			$row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
			$row[]=formatDateTimeNew($row1['sheet_added_date']); 
			
			if(!empty($modifierData)){
				$userType=printUserType($modifierData);
				$row[]=ucwords($modifierData['agency_first_name']." ".$modifierData['agency_last_name'])."&nbsp;".$userType;
				$row[]=formatDateTime($row1['sheet_modified_on']);
			}
			else{
				$row[]="-";
				$row[]="-";
			}
			$type='"TimingSheet"';
			$cStatus="";$editLink="NA";
			if($row1['is_sheet_completed']=='0'){
				//$cStatus="<br/><span style='margin-top:5px;' class='badge badge-danger'>Not Completed</span>";
				$cStatus="<br/><span style='margin-top:5px;' class='badge badge-danger'>Not Completed</span>";
				if(($permissions=="Edit" || $permissions=="Both") && !isFormAssigned($formid,$indid) && $row1['service_added_user']==$this->view->user->agency_id){
					$editLink="<a style='margin-top:5px;' href='javascript:void(1);' onclick='showDiffrentForms(".$indid.",".$formid.",".$row1[$sIndexColumn].",".$type.");' class='btn btn-xs btn-default'>Edit</a>";
				}
				if($this->view->user->agency_user_type=="Agency"){
					$editLink="<a style='margin-top:5px;' href='javascript:void(1);' onclick='showDiffrentForms(".$indid.",".$formid.",".$row1[$sIndexColumn].",".$type.");' class='btn btn-xs btn-default'>Edit</a>";
				}
		    }else{
				$cStatus="<br/><span style='margin-top:5px;' class='badges badge badge-success'>Completed</span>";
				if(($permissions=="Edit" || $permissions=="Both") && !isFormAssigned($formid,$indid) && $row1['service_added_user']==$this->view->user->agency_id){
					$editLink="<a style='margin-top:5px;' href='javascript:void(1);' onclick='showDiffrentForms(".$indid.",".$formid.",".$row1[$sIndexColumn].",".$type.");' class='btn btn-xs btn-default'>Edit</a>";
				}
					if($this->view->user->agency_user_type=="Agency"){
					  $editLink="<a style='margin-top:5px;' href='javascript:void(1);' onclick='showDiffrentForms(".$indid.",".$formid.",".$row1[$sIndexColumn].",".$type.");' class='btn btn-xs btn-default'>Edit</a>";
				    }
			}
			//~ if($this->view->user->agency_user_type=="Agency" && !isFormAssigned($formid,$indid)){
				//~ $editLink="<a style='margin-top:5px;' href='javascript:void(1);' onclick='showDiffrentForms(".$indid.",".$formid.",".$row1[$sIndexColumn].",".$type.");' class='btn btn-xs btn-default'>Clocked Out</a>";
			//~ }
			$row[]=$editLink.$cStatus;
 			$output['aaData'][] = $row;
			$j++;
		}
		echo json_encode($output);
		exit();
	}
	
	public function savetimingsheetAction(){
		global $healthSession,$systemusers;
		$formid=$this->_getParam("formid");
		$indid=$this->_getParam("indid");
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		if($permissions=="View Only"){
			$healthSession->errorMsg="You don't have permission to access this page";
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_timing_sheets");
		}
		$id=$this->_getParam("id");
		$form=new Application_Form_CustomForms();
		$form->timingSheets($indid,$formid,$id);
		if($this->getRequest()->isPost()){
			$posted_data = $this->getRequest()->getPost();
   			if($form->isValid($posted_data)){
				$posted_data['service_date']=date("Y-m-d",strtotime($posted_data['service_date']));
				if(empty($id)){
					 $indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
					 $agencyData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indData['agency_user_agency_id']);
					 $posted_data['service_agency_id']=$agencyData['agency_id'];
					 $posted_data['service_individual_id']=$indid;
					 $posted_data['service_form_id']=$formid;
					 $posted_data['sheet_added_date']=date('Y-m-d H:i:s');
					 $posted_data['service_added_user']=$this->view->user->subuser_id; //$this->view->user->agency_id;
					 $isAlreadyTimeExist=$this->SuperModel->Super_Get("_uhs_timing_sheets","service_individual_id=".$indid." and service_start_time='".$posted_data['service_start_time']."' and service_date='".$posted_data['service_date']."'");
					if(empty($isAlreadyTimeExist)){
					 	$isInserted = $this->SuperModel->Super_Insert("_uhs_timing_sheets",$posted_data);
						 if($isInserted->success){
							if(in_array($this->view->user->agency_user_type,$systemusers) && checkNotifySettings($this->view->user->agency_user_agency_id,"form-".$formid)){
								$notifyData=array("notification_user_id"=>$this->view->user->agency_user_agency_id,"notification_type"=>"form-".$formid,"notification_type_id"=>$isInserted->inserted_id,"notification_by_user_id"=>$this->view->user->agency_id,"notification_date"=>date("Y-m-d H:i:s"));
								$isNotify=$this->SuperModel->Super_Insert("_uhs_notifications",$notifyData);
							}
							$healthSession->successMsg="Time sheet has been added successfully.";
						 }else{
							$healthSession->errorMsg=$isInserted->message;
						 }
					}
					else{
						$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$isAlreadyTimeExist['service_added_user'],"fetch");
						if($creatorData['agency_id']!=$this->view->user->agency_id){
							$healthSession->errorMsg=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])." has already selected this time.";
						}
						else{
							$healthSession->errorMsg="You have already selected this time.";
						}
					}
				}
				else{
					$posted_data['is_sheet_completed']='1';
					$posted_data['sheet_modified_by']=$this->view->user->subuser_id;
					$posted_data['sheet_modified_on']=date('Y-m-d H:i:s');
					$isAlreadyTimeExist=$this->SuperModel->Super_Get("_uhs_timing_sheets","service_individual_id=".$indid." and service_start_time='".$posted_data['service_start_time']."' and service_date='".$posted_data['service_date']."' and sheet_id!=".$id);
					if(empty($isAlreadyTimeExist)){
						$isInserted = $this->SuperModel->Super_Insert("_uhs_timing_sheets",$posted_data,"sheet_id=".$id);
						if($isInserted->success){
							$healthSession->successMsg="Time sheet has been updated successfully.";
						 }else{
							$healthSession->errorMsg=$isInserted->message;
						 }
					}else{
						$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$isAlreadyTimeExist['service_added_user'],"fetch");
						if($creatorData['agency_id']!=$this->view->user->agency_id){
							$healthSession->errorMsg=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])." has already selected this time.";
						}
						else{
							$healthSession->errorMsg="You have already selected this time.";
						}
					}
				}
				 
   			}else{
				$healthSession->errorMsg="Please check information again.";
 			}
		 }
		 $this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_timing_sheets");
	}
	
	public function removetimingsheetsAction(){
		global $healthSession;
		$indid=$this->_getParam('indid');
		$formid=$this->_getParam('formid');
 		$this->_helper->layout->disableLayout();
		$this->_helper->viewRenderer->setNoRender(true);
		$formData = $this->getRequest()->getPost();
		if(isset($formData['records']) && count($formData['records'])) {
			foreach($formData['records'] as $key=>$values){
  				$isDel=$this->SuperModel->Super_Delete('_uhs_timing_sheets',"sheet_id=".$values);
 				$healthSession->successMsg=" Time Sheet(s) has been deleted successfully.";
			}
		}
		else{
			$healthSession->errorMsg = "Invalid Request.";
		}
		$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_timing_sheets");
	}
	
	// Mileage Log Form
	public function mileageAction(){	
		global $healthSession; 
  		$this->view->pageHeading = "Mileage Log";
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		if(empty($indid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		$getAssignedMileage=$this->SuperModel->Super_Get("_uhs_assigned_miles","m_form_id='".$formid."' and m_individual_id='".$indid."' and MONTH(miles_added_date)=MONTH(CURDATE())","fetch",array("order"=>"mid DESC"));
		$this->view->permissions=$permissions;
		$this->view->indid=$indid;
		$this->view->formid=$formid;
		$this->view->id=$id;
		$this->view->getAssignedMileage=$getAssignedMileage;
  	}
	
public function getmileagerecordsAction(){
		if(check_is_ajax($this->_request)){
			$this->_redirect(APPLICATION_URL);
		}
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		$subuser=$dstarts=$dends=$wcode="";
		if(isset($_REQUEST['subuser']) && !empty($_REQUEST['subuser'])){
			$subuser=$_REQUEST['subuser'];
		}
		if(isset($_REQUEST['dstarts']) && !empty($_REQUEST['dstarts'])){
			$dstarts=$_REQUEST['dstarts'];
		}
		if(isset($_REQUEST['dends']) && !empty($_REQUEST['dends'])){
			$dends=$_REQUEST['dends'];
		}
		if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
			$month=$_REQUEST['month'];
		}
		if(isset($_REQUEST['year']) && !empty($_REQUEST['year'])){
			$year=$_REQUEST['year'];
		}	
 		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('mlog_id','mlog_added_user','mlog_service_date','mlog_from_location','mlog_to_location','mlog_total_miles','mlog_activity_description','mlog_added_date','mlog_from_latitude','mlog_from_longitude','mlog_to_latitude','mlog_to_longitude','mlog_starting_mileage','mlog_remaining_mileage','mlog_modified','mlog_ending_mileage','mlog_modified_by','mlog_modified','chosse_your_trip','mlog_to_location1','mlog_to_location2','mlog_to_location3','mlog_to_latitude1','mlog_to_latitude2','mlog_to_latitude3','mlog_to_latitude4','mlog_to_latitude5','mlog_to_latitude6','mlog_to_latitude7','mlog_to_longitude1','mlog_to_longitude2','mlog_to_longitude3','mlog_to_longitude4','mlog_to_longitude5','mlog_to_longitude6','mlog_to_longitude7');
		$sIndexColumn = 'mlog_id';
		$sTable = '_uhs_mileage_logs';
		$sLimit = "";
		if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' ){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		if ( isset( $_GET['iSortCol_0'] ) )
		{
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
			{
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
				{
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
		if(empty($subuser)){
			$indParentUsers="";
			if($this->view->user->agency_user_type=="Agency"){
				$systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_id,"fetchAll",array("fields"=>"agency_id"));
				$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
				$indParentUsers=implode_r(",",$systemUsers);
                                if($sWhere){
                                    $sWhere.=" and mlog_added_user IN(".$indParentUsers.") and mlog_individual_id='".$indid."'"; 
                                }
                                else{
                                    $sWhere.=" where mlog_added_user IN(".$indParentUsers.") and mlog_individual_id='".$indid."'"; 
                                }
			}
			else{
                            $indParentUsers=$this->view->user->agency_id;
                            if($sWhere){
                                $sWhere.=" and mlog_individual_id='".$indid."'";
                            }
                            else{
                                $sWhere.=" where mlog_individual_id='".$indid."'"; 
                            }
			}
		}
		else{
			if($sWhere){
                            $sWhere.=" and mlog_added_user IN(".$subuser.") and mlog_individual_id='".$indid."'"; 
                        }
			else{
                            $sWhere.=" where mlog_added_user IN(".$subuser.") and mlog_individual_id='".$indid."'";
                        }
		}
		if(!empty($dstarts)){
			$sWhere.=" and DATE(mlog_service_date) >='".$dstarts."'";
		}
		if(!empty($dends)){
			$sWhere.=" and DATE(mlog_service_date) <='".$dends."'";
		}
		if(!empty($month)){
			$sWhere.=" and MONTH(mlog_service_date)='".$month."'";
		}
		if(!empty($year)){
			$sWhere.=" and YEAR(mlog_service_date)='".$year."'";
		}
		if(!empty($id) && $id!=0){
			$sWhere.=" and mlog_id=".$id;
		}
		if(empty($month) && empty($year)){
                    if(!empty($sWhere)){
                        $sWhere.=" and MONTH(mlog_added_date)=MONTH(CURDATE()) and YEAR(mlog_added_date)=YEAR(CURDATE())";
                    }else{
                        $sWhere.=" where MONTH(mlog_added_date)=MONTH(CURDATE()) and YEAR(mlog_added_date)=YEAR(CURDATE())";
                    }
                }
		/*if(empty($sOrder)){
			$sOrder.="order by mlog_added_date DESC, mlog_modified DESC";
		}*/
		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";

 		$qry = $this->dbObj->query($sQuery)->fetchAll();
		$sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
		$output = array(
 				"iTotalRecords" => $iTotal,
				"iTotalDisplayRecords" => $iFilteredTotal,
				"aaData" => array()
			);
		$j=0;
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		foreach($qry as $row1){
			
			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['mlog_added_user']."'","fetch");
			$modifierData=array();
			if($row1['mlog_modified_by']!=0){
				$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['mlog_modified_by']."'","fetch");
			}
			$row=array();
 			$row[] = $j+1;
			$row[]='<input class="elem_ids checkboxes" type="checkbox" name="records['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';
			$row[]=formatDate($row1['mlog_service_date']); 
			$Flat="'".$row1['mlog_from_latitude']."'";
			$Flong="'".$row1['mlog_from_longitude']."'";
			$From="'".trim(preg_replace('/\s\s+/', ' ',$row1['mlog_from_location']))."'";
			$row[]=ucwords($row1['mlog_from_location']).'<i class="fa fa-map-marker markers pull-right" title="View Address on Map" onclick="showMap('.$Flat.','.$Flong.','.$From.');"></i>';
			
			if($row1['chosse_your_trip'] == 1 || $row1['chosse_your_trip'] == 2 || $row1['chosse_your_trip'] == 0){
				$Tlat="'".$row1['mlog_to_latitude']."'";
				$Tlong="'".$row1['mlog_to_longitude']."'";
				$To="'".trim(preg_replace('/\s\s+/', ' ',$row1['mlog_to_location']))."'";
				$row[]=ucwords($row1['mlog_to_location']).'<i class="fa fa-map-marker markers pull-right" title="View Address on Map" onclick="showMap('.$Tlat.','.$Tlong.','.$To.');"></i>';
				$row[]=ucwords($row1['mlog_to_location']).'<i class="fa fa-map-marker markers" style="padding-left:10px;" title="View Address on Map" onclick="showMap('.$Tlat.','.$Tlong.','.$To.');"></i>';
			} elseif($row1['chosse_your_trip'] == 3){
				$Tlat1="'".$row1['mlog_to_latitude1']."'";
				$Tlong1="'".$row1['mlog_to_longitude1']."'";
				$To1="'".trim(preg_replace('/\s\s+/', ' ',$row1['mlog_to_location1']))."'";
				$row[]= ucwords($row1['mlog_to_location1']).'<i class="fa fa-map-marker markers pull-right" title="View Address on Map" onclick="showMap('.$Tlat1.','.$Tlong1.','.$To1.');"></i>';
				
				$loc1=ucwords($row1['mlog_to_location1']).'<i class="fa fa-map-marker markers" style="padding-left:10px;" title="View Address on Map" onclick="showMap('.$Tlat1.','.$Tlong1.','.$To1.');"></i>';
				$Tlat2="'".$row1['mlog_to_latitude2']."'";
				$Tlong2="'".$row1['mlog_to_longitude2']."'";
				$To2="'".trim(preg_replace('/\s\s+/', ' ',$row1['mlog_to_location2']))."'";
				
				$Tlat3="'".$row1['mlog_to_latitude3']."'";
				$Tlong3="'".$row1['mlog_to_longitude3']."'";
				$To3="'".trim(preg_replace('/\s\s+/', ' ',$row1['mlog_to_location3']))."'";
				
				$loc2=ucwords($row1['mlog_to_location2']).'<i class="fa fa-map-marker markers" style="padding-left:10px;" title="View Address on Map" onclick="showMap('.$Tlat2.','.$Tlong2.','.$To2.');"></i>';
				$loc3=ucwords($row1['mlog_to_location3']).'<i class="fa fa-map-marker markers" style="padding-left:10px;" title="View Address on Map" onclick="showMap('.$Tlat3.','.$Tlong3.','.$To3.');"></i>';
				
				$row[]= $loc1." , ".$loc2." , ".$loc3;
			}
			
			$row[]=$row1['mlog_starting_mileage']; 
			if($row1['chosse_your_trip'] == 1 || $row1['chosse_your_trip'] == 2 || $row1['chosse_your_trip'] == 0){
				$row[]=$row1['mlog_total_miles'].'<form class="getdirform" method="get" target="iFrame">
					<input id="origin'.$row1['mlog_id'].'" value="'.$row1['mlog_from_location'].'" name="origin'.$row1['mlog_id'].'" type="hidden"/>
					<input id="destination'.$row1['mlog_id'].'" value="'.$row1['mlog_to_location'].'" name="destination'.$row1['mlog_id'].'" type="hidden"/>
					<input id="key" type="hidden" name="key" value="AIzaSyB7V6-2XNLLucSV2IlVU4ES40B7pmR3NzE">
					<input style="margin-top:12px;" class="btn btn-xs btn btn-success frm" type="button" value="Get Direction" onclick="showDirectionMap('.$row1['mlog_id'].');"/>
					</form>';
			} else {
				$row[]=$row1['mlog_total_miles'];
			} 
			$row[]=number_format($row1['mlog_ending_mileage'],3); 
		    $row[]=$row1['mlog_activity_description'];
			$userType=printUserType($creatorData);
  			$row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
			$your_date = date("m/d/Y", strtotime($row1['mlog_added_date'])); 
			$row[]=$your_date;
			if(!empty($modifierData)){
				$userType=printUserType($modifierData);
				$row[]=ucwords($modifierData['agency_first_name']." ".$modifierData['agency_last_name'])."&nbsp;".$userType;
				$row[]=formatDateTimeNew($row1['mlog_modified']);
			}else{
				$row[]="-";
				$row[]="-";
			}
			$type='"Mileage"';
			if(($permissions=="Edit" || $permissions=="Both") && !isFormAssigned($formid,$indid) && date("m")==date("m",strtotime($row1['mlog_added_date']))){
				// Start code adde by amit on 21-may-2018 with a caregiver cannot edit another caregiver record
                                $url =  APPLICATION_URL."/edit-new-mileage/".$indid."/".$formid."/".$row1[$sIndexColumn]."/".$type;
                                if($this->view->user->agency_user_type == "Staff"){
                                    if($row1['mlog_added_user'] == $this->view->user->subuser_id) {
                                        $row[]="<a style='margin-top:5px;' href='".$url."' class='btn btn-xs btn-default'>Edit</a>";
                                    } else {
                                        $row[]="";
                                    }
                                } else {
                                    $row[]="<a style='margin-top:5px;' href='".$url."' class='btn btn-xs btn-default'>Edit</a>";
                                }
                                
                                // End code adde by amit on 21-may-2018 with a caregiver cannot edit another caregiver record
                                
			}
			else{
				$row[]="<b>NA</b>";
			}
 			$output['aaData'][] = $row;
			$j++;
		}
                
		echo json_encode($output);
		exit();
	}
	
	public function viewassignedmileageAction(){	
		global $healthSession; 
  		$this->view->pageHeading = "Assigned Miles";
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		if(empty($indid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		if(isFormAssigned($formid,$indid)){
			$healthSession->errorMsg="Please assign form to individual first.";
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_mileage_logs");
		}
                
                $mileageDataForShare=$this->SuperModel->Super_Get("_uhs_mileage_logs","mlog_form_id=".$formid.' and mlog_individual_id='.$indid.' and MONTH(mlog_added_date)=MONTH(CURDATE()) and YEAR(mlog_added_date)=YEAR(CURDATE()) and mlog_choose_one=2',"fetch",array("fields"=>"SUM(mlog_total_miles) as totalDriven"));
		
		$TotalAssignedMilesForShare=$this->SuperModel->Super_Get("_uhs_assigned_miles","m_form_id=".$formid." and m_individual_id=".$indid." and MONTH(miles_added_date)=MONTH(CURDATE()) and YEAR(miles_added_date)=YEAR(CURDATE()) and chooseone=2","fetch",array("order"=>"mid DESC"));
		
                $mileageDataForIndiv=$this->SuperModel->Super_Get("_uhs_mileage_logs","mlog_form_id=".$formid.' and mlog_individual_id='.$indid.' and MONTH(mlog_added_date)=MONTH(CURDATE()) and YEAR(mlog_added_date)=YEAR(CURDATE()) and mlog_choose_one IN (1,0)',"fetch",array("fields"=>"SUM(mlog_total_miles) as totalDriven"));
		
		$TotalAssignedMilesForIndiv=$this->SuperModel->Super_Get("_uhs_assigned_miles","m_form_id=".$formid." and m_individual_id=".$indid." and MONTH(miles_added_date)=MONTH(CURDATE()) and YEAR(miles_added_date)=YEAR(CURDATE()) and chooseone IN (1,0)","fetch",array("order"=>"mid DESC"));
		
                $this->view->mileageDataForShare=$mileageDataForShare;
		$this->view->TotalAssignedMilesForShare=$TotalAssignedMilesForShare;
                $this->view->mileageDataForIndiv=$mileageDataForIndiv;
		$this->view->TotalAssignedMilesForIndiv=$TotalAssignedMilesForIndiv;
		$this->view->indid=$indid;
		$this->view->formid=$formid;
                
  	}
	
	public function getassignedmilesAction(){
		if(check_is_ajax($this->_request)){
			$this->_redirect(APPLICATION_URL);
		}
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$month=$year="";
		if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
			$month=$_REQUEST['month'];
		}
		if(isset($_REQUEST['year']) && !empty($_REQUEST['year'])){
			$year=$_REQUEST['year'];
		}
 		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('mid','m_form_id','m_individual_id','total_assigned_miles','remaining_miles','miles_added_by','miles_added_date','miles_modified_by','miles_modified_on','month','chooseone');
		$sIndexColumn = 'mid';
		$sTable = '_uhs_assigned_miles';
		$sLimit = "";
		if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' ){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		if ( isset( $_GET['iSortCol_0'] ) )
		{
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
			{
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
				{
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
	
		if($sWhere){
                    $sWhere.=" and m_form_id=".$formid." and m_individual_id='".$indid."'"; 
                }
                else{
                        $sWhere.=" where m_form_id=".$formid." and m_individual_id='".$indid."'";  
                }
		if(!empty($month)){
			$sWhere.=" and MONTH(miles_added_date)=".$month; 
		}
		if(!empty($year)){
			$sWhere.=" and YEAR(miles_added_date)='".$year."'"; 
		}
                
                
                if(empty($month) && empty($year)){
                    if(!empty($sWhere)){
                            $sWhere.=" and MONTH(miles_added_date)=MONTH(CURDATE()) and YEAR(miles_added_date)=YEAR(CURDATE())";
                    }else{
                            $sWhere.=" where MONTH(miles_added_date)=MONTH(CURDATE()) and YEAR(miles_added_date)=YEAR(CURDATE())";
                    }
                }
                
                
                // for share mile
                if($sWhere){
                    $sWhereShare = $sWhere." and chooseone=2"; 
                }
		$sQueryShare = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhereShare $sOrder $sLimit";
                // for individual miles
                if($sWhere){
                    $sWhereIndiv = $sWhere." and chooseone IN (1,0)"; 
                }
		$sQueryIndiv = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhereIndiv $sOrder $sLimit";
                
                $qryShare = $this->dbObj->query($sQueryShare)->fetchAll();
                $qryIndiv = $this->dbObj->query($sQueryIndiv)->fetchAll();
                
                $qry = array_merge($qryIndiv,$qryShare);
             
                $sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
		$output = array(
 				"iTotalRecords" => $iTotal,
				"iTotalDisplayRecords" => $iFilteredTotal,
				"aaData" => array()
			);
		$j=0;
		foreach($qry as $row1){
			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$row1['miles_added_by']);
			$modifierData=array();
			if($row1['miles_modified_by']!=0){
				$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$row1['miles_modified_by']);
			}
			$row=array();
 			$row[] = $j+1;
			$row[]='<input class="elem_ids checkboxes" type="checkbox" name="'.$sTable.'['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';
                        $row[]=$row1['month'];
                        if($row1['chooseone']== 1){
                            $row[]=$row1['total_assigned_miles'].'&nbsp;&nbsp;<i class="fa fa-user" title="Individual Miles"></i>';
                        } elseif($row1['chooseone']== 2){
                            $row[]=$row1['total_assigned_miles'].'&nbsp;&nbsp;<i class="fa fa-users" title="Share Miles"></i>';
                        }else{
                             $row[]=$row1['total_assigned_miles'].'&nbsp;&nbsp;<i class="fa fa-user" title="Individual Miles"></i>';
                        }
			$row[]=$row1['remaining_miles'];
			$userType=printUserType($creatorData);
			$row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
			$your_date = date("m/d/Y", strtotime($row1['miles_added_date'])); 
			$row[]=$your_date;
			if(!empty($modifierData)){
				$userType=printUserType($modifierData);
				$row[]=ucwords($modifierData['agency_first_name']." ".$modifierData['agency_last_name'])."&nbsp;".$userType;
				$row[]=formatDateTime($row1['miles_modified_on']);
			}
			else{
				$row[]="-";
				$row[]="-";
			}
			if(date("m")==date("m",strtotime($row1['miles_added_date']))){
				//$row[]="<a style='margin-top:5px;' href='javascript:void(1);' onClick=showDiffrentForms(".$indid.",".$formid.",".$row1[$sIndexColumn].",'AssignedMileage') class='btn btn-xs btn-default'>Edit</a>";
				$url = APPLICATION_URL."/edit-initial-mileage/".$indid."/".$formid."/".$row1[$sIndexColumn]."/"."AssignedMileage";
                                $row[]="<a style='margin-top:5px;' href='".$url."' class='btn btn-xs btn-default'>Edit</a>";
			}else{
				$row[]="<b>NA</b>";
			}
 			$output['aaData'][] = $row;
			$j++;
		}
		echo json_encode($output);
		exit();
	}
	
public function savemileageAction(){
		global $healthSession,$systemusers;
		$formid=$this->_getParam("formid");
		$indid=$this->_getParam("indid");
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		if($permissions=="View Only"){
			$healthSession->errorMsg="You don't have permission to access this page.";
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_mileage_logs");
		}
		$id=$this->_getParam("id");
		$getAssignedMileage=$this->SuperModel->Super_Get("_uhs_assigned_miles","m_form_id='".$formid."' and m_individual_id='".$indid."' and MONTH(miles_added_date)=MONTH(CURDATE()) and YEAR(miles_added_date)=YEAR(CURDATE())","fetch",array("order"=>"mid DESC"));
		if(empty($getAssignedMileage)){
			$healthSession->errorMsg="You can't add mileage log.";
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_mileage_logs");
		}
		$form=new Application_Form_CustomForms();
		$form->Mileage($indid,$formid,$id);
		
		if($this->getRequest()->isPost()){
			$posted_data = $this->getRequest()->getPost();
			unset($posted_data['bttnsubmit']);
   			if($form->isValid($posted_data)){
                                if($posted_data['mlog_choose_one'] == 2){
                                    $sWhere_miles =" and chooseone = 2";
                                    $sWhere_mlog =" and mlog_choose_one = 2";
				}else{
                                    $sWhere_mlog =" and mlog_choose_one IN (1,0)";
                                    $sWhere_miles =" and chooseone IN (1,0)";
				}
				$getAssignedMileage=$this->SuperModel->Super_Get("_uhs_assigned_miles","m_form_id=".$formid." and m_individual_id=".$indid." and MONTH(miles_added_date)=MONTH(CURDATE()) and YEAR(miles_added_date)=YEAR(CURDATE()) $sWhere_miles","fetch",array("order"=>"mid DESC"));
				if($id==""){
					$getremainedMileage=$this->SuperModel->Super_Get("_uhs_mileage_logs","mlog_form_id=".$formid." and mlog_individual_id=".$indid." and MONTH(mlog_added_date)=MONTH(CURDATE()) and YEAR(mlog_added_date)=YEAR(CURDATE()) $sWhere_mlog","fetchAll",array("order"=>"mlog_id DESC"));
				}
				else{
					$getremainedMileage=$this->SuperModel->Super_Get("_uhs_mileage_logs","mlog_form_id=".$formid." and mlog_id!=".$id." and mlog_individual_id=".$indid." and MONTH(mlog_added_date)=MONTH(CURDATE()) and YEAR(mlog_added_date)=YEAR(CURDATE()) $sWhere_mlog","fetchAll",array("order"=>"mlog_id DESC"));
				}
				$remainMiles=$getAssignedMileage['remaining_miles'];
				if(count($getremainedMileage)>0){
					$remainMiles=$getremainedMileage[0]['mlog_ending_mileage'];
					$totalMileage=0;
					foreach($getremainedMileage as $fin){
						$totalMileage+=$fin['mlog_total_miles'];
					}
					$remainMiles=$getAssignedMileage['remaining_miles']-$totalMileage;
				}
				if($remainMiles!=$posted_data['mlog_remaining_mileage']){
					$posted_data['mlog_remaining_mileage']=$remainMiles;
					if($posted_data['mlog_total_miles']>$remainMiles){
						$healthSession->errorMsg="Starting Mileage is not enough";
						$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_mileage_logs");
					}
					$posted_data['mlog_ending_mileage']=round($remainMiles-$posted_data['mlog_total_miles'],2);
				}
				$posted_data['mlog_service_date']=date("Y-m-d",strtotime($posted_data['mlog_service_date']));
				$maxAddMore = 7;
				if(empty($id)){
					 $indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
					 $agencyData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indData['agency_user_agency_id']);
					 $posted_data['mlog_agency_id']=$agencyData['agency_id'];
					 $posted_data['mlog_individual_id']=$indid;
					 $posted_data['mlog_form_id']=$formid;
					 $posted_data['mlog_added_date']=date('Y-m-d H:i:s');
					 $posted_data['mlog_modified']=NULL;
					 $posted_data['mlog_added_user']=$this->view->user->subuser_id; //$this->view->user->agency_id;
					 if($posted_data['chosse_your_trip'] == 1 || $posted_data['chosse_your_trip'] == 2) {
						 for($i = 1; $i <= $maxAddMore; $i++){
							$posted_data['mlog_to_latitude'.$i]="";
							$posted_data['mlog_to_longitude'.$i]="";
						}
					} else if($posted_data['chosse_your_trip'] == 3){
						$posted_data['mlog_to_latitude']="";
						$posted_data['mlog_to_longitude']="";
					}
					 $isInserted = $this->SuperModel->Super_Insert("_uhs_mileage_logs",$posted_data);
					 if($isInserted->success){
						if(in_array($this->view->user->agency_user_type,$systemusers) && checkNotifySettings($this->view->user->agency_user_agency_id,"form-".$formid)){
							$notifyData=array("notification_user_id"=>$this->view->user->agency_user_agency_id,"notification_type"=>"form-".$formid,"notification_type_id"=>$isInserted->inserted_id,"notification_by_user_id"=>$this->view->user->agency_id,"notification_date"=>date("Y-m-d H:i:s"));
							$isNotify=$this->SuperModel->Super_Insert("_uhs_notifications",$notifyData);
						}
						$healthSession->successMsg  = "Mileage log has been added successfully.";
					 }else{
						$healthSession->errorMsg  = $isInserted->message;
					 }
				}
				else{
					if($posted_data['chosse_your_trip'] == 1 || $posted_data['chosse_your_trip'] == 2) {
						for($i = 1; $i <= $maxAddMore; $i++){
							$posted_data['mlog_to_location'.$i]="";
							$posted_data['mlog_to_latitude'.$i]="";
							$posted_data['mlog_to_longitude'.$i]="";
							$posted_data['mlog_to_comment'.$i]="";
						}
						
					} else if($posted_data['chosse_your_trip'] == 3){
						$posted_data['mlog_to_location']="";
						$posted_data['mlog_to_latitude']="";
						$posted_data['mlog_to_longitude']="";
						
					}
					$posted_data['mlog_modified_by']=$this->view->user->subuser_id;
					$posted_data['mlog_modified']=date('Y-m-d H:i:s');
					$isInserted = $this->SuperModel->Super_Insert("_uhs_mileage_logs",$posted_data,"mlog_id=".$id);
					if($isInserted->success){
						$healthSession->successMsg  ="Mileage log has been updated successfully.";
					 }else{
						$healthSession->errorMsg  = $isInserted->message;
					 }
				}
				 
   			}else{
				$healthSession->errorMsg = " Please check information again.";
 			}
		 }
		 $this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_mileage_logs");
	}
	
public function saveassignedmileageAction(){
		global $healthSession;
		$formid=$this->_getParam("formid");
		$indid=$this->_getParam("indid");
		$id=$this->_getParam("id");
		$form=new Application_Form_CustomForms();
		$form->assignedMileage($indid,$formid,$id);
		if($this->getRequest()->isPost()){
			$posted_data = $this->getRequest()->getPost();
   			//if($form->isValid($posted_data)){
				$indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
				$agencyData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indData['agency_user_agency_id']);
				if(empty($id)){
                                           //prd($posted_data);
                                        foreach($posted_data['total_assigned_miles'] as $key =>$value){
                                            $mileData=$this->SuperModel->Super_Get("_uhs_assigned_miles","MONTH(miles_added_date)=MONTH(CURDATE()) and YEAR(miles_added_date)=YEAR(CURDATE()) and m_individual_id='".$indid."' and m_form_id='".$formid."' and chooseone='".$posted_data['chooseone'][$key]."'","fetch",array("order"=>"mid DESC"));
                                            $posted_data1['total_assigned_miles']=abs(round($posted_data['total_assigned_miles'][$key]));
                                            if(!empty($mileData)){
                                                   $posted_data1['remaining_miles']=round(floatval($mileData['remaining_miles'])+floatval($posted_data['total_assigned_miles'][$key]));
                                            }
                                            else{
                                                   $posted_data1['remaining_miles']=round($posted_data['total_assigned_miles'][$key]);	
                                            }
                                            $posted_data1['m_agency_id']=$agencyData['agency_id'];
                                            $posted_data1['m_individual_id']=$indid;
                                            $posted_data1['m_form_id']=$formid;
                                            $posted_data1['miles_added_by']=$this->view->user->subuser_id;
                                            $posted_data1['miles_added_date']=date('Y-m-d');
                                            $posted_data1['month']=$posted_data['month'][$key];
                                            $posted_data1['chooseone']=$posted_data['chooseone'][$key];
                                            
                                            if(!empty($posted_data['comment'][$key])){
                                                $posted_data1['comment']=$posted_data['comment'][$key];
                                            }else{
                                                $posted_data1['comment']="";
                                            }
                                            
                                            $isInserted = $this->SuperModel->Super_Insert("_uhs_assigned_miles",$posted_data1);
                                            if($isInserted->success){
                                                   $healthSession->successMsg  = "Total Mileage has been added successfully.";
                                            }else{
                                                   $healthSession->errorMsg  = $isInserted->message;
                                              }
                                             
                                        } 
				}
				else{
					$posted_data2['miles_modified_by']=$this->view->user->subuser_id;
					$posted_data2['miles_modified_on']=date("Y-m-d H:i:s");
					$posted_data2['total_assigned_miles']=abs(round($posted_data['total_assigned_miles'][0]));
					$posted_data2['remaining_miles']=round($posted_data['total_assigned_miles'][0]);
                                        $posted_data2['month']=$posted_data['month'][0];
                                        $posted_data2['chooseone']=$posted_data['chooseone'][0];
                                        
                                        if(!empty($posted_data['comment'][0])){
                                            $posted_data2['comment']=$posted_data['comment'][0];
                                        }else{
                                            $posted_data2['comment']="";
                                        }
                                        $isInserted = $this->SuperModel->Super_Insert("_uhs_assigned_miles",$posted_data2,"mid=".$id);
					if($isInserted->success){
						$mileData=$this->SuperModel->Super_Get("_uhs_assigned_miles","MONTH(miles_added_date)=MONTH(CURDATE()) and YEAR(miles_added_date)=YEAR(CURDATE()) and m_individual_id='".$indid."' and m_form_id='".$formid."' and chooseone='".$posted_data['chooseone'][0]."'","fetchAll",array("order"=>"mid ASC"));
						if(count($mileData) > 0){
							$totalMiles=0;
							for($i=0;$i<count($mileData);$i++){
								$totalMiles+=$mileData[$i]['total_assigned_miles'];
								if($i==0){
									$remainMiles=$mileData[$i]['total_assigned_miles'];
								}
								else if($i<count($mileData)-1 && $i>0){
									$remainMiles=$mileData[$i-1]['total_assigned_miles']+$mileData[$i]['total_assigned_miles'];
								}
								else{
									$remainMiles=$totalMiles;
								}
								$upArr=array('remaining_miles'=>$remainMiles);
								$isUpdate=$this->SuperModel->Super_Insert("_uhs_assigned_miles",$upArr,"mid=".$mileData[$i]['mid']);
							}
						}
						$healthSession->successMsg  ="Total Mileage has been updated successfully.";
					 }else{
						$healthSession->errorMsg  = $isInserted->message;
					 }
				}
				 
//   			}else{
//				$healthSession->errorMsg = " Please check information again.";
// 			}
		 }
		 $this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_assigned_miles");
	}
	
	public function saveassignedmileageoldAction(){
		global $healthSession;
		$formid=$this->_getParam("formid");
		$indid=$this->_getParam("indid");
		$id=$this->_getParam("id");
		$form=new Application_Form_CustomForms();
		$form->assignedMileage($indid,$formid,$id);
		if($this->getRequest()->isPost()){
			$posted_data = $this->getRequest()->getPost();
   			//if($form->isValid($posted_data)){
				$indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
				$agencyData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indData['agency_user_agency_id']);
				if(empty($id)){
                                           //prd($posted_data);
                                        foreach($posted_data['total_assigned_miles'] as $key =>$value){
                                            $mileData=$this->SuperModel->Super_Get("_uhs_assigned_miles","MONTH(miles_added_date)=MONTH(CURDATE()) and m_individual_id='".$indid."' and m_form_id='".$formid."' and chooseone='".$posted_data['chooseone'][$key]."'","fetch",array("order"=>"mid DESC"));
                                            $posted_data1['total_assigned_miles']=abs(round($posted_data['total_assigned_miles'][$key]));
                                            if(!empty($mileData)){
                                                   $posted_data1['remaining_miles']=round(floatval($mileData['remaining_miles'])+floatval($posted_data['total_assigned_miles'][$key]));
                                            }
                                            else{
                                                   $posted_data1['remaining_miles']=round($posted_data['total_assigned_miles'][$key]);	
                                            }
                                            $posted_data1['m_agency_id']=$agencyData['agency_id'];
                                            $posted_data1['m_individual_id']=$indid;
                                            $posted_data1['m_form_id']=$formid;
                                            $posted_data1['miles_added_by']=$this->view->user->subuser_id;
                                            $posted_data1['miles_added_date']=date('Y-m-d');
                                            $posted_data1['month']=$posted_data['month'][$key];
                                            $posted_data1['chooseone']=$posted_data['chooseone'][$key];
                                            
                                            if(!empty($posted_data['comment'][$key])){
                                                $posted_data1['comment']=$posted_data['comment'][$key];
                                            }else{
                                                $posted_data1['comment']="";
                                            }
                                            
                                            $isInserted = $this->SuperModel->Super_Insert("_uhs_assigned_miles",$posted_data1);
                                            if($isInserted->success){
                                                   $healthSession->successMsg  = "Total Mileage has been added successfully.";
                                            }else{
                                                   $healthSession->errorMsg  = $isInserted->message;
                                              }
                                             
                                        } 
				}
				else{
					$posted_data2['miles_modified_by']=$this->view->user->subuser_id;
					$posted_data2['miles_modified_on']=date("Y-m-d H:i:s");
					$posted_data2['total_assigned_miles']=abs(round($posted_data['total_assigned_miles'][0]));
					$posted_data2['remaining_miles']=round($posted_data['total_assigned_miles'][0]);
                                        $posted_data2['month']=$posted_data['month'][0];
                                        $posted_data2['chooseone']=$posted_data['chooseone'][0];
                                        
                                        if(!empty($posted_data['comment'][0])){
                                            $posted_data2['comment']=$posted_data['comment'][0];
                                        }else{
                                            $posted_data2['comment']="";
                                        }
                                        $isInserted = $this->SuperModel->Super_Insert("_uhs_assigned_miles",$posted_data2,"mid=".$id);
					if($isInserted->success){
						$mileData=$this->SuperModel->Super_Get("_uhs_assigned_miles","MONTH(miles_added_date)=MONTH(CURDATE()) and m_individual_id='".$indid."' and m_form_id='".$formid."' and chooseone='".$posted_data['chooseone'][0]."'","fetchAll",array("order"=>"mid ASC"));
						if(count($mileData) > 0){
							$totalMiles=0;
							for($i=0;$i<count($mileData);$i++){
								$totalMiles+=$mileData[$i]['total_assigned_miles'];
								if($i==0){
									$remainMiles=$mileData[$i]['total_assigned_miles'];
								}
								else if($i<count($mileData)-1 && $i>0){
									$remainMiles=$mileData[$i-1]['total_assigned_miles']+$mileData[$i]['total_assigned_miles'];
								}
								else{
									$remainMiles=$totalMiles;
								}
								$upArr=array('remaining_miles'=>$remainMiles);
								$isUpdate=$this->SuperModel->Super_Insert("_uhs_assigned_miles",$upArr,"mid=".$mileData[$i]['mid']);
							}
						}
						$healthSession->successMsg  ="Total Mileage has been updated successfully.";
					 }else{
						$healthSession->errorMsg  = $isInserted->message;
					 }
				}
				 
//   			}else{
//				$healthSession->errorMsg = " Please check information again.";
// 			}
		 }
		 $this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_assigned_miles");
	}
	
	public function removemileageAction(){
		global $healthSession;
		$indid=$this->_getParam('indid');
		$formid=$this->_getParam('formid');
 		$this->_helper->layout->disableLayout();
		$this->_helper->viewRenderer->setNoRender(true);
		$formData = $this->getRequest()->getPost();
		if(isset($formData['records']) && count($formData['records'])) {
			foreach($formData['records'] as $key=>$values){
  				$isDel=$this->SuperModel->Super_Delete('_uhs_mileage_logs',"mlog_id=".$values);
 				$healthSession->successMsg=" Mileage Log(s) has been deleted successfully.";
			}
		}
		else{
			$healthSession->errorMsg = "Invalid Request.";
		}
		$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_mileage_logs");
	}
	
	public function removeassignedmileageAction(){
		global $healthSession;
		$indid=$this->_getParam('indid');
		$formid=$this->_getParam('formid');
 		$this->_helper->layout->disableLayout();
		$this->_helper->viewRenderer->setNoRender(true);
		$formData = $this->getRequest()->getPost();
                if(isset($formData['_uhs_assigned_miles']) && count($formData['_uhs_assigned_miles'])) {
			foreach($formData['_uhs_assigned_miles'] as $key=>$values){
  				$isDel=$this->SuperModel->Super_Delete('_uhs_assigned_miles',"mid=".$values);
 				$healthSession->successMsg="Assigned Mileage Log(s) has been deleted successfully.";
			}
                        $chooseOneArray = array(1=>"and chooseone IN(1,0)",2=>"and chooseone = 2");
                        foreach($chooseOneArray as $chooseOne) {
                            $mileData=$this->SuperModel->Super_Get("_uhs_assigned_miles","MONTH(miles_added_date)=MONTH(CURDATE()) and YEAR(miles_added_date)=YEAR(CURDATE()) and m_individual_id='".$indid."' and m_form_id='".$formid."'  $chooseOne","fetchAll",array("order"=>"mid ASC"));
                            if(count($mileData) > 0){
                                $totalMiles=0;
                                for($i=0;$i<count($mileData);$i++){
                                    $totalMiles+=$mileData[$i]['total_assigned_miles'];
                                    if($i==0){
                                            $remainMiles=$mileData[$i]['total_assigned_miles'];
                                    }
                                    else if($i<count($mileData)-1 && $i>0){
                                            $remainMiles=$mileData[$i-1]['total_assigned_miles']+$mileData[$i]['total_assigned_miles'];
                                    }
                                    else{
                                            $remainMiles=$totalMiles;
                                    }
                                    $upArr=array('remaining_miles'=>$remainMiles);
                                    $isUpdate=$this->SuperModel->Super_Insert("_uhs_assigned_miles",$upArr,"mid=".$mileData[$i]['mid']);
                                }
                            }
                        }
		}
		else{
			$healthSession->errorMsg="Invalid Request.";
		}
		$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_assigned_miles");
	}
	
	// Appointment Form
	public function appointmentsAction(){	
		global $healthSession; 
  		$this->view->pageHeading = "Appointments";
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		if(empty($indid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		$this->view->permissions=$permissions;
		$this->view->indid=$indid;
		$this->view->id=$id;
		$this->view->formid=$formid;
  	}
	
	public function getappointmentsAction(){
		if(check_is_ajax($this->_request)){
			$this->_redirect(APPLICATION_URL);
		}
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		$subuser=$dstarts=$dends="";
		if(isset($_REQUEST['subuser']) && !empty($_REQUEST['subuser'])){
			$subuser=$_REQUEST['subuser'];
		}
		if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
			$month=$_REQUEST['month'];
		}
		if(isset($_REQUEST['year']) && !empty($_REQUEST['year'])){
			$year=$_REQUEST['year'];
		}
		if(isset($_REQUEST['dstarts']) && !empty($_REQUEST['dstarts'])){
			$dstarts=$_REQUEST['dstarts'];
		}
		if(isset($_REQUEST['dends']) && !empty($_REQUEST['dends'])){
			$dends=$_REQUEST['dends'];
		}
 		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('appoint_id','appoint_added_user','appoint_date','appoint_time','appoint_with','appoint_address','appoint_reason','appoint_comments','appoint_added_date','appoint_latitude','appoint_longitude','appoint_modified_by','appoint_modified_on');
		$sIndexColumn = 'appoint_id';
		$sTable = '_uhs_appointments';
		$sLimit = "";
		if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' ){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		if ( isset( $_GET['iSortCol_0'] ) )
		{
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
			{
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
				{
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
		
		if(empty($subuser)){
			$indParentUsers="";
			if($this->view->user->agency_user_type=="Agency"){
				$systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_id,"fetchAll",array("fields"=>"agency_id"));
				$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
				$indParentUsers=implode_r(",",$systemUsers);
                                if($sWhere){
                                    $sWhere.=" and appoint_added_user IN(".$indParentUsers.") and appoint_individual_id='".$indid."'"; 
                                }
                                else{
                                        $sWhere.=" where appoint_added_user IN(".$indParentUsers.") and appoint_individual_id='".$indid."'"; 
                                }
			}
			else{
				$indParentUsers=$this->view->user->agency_id;
                                if($sWhere){
                                    $sWhere.=" and appoint_individual_id='".$indid."'"; 
                                }
                                else{
                                        $sWhere.=" where appoint_individual_id='".$indid."'"; 
                                }
			}
			
		}
		else{
			if($sWhere){
				$sWhere.=" and appoint_added_user IN(".$subuser.") and appoint_individual_id='".$indid."'"; 
			}
			else{
				$sWhere.=" where appoint_added_user IN(".$subuser.") and appoint_individual_id='".$indid."'"; 
			}
		}
		if(!empty($dstarts)){
			$sWhere.=" and DATE(appoint_date) >='".$dstarts."'";
		}
		if(!empty($dends)){
			$sWhere.=" and DATE(appoint_date) <='".$dends."'";
		}
		if(!empty($month)){
			$sWhere.=" and MONTH(appoint_date)='".$month."'";
		}
		if(!empty($year)){
			$sWhere.=" and YEAR(appoint_date)='".$year."'";
		}
		if(!empty($id) && $id!=0){
			$sWhere.=" and appoint_id=".$id;
		}
		 if(empty($month) && empty($year)){
                    if(!empty($sWhere)){
                            $sWhere.=" and MONTH(appoint_added_date)=MONTH(CURDATE()) and YEAR(appoint_added_date)=YEAR(CURDATE())";
                    }else{
                            $sWhere.=" where MONTH(appoint_added_date)=MONTH(CURDATE()) and YEAR(appoint_added_date)=YEAR(CURDATE())";
                    }
                }
		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
 		$qry = $this->dbObj->query($sQuery)->fetchAll();
		$sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
		$output = array(
 				"iTotalRecords" => $iTotal,
				"iTotalDisplayRecords" => $iFilteredTotal,
				"aaData" => array()
			);
		$j=0;
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		foreach($qry as $row1){
			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['appoint_added_user']."'","fetch");
			$modifierData=array();
			if($row1['appoint_modified_by']!=0){
				$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['appoint_modified_by']."'","fetch");
			}
			$row=array();
 			$row[] = $j+1;
			$row[]='<input class="elem_ids checkboxes" type="checkbox" name="records['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';
			$row[]=formatDate($row1['appoint_date']);  
			$row[]=$row1['appoint_time'];
			$row[]=ucwords($row1['appoint_with']);
			$lat="'".$row1['appoint_latitude']."'";
			$long="'".$row1['appoint_longitude']."'";
			$address="'".trim(preg_replace('/\s\s+/', ' ',$row1['appoint_address']))."'";
			$row[]=ucwords($row1['appoint_address']).'<i class="fa fa-map-marker markers pull-right" title="View Address on Map" onclick="showMap('.$lat.','.$long.','.$address.');"></i>';
		    $row[]=$row1['appoint_reason'];
			$row[]=$row1['appoint_comments'];
			$userType=printUserType($creatorData);
  			$row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
			$row[]=formatDateTimeNew($row1['appoint_added_date']); 
			if(!empty($modifierData)){
				$userType=printUserType($modifierData);
				$row[]=ucwords($modifierData['agency_first_name']." ".$modifierData['agency_last_name'])."&nbsp;".$userType;
				$row[]=formatDateTimeNew($row1['appoint_modified_on']);
			}else{
				$row[]="-";
				$row[]="-";
			}
			$type='"Appointment"';
			if(($permissions=="Edit" || $permissions=="Both") && !isFormAssigned($formid,$indid)){
				$row[]="<a style='margin-top:5px;' href='javascript:void(1);' onclick='showDiffrentForms(".$indid.",".$formid.",".$row1[$sIndexColumn].",".$type.");' class='btn btn-xs btn-default'>Edit</a>";
			}
			else{
				$row[]="-";
			}
 			$output['aaData'][] = $row;
			$j++;
		}
		echo json_encode($output);
		exit();
	}
	
	public function saveappointmentAction(){
		global $healthSession,$systemusers;
		$formid=$this->_getParam("formid");
		$indid=$this->_getParam("indid");
		$id=$this->_getParam("id");
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		if($permissions=="View Only"){
			$healthSession->errorMsg="You don't have permission to access this page.";
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_appointments");
		}
		$form=new Application_Form_CustomForms();
		$form->appointments($indid,$formid,$id);
		if($this->getRequest()->isPost()){
			$posted_data = $this->getRequest()->getPost();
   			if($form->isValid($posted_data)){
				$posted_data['appoint_date']=date("Y-m-d",strtotime($posted_data['appoint_date']));
				if(empty($id)){
					 $indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
					 $agencyData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indData['agency_user_agency_id']);
					 $posted_data['appoint_agency_id']=$agencyData['agency_id'];
					 $posted_data['appoint_individual_id']=$indid;
					 $posted_data['appoint_form_id']=$formid;
					 $posted_data['appoint_added_date']=date('Y-m-d H:i:s');
					 $posted_data['appoint_added_user']=$this->view->user->subuser_id;//$this->view->user->agency_id;
					 $isInserted = $this->SuperModel->Super_Insert("_uhs_appointments",$posted_data);
					 if($isInserted->success){
						if(in_array($this->view->user->agency_user_type,$systemusers) && checkNotifySettings($this->view->user->agency_user_agency_id,"form-".$formid)){
							$notifyData=array("notification_user_id"=>$this->view->user->agency_user_agency_id,"notification_type"=>"form-".$formid,"notification_type_id"=>$isInserted->inserted_id,"notification_by_user_id"=>$this->view->user->agency_id,"notification_date"=>date("Y-m-d H:i:s"));
							$isNotify=$this->SuperModel->Super_Insert("_uhs_notifications",$notifyData);
						}
						$healthSession->successMsg  = "Appointment has been added successfully.";
					 }else{
						$healthSession->errorMsg  = $isInserted->message;
					 }
				}
				else{
					$posted_data['appoint_modified_by']=$this->view->user->subuser_id;
					$posted_data['appoint_modified_on']=date('Y-m-d H:i:s');
					$isInserted = $this->SuperModel->Super_Insert("_uhs_appointments",$posted_data,"appoint_id=".$id);
					if($isInserted->success){
						$healthSession->successMsg  ="Appointment has been updated successfully.";
					 }else{
						$healthSession->errorMsg  = $isInserted->message;
					 }
				}
				 
   			}else{
				$healthSession->errorMsg = " Please check information again.";
 			}
		 }
		 $this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_appointments");
	}
	
	public function removeappointmentsAction(){
		global $healthSession;
		$indid=$this->_getParam('indid');
		$formid=$this->_getParam('formid');
 		$this->_helper->layout->disableLayout();
		$this->_helper->viewRenderer->setNoRender(true);
		$formData = $this->getRequest()->getPost();
		if(isset($formData['records']) && count($formData['records'])) {
			foreach($formData['records'] as $key=>$values){
  				$isDel=$this->SuperModel->Super_Delete('_uhs_appointments',"appoint_id=".$values);
 				$healthSession->successMsg=" Appointment(s) has been deleted successfully.";
			}
		}
		else{
			$healthSession->errorMsg = "Invalid Request.";
		}
		$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_appointments");
	}
	
	// Medical Concerns Form
	public function medicalconcernsAction(){	
		global $healthSession; 
  		$this->view->pageHeading = "Medical Concerns";
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		if(empty($indid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		$this->view->permissions=$permissions;
		$this->view->indid=$indid;
		$this->view->formid=$formid;
		$this->view->id=$id;
  	}
	
	public function getmedicalconcernsAction(){
		if(check_is_ajax($this->_request)){
			$this->_redirect(APPLICATION_URL);
		}
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		$subuser=$dstarts=$dends=$month=$year="";
		if(isset($_REQUEST['subuser']) && !empty($_REQUEST['subuser'])){
			$subuser=$_REQUEST['subuser'];
		}
		if(isset($_REQUEST['dstarts']) && !empty($_REQUEST['dstarts'])){
			$dstarts=$_REQUEST['dstarts'];
		}
		if(isset($_REQUEST['dends']) && !empty($_REQUEST['dends'])){
			$dends=$_REQUEST['dends'];
		}
		if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
			$month=$_REQUEST['month'];
		}
		if(isset($_REQUEST['year']) && !empty($_REQUEST['year'])){
			$year=$_REQUEST['year'];
		}
 		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('med_id','med_added_user','med_service_date','med_service_time','med_observations','med_action_taken','med_comments','med_added_date','med_modified_by','med_modified_on');
		$sIndexColumn = 'med_id';
		$sTable = '_uhs_medical_concerns';
		$sLimit = "";
		if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' ){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		if ( isset( $_GET['iSortCol_0'] ) )
		{
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
			{
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
				{
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
		
		if(empty($subuser)){
			$indParentUsers="";
			if($this->view->user->agency_user_type=="Agency"){
				$systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_id,"fetchAll",array("fields"=>"agency_id"));
				$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
				$indParentUsers=implode_r(",",$systemUsers);
                                if($sWhere){
                                    $sWhere.=" and med_added_user IN(".$indParentUsers.") and med_individual_id='".$indid."'"; 
                                }
                                else{
                                        $sWhere.=" where med_added_user IN(".$indParentUsers.") and med_individual_id='".$indid."'"; 
                                }
			}
			else{
				$indParentUsers=$this->view->user->agency_id;
                                if($sWhere){
                                    $sWhere.=" and med_individual_id='".$indid."'"; 
                                }
                                else{
                                        $sWhere.=" where med_individual_id='".$indid."'"; 
                                }
			}
			
		}
		else{
			if($sWhere){
				$sWhere.=" and med_added_user IN(".$subuser.") and med_individual_id='".$indid."'"; 
			}
			else{
				$sWhere.=" where med_added_user IN(".$subuser.") and med_individual_id='".$indid."'"; 
			}
		}
		if(!empty($dstarts)){
			$sWhere.=" and DATE(med_service_date) >='".$dstarts."'";
		}
		if(!empty($dends)){
			$sWhere.=" and DATE(med_service_date) <='".$dends."'";
		}
		if(!empty($month)){
			$sWhere.=" and MONTH(med_service_date)='".$month."'";
		}
		if(!empty($year)){
			$sWhere.=" and YEAR(med_service_date)='".$year."'";
		}
		if(!empty($id) && $id!=0){
			$sWhere.=" and med_id=".$id;
		}
		if(empty($month) && empty($year)){
                    if(!empty($sWhere)){
                            $sWhere.=" and MONTH(med_added_date)=MONTH(CURDATE()) and YEAR(med_added_date)=YEAR(CURDATE())";
                    }else{
                            $sWhere.=" where MONTH(med_added_date)=MONTH(CURDATE()) and YEAR(med_added_date)=YEAR(CURDATE())";
                    }
                }
		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
 		$qry = $this->dbObj->query($sQuery)->fetchAll();
		$sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
		$output = array(
 				"iTotalRecords" => $iTotal,
				"iTotalDisplayRecords" => $iFilteredTotal,
				"aaData" => array()
			);
		$j=0;
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		foreach($qry as $row1){
			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['med_added_user']."'","fetch");
			$modifierData=array();
			if($row1['med_modified_by']!=0){
				$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['med_modified_by']."'","fetch");
			}
			$row=array();
 			$row[] = $j+1;
			$row[]='<input class="elem_ids checkboxes" type="checkbox" name="records['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';
			$row[]=formatDate($row1['med_service_date']);
			$row[]=$row1['med_service_time'];
			$row[]=$row1['med_observations']; 
		    $row[]=$row1['med_action_taken'];
			$row[]=$row1['med_comments'];
			$userType=printUserType($creatorData);
  			$row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
			$row[]=formatDateTimeNew($row1['med_added_date']);
			if(!empty($modifierData)){
				$userType=printUserType($modifierData);
  				$row[]=ucwords($modifierData['agency_first_name']." ".$modifierData['agency_last_name'])."&nbsp;".$userType;
				$row[]=formatDateTime($row1['med_modified_on']);
			}else{
				$row[]="-";
				$row[]="-";
			}			
			
			$type='"Medical"';
			if(($permissions=="Edit" || $permissions=="Both") && !isFormAssigned($formid,$indid)){
				$row[]="<a style='margin-top:5px;' href='javascript:void(1);' onclick='showDiffrentForms(".$indid.",".$formid.",".$row1[$sIndexColumn].",".$type.");' class='btn btn-xs btn-default'>Edit</a>";
			}
			else{
				$row[]="-";
			}
 			$output['aaData'][] = $row;
			$j++;
		}
		echo json_encode($output);
		exit();
	}
	
	public function savemedicalconcernAction(){
		global $healthSession,$systemusers;
		$formid=$this->_getParam("formid");
		$indid=$this->_getParam("indid");
		$id=$this->_getParam("id");
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		if($permissions=="View Only"){
			$healthSession->errorMsg="You don't have permission to access this page.";
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_medical_concerns");
		}
		$form=new Application_Form_CustomForms();
		$form->medicalConcerns($indid,$formid,$id);
		if($this->getRequest()->isPost()){
			$posted_data = $this->getRequest()->getPost();
   			if($form->isValid($posted_data)){
				$posted_data['med_service_date']=date("Y-m-d",strtotime($posted_data['med_service_date']));
				if(empty($id)){
					 $indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
					 $agencyData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indData['agency_user_agency_id']);
					 $posted_data['med_agency_id']=$agencyData['agency_id'];
					 $posted_data['med_individual_id']=$indid;
					 $posted_data['med_form_id']=$formid;
					 $posted_data['med_added_date']=date('Y-m-d H:i:s');
					 $posted_data['med_added_user']=$this->view->user->subuser_id;
					 $isInserted = $this->SuperModel->Super_Insert("_uhs_medical_concerns",$posted_data);
					 if($isInserted->success){
						if(in_array($this->view->user->agency_user_type,$systemusers) && checkNotifySettings($this->view->user->agency_user_agency_id,"form-".$formid)){
							$notifyData=array("notification_user_id"=>$this->view->user->agency_user_agency_id,"notification_type"=>"form-".$formid,"notification_type_id"=>$isInserted->inserted_id,"notification_by_user_id"=>$this->view->user->agency_id,"notification_date"=>date("Y-m-d H:i:s"));
							$isNotify=$this->SuperModel->Super_Insert("_uhs_notifications",$notifyData);
						}
						$healthSession->successMsg  = "Medical Concern has been added successfully.";
					 }else{
						$healthSession->errorMsg  = $isInserted->message;
					 }
				}
				else{
					$posted_data['med_modified_by']=$this->view->user->subuser_id;
					$posted_data['med_modified_on']=date('Y-m-d H:i:s');
					$isInserted = $this->SuperModel->Super_Insert("_uhs_medical_concerns",$posted_data,"med_id=".$id);
					if($isInserted->success){
						$healthSession->successMsg  ="Medical Concern has been updated successfully.";
					 }else{
						$healthSession->errorMsg  = $isInserted->message;
					 }
				}
				 
   			}else{
				$healthSession->errorMsg = " Please check information again.";
 			}
		 }
		 $this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_medical_concerns");
	}
	
	public function removemedicalconcernsAction(){
		global $healthSession;
		$indid=$this->_getParam('indid');
		$formid=$this->_getParam('formid');
 		$this->_helper->layout->disableLayout();
		$this->_helper->viewRenderer->setNoRender(true);
		$formData = $this->getRequest()->getPost();
		if(isset($formData['records']) && count($formData['records'])) {
			foreach($formData['records'] as $key=>$values){
  				$isDel=$this->SuperModel->Super_Delete('_uhs_medical_concerns',"med_id=".$values);
 				$healthSession->successMsg=" Medical Concern(s) has been deleted successfully.";
			}
		}
		else{
			$healthSession->errorMsg = "Invalid Request.";
		}
		$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_medical_concerns");
	}
	
	// Financial Ledger Form
	public function financialAction(){	
		global $healthSession; 
  		$this->view->pageHeading = "Financial Ledger";
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		if(empty($indid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		$getAssignedCreditBalance=$this->SuperModel->Super_Get("_uhs_financial_credit_balance","balance_form_id='".$formid."' and balance_individual_id='".$indid."'","fetch",array("order"=>"balance_id DESC"));
		$getAssignedGiftBalance=$this->SuperModel->Super_Get("_uhs_financial_gift_balance","balance_form_id='".$formid."' and balance_individual_id='".$indid."'","fetch",array("order"=>"balance_id DESC"));
		$getAssignedSpendingBalance=$this->SuperModel->Super_Get("_uhs_financial_spending_balance","balance_form_id='".$formid."' and balance_individual_id='".$indid."'","fetch",array("order"=>"balance_id DESC"));
		$getAssignedFoodBalance=$this->SuperModel->Super_Get("_uhs_food_initial_balance","fb_form_id='".$formid."' and fb_individual_id='".$indid."'","fetch",array("order"=>"fbid DESC"));
		$getAssignedGroceriesBalance=$this->SuperModel->Super_Get("_uhs_groceries_initial_balance","gr_form_id='".$formid."' and gr_individual_id='".$indid."'","fetch",array("order"=>"grid DESC"));

		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		$this->view->permissions=$permissions;
		$this->view->indid=$indid;
		$this->view->formid=$formid;
		$this->view->id=$id;
		$this->view->getAssignedCreditBalance=$getAssignedCreditBalance;
		$this->view->getAssignedGiftBalance=$getAssignedGiftBalance;
		$this->view->getAssignedSpendingBalance=$getAssignedSpendingBalance;
		$this->view->getAssignedFoodBalance=$getAssignedFoodBalance;
		$this->view->getAssignedGroceriesBalance=$getAssignedGroceriesBalance;
  	}
	
	public function getfinancialrecordsAction(){
		if(check_is_ajax($this->_request)){
			$this->_redirect(APPLICATION_URL);
		}
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		$subuser=$dstarts=$dends=$month=$year=$wcode=$account="";
		if(isset($_REQUEST['subuser']) && !empty($_REQUEST['subuser'])){
			$subuser=$_REQUEST['subuser'];
		}
		if(isset($_REQUEST['account']) && !empty($_REQUEST['account'])){
			$account=$_REQUEST['account'];
		}
		if(isset($_REQUEST['dstarts']) && !empty($_REQUEST['dstarts'])){
			$dstarts=$_REQUEST['dstarts'];
		}
		if(isset($_REQUEST['dends']) && !empty($_REQUEST['dends'])){
			$dends=$_REQUEST['dends'];
		}	
		if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
			$month=$_REQUEST['month'];
		}
		if(isset($_REQUEST['year']) && !empty($_REQUEST['year'])){
			$year=$_REQUEST['year'];
		}	
		
 		$this->dbObj = Zend_Registry::get('db');
		//$aColumns = array('flid','fl_added_user','fl_service_date','fl_starting_balance','fl_amt_spend','fl_type','fl_ending_balance','fl_address','fl_activity_desc','fl_added_date','fl_latitude','fl_longitude','fl_modified_date','fl_uploads','fl_modified_date','fl_modified_by');
		$aColumns = array('flid','fl_added_user','fl_service_date','fl_remaining_balance','fl_amt_spend','fl_amt_credit','fl_type','fl_ending_balance','fl_address','fl_activity_desc','fl_added_date','fl_latitude','fl_longitude','fl_modified_date','fl_uploads','fl_modified_date','fl_modified_by');
		$sIndexColumn = 'flid';
		$sTable = '_uhs_financial_ledger';
		$sLimit = "";
		if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' ){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		if ( isset( $_GET['iSortCol_0'] ) )
		{
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
			{
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
				{
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
		
		if(empty($subuser)){
			$indParentUsers="";
			if($this->view->user->agency_user_type=="Agency"){
				$systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_id,"fetchAll",array("fields"=>"agency_id"));
				$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
				$indParentUsers=implode_r(",",$systemUsers);
                                if($sWhere){
                                    $sWhere.=" and fl_added_user IN(".$indParentUsers.") and fl_individual_id='".$indid."'"; 
                                }
                                else{
                                        $sWhere.=" where fl_added_user IN(".$indParentUsers.") and fl_individual_id='".$indid."'"; 
                                }
			}
			else{
				$indParentUsers=$this->view->user->agency_id;
                                if($sWhere){
                                    $sWhere.=" and fl_individual_id='".$indid."'"; 
                                }
                                else{
                                        $sWhere.=" where fl_individual_id='".$indid."'"; 
                                }
			}
			
		}
		else{
			if($sWhere){
				$sWhere.=" and fl_added_user IN(".$subuser.") and fl_individual_id='".$indid."'"; 
			}
			else{
				$sWhere.=" where fl_added_user IN(".$subuser.") and fl_individual_id='".$indid."'"; 
			}
		}
		if(!empty($dstarts)){
			$sWhere.=" and DATE(fl_service_date) >='".$dstarts."'";
		}
		if(!empty($dends)){
			$sWhere.=" and DATE(fl_service_date) <='".$dends."'";
		}
		if(!empty($month)){
			$sWhere.=" and MONTH(fl_service_date)='".$month."'";
		}
		if(!empty($year)){
			$sWhere.=" and YEAR(fl_service_date)='".$year."'";
		}
		if(!empty($id) && $id!=0){
			$sWhere.=" and flid=".$id;
		}

		if(!empty($account)){
			$sWhere.=" and fl_type='".$account."'";
		}

		if(empty($month) && empty($year)){
                    if(!empty($sWhere)){
                        $sWhere.=" and MONTH(fl_added_date)=MONTH(CURDATE()) and YEAR(fl_added_date)=YEAR(CURDATE())";
                    }else{
                        $sWhere.=" where MONTH(fl_added_date)=MONTH(CURDATE()) and YEAR(fl_added_date)=YEAR(CURDATE())";
                    }
                }
		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";

		//print_r($sQuery);
		//die;
 		$qry = $this->dbObj->query($sQuery)->fetchAll();
		$sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];

 //-----------------------------------------------for food ----------------------------------------------
		$aColumns = array('food_id','food_added_user','food_service_date','food_remaining_balance','food_amt_spend','food_amt_credit','food_ending_balance','food_address','food_activity_description','food_upload','food_added_date','food_latitude','food_longitude','food_modified_date','food_modified_by','food_modified_date');
		$sIndexColumn_new = 'food_id';
		$sTable = '_uhs_food_stamp';
		$sLimit = "";
		if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' ){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		if ( isset( $_GET['iSortCol_0'] ) )
		{
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
			{
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
				{
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
		
		if(empty($subuser)){
			$indParentUsers="";
			if($this->view->user->agency_user_type=="Agency"){
				$systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_id,"fetchAll",array("fields"=>"agency_id"));
				$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
				$indParentUsers=implode_r(",",$systemUsers);
                                if($sWhere){
                                    $sWhere.=" and food_added_user IN(".$indParentUsers.") and food_individual_id='".$indid."'"; 
                                }
                                else{
                                        $sWhere.=" where food_added_user IN(".$indParentUsers.") and food_individual_id='".$indid."'"; 
                                }
                                
			}
			else{
				$indParentUsers=$this->view->user->agency_id;
                                if($sWhere){
                                    $sWhere.=" and food_individual_id='".$indid."'"; 
                                }
                                else{
                                        $sWhere.=" where food_individual_id='".$indid."'"; 
                                }
			}
			
		}
		else{
			if($sWhere){
				$sWhere.=" and food_added_user IN(".$subuser.") and food_individual_id='".$indid."'"; 
			}
			else{
				$sWhere.=" where food_added_user IN(".$subuser.") and food_individual_id='".$indid."'"; 
			}
		}
		if(!empty($dstarts)){
			$sWhere.=" and DATE(food_service_date) >='".$dstarts."'";
		}
		if(!empty($dends)){
			$sWhere.=" and DATE(food_service_date) <='".$dends."'";
		}
		if(!empty($month)){
			$sWhere.=" and MONTH(food_service_date)='".$month."'";
		}
		if(!empty($year)){
			$sWhere.=" and YEAR(food_service_date)='".$year."'";
		}
		if(!empty($account)){
			$sWhere.=" and food_type='".$account."'";
		}
		if(!empty($id) && $id!=0){
			$sWhere.=" and food_id=".$id;
		}
		if(empty($month) && empty($year)){
                    if(!empty($sWhere)){
                            $sWhere.=" and MONTH(food_added_date)=MONTH(CURDATE()) and YEAR(food_added_date)=YEAR(CURDATE())";
                    }else{
                            $sWhere.=" where MONTH(food_added_date)=MONTH(CURDATE()) and YEAR(food_added_date)=YEAR(CURDATE())";
                    }
                }
		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
 		$qry_new = $this->dbObj->query($sQuery)->fetchAll();
		$sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal1 = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn_new."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 

		$iTotal1= $rResultTotal[0]['cnt'];
		$iFilteredTotal_new=$iFilteredTotal+$iFilteredTotal1;

        $iTotal_new=$iTotal+$iTotal1;

//------------------------------------------------for Groceries -----------------------------------------
		$aColumns = array('groceries_id','groceries_added_user','groceries_service_date','groceries_remaining_balance','groceries_amt_spend','groceries_amt_credit','groceries_ending_balance','groceries_address','groceries_activity_description','groceries_upload','groceries_added_date','groceries_latitude','groceries_longitude','groceries_modified_date','groceries_modified_by','groceries_modified_date');
		$sIndexColumn_gr = 'groceries_id';
		$sTable = '_uhs_groceries';
		$sLimit = "";
		if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' ){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		if ( isset( $_GET['iSortCol_0'] ) )
		{
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
			{
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
				{
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
		
		if(empty($subuser)){
			$indParentUsers="";
			if($this->view->user->agency_user_type=="Agency"){
				$systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_id,"fetchAll",array("fields"=>"agency_id"));
				$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
				$indParentUsers=implode_r(",",$systemUsers);
                                if($sWhere){
                                    $sWhere.=" and groceries_added_user IN(".$indParentUsers.") and groceries_individual_id='".$indid."'"; 
                                }
                                else{
                                        $sWhere.=" where groceries_added_user IN(".$indParentUsers.") and groceries_individual_id='".$indid."'"; 
                                }
                                
			}
			else{
				$indParentUsers=$this->view->user->agency_id;
                                if($sWhere){
                                    $sWhere.=" and groceries_individual_id='".$indid."'"; 
                                }
                                else{
                                        $sWhere.=" where groceries_individual_id='".$indid."'"; 
                                }
			}
			
		}
		else{
			if($sWhere){
				$sWhere.=" and groceries_added_user IN(".$subuser.") and groceries_individual_id='".$indid."'"; 
			}
			else{
				$sWhere.=" where groceries_added_user IN(".$subuser.") and groceries_individual_id='".$indid."'"; 
			}
		}
		if(!empty($dstarts)){
			$sWhere.=" and DATE(groceries_service_date) >='".$dstarts."'";
		}
		if(!empty($dends)){
			$sWhere.=" and DATE(groceries_service_date) <='".$dends."'";
		}
		if(!empty($month)){
			$sWhere.=" and MONTH(groceries_service_date)='".$month."'";
		}
		if(!empty($year)){
			$sWhere.=" and YEAR(groceries_service_date)='".$year."'";
		}
		if(!empty($account)){
			$sWhere.=" and groceries_type='".$account."'";
		}
		if(!empty($id) && $id!=0){
			$sWhere.=" and groceries_id=".$id;
		}
                
                if(empty($month) && empty($year)){
                    if(!empty($sWhere)){
                            $sWhere.=" and MONTH(groceries_added_date)=MONTH(CURDATE()) and YEAR(groceries_added_date)=YEAR(CURDATE())";
                    }else{
                            $sWhere.=" where MONTH(groceries_added_date)=MONTH(CURDATE()) and YEAR(groceries_added_date)=YEAR(CURDATE())";
                    }
                }
                $sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
 		$qry2 = $this->dbObj->query($sQuery)->fetchAll();
		$sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal2 = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn_gr."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal2 = $rResultTotal[0]['cnt'];

		$iFilteredTotal_new=$iFilteredTotal_new+$iFilteredTotal2;
        $iTotal_new=$iTotal_new+$iTotal2;
//---------------------------------------------------------------------------------------------------------
		$output = array(
 				"iTotalRecords" => $iTotal_new,
				"iTotalDisplayRecords" => $iFilteredTotal_new,
				"aaData" => array()
			);
		$j=0;
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		foreach($qry as $row1){
			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['fl_added_user']."'","fetch");
			$modifierData=array();
			if($row1['fl_modified_by']!=0){
				$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['fl_modified_by']."'","fetch");
			}

			// $diff[]=$row1['fl_ending_balance'];

			// if(($diff[$j]-$diff[$j-1])!=$row1['fl_ending_balance'] && ($diff[$j]-$diff[$j-1])>0){
			//   $new= $diff[$j]-$diff[$j-1];
			// }
			if($row1['fl_amt_credit']!=0){
				$new=$row1['fl_amt_credit'];
			}
			$row=array();
 			$row[] = $j+1;
			$row[]='<input class="elem_ids checkboxes" type="checkbox" name="records['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';
			$row[]=formatDate($row1['fl_service_date']); 
			if($row1['fl_type']=='credit'||$row1['fl_type']=='gift'){
			 $row[]= ucwords($row1['fl_type'].' card');
		    } else{
		     $row[]= ucwords($row1['fl_type']);
		    }
			//$row[]=$row1['fl_starting_balance'];
			if(isset($new) && $row1['fl_amt_spend']==0){
			 $row[]='<span>'.$row1['fl_remaining_balance'].'</span><br><span style="color:green;">'.$new.'</span>'; 
			} else{
			 $row[]=$row1['fl_remaining_balance'];
			}
			if($row1['fl_amt_spend']>0){
			 $row[]='<span style="color:red;">-'.$row1['fl_amt_spend'].'</span>';
			} else{
			 $row[]= '-';
			}
			$row[]= $row1['fl_ending_balance']; 
			$lat="'".$row1['fl_latitude']."'";
			$long="'".$row1['fl_longitude']."'";
			$address="'".trim(preg_replace('/\s\s+/', ' ',$row1['fl_address']))."'";
			$row[]=ucwords($row1['fl_address']).' <i class="fa fa-map-marker markers" title="View Address on Map" onclick="showMap('.$lat.','.$long.','.$address.');"></i>';
			$row[]=$row1['fl_activity_desc'];
			if(!empty($row1['fl_uploads'])){
				$row[]="<a target='_blank' href='".HTTP_FINANCIAL_PATH."/".$row1['fl_uploads']."'>".formatDocumentName($row1['fl_uploads'])."</a>";
			}else{
				$row[]="NA";
			}
			$userType=printUserType($creatorData);
  			$row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
			$row[]=formatDateTimeNew($row1['fl_added_date']); 
			if(!empty($modifierData)){
				$userType=printUserType($modifierData);
				$row[]=ucwords($modifierData['agency_first_name']." ".$modifierData['agency_last_name'])."&nbsp;".$userType;
				$row[]=formatDateTime($row1['fl_modified_date']);
			}
			else{
				$row[]="-";
				$row[]="-";
			}
			
			$type='"Financial'.$row1['fl_type'].'"';
			$row[]=strtotime($row1['fl_added_date']);
			if(($permissions=="Edit" || $permissions=="Both") && !isFormAssigned($formid,$indid) && date("m")==date("m",strtotime($row1['fl_added_date']))){
				if($row1['fl_amt_spend']==0){

					$row[]="<b>NA</b>";

				} else{

				    $row[]="<a style='margin-top:5px;' href='javascript:void(1);' onclick='showDiffrentForms(".$indid.",".$formid.",".$row1[$sIndexColumn].",".$type.");' class='btn btn-xs btn-default'>Edit</a>";
			    }
			}
			else{
				$row[]="<b>NA</b>";
			}
 			$output['aaData'][] = $row;
			$j++;
		}
//------------------------------------------for food financial---------------------------------------------
        
        if($j>0){

         $i=$j;

        } else{

         $i=0;
        }

		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		foreach($qry_new as $row2){
			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row2['food_added_user']."'","fetch");
			$modifierData=array();
			if($row2['food_modified_by']!=0){
				$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row2['food_modified_by']."'","fetch");
			}
			if($row2['food_amt_credit']!=0){
				$new2=$row2['food_amt_credit'];
			}
			$row_new=array();
 			$row_new[] = $i+1;
			$row_new[]='<input class="elem_ids checkboxes" type="checkbox" name="fb_records['.$row2[$sIndexColumn_new].']"  value="'.$row2[$sIndexColumn_new].'">';
			$row_new[]=formatDate($row2['food_service_date']); 
			$row_new[]='Food Stamp';
			if(isset($new2) && $row2['food_amt_spend']==0){
			 $row_new[]='<span>'.$row2['food_remaining_balance'].'</span><br><span style="color:green;">'.$new2.'</span>'; 
			} else{
			 $row_new[]=$row2['food_remaining_balance'];
			}
			//$row_new[]=$row2['food_remaining_balance'];
			if($row2['food_amt_spend']>0){
			 $row_new[]='<span style="color:red;">-'.$row2['food_amt_spend'].'</span>';
			} else{
			 $row_new[]= '-';
			}

			//$row_new[]=$row2['food_amt_spend'];
			$row_new[]=$row2['food_ending_balance']; 
			$lat="'".$row2['food_latitude']."'";
			$long="'".$row2['food_longitude']."'";
			$address="'".trim(preg_replace('/\s\s+/', ' ',$row2['food_address']))."'";
			$row_new[]=ucwords($row2['food_address']).' <i class="fa fa-map-marker markers" title="View Address on Map" onclick="showMap('.$lat.','.$long.','.$address.');"></i>';
			$row_new[]=$row2['food_activity_description'];
			if(!empty($row2['food_upload'])){
				$row_new[]="<a target='_blank' href='".HTTP_FINANCIAL_PATH."/".$row2['food_upload']."'>".formatDocumentName($row2['food_upload'])."</a>";
			}else{
				$row_new[]="NA";
			}
			
			$userType=printUserType($creatorData);
  			$row_new[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
			$row_new[]=formatDateTimeNew($row2['food_added_date']); 

			if(!empty($modifierData)){
				$userType=printUserType($modifierData);
  				$row_new[]=ucwords($modifierData['agency_first_name']." ".$modifierData['agency_last_name'])."&nbsp;".$userType;
				$row_new[]=formatDateTimeNew($row2['food_modified_date']); 
			}
			else{ 
				$row_new[]="-";
				$row_new[]="-";
			}
			$type='"FOOD"';
			$row_new[]=strtotime($row2['food_added_date']);
			if(($permissions=="Edit" || $permissions=="Both") && !isFormAssigned($formid,$indid) && date("m")==date("m",strtotime($row2['food_added_date']))){

				if($row2['food_amt_spend']==0){

				   $row_new[]="<b>NA</b>";

				} else{

				   $row_new[]="<a style='margin-top:5px;' href='javascript:void(1);' onclick='showDiffrentForms(".$indid.",".$formid.",".$row2[$sIndexColumn_new].",".$type.");' class='btn btn-xs btn-default'>Edit</a>";
			    }
			}
			else{
				$row_new[]="<b>NA</b>";
			}
 			$output['aaData'][] = $row_new;
			$i++;
		}
//-------------------------------------------------for groceries------------------------------------------
		if($i>0){

         $k=$i;

        } else{

         $k=0;
        }

        $permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		foreach($qry2 as $row3){
			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row3['groceries_added_user']."'","fetch");
			$modifierData=array();
			if($row3['groceries_modified_by']!=0){
				$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row3['groceries_modified_by']."'","fetch");
			}

			if($row3['groceries_amt_credit']!=0){
				$new3=$row3['groceries_amt_credit'];
			}
			$row_new2=array();
 			$row_new2[] = $k+1;
			$row_new2[]='<input class="elem_ids checkboxes" type="checkbox" name="gr_records['.$row3[$sIndexColumn_gr].']"  value="'.$row3[$sIndexColumn_gr].'">';
			$row_new2[]=formatDate($row3['groceries_service_date']);
			$row_new2[]='Groceries'; 
			if(isset($new3) && $row3['groceries_amt_spend']==0){
			 $row_new2[]='<span>'.$row3['groceries_remaining_balance'].'</span><br><span style="color:green;">'.$new3.'</span>'; 
			} else{
			  $row_new2[]=$row3['groceries_remaining_balance'];
			}
			//$row_new2[]=$row3['groceries_remaining_balance'];
			//$row_new2[]=$row3['groceries_amt_spend'];
			if($row3['groceries_amt_spend']>0){
			 $row_new2[]='<span style="color:red;">-'.$row3['groceries_amt_spend'].'</span>';
			} else{
			 $row_new2[]= '-';
			}
			$row_new2[]=$row3['groceries_ending_balance']; 
			$lat="'".$row3['groceries_latitude']."'";
			$long="'".$row3['groceries_longitude']."'";
			$address="'".trim(preg_replace('/\s\s+/', ' ',$row3['groceries_address']))."'";
			$row_new2[]=ucwords($row3['groceries_address']).' <i class="fa fa-map-marker markers" title="View Address on Map" onclick="showMap('.$lat.','.$long.','.$address.');"></i>';
			$row_new2[]=$row3['groceries_activity_description'];
			if(!empty($row3['groceries_upload'])){
				$row_new2[]="<a target='_blank' href='".HTTP_FINANCIAL_PATH."/".$row3['groceries_upload']."'>".formatDocumentName($row3['groceries_upload'])."</a>";
			}else{
				$row_new2[]="NA";
			}
			
			$userType=printUserType($creatorData);
  			$row_new2[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
			$row_new2[]=formatDateTimeNew($row3['groceries_added_date']); 
			if(!empty($modifierData)){
				$userType=printUserType($modifierData);
  				$row_new2[]=ucwords($modifierData['agency_first_name']." ".$modifierData['agency_last_name'])."&nbsp;".$userType;
				$row_new2[]=formatDateTimeNew($row3['groceries_modified_date']); 
			}
			else{ 
				$row_new2[]="-";
				$row_new2[]="-";
			}
			$type='"GROCERIES"';
			$row_new2[]=strtotime($row3['groceries_added_date']);
			if(($permissions=="Edit" || $permissions=="Both") && !isFormAssigned($formid,$indid) && date("m")==date("m",strtotime($row3['groceries_added_date']))){

				if($row3['groceries_amt_spend']==0){

					$row_new2[]="<b>NA</b>";

				} else{

				   $row_new2[]="<a style='margin-top:5px;' href='javascript:void(1);' onclick='showDiffrentForms(".$indid.",".$formid.",".$row3[$sIndexColumn_gr].",".$type.");' class='btn btn-xs btn-default'>Edit</a>";
			    }
			}
			else{
				$row_new2[]="<b>NA</b>";
			}
 			$output['aaData'][] = $row_new2;
			$k++;
		}

//--------------------------------------------------------------------------------------------------------
		// foreach ($output as $k => $v) {
		// 	foreach ($v as $key => $value) {
		// 		$keys = array_column($value, '14');

  //               $output['aaData'][] = array_multisort($keys, SORT_ASC, $value);
		// 	}
			
		// }

		echo json_encode($output);
		exit();
	}
	
	public function viewassignedamountAction(){	
		global $healthSession; 
  		$this->view->pageHeading = "Initial Amounts";
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		if(empty($indid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		if(isFormAssigned($formid,$indid)){
			$healthSession->errorMsg="Please assign form to individual first.";
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_financial_logs");
		}
		$amtData=$this->SuperModel->Super_Get("_uhs_financial_ledger","fl_form_id=".$formid.' and fl_individual_id='.$indid.'',"fetch",array("fields"=>"SUM(fl_amt_spend) as totalSpent"));
	    $TotalAssignedAmount=$this->SuperModel->Super_Get("_uhs_financial_initial_balance","balance_form_id=".$formid." and balance_individual_id=".$indid."","fetch",array("order"=>"balance_id DESC"));
		
		$this->view->amtData=$amtData;
		$this->view->TotalAssignedAmount=$TotalAssignedAmount;
		$this->view->indid=$indid;
		$this->view->formid=$formid;
  	}
	
	public function viewassignedamountforallAction(){	
		
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$card= $this->_getParam("card");
		//if($card=='credit'){
		 $amtData=$this->SuperModel->Super_Get("_uhs_financial_ledger","fl_type='".$card."' and fl_form_id=".$formid.' and fl_individual_id='.$indid.'',"fetch",array("fields"=>"SUM(fl_amt_spend) as totalSpent"));
		//}
		// else{
		//  $amtData=$this->SuperModel->Super_Get("_uhs_financial_ledger","fl_form_id=".$formid.' and fl_individual_id='.$indid.'',"fetch",array("fields"=>"SUM(fl_amt_spend) as totalSpent"));
		// }

		$output['total_spent']= $amtData;

		//if($card=='credit'){
	      $TotalAssignedAmount=$this->SuperModel->Super_Get("_uhs_financial_".$card."_balance","balance_form_id=".$formid." and balance_individual_id=".$indid."","fetch",array("order"=>"balance_id DESC"));

	       $totalBalance=$this->SuperModel->Super_Get("_uhs_financial_".$card."_balance","balance_form_id=".$formid." and balance_individual_id=".$indid."","fetch",array("fields"=>"SUM(initial_balance) as totalBalance"));
		//} 
		// else{
		//   $TotalAssignedAmount=$this->SuperModel->Super_Get("_uhs_financial_initial_balance","balance_form_id=".$formid." and balance_individual_id=".$indid."","fetch",array("order"=>"balance_id DESC"));
		// }

		$output['assigned_amount'] = $TotalAssignedAmount;
		$output['total_balance'] = $totalBalance;
		echo json_encode($output);
		exit();

  	}
    //--------------------new added on 12.09.18----------------------------------
  	public function viewfoodamountAction(){	
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		
		$amtData=$this->SuperModel->Super_Get("_uhs_food_stamp","food_form_id=".$formid.' and food_individual_id='.$indid.'',"fetch",array("fields"=>"SUM(food_amt_spend) as totalSpent"));
		$output['total_spent']= $amtData;
		$TotalAssignedAmount=$this->SuperModel->Super_Get("_uhs_food_initial_balance","fb_form_id=".$formid." and fb_individual_id=".$indid."","fetch",array("order"=>"fbid DESC"));
		$totalBalance=$this->SuperModel->Super_Get("_uhs_food_initial_balance","fb_form_id=".$formid." and fb_individual_id=".$indid."","fetch",array("fields"=>"SUM(fb_initial_balance) as totalBalance"));
		$output['assigned_amount'] = $TotalAssignedAmount;
		$output['total_balance'] = $totalBalance;
		echo json_encode($output);
		exit();
  	}
    //--------------------new added on 12.09.18(End)----------------------------------

    public function viewgroceriesamountAction(){

    	$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
    	$amtData=$this->SuperModel->Super_Get("_uhs_groceries","groceries_form_id=".$formid.' and groceries_individual_id='.$indid.'',"fetch",array("fields"=>"SUM(groceries_amt_spend) as totalSpent"));
    	$output['total_spent']= $amtData;
		$TotalAssignedAmount=$this->SuperModel->Super_Get("_uhs_groceries_initial_balance","gr_form_id=".$formid." and gr_individual_id=".$indid."","fetch",array("order"=>"grid DESC"));
		$totalBalance=$this->SuperModel->Super_Get("_uhs_groceries_initial_balance","gr_form_id=".$formid." and gr_individual_id=".$indid."","fetch",array("fields"=>"SUM(gr_initial_balance) as totalBalance"));
		$output['assigned_amount'] = $TotalAssignedAmount;
		$output['total_balance'] = $totalBalance;
		echo json_encode($output);
		exit();
    }

	public function getassignedamountsAction(){
		// if(check_is_ajax($this->_request)){
		// 	$this->_redirect(APPLICATION_URL);
		// }
		// $indid=$this->_getParam("indid");
		// $formid=$this->_getParam("formid");
		// if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
		// 	$month=$_REQUEST['month'];
		// }
		// if(isset($_REQUEST['year']) && !empty($_REQUEST['year'])){
		// 	$year=$_REQUEST['year'];
		// }
 	// 	$this->dbObj = Zend_Registry::get('db');
		// $aColumns = array('balance_id','balance_form_id','balance_individual_id','initial_balance','remaining_balance','balance_added_date','balance_modified_by','balance_modified_on','balance_added_by');
		// $sIndexColumn = 'balance_id';
		// $sTable = '_uhs_financial_initial_balance';
		// $sLimit = "";
		// if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' ){
		// 	$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		// }
		// $sOrder = "";
		// if ( isset( $_GET['iSortCol_0'] ) )
		// {
		// 	$sOrder = "ORDER BY  ";
		// 	for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
		// 	{
		// 		if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
		// 		{
		// 			$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
		// 				($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
		// 		}
		// 	}
			
		// 	$sOrder = substr_replace( $sOrder, "", -2 );
		// 	if ( $sOrder == "ORDER BY" ){
		// 		$sOrder = "";
		// 	}
		// }
		// $sWhere = "";
		// if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
		// 	$sWhere = "WHERE (";
		// 	for ( $i=0 ; $i<count($aColumns) ; $i++ )
		// 	{
		// 		$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
		// 	}
		// 	$sWhere = substr_replace( $sWhere, "", -3 );
		// 	$sWhere .= ')';
		// }
		// for ( $i=0 ; $i<count($aColumns) ; $i++ )
		// {
		// 	if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
		// 	{
		// 		if ( $sWhere == "" )
		// 		{
		// 			$sWhere = "WHERE ";
		// 		}
		// 		else
		// 		{
		// 			$sWhere .= " AND ";
		// 		}
		// 		$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
		// 	}
		// }
	
		// if($sWhere){
  //           $sWhere.=" and balance_form_id=".$formid." and balance_individual_id='".$indid."'"; 
  //       }
  //     	else{
  //       	$sWhere.=" where balance_form_id=".$formid." and balance_individual_id='".$indid."'";  
  //       }
		// if(!empty($month)){
		// 	$sWhere.=" and MONTH(balance_added_date)=".$month; 
		// }
		// if(!empty($year)){
		// 	$sWhere.=" and YEAR(balance_added_date)='".$year."'"; 
		// }
		// $sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
		// //prd($sQuery);
 	// 	$qry = $this->dbObj->query($sQuery)->fetchAll();
		// $sQuery = "SELECT FOUND_ROWS() as fcnt";
		// $aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		// $iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		// $sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		// $rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		// $iTotal = $rResultTotal[0]['cnt'];
		// $output = array(
 	// 			"iTotalRecords" => $iTotal,
		// 		"iTotalDisplayRecords" => $iFilteredTotal,
		// 		"aaData" => array()
		// 	);
		// $j=0;
		// foreach($qry as $row1){
		// 	$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$row1['balance_added_by']);
		// 	$modifierData=array();
		// 	if($row1['balance_modified_by']!=0){
		// 		$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['balance_modified_by']."'","fetch");
		// 	}
		// 	$row=array();
 	// 		$row[] = $j+1;
		// 	$row[]='<input class="elem_ids checkboxes" type="checkbox" name="'.$sTable.'['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';
		//     $row[]=$row1['initial_balance'];
		// 	$row[]=$row1['remaining_balance'];
		// 	$userType=printUserType($creatorData);
		// 	$row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
		// 	$row[]=formatDateTimeNew($row1['balance_added_date']);
		// 	if(!empty($modifierData)){
		// 		$userType=printUserType($modifierData);
		// 		$row[]=ucwords($modifierData['agency_first_name']." ".$modifierData['agency_last_name'])."&nbsp;".$userType;
		// 		$row[]=formatDateTime($row1['balance_modified_on']);
		// 	}else{
		// 		$row[]="-";
		// 		$row[]="-";
		// 	}
		// 	if(date("m")==date("m",strtotime($row1['balance_added_date']))){
		// 		$row[]="<a style='margin-top:5px;' href='javascript:void(1);' onclick=showDiffrentForms(".$indid.",".$formid.",".$row1[$sIndexColumn].",'AssignedCredit'); class='btn btn-xs btn-default'>Edit</a>";
		// 	}
		// 	else{
		// 		//$row[]="<b>NA</b>";
		// 		$row[]="<a style='margin-top:5px;' href='javascript:void(1);' onclick=showDiffrentForms(".$indid.",".$formid.",".$row1[$sIndexColumn].",'AssignedCredit'); class='btn btn-xs btn-default'>Edit</a>";
		// 	}
 	// 		$output['aaData'][] = $row;
		// 	$j++;
		// }
		$output='';
		echo json_encode($output);
		exit();
	}
	
	//-----------new function for credit card data -------------------
	public function getcreditamountsAction(){
		if(check_is_ajax($this->_request)){
			$this->_redirect(APPLICATION_URL);
		}
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$account=$this->_getParam("account");

		if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
			$month=$_REQUEST['month'];
		}
		if(isset($_REQUEST['year']) && !empty($_REQUEST['year'])){
			$year=$_REQUEST['year'];

		}
 		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('balance_id','balance_form_id','balance_individual_id','initial_balance','remaining_balance','balance_added_date','balance_modified_by','balance_modified_on','balance_added_by');
		$sIndexColumn = 'balance_id';
		$sTable = '_uhs_financial_'.$account.'_balance';
		$sLimit = "";
		if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' ){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		if ( isset( $_GET['iSortCol_0'] ) )
		{
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
			{
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
				{
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
	
		if($sWhere){
            $sWhere.=" and balance_form_id=".$formid." and balance_individual_id='".$indid."'"; 
        }
      	else{
        	$sWhere.=" where balance_form_id=".$formid." and balance_individual_id='".$indid."'";  
        }
		if(!empty($month)){
			$sWhere.=" and MONTH(balance_added_date)=".$month; 
		}
		if(!empty($year)){
			$sWhere.=" and YEAR(balance_added_date)='".$year."'"; 
		}

		if(empty($month) && empty($year)){
                    if(!empty($sWhere)){
                        $sWhere.=" and MONTH(balance_added_date)=MONTH(CURDATE()) and YEAR(balance_added_date)=YEAR(CURDATE())";
                    }else{
                        $sWhere.=" where MONTH(balance_added_date)=MONTH(CURDATE()) and YEAR(balance_added_date)=YEAR(CURDATE())";
                    }
                }
		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
		//prd($sQuery);

 		$qry = $this->dbObj->query($sQuery)->fetchAll();
		$sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
		$output = array(
 				"iTotalRecords" => $iTotal,
				"iTotalDisplayRecords" => $iFilteredTotal,
				"aaData" => array()
			);
		$j=0;
		//$getBalance=$SuperModel->Super_Get("_uhs_financial_".$account."_balance","balance_form_id=".$formid." and balance_individual_id=".$indid."","fetch",array("order"=>"balance_id DESC"));
		// $getfinancialData=$SuperModel->Super_Get("_uhs_financial_ledger","fl_form_id=".$formid." and fl_type='".$account."' and fl_individual_id=".$indid."","fetchAll",array("order"=>"flid DESC"));
			
		// 	$remainBal=$getBalance['remaining_balance'];
		// 	if(count($getfinancialData)>0){
		// 	  $totalBal=0;
		// 	  foreach($getfinancialData as $fin){
		// 		$totalBal+=$fin['fl_amt_spend'];
		// 	   }
		// 	   $remainBal=$getBalance['remaining_balance']-$totalBal;
		// 	}

		//round($getBalance['remaining_balance'],2);
		foreach($qry as $row1){
			
			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$row1['balance_added_by']);
			$modifierData=array();
			if($row1['balance_modified_by']!=0){
				$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['balance_modified_by']."'","fetch");
			}
			$row=array();
 			$row[] = $j+1;
			$row[]='<input class="elem_ids checkboxes" type="checkbox" name="'.$sTable.'['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';
		    $row[]=$row1['initial_balance'];
			$row[]=$row1['remaining_balance'];
			$userType=printUserType($creatorData);
			$row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
			$row[]=formatDateTimeNew($row1['balance_added_date']);
			if(!empty($modifierData)){
				$userType=printUserType($modifierData);
				$row[]=ucwords($modifierData['agency_first_name']." ".$modifierData['agency_last_name'])."&nbsp;".$userType;
				$row[]=formatDateTime($row1['balance_modified_on']);
			}else{
				$row[]="-";
				$row[]="-";
			}
			// if(date("m")==date("m",strtotime($row1['balance_added_date']))){
			// 	$row[]="<a style='margin-top:5px;' href='javascript:void(1);' onclick=showDiffrentForms(".$indid.",".$formid.",".$row1[$sIndexColumn].",'get".$account."balance'); class='btn btn-xs btn-default'>Edit</a>";
			// }
			// else{
			// 	$row[]="<b>NA</b>";
			// 	//$row[]="<a style='margin-top:5px;' href='javascript:void(1);' onclick=showDiffrentForms(".$indid.",".$formid.",".$row1[$sIndexColumn].",'get".$account."balance'); class='btn btn-xs btn-default'>Edit</a>";
			// }
 			$output['aaData'][] = $row;
			$j++;
		}
		echo json_encode($output);
		exit();
	}

	//-------------------------------------------------------
public function getfledgerfinancialAction(){

   $formid=$this->_getParam("formid");
   $indid=$this->_getParam("indid");
   $id=$this->_getParam("id");
   $account=$this->_getParam("account");
   
   $SuperModel= new Application_Model_SuperModel();
//echo strcmp($account,'foodstamp');
//die;

    if($account!='foodstamp' && $account!='groceries'){
	   $getBalance=$SuperModel->Super_Get("_uhs_financial_".$account."_balance","balance_form_id=".$formid." and balance_individual_id=".$indid."","fetch",array("order"=>"balance_id DESC"));
		if($id==""){
			$getfinancialData=$SuperModel->Super_Get("_uhs_financial_ledger","fl_form_id=".$formid." and fl_type='".$account."' and fl_individual_id=".$indid."","fetchAll",array("order"=>"flid DESC"));

			//$remainBal=$getBalance['remaining_balance'];
			// if(count($getfinancialData)>0){
			//   $totalBal=0;
			//   foreach($getfinancialData as $fin){
			// 	$totalBal+=$fin['fl_amt_spend'];
			//    }
			//    $remainBal=$getBalance['remaining_balance']-$totalBal;
			// }

			$balance['fl_starting_balance']= round($getfinancialData[0]['fl_ending_balance'],2);
			$balance['fl_remaining_balance']= round($getfinancialData[0]['fl_ending_balance'],2);

		}
		else{
			$getfinancialData=$SuperModel->Super_Get("_uhs_financial_ledger","fl_form_id=".$formid." and fl_type='".$account."' and flid!=".$id." and fl_individual_id=".$indid."","fetchAll",array("order"=>"flid DESC"));

			$balanceData=$SuperModel->Super_Get("_uhs_financial_ledger","fl_form_id=".$formid." and fl_type='".$account."' and flid=".$id." and fl_individual_id=".$indid."","fetchAll",array("order"=>"flid DESC"));

			$remainBal=$getBalance['remaining_balance'];
			if(count($getfinancialData)>0){
			  $totalBal=0;
			  foreach($getfinancialData as $fin){
				$totalBal+=$fin['fl_amt_spend'];
			   }
			   $remainBal=$getBalance['remaining_balance']-$totalBal;
			}
	                                        
			$balance['fl_starting_balance']= round($getBalance['remaining_balance'],2);
			$balance['fl_remaining_balance']= round($remainBal,2);
			$balance['fl_service_date']= formatDate($balanceData[0]['fl_service_date']);
			$balance['fl_amt_spend']= $balanceData[0]['fl_amt_spend'];
			$balance['fl_ending_balance']= $balanceData[0]['fl_ending_balance'];
			$balance['fl_address']= $balanceData[0]['fl_address'];
			$balance['fl_activity_desc']= $balanceData[0]['fl_activity_desc'];
			$balance['fl_uploads']= $balanceData[0]['fl_uploads'];
		}
	}
	else if($account=='foodstamp'){

		$getBalance=$SuperModel->Super_Get("_uhs_food_initial_balance","fb_form_id=".$formid." and fb_individual_id=".$indid."","fetch",array("order"=>"fbid DESC"));
			if($id==""){
				$getfinancialData=$SuperModel->Super_Get("_uhs_food_stamp","food_form_id=".$formid." and food_individual_id=".$indid."","fetchAll",array("order"=>"food_id DESC"));
				$remainBal=$getBalance['fb_remaining_balance'];
				// if(count($getfinancialData)>0){
				// 	$totalBal=0;
				// 	foreach($getfinancialData as $fin){
				// 		$totalBal+=$fin['food_amt_spend'];
				// 	}
				// 	$remainBal=$getBalance['fb_remaining_balance']-$totalBal;
				// }
				$balance['fl_starting_balance']=  round($getfinancialData[0]['food_ending_balance'],2);
			    $balance['fl_remaining_balance']= round($getfinancialData[0]['food_ending_balance'],2);
			}
			else{
				$getfinancialData=$SuperModel->Super_Get("_uhs_food_stamp","food_form_id=".$formid." and food_id!=".$id." and food_individual_id=".$indid."","fetchAll",array("order"=>"food_id DESC"));
				$balanceData=$SuperModel->Super_Get("_uhs_food_stamp","food_form_id=".$formid." and food_id=".$id." and food_individual_id=".$indid."","fetchAll",array("order"=>"food_id DESC"));

					$remainBal=$getBalance['fb_remaining_balance'];
					if(count($getfinancialData)>0){
					  $totalBal=0;
					  foreach($getfinancialData as $fin){
						$totalBal+=$fin['food_amt_spend'];
					   }
					   $remainBal=$getBalance['fb_remaining_balance']-$totalBal;
					}
			                                        
					$balance['fl_starting_balance']= round($getBalance['fb_remaining_balance'],2);
					$balance['fl_remaining_balance']= round($remainBal,2);
					$balance['fl_service_date']= formatDate($balanceData[0]['fb_service_date']);
					$balance['fl_amt_spend']= $balanceData[0]['fb_amt_spend'];
					$balance['fl_ending_balance']= $balanceData[0]['fb_ending_balance'];
					$balance['fl_address']= $balanceData[0]['fb_address'];
					$balance['fl_activity_desc']= $balanceData[0]['fb_activity_desc'];
					$balance['fl_uploads']= $balanceData[0]['fb_uploads'];
			}
	}
			
	
	else{
	    $getBalance=$SuperModel->Super_Get("_uhs_groceries_initial_balance","gr_form_id=".$formid." and gr_individual_id=".$indid."","fetch",array("order"=>"grid DESC"));

			if($id==""){
				$getfinancialData=$SuperModel->Super_Get("_uhs_groceries","groceries_form_id=".$formid." and groceries_individual_id=".$indid."","fetchAll",array("order"=>"groceries_id DESC"));
				$remainBal=$getBalance['gr_remaining_balance'];
				// if(count($getfinancialData)>0){
				// 	$totalBal=0;
				// 	foreach($getfinancialData as $fin){
				// 		$totalBal+=$fin['groceries_amt_spend'];
				// 	}
				// 	$remainBal=$getBalance['gr_remaining_balance']-$totalBal;
				// }
				$balance['fl_starting_balance']=  round($getfinancialData[0]['groceries_ending_balance'],2);
			    $balance['fl_remaining_balance']= round($getfinancialData[0]['groceries_ending_balance'],2);	
			}
			else{
				$getfinancialData = $SuperModel->Super_Get("_uhs_groceries","groceries_form_id=".$formid." and groceries_id!=".$id." and groceries_individual_id=".$indid."","fetchAll",array("order"=>"groceries_id DESC"));
				$balanceData = $SuperModel->Super_Get("_uhs_groceries","groceries_form_id=".$formid." and groceries_id=".$id." and groceries_individual_id=".$indid."","fetchAll",array("order"=>"groceries_id DESC"));
				$remainBal=$getBalance['gr_remaining_balance'];
				if(count($getfinancialData)>0){
					$totalBal=0;
					foreach($getfinancialData as $fin){
						$totalBal+=$fin['groceries_amt_spend'];
					}
					$remainBal=$getBalance['gr_remaining_balance']-$totalBal;
				}
				$balance['fl_starting_balance']= round($getBalance['gr_remaining_balance'],2);
				$balance['fl_remaining_balance']= round($remainBal,2);
				$balance['fl_service_date']= formatDate($balanceData[0]['gr_service_date']);
				$balance['fl_amt_spend']= $balanceData[0]['gr_amt_spend'];
				$balance['fl_ending_balance']= $balanceData[0]['gr_ending_balance'];
				$balance['fl_address']= $balanceData[0]['gr_address'];
				$balance['fl_activity_desc']= $balanceData[0]['gr_activity_desc'];
				$balance['fl_uploads']= $balanceData[0]['gr_uploads'];

			}
			
	}

	echo json_encode($balance);
	exit();

}

public function savefinancialAction(){
		global $healthSession,$systemusers;
		$formid=$this->_getParam("formid");
		$indid=$this->_getParam("indid");
		$id=$this->_getParam("id");
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		if($permissions=="View Only"){
			$healthSession->errorMsg="You don't have permission to access this page.";
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_financial_logs");
		}

		if($this->getRequest()->getPost('credit')){
          $posted_data['fl_type']=$this->getRequest()->getPost('credit');
		}

		if($this->getRequest()->getPost('gift')){
          $posted_data['fl_type']=$this->getRequest()->getPost('gift');
		}

		if($this->getRequest()->getPost('spending')){
          $posted_data['fl_type']=$this->getRequest()->getPost('spending');
		}

		if($posted_data['fl_type']=='credit'||$posted_data['fl_type']=='gift'||$posted_data['fl_type']=='spending'){

		  $posted_data['fl_service_date']=$this->getRequest()->getPost('fl_service_date');
          $posted_data['fl_starting_balance']=$this->getRequest()->getPost('fl_starting_balance');
          $posted_data['fl_remaining_balance']=$this->getRequest()->getPost('fl_remaining_balance');
          $posted_data['fl_amt_spend']=$this->getRequest()->getPost('fl_amt_spend');
          $posted_data['fl_ending_balance']=$this->getRequest()->getPost('fl_ending_balance');
          $posted_data['fl_address']= $this->getRequest()->getPost('fl_address');
          $posted_data['fl_latitude']= $this->getRequest()->getPost('fl_latitude');
          $posted_data['fl_longitude']= $this->getRequest()->getPost('fl_longitude');
          $posted_data['fl_activity_desc']= $this->getRequest()->getPost('fl_activity_desc');
          $posted_data['fl_uploads']= $this->getRequest()->getPost('fl_uploads');
          $posted_data['MAX_FILE_SIZE']= $this->getRequest()->getPost('MAX_FILE_SIZE');

		  $getAssignedBalance=$this->SuperModel->Super_Get("_uhs_financial_".$posted_data['fl_type']."_balance","balance_form_id='".$formid."' and balance_individual_id='".$indid."'","fetch",array("order"=>"balance_id DESC"));
		}
		if($this->getRequest()->getPost('foodstamp')!=''){

		  if($this->getRequest()->getPost('fl_service_date')){
		  	$posted_data['food_service_date']=$this->getRequest()->getPost('fl_service_date');
		  }
		  if($this->getRequest()->getPost('food_service_date')){
		  	$posted_data['food_service_date']=$this->getRequest()->getPost('food_service_date');
		  }
		  if($this->getRequest()->getPost('fl_starting_balance')){
            $posted_data['food_starting_balance']=$this->getRequest()->getPost('fl_starting_balance');
          }
          if($this->getRequest()->getPost('food_starting_balance')){
          	$posted_data['food_starting_balance']=$this->getRequest()->getPost('food_starting_balance');
          }
          if($this->getRequest()->getPost('fl_remaining_balance')){
            $posted_data['food_remaining_balance']=$this->getRequest()->getPost('fl_remaining_balance');
          }
          if($this->getRequest()->getPost('food_remaining_balance')){
          	$posted_data['food_remaining_balance']=$this->getRequest()->getPost('food_remaining_balance');
          }
          if($this->getRequest()->getPost('fl_amt_spend')){
            $posted_data['food_amt_spend']=$this->getRequest()->getPost('fl_amt_spend');
          }
          if($this->getRequest()->getPost('food_amt_spend')){
            $posted_data['food_amt_spend']=$this->getRequest()->getPost('food_amt_spend');
          }
          if($this->getRequest()->getPost('fl_ending_balance')){
          	$posted_data['food_ending_balance']=$this->getRequest()->getPost('fl_ending_balance');
          }
          if($this->getRequest()->getPost('food_ending_balance')){
          	$posted_data['food_ending_balance']=$this->getRequest()->getPost('food_ending_balance');
          }
          if($this->getRequest()->getPost('fl_address')){
          	$posted_data['food_address']= $this->getRequest()->getPost('fl_address');
          }
          if($this->getRequest()->getPost('food_address')){
          	$posted_data['food_address']= $this->getRequest()->getPost('food_address');
          }

          if($this->getRequest()->getPost('fl_latitude')!=''){
           $posted_data['food_latitude']= $this->getRequest()->getPost('fl_latitude');
          } else{
           $posted_data['food_latitude']='';
          }

          if($this->getRequest()->getPost('food_latitude')!=''){
          	$posted_data['food_latitude']= $this->getRequest()->getPost('food_latitude');
          }
          if($this->getRequest()->getPost('fl_longitude')!=''){
            $posted_data['food_longitude']= $this->getRequest()->getPost('fl_longitude');
          } else{
          	$posted_data['food_longitude']='';
          }

          if($this->getRequest()->getPost('food_longitude')!=''){
          	$posted_data['food_longitude']= $this->getRequest()->getPost('food_longitude');
          }

          if($this->getRequest()->getPost('fl_activity_desc')){
          	$posted_data['food_activity_description']= $this->getRequest()->getPost('fl_activity_desc');
          }
          if($this->getRequest()->getPost('food_activity_description')){
          	$posted_data['food_activity_description']= $this->getRequest()->getPost('food_activity_description');  	
          }
          
          if($this->getRequest()->getPost('fl_uploads')!=''){   
           $posted_data['food_upload']= $this->getRequest()->getPost('fl_uploads');

          } else{
           $posted_data['food_upload']='';
          }

          if($this->getRequest()->getPost('food_upload')!=''){         
            $posted_data['food_upload']= $this->getRequest()->getPost('food_upload');
          }

          $posted_data['MAX_FILE_SIZE']= $this->getRequest()->getPost('MAX_FILE_SIZE');

		  $getAssignedBalance=$this->SuperModel->Super_Get("_uhs_food_initial_balance","fb_form_id='".$formid."' and fb_individual_id='".$indid."'","fetch",array("order"=>"fbid DESC"));
		}

        if($this->getRequest()->getPost('groceries')!=''){

          if($this->getRequest()->getPost('fl_service_date')){
		  	$posted_data['groceries_service_date']=$this->getRequest()->getPost('fl_service_date');
		  }
		  if($this->getRequest()->getPost('groceries_service_date')){
		  	$posted_data['groceries_service_date']=$this->getRequest()->getPost('groceries_service_date');
		  }
		  if($this->getRequest()->getPost('fl_starting_balance')){
            $posted_data['groceries_starting_balance']=$this->getRequest()->getPost('fl_starting_balance');
          }
          if($this->getRequest()->getPost('groceries_starting_balance')){
          	$posted_data['groceries_starting_balance']=$this->getRequest()->getPost('groceries_starting_balance');
          }
          if($this->getRequest()->getPost('fl_remaining_balance')){
            $posted_data['groceries_remaining_balance']=$this->getRequest()->getPost('fl_remaining_balance');
          }
          if($this->getRequest()->getPost('groceries_remaining_balance')){
          	$posted_data['groceries_remaining_balance']=$this->getRequest()->getPost('groceries_remaining_balance');
          }
          if($this->getRequest()->getPost('fl_amt_spend')){
            $posted_data['groceries_amt_spend']=$this->getRequest()->getPost('fl_amt_spend');
          }
          if($this->getRequest()->getPost('groceries_amt_spend')){
            $posted_data['groceries_amt_spend']=$this->getRequest()->getPost('groceries_amt_spend');
          }
          if($this->getRequest()->getPost('fl_ending_balance')){
          	$posted_data['groceries_ending_balance']=$this->getRequest()->getPost('fl_ending_balance');
          }
          if($this->getRequest()->getPost('groceries_ending_balance')){
          	$posted_data['groceries_ending_balance']=$this->getRequest()->getPost('groceries_ending_balance');
          }
          if($this->getRequest()->getPost('fl_address')){
          	$posted_data['groceries_address']= $this->getRequest()->getPost('fl_address');
          }
          if($this->getRequest()->getPost('groceries_address')){
          	$posted_data['groceries_address']= $this->getRequest()->getPost('groceries_address');
          }
         
          if($this->getRequest()->getPost('fl_latitude')!=''){
          	$posted_data['groceries_latitude']= $this->getRequest()->getPost('fl_latitude');
          }else{
          	$posted_data['groceries_latitude']='';
          }
          if($this->getRequest()->getPost('groceries_latitude')!=''){
          	$posted_data['groceries_latitude']= $this->getRequest()->getPost('groceries_latitude');
          }
          if($this->getRequest()->getPost('fl_longitude')!=''){
          	$posted_data['groceries_longitude']= $this->getRequest()->getPost('fl_longitude');
          }else{
          	$posted_data['groceries_longitude']='';
          }
          if($this->getRequest()->getPost('groceries_longitude')!=''){
          	$posted_data['groceries_longitude']= $this->getRequest()->getPost('groceries_longitude');
          }
          if($this->getRequest()->getPost('fl_activity_desc')){
          	$posted_data['groceries_activity_description']= $this->getRequest()->getPost('fl_activity_desc');
          }
          if($this->getRequest()->getPost('groceries_activity_description')){
          	$posted_data['groceries_activity_description']= $this->getRequest()->getPost('groceries_activity_description');  	
          }
          if($this->getRequest()->getPost('fl_uploads')!=''){      
            $posted_data['groceries_upload']= $this->getRequest()->getPost('fl_uploads');
          }else{
          	$posted_data['groceries_upload']='';
          }
          if($this->getRequest()->getPost('groceries_upload')!=''){         
            $posted_data['groceries_upload']= $this->getRequest()->getPost('groceries_upload');
          }

          $posted_data['MAX_FILE_SIZE']= $this->getRequest()->getPost('MAX_FILE_SIZE');

		  $getAssignedBalance=$this->SuperModel->Super_Get("_uhs_groceries_initial_balance","gr_form_id='".$formid."' and gr_individual_id='".$indid."'","fetch",array("order"=>"grid DESC"));

        }

		if(empty($getAssignedBalance)){
			$healthSession->errorMsg="You can't add financial log";
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_financial_logs");
		}
		$form=new Application_Form_CustomForms();
		$form->Financial($indid,$formid,$id);
		if($this->getRequest()->isPost()){
		
			unset($posted_data['MAX_FILE_SIZE']);
			// echo "<pre>";
			// print_r($posted_data);
			// die;
			if($posted_data['fl_type']=='credit'||$posted_data['fl_type']=='gift'||$posted_data['fl_type']=='spending'){

				if($form->isValid($posted_data)){

					$posted_data['fl_service_date']=date("Y-m-d",strtotime($posted_data['fl_service_date']));
					$getBalance=$this->SuperModel->Super_Get("_uhs_financial_".$posted_data['fl_type']."_balance","balance_form_id=".$formid." and balance_individual_id=".$indid."","fetch",array("order"=>"balance_id DESC"));
					if($id==""){
						$getfinancialData=$this->SuperModel->Super_Get("_uhs_financial_ledger","fl_form_id=".$formid." and fl_type='".$posted_data['fl_type']."' and fl_individual_id=".$indid."","fetchAll",array("order"=>"flid DESC"));
					}
					else{
						$getfinancialData=$this->SuperModel->Super_Get("_uhs_financial_ledger","fl_form_id=".$formid." and fl_type='".$posted_data['fl_type']."' and flid!=".$id." and fl_individual_id=".$indid."","fetchAll",array("order"=>"flid DESC"));
					}
					
					if(empty($id)){
						// $remainBal=$getBalance['remaining_balance'];
						// if(count($getfinancialData)>0){
						// 	$totalBal=0;
						// 	foreach($getfinancialData as $fin){
						// 		$totalBal+=$fin['fl_amt_spend'];
						// 	}
						// 	$remainBal=$getBalance['remaining_balance']-$totalBal;
						// }
	                   
						// if($remainBal!=$posted_data['fl_remaining_balance']){
						// 	$posted_data['fl_remaining_balance']=$remainBal;
						// 	if($posted_data['fl_amt_spend']>$remainBal){
						// 		$healthSession->errorMsg="Starting balance is not enough";
						// 		$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_financial_logs");
						// 	}
						// 	$posted_data['fl_ending_balance']=round($remainBal-$posted_data['fl_amt_spend'],2);
						// }

						 $indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
						 $agencyData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indData['agency_user_agency_id']);
						 $posted_data['fl_amt_credit']=0;
						 $posted_data['fl_credit_id']=0;
						 $posted_data['fl_agency_id']=$agencyData['agency_id'];
						 $posted_data['fl_individual_id']=$indid;
						 $posted_data['fl_form_id']=$formid;
						 $posted_data['fl_added_date']=date('Y-m-d H:i:s');
						 $posted_data['fl_modified_date']=NULL;
						 $posted_data['fl_added_user']=$this->view->user->subuser_id; //$this->view->user->agency_id;
						 $posted_data['fl_modified_by']=0;
						 // echo "<pre>";
						 // print_r($posted_data);
						 // die;
						 $isInserted = $this->SuperModel->Super_Insert("_uhs_financial_ledger",$posted_data);
						 if($isInserted->success){
							if(in_array($this->view->user->agency_user_type,$systemusers) && checkNotifySettings($this->view->user->agency_user_agency_id,"form-".$formid."-".$posted_data['fl_type'])){
								$notifyData=array("notification_user_id"=>$this->view->user->agency_user_agency_id,"notification_type"=>"form-".$formid."-".$posted_data['fl_type'],"notification_type_id"=>$isInserted->inserted_id,"notification_by_user_id"=>$this->view->user->agency_id,"notification_date"=>date("Y-m-d H:i:s"));
								$isNotify=$this->SuperModel->Super_Insert("_uhs_notifications",$notifyData);
							}
							$healthSession->successMsg  = "Financial ledger has been added successfully.";
						 }else{
							$healthSession->errorMsg  = $isInserted->message;
						 }
					}
					else{
						// echo "<pre>";
						// print_r($posted_data);
						// die;
						$fData=$this->SuperModel->Super_Get("_uhs_financial_ledger","flid=".$id);
						if(!empty($foodData['fl_uploads']) && $foodData['fl_uploads']!=$posted_data['fl_uploads'] && file_exists(FINANCIAL_PATH.'/'.$foodData['fl_uploads'])){
							unlink(FINANCIAL_PATH.'/'.$foodData['fl_uploads']);
						}
						$posted_data['fl_modified_date']=date('Y-m-d H:i:s');
						$posted_data['fl_modified_by']=$this->view->user->subuser_id;
                        
                        $fl_starting_balance =$posted_data['fl_remaining_balance'];
                        $fl_ending_balance =$posted_data['fl_ending_balance'];
                        //$fl_old_ending_balance = $posted_data['fl_ending_balance'];
                        //echo $fl_ending_balance;

                        //echo "<pre>";
                        //print_r($posted_data);

						$isInserted = $this->SuperModel->Super_Insert("_uhs_financial_ledger",$posted_data,"flid=".$id);

                        //-----new loop for data modification (03.10.18)-------------------
						if($isInserted->success){

							$getData=$this->SuperModel->Super_Get("_uhs_financial_ledger","fl_form_id=".$formid." and fl_type='".$posted_data['fl_type']."' and flid >".$id." and fl_individual_id=".$indid."","fetchAll",array("order"=>"flid ASC"));

							foreach ($getData as $key => $value) {
								if($value['fl_amt_spend']>0){

									//$fl_old_ending_balance = $value['fl_ending_balance'];
									$value['fl_starting_balance']=$fl_ending_balance;
									$value['fl_remaining_balance']=$fl_ending_balance;
									$value['fl_ending_balance']=$fl_ending_balance-$value['fl_amt_spend'];
									$value['fl_modified_date']=date('Y-m-d H:i:s');
							        $value['fl_modified_by']=$this->view->user->subuser_id;
							       
									
									$isInserted = $this->SuperModel->Super_Insert("_uhs_financial_ledger",$value,"flid=".$value['flid']);
									$fl_ending_balance=$value['fl_ending_balance'];

								} else{
									
									$actual_credit = $fl_ending_balance+$value['fl_amt_credit'];
									$value['fl_starting_balance']=$actual_credit;
									$value['fl_remaining_balance']=$actual_credit;
									$value['fl_ending_balance']=$actual_credit;
									$value['fl_modified_date']=date('Y-m-d H:i:s');
							        $value['fl_modified_by']=$this->view->user->subuser_id;
									$isInserted = $this->SuperModel->Super_Insert("_uhs_financial_ledger",$value,"flid=".$value['flid']);
									$isUpdate=$this->SuperModel->Super_Insert("_uhs_financial_".$value['fl_type']."_balance",array('remaining_balance'=>$actual_credit),"balance_id=".$value['fl_credit_id']);

									$fl_ending_balance=$value['fl_ending_balance'];

								}
							}
							
							$healthSession->successMsg  ="Financial ledger has been updated successfully.";

						} else{

							$healthSession->errorMsg  = $isInserted->message;
						}
					}
					 
	   			}else{
					$healthSession->errorMsg = " Please check information again.";
	 			}
	 		}

	 		if($this->getRequest()->getPost('foodstamp')!=''){

	 			$posted_data['food_service_date']=date("Y-m-d",strtotime($posted_data['food_service_date']));
	 			$getBalance=$this->SuperModel->Super_Get("_uhs_food_initial_balance","fb_form_id=".$formid." and fb_individual_id=".$indid."","fetch",array("order"=>"fbid DESC"));
				if(!empty($id)){
					$getfoodData=$this->SuperModel->Super_Get("_uhs_food_stamp","food_form_id=".$formid." and food_id!=".$id." and food_individual_id=".$indid."","fetchAll",array("order"=>"food_id DESC"));
				}
				else{
					$getfoodData=$this->SuperModel->Super_Get("_uhs_food_stamp","food_form_id=".$formid." and food_individual_id=".$indid."","fetchAll",array("order"=>"food_id DESC"));
				}
				
				if(empty($id)){
					// $remainBal=$getBalance['fb_remaining_balance'];
					// if(count($getfoodData)>0){
					// 		$totalBal=0;
					// 		foreach($getfoodData as $fin){
					// 			$totalBal+=$fin['food_amt_spend'];
					// 		}
					// 		$remainBal=$getBalance['fb_remaining_balance']-$totalBal;
					// }
					
					// if($remainBal!=$posted_data['food_remaining_balance']){ 
					// 	$posted_data['food_remaining_balance']=$remainBal;
					// 	if($posted_data['food_amt_spend']>$remainBal){
					// 		$healthSession->errorMsg="Starting balance is not enough";
					// 		$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_food_stamp_logs");
					// 	}
					// 	$posted_data['food_ending_balance']=round($remainBal-$posted_data['food_amt_spend'],2);
					// }
					
					 $indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
					 $agencyData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indData['agency_user_agency_id']);
					 $posted_data['food_amt_credit']=0;
					 $posted_data['food_credit_id']=0;
					 $posted_data['food_agency_id']=$agencyData['agency_id'];
					 $posted_data['food_individual_id']=$indid;
					 $posted_data['food_form_id']=$formid;
					 $posted_data['food_added_date']=date('Y-m-d H:i:s');
					 $posted_data['food_modified_date']=NULL;
					 $posted_data['food_added_user']=$this->view->user->subuser_id; //$this->view->user->agency_id;
					 $posted_data['food_modified_by']=0;
					 $posted_data['food_type']='foodstamp';
					
					 $isInserted = $this->SuperModel->Super_Insert("_uhs_food_stamp",$posted_data);
					 if($isInserted->success){
						if(in_array($this->view->user->agency_user_type,$systemusers) && checkNotifySettings($this->view->user->agency_user_agency_id,"form-".$formid)){
							$notifyData=array("notification_user_id"=>$this->view->user->agency_user_agency_id,"notification_type"=>"form-".$formid,"notification_type_id"=>$isInserted->inserted_id,"notification_by_user_id"=>$this->view->user->agency_id,"notification_date"=>date("Y-m-d H:i:s"));
							$isNotify=$this->SuperModel->Super_Insert("_uhs_notifications",$notifyData);
						}
						$healthSession->successMsg  = "Food stamp ledger has been added successfully.";
					 }else{
						$healthSession->errorMsg  = $isInserted->message;
					 }
				}
				else{
					$foodData=$this->SuperModel->Super_Get("_uhs_food_stamp","food_id=".$id);
					if(!empty($foodData['food_upload']) && $foodData['food_upload']!=$posted_data['food_upload'] && file_exists(STAMP_PATH.'/'.$foodData['food_upload'])){
						unlink(STAMP_PATH.'/'.$foodData['food_upload']);
					}
					$posted_data['food_modified_date']=date('Y-m-d H:i:s');
					$posted_data['food_modified_by']=$this->view->user->subuser_id;
					$food_starting_balance =$posted_data['food_remaining_balance'];
                    $food_ending_balance =$posted_data['food_ending_balance'];
					$isInserted = $this->SuperModel->Super_Insert("_uhs_food_stamp",$posted_data,"food_id=".$id);
					if($isInserted->success){

						$getData=$this->SuperModel->Super_Get("_uhs_food_stamp","food_form_id=".$formid." and food_id >".$id." and food_individual_id=".$indid."","fetchAll",array("order"=>"food_id ASC"));
                         
							foreach ($getData as $key => $value) {
								if($value['food_amt_spend']>0){

									//$fl_old_ending_balance = $value['fl_ending_balance'];
									$value['food_starting_balance']=$food_ending_balance;
									$value['food_remaining_balance']=$food_ending_balance;
									$value['food_ending_balance']=$food_ending_balance-$value['food_amt_spend'];
									$value['food_modified_date']=date('Y-m-d H:i:s');
							        $value['food_modified_by']=$this->view->user->subuser_id;
							       
									
									$isInserted = $this->SuperModel->Super_Insert("_uhs_food_stamp",$value,"food_id=".$value['food_id']);
									$food_ending_balance=$value['food_ending_balance'];

								} else{
									
									$actual_credit = $food_ending_balance+$value['food_amt_credit'];
									$value['food_starting_balance']=$actual_credit;
									$value['food_remaining_balance']=$actual_credit;
									$value['food_ending_balance']=$actual_credit;
									$value['food_modified_date']=date('Y-m-d H:i:s');
							        $value['food_modified_by']=$this->view->user->subuser_id;
							       
									$isInserted = $this->SuperModel->Super_Insert("_uhs_food_stamp",$value,"food_id=".$value['food_id']);
									$isUpdate=$this->SuperModel->Super_Insert("_uhs_food_initial_balance",array('fb_remaining_balance'=>$actual_credit),"fbid=".$value['food_credit_id']);

									$food_ending_balance=$value['food_ending_balance'];

								}
							}

						$healthSession->successMsg  ="Food stamp ledger has been updated successfully.";
					 }else{
						$healthSession->errorMsg  = $isInserted->message;
					 }
				}


	 		}

	 		if($this->getRequest()->getPost('groceries')!=''){

	 			$posted_data['groceries_service_date']=date("Y-m-d",strtotime($posted_data['groceries_service_date']));

	 			$getBalance=$this->SuperModel->Super_Get("_uhs_groceries_initial_balance","gr_form_id=".$formid." and gr_individual_id=".$indid."","fetch",array("order"=>"grid DESC"));
				if(!empty($id)){
					$getfoodData=$this->SuperModel->Super_Get("_uhs_groceries","groceries_form_id=".$formid." and groceries_id!=".$id." and groceries_individual_id=".$indid."","fetchAll",array("order"=>"groceries_id DESC"));
				}
				else{
					$getfoodData=$this->SuperModel->Super_Get("_uhs_groceries","groceries_form_id=".$formid." and groceries_individual_id=".$indid."","fetchAll",array("order"=>"groceries_id DESC"));
				}
				
				if(empty($id)){
					// $remainBal=$getBalance['gr_remaining_balance'];
					// if(count($getfoodData)>0){
					// 		$totalBal=0;
					// 		foreach($getfoodData as $fin){
					// 			$totalBal+=$fin['groceries_amt_spend'];
					// 		}
					// 		$remainBal=$getBalance['gr_remaining_balance']-$totalBal;
					// }
					// if($remainBal!=$posted_data['groceries_remaining_balance']){ 
					// 	$posted_data['groceries_remaining_balance']=$remainBal;
					// 	if($posted_data['groceries_amt_spend']>$remainBal){
					// 		$healthSession->errorMsg="Starting balance is not enough";
					// 		$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_groceries_logs");
					// 	}
					// 	$posted_data['groceries_ending_balance']=round($remainBal-$posted_data['groceries_amt_spend'],2);
					// }
					
					 $indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
					 $agencyData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indData['agency_user_agency_id']);
					 $posted_data['groceries_amt_credit']=0;
					 $posted_data['groceries_credit_id']=0;
					 $posted_data['groceries_agency_id']=$agencyData['agency_id'];
					 $posted_data['groceries_individual_id']=$indid;
					 $posted_data['groceries_form_id']=$formid;
					 $posted_data['groceries_added_date']=date('Y-m-d H:i:s');
					 $posted_data['groceries_modified_date']=NULL;
					 $posted_data['groceries_added_user']=$this->view->user->subuser_id; //$this->view->user->agency_id;
					 $posted_data['groceries_modified_by']=0;
					 $posted_data['groceries_type']='groceries';

					 $isInserted = $this->SuperModel->Super_Insert("_uhs_groceries",$posted_data);
					 if($isInserted->success){
						if(in_array($this->view->user->agency_user_type,$systemusers) && checkNotifySettings($this->view->user->agency_user_agency_id,"form-".$formid)){
							$notifyData=array("notification_user_id"=>$this->view->user->agency_user_agency_id,"notification_type"=>"form-".$formid,"notification_type_id"=>$isInserted->inserted_id,"notification_by_user_id"=>$this->view->user->agency_id,"notification_date"=>date("Y-m-d H:i:s"));
							$isNotify=$this->SuperModel->Super_Insert("_uhs_notifications",$notifyData);
						}
						$healthSession->successMsg  = "Groceries has been added successfully.";
					 }else{
						$healthSession->errorMsg  = $isInserted->message;
					 }
				}
				else{
					$foodData=$this->SuperModel->Super_Get("_uhs_groceries","groceries_id=".$id);
					if(!empty($foodData['groceries_upload']) && $foodData['groceries_upload']!=$posted_data['groceries_upload'] && file_exists(STAMP_PATH.'/'.$foodData['groceries_upload'])){
						unlink(STAMP_PATH.'/'.$foodData['groceries_upload']);
					}
					$posted_data['groceries_modified_date']=date('Y-m-d H:i:s');
					$posted_data['groceries_modified_by']=$this->view->user->subuser_id;
					$groceries_starting_balance =$posted_data['groceries_remaining_balance'];
                    $groceries_ending_balance =$posted_data['groceries_ending_balance'];
					$isInserted = $this->SuperModel->Super_Insert("_uhs_groceries",$posted_data,"groceries_id=".$id);
					if($isInserted->success){

						$getData=$this->SuperModel->Super_Get("_uhs_groceries","groceries_form_id=".$formid." and groceries_id >".$id." and groceries_individual_id=".$indid."","fetchAll",array("order"=>"groceries_id ASC"));

							foreach ($getData as $key => $value) {
								if($value['groceries_amt_spend']>0){

									//$fl_old_ending_balance = $value['fl_ending_balance'];
									$value['groceries_starting_balance']=$groceries_ending_balance;
									$value['groceries_remaining_balance']=$groceries_ending_balance;
									$value['groceries_ending_balance']=$groceries_ending_balance-$value['groceries_amt_spend'];
									$value['groceries_modified_date']=date('Y-m-d H:i:s');
							        $value['groceries_modified_by']=$this->view->user->subuser_id;
							       
									
									$isInserted = $this->SuperModel->Super_Insert("_uhs_groceries",$value,"groceries_id=".$value['groceries_id']);
									$groceries_ending_balance=$value['groceries_ending_balance'];

								} else{
									
									$actual_credit = $groceries_ending_balance+$value['groceries_amt_credit'];
									$value['groceries_starting_balance']=$actual_credit;
									$value['groceries_remaining_balance']=$actual_credit;
									$value['groceries_ending_balance']=$actual_credit;
									$value['groceries_modified_date']=date('Y-m-d H:i:s');
							        $value['groceries_modified_by']=$this->view->user->subuser_id;
									$isInserted = $this->SuperModel->Super_Insert("_uhs_groceries",$value,"groceries_id=".$value['groceries_id']);
									$isUpdate=$this->SuperModel->Super_Insert("_uhs_groceries_initial_balance",array('gr_remaining_balance'=>$actual_credit),"grid=".$value['groceries_credit_id']);

									$groceries_ending_balance=$value['groceries_ending_balance'];

								}
							}

						$healthSession->successMsg  ="Groceries has been updated successfully.";
					 }else{
						$healthSession->errorMsg  = $isInserted->message;
					 }
				}

	 		}
		}

		$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_financial_logs");
	}
//-----------------------------------modified(saveassignedfinancial)---------------------------------
	public function saveassignedfinancialAction(){
		global $healthSession;
		$formid=$this->_getParam("formid");
		$indid=$this->_getParam("indid");
		$id=$this->_getParam("id");
		$form=new Application_Form_CustomForms();
		$form->assignedBalance($indid,$formid,$id);
		if($this->getRequest()->getPost('credit_card')){
		  $account_type = $this->getRequest()->getPost('credit_card');
		}
		if($this->getRequest()->getPost('gift_card')){
			$account_type = $this->getRequest()->getPost('gift_card');
		}
		if($this->getRequest()->getPost('spending')){
			$account_type = $this->getRequest()->getPost('spending');
		}
		if($this->getRequest()->getPost('food_stamp')){
			$account_type = $this->getRequest()->getPost('food_stamp');
		}
		if($this->getRequest()->getPost('groceries')){
			$account_type = $this->getRequest()->getPost('groceries');
		}
		if($account_type!='foodstamp' && $account_type!='groceries'){
			if($this->getRequest()->isPost()){

				$posted_data['initial_balance'] = $this->getRequest()->getPost('initial_balance');
				
				//echo $account_type;
				//die;
				
		   			if($form->isValid($posted_data)){
						$indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
						$agencyData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indData['agency_user_agency_id']);
						if(empty($id)){
							 //if(isset($credit) && $credit=='credit'){
							 
							 	$amtData=$this->SuperModel->Super_Get("_uhs_financial_".$account_type."_balance","balance_individual_id='".$indid."' and balance_form_id='".$formid."'","fetch",array("order"=>"balance_id DESC"));
							   
							   
							 //} 
							 	//else{
							 // 	$amtData=$this->SuperModel->Super_Get("_uhs_financial_initial_balance","balance_individual_id='".$indid."' and balance_form_id='".$formid."'","fetch",array("order"=>"balance_id DESC"));
							 // }
							 
							 //$amtData=$this->SuperModel->Super_Get("_uhs_financial_initial_balance","MONTH(balance_added_date)=MONTH(CURDATE()) and balance_individual_id='".$indid."' and balance_form_id='".$formid."'","fetch",array("order"=>"balance_id DESC"));
							$posted_data['initial_balance']=abs($posted_data['initial_balance']);

							 $getBalance=$this->SuperModel->Super_Get("_uhs_financial_".$account_type."_balance","balance_form_id=".$formid." and balance_individual_id=".$indid."","fetch",array("order"=>"balance_id DESC"));

							 $gettotalBalance=$this->SuperModel->Super_Get("_uhs_financial_".$account_type."_balance","balance_form_id=".$formid." and balance_individual_id=".$indid."","fetch",array("fields"=>"SUM(initial_balance) as totalBalance"));

							 $getfinancialData=$this->SuperModel->Super_Get("_uhs_financial_ledger","fl_form_id=".$formid." and fl_type='".$account_type."' and fl_individual_id=".$indid."","fetchAll",array("order"=>"flid DESC"));

								$remainBal=$getBalance['remaining_balance'];

								if(count($getfinancialData)>0){
								  $totalSpent=0;
								  foreach($getfinancialData as $fin){
									$totalSpent+=$fin['fl_amt_spend'];
								   }
								   $remainBal= $gettotalBalance['totalBalance']+floatval($posted_data['initial_balance'])-$totalSpent;
								   //$remainBal= $remainBal+floatval($posted_data['initial_balance']);
								}

							 if(!empty($amtData)){
								 $posted_data['remaining_balance']= round($remainBal,2);
							 }
							 else{
								$posted_data['remaining_balance']=$posted_data['initial_balance'];	
							 }
							 $posted_data['balance_agency_id']=$agencyData['agency_id'];
							 $posted_data['balance_individual_id']=$indid;
							 $posted_data['balance_form_id']=$formid;
							 $posted_data['balance_added_by']=$this->view->user->subuser_id;
							 $posted_data['balance_added_date']=date('Y-m-d');
							 //----new added for local(04.09.18)----------
							 $posted_data['balance_modified_on']= date('Y-m-d H:i:s');
							 $posted_data['balance_modified_by']= '0';
							 //if(isset($credit) && $credit=='credit'){
							//if($account_type!='foodstamp' && $account_type!='groceries'){
							 	$isInserted = $this->SuperModel->Super_Insert("_uhs_financial_".$account_type."_balance",$posted_data);
							 //}
							 //} 
							 // else{
							 // 	$isInserted = $this->SuperModel->Super_Insert("_uhs_financial_initial_balance",$posted_data);
							 // }
							 $fl_blankpost=array();
							 $fl_blankpost['fl_type']=$account_type;
							 $fl_blankpost['fl_service_date']=date('Y-m-d');
							 $fl_blankpost['fl_starting_balance']= $posted_data['remaining_balance'];
							 $fl_blankpost['fl_remaining_balance']= $posted_data['remaining_balance'];
							 $fl_blankpost['fl_amt_credit']=$posted_data['initial_balance'];
							 $fl_blankpost['fl_credit_id']=$isInserted->inserted_id;
					         $fl_blankpost['fl_amt_spend']=0;
					         $fl_blankpost['fl_ending_balance']= $posted_data['remaining_balance'];
					         $fl_blankpost['fl_address']='NA';
					         $fl_blankpost['fl_latitude']='NA';
					         $fl_blankpost['fl_longitude']='NA';
					         $fl_blankpost['fl_activity_desc']='NA';
					         $fl_blankpost['fl_uploads']='';
							 $fl_blankpost['fl_agency_id']=$agencyData['agency_id'];
							 $fl_blankpost['fl_individual_id']=$indid;
							 $fl_blankpost['fl_form_id']=$formid;
							 $fl_blankpost['fl_added_date']=date('Y-m-d H:i:s');
							 $fl_blankpost['fl_modified_date']=NULL;
							 $fl_blankpost['fl_added_user']=$this->view->user->subuser_id; //$this->view->user->agency_id;
							 $fl_blankpost['fl_modified_by']=0;
							 $isInserted_new = $this->SuperModel->Super_Insert("_uhs_financial_ledger",$fl_blankpost);
							 if($isInserted->success && $isInserted_new->success){
								$healthSession->successMsg  = "Credit has been added successfully.";
							 }else{
								$healthSession->errorMsg  = $isInserted_new->message;
								//$healthSession->errorMsg = " Please select an account to add credit.";
							 }
						}//---------------------------Credit update Not in use(04.10.18) -----------------
						else{
							$posted_data['balance_modified_on']=date('Y-m-d H:i:s');
							$posted_data['balance_modified_by']=$this->view->user->subuser_id;
							$posted_data['initial_balance']=abs(round($posted_data['initial_balance']));
							$posted_data['remaining_balance']=round($posted_data['initial_balance']);	
							//if(isset($credit) && $credit=='credit'){
							
							 	$isInserted = $this->SuperModel->Super_Insert("_uhs_financial_".$account_type."_balance",$posted_data,"balance_id=".$id);
							

							//} 
							// else{
							//     $isInserted = $this->SuperModel->Super_Insert("_uhs_financial_initial_balance",$posted_data,"balance_id=".$id);
							// }

							if($isInserted->success){

								//if(isset($credit) && $credit=='credit'){
								

								  $amtData=$this->SuperModel->Super_Get("_uhs_financial_".$account_type."_balance","balance_individual_id='".$indid."' and balance_form_id='".$formid."'","fetchAll",array("order"=>"balance_id ASC"));
								

								//} 
								// else{
								//   $amtData=$this->SuperModel->Super_Get("_uhs_financial_initial_balance","balance_individual_id='".$indid."' and balance_form_id='".$formid."'","fetchAll",array("order"=>"balance_id ASC"));
								// }

								if(count($amtData) > 0){
									$totalBal=0;
									for($i=0;$i<count($amtData);$i++){
										$totalBal+=$amtData[$i]['initial_balance'];
										if($i==0){
											$remainBal=$amtData[$i]['initial_balance'];
										}
										else if($i<count($amtData)-1 && $i>0){
											$remainBal=$amtData[$i-1]['initial_balance']+$amtData[$i]['initial_balance'];
										}
										else{
											$remainBal=$totalBal;
										}
										$upArr=array('remaining_balance'=>$remainBal);
										//if(isset($credit) && $credit=='credit'){

										 $isUpdate=$this->SuperModel->Super_Insert("_uhs_financial_".$account_type."_balance",$upArr,"balance_id=".$amtData[$i]['balance_id']);
										

										//} 
										// else{

										//  $isUpdate=$this->SuperModel->Super_Insert("_uhs_financial_initial_balance",$upArr,"balance_id=".$amtData[$i]['balance_id']);
									 //    }
									}
								}
								$healthSession->successMsg  ="Credit has been updated successfully.";
							 }else{
								//$healthSession->errorMsg  = $isInserted->message;
								$healthSession->errorMsg = " Please select an account to update credit.";
							 }
						}
						 
		   			}else{
						$healthSession->errorMsg = " Please check information again.";
		 			}
		 		
			}
		}
		if($account_type=='foodstamp'){
			if($this->getRequest()->isPost()){
				if($this->getRequest()->getPost('initial_balance')){
				 $posted_data['fb_initial_balance'] = $this->getRequest()->getPost('initial_balance');
			    }

				if($this->getRequest()->getPost('fb_initial_balance')){
				 $posted_data['fb_initial_balance'] = $this->getRequest()->getPost('fb_initial_balance');
				}
	   			//if($form->isValid($posted_data)){
					$indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
					$agencyData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indData['agency_user_agency_id']);
					if(empty($id)){
						 $foodamtData=$this->SuperModel->Super_Get("_uhs_food_initial_balance","fb_individual_id='".$indid."' and fb_form_id='".$formid."'","fetch",array("order"=>"fbid DESC"));
						 //$foodamtData=$this->SuperModel->Super_Get("_uhs_food_initial_balance","MONTH(fb_added_date)=MONTH(CURDATE()) and fb_individual_id='".$indid."' and fb_form_id='".$formid."'","fetch",array("order"=>"fbid DESC"));
						 $posted_data['fb_initial_balance']=abs($posted_data['fb_initial_balance']);
						//-------------------------new code(04.10.18)--------------------------
						  $getBalance=$this->SuperModel->Super_Get("_uhs_food_initial_balance","fb_form_id=".$formid." and fb_individual_id=".$indid."","fetch",array("order"=>"fbid DESC"));

							 $gettotalBalance=$this->SuperModel->Super_Get("_uhs_food_initial_balance","fb_form_id=".$formid." and fb_individual_id=".$indid."","fetch",array("fields"=>"SUM(fb_initial_balance) as totalBalance"));

							 $getfinancialData=$this->SuperModel->Super_Get("_uhs_food_stamp","food_form_id=".$formid." and food_type='".$account_type."' and food_individual_id=".$indid."","fetchAll",array("order"=>"food_id DESC"));

								$remainBal=$getBalance['fb_remaining_balance'];

								if(count($getfinancialData)>0){
								  $totalSpent=0;
								  foreach($getfinancialData as $fin){
									$totalSpent+=$fin['food_amt_spend'];
								   }
								   $remainBal= $gettotalBalance['totalBalance']+floatval($posted_data['fb_initial_balance'])-$totalSpent;
								   //$remainBal= $remainBal+floatval($posted_data['initial_balance']);
								}

							 if(!empty($foodamtData)){
								 $posted_data['fb_remaining_balance']= round($remainBal,2);
							 }
							 else{
								$posted_data['fb_remaining_balance']=$posted_data['fb_initial_balance'];	
							 }

						//----------------------------------------------------------------------------
						 
						 // if(!empty($foodamtData)){
							// $posted_data['fb_remaining_balance']=floatval($foodamtData['fb_remaining_balance'])+floatval($posted_data['fb_initial_balance']);
						 // }
						 // else{
							// $posted_data['fb_remaining_balance']=$posted_data['fb_initial_balance'];	
						 // }
						//-----------------------------------------------------------------------------
						 $posted_data['fb_agency_id']=$agencyData['agency_id'];
						 $posted_data['fb_individual_id']=$indid;
						 $posted_data['fb_form_id']=$formid;
						 $posted_data['fb_added_by']=$this->view->user->subuser_id;
						 $posted_data['fb_added_date']=date('Y-m-d');
						 $posted_data['fb_modified_on']= date('Y-m-d H:i:s');
						 $posted_data['fb_modified_by']= '0';
						 $isInserted = $this->SuperModel->Super_Insert("_uhs_food_initial_balance",$posted_data);

						     $fb_blankpost=array();
							 $fb_blankpost['food_type']=$account_type;
							 $fb_blankpost['food_service_date']=date('Y-m-d');	
							 $fb_blankpost['food_starting_balance']= $posted_data['fb_remaining_balance'];
							 $fb_blankpost['food_remaining_balance']= $posted_data['fb_remaining_balance'];
							 $fb_blankpost['food_amt_credit']=$posted_data['fb_initial_balance'];
							 $fb_blankpost['food_credit_id']=$isInserted->inserted_id;
					         $fb_blankpost['food_amt_spend']=0;
					         $fb_blankpost['food_ending_balance']= $posted_data['fb_remaining_balance'];
					         $fb_blankpost['food_address']='NA';
					         $fb_blankpost['food_latitude']='NA';
					         $fb_blankpost['food_longitude']='NA';
					         $fb_blankpost['food_activity_description']='NA';
					         $fb_blankpost['food_upload']='';
							 $fb_blankpost['food_agency_id']=$agencyData['agency_id'];
							 $fb_blankpost['food_individual_id']=$indid;
							 $fb_blankpost['food_form_id']=$formid;
							 $fb_blankpost['food_added_date']=date('Y-m-d H:i:s');
							 $fb_blankpost['food_modified_date']=NULL;
							 $fb_blankpost['food_added_user']=$this->view->user->subuser_id; //$this->view->user->agency_id;
							 $fb_blankpost['food_modified_by']=0;

						 $fbInserted_new = $this->SuperModel->Super_Insert("_uhs_food_stamp",$fb_blankpost);

						 if($isInserted->success && $fbInserted_new->success){
							$healthSession->successMsg  = "Initial Balance has been added successfully.";
						 }else{
							$healthSession->errorMsg  = $fbInserted_new->message;
						 }
					}//---------------------------Credit update Not in use(04.10.18) -----------------
					else{
						$posted_data['fb_modified_on']=date('Y-m-d H:i:s');
						$posted_data['fb_modified_by']=$this->view->user->subuser_id;
						$posted_data['fb_initial_balance']=abs(round($posted_data['fb_initial_balance']));
						$posted_data['fb_remaining_balance']=round($posted_data['fb_initial_balance']);	
						$isInserted = $this->SuperModel->Super_Insert("_uhs_food_initial_balance",$posted_data,"fbid=".$id);
						if($isInserted->success){
							 $foodamtData=$this->SuperModel->Super_Get("_uhs_food_initial_balance","fb_individual_id='".$indid."' and fb_form_id='".$formid."'","fetchAll",array("order"=>"fbid ASC"));
							  if(count($foodamtData) > 0){
								$totalBal=0;
								for($i=0;$i<count($foodamtData);$i++){
									$totalBal+=$foodamtData[$i]['fb_initial_balance'];
									if($i==0){
										$remainBal=$foodamtData[$i]['fb_initial_balance'];
									}
									else if($i<count($foodamtData)-1 && $i>0){
										$remainBal=$foodamtData[$i-1]['fb_initial_balance']+$foodamtData[$i]['fb_initial_balance'];
									}
									else{
										$remainBal=$totalBal;
									}
									$upArr=array('fb_remaining_balance'=>$remainBal);
									$isUpdate=$this->SuperModel->Super_Insert("_uhs_food_initial_balance",$upArr,"fbid=".$foodamtData[$i]['fbid']);
								}
							}
							$healthSession->successMsg  ="Initial Balance has been updated successfully.";
						 }else{
							$healthSession->errorMsg  = $isInserted->message;
						}
					}
	   			//}
		    }
		}
		if($account_type=='groceries'){

		    if($this->getRequest()->isPost()){
				if($this->getRequest()->getPost('initial_balance')){
				 $posted_data['gr_initial_balance'] = $this->getRequest()->getPost('initial_balance');
			    }

				if($this->getRequest()->getPost('gr_initial_balance')){
				 $posted_data['gr_initial_balance'] = $this->getRequest()->getPost('gr_initial_balance');
				}
					$indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
					$agencyData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indData['agency_user_agency_id']);
					if(empty($id)){
						 $foodamtData=$this->SuperModel->Super_Get("_uhs_groceries_initial_balance","gr_individual_id='".$indid."' and gr_form_id='".$formid."'","fetch",array("order"=>"grid DESC"));
						 //$foodamtData=$this->SuperModel->Super_Get("_uhs_food_initial_balance","MONTH(fb_added_date)=MONTH(CURDATE()) and fb_individual_id='".$indid."' and fb_form_id='".$formid."'","fetch",array("order"=>"fbid DESC"));
						 $posted_data['gr_initial_balance']=abs($posted_data['gr_initial_balance']);
						 //---------------------------Modified section (04.10.18) -------------------------

						  $getBalance=$this->SuperModel->Super_Get("_uhs_groceries_initial_balance","gr_form_id=".$formid." and gr_individual_id=".$indid."","fetch",array("order"=>"grid DESC"));

							 $gettotalBalance=$this->SuperModel->Super_Get("_uhs_groceries_initial_balance","gr_form_id=".$formid." and gr_individual_id=".$indid."","fetch",array("fields"=>"SUM(gr_initial_balance) as totalBalance"));

							 $getfinancialData=$this->SuperModel->Super_Get("_uhs_groceries","groceries_form_id=".$formid." and groceries_type='".$account_type."' and groceries_individual_id=".$indid."","fetchAll",array("order"=>"groceries_id DESC"));

								$remainBal=$getBalance['gr_remaining_balance'];

								if(count($getfinancialData)>0){
								  $totalSpent=0;
								  foreach($getfinancialData as $fin){
									$totalSpent+=$fin['groceries_amt_spend'];
								   }
								   $remainBal= $gettotalBalance['totalBalance']+floatval($posted_data['gr_initial_balance'])-$totalSpent;
								   //$remainBal= $remainBal+floatval($posted_data['initial_balance']);
								}

							 if(!empty($foodamtData)){
								 $posted_data['gr_remaining_balance']= round($remainBal,2);
							 }
							 else{
								$posted_data['gr_remaining_balance']=$posted_data['gr_initial_balance'];	
							 }


						 //-------------------------------------------------------------------------------
						 // if(!empty($foodamtData)){
							// $posted_data['gr_remaining_balance']=floatval($foodamtData['gr_remaining_balance'])+floatval($posted_data['gr_initial_balance']);
						 // }
						 // else{
							// $posted_data['gr_remaining_balance']=$posted_data['gr_initial_balance'];	
						 // }
						//----------------------------------------------------------------------------------
						 $posted_data['gr_agency_id']=$agencyData['agency_id'];
						 $posted_data['gr_individual_id']=$indid;
						 $posted_data['gr_form_id']=$formid;
						 $posted_data['gr_added_by']=$this->view->user->subuser_id;
						 $posted_data['gr_added_date']=date('Y-m-d');
						 $posted_data['gr_modified_on']= date('Y-m-d H:i:s');
						 $posted_data['gr_modified_by']= '0';
						 $isInserted = $this->SuperModel->Super_Insert("_uhs_groceries_initial_balance",$posted_data);

						     $gr_blankpost=array();
							 $gr_blankpost['groceries_type']=$account_type;
							 $gr_blankpost['groceries_service_date']=date('Y-m-d');				        
							 $gr_blankpost['groceries_starting_balance'] = $posted_data['gr_remaining_balance'];
						     $gr_blankpost['groceries_remaining_balance'] = $posted_data['gr_remaining_balance'];	
					         $gr_blankpost['groceries_amt_credit']=$posted_data['gr_initial_balance'];
							 $gr_blankpost['groceries_credit_id']=$isInserted->inserted_id;
					         $gr_blankpost['groceries_amt_spend']=0;
					         $gr_blankpost['groceries_ending_balance']= $posted_data['gr_remaining_balance'];
					         $gr_blankpost['groceries_address']='NA';
					         $gr_blankpost['groceries_latitude']='NA';
					         $gr_blankpost['groceries_longitude']='NA';
					         $gr_blankpost['groceries_activity_description']='NA';
					         $gr_blankpost['groceries_upload']='';
							 $gr_blankpost['groceries_agency_id']=$agencyData['agency_id'];
							 $gr_blankpost['groceries_individual_id']=$indid;
							 $gr_blankpost['groceries_form_id']=$formid;
							 $gr_blankpost['groceries_added_date']=date('Y-m-d H:i:s');
							 $gr_blankpost['groceries_modified_date']=NULL;
							 $gr_blankpost['groceries_added_user']=$this->view->user->subuser_id; //$this->view->user->agency_id;
							 $gr_blankpost['groceries_modified_by']=0;

						 $grInserted_new = $this->SuperModel->Super_Insert("_uhs_groceries",$gr_blankpost);

						 if($isInserted->success && $grInserted_new->success){
							$healthSession->successMsg  = "Initial Balance has been added successfully.";
						 }else{
							$healthSession->errorMsg  = $isInserted->message;
						 }
					}
					else{ //---------------------------Credit update Not in use(04.10.18) -----------------
						$posted_data['gr_modified_on']=date('Y-m-d H:i:s');
						$posted_data['gr_modified_by']=$this->view->user->subuser_id;
						$posted_data['gr_initial_balance']=abs(round($posted_data['gr_initial_balance']));
						$posted_data['gr_remaining_balance']=round($posted_data['gr_initial_balance']);	
						$isInserted = $this->SuperModel->Super_Insert("_uhs_groceries_initial_balance",$posted_data,"grid=".$id);
						if($isInserted->success){
							 $foodamtData=$this->SuperModel->Super_Get("_uhs_groceries_initial_balance","gr_individual_id='".$indid."' and gr_form_id='".$formid."'","fetchAll",array("order"=>"grid ASC"));
							  if(count($foodamtData) > 0){
								$totalBal=0;
								for($i=0;$i<count($foodamtData);$i++){
									$totalBal+=$foodamtData[$i]['gr_initial_balance'];
									if($i==0){
										$remainBal=$foodamtData[$i]['gr_initial_balance'];
									}
									else if($i<count($foodamtData)-1 && $i>0){
										$remainBal=$foodamtData[$i-1]['gr_initial_balance']+$foodamtData[$i]['gr_initial_balance'];
									}
									else{
										$remainBal=$totalBal;
									}
									$upArr=array('gr_remaining_balance'=>$remainBal);
									$isUpdate=$this->SuperModel->Super_Insert("_uhs_groceries_initial_balance",$upArr,"grid=".$foodamtData[$i]['grid']);
								}
							}
							$healthSession->successMsg  ="Initial Balance has been updated successfully.";
						}else{
							$healthSession->errorMsg  = $isInserted->message;
						}
					}
	   			
		    }

		}

		$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_assigned_balance");
	}
//-----------------------------------modified(saveassignedfinancial)---------------------------------
	public function removefinancialAction(){
		global $healthSession;
		$indid=$this->_getParam('indid');
		$formid=$this->_getParam('formid');
 		$this->_helper->layout->disableLayout();
		$this->_helper->viewRenderer->setNoRender(true);
		$formData = $this->getRequest()->getPost();

		if(isset($formData['records']) && count($formData['records'])) {
			foreach($formData['records'] as $key=>$values){
  				$isDel=$this->SuperModel->Super_Delete('_uhs_financial_ledger',"flid=".$values);
 				$healthSession->successMsg="Financial Ledger(s) has been deleted successfully.";
			}
		}
		elseif(isset($formData['gr_records']) && count($formData['gr_records'])) {
			foreach($formData['gr_records'] as $key=>$values){
  				$isDel=$this->SuperModel->Super_Delete('_uhs_groceries',"groceries_id=".$values);
 				$healthSession->successMsg="Financial Ledger(s) has been deleted successfully.";
			}
		}
		elseif(isset($formData['fb_records']) && count($formData['fb_records'])) {
			foreach($formData['fb_records'] as $key=>$values){
  				$isDel=$this->SuperModel->Super_Delete('_uhs_food_stamp',"food_id=".$values);
 				$healthSession->successMsg="Financial Ledger(s) has been deleted successfully.";
			}
		}
		else{
			$healthSession->errorMsg = "Invalid Request.";
		}
		$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_financial_logs");
	}
	
	public function removeassignedfinancialamtAction(){
		global $healthSession;
		$indid=$this->_getParam('indid');
		$formid=$this->_getParam('formid');
 		$this->_helper->layout->disableLayout();
		$this->_helper->viewRenderer->setNoRender(true);
		$formData = $this->getRequest()->getPost();
		//print_r($formData);
		//die;
		if(isset($formData['_uhs_financial_initial_balance']) && count($formData['_uhs_financial_initial_balance'])) {
			foreach($formData['_uhs_financial_initial_balance'] as $key=>$values){
  				$isDel=$this->SuperModel->Super_Delete('_uhs_financial_initial_balance',"balance_id=".$values);
			}
			$amtData=$this->SuperModel->Super_Get("_uhs_financial_initial_balance","balance_individual_id='".$indid."' and balance_form_id='".$formid."'","fetchAll",array("order"=>"balance_id ASC"));
			if(count($amtData) > 0){
				$totalBal=0;
				for($i=0;$i<count($amtData);$i++){
					$totalBal+=$amtData[$i]['initial_balance'];
					if($i==0){
						$remainBal=$amtData[$i]['initial_balance'];
					}
					else if($i<count($amtData)-1 && $i>0){
						$remainBal=$amtData[$i-1]['initial_balance']+$amtData[$i]['initial_balance'];
					}
					else{
						$remainBal=$totalBal;
					}
					$upArr=array('remaining_balance'=>$remainBal);
					$isUpdate=$this->SuperModel->Super_Insert("_uhs_financial_initial_balance",$upArr,"balance_id=".$amtData[$i]['balance_id']);
				}
		    }
			$healthSession->successMsg="Assigned Financial Amount Log(s) has been deleted successfully.";

		} elseif(isset($formData['_uhs_financial_credit_balance']) && count($formData['_uhs_financial_credit_balance'])){

			foreach($formData['_uhs_financial_credit_balance'] as $key=>$values){
  				$isDel=$this->SuperModel->Super_Delete('_uhs_financial_credit_balance',"balance_id=".$values);
			}
			$amtData=$this->SuperModel->Super_Get("_uhs_financial_credit_balance","balance_individual_id='".$indid."' and balance_form_id='".$formid."'","fetchAll",array("order"=>"balance_id ASC"));
			if(count($amtData) > 0){
				$totalBal=0;
				for($i=0;$i<count($amtData);$i++){
					$totalBal+=$amtData[$i]['initial_balance'];
					if($i==0){
						$remainBal=$amtData[$i]['initial_balance'];
					}
					else if($i<count($amtData)-1 && $i>0){
						$remainBal=$amtData[$i-1]['initial_balance']+$amtData[$i]['initial_balance'];
					}
					else{
						$remainBal=$totalBal;
					}
					$upArr=array('remaining_balance'=>$remainBal);
					$isUpdate=$this->SuperModel->Super_Insert("_uhs_financial_credit_balance",$upArr,"balance_id=".$amtData[$i]['balance_id']);
				}
		    }
			$healthSession->successMsg="Assigned Credit Card Amount Log(s) has been deleted successfully.";

		}elseif(isset($formData['_uhs_financial_gift_balance']) && count($formData['_uhs_financial_gift_balance'])){

			foreach($formData['_uhs_financial_gift_balance'] as $key=>$values){
  				$isDel=$this->SuperModel->Super_Delete('_uhs_financial_gift_balance',"balance_id=".$values);
			}
			$amtData=$this->SuperModel->Super_Get("_uhs_financial_gift_balance","balance_individual_id='".$indid."' and balance_form_id='".$formid."'","fetchAll",array("order"=>"balance_id ASC"));
			if(count($amtData) > 0){
				$totalBal=0;
				for($i=0;$i<count($amtData);$i++){
					$totalBal+=$amtData[$i]['initial_balance'];
					if($i==0){
						$remainBal=$amtData[$i]['initial_balance'];
					}
					else if($i<count($amtData)-1 && $i>0){
						$remainBal=$amtData[$i-1]['initial_balance']+$amtData[$i]['initial_balance'];
					}
					else{
						$remainBal=$totalBal;
					}
					$upArr=array('remaining_balance'=>$remainBal);
					$isUpdate=$this->SuperModel->Super_Insert("_uhs_financial_gift_balance",$upArr,"balance_id=".$amtData[$i]['balance_id']);
				}
		    }
			$healthSession->successMsg="Assigned Gift Card Amount Log(s) has been deleted successfully.";

		}elseif(isset($formData['_uhs_financial_spending_balance']) && count($formData['_uhs_financial_spending_balance'])){

			foreach($formData['_uhs_financial_spending_balance'] as $key=>$values){
  				$isDel=$this->SuperModel->Super_Delete('_uhs_financial_spending_balance',"balance_id=".$values);
			}
			$amtData=$this->SuperModel->Super_Get("_uhs_financial_spending_balance","balance_individual_id='".$indid."' and balance_form_id='".$formid."'","fetchAll",array("order"=>"balance_id ASC"));
			if(count($amtData) > 0){
				$totalBal=0;
				for($i=0;$i<count($amtData);$i++){
					$totalBal+=$amtData[$i]['initial_balance'];
					if($i==0){
						$remainBal=$amtData[$i]['initial_balance'];
					}
					else if($i<count($amtData)-1 && $i>0){
						$remainBal=$amtData[$i-1]['initial_balance']+$amtData[$i]['initial_balance'];
					}
					else{
						$remainBal=$totalBal;
					}
					$upArr=array('remaining_balance'=>$remainBal);
					$isUpdate=$this->SuperModel->Super_Insert("_uhs_financial_spending_balance",$upArr,"balance_id=".$amtData[$i]['balance_id']);
				}
		    }
			$healthSession->successMsg="Assigned Spending Amount Log(s) has been deleted successfully.";

		}elseif(isset($formData['_uhs_food_initial_balance']) && count($formData['_uhs_food_initial_balance'])) {

			foreach($formData['_uhs_food_initial_balance'] as $key=>$values){
  				$isDel=$this->SuperModel->Super_Delete('_uhs_food_initial_balance',"fbid=".$values);
			}
			$foodamtData=$this->SuperModel->Super_Get("_uhs_food_initial_balance","fb_individual_id='".$indid."' and fb_form_id='".$formid."'","fetchAll",array("order"=>"fbid ASC"));
			if(count($foodamtData) > 0){
							$totalBal=0;
							for($i=0;$i<count($foodamtData);$i++){
								$totalBal+=$foodamtData[$i]['fb_initial_balance'];
								if($i==0){
									$remainBal=$foodamtData[$i]['fb_initial_balance'];
								}
								else if($i<count($foodamtData)-1 && $i>0){
									$remainBal=$foodamtData[$i-1]['fb_initial_balance']+$foodamtData[$i]['fb_initial_balance'];
								}
								else{
									$remainBal=$totalBal;
								}
								$upArr=array('fb_remaining_balance'=>$remainBal);
								$isUpdate=$this->SuperModel->Super_Insert("_uhs_food_initial_balance",$upArr,"fbid=".$foodamtData[$i]['fbid']);
							}
						}
			$healthSession->successMsg="Assigned Food Amount Log(s) has been deleted successfully.";

		}elseif(isset($formData['_uhs_groceries_initial_balance']) && count($formData['_uhs_groceries_initial_balance'])) {

			foreach($formData['_uhs_groceries_initial_balance'] as $key=>$values){
  				$isDel=$this->SuperModel->Super_Delete('_uhs_groceries_initial_balance',"grid=".$values);
			}
			$foodamtData=$this->SuperModel->Super_Get("_uhs_groceries_initial_balance","gr_individual_id='".$indid."' and gr_form_id='".$formid."'","fetchAll",array("order"=>"grid ASC"));
			if(count($foodamtData) > 0){
							$totalBal=0;
							for($i=0;$i<count($foodamtData);$i++){
								$totalBal+=$foodamtData[$i]['gr_initial_balance'];
								if($i==0){
									$remainBal=$foodamtData[$i]['gr_initial_balance'];
								}
								else if($i<count($foodamtData)-1 && $i>0){
									$remainBal=$foodamtData[$i-1]['gr_initial_balance']+$foodamtData[$i]['gr_initial_balance'];
								}
								else{
									$remainBal=$totalBal;
								}
								$upArr=array('gr_remaining_balance'=>$remainBal);
								$isUpdate=$this->SuperModel->Super_Insert("_uhs_groceries_initial_balance",$upArr,"grid=".$foodamtData[$i]['grid']);
							}
						}
			$healthSession->successMsg="Assigned Groceries Amount Log(s) has been deleted successfully.";
		}
		else{
			$healthSession->errorMsg="Invalid Request.";
		}
		$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_assigned_balance");
	}
	
	// Food Stamp Ledger Form
	public function foodstampAction(){	
		global $healthSession; 
  		$this->view->pageHeading = "Food Stamp Ledger";
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		if(empty($indid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		$getAssignedBalance=$this->SuperModel->Super_Get("_uhs_food_initial_balance","fb_form_id='".$formid."' and fb_individual_id='".$indid."'","fetch",array("order"=>"fbid DESC"));
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		$this->view->permissions=$permissions;
		$this->view->indid=$indid;
		$this->view->formid=$formid;
		$this->view->id=$id;
		$this->view->getAssignedBalance=$getAssignedBalance;
  	}
	
	public function getfoodstampsAction(){
		if(check_is_ajax($this->_request)){
			$this->_redirect(APPLICATION_URL);
		}
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		$subuser=$dstarts=$dends=$month=$year="";
		if(isset($_REQUEST['subuser']) && !empty($_REQUEST['subuser'])){
			$subuser=$_REQUEST['subuser'];
		}
		if(isset($_REQUEST['dstarts']) && !empty($_REQUEST['dstarts'])){
			$dstarts=$_REQUEST['dstarts'];
		}
		if(isset($_REQUEST['dends']) && !empty($_REQUEST['dends'])){
			$dends=$_REQUEST['dends'];
		}
		if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
			$month=$_REQUEST['month'];
		}
		if(isset($_REQUEST['year']) && !empty($_REQUEST['year'])){
			$year=$_REQUEST['year'];
		}
 		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('food_id','food_added_user','food_service_date','food_starting_balance','food_amt_spend','food_ending_balance','food_address','food_upload','food_activity_description','food_added_date','food_latitude','food_longitude','food_modified_date','food_modified_by','food_modified_date');
		$sIndexColumn = 'food_id';
		$sTable = '_uhs_food_stamp';
		$sLimit = "";
		if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' ){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		if ( isset( $_GET['iSortCol_0'] ) )
		{
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
			{
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
				{
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
		
		if(empty($subuser)){
			$indParentUsers="";
			if($this->view->user->agency_user_type=="Agency"){
				$systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_id,"fetchAll",array("fields"=>"agency_id"));
				$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
				$indParentUsers=implode_r(",",$systemUsers);
                                if($sWhere){
                                    $sWhere.=" and food_added_user IN(".$indParentUsers.") and food_individual_id='".$indid."'"; 
                                }
                                else{
                                        $sWhere.=" where food_added_user IN(".$indParentUsers.") and food_individual_id='".$indid."'"; 
                                }
                                
			}
			else{
				$indParentUsers=$this->view->user->agency_id;
                                if($sWhere){
                                    $sWhere.=" and food_individual_id='".$indid."'"; 
                                }
                                else{
                                        $sWhere.=" where food_individual_id='".$indid."'"; 
                                }
			}
			
		}
		else{
			if($sWhere){
				$sWhere.=" and food_added_user IN(".$subuser.") and food_individual_id='".$indid."'"; 
			}
			else{
				$sWhere.=" where food_added_user IN(".$subuser.") and food_individual_id='".$indid."'"; 
			}
		}
		if(!empty($dstarts)){
			$sWhere.=" and DATE(food_service_date) >='".$dstarts."'";
		}
		if(!empty($dends)){
			$sWhere.=" and DATE(food_service_date) <='".$dends."'";
		}
		if(!empty($month)){
			$sWhere.=" and MONTH(food_service_date)='".$month."'";
		}
		if(!empty($year)){
			$sWhere.=" and YEAR(food_service_date)='".$year."'";
		}
		if(!empty($id) && $id!=0){
			$sWhere.=" and food_id=".$id;
		}
		if(empty($month) && empty($year)){
                    if(!empty($sWhere)){
                            $sWhere.=" and MONTH(food_added_date)=MONTH(CURDATE()) and YEAR(food_added_date)=YEAR(CURDATE())";
                    }else{
                            $sWhere.=" where MONTH(food_added_date)=MONTH(CURDATE()) and YEAR(food_added_date)=YEAR(CURDATE())";
                    }
                }
		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
 		$qry = $this->dbObj->query($sQuery)->fetchAll();
		$sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
		$output = array(
 				"iTotalRecords" => $iTotal,
				"iTotalDisplayRecords" => $iFilteredTotal,
				"aaData" => array()
			);
		$j=0;
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		foreach($qry as $row1){
			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['food_added_user']."'","fetch");
			$modifierData=array();
			if($row1['food_modified_by']!=0){
				$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['food_modified_by']."'","fetch");
			}
			$row=array();
 			$row[] = $j+1;
			$row[]='<input class="elem_ids checkboxes" type="checkbox" name="records['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';
			$row[]=formatDate($row1['food_service_date']); 
			$row[]=$row1['food_starting_balance'];
			$row[]=$row1['food_amt_spend'];
			$row[]=$row1['food_ending_balance']; 
			$lat="'".$row1['food_latitude']."'";
			$long="'".$row1['food_longitude']."'";
			$address="'".trim(preg_replace('/\s\s+/', ' ',$row1['food_address']))."'";
			$row[]=ucwords($row1['food_address']).' <i class="fa fa-map-marker markers" title="View Address on Map" onclick="showMap('.$lat.','.$long.','.$address.');"></i>';
			if(!empty($row1['food_upload'])){
				$row[]="<a target='_blank' href='".HTTP_STAMP_PATH."/".$row1['food_upload']."'>".formatDocumentName($row1['food_upload'])."</a>";
			}else{
				$row[]="NA";
			}
			$row[]=$row1['food_activity_description'];
			$userType=printUserType($creatorData);
  			$row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
			$row[]=formatDateTimeNew($row1['food_added_date']); 
			if(!empty($modifierData)){
				$userType=printUserType($modifierData);
  				$row[]=ucwords($modifierData['agency_first_name']." ".$modifierData['agency_last_name'])."&nbsp;".$userType;
				$row[]=formatDateTimeNew($row1['food_modified_date']); 
			}
			else{ 
				$row[]="-";
				$row[]="-";
			}
			$type='"FOOD"';
			if(($permissions=="Edit" || $permissions=="Both") && !isFormAssigned($formid,$indid) && date("m")==date("m",strtotime($row1['food_added_date']))){
				$row[]="<a style='margin-top:5px;' href='javascript:void(1);' onclick='showDiffrentForms(".$indid.",".$formid.",".$row1[$sIndexColumn].",".$type.");' class='btn btn-xs btn-default'>Edit</a>";
			}
			else{
				$row[]="<b>NA</b>";
			}
 			$output['aaData'][] = $row;
			$j++;
		}
		echo json_encode($output);
		exit();
	}
	
	public function viewassignedfoodamountAction(){	
		global $healthSession; 
  		$this->view->pageHeading = "Initial Balance";
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		if(empty($indid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		if(isFormAssigned($formid,$indid)){
			$healthSession->errorMsg="Please assign form to individual first.";
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_food_stamp_logs");
		}
		$amtData=$this->SuperModel->Super_Get("_uhs_food_stamp","food_form_id=".$formid.' and food_individual_id='.$indid.'',"fetch",array("fields"=>"SUM(food_amt_spend) as totalSpent"));
		$TotalAssignedAmount=$this->SuperModel->Super_Get("_uhs_food_initial_balance","fb_form_id=".$formid." and fb_individual_id=".$indid."","fetch",array("order"=>"fbid DESC"));
		
		$this->view->amtData=$amtData;
		$this->view->TotalAssignedAmount=$TotalAssignedAmount;
		$this->view->indid=$indid;
		$this->view->formid=$formid;
  	}
	
	public function getassignedfoodamountsAction(){
		if(check_is_ajax($this->_request)){
			$this->_redirect(APPLICATION_URL);
		}
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
			$month=$_REQUEST['month'];
		}
		if(isset($_REQUEST['year']) && !empty($_REQUEST['year'])){
			$year=$_REQUEST['year'];
		}
 		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('fbid','fb_form_id','fb_individual_id','fb_initial_balance','fb_remaining_balance','fb_added_date','fb_added_by','fb_modified_on','fb_modified_by');
		$sIndexColumn = 'fbid';
		$sTable = '_uhs_food_initial_balance';
		$sLimit = "";
		if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' ){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		if ( isset( $_GET['iSortCol_0'] ) )
		{
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
			{
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
				{
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
	
		if($sWhere){
            $sWhere.=" and fb_form_id=".$formid." and fb_individual_id='".$indid."'"; 
        }
      	else{
        	$sWhere.=" where fb_form_id=".$formid." and fb_individual_id='".$indid."'";  
        }
		if(!empty($month)){
			$sWhere.=" and MONTH(fb_added_date)=".$month; 
		}
		if(!empty($year)){
			$sWhere.=" and YEAR(fb_added_date)='".$year."'"; 
		}


		if(empty($month) && empty($year)){
                    if(!empty($sWhere)){
                        $sWhere.=" and MONTH(fb_added_date)=MONTH(CURDATE()) and YEAR(fb_added_date)=YEAR(CURDATE())";
                    }else{
                        $sWhere.=" where MONTH(fb_added_date)=MONTH(CURDATE()) and YEAR(fb_added_date)=YEAR(CURDATE())";
                    }
                }

		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
 		$qry = $this->dbObj->query($sQuery)->fetchAll();
		$sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
		$output = array(
 				"iTotalRecords" => $iTotal,
				"iTotalDisplayRecords" => $iFilteredTotal,
				"aaData" => array()
			);
		$j=0;
		foreach($qry as $row1){
			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$row1['fb_added_by']);
			$modifierData=array();
			if($row1['fb_modified_by']!=0){
				$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['fb_modified_by']."'","fetch");
			}
			$row=array();
 			$row[] = $j+1;
			$row[]='<input class="elem_ids checkboxes" type="checkbox" name="'.$sTable.'['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';
		    $row[]=$row1['fb_initial_balance'];
			$row[]=$row1['fb_remaining_balance'];
			$userType=printUserType($creatorData);
			$row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
			$row[]=formatDate($row1['fb_added_date']);
			if(!empty($modifierData)){
				$userType=printUserType($modifierData);
				$row[]=ucwords($modifierData['agency_first_name']." ".$modifierData['agency_last_name'])."&nbsp;".$userType;
				$row[]=formatDateTime($row1['fb_modified_on']);
			}
			else{
				$row[]="-";
				$row[]="-";
			}
			if(date("m")==date("m",strtotime($row1['fb_added_date']))){
		   		 $row[]="<a style='margin-top:5px;' href='javascript:void(1);' onclick=showDiffrentForms(".$indid.",".$formid.",".$row1[$sIndexColumn].",'AssignedFoodBalance'); class='btn btn-xs btn-default'>Edit</a>";
			}
			else{
				$row[]="<b>NA</b>";
			}
 			$output['aaData'][] = $row;
			$j++;
		}
		echo json_encode($output);
		exit();
	}
	
	public function savefoodstampAction(){
		global $healthSession,$systemusers;
		$formid=$this->_getParam("formid");
		$indid=$this->_getParam("indid");
		$id=$this->_getParam("id");
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		if($permissions=="View Only"){
			$healthSession->errorMsg="You don't have permission to access this page.";
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_food_stamp_logs");
		}
		$getAssignedBalance=$this->SuperModel->Super_Get("_uhs_food_initial_balance","fb_form_id='".$formid."' and fb_individual_id='".$indid."'","fetch",array("order"=>"fbid DESC"));
		if(empty($getAssignedBalance)){
			$healthSession->errorMsg="You can't add financial log";
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_food_stamp_logs");
		}
		$form=new Application_Form_CustomForms();
		$form->FoodStamp($indid,$formid,$id);
		if($this->getRequest()->isPost()){
			$posted_data = $this->getRequest()->getPost();
			unset($posted_data['MAX_FILE_SIZE']);
   			if($form->isValid($posted_data)){
				$getBalance=$this->SuperModel->Super_Get("_uhs_food_initial_balance","fb_form_id=".$formid." and fb_individual_id=".$indid."","fetch",array("order"=>"fbid DESC"));
				if(!empty($id)){
					$getfoodData=$this->SuperModel->Super_Get("_uhs_food_stamp","food_form_id=".$formid." and food_id!=".$id." and food_individual_id=".$indid."","fetchAll",array("order"=>"food_id DESC"));
				}
				else{
					$getfoodData=$this->SuperModel->Super_Get("_uhs_food_stamp","food_form_id=".$formid." and food_individual_id=".$indid."","fetchAll",array("order"=>"food_id DESC"));
				}
				$remainBal=$getBalance['fb_remaining_balance'];
				if(count($getfoodData)>0){
						$totalBal=0;
						foreach($getfoodData as $fin){
							$totalBal+=$fin['food_amt_spend'];
						}
						$remainBal=$getBalance['fb_remaining_balance']-$totalBal;
				}
				if($remainBal!=$posted_data['food_remaining_balance']){ 
					$posted_data['food_remaining_balance']=$remainBal;
					if($posted_data['food_amt_spend']>$remainBal){
						$healthSession->errorMsg="Starting balance is not enough";
						$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_food_stamp_logs");
					}
					$posted_data['food_ending_balance']=round($remainBal-$posted_data['food_amt_spend'],2);
				}
				$posted_data['food_service_date']=date("Y-m-d",strtotime($posted_data['food_service_date']));
				if(empty($id)){
					 $indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
					 $agencyData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indData['agency_user_agency_id']);
					 $posted_data['food_agency_id']=$agencyData['agency_id'];
					 $posted_data['food_individual_id']=$indid;
					 $posted_data['food_form_id']=$formid;
					 $posted_data['food_added_date']=date('Y-m-d H:i:s');
					 $posted_data['food_modified_date']=NULL;
					 $posted_data['food_added_user']=$this->view->user->subuser_id; //$this->view->user->agency_id;
					 $isInserted = $this->SuperModel->Super_Insert("_uhs_food_stamp",$posted_data);
					 if($isInserted->success){
						if(in_array($this->view->user->agency_user_type,$systemusers) && checkNotifySettings($this->view->user->agency_user_agency_id,"form-".$formid)){
							$notifyData=array("notification_user_id"=>$this->view->user->agency_user_agency_id,"notification_type"=>"form-".$formid,"notification_type_id"=>$isInserted->inserted_id,"notification_by_user_id"=>$this->view->user->agency_id,"notification_date"=>date("Y-m-d H:i:s"));
							$isNotify=$this->SuperModel->Super_Insert("_uhs_notifications",$notifyData);
						}
						$healthSession->successMsg  = "Food stamp ledger has been added successfully.";
					 }else{
						$healthSession->errorMsg  = $isInserted->message;
					 }
				}
				else{
					$foodData=$this->SuperModel->Super_Get("_uhs_food_stamp","food_id=".$id);
					if(!empty($foodData['food_upload']) && $foodData['food_upload']!=$posted_data['food_upload'] && file_exists(STAMP_PATH.'/'.$foodData['food_upload'])){
						unlink(STAMP_PATH.'/'.$foodData['food_upload']);
					}
					$posted_data['food_modified_date']=date('Y-m-d H:i:s');
					$posted_data['food_modified_by']=$this->view->user->subuser_id;
					$isInserted = $this->SuperModel->Super_Insert("_uhs_food_stamp",$posted_data,"food_id=".$id);
					if($isInserted->success){
						$healthSession->successMsg  ="Food stamp ledger has been updated successfully.";
					 }else{
						$healthSession->errorMsg  = $isInserted->message;
					 }
				}
				 
   			}else{
				$healthSession->errorMsg = " Please check information again.";
 			}
		 }
		 $this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_food_stamp_logs");
	}
	
	public function saveassignedfoodamtAction(){
		global $healthSession;
		$formid=$this->_getParam("formid");
		$indid=$this->_getParam("indid");
		$id=$this->_getParam("id");
		$form=new Application_Form_CustomForms();
		$form->assignedFoodBalance($indid,$formid,$id);
		
		if($this->getRequest()->isPost()){
			$posted_data = $this->getRequest()->getPost();
   			if($form->isValid($posted_data)){
				$indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
				$agencyData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indData['agency_user_agency_id']);
				if(empty($id)){
					 $foodamtData=$this->SuperModel->Super_Get("_uhs_food_initial_balance","fb_individual_id='".$indid."' and fb_form_id='".$formid."'","fetch",array("order"=>"fbid DESC"));
					 //$foodamtData=$this->SuperModel->Super_Get("_uhs_food_initial_balance","MONTH(fb_added_date)=MONTH(CURDATE()) and fb_individual_id='".$indid."' and fb_form_id='".$formid."'","fetch",array("order"=>"fbid DESC"));
					 $posted_data['fb_initial_balance']=abs($posted_data['fb_initial_balance']);
					 if(!empty($foodamtData)){
						$posted_data['fb_remaining_balance']=floatval($foodamtData['fb_remaining_balance'])+floatval($posted_data['fb_initial_balance']);
					 }
					 else{
						$posted_data['fb_remaining_balance']=$posted_data['fb_initial_balance'];	
					 }
					 $posted_data['fb_agency_id']=$agencyData['agency_id'];
					 $posted_data['fb_individual_id']=$indid;
					 $posted_data['fb_form_id']=$formid;
					 $posted_data['fb_added_by']=$this->view->user->subuser_id;
					 $posted_data['fb_added_date']=date('Y-m-d');
					 $posted_data['fb_modified_on']= date('Y-m-d H:i:s');
					 $posted_data['fb_modified_by']= '0';
					 $isInserted = $this->SuperModel->Super_Insert("_uhs_food_initial_balance",$posted_data);
					 if($isInserted->success){
						$healthSession->successMsg  = "Initial Balance has been added successfully.";
					 }else{
						$healthSession->errorMsg  = $isInserted->message;
					 }
				}
				else{
					$posted_data['fb_modified_on']=date('Y-m-d H:i:s');
					$posted_data['fb_modified_by']=$this->view->user->subuser_id;
					$posted_data['fb_initial_balance']=abs(round($posted_data['fb_initial_balance']));
					$posted_data['fb_remaining_balance']=round($posted_data['fb_initial_balance']);	
					$isInserted = $this->SuperModel->Super_Insert("_uhs_food_initial_balance",$posted_data,"fbid=".$id);
					if($isInserted->success){
						 $foodamtData=$this->SuperModel->Super_Get("_uhs_food_initial_balance","fb_individual_id='".$indid."' and fb_form_id='".$formid."'","fetchAll",array("order"=>"fbid ASC"));
						  if(count($foodamtData) > 0){
							$totalBal=0;
							for($i=0;$i<count($foodamtData);$i++){
								$totalBal+=$foodamtData[$i]['fb_initial_balance'];
								if($i==0){
									$remainBal=$foodamtData[$i]['fb_initial_balance'];
								}
								else if($i<count($foodamtData)-1 && $i>0){
									$remainBal=$foodamtData[$i-1]['fb_initial_balance']+$foodamtData[$i]['fb_initial_balance'];
								}
								else{
									$remainBal=$totalBal;
								}
								$upArr=array('fb_remaining_balance'=>$remainBal);
								$isUpdate=$this->SuperModel->Super_Insert("_uhs_food_initial_balance",$upArr,"fbid=".$foodamtData[$i]['fbid']);
							}
						}
						$healthSession->successMsg  ="Initial Balance has been updated successfully.";
					 }else{
						$healthSession->errorMsg  = $isInserted->message;
					}
				}
   			}else{
				$healthSession->errorMsg = " Please check information again.";
 			}
		 }
		$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_assigned_food_balance");
		 //$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_assigned_balance");
	}
	
	public function removefoodstampAction(){
		global $healthSession;
		$indid=$this->_getParam('indid');
		$formid=$this->_getParam('formid');
 		$this->_helper->layout->disableLayout();
		$this->_helper->viewRenderer->setNoRender(true);
		$formData = $this->getRequest()->getPost();
		if(isset($formData['records']) && count($formData['records'])) {
			foreach($formData['records'] as $key=>$values){
  				$isDel=$this->SuperModel->Super_Delete('_uhs_food_stamp',"food_id=".$values);
 				$healthSession->successMsg="Food Stamp Ledger(s) has been deleted successfully.";
			}
		}
		else{
			$healthSession->errorMsg = "Invalid Request.";
		}
		$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_food_stamp_logs");
	}
	
	public function removeassignedfoodamtAction(){
		global $healthSession;
		$indid=$this->_getParam('indid');
		$formid=$this->_getParam('formid');
 		$this->_helper->layout->disableLayout();
		$this->_helper->viewRenderer->setNoRender(true);
		$formData = $this->getRequest()->getPost();
		if(isset($formData['_uhs_food_initial_balance']) && count($formData['_uhs_food_initial_balance'])) {
			foreach($formData['_uhs_food_initial_balance'] as $key=>$values){
  				$isDel=$this->SuperModel->Super_Delete('_uhs_food_initial_balance',"fbid=".$values);
			}
			$foodamtData=$this->SuperModel->Super_Get("_uhs_food_initial_balance","fb_individual_id='".$indid."' and fb_form_id='".$formid."'","fetchAll",array("order"=>"fbid ASC"));
			if(count($foodamtData) > 0){
							$totalBal=0;
							for($i=0;$i<count($foodamtData);$i++){
								$totalBal+=$foodamtData[$i]['fb_initial_balance'];
								if($i==0){
									$remainBal=$foodamtData[$i]['fb_initial_balance'];
								}
								else if($i<count($foodamtData)-1 && $i>0){
									$remainBal=$foodamtData[$i-1]['fb_initial_balance']+$foodamtData[$i]['fb_initial_balance'];
								}
								else{
									$remainBal=$totalBal;
								}
								$upArr=array('fb_remaining_balance'=>$remainBal);
								$isUpdate=$this->SuperModel->Super_Insert("_uhs_food_initial_balance",$upArr,"fbid=".$foodamtData[$i]['fbid']);
							}
						}
			$healthSession->successMsg="Assigned Food Amount Log(s) has been deleted successfully.";
		}
		else{
			$healthSession->errorMsg="Invalid Request.";
		}
		$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_assigned_food_balance");
	}
	
	private function _handle_document($formid){ 
 		global $healthSession; 
		$uploaded_image_names = array();
		$adapter = new Zend_File_Transfer_Adapter_Http();
		$files = $adapter->getFileInfo();
		$uploaded_image_names = array();
		$new_name = false; 
		foreach ($files as $file => $info) { 
  			$name_old = $adapter->getFileName($file);
			if(empty($name_old)){
				continue ;			
			}
			$file_title=$adapter->getFileInfo($file);
			$file_title = $file_title[$file]['name']; 
  			$uploaded_image_extension=getFileExtension($name_old);
 			$file_title=str_replace(".".$uploaded_image_extension,"",$file_title);
			$file_title=formatImageName($file_title);
 			$new_name=$file_title."-".time()."-".rand(1,100000).".".$uploaded_image_extension;
			if($formid==12){
  				$adapter->addFilter('Rename',array('target' => STAMP_PATH."/".$new_name));
			}
			if($formid==6){
				$adapter->addFilter('Rename',array('target' => FINANCIAL_PATH."/".$new_name));
			}
			try{
				$adapter->receive($file);
			}
			catch(Zend_Exception $e){
				return (object) array('success'=>false,"error"=>true,'exception'=>true,'message'=>$e->getMessage(),'exception_code'=>$e->getCode()) ;
			}
		}
		return (object)array("success"=>true,'error'=>false,"message"=>"Document(s) Successfully Uploaded","media_path"=>$new_name) ;
 	}
	
	private function _handle_newform_document(){ 
 		global $healthSession; 
		$uploaded_image_names = array();
		$adapter = new Zend_File_Transfer_Adapter_Http();
		$files = $adapter->getFileInfo();
		$uploaded_image_names = array();
		$new_name = false; 
		foreach ($files as $file => $info) { 
  			$name_old = $adapter->getFileName($file);
			if(empty($name_old)){
				continue ;			
			}
			$file_title=$adapter->getFileInfo($file);
			$file_title = $file_title[$file]['name']; 
  			$uploaded_image_extension=getFileExtension($name_old);
 			$file_title=str_replace(".".$uploaded_image_extension,"",$file_title);
			$file_title=formatImageName($file_title);
 			$new_name=$file_title."-".time()."-".rand(1,100000).".".$uploaded_image_extension;
			$adapter->addFilter('Rename',array('target' => AGENCY_FORM_PATH."/".$new_name));
			try{
				$adapter->receive($file);
			}
			catch(Zend_Exception $e){
				return (object) array('success'=>false,"error"=>true,'exception'=>true,'message'=>$e->getMessage(),'exception_code'=>$e->getCode()) ;
			}
		}
		return (object)array("success"=>true,'error'=>false,"message"=>"Document(s) Successfully Uploaded","media_path"=>$new_name) ;
 	}
	
	public function savefooddocumentAction(){
		global $healthSession;
		$formid=$this->_getParam('formid');
		$extarr=explode(".",$_FILES['upload_file']['name']);
		$ext=array('doc','docx','xls','xlsx','pdf','DOC','DOCX','XLS','XLSX','PDF','jpg','JPG','png','PNG','jpeg','JPEG');
		if(!in_array($extarr[count($extarr)-1],$ext)){
			echo 'extention error';
		}
		else{
			$is_uploaded = $this->_handle_document($formid);
			if(count($is_uploaded->media_path)>0){
				echo json_encode($is_uploaded->media_path);
			}
			else{
				echo json_encode('error');
			}
		}
		exit();
	}
	
	// Diffrent Reports
	public function reportsAction(){
		global $healthSession;
		 $indid=$this->_getParam("indid");
		 $formid=$this->_getParam("formid");
		 
                if(empty($indid) || empty($formid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
                $indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
		$formData = $this->getRequest()->getPost();
                
                $router=$pdfTitle="";
		switch($formid){
			case 1: // Incident Report
			$router="front_incident_reports";
			break;
			case 2: // Documentation Of Homemaker Personal Care
			$router="front_personal_care";
			break;
			case 3: // Time Sheet
			$router="front_timing_sheets";
			break;
			case 4: // Mileage Log
			$router="front_mileage_logs";
			break;
			case 5: // PRN
			$router="front_prn_record";
			break;
			case 6: // Financial Log
			$router="front_financial_logs";
			break;
			case 7: // Incident Log
			$router="front_incident_logs";
			break;
			case 8: // Tornado Drill Logs
			$router="front_tornado_logs";
			break;
			case 9: // Fire Logs
			$router="front_fire_logs";
			break;
			case 10: // Intake Logs
			$router="front_intake_logs";
			break;
			case 11: // Appointments Logs
			$router="front_appointments";
			break;
			case 12: // Food Stamp Logs
			$router="front_food_stamp_logs";
			break;
			case 13: // Medical Logs
			$router="front_medical_concerns";
			break;
			case 14: // Shift Summary Logs
			$router="front_shift_logs";
			break;
			case 15: // Cleaning Logs
			$router="front_cleaning_record";
			break;
			case 22: // Groceries/household Logs
			$router="front_groceries_logs";
			break;
			case 21: // Record OutCome Logs
                        $router = "record_outcome_report";
                        break;
			case 25: // Record Vehicle Inspection Logs
                        $router = "front_view_car_inspection";
                        break;
			case 27: // Record Vehicle Inspection Logs
                        $router = "front_personal_care";
                        break;
			case 18: // Bowel Movement
                        $router = "front_blow_movement";
                        break;
		} 
		
		if(!empty($formData)){
			$extra=array("month"=>$formData['months'],"year"=>$formData['years']);
			if($form==14 && !empty($formData['months'])){
				$ids="All";
			}

			if(!empty($formData['records'])){
				$ids=implode(",",$formData['records']);
			}
			else{
				$ids="All";
			}

			if($formid==6){
				$ids_arr=array();
				if(!empty($formData['records'])){
					$ids_arr['fin'][]=$formData['records'];
					//echo 'fin=='.$ids;
				}
				
				if(!empty($formData['fb_records'])){
					$ids_arr['fb'][]=$formData['fb_records'];
					//echo 'gr=='.$fb_ids;
					
				}
				
				if(!empty($formData['gr_records'])){
					$ids_arr['gr'][]=$formData['gr_records'];
					//echo 'gr=='.$gr_ids;
				}

				if(empty($formData['records']) && empty($formData['fb_records']) && empty($formData['gr_records'])){
					$ids_arr = "All";
					//echo 'fin=='.$ids;
				}
				
			}
			
                        
			switch($formid){
			case 1: // Incident Report
			$html.=$this->_incident_reports($indData,$ids,$formid,$extra);
			$pdfTitle=$this->view->site_configs['site_name']." | Incident Report";
			$router="front_incident_reports";
			break;
			
			case 2: // Documentation Of Homemaker Personal Care
                            $flag=0;
                            $idte="";
                            $idsc="";
                            if(!empty($formData['_uhs_task_entries'])){
				$idte=implode(",",$formData['_uhs_task_entries']);
                                $flag=1;
                            }
                            if(!empty($formData['_uhs_supports_charting'])){
				$idsc=implode(",",$formData['_uhs_supports_charting']);
                                $flag=1;
                            }
                            
                            
                            if(!empty($flag)){
                                $idall="";
                                $html.=$this->_charting_task_join_log($indData,$idte,$idsc,$idall,$formid,"Care",$extra);
                            }else{
                                $html.=$this->_charting_log($indData,$ids,$formid,"Care",$extra);
                            }
                            
			
                            
                        $pdfTitle=$this->view->site_configs['site_name']." | Documentation Of Homemaker Personal Care";
			$router="front_personal_care";
			break;
			
			case 3: // Time Sheet
			$html.=$this->_timing_sheet($indData,$ids,$formid,$extra);
			$pdfTitle=$this->view->site_configs['site_name']." | Time Sheet";
			$router="front_timing_sheets";
			break;
			
			case 4: // Mileage Log
			$html.=$this->_mileage_log($indData,$ids,$formid,$extra);
			$pdfTitle=$this->view->site_configs['site_name']." | Mileage Log";
			$router="front_mileage_logs";
			break;
			
			case 5: // PRN
			$html.=$this->_charting_log($indData,$ids,$formid,"MAR",$extra);
			$pdfTitle=$this->view->site_configs['site_name']." | PRN - Medication Administration Record";
			$router="front_prn_record";
			break;
			
			case 6: // Financial Log
			//print_r($ids);
			//die;
			$html.=$this->_financial_log($indData,$ids_arr,$formid,$extra);
			// if(isset($fb_ids) && $fb_ids!=''){
			//  $html.=$this->_foodstamp_log($indData,$fb_ids,$formid,$extra);
		 //    }
		 //    if(isset($gr_ids) && $gr_ids!=''){
   //           $html.=$this->_groceries_log($indData,$gr_ids,$formid,$extra);
   //          }
			$pdfTitle=$this->view->site_configs['site_name']." | Financial Ledger";
			$router="front_financial_logs";
			break;
			
			case 7: // Incident Log
			$html.=$this->_incident_log($indData,$ids,$formid,$extra);
			$pdfTitle=$this->view->site_configs['site_name']." | Incident Log";
			$router="front_incident_logs";
			break;
			
			case 8: // Tornado Drill Logs
			$html.=$this->_drill_log($indData,$ids,$formid,$extra);
			$pdfTitle=$this->view->site_configs['site_name']." | Tornado Drill Logs";
			$router="front_tornado_logs";
			break;
			
			case 9: // Fire Logs
			$html.=$this->_drill_log($indData,$ids,$formid,$extra);
			$pdfTitle=$this->view->site_configs['site_name']." | Fire Drill Log";
			$router="front_fire_logs";
			break;
			
			case 10: // Intake Logs
			$html.=$this->_intake_log($indData,$ids,$formid,$extra);
			$pdfTitle=$this->view->site_configs['site_name']." | Intake Log";
			$router="front_intake_logs";
			break;
			
			case 11: // Appointments Logs
			$html.=$this->_appointments_log($indData,$ids,$formid,$extra);
			$pdfTitle=$this->view->site_configs['site_name']." | Appointments";
			$router="front_appointments";
			break;
			
			case 12: // Food Stamp Logs
			$html.=$this->_foodstamp_log($indData,$ids,$formid,$extra);
			$pdfTitle=$this->view->site_configs['site_name']." | Food Stamp Ledger";
			$router="front_food_stamp_logs";
			break;
			
			case 13: // Medical Logs
			$html.=$this->_medical_log($indData,$ids,$formid,$extra);
			$pdfTitle=$this->view->site_configs['site_name']." | Medical Concerns";
			$router="front_medical_concerns";
			break;
			
			case 14: // Shift Summary Logs
			$html.=$this->_shift_summary_log($indData,$ids,$formid,$extra);
			$pdfTitle=$this->view->site_configs['site_name']." | Shift Report Summary";
			$router="front_shift_logs";
			break;
			
			case 15: // Cleaning Logs
			$html.=$this->_charting_log($indData,$ids,$formid,"Cleaning",$extra);
			$pdfTitle=$this->view->site_configs['site_name']." | Cleaning Chart";
			$router="front_cleaning_record";
			break;
            
                        case 22: // Groceries/household Logs
			$html.=$this->_groceries_log($indData,$ids,$formid,$extra);
			$pdfTitle=$this->view->site_configs['site_name']." | Groceries/household";
			$router="front_groceries_logs";
			break;
			
			case 21: // Outcome  Form
                        $html .= $this->_record_log($indData, $ids, $formid, "Record", $extra);
                        $pdfTitle = $this->view->site_configs['site_name'] . " |Outcome  Form";
                        $router = "record_outcome_report";
                        break;
			case 25: // Vehicle inspection  Form
                        $html .= $this->_vehicle_inspection_log($indData, $ids, $formid, "Record", $extra);
                        $pdfTitle = $this->view->site_configs['site_name'] . " |Vehicle Inspection  Form";
                        $router = "front_view_car_inspection";
                        break;
                        case 27: // Documentation Of Homemaker Personal Care
                            $flag=0;
                            $idte="";
                            $idsc="";
                            if(!empty($formData['_uhs_task_entries'])){
				$idte=implode(",",$formData['_uhs_task_entries']);
                                $flag=1;
                            }
                            if(!empty($formData['_uhs_supports_charting'])){
				$idsc=implode(",",$formData['_uhs_supports_charting']);
                                $flag=1;
                            }
                            
                            
                            if(!empty($flag)){
                                $idall="";
                                $html.=$this->_charting_task_join_log($indData,$idte,$idsc,$idall,$formid,"Ads",$extra);
                            }else{
                                $html.=$this->_charting_log($indData,$ids,$formid,"Ads",$extra);
                            }
                            
			
                            
                        $pdfTitle=$this->view->site_configs['site_name']." | Documentation of Adult Day Support";
			$router="front_personal_care";
			break;
                        case 18: // Bowel movement
                            $html.=$this->_bowel_movement_log($indData,$ids,$formid,$extra);
                            $pdfTitle=$this->view->site_configs['site_name']." | Bowel Movement";
                            $router="front_blow_movement";
			break;
		} 
			if(!empty($html)){
			require_once ROOT_PATH.'/private/mpdf/mpdf.php';
			$mpdf=new mPDF('utf-8', 'A4-L');
			$stylesheet = file_get_contents(APPLICATION_URL.'/public/plugins/bootstrap/css/bootstrap.css');
			$mpdf->SetTitle($pdfTitle);
			$mpdf->WriteHTML($stylesheet,1);
			$mpdf->WriteHTML($html,2);
			$mpdf->Output();
			exit();
		}
			else{
				$healthSession->errorMsg="No logs found.";
				$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),$router);
			}
		}
		else{
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),$router);
		}
	}
	
private function _smartPrint($indid,$formid,$month,$year){
        error_reporting(E_ALL);
        ini_set('display_errors', 1);
        ini_set('display_startup_errors', 1);
        ini_set('memory_limit', '-1');
        ini_set('max_execution_time', 300);
		$indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
		$ids="All";
		$extra=array("month"=>$month,"year"=>$year);
		$html="";
		switch($formid){
                        case 20: // Individual service plan Report
			$html.=$this->_individual_service_plan_logs($indData,$ids,$formid,$extra);
			break;
                    
			case 1: // Incident Report
			$html.=$this->_incident_reports($indData,$ids,$formid,$extra);
			break;
			
			case 2: // Documentation Of Homemaker Personal Care
                        $idte="";    
                        $idsc="";    
			$html.=$this->_charting_task_join_log($indData,$idte,$idsc,$ids,$formid,"Care",$extra);
			break;
			case 27: // Documentation Of Homemaker Personal Care
                        $idte="";    
                        $idsc="";    
			$html.=$this->_charting_task_join_log($indData,$idte,$idsc,$ids,$formid,"Ads",$extra);
			break;
			
			case 3: // Time Sheet
			// $html.= $this->_report_header("Time Sheet");
			$html.=$this->_timing_sheet($indData,$ids,$formid,$extra);
			break;
			
			case 4: // Mileage Log
			$html.=$this->_mileage_log($indData,$ids,$formid,$extra);
			break;
			
			case 5: // Documentation Of Homemaker Personal Care
			$html.=$this->_charting_log($indData,$ids,$formid,"MAR",$extra);
			break;
			
			case 6: // Financial Log
			$html.=$this->_financial_log($indData,$ids,$formid,$extra);
			break;
			
			case 7: // Incident Log
			$html.=$this->_incident_log($indData,$ids,$formid,$extra);
			break;
			
			case 8: // Tornado Drill Logs
			$html.=$this->_drill_log($indData,$ids,$formid,$extra);
			break;
			
			case 9: // Fire Logs
			$html.=$this->_drill_log($indData,$ids,$formid,$extra);
			break;
			
			case 10: // Intake Logs
			$html.=$this->_intake_log($indData,$ids,$formid,$extra);
			break;
			
			case 11: // Appointments Logs
			$html.=$this->_appointments_log($indData,$ids,$formid,$extra);
			break;
			
			case 12: // Food Stamp Logs
			$html.=$this->_foodstamp_log($indData,$ids,$formid,$extra);
			break;
			
			case 13: // Medical Logs
			$html.=$this->_medical_log($indData,$ids,$formid,$extra);
			break;
			
			case 14: // Shift Summary Logs
			$html.=$this->_shift_summary_log($indData,$ids,$formid,$extra);
			break;
			
			case 15: // Cleaning Logs
			$html.=$this->_charting_log($indData,$ids,$formid,"Cleaning",$extra);
			break;
                        
                        case 16: // Behavior Logs
			$html.=$this->_behavior_log($indData,$ids,$formid,$extra);
			break;
//                    
                        case 17: // Sleep Logs
			$html.=$this->_sleep_log($indData,$ids,$formid,$extra);
			break;
                    
                        case 18: // Bowel Movement Logs
			$html.=$this->_bowelmovement_log($indData,$ids,$formid,$extra);
			break;
			
			case 22: // Groceries/household Logs
			$html.=$this->_groceries_log($indData,$ids,$formid,$extra);
			break;
                 } 
		return $html;
		exit();
	}
	private function _report_header($title,$indData){
            
               $spend_content = $this->SuperModel->Super_Get("_uhs_spend_dates","agency_id='".$indData['agency_id']."' AND spend_status= '1'","fetch"); 
               $indid_plan_dates= " NA";
               if(!empty($spend_content["spend_from_date"]) && !empty($spend_content["spend_to_date"])){
                    $exlpode_from_date = explode("/",$spend_content['spend_from_date']);
                    $spend_from_date =  $exlpode_from_date[1]."/". $exlpode_from_date[0]."/". $exlpode_from_date[2];
                    $exlpode_to_date = explode("/",$spend_content['spend_to_date']);
                    $spend_to_date =  $exlpode_to_date[1]."/". $exlpode_to_date[0]."/". $exlpode_to_date[2];
                    $indid_plan_dates= $spend_from_date." - ".$spend_to_date;
              }
		$html="";
		$html .= '<table style= "width:100%">
					<tr>
						<td> 
							<div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
								<h4 class="magin0">Company Information</h4><br>
								<p><b>Company:</b>'. ucwords($this->view->user->agency_company_name).'</p>
								
								<p><b>Provider No:</b>'. $this->view->user->agency_provider_number.'</p>
								
								<p><b>Name:</b>'. ucwords($this->view->user->agency_first_name. '  ' . $this->view->user->agency_last_name).'</p>
								
								<p><b>Address:</b>'. ucwords($this->view->user->agency_address1 .', '. $this->view->user->agency_city.', '. $this->view->user->agency_state.', '. $this->view->user->agency_zip).'</p>
								
								<p><b>ContactContact:</b>'. $this->view->user->agency_contact.'</p>
							</div>
						</td>
						
						<td>
							<div class="col-lg-6 col-md-6 col-sm-6 col-xs-12 ">
								<h4 class="magin0">Individual Information</h4><br>
								<p><b>Individual Id:</b>'.$indData["agency_individual_assign_code"].'</p>
								<p><b>Medicaid Number: </b>'.$indData["agency_medicaid_number"].'</p>
								<p><b>Name: </b>'.ucwords($indData["agency_first_name"].' '.$indData["agency_last_name"] ).'</p>
								<p><b>Address:</b>'.ucwords($indData["agency_address1"].', '.$indData["agency_city"].', '.$indData["agency_state"].', '.$indData["agency_zip"] ).'</p>
								<p><b>Contact:</b>'.$indData["agency_contact"].'</p>
								<p><b>Individual Plan Dates:</b>'.$indid_plan_dates.'</p>
							</div>	
						</td>
					</tr>
				</table>	
							<br/>';
			$html.="<div class='text-right'>Date:".date("m/d/Y H:i:s",time())."</div><div class='alert alert-info text-center'><h3>$title</h3>";
			return $html;

	}
	private function _incident_reports($indData,$ids,$formid,$extra=array()){
		global $months;
		$userCond="";
		
		
		if($this->view->user->agency_user_type!="Agency"){
			$userCond="incident_added_user='".$this->view->user->agency_id."' and ";
		}
		$html="";
		if($ids=="All"){
			
			$data=$this->SuperModel->Super_Get("_uhs_incidents_reports","".$userCond." incident_individual_id=".$indData['agency_id']." and MONTH(incident_date)=".$extra['month']." and YEAR(incident_date)='".$extra['year']."'","fetchAll");
		}
		else{
			
			$data=$this->SuperModel->Super_Get("_uhs_incidents_reports","incident_id In(".$ids.")","fetchAll");
			if(count($data)==1){	
				$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indData['agency_id'],"formid"=>$formid,"rid"=>$ids),"front_ireport");
			}
		}
		if(count($data)>0){
                        $html.= $this->_report_header("Incident Reports",$indData);
			$html.="
						<h5>Individual Information: ".ucwords($indData['agency_first_name']." ".$indData['agency_last_name']).",".$indData['agency_city'].",".$indData['agency_state'].",".$indData['agency_zip']."</h5>
			 	   </div>";
			$html.="<table class='table table-bordered' cellspacing='10' cellpadding='20' width='100%'>
					<tr>
						<th style='padding:0.3%;' width='16.6%'>Tracking No.</th>
						<th style='padding:0.3%;' width='16.6%'>Incident Date</th>
						<th style='padding:0.3%;' width='16.6%'>Incident Time</th>
						<th style='padding:0.3%;' width='16.6%'>Incident Location</th>
						<th style='padding:0.3%;' width='16.6%'>Created By</th>
						<th style='padding:0.3%;' width='16.6%'>Created On</th>
				   </tr>";
			foreach($data as $data){
				$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$data['incident_added_user']);
				$html.="<tr>
							<td style='padding:0.3%;'>".$data['incident_tracking_number']."</td>
							<td style='padding:0.3%;'>".formatDate($data['incident_date'])."</td>
							<td style='padding:0.3%;'>".$data['incident_time']."</td>
							<td style='padding:0.3%;'>".ucwords($data['incident_location'])."</td>
							<td style='padding:0.3%;'>".ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."</td>
							<td style='padding:0.3%;'>".formatDateTimeNew($data['report_created_on'])."</td>
				  	  </tr>";	
			}
			$html.="</table>";
			if($ids=="All"){
				$html.="<pagebreak />";
			}
		}else{
			//$html.= "<h4><center><strong><i> No DATA FOUND </strong></i></center></h4> </div>";
		}
		return $html;
	
	}
	
	private function _timing_sheet($indData,$ids,$formid,$extra=array()){
		global $months;
		$userCond="";
		if($this->view->user->agency_user_type!="Agency"){ $userCond="service_added_user='".$this->view->user->agency_id."' and ";}
		if($ids!=="All"){
			$data=$this->SuperModel->Super_Get("_uhs_timing_sheets","sheet_id In(".$ids.")","fetchAll");
		}
		else{
			$data=$this->SuperModel->Super_Get("_uhs_timing_sheets","".$userCond." service_individual_id=".$indData['agency_id']." and MONTH(service_date)=".$extra['month']." and YEAR(service_date)='".$extra['year']."'","fetchAll");
		}
		$html="";
		
		if(count($data)>0){
			$html.= $this->_report_header("Time Sheet",$indData);
			$html.="<h5>Individual Information: ".ucwords($indData['agency_first_name']." ".$indData['agency_last_name']).",".$indData['agency_city'].",".$indData['agency_state'].",".$indData['agency_zip']."</h5>
			 	   </div>";
			$html.="<table class='table table-bordered' cellspacing='10' cellpadding='20' width='100%'>
					<tr>
						<th style='padding:0.3%;' width='12.5%'>Date Of Service</th>
						<th style='padding:0.3%;' width='12.5%'>Work Code</th>
						<th style='padding:0.3%;' width='12.5%'>Start Time</th>
						<th style='padding:0.3%;' width='12.5%'>End Time</th>
						<th style='padding:0.3%;' width='12.5%'>Total Hours</th>
						<th style='padding:0.3%;' width='12.5%'>Miles Used</th>
						<th style='padding:0.3%;' width='12.5%'>Created By</th>
						<th style='padding:0.3%;' width='12.5%'>Created On</th>
				   </tr>";
			foreach($data as $data){
				$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$data['service_added_user']);
				$html.="<tr>
							<td style='padding:0.3%;'>".formatDate($data['service_date'])."</td>
							<td style='padding:0.3%;'>".ucwords($data['service_work_code'])."</td>
							<td style='padding:0.3%;'>".$data['service_start_time']."</td>
							<td style='padding:0.3%;'>".$data['service_end_time']."</td>
							<td style='padding:0.3%;'>".$data['service_total_hours']."</td>
							<td style='padding:0.3%;'>".$data['total_miles_used']."</td>
							<td style='padding:0.3%;'>".ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."</td>
							<td style='padding:0.3%;'>".formatDateTimeNew($data['sheet_added_date'])."</td>
				  	  </tr>";	
			}
			$html.="</table>";
			if($ids=="All"){
				$html.="<pagebreak />";
			}
		}else{
			$html.= "";
		}
		return $html;
	}
	
	private function _mileage_log($indData,$ids,$formid,$extra=array()){
		global $months;
		$userCond="";
		if($this->view->user->agency_user_type!="Agency"){ $userCond="mlog_added_user='".$this->view->user->agency_id."' and ";}
		if($ids!=="All"){
			$data=$this->SuperModel->Super_Get("_uhs_mileage_logs","mlog_id In(".$ids.")","fetchAll");
		}
		else{
			$data=$this->SuperModel->Super_Get("_uhs_mileage_logs","".$userCond." mlog_individual_id=".$indData['agency_id']." and MONTH(mlog_service_date)=".$extra['month']." and YEAR(mlog_service_date)='".$extra['year']."'","fetchAll");
		}
		$html="";
		
		if(count($data)>0){
			$html.= $this->_report_header("Mileage Log",$indData);
			
			$html.=	"<h5>Individual Information: ".ucwords($indData['agency_first_name']." ".$indData['agency_last_name']).",".$indData['agency_city'].",".$indData['agency_state'].",".$indData['agency_zip']."</h5>
			 	   </div>";
			$html.="<table class='table table-bordered' cellspacing='10' cellpadding='20' width='100%'>
					<tr>
						<th style='padding:0.3%;' width='14.28%'>Date Of Service</th>
						<th style='padding:0.3%;' width='14.28%'>From Location</th>
						<th style='padding:0.3%;' width='14.28%'>To Location</th>
						<th style='padding:0.3%;' width='14.28%'>Total Miles Driven</th>
						<th style='padding:0.3%;' width='14.28%'>Activity Description</th>
						<th style='padding:0.3%;' width='14.28%'>Created By</th>
						<th style='padding:0.3%;' width='14.28%'>Created On</th>
				   </tr>";
			foreach($data as $data){
				$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$data['mlog_added_user']);
				$html.="<tr>
							<td style='padding:0.3%;'>".formatDate($data['mlog_service_date'])."</td>
							<td style='padding:0.3%;'>".ucwords($data['mlog_from_location'])."</td>";
                                                        if($data['chosse_your_trip'] == 0 || $data['chosse_your_trip'] == 1 || $data['chosse_your_trip'] == 2){
                                                            $loaction ="";
                                                            $loaction .= $data['mlog_to_location'];
                                                        }else{
                                                            $loaction="";
                                                            $j=1;
                                                            for($k=1;$k<=7;$k++){
                                                                $multloc= "mlog_to_location".$k;
                                                                if(!empty($data[$multloc])){
                                                                    $loaction .=  "<strong>".$j." - </strong>".$data[$multloc]."<br>";
                                                                    $j++;
                                                                }
                                                            }
                                                        }
							$html.="<td style='padding:0.3%;'>".ucwords($loaction)."</td>
							<td style='padding:0.3%;'>".$data['mlog_total_miles']."</td>
							<td style='padding:0.3%;'>".$data['mlog_activity_description']."</td>
							<td style='padding:0.3%;'>".ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."</td>
							<td style='padding:0.3%;'>".formatDateTimeNew($data['mlog_added_date'])."</td>
				  	  </tr>";	
			}
			$html.="</table>";
			if($ids=="All"){
				$html.="<pagebreak />";
			}
		}else{
			$html.= "";
		}
		return $html;
	}
	
	private function _financial_log($indData,$ids,$formid,$extra=array()){
		global $months;
		$userCond="";
		//$records=$this->_getParam("recors");
		// echo "<pre>";
		// print_r($ids);
		// die;
		$id = array();
		$fb = array();
		$gr = array();

		if(array_key_exists('fin',$ids)){

			$id = $ids['fin'][0];
			if(!empty($id)){
			  $id=implode(",",$id);
			} 
		}

		if(array_key_exists('fb',$ids)){

			$fb = $ids['fb'][0];
			if(!empty($fb)){
			 $fb=implode(",",$fb);
			} 
		}

		if(array_key_exists('gr',$ids)){

			$gr = $ids['gr'][0];
			if(!empty($gr)){
			  $gr=implode(",",$gr);
			} 
		}

		//echo "<pre>";
		//var_dump($ids);
		//die;

		if($this->view->user->agency_user_type!="Agency"){ 
			$userCond="fl_added_user='".$this->view->user->agency_id."' and ";
		}

		if($id){
			$data=$this->SuperModel->Super_Get("_uhs_financial_ledger","flid In(".$id.")","fetchAll");
		}
		// else{
		// 	$data=$this->SuperModel->Super_Get("_uhs_financial_ledger","".$userCond." fl_individual_id=".$indData['agency_id']." and MONTH(fl_service_date)=".$extra['month']." and YEAR(fl_service_date)='".$extra['year']."'","fetchAll");
		// }

		if($fb){
			$data_fb=$this->SuperModel->Super_Get("_uhs_food_stamp","food_id In(".$fb.")","fetchAll");
		}
		// else{
		// 	$data_fb=$this->SuperModel->Super_Get("_uhs_food_stamp","".$userCond." food_individual_id=".$indData['agency_id']." and MONTH(food_service_date)=".$extra['month']." and YEAR(food_service_date)='".$extra['year']."'","fetchAll");
		// }

        

        if($gr){
			$data_gr=$this->SuperModel->Super_Get("_uhs_groceries","groceries_id In(".$gr.")","fetchAll");
		}
		// else{
		// 	$data_gr=$this->SuperModel->Super_Get("_uhs_groceries","".$userCond." groceries_individual_id=".$indData['agency_id']." and MONTH(groceries_service_date)=".$extra['month']." and YEAR(groceries_service_date)='".$extra['year']."'","fetchAll");
		// }

		if($ids=="All"){

			$data=$this->SuperModel->Super_Get("_uhs_financial_ledger","".$userCond." fl_individual_id=".$indData['agency_id']." and MONTH(fl_service_date)=".$extra['month']." and YEAR(fl_service_date)='".$extra['year']."'","fetchAll");

			$data_fb=$this->SuperModel->Super_Get("_uhs_food_stamp","".$userCond." food_individual_id=".$indData['agency_id']." and MONTH(food_service_date)=".$extra['month']." and YEAR(food_service_date)='".$extra['year']."'","fetchAll");

			$data_gr=$this->SuperModel->Super_Get("_uhs_groceries","".$userCond." groceries_individual_id=".$indData['agency_id']." and MONTH(groceries_service_date)=".$extra['month']." and YEAR(groceries_service_date)='".$extra['year']."'","fetchAll");

		}

		//print_r($data_gr);
		//die;

       // $creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$data['groceries_added_user']);

		$html="";
		
		//if(count($data)>0){
			$html.= $this->_report_header("Financial Ledger",$indData);
		
			$html.="<h5>Individual Information: ".ucwords($indData['agency_first_name']." ".$indData['agency_last_name']).",".$indData['agency_city'].",".$indData['agency_state'].",".$indData['agency_zip']."</h5>
			 	   </div>";
			$html.="<table class='table table-bordered' cellspacing='10' cellpadding='20' width='100%'>
					<tr>
						<th style='padding:0.3%;' width='12.5%'>Date Of Service</th>
						<th style='padding:0.3%;' width='12.5%'>Account</th>
						<th style='padding:0.3%;' width='12.5%'>Credit($)</th>
						<th style='padding:0.3%;' width='12.5%'>Amount Spend($)</th>
						<th style='padding:0.3%;' width='12.5%'>Ending Balance($)</th>
						<th style='padding:0.3%;' width='12.5%'>Where</th>
						<th style='padding:0.3%;' width='12.5%'>Activity Description</th>
						<th style='padding:0.3%;' width='12.5%'>Created By</th>
						<th style='padding:0.3%;' width='12.5%'>Created On</th>
				   </tr>";

		    //if(is_array($data)){
				$i=$j=$k=0;
				foreach($data as $data){
					   $creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$data['fl_added_user']);
					   if($data['fl_type']=='credit' || $data['fl_type']=='gift'){
	                     $fl_type=ucwords($data['fl_type'].' card');
					   }
	                    else{
	                     $fl_type=ucwords($data['fl_type']);
	                    }

					   $data_new['report'][$i]['service_date'] = formatDate($data['fl_service_date']);
					   $data_new['report'][$i]['type'] = $fl_type;
					   $data_new['report'][$i]['remaining_balance'] = $data['fl_remaining_balance'];
					   $data_new['report'][$i]['amt_spend'] = $data['fl_amt_spend'];
					   $data_new['report'][$i]['amt_credit'] = $data['fl_amt_credit'];
					   $data_new['report'][$i]['ending_balance'] = $data['fl_ending_balance'];
					   $data_new['report'][$i]['address'] = ucwords($data['fl_address']);
					   $data_new['report'][$i]['activity_description'] = $data['fl_activity_desc'];
					   $data_new['report'][$i]['agency_name'] = ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name']);
					   $data_new['report'][$i]['added_date'] = formatDateTimeNew($data['fl_added_date']);
					   $data_new['report'][$i]['timestamp']= strtotime($data['fl_added_date']);
					   $i++;
					// $html.="<tr>
					// 			<td style='padding:0.3%;'>".formatDate($data['fl_service_date'])."</td>
					// 			<td style='padding:0.3%;'>".$fl_type."</td>
					// 			<td style='padding:0.3%;'>".$data['fl_remaining_balance']."</td>
					// 			<td style='padding:0.3%;'>".$data['fl_amt_spend']."</td>
					// 			<td style='padding:0.3%;'>".$data['fl_ending_balance']."</td>
					// 			<td style='padding:0.3%;'>".ucwords($data['fl_address'])."</td>
					// 			<td style='padding:0.3%;'>".$data['fl_activity_desc']."</td>
					// 			<td style='padding:0.3%;'>".ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."</td>
					// 			<td style='padding:0.3%;'>".formatDateTimeNew($data['fl_added_date'])."</td>
					//   	  </tr>";	
				}
			//}
			if($i>$j){
				$j=$i;
			}
			//if(is_array($data_fb)){
				foreach ($data_fb as $data) {
					$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$data['food_added_user']);
					
	                   $fl_type= "Food Stamp";
	                   $data_new['report'][$j]['service_date'] = formatDate($data['food_service_date']);
					   $data_new['report'][$j]['type'] = $fl_type;
					   $data_new['report'][$j]['remaining_balance'] = $data['food_remaining_balance'];
					   $data_new['report'][$j]['amt_spend'] = $data['food_amt_spend'];
					   $data_new['report'][$j]['amt_credit'] = $data['food_amt_credit'];
					   $data_new['report'][$j]['ending_balance'] = $data['food_ending_balance'];
					   $data_new['report'][$j]['address'] = ucwords($data['food_address']);
					   $data_new['report'][$j]['activity_description'] = $data['food_activity_description'];
					   $data_new['report'][$j]['agency_name'] = ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name']);
					   $data_new['report'][$j]['added_date'] = formatDateTimeNew($data['food_added_date']);
					   $data_new['report'][$j]['timestamp']= strtotime($data['food_added_date']);
						$j++;

				}
			//}
			if($i>0 && $j>0){
			  $k=$j;
			}
			if($i==0 && $j>0){
			  $k=$j;
			}
			if($i>0 && $j==0){
			  $k=$i;
			}
			//if(is_array($data_gr)){
				foreach ($data_gr as $data) {
					$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$data['groceries_added_user']);
					
	                   $fl_type= ucwords($data['groceries_type']);
					
					   $data_new['report'][$k]['service_date'] = formatDate($data['groceries_service_date']);
					   $data_new['report'][$k]['type'] = $fl_type;
					   $data_new['report'][$k]['remaining_balance'] = $data['groceries_remaining_balance'];
					   $data_new['report'][$k]['amt_spend'] = $data['groceries_amt_spend'];
					   $data_new['report'][$k]['amt_credit'] = $data['groceries_amt_credit'];
					   $data_new['report'][$k]['ending_balance'] = $data['groceries_ending_balance'];
					   $data_new['report'][$k]['address'] = ucwords($data['groceries_address']);
					   $data_new['report'][$k]['activity_description'] = $data['groceries_activity_description'];
					   $data_new['report'][$k]['agency_name'] = ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name']);
					   $data_new['report'][$k]['added_date'] = formatDateTimeNew($data['groceries_added_date']);
					   $data_new['report'][$k]['timestamp']= strtotime($data['groceries_added_date']);
					   $k++;
				}
			//}
            $data_new1 = $this->array_sort($data_new['report'], 'timestamp', SORT_DESC);
            // echo "<pre>";
            // print_r($data_new1);
           // die;
            foreach ($data_new1 as $key => $value) {

            	//var_dump($value['service_date']);
            	if($value['amt_spend']==0){
            		$spending ='-';
            	} else{
            		$spending ='<span style="color:red;">-'.$value['amt_spend'].'</span>';
            	}

            	if($value['amt_credit']==0){
            		
            		$remaining_balance ='<span>'.$value['remaining_balance'].'</span>';
            		
            	} else{

            		$remaining_balance = '<span>'.$value['remaining_balance'].'</span><br><span style="color:green;">'.$value['amt_credit'].'</span>';
            	}


            	$html.="<tr>
						<td style='padding:0.3%;'>".$value['service_date']."</td>
						<td style='padding:0.3%;'>".$value['type']."</td>
						<td style='padding:0.3%;'>".$remaining_balance."</td>
						<td style='padding:0.3%;'>".$spending."</td>
						<td style='padding:0.3%;'>".$value['ending_balance']."</td>
						<td style='padding:0.3%;'>".$value['address']."</td>
						<td style='padding:0.3%;'>".$value['activity_description']."</td>
						<td style='padding:0.3%;'>".$value['agency_name']."</td>
						<td style='padding:0.3%;'>".$value['added_date']."</td>
					  	</tr>";
            }
            
			$html.="</table>";
			if($ids=="All"){
				$html.="<pagebreak />";
			}
		//}else{
			//$html.= "";
		//}
		return $html;
	}
	
	private function array_sort($array, $on, $order=SORT_ASC){

	    $new_array = array();
	    $sortable_array = array();

	    if (count($array) > 0) {
	        foreach ($array as $k => $v) {
	            if (is_array($v)) {
	                foreach ($v as $k2 => $v2) {
	                    if ($k2 == $on) {
	                        $sortable_array[$k] = $v2;
	                    }
	                }
	            } else {
	                $sortable_array[$k] = $v;
	            }
	        }

	        switch ($order) {
	            case SORT_ASC:
	                asort($sortable_array);
	                break;
	            case SORT_DESC:
	                arsort($sortable_array);
	                break;
	        }

	        foreach ($sortable_array as $k => $v) {
	            $new_array[$k] = $array[$k];
	        }
	    }

	    return $new_array;
	}

	private function _incident_log($indData,$ids,$formid,$extra=array()){
		global $months;
		$userCond="";
		if($this->view->user->agency_user_type!="Agency"){ $userCond="inc_log_added_user='".$this->view->user->agency_id."' and ";}
		if($ids!=="All"){
			$data=$this->SuperModel->Super_Get("_uhs_incident_logs","inc_log_id In(".$ids.")","fetchAll");
		}
		else{
			$data=$this->SuperModel->Super_Get("_uhs_incident_logs","".$userCond." inc_log_individual_id=".$indData['agency_id']." and MONTH(inc_service_date)=".$extra['month']." and YEAR(inc_service_date)='".$extra['year']."'","fetchAll");
		}
		$html="";
		
		if(count($data)>0){
			$html.= $this->_report_header("Incident Logs",$indData);
			
			$html.=	"<h5>Individual Information: ".ucwords($indData['agency_first_name']." ".$indData['agency_last_name']).",".$indData['agency_city'].",".$indData['agency_state'].",".$indData['agency_zip']."</h5>
			 	   </div>";
			$html.="<table class='table table-bordered' cellspacing='10' cellpadding='20' width='100%'>
					<tr>
						<th style='padding:0.3%;' width='12.5%'>Date Of Service</th>
						<th style='padding:0.3%;' width='12.5%'>Country</th>
						<th style='padding:0.3%;' width='12.5%'>Time</th>
						<th style='padding:0.3%;' width='12.5%'>Location</th>
						<th style='padding:0.3%;' width='12.5%'>Is Injured?</th>
						<th style='padding:0.3%;' width='12.5%'>Preventative Measure</th>
						<th style='padding:0.3%;' width='12.5%'>Created By</th>
						<th style='padding:0.3%;' width='12.5%'>Created On</th>
				   </tr>";
			foreach($data as $data){
				$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$data['inc_log_added_user']);
				$html.="<tr>
							<td style='padding:0.3%;'>".formatDate($data['inc_service_date'])."</td>
							<td style='padding:0.3%;'>".ucwords($data['inc_country'])."</td>
							<td style='padding:0.3%;'>".$data['inc_time']."</td>
							<td style='padding:0.3%;'>".ucwords($data['inc_location'])."</td>
							<td style='padding:0.3%;'>".ucwords($data['is_injured'])."</td>
							<td style='padding:0.3%;'>".$data['inc_preventative_measure']."</td>
							<td style='padding:0.3%;'>".ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."</td>
							<td style='padding:0.3%;'>".formatDateTimeNew($data['inc_added_date'])."</td>
				  	  </tr>";	
			}
			$html.="</table>";
			if($ids=="All"){
				$html.="<pagebreak />";
			}
		}else{
			$html.= "";
		}
		return $html;
	}
	
	private function _drill_log($indData,$ids,$formid,$extra=array()){
		global $months;
		$userCond="";
		if($this->view->user->agency_user_type!="Agency"){ $userCond="drill_added_user='".$this->view->user->agency_id."' and ";}
		if($ids!=="All"){
			$data=$this->SuperModel->Super_Get("_uhs_drills_logs","drill_id In(".$ids.") and drill_form_id='".$formid."'","fetchAll");
		}
		else{
			$data=$this->SuperModel->Super_Get("_uhs_drills_logs","".$userCond." drill_individual_id=".$indData['agency_id']." and MONTH(drill_added_date)=".$extra['month']." and YEAR(drill_added_date)='".$extra['year']."' and drill_form_id='".$formid."'","fetchAll");
		}
		$html="";
		if($formid==8){ $head="Tornado Drill Logs";}else{ $head="Fire Drill Logs";}
		
		if(count($data)>0){
			$html.= $this->_report_header($head,$indData);
			
					$html.="	<h5>Individual Information: ".ucwords($indData['agency_first_name']." ".$indData['agency_last_name']).",".$indData['agency_city'].",".$indData['agency_state'].",".$indData['agency_zip']."</h5>
			 	   </div>";
			$html.="<table class='table table-bordered' cellspacing='10' cellpadding='20' width='100%'>
					<tr>
						<th style='padding:0.3%;' width='14.28%'>Date Of Service</th>
						<th style='padding:0.3%;' width='14.28%'>Start Time</th>
						<th style='padding:0.3%;' width='14.28%'>End Time</th>
						<th style='padding:0.3%;' width='14.28%'>Participant Names</th>
						<th style='padding:0.3%;' width='14.28%'>Comments</th>
						<th style='padding:0.3%;' width='14.28%'>Created By</th>
						<th style='padding:0.3%;' width='14.28%'>Created On</th>
				   </tr>";
			foreach($data as $data){
				$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$data['drill_added_user']);
				$html.="<tr>
							<td style='padding:0.3%;'>".formatDate($data['drill_service_date'])."</td>
							<td style='padding:0.3%;'>".$data['drill_start_time']."</td>
							<td style='padding:0.3%;'>".$data['drill_end_time']."</td>
							<td style='padding:0.3%;'>".ucwords($data['drill_participant_names'])."</td>
							<td style='padding:0.3%;'>".ucwords($data['drill_comments'])."</td>
							<td style='padding:0.3%;'>".ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."</td>
							<td style='padding:0.3%;'>".formatDateTimeNew($data['drill_added_date'])."</td>
				  	  </tr>";	
			}
			$html.="</table>";
			if($ids=="All"){
				$html.="<pagebreak />";
			}
		}else{
			$html.= "";
		}
		return $html;
	}
	
	private function _intake_log($indData,$ids,$formid,$extra=array()){
		global $months;
		$userCond="";
		if($this->view->user->agency_user_type!="Agency"){ $userCond="intake_added_user='".$this->view->user->agency_id."' and ";}
		if($ids!=="All"){
			$data=$this->SuperModel->Super_Get("_uhs_intake_logs","intake_id In(".$ids.")","fetchAll");
		}
		else{
			$data=$this->SuperModel->Super_Get("_uhs_intake_logs","".$userCond." intake_individual_id=".$indData['agency_id']." and MONTH(intake_added_date)=".$extra['month']." and YEAR(intake_added_date)='".$extra['year']."'","fetchAll");
		}
		$html="";
		
		if(count($data)>0){
			$html.= $this->_report_header("Food Intake Logs",$indData);
			$html.="<h5>Individual Information: ".ucwords($indData['agency_first_name']." ".$indData['agency_last_name']).",".$indData['agency_city'].",".$indData['agency_state'].",".$indData['agency_zip']."</h5>
			 	   </div>";
			$html.="<table class='table table-bordered' cellspacing='10' cellpadding='20' width='100%'>
					<tr>
						<th style='padding:0.3%;' width='14.28%'>Date Of Service</th>
						<th style='padding:0.3%;' width='14.28%'>Time</th>
						<th style='padding:0.3%;' width='14.28%'>Meal Category</th>
						<th style='padding:0.3%;' width='14.28%'>Intake(%)</th>
						<th style='padding:0.3%;' width='14.28%'>Meal Description</th>
						<th style='padding:0.3%;' width='14.28%'>Comments</th>
						<th style='padding:0.3%;' width='14.28%'>Created By</th>
						<th style='padding:0.3%;' width='14.28%'>Created On</th>
				   </tr>";
			foreach($data as $data){
				$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$data['intake_added_user']);
				$html.="<tr>
							<td style='padding:0.3%;'>".formatDate($data['intake_service_date'])."</td>
							<td style='padding:0.3%;'>".$data['intake_service_time']."</td>
							<td style='padding:0.3%;'>".ucwords($data['intake_meal_category'])."</td>
							<td style='padding:0.3%;'>".$data['intake_percentage']."</td>
							<td style='padding:0.3%;'>".$data['intake_meal_desc']."</td>
							<td style='padding:0.3%;'>".$data['intake_comments']."</td>
							<td style='padding:0.3%;'>".ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."</td>
							<td style='padding:0.3%;'>".formatDateTimeNew($data['intake_added_date'])."</td>
				  	  </tr>";	
			}
			$html.="</table>";
			if($ids=="All"){
				$html.="<pagebreak />";
			}
		}else{
			$html.= "";
		}
		return $html;
	}
	
	private function _appointments_log($indData,$ids,$formid,$extra=array()){
		global $months;
		$userCond="";
		if($this->view->user->agency_user_type!="Agency"){ $userCond="appoint_added_user='".$this->view->user->agency_id."' and ";}
		if($ids!=="All"){
			$data=$this->SuperModel->Super_Get("_uhs_appointments","appoint_id In(".$ids.")","fetchAll");
		}
		else{
			$data=$this->SuperModel->Super_Get("_uhs_appointments","".$userCond." appoint_individual_id=".$indData['agency_id']." and MONTH(appoint_date)=".$extra['month']." and YEAR(appoint_date)='".$extra['year']."'","fetchAll");
		}
		$html="";
		
		if(count($data)>0){
			$html.= $this->_report_header("Appointments",$indData);
			$html.="<h5>Individual Information: ".ucwords($indData['agency_first_name']." ".$indData['agency_last_name']).",".$indData['agency_city'].",".$indData['agency_state'].",".$indData['agency_zip']."</h5>
			 	   </div>";
			$html.="<table class='table table-bordered' cellspacing='10' cellpadding='20' width='100%'>
					<tr>
						<th style='padding:0.3%;' width='14.28%'>Date</th>
						<th style='padding:0.3%;' width='14.28%'>Time</th>
						<th style='padding:0.3%;' width='14.28%'>With</th>
						<th style='padding:0.3%;' width='14.28%'>Address</th>
						<th style='padding:0.3%;' width='14.28%'>Reason</th>
						<th style='padding:0.3%;' width='14.28%'>Comments</th>
						<th style='padding:0.3%;' width='14.28%'>Created By</th>
						<th style='padding:0.3%;' width='14.28%'>Created On</th>
				   </tr>";
			foreach($data as $data){
				$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$data['appoint_added_user']);
				$html.="<tr>
							<td style='padding:0.3%;'>".formatDate($data['appoint_date'])."</td>
							<td style='padding:0.3%;'>".$data['appoint_time']."</td>
							<td style='padding:0.3%;'>".ucwords($data['appoint_with'])."</td>
							<td style='padding:0.3%;'>".ucwords($data['appoint_address'])."</td>
							<td style='padding:0.3%;'>".$data['appoint_reason']."</td>
							<td style='padding:0.3%;'>".$data['appoint_comments']."</td>
							<td style='padding:0.3%;'>".ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."</td>
							<td style='padding:0.3%;'>".formatDateTimeNew($data['appoint_added_date'])."</td>
				  	  </tr>";	
			}
			$html.="</table>";
			if($ids=="All"){
				$html.="<pagebreak />";
			}
		}else{
			$html.= "";
		}
		return $html;
	}
	
	private function _foodstamp_log($indData,$ids,$formid,$extra=array()){
		global $months;
		$userCond="";
		if($this->view->user->agency_user_type!="Agency"){ $userCond="food_added_user='".$this->view->user->agency_id."' and ";}
		if($ids!=="All"){
			$data=$this->SuperModel->Super_Get("_uhs_food_stamp","food_id In(".$ids.")","fetchAll");
		}
		else{
			$data=$this->SuperModel->Super_Get("_uhs_food_stamp","".$userCond." food_individual_id=".$indData['agency_id']." and MONTH(food_service_date)=".$extra['month']." and YEAR(food_service_date)='".$extra['year']."'","fetchAll");
		}
		$html="";
		
		if(count($data)>0){
			$html.= $this->_report_header("Food Stamp Ledger",$indData);
			$html.="<h5>Individual Information: ".ucwords($indData['agency_first_name']." ".$indData['agency_last_name']).",".$indData['agency_city'].",".$indData['agency_state'].",".$indData['agency_zip']."</h5>
			 	   </div>";
			$html.="<table class='table table-bordered' cellspacing='10' cellpadding='20' width='100%'>
					<tr>				
						<th style='padding:0.3%;' width='12.5%'>Date Of Service</th>
						<th style='padding:0.3%;' width='12.5%'>Account</th>
						<th style='padding:0.3%;' width='12.5%'>Credit($)</th>
						<th style='padding:0.3%;' width='12.5%'>Amount Spend($)</th>
						<th style='padding:0.3%;' width='12.5%'>Ending Balance($)</th>
						<th style='padding:0.3%;' width='12.5%'>Where</th>
						<th style='padding:0.3%;' width='12.5%'>Activity Description</th>
						<th style='padding:0.3%;' width='12.5%'>Created By</th>
						<th style='padding:0.3%;' width='12.5%'>Created On</th>
				   </tr>";
			foreach($data as $data){
				$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$data['food_added_user']);
				$html.="<tr>
							<td style='padding:0.3%;'>".formatDate($data['food_service_date'])."</td>
							<td style='padding:0.3%;'>Food Stamp</td>
							<td style='padding:0.3%;'>".$data['food_remaining_balance']."</td>
							<td style='padding:0.3%;'>".$data['food_amt_spend']."</td>
							<td style='padding:0.3%;'>".$data['food_ending_balance']."</td>
							<td style='padding:0.3%;'>".ucwords($data['food_address'])."</td>
							<td style='padding:0.3%;'>".$data['food_activity_description']."</td>
							<td style='padding:0.3%;'>".ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."</td>
							<td style='padding:0.3%;'>".formatDateTimeNew($data['food_added_date'])."</td>
				  	  </tr>";	
			}
			$html.="</table>";
			if($ids=="All"){
				$html.="<pagebreak />";
			}
		}else{
			$html.= "";
		}
		return $html;
	}
	
	private function _medical_log($indData,$ids,$formid,$extra=array()){
		global $months;
		$userCond="";
		if($this->view->user->agency_user_type!="Agency"){ $userCond="med_added_user='".$this->view->user->agency_id."' and ";}
		if($ids!=="All"){
			$data=$this->SuperModel->Super_Get("_uhs_medical_concerns","med_id In(".$ids.")","fetchAll");
		}
		else{
			$data=$this->SuperModel->Super_Get("_uhs_medical_concerns","".$userCond." med_individual_id=".$indData['agency_id']." and MONTH(med_service_date)=".$extra['month']." and YEAR(med_service_date)='".$extra['year']."'","fetchAll");
		}
		$html="";
		
		if(count($data)>0){
			$html.= $this->_report_header("Medical Concerns",$indData);
			$html.="<h5>Individual Information: ".ucwords($indData['agency_first_name']." ".$indData['agency_last_name']).",".$indData['agency_city'].",".$indData['agency_state'].",".$indData['agency_zip']."</h5>
			 	   </div>";
			$html.="<table class='table table-bordered' cellspacing='10' cellpadding='20' width='100%'>
					<tr>
						<th style='padding:0.3%;' width='14.28%'>Date</th>
						<th style='padding:0.3%;' width='14.28%'>Time</th>
						<th style='padding:0.3%;' width='14.28%'>Observation</th>
						<th style='padding:0.3%;' width='14.28%'>Action Taken</th>
						<th style='padding:0.3%;' width='14.28%'>Comments</th>
						<th style='padding:0.3%;' width='14.28%'>Created By</th>
						<th style='padding:0.3%;' width='14.28%'>Created On</th>
				   </tr>";
			foreach($data as $data){
				$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$data['med_added_user']);
				$html.="<tr>
							<td style='padding:0.3%;'>".formatDate($data['med_service_date'])."</td>
							<td style='padding:0.3%;'>".$data['med_service_time']."</td>
							<td style='padding:0.3%;'>".ucwords($data['med_observations'])."</td>
							<td style='padding:0.3%;'>".ucwords($data['med_action_taken'])."</td>
							<td style='padding:0.3%;'>".ucwords($data['med_comments'])."</td>
							<td style='padding:0.3%;'>".ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."</td>
							<td style='padding:0.3%;'>".formatDateTimeNew($data['med_added_date'])."</td>
				  	  </tr>";	
			}
			$html.="</table>";
			if($ids=="All"){
				$html.="<pagebreak />";
			}
		}else{
			$html.= "";
		}
		return $html;
	}
	private function _bowel_movement_log($indData,$ids,$formid,$extra=array()){
		global $months;
		$userCond="";
		if($this->view->user->agency_user_type!="Agency"){ $userCond="bow_added_user='".$this->view->user->agency_id."' and ";}
		if($ids!=="All"){
			$data=$this->SuperModel->Super_Get("_uhs_bow_movement_logs","bow_movement_id In(".$ids.")","fetchAll");
		}
		else{
			$data=$this->SuperModel->Super_Get("_uhs_bow_movement_logs","".$userCond." bow_individual_id=".$indData['agency_id']." and MONTH(bowel_service_date)=".$extra['month']." and YEAR(bowel_service_date)='".$extra['year']."'","fetchAll");
		}
		$html="";
		
		if(count($data)>0){
			$html.= $this->_report_header("Bowel Movement",$indData);
			$html.="<h5>Individual Information: ".ucwords($indData['agency_first_name']." ".$indData['agency_last_name']).",".$indData['agency_city'].",".$indData['agency_state'].",".$indData['agency_zip']."</h5>
			 	   </div>";
			$html.="<table class='table table-bordered' cellspacing='10' cellpadding='20' width='100%'>
					<tr>
						<th style='padding:0.3%;' width='14.28%'>Service Date</th>
						<th style='padding:0.3%;' width='14.28%'>Bowel Movement</th>
						<th style='padding:0.3%;' width='14.28%'>Color</th>
						<th style='padding:0.3%;' width='14.28%'>Size</th>
						<th style='padding:0.3%;' width='14.28%'>Condtion</th>
						<th style='padding:0.3%;' width='14.28%'>Created By</th>
						<th style='padding:0.3%;' width='14.28%'>Created On</th>
				   </tr>";
			foreach($data as $data){
				$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$data['bow_added_user']);
				$html.="<tr>
							<td style='padding:0.3%;'>".formatDate($data['bowel_service_date'])."</td>
							<td style='padding:0.3%;'>".$data['bow_question_1']."</td>
							<td style='padding:0.3%;'>".ucwords($data['bow_question_3'])."</td>
							<td style='padding:0.3%;'>".ucwords($data['bow_question_4'])."</td>
							<td style='padding:0.3%;'>".ucwords($data['bow_question_2'])."</td>
							<td style='padding:0.3%;'>".ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."</td>
							<td style='padding:0.3%;'>".formatDateTimeNew($data['bow_added_date'])."</td>
				  	  </tr>";	
			}
			$html.="</table>";
			if($ids=="All"){
				$html.="<pagebreak />";
			}
		}else{
			$html.= "";
		}
		return $html;
	}
	
	private function _shift_summary_log($indData,$ids,$formid,$extra=array()){
		global $months;
		$userCond="";
		if($ids!=="All"){
			$data=$this->SuperModel->Super_Get("_uhs_shift_summary","shift_id In(".$ids.")","fetchAll",array("order"=>"shift_id DESC"));
		}
		else{
			$data=$this->SuperModel->Super_Get("_uhs_shift_summary","".$userCond." shift_individual_id=".$indData['agency_id']." and MONTH(shift_added_date)=".$extra['month']." and YEAR(shift_added_date)='".$extra['year']."'","fetchAll",array("order"=>"shift_id DESC"));
		}
		$html="";
		
		if(count($data)>0){
			$html.= $this->_report_header("Shift Summar",$indData);
			$html.="<h5>Individual Information: ".ucwords($indData['agency_first_name']." ".$indData['agency_last_name']).",".$indData['agency_city'].",".$indData['agency_state'].",".$indData['agency_zip']."</h5>
			 	   </div>";
			foreach($data as $data){
				$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$data['shift_added_user']);
				 if(!empty($creatorData['agency_company_logo']) && file_exists(AGENCY_IMG_PATH.'/160/'.$creatorData['agency_company_logo'])){
					$img='<img src="'.HTTP_AGENCY_IMG_PATH.'/160/'.$creatorData['agency_company_logo'].'" class="img-responsive marginA" />';
				 }else{
					$img='<img src="'.HTTP_AGENCY_IMG_PATH.'/160/default-icon.png" class="img-responsive marginA" />';
				 } 
				$html.="<div class='col-lg-12 col-md-12 col-sm-12 col-xs-12' style='border:1px solid #eaeaea; margin-bottom:10px; padding:8px 0px; background:#FFF !important;'>
					   <div class='col-xs-1'>".$img."</div>
					   <div class='col-xs-10'>
						   <p style='font-size:13px; color:#5e656b !important; text-align:justify !important;'>".nl2br($data['shift_notes'])."</p> 
						   <span style='font-size:11px; color:#666 !important;'><i>Posted By: ".ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."</i></span> &nbsp;
						   <span style='font-size:11px; color:#666 !important;'><i>Posted On: ".formatDateTime($data['shift_added_date'])."</i></span>
					   </div>
					   <div class='clearfix'></div>
				  </div>";
			}
			if($ids=="All"){
				$html.="<pagebreak />";
			}
		}else{
			$html.= "";
		}
		return $html;
	}
	
	private function _charting_log($indData,$ids,$formid,$type,$extra=array()){
			global $months;
			$userCond="";
			if($this->view->user->agency_user_type!="Agency"){ $userCond="task_added_user='".$this->view->user->agency_id."' and ";}
			if($ids!=="All"){
				$taskData=$this->SuperModel->Super_Get("_uhs_task_entries","task_id IN(".$ids.") and support_frequency IN(select support_frequency from _uhs_supports group by support_frequency) ","fetchAll",array("join"=>"_uhs_supports","joincondition"=>"support_id=task_support_id","joinfields"=>"*","order"=>"support_frequency ASC"));
			}
			else{
				$taskData=$this->SuperModel->Super_Get("_uhs_task_entries","".$userCond." task_individual_id=".$indData['agency_id']." and task_type='".$type."' and MONTH(task_added_date)=".$extra['month']." and YEAR(task_added_date)='".$extra['year']."' and support_frequency IN(select support_frequency from _uhs_supports group by support_frequency) ","fetchAll",array("join"=>"_uhs_supports","joincondition"=>"support_id=task_support_id","joinfields"=>"*","order"=>"support_frequency ASC"));
			}
			//prd($taskData);
			$number = date('t');
			$totalColspan=$number+1;
			$headingText=$html="";
			if($type=="Care"){$headingText="Documentation of Homemaker Personal Care";}
			if($type=="MAR"){ $headingText="PRN Medication Administration Record";}
			if($type=="Cleaning"){ $headingText="Cleaning Chart";}
			$tdWid=round(90/$number,2);
			$html="";
			if(count($taskData)>0){
				$html.= $this->_report_header($headingText,$indData);
				$html.="<h5>Individual Information: ".ucwords($indData['agency_first_name']." ".$indData['agency_last_name']).",".$indData['agency_city'].",".$indData['agency_state'].",".$indData['agency_zip']."</h5>
				</div>";
				$html.="<table class='table table-bordered' cellspacing='10' cellpadding='20' width='100%'><tr><th style='padding:0.5%;' width='20%'>Supports</th>";
				for($i=1;$i<=$number;$i++){
					$html.="<th align='center' style='padding:0.5%;' width='".$tdWid."%'>".$i."</th>";
				}
				$html.="</tr>";
				$fArr=array();
				foreach($taskData as $task){
                                        $creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$task['task_added_user']."'","fetch");
                                        
                                        $documented_by[] = $task['task_added_user'];
                                        if(!in_array($task['support_frequency'],$fArr)){
						$fArr[]=$task['support_frequency'];
						$html.="<tr><td style='padding:0.5%;' colspan='".$totalColspan."'><b>".$task['support_frequency']."</b></td></tr>";
					}
                                        
					$html.="<tr><td style='padding:0.5%;' width='20%'><strong>".$creatorData['agency_first_name']." ".$creatorData['agency_last_name']."</strong><br/>".ucwords($task['support_description'])."</td>";
						for($i=1;$i<=$number;$i++){
							if(date("j",strtotime($task['task_added_date']))==$i){
								if($task['is_task_done']=="Yes"){
									$html.="<td style='padding:0.5%;' align='center' width='".$tdWid."%'><img src='".HTTP_IMG_URL."/yes.png'/><td>";
								}
								else{
									$html.="<td style='padding:0.5%;' align='center' width='".$tdWid."%'><img src='".HTTP_IMG_URL."/no.png'/></td>";
								}
							}
							else if($i<$number){
								$html.="<td style='padding:0.5%;' width='".$tdWid."%'></td>";
							}
                                                }
						$html.="</tr>";	
                                                
					
				}
                                
				$html.="</table>";
                                $documented_by= array_unique($documented_by);
                                $documented_list = array();
                                foreach ($documented_by as $key => $agency_id) {
                                        $where = "agency_id = $agency_id";
                                        $documented_list[]=$this->SuperModel->Super_Get("_uhs_agency",$where,"fetch");
                                }
                                
                                $html.="<div class='container col-md-3'>
                                <h4>Documented By</h4>
                                <table class='table documented-by-list'>
                                    <thead>
                                        <tr>
                                            <th style='padding:0.3%;'>Name</th>
                                        </tr>
                                    </thead>
                                  <tbody>";
                                    foreach ($documented_list as $key => $value) { 
                                        $html.="<tr>
                                            <td style='padding:0.3%;'>".ucwords($value['agency_first_name']. " ". $value['agency_last_name'])."</td>
                                        </tr>";
                                   } 
                                    $html.="</tbody>
                                </table>
                                </div>";
                               if($ids=="All"){
					$html.="<pagebreak />";
				}
			}else{
			$html.= "";
		}
		return $html;
	}
	private function _individual_service_plan_logs($indData,$ids,$formid,$extra=array()){
		global $months;
		$userCond="";
		
		
		if($this->view->user->agency_user_type!="Agency"){
			$userCond="isp_added_user='".$this->view->user->agency_id."' and ";
		}
		$html="";
		if($ids=="All"){
			
			$data=$this->SuperModel->Super_Get("_uhs_isp_log","".$userCond." isp_individual_id=".$indData['agency_id']." and MONTH(isp_added_date)=".$extra['month']." and YEAR(isp_added_date)='".$extra['year']."'","fetchAll");
		}
		else{
			
			$data=$this->SuperModel->Super_Get("_uhs_isp_log","isp_id In(".$ids.")","fetchAll");
		}
		if(count($data)>0){
                        $html.= $this->_report_header("Individual Service Plan",$indData);
			$html.="<h5>Individual Information: ".ucwords($indData['agency_first_name']." ".$indData['agency_last_name']).",".$indData['agency_city'].",".$indData['agency_state'].",".$indData['agency_zip']."</h5>
			 	</div>";
			$html.="<table class='table table-bordered' cellspacing='10' cellpadding='20' width='100%'>
					<tr>
						<th style='padding:0.3%;' width='16.6%'>Span Dates</th>
						<th style='padding:0.3%;' width='16.6%'>Created By</th>
						<th style='padding:0.3%;' width='16.6%'>Created On</th>
				   </tr>";
			foreach($data as $data){
                                $creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$data['isp_added_user']);
				$html.="<tr>
							
							<td style='padding:0.3%;'>From ".formatDate($data['isp_start_date'])." To ".formatDate($data['isp_end_date'])."</td>
							<td style='padding:0.3%;'>".ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."</td>
							<td style='padding:0.3%;'>".formatDateTimeNew($data['isp_added_date'])."</td>
				  	  </tr>";	
			}
			$html.="</table>";
			if($ids=="All"){
				$html.="<pagebreak />";
			}
		}else{
			//$html.= "<h4><center><strong><i> No DATA FOUND </strong></i></center></h4> </div>";
		}
		return $html;
	
	}
	private function _sleep_log($indData,$ids,$formid,$extra=array()){
		global $months;
		$userCond="";
		
		
		if($this->view->user->agency_user_type!="Agency"){
			$userCond="created_by='".$this->view->user->agency_id."' and ";
		}
		$html="";
		if($ids=="All"){
                    
                    $data=$this->SuperModel->Super_Get("_uhs_form_sleep","".$userCond." user_id=".$indData['agency_id']." and MONTH(sleep_date)=".$extra['month']." and YEAR(sleep_date)='".$extra['year']."'","fetchAll");
                    
                    $sleepinfo = array();
                    $documented_by = array();
                    if(!empty($data)){
                        
                        foreach ($data as $key => $sleep) {
                                $sleepinfo[$sleep['sleep_date']][$sleep['sleep_time']] = $sleep;
                                $documented_by[] = $sleep['created_by'];
                                $where = "agency_id = ".$sleep['created_by'];
                                $doc_by = $this->SuperModel->Super_Get("_uhs_agency",$where,"fetch");
                                $sleepinfo[$sleep['sleep_date']][$sleep['sleep_time']]['doc_by'] = ucwords(strtolower($doc_by['agency_first_name'].' '.$doc_by['agency_last_name']));
                        }
                        $documented_by= array_unique($documented_by);
                        $documented_list = array();
                        foreach ($documented_by as $key => $agency_id) {
                                $where = "agency_id = $agency_id";
                                $documented_list[]=$this->SuperModel->Super_Get("_uhs_agency",$where,"fetch");
                        }
                    }
                       
                }
		else{
			$data=array();
                        if(!empty($ids)){
                            $data=$this->SuperModel->Super_Get("_uhs_form_sleep","sleep_id IN(".$ids.")","fetchAll");
                        }                       
                        $sleepinfo = array();
                        $documented_by = array();
                        if(!empty($data)){
                            foreach ($data as $key => $sleep) {
                                    $sleepinfo[$sleep['sleep_date']][$sleep['sleep_time']] = $sleep;
                                    $documented_by[] = $sleep['created_by'];
                                    $where = "agency_id = ".$sleep['created_by'];
                                    $doc_by = $this->SuperModel->Super_Get("_uhs_agency",$where,"fetch");
                                    $sleepinfo[$sleep['sleep_date']][$sleep['sleep_time']]['doc_by'] = ucwords(strtolower($doc_by['agency_first_name'].' '.$doc_by['agency_last_name']));
                            }
                            $documented_by= array_unique($documented_by);
                            $documented_list = array();
                            foreach ($documented_by as $key => $agency_id) {
                                    $where = "agency_id = $agency_id";
                                    $documented_list[]=$this->SuperModel->Super_Get("_uhs_agency",$where,"fetch");
                            }
                        }
		}
		
                $html="";
                if(count($sleepinfo)>0){ 
                    $html.= $this->_report_header("Sleep Log",$indData);
                    $html.="<h5>Individual Information: ".ucwords($indData['agency_first_name']." ".$indData['agency_last_name']).",".$indData['agency_city'].",".$indData['agency_state'].",".$indData['agency_zip']."</h5>
			 	</div>
                                <div class='col-md-6' style='margin-top: 32px;'>
                                    <div style='float: right;'>
                                            <span style='color:#fff; background:#7bac33; padding:3px 7px 3px 7px;'>A</span>=Awake &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
                                            <span style='color:#fff; background:#ff840c; padding:3px 7px 3px 7px;'>R</span>=Resting &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
                                            <span style='color:#fff; background:#ff2940; padding:3px 7px 3px 7px;'>S</span>=Sleeping &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
                                            <span style='color:#fff; background:#01afe4; padding:3px 7px 3px 7px;'>V</span>=Visiting &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
                                    </div>
                                </div>";
                    $html.="<table class='table table-bordered' cellspacing='10' cellpadding='20' width='100%'>";
                    $days = date('t');
                    for($j=0; $j<49; $j++){
                            $html.="<tr>";
                            for($i=0; $i<= $days; $i++){
                                    $xdate = date('Y-m',time()).'-'.$i;
                                    $xdate = date('Y-m-d',strtotime($xdate));
                                    $arry = array("30",'00');
                                    // echo "sahil";
                                    if($i == 0 && $j==0){
                                            $html.="<td style='padding:1px;'>";
                                            $html.="<strong>". "Hours". "</strong>";	
                                            $html.="</td>";
                                    }else if($j==0){
                                            if($i == date('d', time())){
                                                    $html.= "<td style='padding:1px;'>";
                                                    $html.= "<strong>". $i. "</strong><BR><small>(".date('D',strtotime($xdate)).")</small>";
                                            }else{
                                                    $html.="<td style='padding:1px;'>";
                                                    $html.="<strong>". $i. "</strong><BR><small>(".date('D',strtotime($xdate)).")</small>";	
                                            }
                                            $html.="</td>";
                                    }else if($i == 0){
                                            $html.="<td style='padding:1px;'>";
                                            $html.="<strong>". intval(($j)/2) . ":" . $arry[($j-1)%2]. "</strong>";
                                            $html.="</td>";
                                    }elseif(isset($sleepinfo[$xdate][intval(($j)/2) . ":" . $arry[($j-1)%2]])){

                                            $html.="<td style='padding:1px;'>";
                                            $html.="<span>". ucfirst($sleepinfo[$xdate][intval(($j)/2) . ':' . $arry[($j-1)%2]]['sleep_type'])."</span>";
                                            $html.="</td>";
                                    }
                                    elseif($i == date('d', time())){
                                            $html.="<td style='padding:0px;' class='select-time-td'>";
                                            $html.="</td>";
                                     }else{
                                            $html.="<td style='padding:1px;'>";
                                            $html.=" ";
                                            $html.="</td>";
                                    }
                            }
                            $html.="</tr>";
                }
                $html.="</table>";
                $html.="<div class='container col-md-3'>
                    <h2>Documented By</h2>
                    <table class='table documented-by-list'>
                      <thead>
                        <tr>
                          <th style='padding:0.3%;'><h4>Name<h4></th>
                          </tr>
                      </thead>
                      <tbody>";
                      foreach ($documented_list as $key => $value) { 
                          $html.="<tr>
                                <td style='padding:0.3%;'>".ucwords($value['agency_first_name']. " ". $value['agency_last_name'])."<br><label class='badge badge-success badge-roundless' style='background:#5cb85c; font-size:10px !important;'>".$value['agency_user_type']."</label>
                                </td>
                          </tr>";
                       } 
                     $html.="</tbody>
                    </table>
                  </div>";  
                if($ids=="All"){
                         $html.="<pagebreak />";
                }
                }else{
			$html.= "<h4><center><strong><i> No DATA FOUND </strong></i></center></h4> </div>";
		}
		return $html;
	
	}
    private function _behavior_log($indData,$ids,$formid,$extra=array()){
		global $months;
		$userCond="";
		if($this->view->user->agency_user_type!="Agency"){
			$userCond="behavior_added_user='".$this->view->user->agency_id."' and ";
		}
		$html="";
		if($ids=="All"){
			
			$data=$this->SuperModel->Super_Get("_uhs_behavior_support_log","".$userCond." behavior_individual_id=".$indData['agency_id']." and MONTH(bahavior_added_date)=".$extra['month']." and YEAR(bahavior_added_date)='".$extra['year']."'","fetchAll");
                        $behaviorDatas=array();
                        foreach($data as $record){
                           $behaviorData=$this->SuperModel->Super_Get("_uhs_behavior_support_services","_uhs_behavior_support_services.behavior_support_id=".$record['behavior_support_id']."","fetchAll",array("join"=>"_uhs_behavior_support_log","joincondition"=>"_uhs_behavior_support_log.behavior_support_id=".$record['behavior_support_id']."","joinfields"=>"*"));
                           if(!empty($behaviorData)){
                                $behaviorDatas[$record['behavior_support_id']] = $behaviorData;
                           }
                        }
                }
		else{
		}
                $number = date('t');
                $totalColspan=$number+1;
                $tdWid=round(90/$number,2);
                $html="";
                if(count($behaviorDatas)>0){
                        $html.= $this->_report_header("Behavior Support Log",$indData);
			$html.="<h5>Individual Information: ".ucwords($indData['agency_first_name']." ".$indData['agency_last_name']).",".$indData['agency_city'].",".$indData['agency_state'].",".$indData['agency_zip']."</h5>
				</div>
				<div class='col-lg-9 col-md-9 col-sm-9 col-xs-12 text-left padding0'>
                                    <span style='color:#13bca6;'>'Y'</span>=Yes  
                                    <span style='color:#13bca6;'>'N'</span>=No  
                                    <span style='color:#13bca6;'>'NA'</span>=Not Available 
                                    <span style='color:#13bca6;'>'O'</span>=Other 
                                </div>";
                        foreach($behaviorDatas as $records){
                            $html.="<table class='table table-bordered' cellspacing='10' cellpadding='20' width='100%'><tr><th style='padding:0.5%;' width='20%'>Shift</th>";
                            for($i=1;$i<=$number;$i++){
                                    $html.="<th align='center' style='padding:0.5%;' width='".$tdWid."%'>".$i."</th>";
                            }
                            $html.="</tr>";
                            $grouped = array();
                            foreach ($records as $item) {
                              $grouped[$item['behavior_services_time']][] = $item;
                            }
                            foreach($grouped as $key => $groupedrecord){
                               $html.="<tr><td style='padding:0.5%;' width='20%'>".$key."</td>";
                                $flag=0;
                                $temp=1;
                                $count = count($groupedrecord);
                                $index=1;
                                foreach($groupedrecord as $record){
                                   for($i=$temp;$i<=$number;$i++){
                                        if(date("j",strtotime($record['behavior_services_date']))==$i){

                                            if($record['bahavior_selection'] == 'code'){
                                                
                                                $html.="<td style='padding:0.5%;' align='center' width='".$tdWid."%'>".$record['behavior_services_code']."</td>";
                                                $temp = $i + 1;
                                                if($count == $index){
                                                     for($z=$temp;$z<=$number;$z++){
                                                        $html.="<td style='padding:0.5%;' width='".$tdWid."%'></td>";
                                                     } 
                                                }
                                                break;
                                            }else {
                                                
                                                $html.="<td style='padding:0.5%;' align='center' width='".$tdWid."%'>".$record['bahavior_counter']."</td>";
                                                $temp = $i + 1;
                                                if($count == $index){
                                                     for($z=$temp;$z<=$number;$z++){
                                                        $html.="<td style='padding:0.5%;' width='".$tdWid."%'></td>";
                                                     } 
                                                }
                                                 break;
                                            }
                                        }
                                        else if($i < $number){
                                           $html.="<td style='padding:0.5%;' width='".$tdWid."%'></td>";
                                        }
                                    }
                                    $flag++;
                                     $index++;
                                }
                                $html.="</tr>";
                            }
                            $html.="</table>"; 
                            $html.="<div><strong>Heading :</strong>"." ".$record['bahavior_heading']."<BR>
                            <strong>Support :</strong>"." ".$record['bahavior_description']."</div><BR>";
                        }
                        if($ids=="All"){
				$html.="<pagebreak />";
			}
		}else{
			//$html.= "<h4><center><strong><i> No DATA FOUND </strong></i></center></h4> </div>";
		}
		return $html;
	
	}
	private function _bowelmovement_log($indData,$ids,$formid,$extra=array()){
		global $months;
		$userCond="";
		
		
		if($this->view->user->agency_user_type!="Agency"){
			$userCond="bow_added_user='".$this->view->user->agency_id."' and ";
		}
		$html="";
		if($ids=="All"){
			
			$data=$this->SuperModel->Super_Get("_uhs_bow_movement_logs","".$userCond." bow_individual_id=".$indData['agency_id']." and MONTH(bowel_service_date)=".$extra['month']." and YEAR(bowel_service_date)='".$extra['year']."'","fetchAll");
		}
		else{
			
			$data=$this->SuperModel->Super_Get("_uhs_bow_movement_logs","bow_movement_id In(".$ids.")","fetchAll");
		}
		if(count($data)>0){
                        $html.= $this->_report_header("Bowel Movement",$indData);
			$html.="<h5>Individual Information: ".ucwords($indData['agency_first_name']." ".$indData['agency_last_name']).",".$indData['agency_city'].",".$indData['agency_state'].",".$indData['agency_zip']."</h5>
			 	</div>";
			$html.="<table class='table table-bordered' cellspacing='10' cellpadding='20' width='100%'>
					<tr>
						<th style='padding:0.3%;' width='16.6%'>Service Date</th>
						<th style='padding:0.3%;' width='16.6%'>Bowel Movement?</th>
						<th style='padding:0.3%;' width='16.6%'>Color</th>
						<th style='padding:0.3%;' width='16.6%'>Size</th>
						<th style='padding:0.3%;' width='16.6%'>Created By</th>
						<th style='padding:0.3%;' width='16.6%'>Created On</th>
				   </tr>";
			foreach($data as $data){
                                $creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$data['bow_added_user']);
				$html.="<tr>
							
							<td style='padding:0.3%;'>".formatDate($data['bowel_service_date'])."</td>
							<td style='padding:0.3%;'>".$data['bow_question_1']."</td>
							<td style='padding:0.3%;'>".$data['bow_question_3']."</td>
							<td style='padding:0.3%;'>".$data['bow_question_4']."</td>
							<td style='padding:0.3%;'>".ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."</td>
							<td style='padding:0.3%;'>".formatDateTimeNew($data['bow_added_date'])."</td>
				  	  </tr>";	
			}
			$html.="</table>";
			if($ids=="All"){
				//$html.="<pagebreak />";
			}
		}else{
			//$html.= "<h4><center><strong><i> No DATA FOUND </strong></i></center></h4> </div>";
		}
		return $html;
	
	}
	
	/* Common Codes */
	public function checktimerecordAction(){
		global $healthSession;
		$indid=$_REQUEST['indid'];
		$formid=$_REQUEST['formid'];
		$stime=$_REQUEST['stime'];
		$id=$_REQUEST['id'];
		$date=$_REQUEST['date'];
		switch($formid){
			case 3:
				$dbDate=date("Y-m-d",strtotime($date));
				$where="service_date='".$dbDate."' and service_start_time='".$stime."' and service_individual_id=".$indid;
				if(!empty($id)){
					$where.=" and sheet_id!=".$id;
				}
				$timeData=$this->SuperModel->Super_Get("_uhs_timing_sheets",$where);
				if(!empty($timeData)){
					$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$timeData['service_added_user']);
					$msg="You have already selected this time.";
					if($creatorData['agency_id']!=$this->view->user->agency_id){
						$msg=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])." has already selected this time.";
					}
					echo "1~~".$msg;
				}
			break;
		}
		exit();
	}

	public function sleepaddAction(){
		global $healthSession;
		$this->view->pageHeading="Add Sleep Log";
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");

		//get data
		$month = date('Y-m',time());
		// $created_by = $this->view->user->agency_id;
		$where = "user_id =$indid AND month= '$month'";
		$sleepData=$this->SuperModel->Super_Get("_uhs_form_sleep",$where,"fetchAll");
		$sleepinfo = array();
		$documented_by = array();
		foreach ($sleepData as $key => $sleep) {
			$sleepinfo[$sleep['sleep_date']][$sleep['sleep_time']] = $sleep;
			$documented_by[] = $sleep['created_by'];
			$where = "agency_id = ".$sleep['created_by'];
			$doc_by = $this->SuperModel->Super_Get("_uhs_agency",$where,"fetch");
			$sleepinfo[$sleep['sleep_date']][$sleep['sleep_time']]['doc_by'] = ucwords(strtolower($doc_by['agency_first_name'].' '.$doc_by['agency_last_name']));
		}
		$documented_by= array_unique($documented_by);
		$documented_list = array();
		foreach ($documented_by as $key => $agency_id) {
			$where = "agency_id = $agency_id";
			$documented_list[]=$this->SuperModel->Super_Get("_uhs_agency",$where,"fetch");
		}
		$this->view->formid 		= $formid;
		$this->view->indid 		= $indid;
		$this->view->sleepData		= $sleepinfo;
		$this->view->documentedBy 	= $documented_list;
	}

	public function savesleepAction(){
		global $healthSession;
		$data=$_POST;
		$data['sleep_date'] = date('Y-m-d',time());
		$data['created_by'] = $this->view->user->agency_id;
		$data['user_id'] = $this->_getParam("indid");
		$data['month'] = date('Y-m',time());
		$isIns=$this->SuperModel->Super_Insert("_uhs_form_sleep",$data);
		if($isIns->success){
			echo "true";
		}else{
			echo "false";
		}
		die();
	}

	public function sleeploghistoryAction() {
		ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);
//        global $healthSession;
//        $this->view->pageHeading = "Sleep Log History";
//        $indid = $this->_getParam("indid");
//        $formid = $this->_getParam("formid");
//        $datestring = date('Y-m-d') . ' first day of last month';
//        $dt = date_create($datestring);
//        $month = $dt->format('Y-m');
//        $where = "user_id=$indid AND month = '$month'";
//        $sleepData = $this->SuperModel->Super_Get("_uhs_form_sleep", $where, "fetchAll");
//        $sleepinfo = array();
//        $documented_by = array();
//        foreach ($sleepData as $key => $sleep) {
//            $sleepinfo[$sleep['sleep_date']][$sleep['sleep_time']] = $sleep;
//            $documented_by[] = $sleep['created_by'];
//            $where = "agency_id = " . $sleep['created_by'];
//            $doc_by = $this->SuperModel->Super_Get("_uhs_agency", $where, "fetch");
//            $sleepinfo[$sleep['sleep_date']][$sleep['sleep_time']]['doc_by'] = ucwords(strtolower($doc_by['agency_first_name'] . ' ' . $doc_by['agency_last_name']));
//            // if($sleep['sleep_id'] == 134){
//            // }
//        }
//        $documented_by = array_unique($documented_by);
//        $documented_list = array();
//        foreach ($documented_by as $key => $agency_id) {
//            $where = "agency_id = $agency_id";
//            $documented_list[] = $this->SuperModel->Super_Get("_uhs_agency", $where, "fetch");
//        }
//        // print_r(count($sleepinfo));die;
//        $this->view->formid = $formid;
//        $this->view->indid = $indid;
//        $this->view->sleepData = $sleepinfo;
//        $this->view->documentedBy = $documented_list;
//        $this->view->month = $month;
        
        global $healthSession;
        $this->view->pageHeading = "Sleep Log History";
        $indid = $this->_getParam("indid");
        $formid = $this->_getParam("formid");
        
        $month_year = $this->_getParam("id");
        
        if($month_year == 0) {
            $month = date('Y-m', strtotime("last month"));
            
            $tempYear = date('Y', strtotime("last month"));
            $tempMonth = date('m', strtotime("last month"));
            $tempDate = "$tempYear-$tempMonth-01";
            
            $this->view->search_year = $tempYear;
            $this->view->search_month = $tempMonth;
            $this->view->searchYearMonth = $tempDate;
        }
        else {
            $tempYear = substr($month_year, 0, 4);
            $tempMonth = substr($month_year, 4);
            $tempDate = "$tempYear-$tempMonth-01";
            
            $month = date('Y-m', strtotime($tempDate));
            
            $this->view->search_year = $tempYear;
            $this->view->search_month = $tempMonth;
            $this->view->searchYearMonth = $tempDate;
        }
        
        $where = "WHERE user_id =$indid AND month= '$month'";
        //$sleepData = $this->SuperModel->Super_Get("_uhs_form_sleep", $where, "fetchAll");
        
        $this->dbObj = Zend_Registry::get('db');
        $testQuery = "SELECT * FROM _uhs_form_sleep $where";
        $sleepData = $this->dbObj->query($testQuery)->fetchAll();
        
        $sleepinfo = array();
        $documented_by = array();
        foreach ($sleepData as $key => $sleep) {
            $sleepinfo[$sleep['sleep_date']][$sleep['sleep_time']] = $sleep;
            $documented_by[] = $sleep['created_by'];
            $where = "agency_id = " . $sleep['created_by'];
            $doc_by = $this->SuperModel->Super_Get("_uhs_agency", $where, "fetch");
            $sleepinfo[$sleep['sleep_date']][$sleep['sleep_time']]['doc_by'] = ucwords(strtolower($doc_by['agency_first_name'] . ' ' . $doc_by['agency_last_name']));
        }
        $documented_by = array_unique($documented_by);
        $documented_list = array();
        foreach ($documented_by as $key => $agency_id) {
            $where = "agency_id = $agency_id";
            $documented_list[] = $this->SuperModel->Super_Get("_uhs_agency", $where, "fetch");
        }
        $this->view->formid = $formid;
        $this->view->indid = $indid;
        $this->view->sleepData = $sleepinfo;
        $this->view->documentedBy = $documented_list;
        
        
    }

	  // blowmovementAction
	public function blowmovementAction(){	
		error_reporting(1);
		global $healthSession; 
  		$this->view->pageHeading = " Bowel movement";
		 $indid=$this->_getParam("indid");
		 $formid=$this->_getParam("formid");
		 $id=$this->_getParam("id");
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		$this->view->permissions=$permissions;
		if(empty($indid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		 $this->view->indid=$indid;
		 $this->view->id=$id;
		 $this->view->formid=$formid;
  	}

	public function savebowmomentAction() {
   
       	global $healthSession,$systemusers;
		$formid=$this->_getParam("formid");
		$indid=$this->_getParam("indid");
		$id=$this->_getParam("id");
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		if($permissions=="View Only"){
			$healthSession->errorMsg="You don't have permission to access this page.";
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_blow_movement");
		}
		$form=new Application_Form_CustomForms();

		$form->blowmovement($indid,$formid,$id);

		if($this->getRequest()->isPost()){
			$posted_data = $this->getRequest()->getPost();

   			if($form->isValid($posted_data)){
				
				if(empty($id)){

					 $indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
					 $agencyData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indData['agency_user_agency_id']);

					 $posted_data['bow_agency_id']=$agencyData['agency_id'];
					 $posted_data['bow_individual_id']=$indid;
					 $posted_data['bow_movement_form_id']=$formid;
					 $posted_data['bow_added_date']=date('Y-m-d H:i:s');
					 $posted_data['bow_added_user']=$this->view->user->subuser_id;

				$posted_data['bowel_service_date']=date("Y-m-d",strtotime($posted_data['bowel_service_date']));
		 $isInserted = $this->SuperModel->Super_Insert("_uhs_bow_movement_logs",$posted_data);
					 if($isInserted->success){
						if(in_array($this->view->user->agency_user_type,$systemusers) && checkNotifySettings($this->view->user->agency_user_agency_id,"form-".$formid)){
							$notifyData=array("notification_user_id"=>$this->view->user->agency_user_agency_id,"notification_type"=>"form-".$formid,"notification_type_id"=>$isInserted->inserted_id,"notification_by_user_id"=>$this->view->user->agency_id,"notification_date"=>date("Y-m-d H:i:s"));
							$isNotify=$this->SuperModel->Super_Insert("_uhs_notifications",$notifyData);
						}
						$healthSession->successMsg  = "Bowel movement log has been added successfully.";
					 }else{
						$healthSession->errorMsg  = $isInserted->message;
					 }
				}
				else{
		$posted_data['bowel_service_date']=date("Y-m-d",strtotime($posted_data['bowel_service_date']));
					$posted_data['bow_modified_by']=$this->view->user->subuser_id;
					$posted_data['bow_modified_on']=date('Y-m-d H:i:s');
					$isInserted = $this->SuperModel->Super_Insert("_uhs_bow_movement_logs",$posted_data,"bow_movement_id=".$id);
					if($isInserted->success){
						$healthSession->successMsg  =" Bowel movement log has been updated successfully.";
					 }else{
						$healthSession->errorMsg  = $isInserted->message;
					 }
				}
				 
   			}else{
				$healthSession->errorMsg = " Please check information again.";
 			}
		 }
		 $this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_blow_movement");
	}


	public function removeblowmovementlogsAction() {
	
		global $healthSession;
		$indid=$this->_getParam('indid');
		$formid=$this->_getParam('formid');
 		$this->_helper->layout->disableLayout();
		$this->_helper->viewRenderer->setNoRender(true);
		$formData = $this->getRequest()->getPost();
		if(isset($formData['records']) && count($formData['records'])) {
			foreach($formData['records'] as $key=>$values){
  				$isDel=$this->SuperModel->Super_Delete('_uhs_bow_movement_logs',"bow_movement_id=".$values);
 				$healthSession->successMsg=" Bowel MovementLog(s) has been deleted successfully.";
			}
		}
		else{
			$healthSession->errorMsg = "Invalid Request.";
		}
		$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_blow_movement");


	}




  	public function getbowmovementAction(){
		if(check_is_ajax($this->_request)){
			$this->_redirect(APPLICATION_URL);
		}
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		// BY : Amit
                $subuser=$dstarts=$dends=$month=$year="";
		if(isset($_REQUEST['subuser']) && !empty($_REQUEST['subuser'])){
			$subuser=$_REQUEST['subuser'];
		}
		if(isset($_REQUEST['dstarts']) && !empty($_REQUEST['dstarts'])){
			$dstarts=$_REQUEST['dstarts'];
		}
		if(isset($_REQUEST['dends']) && !empty($_REQUEST['dends'])){
			$dends=$_REQUEST['dends'];
		}
		if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
			$month=$_REQUEST['month'];
		}
		if(isset($_REQUEST['year']) && !empty($_REQUEST['year'])){
			$year=$_REQUEST['year'];
		}
 		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('bow_movement_id','bow_movement_form_id','bow_agency_id','bow_individual_id','bow_added_user','bow_question_1','bow_question_2','bow_question_3','bow_question_4','bow_added_date','bow_modified_by', 'bow_modified_on', 'bowel_service_date');
		$sIndexColumn = 'bow_movement_id';
		$sTable = '_uhs_bow_movement_logs';
		$sLimit = "";
                if(isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength']!='-1'){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		if ( isset( $_GET['iSortCol_0'] ) ){
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
			{
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
				{
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
		if(empty($subuser)){
			
			if($sWhere){
				$sWhere.=" and bow_individual_id='".$indid."'"; 
                        }
			else{
				$sWhere.=" where bow_individual_id='".$indid."'"; 
                        }
		}
		else{
			if($sWhere){
                            $sWhere.=" and bow_added_user IN(".$subuser.") and bow_individual_id='".$indid."'"; 
                        }
			else{
                            $sWhere.=" where bow_added_user IN(".$subuser.") and bow_individual_id='".$indid."'"; 
                        }
		}
		if(!empty($dstarts)){
			$sWhere.=" and DATE(bow_added_date) >='".$dstarts."'";
		}
		if(!empty($dends)){
			$sWhere.=" and DATE(bow_added_date) <='".$dends."'";
		}
		if(!empty($month)){
			$sWhere.=" and MONTH(bow_added_date)='".$month."'";
		}
		if(!empty($year)){
			$sWhere.=" and YEAR(bow_added_date)='".$year."'";
		}
		
		if(empty($month) && empty($year) && empty($dstarts) && empty($dends) && empty($subuser)){
                    if(!empty($sWhere)){
                        $sWhere.=" and MONTH(bow_added_date)=MONTH(CURDATE()) and YEAR(bow_added_date)=YEAR(CURDATE())";
                    }else{
                        $sWhere.=" where MONTH(bow_added_date)=MONTH(CURDATE()) and YEAR(bow_added_date)=YEAR(CURDATE())";
                    }
                }
                
		// BY : Amit

                $sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
 		$qry = $this->dbObj->query($sQuery)->fetchAll();

		$sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
		$output = array(
 				"iTotalRecords" => $iTotal,
				"iTotalDisplayRecords" => $iFilteredTotal,
				"aaData" => array()
			);
		$j=0;
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		foreach($qry as $row1){

			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['bow_added_user']."'","fetch");
			$modifierData=array();
			if($row1['bow_modified_by']!=0){
				$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$row1['bow_modified_by']);
			}	
			$row=array();
 			$row[] = $j+1;
			$row[]='<input class="elem_ids checkboxes" type="checkbox" name="records['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';
			$row[]= formatDate($row1['bowel_service_date']);  

			$row[]= $row1['bow_question_1'];  
			$row[]= $row1['bow_question_3']; 
			$row[]=$row1['bow_question_4']; 
			$userType = printUserType($creatorData);	
  			$row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
			$row[]=formatDateTimeNew($row1['bow_added_date']);
			$row[]=$row1['bow_question_2'];
			if(!empty($modifierData)){
				$userType=printUserType($modifierData);
				$row[]=ucwords($modifierData['agency_first_name']." ".$modifierData['agency_last_name'])."&nbsp;".$userType;
				$row[]=formatDateTime($row1['bow_modified_on']);
			}else{
				$row[]="-";
				$row[]="-";
			}

			

			$type='"BlowForm"';
			if(($permissions=="Edit" || $permissions=="Both") && !isFormAssigned($formid,$indid)){
				$row[]="<a style='margin-top:5px;' href='javascript:void(1);' onclick='showDiffrentForms(".$indid.",".$formid.",".$row1[$sIndexColumn].",".$type.");' class='btn btn-xs btn-default'>Edit</a>";
			}
			else{
				$row[]="-";
			}
 			$output['aaData'][] = $row;
			$j++;
		}
		echo json_encode($output);
		exit();
	}

// DD 132 Form


public function behavoirsupportsAction(){	
		global $healthSession; 

	      $indid=$this->_getParam("indid");
		  $formid=$this->_getParam("formid");
		  $id=$this->_getParam("id");

         $this->dbObj = Zend_Registry::get('db');

		 $permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);

		$agencyDataid = $this->dbObj->query("select * from _uhs_agency where agency_id =".$this->view->user->agency_id)->fetchAll();

	    $agencyDataid[0]['agency_user_type'];

        if($agencyDataid[0]['agency_user_type'] == 'Staff') {

         	$healthSession->errorMsg="You don't have permission to access this page.";
         $this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"view_behavoir_supports");
           exit;

        }

		if($permissions=="View Only"){
			$healthSession->errorMsg="You don't have permission to access this page.";
		}
	
         if($this->getRequest()->isPost()){

			$data = $this->getRequest()->getPost();

				$madicationData['bahavior_heading']=array_values($data['behavior_support_title']);
				$madicationData['bahavior_description']=array_values($data['behavior_support_desc']);
				$madicationData['bahavior_selection']=array_values($data['selectone']);


		$madicationData['bahavior_shift']=array_values($data['shift1']);
		$madicationData['bahavior_shift_1']=array_values($data['shift2']);
		$madicationData['bahavior_shift_2']=array_values($data['shift3']);
		$madicationData['bahavior_shift_3']=array_values($data['shift4']);


	            unset($data['bahavior_heading']);
				unset($data['bahavior_description']);
				unset($data['bahavior_selection']);
				unset($data['bahavior_shift']);
				unset($data['bahavior_shift_1']);
				unset($data['bahavior_shift_2']);
				unset($data['bahavior_shift_3']);

	$totalbehaviorcount =count($madicationData['bahavior_heading']);

	for($i=0;$i<$totalbehaviorcount;$i++){

			     	$madicationDatanew=array();
					$madicationDatanew['bahavior_heading']=$madicationData['bahavior_heading'][$i];
					$madicationDatanew['bahavior_description']=$madicationData['bahavior_description'][$i];
					$madicationDatanew['bahavior_selection']=$madicationData['bahavior_selection'][$i];
					$madicationDatanew['bahavior_shift']=$madicationData['bahavior_shift'][$i];

					$madicationDatanew['bahavior_shift_1']=$madicationData['bahavior_shift_1'][$i];

					$madicationDatanew['bahavior_shift_2']=$madicationData['bahavior_shift_2'][$i];

					$madicationDatanew['bahavior_shift_3']=$madicationData['bahavior_shift_3'][$i];


					 $indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
					 $agencyData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indData['agency_user_agency_id']);

			$madicationDatanew['behavior_agency_id']=$agencyData['agency_id'];
			$madicationDatanew['behavior_individual_id']=$indid;
			$madicationDatanew['behavior_form_id']=$formid;
			$madicationDatanew['behavior_added_user']=$this->view->user->subuser_id;

			$a=$this->SuperModel->Super_Insert("_uhs_behavior_support_log",$madicationDatanew);
			var_dump($a);
				}
              $healthSession->successMsg="behavior support log has been added successfully";
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"view_behavoir_supports");

   	     }

  		$this->view->pageHeading = "  BEHAVIOR SUPPORTS LOG";
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		$this->view->permissions=$permissions;
		if(empty($indid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		 $this->view->indid=$indid;
		 $this->view->id=$id;
		 $this->view->formid=$formid;
         $sTable = '_uhs_agency';
         $sWhere = "agency_id =".$id;
       	 $indData =$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");

         $this->view->agency_first_name        =   $indData['agency_first_name'];
         $this->view->agency_last_name      =   $indData['agency_last_name'];
         $this->view->agency_email      =   $indData['agency_email'];
         $this->view->agency_gender      =   $indData['agency_gender'];
         $this->view->agency_dob      =   $indData['agency_dob'];
         $this->view->agency_address1      =   $indData['agency_address1'];
         $this->view->agency_cell_phone      =   $indData['agency_cell_phone'];
         $this->view->agency_medicaid_number      =   $indData['agency_medicaid_number'];
         $this->view->agency_medicare_number      =   $indData['agency_medicare_number'];

  	}


public function viewbehavoirsupportsAction() {
	 global $healthSession,$systemusers; 
  	     $this->view->pageHeading = "  BEHAVIOR SUPPORTS LOG";
		 $indid=$this->_getParam("indid");
		 $formid=$this->_getParam("formid");
		 $id=$this->_getParam("id");
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		   $this->view->permissions=$permissions;
		     if(empty($indid))
		        {
			  $healthSession->errorMsg="Invalid Access";
			  $this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		       }
		 $this->view->indid=$indid;
		 $this->view->id=$id;
		 $this->view->formid=$formid;

      $indi_data=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
     $this->view->indi_data=$indi_data;
        $indi_parent_data=$this->SuperModel->Super_get("_uhs_agency","agency_id='".$indi_data['agency_user_agency_id']."'",'fetch');



        //echo "<pre>"; print_r($indi_parent_data); die;
        $sWhere = "";
        $this->dbObj = Zend_Registry::get('db');
        $aColumns = array('behavior_support_id', 'behavior_form_id', 'behavior_agency_id', 'behavior_individual_id', 'behavior_added_user', 'bahavior_heading', 'bahavior_description', 'bahavior_selection', 'bahavior_shift', 'bahavior_added_date', 'bahavior_modified_by', 'bahavior_modified_on', 'bahavior_shift_1', 'bahavior_shift_2', 'bahavior_shift_3');

        $sIndexColumn = 'behavior_support_id';
        $sTable = '_uhs_behavior_support_log';
        $sLimit = "";
//        $smnth= date('m');
//        $syear= date('Y');
        
        //$sWhere .=" where behavior_individual_id=".$indid." and MONTH(bahavior_added_date) =".$smnth." and  YEAR(bahavior_added_date) =".$syear."";
        $sWhere .= " where behavior_individual_id='" . $indid . "'";

        $sQuery = "SELECT SQL_CALC_FOUND_ROWS " . str_replace(" , ", " ", implode(", ", $aColumns)) . " FROM  $sTable $sWhere $sOrder $sLimit";
        $qry = $this->dbObj->query($sQuery)->fetchAll();

        //echo "<pre>"; print_r($qry); die;

        /* Start Pagination */
        $page = $this->_request->getParam('page');
        $page = $this->_request->getParam('page',1);

        $paginator = Zend_Paginator::factory($qry);
        $paginator->setItemCountPerPage(4);
        $paginator->setCurrentPageNumber($page);
        $this->view->paginator=$paginator;

        $start = 0;
        $limit = 4;
        $page = $this->_getParam('page');
        if(!empty($page)){
            $start = ($page-1) * $limit;
        }

        $sWhere = "";
        $this->dbObj = Zend_Registry::get('db');
        $aColumns = array('behavior_support_id', 'behavior_form_id', 'behavior_agency_id', 'behavior_individual_id', 'behavior_added_user', 'bahavior_heading', 'bahavior_description', 'bahavior_selection', 'bahavior_shift', 'bahavior_added_date', 'bahavior_modified_by', 'bahavior_modified_on', 'bahavior_shift_1', 'bahavior_shift_2', 'bahavior_shift_3');

        $sIndexColumn = 'behavior_support_id';
        $sTable = '_uhs_behavior_support_log';

        $sLimit = "LIMIT " . intval($start) . ", " . intval($limit);
       // $sWhere .=" where behavior_individual_id='".$indid."' and MONTH(bahavior_added_date) ='".$smnth."' and  YEAR(bahavior_added_date) ='".$syear."'";
        $sWhere .= " where behavior_individual_id='" . $indid . "'";
        $sQuery = "SELECT SQL_CALC_FOUND_ROWS " . str_replace(" , ", " ", implode(", ", $aColumns)) . " FROM  $sTable $sWhere $sOrder $sLimit";
        $qry = $this->dbObj->query($sQuery)->fetchAll();

        /* End Pagination */

        //echo "<pre>"; print_r($qry); die;
        
        foreach ($qry as $key=>$supportdata){
            $assignedby = $supportdata['behavior_added_user'];
            $aCol = array('agency_id', 'agency_first_name', 'agency_last_name');

            $sIndexColumn = '_uhs_agency';
            $ssTable = '_uhs_agency';
            $ssLimit = "";
            // $ssWhere.=" where agency_id=3307";
            // $sWhere.=" where agency_id='".$assignedby."'";

            $sql = "SELECT SQL_CALC_FOUND_ROWS " . str_replace(" , ", " ", implode(", ", $aCol)) . " FROM  $ssTable";

            $qrydata = $this->dbObj->query($sql)->fetchAll();

            $agencyDataid = $this->dbObj->query("select * from _uhs_agency where agency_id =" . $assignedby)->fetchAll();
            $qry[$key]['qrydata']=$qrydata;
            $qry[$key]['agencyDataid']=$agencyDataid;


        }
        
        
        if($this->view->user->agency_user_type == "Agency") {
             $agencyid=$this->view->user->agency_id;
             $amendview_data = $this->SuperModel->Super_Get("_uhs_amend_view", "am_agency_id='".$agencyid."' AND am_indid='".$indid."' AND am_form_id='".$formid."' ", "fetch");
             if(!empty($amendview_data)){
                 $this->view->am_status = $amendview_data['am_status'];
                 $this->view->am_id = $amendview_data['am_id'];
             }else {
                 $this->view->am_status = 0;
                 $this->view->am_id = 0;
              }
        } elseif($this->view->user->agency_user_type == "Staff") {
                $agencyid=$this->view->user->agency_user_agency_id;
                $amendview_data = $this->SuperModel->Super_Get("_uhs_amend_view", "am_agency_id='".$agencyid."' AND am_indid='".$indid."' AND am_form_id='".$formid."' ", "fetch");
                if(!empty($amendview_data)){
                   $this->view->am_status = $amendview_data['am_status'];
                } else {
                 $this->view->am_status = 0;
                }
        }
        $this->view->agency_user_type = $this->view->user->agency_user_type;
        
        $this->view->calenderData=$qry;
		$this->view->indi_parent_data=$indi_parent_data;
                

}



	/* remove beh Code */
	public function removebehavoirAction(){	
		global $healthSession;
		$medid=$_REQUEST['medId'];
	$medData=$this->SuperModel->Super_Get("_uhs_behavior_support_log","behavior_support_id=".$medid);
		if(!empty($medData)){
			$isRemoved=$this->SuperModel->Super_Delete("_uhs_behavior_support_log","behavior_support_id=".$medid);
		}
		exit();
	}


// edit behavoir supports
public function editbehavoirsupportsAction() {
error_reporting(E_ALL);
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
	 $indid=$this->_getParam("indid");
		 $formid=$this->_getParam("formid");
		 $id=$this->_getParam("id");
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
         $this->dbObj = Zend_Registry::get('db');
$agencyDataid = $this->dbObj->query("select * from _uhs_agency where agency_id =".$this->view->user->agency_id)->fetchAll();
	    $agencyDataid[0]['agency_user_type'];
        if($agencyDataid[0]['agency_user_type'] == 'Staff') {
         	$healthSession->errorMsg="You don't have permission to access this page.";
         $this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"view_behavoir_supports");
           exit;

        }
		
		$this->view->permissions=$permissions;
		  if(empty($indid)){
			  $healthSession->errorMsg="Invalid Access";
			  $this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		  }
	 global $healthSession; 
  	     
     if($this->getRequest()->isPost()){
			$data = $this->getRequest()->getPost();

	   $madicationData['bahavior_heading']=array_values($data['behavior_support_title']);
	    $madicationData['bahavior_description']=array_values($data['behavior_support_desc']);
	$madicationData['behavior_support_id']=array_values($data['support_id']);
$madicationData['bahavior_selection']=array_values($data['selectone']);
	
		$madicationData['bahavior_shift']=array_values($data['shift1']);
		$madicationData['bahavior_shift_1']=array_values($data['shift2']);
		$madicationData['bahavior_shift_2']=array_values($data['shift3']);
		$madicationData['bahavior_shift_3']=array_values($data['shift4']);
	            unset($data['bahavior_heading']);
				unset($data['bahavior_description']);
				unset($data['bahavior_selection']);
				unset($data['bahavior_shift']);
				unset($data['bahavior_shift_1']);
				unset($data['bahavior_shift_2']);
				unset($data['bahavior_shift_3']);
		 $totalbehaviorcount =count($madicationData['bahavior_heading']);
	    	for($i=0;$i<$totalbehaviorcount;$i++){

			     	$madicationDatanew=array();
					$madicationDatanew['bahavior_heading']=$madicationData['bahavior_heading'][$i];
					$madicationDatanew['bahavior_description']=$madicationData['bahavior_description'][$i];

					$madicationDatanew['bahavior_selection']=$madicationData['bahavior_selection'][$i]
					;
					$madicationDatanew['bahavior_shift']=$madicationData['bahavior_shift'][$i];

					$madicationDatanew['bahavior_shift_1']=$madicationData['bahavior_shift_1'][$i];

					$madicationDatanew['bahavior_shift_2']=$madicationData['bahavior_shift_2'][$i];

					$madicationDatanew['bahavior_shift_3']=$madicationData['bahavior_shift_3'][$i];

$madicationDatanew['behavior_support_id']=$madicationData['behavior_support_id'][$i];
$indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
$agencyData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indData['agency_user_agency_id']);
$madicationDatanew['behavior_agency_id']=$agencyData['agency_id'];
$madicationDatanew['behavior_form_id']=$formid;
	$madicationDatanew['behavior_added_user']=$this->view->user->subuser_id;
           if($madicationDatanew['behavior_support_id']) {
            	$a=$this->SuperModel->Super_Insert("_uhs_behavior_support_log",$madicationDatanew, "behavior_support_id=".$madicationDatanew['behavior_support_id']);
            }
            else {
          $madicationDatanew['behavior_individual_id']=$indid;
			$a=$this->SuperModel->Super_Insert("_uhs_behavior_support_log",$madicationDatanew);
            }
			var_dump($a);

				}
 $healthSession->successMsg="behavior support log has been updated successfully";

			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"view_behavoir_supports");

   	     }

  	     $this->view->pageHeading = "Edit Behavior Support Log";
	
		 $this->view->indid=$indid;
		 $this->view->id=$id;
		 $this->view->formid=$formid;

     $indi_data=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
     $this->view->indi_data=$indi_data;

    $isExist=$this->SuperModel->Super_Get("_uhs_behavior_support_log","behavior_individual_id=".$indid,"fetchAll");

    $this->view->behavior = $isExist;
}




// history behavoir supportsAction


        public function historybehavoirsupportsAction() {
            global $healthSession,$systemusers; 
            $this->view->pageHeading = "  BEHAVIOR SUPPORTS HISTORY CHART";
            $indid=$this->_getParam("indid");
            $formid=$this->_getParam("formid");
            $id=$this->_getParam("id");
            $permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
               $this->view->permissions=$permissions;
                 if(empty($indid))
                    {
                      $healthSession->errorMsg="Invalid Access";
                      $this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
                   }
            $this->view->indid=$indid;
            $this->view->id=$id;
            $this->view->formid=$formid;
            $indi_data=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
            $this->view->indi_data=$indi_data;
            $indi_parent_data=$this->SuperModel->Super_get("_uhs_agency","agency_id='".$indi_data['agency_user_agency_id']."'",'fetch');
            $this->view->indi_parent_data=$indi_parent_data;
            if(in_array($this->view->user->agency_user_type,$systemusers)) {
                    $agencyid=$this->view->user->agency_user_agency_id;
                    $amendview_data = $this->SuperModel->Super_Get("_uhs_amend_view", "am_agency_id='".$agencyid."' AND am_indid='".$indid."' AND am_form_id='".$formid."' ", "fetch");
                    if(!empty($amendview_data)){
                       $this->view->am_status = $amendview_data['am_status'];
                    } else {
                     $this->view->am_status = 0;
                    }
            }
            $this->view->agency_user_type = $this->view->user->agency_user_type;
        }

public function behavoirpdfprintAction() {

	$indid=$this->_getParam("indid");
		 $formid=$this->_getParam("formid");
		 $id=$this->_getParam("id");

		 $html = $this->behavoirpdfHtmlAction($indid,$formid,$id);


require_once ROOT_PATH.'/private/mpdf/mpdf.php';
		$mpdf=new mPDF('utf-8', 'A4-L');
		$stylesheet = file_get_contents(APPLICATION_URL.'/public/plugins/bootstrap/css/bootstrap.css');
		//$stylesheet = file_get_contents(APPLICATION_URL . '/public/front_css/style_custom.css');
		$mpdf->SetTitle('Behavoir Support Log');
		$mpdf->WriteHTML($stylesheet,1);
		$mpdf->WriteHTML($html,2);
		$mpdf->Output(); 
		exit();


}

public function behavoirpdfAction() {
	$indid=$this->_getParam("indid");
	 $formid=$this->_getParam("formid");
	 $id=$this->_getParam("id");

	 $html = $this->behavoirpdfHtmlAction($indid,$formid,$id);

	 $permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		$this->view->permissions=$permissions;
		  if(empty($indid)){
			  $healthSession->errorMsg="Invalid Access";
			  $this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		  }
global $healthSession;
      if(!empty($html)){
			require_once ROOT_PATH.'/private/mpdf/mpdf.php';
		    $mpdf=new mPDF('utf-8', 'A2');
		    //$mpdf->showImageErrors = true;
			$stylesheet = file_get_contents(APPLICATION_URL.'/public/plugins/bootstrap/css/bootstrap.css');

			$mpdf->SetTitle('Behavoir Support Log');
			$mpdf->WriteHTML($stylesheet,1);
			$mpdf->WriteHTML($html,2);
			$mpdf->Output('/home/xoomia/public_html/public/pdf/behavior.pdf','F'); 
	      //$mpdf->Output(); 

			//echo $html;
			//die;
		//	echo "sdfsdf";

    if($this->getRequest()->isPost()){
	    $data = $this->getRequest()->getPost();

$recipients = $data['msg_to'];
$email_to = explode(',', $recipients);

$count = count($email_to);
 $mail = new Zend_Mail();


$Mc = 1;
foreach ($email_to as $toemail) {

    if($Mc >= $count) 
       {
	        $maildddd = str_replace(' ', '', $toemail);
			$mail = new Zend_Mail();
			$mail->setBodyHtml($data['msg_text']);
			$mail->setFrom('client@xoomia.com', 'xoomia.com');
			$mail->addTo($maildddd,$ReceiverName);
			$mail->setSubject($data['msg_subject']);
			$content = file_get_contents("/home/xoomia/public_html/public/pdf/behavior.pdf"); 
			$attachment = new Zend_Mime_Part($content);
			$attachment->type = 'application/pdf';
			$attachment->disposition = Zend_Mime::DISPOSITION_ATTACHMENT;
			$attachment->encoding = Zend_Mime::ENCODING_BASE64;
			$attachment->filename = 'behavior.pdf'; // name of file
			$mail->addAttachment($attachment);                  
			$mail->send();
			echo 'done';
	   }  
$Mc++;
}


      $healthSession->successMsg="Data has been email successfully";

	$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"view_behavoir_supports");

   	     }


			exit();
		}

}

public function behavoirpdfHtmlAction($indid,$formid,$id) {

		/* $indid=$this->_getParam("indid");
		 $formid=$this->_getParam("formid");
		 $id=$this->_getParam("id");*/

global $rotines,$time_array,$weekArray; $agency_id=$this->agency_id; 
$SuperModel = new Application_Model_SuperModel();

 $this->dbObj = Zend_Registry::get('db');
    $aColumns = array('behavior_support_id','behavior_form_id','behavior_agency_id','behavior_individual_id','behavior_added_user','bahavior_heading','bahavior_description','bahavior_selection','bahavior_shift','bahavior_added_date','bahavior_modified_by','bahavior_modified_on', 'bahavior_shift_1', 'bahavior_shift_2', 'bahavior_shift_3');

    $sIndexColumn = 'behavior_support_id';
    $sTable = '_uhs_behavior_support_log';
    $sLimit = "";
    $sWhere.=" where behavior_individual_id='".$indid."'"; 
    $sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
    $qry = $this->dbObj->query($sQuery)->fetchAll();

 $agencyDataid = $this->dbObj->query("select * from _uhs_agency where agency_id =".$indid)->fetchAll();
 $spanData = $this->dbObj->query("select * from _uhs_spend_dates where agency_id=".$indid." AND spend_status = 1")->fetch();
   if(isset($spanData)){ 
                    if(!empty($spanData['spend_from_date']) && !empty($spanData['spend_to_date'])){
                       $exlpode_from_date = explode("/",$spanData['spend_from_date']);
					   $spend_from_date =  $exlpode_from_date[1]."/". $exlpode_from_date[0]."/". $exlpode_from_date[2];
					   $exlpode_to_date = explode("/",$spanData['spend_to_date']);
					   $spend_to_date =  $exlpode_to_date[1]."/". $exlpode_to_date[0]."/". $exlpode_to_date[2];
					   $date =  $spend_from_date." - ".$spend_to_date;
                    }else{ $date = "NA";}
                }else{ $date =  "NA";}
 $agencyData = $this->dbObj->query("select * from _uhs_agency where agency_id =".$agencyDataid[0]['agency_user_agency_id'])->fetchAll();

if(!empty($agencyDataid[0]['agency_address1']) && !empty($agencyDataid[0]['agency_city']) && !empty($agencyDataid[0]['agency_state']) && !empty($agencyDataid[0]['agency_zip'])){
        	$iadd = ucwords($agencyDataid[0]['agency_address1'].",".$agencyDataid[0]['agency_city'].",".$agencyDataid[0]['agency_state'].",".$agencyDataid[0]['agency_zip']);

        }else{ $iadd = "NA";}

$name = $agencyData[0]['agency_first_name']." ".$agencyData[0]['agency_last_name'];

 if(!empty($agencyData[0]['agency_address1']) && !empty($agencyData[0]['agency_city']) && !empty($agencyData[0]['agency_state']) && !empty($agencyData[0]['agency_zip'])){
        	
     $address = ucwords($agencyData[0]['agency_address1'].",".$agencyData[0]['agency_city'].",".$agencyData[0]['agency_state'].",".$agencyData[0]['agency_zip']);

    }else{ $address = "NA";} 

$anme = $agencyDataid[0]['agency_first_name'].' '.$agencyDataid[0]['agency_last_name'];

$html = "";
$html .='<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 profile-container"><div class="clearfix"></div>';

 //~ $html .='<div class="well">
    	//~ <div class="col-xs-5">
            //~ <h4 class="magin0">Company Information</h4><br/>
            //~ <div class="col-xs-2">';

				  //~ $html .='<img class="img-responsive" src="'.HTTP_AGENCY_IMG_PATH.'/160/default-icon.png" alt="pharmacy" />';

        //~ $html .='</div>
        //~ <div class="col-xs-8">
        //~ <p style="font-size:12px;"><b>Company Name:</b>'.$agencyData[0]["agency_company_name"].'</p>
        //~ <p style="font-size:12px;"><b>Provider No:</b>'.$agencyData[0]["agency_provider_number"].'</p>
        //~ <p style="font-size:12px;"><b>Name:</b>'.$name.'</p>
        //~ <p style="font-size:12px;"><b>Address: </b>'.$address.'</p>
        //~ <p style="font-size:12px;"><b>Contact: </b>'.$agencyData[0]["agency_contact"].'</p>
            //~ </div>
        //~ </div>
        //~ <div class="col-xs-5">
            //~ <h4 class="magin0">Individual Information</h4><br/>
            //~ <div class="col-xs-2">';

			  //~ $html .='<img class="img-responsive" src="'.HTTP_AGENCY_IMG_PATH.'/160/default-icon.png" alt="pharmacy" />';

            //~ $html .='</div>
            //~ <div class="col-xs-8">
//~ <p style="font-size:12px;"><b>Individual Id:</b>'.$agencyDataid[0]["agency_individual_assign_code"].'</p>
//~ <p style="font-size:12px;"><b>Medicaid Number:</b>'.$agencyDataid[0]["agency_medicaid_number"].'</p>
//~ <p style="font-size:12px;"><b>Name:</b>'.$anme.'</p>
//~ <p style="font-size:12px;"><b>Address: </b>'.$iadd.'</p>
//~ <p style="font-size:12px;"><b>Individual Service Plan: </b>'.$date.'</p>
//~ <p style="font-size:12px;"><b>Contact: </b>'.$agencyDataid[0]["agency_contact"].'</p>
//~ </div>
        //~ </div>
    	//~ <div class="clearfix"></div>
   //~ </div>';
   
   $html .= '<div class="well"><table style= "width:100%">
					<tr>
						<td> 
							<div class="col-xs-5">
								<h4 class="magin0">Company Information</h4><br>
								<div class="col-xs-2"><img class="img-responsive" src="'.HTTP_AGENCY_IMG_PATH.'/160/default-icon.png" alt="pharmacy" /></div>
								<div class="col-xs-8"><p><b>Company Name:</b>'. $agencyData[0]["agency_company_name"].'</p>
								
								<p><b>Provider No:</b>'. $agencyData[0]["agency_provider_number"].'</p>
								
								<p><b>Name:</b>'.$name.'</p>
								
								<p><b>Address:</b>'.$address.'</p>
								
								<p><b>Contact:</b>'. $agencyData[0]["agency_contact"].'</p></div>
							</div>
						</td>
						
						<td>
							<div class="col-xs-5">
								<h4 class="magin0">Individual Information</h4><br>
							    <div class="col-xs-2"><img class="img-responsive" src="'.HTTP_AGENCY_IMG_PATH.'/160/default-icon.png" alt="pharmacy" /></div>
								<div class="col-xs-8"><p><b>Individual Id:</b>'.$agencyDataid[0]["agency_individual_assign_code"].'</p>
								<p><b>Medicaid Number: </b>'.$agencyDataid[0]["agency_medicaid_number"].'</p>
								<p><b>Name: </b>'.$anme.'</p>
								<p><b>Address:</b>'.$iadd.'</p>
								<p><b>Contact:</b>'.$agencyDataid[0]["agency_contact"].'</p>
								<p><b>Individual Plan Dates:</b>'.$date.'</p></div>
							</div>	
						</td>
					</tr>
				</table></div>';	

$html .='<div class="col-lg-9 col-md-9 col-sm-9 col-xs-12 text-left padding0">
    <span style="color:#13bca6;">"Y"</span>=Yes &nbsp; 
    <span style="color:#13bca6;">"N"</span>=No &nbsp; 
    <span style="color:#13bca6;">"NA"</span>=Not Available &nbsp; 
    <span style="color:#13bca6;">"O"</span>=Other &nbsp; 
</div>';

  $html .='<div class="clearfix">&nbsp;</div><div class="col-xs-12 table-responsive profile-container cstmcss" style="padding-left:0;">
     <table  width="100%" cellpadding="0" cellspacing="0" class="">
        <tbody>
          <tr>
            <td><table style="border:1px solid #000;margin-bottom:10px;" width="100%" cellpadding="100" cellspacing="100" class="boldfont">
                <tr>
                  <td style="width:30%">'.ucwords($agencyData[0]['agency_company_name']).'</td>
                  <td style="width:70%">'.date("F/Y").'</td>
                </tr>
              </table></td>
          </tr>';


  if($qry!="" && count($qry)>0){
       foreach($qry as $supportdata){

  $assignedby = $supportdata['behavior_added_user'];
   $agencyDataid = $this->dbObj->query("select * from _uhs_agency where agency_id =".$assignedby)->fetchAll();

          $html .='<tr class="toprow" style="border-top:1px solid #000;">
            <td>
                <table style="border-top:1px solid;" width="100%" cellpadding="0" cellspacing="0" class="bordertopmar textuppercase">
                      <tr>
              <td class="lefttr">
                                  <table width="100%" border="0" cellpadding="0" cellspacing="0">
   <tr class="boldfont">

   <td width="100%" colspan="2" valign="top">Heading:'.$supportdata['bahavior_heading'].'</td></tr>
                     <tr>
               <td width="100%" valign="top"></td>
                                <td valign="top"></td></tr>
<tr><td colspan="2"> Support:'.$supportdata['bahavior_description'].'</td></tr>

   </table></td>
   <td class="verticle_align_top righttr">
   <table width="100%" border="0" cellpadding="0" cellspacing="0" class="">
        <tr class="marborderclass" style="border-top:none !important">
            <td class="marborderrightclass" style="width:7%;"> Shift </td>';

      for($j=1;$j<=date('t');$j++){
                $date=date("Y")."-".date('m')."-".$j;
             
           if($j==date('d')){$tod='today_date_class';
                             }
              else{ $tod='';}
      $html .='<td class="marborderrightclass '.$tod.'">'.$j.'<br/> <small style="font-size:50% !important;">('.date('D',strtotime($date)).')</small> </td>';
      }
    $html .='</tr>';

if($supportdata['bahavior_shift'] == 'none' or $supportdata['bahavior_shift'] == null) { 
  $html .='<tr><td class="marborderrightclass" style="width:7%;"> </td>';
   for($j=1;$j<=date('t');$j++){
                $date=date("Y")."-".date('m')."-".$j;
            
            if($j==date('d')){$tod='today_date_class';
                            }
              else{ $tod='';} 
      $html .='<td class="marborderrightclass"> &nbsp; </td>';
                        }
  $html .='</tr>';
 }
if($supportdata['bahavior_shift'] == 'none') { 
$time = "";
$html .='<tr><td class="marborderrightclass" style="width:7%;">'.$time.'</td>';
for($j=1;$j<=date('t');$j++){
                $date=date("Y")."-".date('m')."-".$j;
                 if($j < 10) {
                      $datedb =date("Y")."-".date('m')."-0".$j;
                 }
                 else {
                     $datedb =date("Y")."-".date('m')."-".$j;
                 }
         if($j==date('d')){$tod='today_date_class';
     } else{ $tod='';} 

    $aColumnss = array('behavior_services_code' , 'bahavior_counter' , 'behavior_services_date');
    $ssTable = '_uhs_behavior_support_services';
   $sWhere="where behavior_services_date='".$datedb."' and behavior_support_id = '".$supportdata['behavior_support_id']."' and behavior_services_time = '".$time."'"; 
      $ssQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumnss))." FROM  $ssTable $sWhere";
    $qryd = $this->dbObj->query($ssQuery)->fetchAll();
if($j==date('d')) { 
	$coden = $qryd[0]['behavior_services_code'];
 if($coden) {
       $codeC = "#867d70";
  }
 elseif($coden == "") {
  $codeC = "#fff";
 }

$html .='<td class="marborderrightclass"  style="background-color:'.$codeC.';color: #fff;">';

 if(empty($qryd[0]['behavior_services_code'])) {
   }
   else {
      if($qryd[0]['behavior_services_code'] !='counter') {
          $html .= $qryd[0]['behavior_services_code'];
      }
      else { 
 $html .=$qryd[0]["bahavior_counter"];
      }
   }
$html .='</td>';
 } else { 
 		$coden = $qryd[0]['behavior_services_code'];
 if($coden) {
       $codeC = "#867d70";
  }
 elseif($coden == "") {
  $codeC = "#fff";
 }
 $html .='<td class="marborderrightclass"  style="background-color:'.$codeC.';color: #fff;">';
     if($qryd[0]['behavior_services_code'] !='counter') {
          $html .= $qryd[0]['behavior_services_code'];
      }
      else {
        $html .= $qryd[0]['bahavior_counter']; 

      }

    $html .='</td>';
      } 
  }
 $html .= '</tr>';
}


if($supportdata['bahavior_shift_1'] == '1') {   
$time = $supportdata['bahavior_shift_1'];
$html .='<tr><td class="marborderrightclass" style="width:7%;">'.$time.'</td>';
for($j=1;$j<=date('t');$j++){
                $date=date("Y")."-".date('m')."-".$j;
                 if($j < 10) {
                      $datedb =date("Y")."-".date('m')."-0".$j;
                 }
                 else {
                     $datedb =date("Y")."-".date('m')."-".$j;
                 }
          if($j==date('d')){$tod='today_date_class';
           } else{ $tod='';}
   $aColumnss = array('behavior_services_code' , 'bahavior_counter');
   $ssTable = '_uhs_behavior_support_services';
   $sWhere="where behavior_services_date='".$datedb."' and behavior_support_id = '".$supportdata['behavior_support_id']."' and behavior_services_time = '".$time."'"; 
      $ssQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumnss))." FROM  $ssTable $sWhere";
    $qryd = $this->dbObj->query($ssQuery)->fetchAll();
if($j==date('d')) { 
$coden = $qryd[0]['behavior_services_code'];
 if($coden) {
       $codeC = "#867d70";
  }
 elseif($coden == "") {
  $codeC = "#fff";
 }
$html .='<td class="marborderrightclass"  style="background-color:'.$codeC.';color: #fff;">'; 
 if(empty($qryd[0]['behavior_services_code'])) {
       
   }
   else {
    if($qryd[0]['behavior_services_code'] !='counter') { 
      $html .= $qryd[0]['behavior_services_code'];
           }
      else { 
  $html .= $qryd[0]['bahavior_counter'];
   }
   }
$html .='</td>';
   } else { 
$coden = $qryd[0]['behavior_services_code'];
 if($coden) {
       $codeC = "#867d70";
  }
 elseif($coden == "") {
  $codeC = "#fff";
 }
 $html .='<td class="marborderrightclass"  style="background-color:'.$codeC.';color: #fff;">'; 
 if($qryd[0]['behavior_services_code'] !='counter') { 
 	 $html .= $qryd[0]['behavior_services_code']; 
     }
      else { 
          $html .= $qryd[0]['bahavior_counter'];
    }
   $html .='</td>';
            } 
      }
  $html .='</tr>';
if($supportdata['bahavior_shift_2'] != NULL) { 
  $html .='<tr><td class="marborderrightclass" style="width:7%;">  </td>';
   for($j=1;$j<=date('t');$j++){
                $date=date("Y")."-".date('m')."-".$j;
          
           if($j==date('d')){$tod='today_date_class';
                           }
              else{ $tod='';}
      $html .='<td class="marborderrightclass"> &nbsp; </td>';
                          }
  $html .='</tr>';
  } 
 } 


if($supportdata['bahavior_shift_2'] == '2') {   
$time = $supportdata['bahavior_shift_2'];
$html .='<tr><td class="marborderrightclass" style="width:7%;">'.$time.'</td>';
for($j=1;$j<=date('t');$j++){
                $date=date("Y")."-".date('m')."-".$j;
                 if($j < 10) {
                      $datedb =date("Y")."-".date('m')."-0".$j;
                 }
                 else {
                     $datedb =date("Y")."-".date('m')."-".$j;
                 }
          if($j==date('d')){$tod='today_date_class';
           } else{ $tod='';}
   $aColumnss = array('behavior_services_code' , 'bahavior_counter');
   $ssTable = '_uhs_behavior_support_services';
   $sWhere="where behavior_services_date='".$datedb."' and behavior_support_id = '".$supportdata['behavior_support_id']."' and behavior_services_time = '".$time."'"; 
      $ssQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumnss))." FROM  $ssTable $sWhere";
    $qryd = $this->dbObj->query($ssQuery)->fetchAll();
if($j==date('d')) { 
$coden = $qryd[0]['behavior_services_code'];
 if($coden) {
       $codeC = "#867d70";
  }
 elseif($coden == "") {
  $codeC = "#fff";
 }
$html .='<td class="marborderrightclass"  style="background-color:'.$codeC.';color: #fff;">'; 
 if(empty($qryd[0]['behavior_services_code'])) {
       
   }
   else {
    if($qryd[0]['behavior_services_code'] !='counter') { 
      $html .= $qryd[0]['behavior_services_code'];
           }
      else { 
  $html .= $qryd[0]['bahavior_counter'];
   }
   }
$html .='</td>';
   } else { 
$coden = $qryd[0]['behavior_services_code'];
 if($coden) {
       $codeC = "#867d70";
  }
 elseif($coden == "") {
  $codeC = "#fff";
 }
 $html .='<td class="marborderrightclass"  style="background-color:'.$codeC.';color: #fff;">'; 
 if($qryd[0]['behavior_services_code'] !='counter') { 
 	 $html .= $qryd[0]['behavior_services_code']; 
     }
      else { 
          $html .= $qryd[0]['bahavior_counter'];
    }
   $html .='</td>';
            } 
      }
  $html .='</tr>';
if($supportdata['bahavior_shift_3'] != NULL) { 
  $html .='<tr><td class="marborderrightclass" style="width:7%;">  </td>';
   for($j=1;$j<=date('t');$j++){
                $date=date("Y")."-".date('m')."-".$j;
          
           if($j==date('d')){$tod='today_date_class';
                           }
              else{ $tod='';}
      $html .='<td class="marborderrightclass"> &nbsp; </td>';
                          }
  $html .='</tr>';
  } 
 } 
 

if($supportdata['bahavior_shift_3'] == '3') { 

if($supportdata['bahavior_shift_2'] == NULL) { 

 $html .='<tr><td class="marborderrightclass" style="width:7%;">  </td>';
    for($j=1;$j<=date('t');$j++){
                $date=date("Y")."-".date('m')."-".$j;
          
          if($j==date('d')){$tod='today_date_class';
                        }
              else{ $tod='';}
     $html .='<td class="marborderrightclass"> &nbsp; </td>';
                    }
 $html .='</tr>';
  } 


$time = $supportdata['bahavior_shift_3'];
$html .='<tr><td class="marborderrightclass" style="width:7%;">'.$time.'</td>';
for($j=1;$j<=date('t');$j++){
                $date=date("Y")."-".date('m')."-".$j;
                 if($j < 10) {
                      $datedb =date("Y")."-".date('m')."-0".$j;
                 }
                 else {
                     $datedb =date("Y")."-".date('m')."-".$j;
                 }
          if($j==date('d')){$tod='today_date_class';
           } else{ $tod='';}
   $aColumnss = array('behavior_services_code' , 'bahavior_counter');
   $ssTable = '_uhs_behavior_support_services';
   $sWhere="where behavior_services_date='".$datedb."' and behavior_support_id = '".$supportdata['behavior_support_id']."' and behavior_services_time = '".$time."'"; 
      $ssQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumnss))." FROM  $ssTable $sWhere";
    $qryd = $this->dbObj->query($ssQuery)->fetchAll();
if($j==date('d')) { 
$coden = $qryd[0]['behavior_services_code'];
 if($coden) {
       $codeC = "#867d70";
  }
 elseif($coden == "") {
  $codeC = "#fff";
 }
$html .='<td class="marborderrightclass"  style="background-color:'.$codeC.';color: #fff;">'; 
 if(empty($qryd[0]['behavior_services_code'])) {
       
   }
   else {
    if($qryd[0]['behavior_services_code'] !='counter') { 
      $html .= $qryd[0]['behavior_services_code'];
           }
      else { 
  $html .= $qryd[0]['bahavior_counter'];
   }
   }
$html .='</td>';
   } else { 
$coden = $qryd[0]['behavior_services_code'];
 if($coden) {
       $codeC = "#867d70";
  }
 elseif($coden == "") {
  $codeC = "#fff";
 }
 $html .='<td class="marborderrightclass"  style="background-color:'.$codeC.';color: #fff;">'; 
 if($qryd[0]['behavior_services_code'] !='counter') { 
 	 $html .= $qryd[0]['behavior_services_code']; 
     }
      else { 
          $html .= $qryd[0]['bahavior_counter'];
    }
   $html .='</td>';
            } 
      }
  $html .='</tr>';
 } 


 $html .='</table></td>
                  </tr>
              </table></td>
          </tr>
          <tr class="'.$class.'">
            <td><table  width="100%" border="0" cellpadding="0" cellspacing="0" class="">
                <tbody>
                  <tr>
                    <td><table width="100%" border="0" cellpadding="0" cellspacing="0" class="">
                        <tr>
                          <td style="width:35%"></td>
                          <td style="width:65%"> &nbsp;  </td>
                        </tr>
                      </table></td>
                  </tr>
                </tbody>
              </table></td>
          </tr>
           <tr class="'.$class.'">
            <td style="height:15px;"></td>
           </tr>';
           }}       
          
           $html .='<tr>
            <td style="height:15px;"></td>
           </tr>
        </tbody>
     </table>';

$html .='<table style="width: 100%">
   <tr style="border-top: 2px solid">
    <th>Documenting By</th>
    </tr>';
     foreach ( $agencyDataid as  $agencyData) { 
     $html .='<tr>
      <td>'.$agencyData["agency_first_name"].' '.$agencyData["agency_last_name"].'</br>
        <span class="agcd">'.$agencyData["agency_user_type"].'</span>

      </td>
    </tr>';
  } 
 
$html .='</table>';

     $html .='</div>
   </div>
   </div>
   <div class="clearfix">&nbsp;</div>
</div>
</div>';
         // die;

$html .='<link href="http://localhost/xoomia/public/plugins/bootstrap/css/bootstrap.css" media="screen" rel="stylesheet" type="text/css" >';


return $html;




}


public function behavoirpdfAction_killllll() {

		 $indid=$this->_getParam("indid");
		 $formid=$this->_getParam("formid");
		 $id=$this->_getParam("id");

global $rotines,$time_array,$weekArray; $agency_id=$this->agency_id; 
$SuperModel = new Application_Model_SuperModel();

 $this->dbObj = Zend_Registry::get('db');
    $aColumns = array('behavior_support_id','behavior_form_id','behavior_agency_id','behavior_individual_id','behavior_added_user','bahavior_heading','bahavior_description','bahavior_selection','bahavior_shift','bahavior_added_date','bahavior_modified_by','bahavior_modified_on', 'bahavior_shift_1', 'bahavior_shift_2', 'bahavior_shift_3');

    $sIndexColumn = 'behavior_support_id';
    $sTable = '_uhs_behavior_support_log';
    $sLimit = "";
    $sWhere.=" where behavior_individual_id='".$indid."'"; 
    $sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
    $qry = $this->dbObj->query($sQuery)->fetchAll();

 $agencyDataid = $this->dbObj->query("select * from _uhs_agency where agency_id =".$indid)->fetchAll();

 $agencyData = $this->dbObj->query("select * from _uhs_agency where agency_id =".$agencyDataid[0]['agency_user_agency_id'])->fetchAll();

if(!empty($agencyDataid[0]['agency_address1']) && !empty($agencyDataid[0]['agency_city']) && !empty($agencyDataid[0]['agency_state']) && !empty($agencyDataid[0]['agency_zip'])){
        	$iadd = ucwords($agencyDataid[0]['agency_address1'].",".$agencyDataid[0]['agency_city'].",".$agencyDataid[0]['agency_state'].",".$agencyDataid[0]['agency_zip']);

        }else{ $iadd = "NA";}

$name = $agencyData[0]['agency_first_name']." ".$agencyData[0]['agency_last_name'];

 if(!empty($agencyData[0]['agency_address1']) && !empty($agencyData[0]['agency_city']) && !empty($agencyData[0]['agency_state']) && !empty($agencyData[0]['agency_zip'])){
        	
     $address = ucwords($agencyData[0]['agency_address1'].",".$agencyData[0]['agency_city'].",".$agencyData[0]['agency_state'].",".$agencyData[0]['agency_zip']);

    }else{ $address = "NA";} 

$anme = $agencyDataid[0]['agency_first_name'].' '.$agencyDataid[0]['agency_last_name'];

$html = "";
$html .='<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 profile-container"><div class="clearfix"></div>';

$html .='<div class="well fofo"><table style= "width:100%"><tr><td>
<div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
<h4 class="magin0">Company Information</h4><br>
<p><b>Company:</b>'.$agencyData[0]['agency_company_name'].'</p>
<p>&nbsp;</p>
<p><b>Provider No:</b>'.$agencyData[0]['agency_provider_number'].'</p>
<p>&nbsp;</p>
<p><b>Name:</b> Crystal Sillah</p>
<p>&nbsp;</p>
<p><b>Address: </b>'.$address.'</p>
<p>&nbsp;</p>
<p><b>Contact: </b>'.$agencyData[0]['agency_contact'].'</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
</div></td>
<td>
<div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
<h4 class="magin0">Individual Information</h4><br>
<p><b>Individual Id:</b>'.$agencyDataid[0]['agency_individual_assign_code'].'</p>
<p>&nbsp;</p>
<p><b>Medicaid Number:</b>'.$agencyDataid[0]['agency_medicaid_number'].'</p>
<p>&nbsp;</p>
<p><b>Name:</b>'.$anme.'</p>
<p>&nbsp;</p>
<p><b>Address: </b>'.$iadd.'</p>
<p>&nbsp;</p>
<p><b>County of Services: </b>'.$agencyDataid[0]['agency_county'].'</p>
<p>&nbsp;</p>
<p><b>Contact: </b>'.$agencyDataid[0]['agency_contact'].'</p>
<p>&nbsp;</p>     
<p><b>Individual Service Plan: </b>
NA</p> 
<p>&nbsp;</p></div>
</td></tr></table></div>
</div>';


$html .='<div style="padding-left:0;" class="col-lg-9 col-md-9 col-sm-9 col-xs-12 text-left padding0">
    <span style="color:#13bca6;">"Y"</span>=Yes &nbsp; 
    <span style="color:#13bca6;">"N"</span>=No &nbsp; 
    <span style="color:#13bca6;">"NA"</span>=Not Available &nbsp; 
    <span style="color:#13bca6;">"O"</span>=Other &nbsp; 
</div>';


  $html .='<div class="clearfix">&nbsp;</div><div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 profile-container cstmcss">
     <table  width="100%" cellpadding="0" cellspacing="0" class="">
        <tbody>
          <tr>
            <td><table style="border:1px solid #000;margin-bottom:10px;" width="100%" cellpadding="100" cellspacing="100" class="boldfont">
                <tr>
                  <td style="width:35%">'.ucwords($agencyData[0]['agency_company_name']).'</td>
                  <td style="width:65%">'.date("F/Y").'</td>
                </tr>
              </table></td>
          </tr>';


  if($qry!="" && count($qry)>0){
       foreach($qry as $supportdata){
          $html .='<tr class="toprow" style="border-top:1px solid #000;">
            <td>
                <table style="border-top:1px solid;" width="100%" cellpadding="0" cellspacing="0" class="bordertopmar textuppercase">
                      <tr>
                          <td style="width:25%;" class="">
                                  <table width="100%" border="0" cellpadding="0" cellspacing="0">
   <tr class="boldfont"><td width="75%" colspan="2" valign="top">Heading:'.$supportdata['bahavior_heading'].'</td></tr>
                                      <tr>
                               <td width="75%" valign="top"></td>
                                <td valign="top"></td></tr>
<tr><td colspan="2"> Support:'.$supportdata['bahavior_description'].'</td></tr>

   </table></td>
   <td style="width:75%" class="verticle_align_top">
   <table width="100%" border="0" cellpadding="0" cellspacing="0" class="">
        <tr class="marborderclass" style="border-top:none !important">
            <td class="marborderrightclass" style="width:7%;"> Shift </td>';

      for($j=1;$j<=date('t');$j++){
                $date=date("Y")."-".date('m')."-".$j;
             
           if($j==date('d')){$tod='today_date_class';
                             }
              else{ $tod='';}
      $html .='<td class="marborderrightclass '.$tod.'">'.$j.'<br/> <small style="font-size:50% !important;">('.date('D',strtotime($date)).')</small> </td>';
      }
    $html .='</tr>';

if($supportdata['bahavior_shift'] == 'none' or $supportdata['bahavior_shift'] == null) { 
  $html .='<tr><td class="marborderrightclass" style="width:7%;"> </td>';
   for($j=1;$j<=date('t');$j++){
                $date=date("Y")."-".date('m')."-".$j;
            
            if($j==date('d')){$tod='today_date_class';
                            }
              else{ $tod='';} 
      $html .='<td class="marborderrightclass"> &nbsp; </td>';
                        }
  $html .='</tr>';
 }
if($supportdata['bahavior_shift'] == 'none') { 
$time = "";
$html .='<tr><td class="marborderrightclass" style="width:7%;">'.$time.'</td>';
for($j=1;$j<=date('t');$j++){
                $date=date("Y")."-".date('m')."-".$j;
                 if($j < 10) {
                      $datedb =date("Y")."-".date('m')."-0".$j;
                 }
                 else {
                     $datedb =date("Y")."-".date('m')."-".$j;
                 }
         if($j==date('d')){$tod='today_date_class';
     } else{ $tod='';} 

    $aColumnss = array('behavior_services_code' , 'bahavior_counter' , 'behavior_services_date');
    $ssTable = '_uhs_behavior_support_services';
   $sWhere="where behavior_services_date='".$datedb."' and behavior_support_id = '".$supportdata['behavior_support_id']."' and behavior_services_time = '".$time."'"; 
      $ssQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumnss))." FROM  $ssTable $sWhere";
    $qryd = $this->dbObj->query($ssQuery)->fetchAll();
if($j==date('d')) { 
	$coden = $qryd[0]['behavior_services_code'];
 if($coden) {
       $codeC = "#867d70";
  }
 elseif($coden == "") {
  $codeC = "#fff";
 }

$html .='<td class="marborderrightclass"  style="background-color:'.$codeC.';color: #fff;">';

 if(empty($qryd[0]['behavior_services_code'])) {
   }
   else {
      if($qryd[0]['behavior_services_code'] !='counter') {
          $html .= $qryd[0]['behavior_services_code'];
      }
      else { 
 $html .=$qryd[0]["bahavior_counter"];
      }
   }
$html .='</td>';
 } else { 
 		$coden = $qryd[0]['behavior_services_code'];
 if($coden) {
       $codeC = "#867d70";
  }
 elseif($coden == "") {
  $codeC = "#fff";
 }
 $html .='<td class="marborderrightclass"  style="background-color:'.$codeC.';color: #fff;">';
     if($qryd[0]['behavior_services_code'] !='counter') {
          $html .= $qryd[0]['behavior_services_code'];
      }
      else {
        $html .= $qryd[0]['bahavior_counter']; 

      }

    $html .='</td>';
      } 
  }
 $html .= '</tr>';
}


if($supportdata['bahavior_shift_1'] == '1') {   
$time = $supportdata['bahavior_shift_1'];
$html .='<tr><td class="marborderrightclass" style="width:7%;">'.$time.'</td>';
for($j=1;$j<=date('t');$j++){
                $date=date("Y")."-".date('m')."-".$j;
                 if($j < 10) {
                      $datedb =date("Y")."-".date('m')."-0".$j;
                 }
                 else {
                     $datedb =date("Y")."-".date('m')."-".$j;
                 }
          if($j==date('d')){$tod='today_date_class';
           } else{ $tod='';}
   $aColumnss = array('behavior_services_code' , 'bahavior_counter');
   $ssTable = '_uhs_behavior_support_services';
   $sWhere="where behavior_services_date='".$datedb."' and behavior_support_id = '".$supportdata['behavior_support_id']."' and behavior_services_time = '".$time."'"; 
      $ssQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumnss))." FROM  $ssTable $sWhere";
    $qryd = $this->dbObj->query($ssQuery)->fetchAll();
if($j==date('d')) { 
$coden = $qryd[0]['behavior_services_code'];
 if($coden) {
       $codeC = "#867d70";
  }
 elseif($coden == "") {
  $codeC = "#fff";
 }
$html .='<td class="marborderrightclass"  style="background-color:'.$codeC.';color: #fff;">'; 
 if(empty($qryd[0]['behavior_services_code'])) {
       
   }
   else {
    if($qryd[0]['behavior_services_code'] !='counter') { 
      $html .= $qryd[0]['behavior_services_code'];
           }
      else { 
  $html .= $qryd[0]['bahavior_counter'];
   }
   }
$html .='</td>';
   } else { 
$coden = $qryd[0]['behavior_services_code'];
 if($coden) {
       $codeC = "#867d70";
  }
 elseif($coden == "") {
  $codeC = "#fff";
 }
 $html .='<td class="marborderrightclass"  style="background-color:'.$codeC.';color: #fff;">'; 
 if($qryd[0]['behavior_services_code'] !='counter') { 
 	 $html .= $qryd[0]['behavior_services_code']; 
     }
      else { 
          $html .= $qryd[0]['bahavior_counter'];
    }
   $html .='</td>';
            } 
      }
  $html .='</tr>';
if($supportdata['bahavior_shift_2'] != NULL) { 
  $html .='<tr><td class="marborderrightclass" style="width:7%;">  </td>';
   for($j=1;$j<=date('t');$j++){
                $date=date("Y")."-".date('m')."-".$j;
          
           if($j==date('d')){$tod='today_date_class';
                           }
              else{ $tod='';}
      $html .='<td class="marborderrightclass"> &nbsp; </td>';
                          }
  $html .='</tr>';
  } 
 } 


if($supportdata['bahavior_shift_2'] == '2') {   
$time = $supportdata['bahavior_shift_2'];
$html .='<tr><td class="marborderrightclass" style="width:7%;">'.$time.'</td>';
for($j=1;$j<=date('t');$j++){
                $date=date("Y")."-".date('m')."-".$j;
                 if($j < 10) {
                      $datedb =date("Y")."-".date('m')."-0".$j;
                 }
                 else {
                     $datedb =date("Y")."-".date('m')."-".$j;
                 }
          if($j==date('d')){$tod='today_date_class';
           } else{ $tod='';}
   $aColumnss = array('behavior_services_code' , 'bahavior_counter');
   $ssTable = '_uhs_behavior_support_services';
   $sWhere="where behavior_services_date='".$datedb."' and behavior_support_id = '".$supportdata['behavior_support_id']."' and behavior_services_time = '".$time."'"; 
      $ssQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumnss))." FROM  $ssTable $sWhere";
    $qryd = $this->dbObj->query($ssQuery)->fetchAll();
if($j==date('d')) { 
$coden = $qryd[0]['behavior_services_code'];
 if($coden) {
       $codeC = "#867d70";
  }
 elseif($coden == "") {
  $codeC = "#fff";
 }
$html .='<td class="marborderrightclass"  style="background-color:'.$codeC.';color: #fff;">'; 
 if(empty($qryd[0]['behavior_services_code'])) {
       
   }
   else {
    if($qryd[0]['behavior_services_code'] !='counter') { 
      $html .= $qryd[0]['behavior_services_code'];
           }
      else { 
  $html .= $qryd[0]['bahavior_counter'];
   }
   }
$html .='</td>';
   } else { 
$coden = $qryd[0]['behavior_services_code'];
 if($coden) {
       $codeC = "#867d70";
  }
 elseif($coden == "") {
  $codeC = "#fff";
 }
 $html .='<td class="marborderrightclass"  style="background-color:'.$codeC.';color: #fff;">'; 
 if($qryd[0]['behavior_services_code'] !='counter') { 
 	 $html .= $qryd[0]['behavior_services_code']; 
     }
      else { 
          $html .= $qryd[0]['bahavior_counter'];
    }
   $html .='</td>';
            } 
      }
  $html .='</tr>';
if($supportdata['bahavior_shift_3'] != NULL) { 
  $html .='<tr><td class="marborderrightclass" style="width:7%;">  </td>';
   for($j=1;$j<=date('t');$j++){
                $date=date("Y")."-".date('m')."-".$j;
          
           if($j==date('d')){$tod='today_date_class';
                           }
              else{ $tod='';}
      $html .='<td class="marborderrightclass"> &nbsp; </td>';
                          }
  $html .='</tr>';
  } 
 } 
 

if($supportdata['bahavior_shift_3'] == '3') { 

if($supportdata['bahavior_shift_2'] == NULL) { 

 $html .='<tr><td class="marborderrightclass" style="width:7%;">  </td>';
    for($j=1;$j<=date('t');$j++){
                $date=date("Y")."-".date('m')."-".$j;
          
          if($j==date('d')){$tod='today_date_class';
                        }
              else{ $tod='';}
     $html .='<td class="marborderrightclass"> &nbsp; </td>';
                    }
 $html .='</tr>';
  } 


$time = $supportdata['bahavior_shift_3'];
$html .='<tr><td class="marborderrightclass" style="width:7%;">'.$time.'</td>';
for($j=1;$j<=date('t');$j++){
                $date=date("Y")."-".date('m')."-".$j;
                 if($j < 10) {
                      $datedb =date("Y")."-".date('m')."-0".$j;
                 }
                 else {
                     $datedb =date("Y")."-".date('m')."-".$j;
                 }
          if($j==date('d')){$tod='today_date_class';
           } else{ $tod='';}
   $aColumnss = array('behavior_services_code' , 'bahavior_counter');
   $ssTable = '_uhs_behavior_support_services';
   $sWhere="where behavior_services_date='".$datedb."' and behavior_support_id = '".$supportdata['behavior_support_id']."' and behavior_services_time = '".$time."'"; 
      $ssQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumnss))." FROM  $ssTable $sWhere";
    $qryd = $this->dbObj->query($ssQuery)->fetchAll();
if($j==date('d')) { 
$coden = $qryd[0]['behavior_services_code'];
 if($coden) {
       $codeC = "#867d70";
  }
 elseif($coden == "") {
  $codeC = "#fff";
 }
$html .='<td class="marborderrightclass"  style="background-color:'.$codeC.';color: #fff;">'; 
 if(empty($qryd[0]['behavior_services_code'])) {
       
   }
   else {
    if($qryd[0]['behavior_services_code'] !='counter') { 
      $html .= $qryd[0]['behavior_services_code'];
           }
      else { 
  $html .= $qryd[0]['bahavior_counter'];
   }
   }
$html .='</td>';
   } else { 
$coden = $qryd[0]['behavior_services_code'];
 if($coden) {
       $codeC = "#867d70";
  }
 elseif($coden == "") {
  $codeC = "#fff";
 }
 $html .='<td class="marborderrightclass"  style="background-color:'.$codeC.';color: #fff;">'; 
 if($qryd[0]['behavior_services_code'] !='counter') { 
 	 $html .= $qryd[0]['behavior_services_code']; 
     }
      else { 
          $html .= $qryd[0]['bahavior_counter'];
    }
   $html .='</td>';
            } 
      }
  $html .='</tr>';
 } 


 $html .='</table></td>
                  </tr>
              </table></td>
          </tr>
          <tr class="'.$class.'">
            <td><table  width="100%" border="0" cellpadding="0" cellspacing="0" class="">
                <tbody>
                  <tr>
                    <td><table width="100%" border="0" cellpadding="0" cellspacing="0" class="">
                        <tr>
                          <td style="width:35%"></td>
                          <td style="width:65%"> &nbsp;  </td>
                        </tr>
                      </table></td>
                  </tr>
                </tbody>
              </table></td>
          </tr>
           <tr class="'.$class.'">
            <td style="height:15px;"></td>
           </tr>';
           }}       
          
           $html .='<tr>
            <td style="height:15px;"></td>
           </tr>
        </tbody>
     </table></div>
   </div>
   </div>
   <div class="clearfix">&nbsp;</div>
</div>
</div>';
         // die;

//$html .='<link href="http://localhost/xoomia/public/plugins/bootstrap/css/bootstrap.css" media="screen" rel="stylesheet" type="text/css" >';


$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		$this->view->permissions=$permissions;
		  if(empty($indid)){
			  $healthSession->errorMsg="Invalid Access";
			  $this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		  }
global $healthSession;
      if(!empty($html)){
			require_once ROOT_PATH.'/private/mpdf/mpdf.php';
			$mpdf=new mPDF('utf-8', 'A4-L');
			$stylesheet = file_get_contents(APPLICATION_URL.'/public/plugins/bootstrap/css/bootstrap.css');
			$mpdf->SetTitle('Behavoir Support Log');
			$mpdf->WriteHTML($stylesheet,1);
			$mpdf->WriteHTML($html,2);
			//$mpdf->Output('/home/xoomia/public_html/public/pdf/behavior.pdf','F'); 
			$mpdf->Output(); 
			//echo $html;
			die;

    if($this->getRequest()->isPost()){
	    $data = $this->getRequest()->getPost();
$recipients = $data['msg_to'];
$email_to = explode(',', $recipients);
$count = count($email_to);
 $mail = new Zend_Mail();
	$config = array('ssl' => 'tls',
  'port' => 587,'auth'=>'login','username'=>'test4rvtech@gmail.com','password'=>'RVtechtest#123');
	$transport = new Zend_Mail_Transport_Smtp('smtp.gmail.com', $config);
   
$Mc = 1;
foreach ($email_to as $toemail) {

    if($Mc >= $count) 
       {
	        $maildddd = str_replace(' ', '', $toemail);
			$mail = new Zend_Mail();
			$mail->setBodyHtml($data['msg_text']);
			$mail->setFrom($SenderEmail, $SenderName);
			$mail->addTo($maildddd,$ReceiverName);
			$mail->setSubject($data['msg_subject']);
			$content = file_get_contents("/home/xoomia/public_html/public/pdf/behavior.pdf"); 
			$attachment = new Zend_Mime_Part($content);
			$attachment->type = 'application/pdf';
			$attachment->disposition = Zend_Mime::DISPOSITION_ATTACHMENT;
			$attachment->encoding = Zend_Mime::ENCODING_BASE64;
			$attachment->filename = 'behavior.pdf'; // name of file
			$mail->addAttachment($attachment);                  
			$transport->send($mail);
			echo 'done';
	   }  
$Mc++;
}




      $healthSession->successMsg="Data has been email successfully";

	$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"view_behavoir_supports");

   	     }


			exit();
		}
}






	public function savesupportformAction(){
		global $healthSession;
		$data=$_POST;
		$this->dbObj = Zend_Registry::get('db');
		//$data['behavior_support_id'] = 1;
                if(empty($data['behavior_services_date'])){
                    $data['behavior_services_date'] = date('Y-m-d',time());
                } 
		
		$data['behavior_services_individual_id'] =  10;


if($data['bahavior_counter']) {
 if($data['bahavior_counter'] == 1) {
    $isIns=$this->SuperModel->Super_Insert("_uhs_behavior_support_services",$data);
        } else {
$sql = "UPDATE _uhs_behavior_support_services SET bahavior_counter = '".$data['bahavior_counter']."' where behavior_support_id = '".$data['behavior_support_id']."' and behavior_services_date= '".$data['behavior_services_date']."'";

      $qry = $this->dbObj->query($sql);
        }
  }
else {
	  $isIns=$this->SuperModel->Super_Insert("_uhs_behavior_support_services",$data);
}
   echo"<pre>"; print_r($isIns);die;
		if($isIns->success){
			echo "true";
		}else{
			echo "false";
		}
		die();
	}



// add IPS form 

	public function addispAction() {
		
		global $healthSession; 
		$this->view->pageHeading = "Add Individual Service Plan";
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
	    $this->dbObj = Zend_Registry::get('db');


$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);

	$agencyDataid = $this->dbObj->query("select * from _uhs_agency where agency_id =".$this->view->user->agency_id)->fetchAll();
    $agencyDataid[0]['agency_user_type'];
	if($agencyDataid[0]['agency_user_type'] == 'Staff') {
		$healthSession->errorMsg="You don't have permission to access this page.";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		exit;

	}

	if($permissions=="View Only"){
		$healthSession->errorMsg="You don't have permission to access this page.";
	}



		$this->view->permissions=$permissions;
		if(empty($indid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		$this->view->indid=$indid;
		$this->view->id=$id;
		$this->view->formid=$formid;

		if($this->getRequest()->isPost()){
			$ispcount = count($_FILES['load_isp']);
			for($i=0;$i<$ispcount;$i++){

				if(isset($_FILES['load_isp'][$i]) && !empty($_FILES['load_isp']['name'][$i])){
					
					$is_uploaded=$this->_handleprofile_image();
					$posted_data['load_isp']=$is_uploaded->media_path;	

					print_r($_FILES);
					die;
				}
			}


			$uploads_dir = '/home/xoomia/public_html/public/isp_data';

			foreach ($_FILES["load_isp"]["error"] as $key => $error) {
				if ($error == UPLOAD_ERR_OK) {
					$tmp_name = $_FILES["load_isp"]["tmp_name"][$key];
					$name = basename($_FILES["load_isp"]["name"][$key]);

					move_uploaded_file($tmp_name, "$uploads_dir/$name");

					$ispDatanew=array();
					
					$ext = pathinfo($_FILES['load_isp']['name'][$key], PATHINFO_EXTENSION);
					if ($ext=='docx' || $ext == 'doc'){
						$nameorg = $_FILES['load_isp']['name'][$key];
						$rename = (explode('.',$nameorg)[0]).'.pdf';
						
						$ispDatanew['load_isp']=$rename;
						$path1 = $uploads_dir.'/'.$nameorg;
						$path2 = $uploads_dir.'/'.$rename;
						$this->converter($path1,$path2);
					}else{
						$ispDatanew['load_isp']=$_FILES['load_isp']['name'][$key];
					}
					$ispDatanew['isp_start_date']=$_POST['isp_start_date'][$key];
					$ispDatanew['isp_end_date']=$_POST['isp_end_date'][$key];

					$indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
					$agencyData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indData['agency_user_agency_id']);

					$ispDatanew['isp_agency_id']=$agencyData['agency_id'];
					$ispDatanew['isp_individual_id']=$indid;
					$ispDatanew['isp_form_id']=$formid;
					$ispDatanew['isp_added_user']=$this->view->user->subuser_id;

					$a=$this->SuperModel->Super_Insert("_uhs_isp_log",$ispDatanew);
					var_dump($a);
					print_r($ispDatanew);
				}
			}

			$healthSession->successMsg="ISP log has been added successfully";

			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_read_isp");


		}


		$form=new Application_Form_CustomForms();
		$form->addipsform();
		$this->view->form = $form;

	}


// Read Ips Form
	
	public function readispAction() {

		error_reporting(1);
		global $healthSession; 
		$this->view->pageHeading = "Individual service plan - Read ISP";
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		$this->view->permissions=$permissions;
		if(empty($indid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}

		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('load_isp','isp_start_date','	isp_end_date');
		$sIndexColumn = 'isp_id';
		$sTable = '_uhs_isp_log';
		$sLimit = "";

		$sWhere.=" where isp_individual_id='".$indid."'"; 
		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
		$qry = $this->dbObj->query($sQuery)->fetchAll();

		$this->view->indid=$indid;
		$this->view->id=$id;
		$this->view->formid=$formid;
		$this->view->postdata=$qry;

	}

	public function getispAction(){
		if(check_is_ajax($this->_request)){
			$this->_redirect(APPLICATION_URL);
		}
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		




		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('isp_id','isp_form_id','isp_agency_id','isp_individual_id','isp_added_user','isp_added_date','isp_modified_by','load_isp','isp_start_date','isp_end_date');
		$sIndexColumn = 'isp_id';
		$sTable = '_uhs_isp_log';
		$sLimit = "";

		$sWhere.=" where isp_individual_id='".$indid."'"; 

		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";

		$qry = $this->dbObj->query($sQuery)->fetchAll();

		$sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
		$output = array(
			"iTotalRecords" => $iTotal,
			"iTotalDisplayRecords" => $iFilteredTotal,
			"aaData" => array()
			);
		$j=0;

		$agencydata = $this->SuperModel->Super_Get("_uhs_agency","agency_id='".$this->view->user->agency_id."'","fetch");
		$userlogintype = $agencydata['agency_user_type'];


		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		foreach($qry as $row1){

			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['isp_added_user']."'","fetch");
			$modifierData=array();


			$row=array();
			$row[] = $j+1;

			$row[]='<input class="elem_ids checkboxes" type="checkbox" name="records['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';


			$row[]= 'From '.$row1['isp_start_date'] .' To '.$row1['isp_end_date'];

			$userType=printUserType($creatorData); 

			$row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;

			$row[]=formatDateTimeNew($row1['isp_added_date']);

			/*	$row[] = '<a class="btn btn-primary view-pdf red" href="https://docs.google.com/gview?url=http://122.180.254.6/server2/xoomia/public/isp_data/'.$row1['load_isp'].'&embedded=true"> Read ISP</a>';*/


			$url =  APPLICATION_URL."/single-isp-read/".$indid."/".$row1['isp_id'];

			$urledit =  APPLICATION_URL."/single-edit-isp/".$indid."/".$row1['isp_id'];

		      $isplog =  APPLICATION_URL."/read-isp-log/".$indid."/".$row1['isp_id'];

//	$row[] = '<a class="btn btn-xs btn-default" href="'.$url.'"> Read ISP</a><a class="btn btn-xs btn-default" href="'.$urledit.'"> Edit ISP</a><a class="btn btn-xs btn-default" href="'.$isplog.'"> ISP Log</a>';

    if ($userlogintype == 'Staff' || $userlogintype == 'Guardians' || $userlogintype == 'SupportAdministrators' || $userlogintype == 'HealthcareProfessional'){
				$row[] = '<a class="btn btn-xs btn-default popup" onclick="popup('.$indid.','.$row1['isp_id'].')"  href="#"> Read ISP </a>';
			}else{
				$row[] = '<a class="btn btn-xs btn-default popup" onclick="popup('.$indid.','.$row1['isp_id'].')"  href="#"> Read ISP</a><a class="btn btn-xs btn-default" href="'.$urledit.'"> Edit ISP</a><a class="btn btn-xs btn-default" href="'.$isplog.'"> ISP Log</a>';		
			}


			$output['aaData'][] = $row;
			$j++;
		}
		echo json_encode($output);
		exit();
	}

	
	function readsingleispAction()
	{
		//return 'ok';
		
		error_reporting(1);
		global $healthSession; 
		$this->view->pageHeading = " Individual Service Plan for";
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		$this->view->permissions=$permissions;
		if(empty($indid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}

		$this->dbObj = Zend_Registry::get('db');
		$agencyDataid = $this->dbObj->query("select * from _uhs_agency where agency_id =".$indid)->fetchAll();

		$agencyData = $this->dbObj->query("select * from _uhs_agency where agency_id =".$agencyDataid[0]['agency_user_agency_id'])->fetchAll();

		$fordata = $agencyDataid[0]['agency_first_name']." ".$agencyDataid[0]['agency_last_name'];

		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('load_isp','isp_start_date','	isp_end_date');
		$sIndexColumn = 'isp_id';
		$sTable = '_uhs_isp_log';
		$sLimit = "";

		$sWhere.=" where isp_id='".$formid."'"; 

		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
		$qry = $this->dbObj->query($sQuery)->fetchAll();
                
                // staff once time acknowledgement save for form DD 100.
                
                $this->view->acknowledgementCheck = 1;
                if($this->view->user->agency_user_type == "Staff") {
                    $this->dbObj = Zend_Registry::get('db');
                    $isReadIspId = $this->dbObj->query("select _uhs_isp_read_log.read_isp_id, _uhs_isp_log.isp_form_id from _uhs_isp_read_log join _uhs_isp_log on _uhs_isp_read_log.isp_id = _uhs_isp_log.isp_id where _uhs_isp_read_log.isp_agency_user_type = 'Staff' and _uhs_isp_read_log.isp_id = '".$formid."'")->fetchAll();
                    if(!empty($isReadIspId)) {
                        $ismatchFormId = $this->dbObj->query("select form_id from _uhs_agency_forms where form_id = '".$isReadIspId[0]['isp_form_id']."' and form_number = 'DD 100'")->fetchAll();
                        if(!empty($ismatchFormId)) {
                            $this->view->acknowledgementCheck = 0;
                        }
                    }
                }
                
		if($this->getRequest()->isPost()){
		
			if($_POST['readisp'] == 'yes') {
          
	  $ispDatanew = array();

      $ispDatanew['isp_id']= $formid;
      $ispDatanew['isp_added_name']= $_POST['agency_name'];
      $ispDatanew['isp_for']= $_POST['isp_for'];
     
      if($this->view->user->agency_user_type == "Staff") {
        $ispDatanew['isp_agency_user_type']= $this->view->user->agency_user_type;
      }
      
      $a=$this->SuperModel->Super_Insert("_uhs_isp_read_log",$ispDatanew);
      var_dump($a);


		$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_read_isp");


			}

		}

		$userArr=array("agency_name"=>$this->view->user->agency_first_name." ".$this->view->user->agency_last_name,"provider_name"=>$this->view->user->agency_company_name,"agency_email"=>$this->view->user->agency_email);	
		
		$ext_flag=1;
		$ispDatanew=array();
		
		$ext = pathinfo($qry[0]['load_isp'], PATHINFO_EXTENSION);
		if ($ext=='docx' || $ext == 'doc'){
			$base_url =  $_SERVER['DOCUMENT_ROOT'];
			$uploads_dir = $base_url.'/public/isp_data';
			
			$nameorg =$qry[0]['load_isp'];
			$rename = (explode('.',$qry[0]['load_isp'])[0]).'.pdf';
			$ispDatanew['load_isp']=$rename;
			
			$path1 = $uploads_dir.'/'.$nameorg;
			$path2 = $uploads_dir.'/'.$rename;
			$this->converter($path1,$path2);
			$filename = $rename;
			
			$this->SuperModel->Super_Insert("_uhs_isp_log",$ispDatanew,"isp_id=".$formid);
		}else{
			$filename = $qry[0]['load_isp'];
		}
		
		if($ext == 'jpg' || $ext == 'jpeg' || $ext == 'png') {
		$ext_flag=2;
		}
		
		$data = [
			'id' => $formid,
			'name' => $userArr['agency_name'],
			'email' => $userArr['agency_email'],
			'ack' =>  $this->view->acknowledgementCheck,
			'image' => $filename,
			'ips' => $fordata,
			'indid' => $indid,
			'APPLICATION_URL' => APPLICATION_URL,
			'ext_flag' => $ext_flag,
            'fordata' => $fordata,
];

echo json_encode($data);
exit;

		

	}

	
	
	function editispAction() {
		global $healthSession; 
		$this->view->pageHeading = "Edit Individual Service Plan";
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");

		
	    $this->dbObj = Zend_Registry::get('db');


$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);

	$agencyDataid = $this->dbObj->query("select * from _uhs_agency where agency_id =".$this->view->user->agency_id)->fetchAll();
    $agencyDataid[0]['agency_user_type'];
	if($agencyDataid[0]['agency_user_type'] == 'Staff') {
		$healthSession->errorMsg="You don't have permission to access this page.";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		exit;

	}

	if($permissions=="View Only"){
		$healthSession->errorMsg="You don't have permission to access this page.";
		$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
	}


		$this->view->permissions=$permissions;
		if(empty($indid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		$this->view->indid=$indid;
		$this->view->id=$id;
		$this->view->formid=$formid;

		if($this->getRequest()->isPost()){
			$ispcount = count($_FILES['load_isp']);
                        
			for($i=0;$i<$ispcount;$i++){

				if(isset($_FILES['load_isp'][$i]) && !empty($_FILES['load_isp']['name'][$i])){
					
					$is_uploaded=$this->_handleprofile_image();
					$posted_data['load_isp']=$is_uploaded->media_path;	

					print_r($_FILES);
					die;
				}
			}

			$uploads_dir = '/home/xoomia/public_html/public/isp_data';
			//$base_url =  $_SERVER['DOCUMENT_ROOT'];
			//$uploads_dir = $base_url.'/public/isp_data';
              foreach ($_FILES["load_isp"]["error"] as $key => $error) {
				if ($error == UPLOAD_ERR_OK) {
					$tmp_name = $_FILES["load_isp"]["tmp_name"][$key];
					$name = basename($_FILES["load_isp"]["name"][$key]);
                                        //prd($uploads_dir);
					move_uploaded_file($tmp_name, "$uploads_dir/$name");

					$ispDatanew=array();
					$ext = pathinfo($_FILES['load_isp']['name'][$key], PATHINFO_EXTENSION);
					if ($ext=='docx' || $ext == 'doc'){
						$nameorg = $_FILES['load_isp']['name'][$key];
						$rename = (explode('.',$nameorg)[0]).'.pdf';
						
						$ispDatanew['load_isp']=$rename;
						$path1 = $uploads_dir.'/'.$nameorg;
						$path2 = $uploads_dir.'/'.$rename;
						$this->converter($path1,$path2);
					}else{
						$ispDatanew['load_isp']=$_FILES['load_isp']['name'][$key];
					}
					
					
					$ispDatanew['isp_start_date']=$_POST['isp_start_date'][$key];
					$ispDatanew['isp_end_date']=$_POST['isp_end_date'][$key];

					$indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
					$agencyData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indData['agency_user_agency_id']);

					$ispDatanew['isp_agency_id']=$agencyData['agency_id'];
					$ispDatanew['isp_individual_id']=$indid;
					$ispDatanew['isp_form_id']=$formid;
					$ispDatanew['isp_added_user']=$this->view->user->subuser_id;

	//$a=$this->SuperModel->Super_Insert("_uhs_isp_log",$ispDatanew);

	$$a=$this->SuperModel->Super_Insert("_uhs_isp_log",$ispDatanew,"isp_id=".$formid);

					var_dump($a);
					print_r($ispDatanew);
				}
			}

			$healthSession->successMsg="ISP log has been updated successfully";
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_read_isp");

		}


		$form=new Application_Form_CustomForms();
		$form->addipsform();
		$this->view->form = $form;

		$taskData=$this->SuperModel->Super_Get("_uhs_isp_log","isp_id=".$formid,"fetch");
		$form->populate($taskData);
		
		
		$ext_flag=1;
		$ext = pathinfo($taskData["load_isp"], PATHINFO_EXTENSION);
		if($ext == 'jpg' || $ext == 'jpeg' || $ext == 'png') {
			$ext_flag=2;
		}
		$this->view->load_isp = $taskData["load_isp"];
		$this->view->ext_flag = $ext_flag;
		



	}

	public function removeisplogsAction() {
		
		global $healthSession;
		$indid=$this->_getParam('indid');
		$formid=$this->_getParam('formid');
		$this->_helper->layout->disableLayout();
		$this->_helper->viewRenderer->setNoRender(true);
		$formData = $this->getRequest()->getPost();
		if(isset($formData['records']) && count($formData['records'])) {
			foreach($formData['records'] as $key=>$values){
				$isDel=$this->SuperModel->Super_Delete('_uhs_isp_log',"isp_id=".$values);
				$healthSession->successMsg=" Isp Log(s) has been deleted successfully.";
			}
		}
		else{
			$healthSession->errorMsg = "Invalid Request.";
		}
		$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_read_isp");


	}

	
public function readisplogAction() {

  		error_reporting(1);
		global $healthSession; 
  		$this->view->pageHeading = "Individual service plan";
		 $indid=$this->_getParam("indid");
		 $formid=$this->_getParam("formid");
		 $id=$this->_getParam("id");
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		$this->view->permissions=$permissions;
		if(empty($indid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}

  $this->dbObj = Zend_Registry::get('db');
	$aColumns = array('isp_added_name','isp_for','isp_added_on', 'read_isp_id');
		$sIndexColumn = 'read_isp_id';
		$sTable = '_uhs_isp_read_log';
		$sLimit = "";

		$sWhere.=" where isp_id='".$formid."'"; 
		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
 		$qry = $this->dbObj->query($sQuery)->fetchAll();
		
		 $this->view->indid=$indid;
		 $this->view->id=$id;
		 $this->view->formid=$formid;
		 $this->view->postdata=$qry;
		 $this->view->indual_name=$qry[0]['isp_for'];

}

// 21-feb-2018  
  public function incidentreportAction(){
	  global $healthSession; 
	  
		if($this->view->user->agency_user_type!="Agency"){
			$healthSession->errorMsg="You don't have permission to access this page.";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		
			$this->view->pageHeading="Incident Report Log";	
	}
	
  public function getincidentreportAction(){
	        $currentmonth=date('m'); 
	        $currentyear=date('Y');
	  		$subuser=$dstarts=$dends=$county="";
		if(isset($_REQUEST['subuser']) && !empty($_REQUEST['subuser'])){
			$subuser=$_REQUEST['subuser'];
		}
		if(isset($_REQUEST['county']) && !empty($_REQUEST['county'])){
			$county=$_REQUEST['county'];
		}
		if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
			$month=$_REQUEST['month'];
		}
		if(isset($_REQUEST['year']) && !empty($_REQUEST['year'])){
			$year=$_REQUEST['year'];
		}
		if(isset($_REQUEST['dstarts']) && !empty($_REQUEST['dstarts'])){
			$dstarts=$_REQUEST['dstarts'];
		}
		if(isset($_REQUEST['dends']) && !empty($_REQUEST['dends'])){
			$dends=$_REQUEST['dends'];
		}

 		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('incident_id','incident_individual_id','is_included_claims','incident_form_id','incident_added_user','incident_tracking_number','incident_date','incident_location','report_created_on','is_report_completed','incident_modified_by','incident_modified_on');
		$sIndexColumn = 'incident_id';
		$sTable = '_uhs_incidents_reports';
		$sLimit = "";
		if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' ){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		if(isset($_GET['iSortCol_0'])){
			$sOrder = "ORDER BY  ";
			for($i=0;$i<intval( $_GET['iSortingCols']);$i++){
				if($_GET['bSortable_'.intval($_GET['iSortCol_'.$i])]=="true"){
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
		
		$indParentUsers="";
			if($this->view->user->agency_user_type=="Agency"){
				$systemUsers=$this->SuperModel->Get_AllIndividuals($this->view->user->agency_id);
			    foreach($systemUsers as $sysusers){
					$system .= $sysusers['agency_id'].',';
				}
				$indParentUsers=rtrim($system,',');
				
			}
			else{
				$indParentUsers=$this->view->user->agency_id;
			}
			if($sWhere){
				$sWhere.=" and incident_individual_id IN(".$indParentUsers.")"; 
			}
			else{
				if(!empty($dstarts) || !empty($dends) || !empty($month) || !empty($year) || !empty($county)){
					$sWhere.=" where incident_individual_id IN(".$indParentUsers.")"; 
				}else{
				   $sWhere.=" where incident_individual_id IN(".$indParentUsers.") and MONTH(incident_date)='".$currentmonth."' and YEAR(incident_date)='".$currentyear."'"; 
			     }
			}
	    if(!empty($dstarts)){
			$sWhere.=" and DATE(incident_date) >='".$dstarts."'";
		}
		if(!empty($dends)){
			$sWhere.=" and DATE(incident_date) <='".$dends."'";
		}
		
		if(!empty($month)){
			$sWhere.=" and MONTH(incident_date)='".$month."'";
		}
		if(!empty($year)){
			$sWhere.=" and YEAR(incident_date)='".$year."'";
		}
		if(!empty($county)){
			$systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_county='".$county."'","fetchAll",array("fields"=>"agency_id"));
			if(count($systemUsers) > 0){
				$indParentUsers=implode_r(",",$systemUsers);
				$sWhere.=" and 	incident_individual_id IN(".$indParentUsers.")"; 
			}
		}
		
		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
 		$qry = $this->dbObj->query($sQuery)->fetchAll();
		$sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
		$output = array(
 				"iTotalRecords" => $iTotal,
				"iTotalDisplayRecords" => $iFilteredTotal,
				"aaData" => array()
			);
		$j=0;
		if(!empty($qry)){
			$dataArr=array("new_record"=>"1");
			$isUpdate=$this->SuperModel->Super_Insert("_uhs_incidents_reports",$dataArr,"new_record='0' and incident_individual_id IN(".$indParentUsers.")");
		}
		foreach($qry as $row1){	
			$modifierData=array();
			if($row1['incident_modified_by']!=0){
				$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$row1['incident_modified_by']);
			}
			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['incident_added_user']."'" ,"fetch");
			$indivData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['incident_individual_id']."'" ,"fetch");					
			$row=array();
 			$row[] = $j+1;
			$row[]='<input class="elem_ids checkboxes" type="checkbox"  name="records['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'" form_id="'.$row1['incident_form_id'].'" indiv_id="'.$row1['incident_individual_id'].'">';
		    $row[]=$row1['incident_tracking_number']; 
		    $row[]=ucwords($indivData['agency_first_name']." ".$indivData['agency_last_name']);
			$row[]=formatDate($row1['incident_date']);		
			$row[]=ucwords($row1['incident_location']);
			$userType=printUserType($creatorData); 
  			$row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."&nbsp;".$userType;
			$row[]=formatDate($row1['report_created_on']);	
			
			$emailLink="";
			$toggle="";
			$claimData = unserialize($row1['is_included_claims']);
			$isIncludedClaim = count(unserialize($row1['is_included_claims']));
			
			
			$status = $abc==1?"checked='checked'":" ";
			if($isIncludedClaim == 2 || $claimData[0]== "MUI"){	
				$abc = 1;
				$status = $abc==1?"checked='checked'":" ";
				$toggle='<div class="danger-toggle-button"><input type="checkbox" class="incident-toggle status-mui "  '.$status.'  id="'.$sTable.'-'.$row1[$sIndexColumn].'" /></div>';  
			}
			if($claimData[0]== "UI"){
				$abc = 0;
				$status = $abc==1?"checked='checked'":" ";
				$toggle='<div class="danger-toggle-button"><input type="checkbox" class="incident-toggle status-ui "  '.$status.'  id="'.$sTable.'-'.$row1[$sIndexColumn].'" /></div>';  
			}
			
			if($this->view->user->agency_user_type=="Agency"){
				$emailLink="<a href='javascript:void(1);' style='margin-top:5px;' onclick='emailIncident(".$row1['incident_individual_id'].",".$row1['incident_form_id'].",".$row1['incident_id'].");' class='btn btn-xs btn-default'>Email form</a>";
			}
			$editLink=$viewLink="";
		//	if($row1['is_report_completed']=='0'){
				$editLink="<a style='margin-top:5px; margin-left:5px;' href='".APPLICATION_URL."/edit-incident-report/".$row1['incident_individual_id']."/".$row1['incident_form_id']."/".$row1['incident_id']."' class='btn btn-xs btn-default'>Edit</a>&nbsp;";
		//	}
		//	else{
				$viewLink="<a style='margin-top:5px; margin-left:5px;' href='".APPLICATION_URL."/view-incident-report/".$row1['incident_individual_id']."/".$row1['incident_form_id']."/".$row1['incident_id']."' class='btn btn-xs btn-default'>View</a>&nbsp;";
		//	}
						
			if(!isFormAssigned($row1['incident_form_id'],$row1['incident_individual_id'])){
				$row[]=$toggle.$editLink.$viewLink.$emailLink;
			}
			else{
				$row[]=$viewLink;
			}
			if(!empty($modifierData)){
				$userType=printUserType($modifierData);
				$row[]=ucwords($modifierData['agency_first_name']." ".$modifierData['agency_last_name'])."&nbsp;".$userType;
				$row[]=formatDateTime($row1['incident_modified_on']);
			}
			else{
				$row[]="-";
				$row[]="-";
			}
 			$output['aaData'][] = $row;
			$j++;
		}
		echo json_encode($output);
		exit();
	}
	
	function converter($orgfile,$confile){
	//echo "test";exit;
$endpoint = "https://sandbox.zamzar.com/v1/jobs";
$apiKey = "e6243f20788114565800b4813b1d9fddf35b0276";
$sourceFilePath = $orgfile;
$targetFormat = "pdf";

// Since PHP 5.5+ CURLFile is the preferred method for uploading files
if(function_exists('curl_file_create')) {
  $sourceFile = curl_file_create($sourceFilePath);
} else {
  $sourceFile = '@' . realpath($sourceFilePath);
}

$postData = array(
  "source_file" => $sourceFile,
  "target_format" => $targetFormat
);

$ch = curl_init(); // Init curl
curl_setopt($ch, CURLOPT_URL, $endpoint); // API endpoint
curl_setopt($ch, CURLOPT_CUSTOMREQUEST, 'POST');
curl_setopt($ch, CURLOPT_POSTFIELDS, $postData);
curl_setopt($ch, CURLOPT_SAFE_UPLOAD, false); // Enable the @ prefix for uploading files
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true); // Return response as a string
curl_setopt($ch, CURLOPT_USERPWD, $apiKey . ":"); // Set the API key as the basic auth username
$body = curl_exec($ch);
curl_close($ch);

$response = json_decode($body, true);


$jobid = $response['id'];

$this->checkstatus($jobid ,$confile);

	}

 function checkstatus($id,$confile){
$renamefile = $confile;
$jobID = $id;
$endpoint = "https://sandbox.zamzar.com/v1/jobs/$jobID";
$apiKey = "e6243f20788114565800b4813b1d9fddf35b0276";
$ch = curl_init(); // Init curl
curl_setopt($ch, CURLOPT_URL, $endpoint); // API endpoint
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true); // Return response as a string
curl_setopt($ch, CURLOPT_USERPWD, $apiKey . ":"); // Set the API key as the basic auth username
$body = curl_exec($ch);
curl_close($ch);
$job = json_decode($body, true);
$status = $job['status'];

if($status == 'successful'){
	$this->downloadpdf($job['target_files'][0]['id'],$renamefile);
}else{
	$this->checkstatus($jobID,$renamefile);
}

}

 function downloadpdf($id,$renamefile){
	
$fileID = $id;
$localFilename = $renamefile;
$endpoint = "https://sandbox.zamzar.com/v1/files/$fileID/content";
$apiKey = "e6243f20788114565800b4813b1d9fddf35b0276";

$ch = curl_init(); // Init curl
curl_setopt($ch, CURLOPT_URL, $endpoint); // API endpoint
curl_setopt($ch, CURLOPT_USERPWD, $apiKey . ":"); // Set the API key as the basic auth username
curl_setopt($ch, CURLOPT_FOLLOWLOCATION, TRUE);

$fh = fopen($localFilename, "wb");
curl_setopt($ch, CURLOPT_FILE, $fh);

$body = curl_exec($ch);
curl_close($ch);

//echo "File downloaded";
	
}

public function addnewmileageAction(){
        
        global $healthSession;
        $type=$this->_getParam("type");
        $formid=$this->_getParam("formid");
        $indid=$this->_getParam("indid");
        $id=$this->_getParam("id");
        
        if(empty($indid)){
            $healthSession->errorMsg="Invalid Access";
            $this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
        }
        $form=new Application_Form_CustomForms();
        $headingText="Add";
        $document="";
        if(empty($id)){
            $id="";
        }
        if(!empty($id)){
            $headingText="Edit";
        }
        $headingText.=" Mileage Log";
        $form->Mileage($indid,$formid,$id);
        if(!empty($id)){
            $logData=$this->SuperModel->Super_Get("_uhs_mileage_logs","mlog_id=".$id,"fetch");
            if(!empty($logData)){
                unset($logData['mlog_remaining_mileage']);
                $logData['mlog_service_date']=date('m/d/Y',strtotime($logData['mlog_service_date']));
                if($logData['mlog_choose_one'] == 0){
                    $logData['mlog_choose_one'] = 1;
                }
                $form->populate($logData);
            }
        }
        $this->view->pageHeading=$headingText;
        $this->view->form=$form;		
        $this->view->id=$id;
        $this->view->indid=$indid;
        $this->view->formid=$formid;
    }
    public function addinitialmileageAction(){
        
        global $healthSession;
        $type=$this->_getParam("type");
        $formid=$this->_getParam("formid");
        $indid=$this->_getParam("indid");
        $id=$this->_getParam("id");
        
        if(empty($indid)){
            $healthSession->errorMsg="Invalid Access";
            $this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
        }
        $form=new Application_Form_CustomForms();
        $headingText="Add Mileage";
        $document="";
         $form->assignedMileage($indid,$formid,$id,$type);
        if(empty($id)){
            $id="";
        }
        if(!empty($id)){
            $headingText="Edit Mileage";
            $logData=$this->SuperModel->Super_Get("_uhs_assigned_miles","mid=".$id,"fetch");
            if(!empty($logData)){
                    $form->populate($logData);
            }
        }
       
        $this->view->pageHeading=$headingText;
        $this->view->form=$form;		
        $this->view->id=$id;	
        $this->view->indid=$indid;
        $this->view->url=APPLICATION_URL.'/save-assigned-mileage/'.$indid.'/'.$formid.'/'.$id;
    }

    // START Outcome
    public function outcomeaddAction() {
        
        
        global $healthSession;

        $indid = $this->_getParam("indid");
        $formid = $this->_getParam("formid");

        if (isset($_POST['bttnsubmit'])) {
            $action_step_raw = $_POST['oc_action_step'];
            $action_step_counter = 0;
            foreach ($action_step_raw as $raw_data) {
                if ($raw_data == '') {
                    $action_step_counter++;
                    continue;
                }
                $acstp[$action_step_counter][] = $raw_data;
            }
            $_POST['oc_action_step'] = $acstp;
            //echo"<pre>";print_r($_POST);die();
            foreach ($_POST['oc_description'] as $key => $value) {
                $data['oc_description'] = $_POST['oc_description'][$key];

                $data['oc_action_step'] = json_encode($_POST['oc_action_step'][$key]);
                $data['oc_frequency'] = $_POST['oc_frequency'][$key];
                $data['other_frequency_detail'] = $_POST['other_frequency_detail'][$key];
                // $data['shift'][0] 	=  	$_POST['shift'][$key];
                $data_shift[0] = isset($_POST['shift1'][$key]) ? $_POST['shift1'][$key] : "";
                $data_shift[1] = isset($_POST['shift2'][$key]) ? $_POST['shift2'][$key] : "";
                $data_shift[2] = isset($_POST['shift3'][$key]) ? $_POST['shift3'][$key] : "";
                $data_shift[3] = isset($_POST['shift4'][$key]) ? $_POST['shift4'][$key] : "";
                //$result = array_filter($data_shift);
                $data['oc_shift'] = json_encode($data_shift);

                $oc_completed_by = $_POST['oc_completed_by'][$key];
                //$oc_completed_by = implode(", ", $oc_completed_by);
                $data['oc_completed_by'] = $oc_completed_by;

                $user_id = $_SESSION['UHS_AUTH']['storage']->agency_id;
                $data['created_by'] = $user_id;

                $data['indid'] = $indid;
                $data['formid'] = $formid;

                $data['modified_at'] = date("Y-m-d H:i:s");

                $isIns = $this->SuperModel->Super_Insert("_uhs_outcome_form", $data);
                //echo '<pre>';
                //print_r($data);die;

                if ($isIns->success) {
                    $healthSession->successMsg = "Outcome has been added successfully";
                } else {
                    $healthSession->errorMsg = "Oops! error occured while adding outcome";
                }

                
            }
            $this->_helper->getHelper("Redirector")->gotoRoute(array("indid" => $indid, "formid" => $formid), "add_outcome_form");
        }
        $this->view->pageHeading = "Create Outcome";
        $indid = $this->_getParam("indid");
        $formid = $this->_getParam("formid");
        $id = $this->_getParam("id");
        $permissions = checkPermissions("individual", $indid, $this->view->user->agency_id);
        $this->view->permissions = $permissions;
        if (empty($indid)) {
            $healthSession->errorMsg = "Invalid Access";
            $this->_helper->getHelper("Redirector")->gotoRoute(array(), "front_agency_dashboard");
        }
        $this->view->indid = $indid;
        $this->view->id = $id;
        $this->view->formid = $formid;

        $indi_data = $this->SuperModel->Super_Get("_uhs_agency", "agency_id=" . $indid, "fetch");
        $this->view->indi_data = $indi_data;
        $indi_parent_data = $this->SuperModel->Super_get("_uhs_agency", "agency_id='" . $indi_data['agency_user_agency_id'] . "'", 'fetch');
        $this->view->indi_parent_data = $indi_parent_data;
    }

    public function sendmailAction() {
        $subject = "Test mail";
        $to_email = "sanjay@rvtechnologies.co.in";
        $to_fullname = "John Doe";
        $from_email = "from@example.com";
        $from_fullname = "Jane Doe";
        $headers = "MIME-Version: 1.0\r\n";
        $headers .= "Content-type: text/html; charset=utf-8\r\n";
        // Additional headers
        // This might look redundant but some services REALLY favor it being there.
        $headers .= "To: $to_fullname <$to_email>\r\n";
        $headers .= "From: $from_fullname <$from_email>\r\n";
        $message = "<html xmlns=\"http://www.w3.org/1999/xhtml\" lang=\"en\" xml:lang=\"en\">\r\n
  <head>\r\n
    <title>Hello Test</title>\r\n
  </head>\r\n
  <body>\r\n
    <p></p>\r\n
    <p style=\"color: #00CC66; font-weight:600; font-style: italic; font-size:14px; float:left; margin-left:7px;\">You have received an inquiry from your website.  Please review the contact information below.</p>\r\n
  </body>\r\n
  </html>";
        if (!mail($to_email, $subject, $message, $headers)) {
            print_r(error_get_last());
        } else {
            echo 'thanks';
        }die;
    }

    public function outcomeupdateAction() {
        global $healthSession;

        $indid = $this->_getParam("indid");
        $formid = $this->_getParam("formid");
        
        $editid = $this->_getParam("id");

        $previous_url = $_SERVER['HTTP_REFERER'];

        if (strpos($previous_url, "outcome-log")) {
            $previous_url = "outcome-log";
        } elseif (strpos($previous_url, "add-outcome-form")) {
            $previous_url = "add-outcome-form";
        }

        if (isset($_POST['bttnsubmit'])) {
            $action_step_raw = $_POST['oc_action_step'];
            $action_step_counter = 0;
            foreach ($action_step_raw as $raw_data) {
                if ($raw_data == '') {
                    $action_step_counter++;
                    continue;
                }
                $acstp[$action_step_counter][] = $raw_data;
            }
            $_POST['oc_action_step'] = $acstp;
            //echo"<pre>";print_r($_POST);die();
            foreach ($_POST['oc_description'] as $key => $value) {
                $data['oc_description'] = $_POST['oc_description'][$key];

                $data['oc_action_step'] = json_encode($_POST['oc_action_step'][$key]);
                $data['oc_frequency'] = $_POST['oc_frequency'][$key];
                $data['other_frequency_detail'] = $_POST['other_frequency_detail'];
                // $data['shift'][0] 	=  	$_POST['shift'][$key];
                $data_shift[0] = isset($_POST['shift1'][$key]) ? $_POST['shift1'][$key] : "";
                $data_shift[1] = isset($_POST['shift2'][$key]) ? $_POST['shift2'][$key] : "";
                $data_shift[2] = isset($_POST['shift3'][$key]) ? $_POST['shift3'][$key] : "";
                $data_shift[3] = isset($_POST['shift4'][$key]) ? $_POST['shift4'][$key] : "";
                //$result = array_filter($data_shift);
                $data['oc_shift'] = json_encode($data_shift);

                $oc_completed_by = $_POST['oc_completed_by'];
                $oc_completed_by = implode(", ", $oc_completed_by);
                $data['oc_completed_by'] = $oc_completed_by;

                $user_id = $_SESSION['UHS_AUTH']['storage']->agency_id;
                $data['created_by'] = $user_id;

                $data['indid'] = $indid;
                $data['formid'] = $formid;


                $data['modified_at'] = date("Y-m-d H:i:s");
                $data['modified_by'] = $_SESSION['UHS_AUTH']['storage']->agency_id;
                $data['modified_on'] = date("Y-m-d H:i:s");
                
                $isIns = $this->SuperModel->Super_Insert("_uhs_outcome_form", $data, "oc_id = $editid");
                //echo '<pre>';
                //print_r($data);die;

                if ($isIns->success) {
                    $healthSession->successMsg = "Outcome has been updated successfully";
                } else {
                    $healthSession->errorMsg = "Oops! error occured while adding outcome";
                }
                $previous_url = $_POST['previous_url'];

                if ($previous_url == "outcome-log") {
                    $this->_helper->getHelper("Redirector")->gotoRoute(array("indid" => $indid, "formid" => $formid), "outcome_log");
                } elseif ($previous_url == "add-outcome-form") {
                    $this->_helper->getHelper("Redirector")->gotoRoute(array("indid" => $indid, "formid" => $formid), "add_outcome_form");
                }

                //$this->_helper->getHelper("Redirector")->gotoRoute(array(), "add_outcome");
            }
        }

        $outcome_data = $this->SuperModel->Super_Get("_uhs_outcome_form", "oc_id=" . $editid, "fetch");
        $this->view->oc_frequency = $outcome_data['oc_frequency'];
        $this->view->other_frequency_detail = $outcome_data['other_frequency_detail'];
        
        $outcome_data['oc_action_step'] = json_decode($outcome_data['oc_action_step'], TRUE);
        $outcome_data['oc_completed_by'] = explode(",", $outcome_data['oc_completed_by']);

        foreach ($outcome_data['oc_completed_by'] as $key => $value) {
            $outcome_data['oc_completed_by'][$key] = trim($value);
        }

        $this->view->pageHeading = "Edit Outcome";

        $this->view->outcome_data = $outcome_data;
        $this->view->indid = $indid;
        $this->view->editid = $editid;
        $this->view->formid = $formid;
        $this->view->previous_url = $previous_url;
        
    }

    public function outcomelogcurrentmonthAction() {
        global $healthSession;
        $indid = $this->_getParam("indid");
        $formid = $this->_getParam("formid");
        $this->view->indid = $indid;
        $this->view->formid = $formid;
        $this->view->type = "Care";
        $this->view->pageHeading = "Outcome";
    }

    public function getoutcomeAction() {
        if (check_is_ajax($this->_request)) {
            $this->_redirect(APPLICATION_URL);
        }
        $indid = $this->_getParam("indid");
        $formid = $this->_getParam("formid");
        $type = $this->_getParam("type");
        $this->dbObj = Zend_Registry::get('db');
        $aColumns = array('support_frequency', 'support_description', 'support_added_date', 'support_other_frequency', 'support_group_size', 'support_added_by', 'support_modified_by', 'support_modified_on');
        $sIndexColumn = 'support_id';
        $sTable = '_uhs_supports';
        $sLimit = "";
        if (isset($_GET['iDisplayStart']) && $_GET['iDisplayLength'] != '-1') {
            $sLimit = "LIMIT " . intval($_GET['iDisplayStart']) . ", " . intval($_GET['iDisplayLength']);
        }
        $sOrder = "";
        if (isset($_GET['iSortCol_0'])) {
            $sOrder = "ORDER BY  ";
            for ($i = 0; $i < intval($_GET['iSortingCols']); $i++) {
                if ($_GET['bSortable_' . intval($_GET['iSortCol_' . $i])] == "true") {
                    $sOrder .= "" . $aColumns[intval($_GET['iSortCol_' . $i])] . " " .
                            ($_GET['sSortDir_' . $i] === 'asc' ? 'asc' : 'desc') . ", ";
                }
            }

            $sOrder = substr_replace($sOrder, "", -2);
            if ($sOrder == "ORDER BY") {
                $sOrder = "";
            }
        }
        $sWhere = "";
        if (isset($_GET['sSearch']) and $_GET['sSearch'] != "") {
            $sWhere = "WHERE (";
            for ($i = 0; $i < count($aColumns); $i++) {
                $sWhere .= "" . $aColumns[$i] . " LIKE '%" . $_GET["sSearch"] . "%' OR "; // NEW CODE
            }
            $sWhere = substr_replace($sWhere, "", -3);
            $sWhere .= ')';
        }
        for ($i = 0; $i < count($aColumns); $i++) {
            if (isset($_GET['bSearchable_' . $i]) and $_GET['bSearchable_' . $i] == "true" and $_GET['sSearch_' . $i] != '') {
                if ($sWhere == "") {
                    $sWhere = "WHERE ";
                } else {
                    $sWhere .= " AND ";
                }
                $sWhere .= "" . $aColumns[$i] . " LIKE '%" . $_GET['sSearch_' . $i] . "%' ";
            }
        }
        if ($sWhere) {
            $sWhere .= " and support_form_id=" . $formid . " and support_individual_id='" . $indid . "'";
        } else {
            $sWhere .= " where support_form_id=" . $formid . " and support_individual_id='" . $indid . "'";
        }
        $sQuery = "SELECT SQL_CALC_FOUND_ROWS " . str_replace(" , ", " ", implode(", ", $aColumns)) . " FROM  $sTable $sWhere $sOrder $sLimit";
        $qry = $this->dbObj->query($sQuery)->fetchAll();
        $sQuery = "SELECT FOUND_ROWS() as fcnt";
        $aResultFilterTotal = $this->dbObj->query($sQuery)->fetchAll();
        $iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
        $sQuery = "SELECT COUNT(`" . $sIndexColumn . "`) as cnt FROM $sTable ";
        $rResultTotal = $this->dbObj->query($sQuery)->fetchAll();
        $iTotal = $rResultTotal[0]['cnt'];
        $output = array(
            "iTotalRecords" => $iTotal,
            "iTotalDisplayRecords" => $iFilteredTotal,
            "aaData" => array()
        );
        $j = 0;
        $a = [1, 2, 3, 4, 5];

        $outcome_data = $this->SuperModel->Super_Get("_uhs_outcome_form", "indid=$indid AND formid=$formid", "fetchAll");
        
        $outcome_count = 0;
        foreach ($outcome_data as $key => $row1) {
            $user_type = $_SESSION['UHS_AUTH']['storage']->agency_user_type;
            $action_step_check_for_user = explode(" ", $row1['oc_completed_by']);
            
            $user_type_string = '';
            foreach ($action_step_check_for_user as $key => $raw_data) {
                $user_type_data[$key] = trim($raw_data);
                $user_type_string .= $raw_data;
            }
            $user_type_array = explode(",", $user_type_string);
            
            if($user_type == "Staff") {
                if(in_array($user_type, $user_type_array) || in_array("Caregiver", $user_type_array)) {
                    
                } else {
                    continue;
                }
            }
            
            $row = array();
            $row[] = $outcome_count + 1;
            $row[] = '<input class="elem_ids checkboxes" type="checkbox" name="uhs_outcome[]"  value="' . $row1['oc_id'] . '">';
            $row[] = $row1['oc_frequency'];

            $row[] = $row1['oc_description'];
            $row[] = $row1['oc_completed_by'];

            $oc_action_step = json_decode($row1['oc_action_step'], TRUE);
            $action_stp = '';
            $step_counter = count($oc_action_step) - 1;
            foreach ($oc_action_step as $key => $action_step) {
                if ($key == $step_counter) {
                    $action_stp .= ($key+1)."-".$action_step;
                } else {
                    $action_stp .= ($key+1)."-".$action_step . ","."&nbsp";
                }
            }


            $creatorData = $this->SuperModel->Super_Get("_uhs_agency", "agency_id=" . $row1['created_by']);
            $userType = printUserType($creatorData);

            $row[] = $action_stp;
            $row[] = ucwords($creatorData['agency_first_name'] . " " . $creatorData['agency_last_name']) . "<br/>" . $userType;
            $row[] = date("F d, Y");

            $row[] = date("h:i a F d, Y", strtotime($row1['created_at']));

            $modifierData = array();
            if ($row1['modified_by'] != 0) {
                $modifierData = $this->SuperModel->Super_Get("_uhs_agency", "agency_id='" . $row1['modified_by'] . "'", "fetch");
            }
            if (!empty($modifierData)) {
                $userType = printUserType($modifierData);
                $row[] = ucwords($modifierData['agency_first_name'] . " " . $modifierData['agency_last_name']) . "&nbsp;" . $userType;
                $row[] = formatDateTime($row1['modified_on']);
            } else {
                $row[] = "-";
                $row[] = "-";
            }
            $edit_url = APPLICATION_URL . "/edit-outcome/$indid/$formid/" . $row1['oc_id'];
            $recordoutcome_url = APPLICATION_URL . "/add-record-outcome/$indid/$formid/" . $row1['oc_id'];
            
            if($type == "Caregiver") {
                //$a = "<a href='javascript:void(0)' style='margin-top:5px;' class='btn btn-xs btn-default record-outcome' data-oc_id=".$row1['oc_id'].">Record Outcome </a>";
                if($this->view->user->agency_user_type=="Staff"){
                    $row[] = "<a href='" . $recordoutcome_url . "' style='margin-top:5px;' class='btn btn-xs btn-default'>Record Outcome Actions</a>";
                } else {
                    $row[] = "<a href='" . $recordoutcome_url . "' style='margin-top:5px;' class='btn btn-xs btn-default'>Record Outcome</a>";
                }
                
                

            } else {
                $row[] = "<a href='" . $edit_url . "' style='margin-top:5px;' class='btn btn-xs btn-default'>Edit</a>";
            }
            
            $output['aaData'][] = $row;
            $j++;
            $outcome_count++;
        }
        echo json_encode($output);
        exit();
    }

    public function getoutcomecurrentmonthAction() {
        if (check_is_ajax($this->_request)) {
            $this->_redirect(APPLICATION_URL);
        }
        $indid = $this->_getParam("indid");
        $formid = $this->_getParam("formid");
        $type = $this->_getParam("type");
        $this->dbObj = Zend_Registry::get('db');
        $aColumns = array('support_frequency', 'support_description', 'support_added_date', 'support_other_frequency', 'support_group_size', 'support_added_by', 'support_modified_by', 'support_modified_on');
        $sIndexColumn = 'support_id';
        $sTable = '_uhs_supports';
        $sLimit = "";
        if (isset($_GET['iDisplayStart']) && $_GET['iDisplayLength'] != '-1') {
            $sLimit = "LIMIT " . intval($_GET['iDisplayStart']) . ", " . intval($_GET['iDisplayLength']);
        }
        $sOrder = "";
        if (isset($_GET['iSortCol_0'])) {
            $sOrder = "ORDER BY  ";
            for ($i = 0; $i < intval($_GET['iSortingCols']); $i++) {
                if ($_GET['bSortable_' . intval($_GET['iSortCol_' . $i])] == "true") {
                    $sOrder .= "" . $aColumns[intval($_GET['iSortCol_' . $i])] . " " .
                            ($_GET['sSortDir_' . $i] === 'asc' ? 'asc' : 'desc') . ", ";
                }
            }

            $sOrder = substr_replace($sOrder, "", -2);
            if ($sOrder == "ORDER BY") {
                $sOrder = "";
            }
        }
        $sWhere = "";
        if (isset($_GET['sSearch']) and $_GET['sSearch'] != "") {
            $sWhere = "WHERE (";
            for ($i = 0; $i < count($aColumns); $i++) {
                $sWhere .= "" . $aColumns[$i] . " LIKE '%" . $_GET["sSearch"] . "%' OR "; // NEW CODE
            }
            $sWhere = substr_replace($sWhere, "", -3);
            $sWhere .= ')';
        }
        for ($i = 0; $i < count($aColumns); $i++) {
            if (isset($_GET['bSearchable_' . $i]) and $_GET['bSearchable_' . $i] == "true" and $_GET['sSearch_' . $i] != '') {
                if ($sWhere == "") {
                    $sWhere = "WHERE ";
                } else {
                    $sWhere .= " AND ";
                }
                $sWhere .= "" . $aColumns[$i] . " LIKE '%" . $_GET['sSearch_' . $i] . "%' ";
            }
        }
        if ($sWhere) {
            $sWhere .= " and support_form_id=" . $formid . " and support_individual_id='" . $indid . "'";
        } else {
            $sWhere .= " where support_form_id=" . $formid . " and support_individual_id='" . $indid . "'";
        }
        $sQuery = "SELECT SQL_CALC_FOUND_ROWS " . str_replace(" , ", " ", implode(", ", $aColumns)) . " FROM  $sTable $sWhere $sOrder $sLimit";
        $qry = $this->dbObj->query($sQuery)->fetchAll();
        $sQuery = "SELECT FOUND_ROWS() as fcnt";
        $aResultFilterTotal = $this->dbObj->query($sQuery)->fetchAll();
        $iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
        $sQuery = "SELECT COUNT(`" . $sIndexColumn . "`) as cnt FROM $sTable ";
        $rResultTotal = $this->dbObj->query($sQuery)->fetchAll();
        $iTotal = $rResultTotal[0]['cnt'];
        $output = array(
            "iTotalRecords" => $iTotal,
            "iTotalDisplayRecords" => $iFilteredTotal,
            "aaData" => array()
        );
        $j = 0;
        $a = [1, 2, 3, 4, 5];

        $date_from = date("Y-m-01");
        $date_to = date("Y-m-t");
       // $outcome_data = $this->SuperModel->Super_Get("_uhs_outcome_form", "indid=$indid AND formid=$formid AND created_at BETWEEN '" . $date_from . "' AND '" . $date_to . "'", "fetchAll");
        $outcome_data = $this->SuperModel->Super_Get("_uhs_outcome_form", "indid=$indid AND formid=$formid", "fetchAll");

        $outcome_count = 0;
        foreach ($outcome_data as $key => $row1) {
            $user_type = $_SESSION['UHS_AUTH']['storage']->agency_user_type;
            $action_step_check_for_user = explode(" ", $row1['oc_completed_by']);
            
            $user_type_string = '';
            foreach ($action_step_check_for_user as $key => $raw_data) {
                $user_type_data[$key] = trim($raw_data);
                $user_type_string .= $raw_data;
            }
            $user_type_array = explode(",", $user_type_string);
            
            if($user_type == "Staff") {
                if(!in_array($user_type, $user_type_array)) {
                    continue;
                }
            }
            
            $row = array();
            $row[] = $outcome_count + 1;
            $row[] = '<input class="elem_ids checkboxes" type="checkbox" name="uhs_outcome[]"  value="' . $row1['oc_id'] . '">';
            
            if($row1['oc_frequency'] == "Other"){ 
                if(!empty($row1['other_frequency_detail'])) {
                    $row[] = $row1['other_frequency_detail'];
                } else {
                    $row[] = $row1['oc_frequency'];
                }
                
            }else{
                $row[] = $row1['oc_frequency'];
            }

            $row[] = $row1['oc_description'];
            $row[] = $row1['oc_completed_by'];

            $oc_action_step = json_decode($row1['oc_action_step'], TRUE);
            $action_stp = '';
            $step_counter = count($oc_action_step) - 1;
            foreach ($oc_action_step as $key => $action_step) {
                if ($key == $step_counter) {
                    $action_stp .= ($key+1)."-".$action_step;
                } else {
                    $action_stp .= ($key+1)."-".$action_step . ","."&nbsp";
                }
            }
            $creatorData = $this->SuperModel->Super_Get("_uhs_agency", "agency_id=" . $row1['created_by']);
            $userType = printUserType($creatorData);

            $row[] = $action_stp;
            $row[] = ucwords($creatorData['agency_first_name'] . " " . $creatorData['agency_last_name']) . "<br/>" . $userType;
            $row[] = date("F d, Y");

            $row[] = date("h:i a F d, Y", strtotime($row1['created_at']));

            $modifierData = array();
            if ($row1['modified_by'] != 0) {
                $modifierData = $this->SuperModel->Super_Get("_uhs_agency", "agency_id='" . $row1['modified_by'] . "'", "fetch");
            }
            if (!empty($modifierData)) {
                $userType = printUserType($modifierData);
                $row[] = ucwords($modifierData['agency_first_name'] . " " . $modifierData['agency_last_name']) . "&nbsp;" . $userType;
                $row[] = formatDateTime($row1['modified_on']);
            } else {
                $row[] = "-";
                $row[] = "-";
            }
            $edit_url = APPLICATION_URL . "/edit-outcome/$indid/$formid/" . $row1['oc_id'];
            $recordoutcome_url = APPLICATION_URL . "/add-record-outcome/$indid/$formid/" . $row1['oc_id'];
            $edit_outcome = "<a href='" . $edit_url . "' style='margin-top:5px;' class='btn btn-xs btn-default'>Edit Outcome</a>";
            $record_come = "<a href='" . $recordoutcome_url . "' style='margin-top:5px;' class='btn btn-xs btn-default'>Record Outcome Actions</a>";
            $row[] = $edit_outcome."&nbsp;&nbsp;".$record_come;
            $output['aaData'][] = $row;
            $j++;
            $outcome_count++;
        }

        echo json_encode($output);
        exit();
    }
    
    public function getoutcomeviewAction() {
        if (check_is_ajax($this->_request)) {
            $this->_redirect(APPLICATION_URL);
        }
        $indid = $this->_getParam("indid");
        $formid = $this->_getParam("formid");
        $type = $this->_getParam("type");
        $this->dbObj = Zend_Registry::get('db');
        $subuser = $dstarts = $dends = $month = $year = "";
        if (isset($_REQUEST['subuser']) && !empty($_REQUEST['subuser'])) {
            $subuser = $_REQUEST['subuser'];
        }
        if (isset($_REQUEST['dstarts']) && !empty($_REQUEST['dstarts'])) {
            $dstarts = $_REQUEST['dstarts'];
        }
        if (isset($_REQUEST['dends']) && !empty($_REQUEST['dends'])) {
            $dends = $_REQUEST['dends'];
        }
        if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
                $month=$_REQUEST['month'];
        }
        if(isset($_REQUEST['year']) && !empty($_REQUEST['year'])){
                $year=$_REQUEST['year'];
        }
        $aColumns = array('record_id', 'indid', 'formid', 'oc_id', 'oc_description', 'oc_action_step', 'is_completed', 'outcome_comment','added_by','created_at','modified_at','modified_by','modified_on');
        $sIndexColumn = 'record_id';
        $sTable = '_uhs_record_outcome_form';
        $sLimit = "";
        if (isset($_GET['iDisplayStart']) && $_GET['iDisplayLength'] != '-1') {
            $sLimit = "LIMIT " . intval($_GET['iDisplayStart']) . ", " . intval($_GET['iDisplayLength']);
        }
        $sOrder = "";
        if (isset($_GET['iSortCol_0'])) {
            $sOrder = "ORDER BY  ";
            for ($i = 0; $i < intval($_GET['iSortingCols']); $i++) {
                if ($_GET['bSortable_' . intval($_GET['iSortCol_' . $i])] == "true") {
                    $sOrder .= "" . $aColumns[intval($_GET['iSortCol_' . $i])] . " " .
                            ($_GET['sSortDir_' . $i] === 'asc' ? 'asc' : 'desc') . ", ";
                }
            }

            $sOrder = substr_replace($sOrder, "", -2);
            if ($sOrder == "ORDER BY") {
                $sOrder = "";
            }
        }

        $sWhere = "";

        if (empty($subuser)) {
            $indParentUsers = "";
            if ($this->view->user->agency_user_type == "Agency") {
                $systemUsers = $this->SuperModel->Super_Get("_uhs_agency", "agency_user_agency_id=" . $this->view->user->agency_id, "fetchAll", array("fields" => "agency_id"));
                $systemUsers[count($systemUsers)]['agency_id'] = $this->view->user->agency_id;
                $indParentUsers = implode_r(",", $systemUsers);
            } else {
                $systemUsers = $this->SuperModel->Super_Get("_uhs_agency", "agency_user_agency_id=" . $this->view->user->agency_user_agency_id, "fetchAll", array("fields" => "agency_id"));
                $systemUsers[count($systemUsers)]['agency_id'] = $this->view->user->agency_id;
                $systemUsers[count($systemUsers)]['agency_id'] = $this->view->user->agency_user_agency_id;
                $indParentUsers = implode_r(",", $systemUsers);
                //$indParentUsers=$this->view->user->agency_id.",".$this->view->user->agency_user_agency_id;
            }
            if ($sWhere) {
                $sWhere .= " and added_by IN(" . $indParentUsers . ") and indid='" . $indid . "' and formid='" . $formid . "'";
            } else {
                $sWhere .= " where added_by IN(" . $indParentUsers . ") and indid='" . $indid . "' and formid='" . $formid . "'";
            }
        } else {
            if ($sWhere) {
                $sWhere .= " and added_by IN(" . $subuser . ") and indid='" . $indid . "' and formid='" . $formid . "'";
            } else {
                $sWhere .= " where added_by IN(" . $subuser . ") and indid='" . $indid . "' and formid='" . $formid . "'";
            }
        }

        if (!empty($dstarts)) {
            $sWhere .= " and DATE(created_at) >='" . $dstarts . "'";
        }
        if (!empty($dends)) {
            $sWhere .= " and DATE(created_at) <='" . $dends . "'";
        }

        if(!empty($month)){
            $sWhere.=" and MONTH(created_at)='".$month."'";
        }
        if(!empty($year)){
            $sWhere.=" and YEAR(created_at)='".$year."'";
        }
        $sQuery = "SELECT SQL_CALC_FOUND_ROWS " . str_replace(" , ", " ", implode(", ", $aColumns)) . " FROM  $sTable $sWhere $sOrder $sLimit";
        
        
        
        $qry = $this->dbObj->query($sQuery)->fetchAll();
        
        ///echo "<pre>"; print_r($qry); die;
        $sQuery = "SELECT FOUND_ROWS() as fcnt";
        $aResultFilterTotal = $this->dbObj->query($sQuery)->fetchAll();
        $iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
        $sQuery = "SELECT COUNT(`" . $sIndexColumn . "`) as cnt FROM $sTable ";
        $rResultTotal = $this->dbObj->query($sQuery)->fetchAll();
        $iTotal = $rResultTotal[0]['cnt'];
        $output = array(
            "iTotalRecords" => $iTotal,
            "iTotalDisplayRecords" => $iFilteredTotal,
            "aaData" => array()
        );
        $j = 0;
        $a = [1, 2, 3, 4, 5];

        //$outcome_data = $this->SuperModel->Super_Get("_uhs_record_outcome_form", "indid=$indid AND formid=$formid", "fetchAll");
        //echo "<pre>"; print_r($outcome_data); die;
        $outcome_count = 0;
        foreach ($qry as $key => $row1) {

            $oc_id = $row1['oc_id'];
            $data_for_recorded_outcome = $this->SuperModel->Super_Get("_uhs_outcome_form", "oc_id = $oc_id", "fetch");
            
            $row = array();
            $row[] = $outcome_count + 1;
            $row[] = '<input class="elem_ids checkboxes" type="checkbox" name="records[' . $row1['record_id'] . ']"  value="' . $row1['record_id'] . '">';
            
            
            if($data_for_recorded_outcome['oc_frequency'] == "Other"){ 
                if(!empty($data_for_recorded_outcome['other_frequency_detail'])) {
                    
                    $row[] = $data_for_recorded_outcome['other_frequency_detail'];
                } else {
                    $row[] = $data_for_recorded_outcome['oc_frequency'];
                }
                
            }else{
                $row[] = $data_for_recorded_outcome['oc_frequency'];
            }
            
            

            $row[] = $data_for_recorded_outcome['oc_description'];
            $bclass = "";
            if ($row1['is_completed'] == "Yes") {
                $bclass = "badge-success";
            } else {
                $bclass = "badge-danger";
            }
            $row[] = "<span class='badges badge " . $bclass . "'>" . ucwords($row1['is_completed']) . "</span>";
            //$row[] = $row1['is_completed'];

            $oc_action_step = json_decode($row1['oc_action_step'], TRUE);
            $action_stp = '';
            $step_counter = count($oc_action_step) - 1;
            foreach ($oc_action_step as $key => $action_step) {
                if ($key == $step_counter) {
                    $action_stp .= ($key+1)."-".$action_step;
                } else {
                    $action_stp .= ($key+1)."-".$action_step . ","."&nbsp";
                }
            }
            $creatorData = $this->SuperModel->Super_Get("_uhs_agency", "agency_id='" . $row1['added_by'] . "'", "fetch");
            //$creatorData = $this->SuperModel->Super_Get("_uhs_agency", "agency_user_agency_id=" . $row1['added_by']);

            $userType = printUserType($creatorData);

            $row[] = $action_stp;
            $row[] = $row1['outcome_comment'];
            $row[] = ucwords($creatorData['agency_first_name'] . " " . $creatorData['agency_last_name']) . "<br/>" . $userType;
            /*$row[] = date("F d, Y");*/

            $row[] = date("h:i a F d, Y", strtotime($row1['created_at']));

            $modifierData = array();
            if ($row1['modified_by'] != 0) {
                $modifierData = $this->SuperModel->Super_Get("_uhs_agency", "agency_id='" . $row1['modified_by'] . "'", "fetch");
            }
            if (!empty($modifierData)) {
                $userType = printUserType($modifierData);
                $row[] = ucwords($modifierData['agency_first_name'] . " " . $modifierData['agency_last_name']) . "&nbsp;" . $userType;
                $row[] = formatDateTime($row1['modified_on']);
            } else {
                $row[] = "-";
                $row[] = "-";
            }

            $edit_url = APPLICATION_URL . "/edit-outcome/$indid/$formid/" . $row1['oc_id'];
            $edit_record_url = APPLICATION_URL . "/edit-record-outcome/$indid/$formid/" . $row1['oc_id']."/".$row1['record_id'];
            
//            if($type == "Caregiver") {
//                //$a = "<a href='javascript:void(0)' style='margin-top:5px;' class='btn btn-xs btn-default record-outcome' data-oc_id=".$row1['oc_id']." data-recorded_oc_id=".$row1['record_id'].">Edit</a>";
//                if($_SESSION['UHS_AUTH']['storage']->agency_user_type == 'Staff'){
//                    $edit = "<b>NA</b>";
//                }else{
//                    $edit = "<a href='" . $edit_record_url . "' style='margin-top:5px;' class='btn btn-xs btn-default'>Edit</a>";
//                }
//            } else {
//                $edit = "<a href='" . $edit_url . "' style='margin-top:5px;' class='btn btn-xs btn-default'>Edit</a>";
//            }
//            $recordoutcome_url = APPLICATION_URL . "/add-record-outcome/$indid/$formid/" . $row1['oc_id'];
//            $recordoutcome = "<a href='" . $recordoutcome_url . "' style='margin-top:5px;' class='btn btn-xs btn-default'>Record Outcome</a>";
//            $row[]= $edit."&nbsp;&nbsp;&nbsp;&nbsp;".$recordoutcome;
            
            
            
            if($type == "Caregiver") {
                //$a = "<a href='javascript:void(0)' style='margin-top:5px;' class='btn btn-xs btn-default record-outcome' data-oc_id=".$row1['oc_id']." data-recorded_oc_id=".$row1['record_id'].">Edit</a>";
                if($_SESSION['UHS_AUTH']['storage']->agency_user_type == 'Staff'){
                    //$edit = "<b>NA</b>";
                    $edit = "<a href='" . $edit_record_url . "' style='margin-top:5px;' class='btn btn-xs btn-default'>Edit</a>";
                }else{
                    $edit = "<a href='" . $edit_record_url . "' style='margin-top:5px;' class='btn btn-xs btn-default'>Edit</a>";
                }
            } else {
                $edit = "<a href='" . $edit_url . "' style='margin-top:5px;' class='btn btn-xs btn-default'>Edit</a>";
            }
            //$recordoutcome_url = APPLICATION_URL . "/add-record-outcome/$indid/$formid/" . $row1['oc_id'];
            //$recordoutcome = "<a href='" . $recordoutcome_url . "' style='margin-top:5px;' class='btn btn-xs btn-default'>Record Outcome</a>";
            $row[]= $edit;
            
            $output['aaData'][] = $row;
            $j++;
            $outcome_count++;
        }
        echo json_encode($output);
        exit();
    }

    public function outcomedeleteAction() {
        global $healthSession;
        $formData = $this->getRequest()->getPost();

        if (isset($formData['uhs_outcome']) && count($formData['uhs_outcome'])) {
            foreach ($formData['uhs_outcome'] as $key => $values) {
                $isAdd = $this->SuperModel->Super_Delete('_uhs_outcome_form', "oc_id=" . $values);
                $isAddRecord = $this->SuperModel->Super_Delete('_uhs_record_outcome_form', "oc_id=" . $values);
                $healthSession->successMsg = "Outcome(s) has been deleted successfully.";
            }
        } else {
            $healthSession->errorMsg = "Invalid Request.";
        }

        $indid = $formData['indid'];
        $formid = $formData['formid'];

        if ($formData['previous_url'] == "outcome-log") {
            $this->_helper->getHelper("Redirector")->gotoRoute(array("indid" => $indid, "formid" => $formid), "outcome_log");
        } elseif ($formData['previous_url'] == "add-outcome-form") {
            $this->_helper->getHelper("Redirector")->gotoRoute(array("indid" => $indid, "formid" => $formid), "add_outcome_form");
        }
    }

    public function outcomelogAction() {
        global $healthSession;
        $indid = $this->_getParam("indid");
        $formid = $this->_getParam("formid");
        $this->view->indid = $indid;
        $this->view->formid = $formid;
        $this->view->type = "Care";
        $this->view->pageHeading = "Outcome";
    }

    public function recordoutcomeAction() {
        //echo "<pre>"; print_r($_POST); die;
        global $healthSession;
        
        
        $indid = $this->_getParam("indid");
        $formid = $this->_getParam("formid");

        $posted_data = [];

        $posted_data['indid'] = $indid;
        $posted_data['formid'] = $formid;
        $posted_data['oc_description'] = $_POST['oc_description'];
        $posted_data['oc_action_step'] = json_encode($_POST['oc_action_step']);
        $posted_data['is_completed'] = $_POST['is_completed'];
        $posted_data['outcome_comment'] = $_POST['oc_comment'];
        $posted_data['added_by'] = $this->view->user->subuser_id;
        $posted_data['oc_id'] = $_POST['oc_id'];
        $posted_data['modified_at'] = date("Y-m-d H:i:s");
        
        $edit_id = $_POST['edit_id'];
        
        //echo '<pre>';
        //print_r($_POST);die;
        
        if($edit_id == 0) {
            $isIns = $this->SuperModel->Super_Insert("_uhs_record_outcome_form", $posted_data);
            
            $healthSession->successMsg = "Outcome has been recorded successfully.";
        } else {
            $posted_data['modified_by'] = $_SESSION['UHS_AUTH']['storage']->agency_id;
            $posted_data['modified_on'] = date("Y-m-d H:i:s");
            $isIns = $this->SuperModel->Super_Insert("_uhs_record_outcome_form", $posted_data, "record_id = $edit_id");
            
            $healthSession->successMsg = "Outcome has been updated successfully.";
        }
        if($_SESSION['UHS_AUTH']['storage']->agency_user_type == 'Staff'){
           // $this->_helper->getHelper("Redirector")->gotoRoute(array("indid" => $indid, "formid" => $formid), "record_outcome_log");
            $this->_helper->getHelper("Redirector")->gotoRoute(array("indid" => $indid, "formid" => $formid), "record_outcome_log_view");
        }else{
            //$this->_helper->getHelper("Redirector")->gotoRoute(array("indid" => $indid, "formid" => $formid), "add_outcome_form");
            $this->_helper->getHelper("Redirector")->gotoRoute(array("indid" => $indid, "formid" => $formid), "record_outcome_log_view");
        }


//        echo '<pre>';
//        print_r($_POST);die;
    }
    
    public function recordoutcomelogviewAction() {
        //$taskData = $this->SuperModel->Super_Get("_uhs_record_outcome_form", "record_id IN(" . 12 . ") and oc_frequency IN(select oc_frequency from _uhs_outcome_form group by oc_frequency)", "fetchAll", array("join" => "_uhs_outcome_form", "joincondition" => "_uhs_record_outcome_form.oc_id=_uhs_outcome_form.oc_id", "joinfields" => "oc_frequency", "order" => "oc_frequency ASC"));
        //echo "<pre>"; print_r($taskData); die;
        global $healthSession;
        $indid = $this->_getParam("indid");
        $formid = $this->_getParam("formid");
        $permissions = checkPermissions("individual", $indid, $this->view->user->agency_id);
        $this->view->permissions = $permissions;
        $this->view->indid = $indid;
        $this->view->formid = $formid;
        $this->view->type = "Caregiver";
        $this->view->pageHeading = "Outcome";
    }

    public function recordoutcomelogAction() {
        global $healthSession;
        $indid = $this->_getParam("indid");
        $formid = $this->_getParam("formid");
        $this->view->indid = $indid;
        $this->view->formid = $formid;
        $this->view->type = "Caregiver";
        $this->view->pageHeading = "Outcome";
    }
    
    public function getocbyidAction() {
        $editid = $_POST['oc_id'];
        
        $outcome_data = $this->SuperModel->Super_Get("_uhs_outcome_form", "oc_id=" . $editid, "fetch");
        $outcome_data['oc_action_step'] = json_decode($outcome_data['oc_action_step'], TRUE);
        $outcome_data['oc_completed_by'] = explode(",", $outcome_data['oc_completed_by']);
        
        $action_step = '';
        $action_step .= "<label for='med_observations' class='required' aria-required='true'>Action Steps <small>Select one or more steps to complete this outcome</small> <span class='star'>*</span>
                        </label><br>";
        foreach ($outcome_data['oc_action_step'] as $raw_data) {
            $action_step .= "<span><input name='oc_action_step[]' type='checkbox' value='".$raw_data."'> ".$raw_data."</span><br>";
        }
        
        $outcome_data['oc_action_step'] = $action_step;
        
        echo json_encode($outcome_data);
        exit();
    }
    
    public function getrecordedocbyidAction() {
        $editid = $_POST['oc_id'];
        
        $recorded_oc_id = $_POST['recorded_oc_id'];
        
        $recorded_outcome_data = $this->SuperModel->Super_Get("_uhs_record_outcome_form", "record_id=" . $recorded_oc_id, "fetch");
        $recorded_action_step = json_decode($recorded_outcome_data['oc_action_step'], TRUE);
        
        $outcome_data = $this->SuperModel->Super_Get("_uhs_outcome_form", "oc_id=" . $editid, "fetch");
        $outcome_data['oc_action_step'] = json_decode($outcome_data['oc_action_step'], TRUE);
        $outcome_data['oc_completed_by'] = explode(",", $outcome_data['oc_completed_by']);
        
        $action_step = '';
        $action_step .= "<label for='med_observations' class='required' aria-required='true'>Action Steps <small>Select one or more steps to complete this outcome</small> <span class='star'>*</span>
                        </label><br>";
        foreach ($outcome_data['oc_action_step'] as $raw_data) {
            if(in_array($raw_data, $recorded_action_step)) {
                $action_step .= "<span><input name='oc_action_step[]' type='checkbox' value='".$raw_data."' checked> ".$raw_data."</span><br>";
            }
            else {
                $action_step .= "<span><input name='oc_action_step[]' type='checkbox' value='".$raw_data."'> ".$raw_data."</span><br>";
            }
        }
        
        $result['oc_description'] = $outcome_data['oc_description'];
        $result['oc_id'] = $outcome_data['oc_id'];
        $result['oc_action_step'] = $action_step;
        $result['record_id'] = $recorded_outcome_data['record_id'];
        $result['outcome_comment'] = $recorded_outcome_data['outcome_comment'];
        $result['is_completed'] = $recorded_outcome_data['is_completed'];
        
        echo json_encode($result);
        exit();
    }

    public function addrecordoutcomeAction()
    {
        global $healthSession;

        $indid = $this->_getParam("indid");
        $formid = $this->_getParam("formid");
        $editid = $this->_getParam("id");

        $previous_url = $_SERVER['HTTP_REFERER'];

        $outcome_data = $this->SuperModel->Super_Get("_uhs_outcome_form", "oc_id=" . $editid, "fetch");
        $outcome_data['oc_action_step'] = json_decode($outcome_data['oc_action_step'], TRUE);
        $outcome_data['oc_completed_by'] = explode(",", $outcome_data['oc_completed_by']);

        $action_step = '';
        $action_step .= "<label for='med_observations' class='required' aria-required='true'>Action Steps <small>Select one or more steps to complete this outcome</small> <span class='star'>*</span>
                        </label><br>";
        foreach ($outcome_data['oc_action_step'] as $raw_data) {
            $action_step .= "<span><input name='oc_action_step[]' type='checkbox' value='".$raw_data."'> ".$raw_data."</span><br>";
        }

        $outcome_data['oc_action_step'] = $action_step;

        foreach ($outcome_data['oc_completed_by'] as $key => $value) {
            $outcome_data['oc_completed_by'][$key] = trim($value);
        }
        $this->view->pageHeading = "Record Outcome Actions";

        $this->view->outcome_data = $outcome_data;
        $this->view->indid = $indid;
        $this->view->editid = $editid;
        $this->view->formid = $formid;
        $this->view->previous_url = $previous_url;
        $this->view->agency_user_type = $this->view->user->agency_user_type;
    }

    public function editrecordoutcomeAction()
    {
        global $healthSession;
        $indid = $this->_getParam("indid");
        $formid = $this->_getParam("formid");
        $editid = $this->_getParam("id");
        $recorded_oc_id = $this->_getParam("recordid");

        $previous_url = $_SERVER['HTTP_REFERER'];

        $recorded_outcome_data = $this->SuperModel->Super_Get("_uhs_record_outcome_form", "record_id=" . $recorded_oc_id, "fetch");
        $recorded_action_step = json_decode($recorded_outcome_data['oc_action_step'], TRUE);

        $outcome_data = $this->SuperModel->Super_Get("_uhs_outcome_form", "oc_id=" . $editid, "fetch");
        $outcome_data['oc_action_step'] = json_decode($outcome_data['oc_action_step'], TRUE);
        $outcome_data['oc_completed_by'] = explode(",", $outcome_data['oc_completed_by']);

        $action_step = '';
        $action_step .= "<label for='med_observations' class='required' aria-required='true'>Action Steps <small>Select one or more steps to complete this outcome</small> <span class='star'>*</span>
                        </label><br>";
        foreach ($outcome_data['oc_action_step'] as $raw_data) {
            if(in_array($raw_data, $recorded_action_step)) {
                $action_step .= "<span><input name='oc_action_step[]' type='checkbox' value='".$raw_data."' checked> ".$raw_data."</span><br>";
            }
            else {
                $action_step .= "<span><input name='oc_action_step[]' type='checkbox' value='".$raw_data."'> ".$raw_data."</span><br>";
            }
        }

        $result['oc_description'] = $outcome_data['oc_description'];
        $result['oc_id'] = $outcome_data['oc_id'];
        $result['oc_action_step'] = $action_step;
        $result['record_id'] = $recorded_outcome_data['record_id'];
        $result['outcome_comment'] = $recorded_outcome_data['outcome_comment'];
        $result['is_completed'] = $recorded_outcome_data['is_completed'];

        $this->view->pageHeading = "Record Outcome";
        
        $this->view->outcome_data = $result;
        $this->view->indid = $indid;
        $this->view->editid = $editid;
        $this->view->formid = $formid;
        $this->view->previous_url = $previous_url;
    }

    public function removeoutcomerecordAction() {
        global $healthSession;
        $formData = $this->getRequest()->getPost();

        if (isset($formData['records']) && count($formData['records'])) {
            foreach ($formData['records'] as $key => $values) {
                $isAdd = $this->SuperModel->Super_Delete('_uhs_record_outcome_form', "record_id=" . $values);
                $healthSession->successMsg = "Outcome(s) records has been deleted successfully.";
            }
        } else {
            $healthSession->errorMsg = "Invalid Request.";
        }

        $indid = $formData['indid'];
        $formid = $formData['formid'];

        $this->_helper->getHelper("Redirector")->gotoRoute(array("indid" => $indid, "formid" => $formid), "record_outcome_log_view");

    }

    private function _record_log($indData, $ids, $formid, $type, $extra = array()) {
        global $months;
        $userCond = "";
        if ($this->view->user->agency_user_type != "Agency") {
            $userCond = "added_by='" . $this->view->user->agency_id . "' and ";
        }
        //return $ids;
        if ($ids !== "All") {
            $taskData = $this->SuperModel->Super_Get("_uhs_record_outcome_form", "record_id IN(" . $ids . ") and oc_frequency IN(select oc_frequency from _uhs_outcome_form group by oc_frequency)", "fetchAll", array("join" => "_uhs_outcome_form", "joincondition" => "_uhs_record_outcome_form.oc_id=_uhs_outcome_form.oc_id", "joinfields" => array("oc_frequency","other_frequency_detail"), "order" => "created_at DESC"));

        } else {
            $taskData = $this->SuperModel->Super_Get("_uhs_record_outcome_form", "" . $userCond . " added_by=" . $indData['agency_id'] . " and  MONTH(created_at)=" . $extra['month'] . " and YEAR(created_at)='" . $extra['year'] . "'", "fetchAll", array("join" => " _uhs_outcome_form", "joincondition" => "_uhs_record_outcome_form.oc_id=_uhs_outcome_form.oc_id", "joinfields" => array("oc_frequency","other_frequency_detail"), "order" => "created_at DESC"));
        }
        $number = date('t');
        $totalColspan = $number + 1;
        $headingText = $html = "";
        if ($type == "Record") {
            $headingText = "Outcome Form";
        }
        if ($type == "MAR") {
            $headingText = "PRN Medication Administration Record";
        }
        if ($type == "Cleaning") {
            $headingText = "Cleaning Chart";
        }
        $tdWid = round(90 / $number, 2);
        $html = "";
       

        if(count($taskData)>0){
            $html.= $this->_report_header($headingText,$indData);
            $html.="<h5>Individual Information: ".ucwords($indData['agency_first_name']." ".$indData['agency_last_name']).",".$indData['agency_city'].",".$indData['agency_state'].",".$indData['agency_zip']."</h5>";
            

            $html.="</div>
            <div class='clearfix'>&nbsp;</div>";
            
            $html.="<table width='140%'>";
            for($i=0;$i<count($taskData);$i++){
                    $taskcreatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$taskData[$i]['added_by']."'","fetch");
                    if($taskcreatorData['is_subuser']){
                       $agency_user_type =  $taskcreatorData['agency_user_type']." Sub-User";
                    } else {
                        $agency_user_type = $taskcreatorData['agency_user_type'];
                    }
                    $taskcreatername = $taskcreatorData['agency_first_name']." ".$taskcreatorData['agency_last_name']."|".$agency_user_type;
                    $oc_action_steps = json_decode($taskData[$i]['oc_action_step']);
                    $action_steps="";
                    $oc_frequency="";
                    foreach($oc_action_steps as $oc_action_step){
                            if($oc_action_step){
                                    $action_steps.= $oc_action_step.',';
                            }
                    }
                    if($taskData[$i]['oc_frequency'] == "Other"){ 
                        if(!empty($taskData[$i]['other_frequency_detail'])) {

                            $oc_frequency = $taskData[$i]['other_frequency_detail'];
                        } else {
                            $oc_frequency = $taskData[$i]['oc_frequency'];
                        }
                    }else{
                        $oc_frequency = $taskData[$i]['oc_frequency'];
                    }

                    $actionsteps = rtrim($action_steps,',');
                    $html.="<tr><td style='font-size: 20px;'>".($i+1)." ".$taskData[$i]['oc_description']."</td></tr>";
                    $html.="<tr>
                                <td style='font-size: 20px;' width='40%'><b>Support Frequency: </b>".$oc_frequency."</td>
                                
                                <td style='font-size: 20px;' width='40%'><b>Action Steps: </b>".$actionsteps."</td>
                                <td style='font-size: 20px;' width='20%'><b>Task Completion: </b>".$taskData[$i]['is_completed']."</td>
                                <td style='font-size: 20px;' width='20%'><b>Recorded By: </b>".$taskcreatername."</td>
                                <td style='font-size: 20px;' width='20%'><b>Recorded On: </b>".formatDateTime($taskData[$i]['created_at'])."</td>
                            </tr>";
                      $html.="<tr>
                                <td style='font-size: 20px;'><b>Comment: </b>".$taskData[$i]['outcome_comment']."</td>
                                
                                
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                            <tr><td width='140%' style='height:30px;border-bottom:1px solid black;' colspan='8'></td></tr>
                            <tr><td width='140%' style='height:30px;' colspan='8'></td></tr>";
            }                               
            $html.="</table>";
            if($idall=="All"){
                    $html.="<pagebreak />";
            }
        }else{
            $html.= "";
        }
        return $html;
    }
//    private function _record_log($indData, $ids, $formid, $type, $extra = array()) {
//        global $months;
//        $userCond = "";
//        if ($this->view->user->agency_user_type != "Agency") {
//            $userCond = "added_by='" . $this->view->user->agency_id . "' and ";
//        }
//        //return $ids;
//        if ($ids !== "All") {
//            $taskData = $this->SuperModel->Super_Get("_uhs_record_outcome_form", "record_id IN(" . $ids . ") and oc_frequency IN(select oc_frequency from _uhs_outcome_form group by oc_frequency)", "fetchAll", array("join" => "_uhs_outcome_form", "joincondition" => "_uhs_record_outcome_form.oc_id=_uhs_outcome_form.oc_id", "joinfields" => "oc_frequency", "order" => "oc_frequency ASC"));
//
//        } else {
//            $taskData = $this->SuperModel->Super_Get("_uhs_record_outcome_form", "" . $userCond . " added_by=" . $indData['agency_id'] . " and  MONTH(created_at)=" . $extra['month'] . " and YEAR(created_at)='" . $extra['year'] . "'", "fetchAll", array("join" => " _uhs_outcome_form", "joincondition" => "_uhs_record_outcome_form.oc_id=_uhs_outcome_form.oc_id", "joinfields" => "oc_frequency", "order" => "oc_frequency ASC"));
//        }
//        $number = date('t');
//        $totalColspan = $number + 1;
//        $headingText = $html = "";
//        if ($type == "Record") {
//            $headingText = "Outcome Form";
//        }
//        if ($type == "MAR") {
//            $headingText = "PRN Medication Administration Record";
//        }
//        if ($type == "Cleaning") {
//            $headingText = "Cleaning Chart";
//        }
//        $tdWid = round(90 / $number, 2);
//        $html = "";
//        $html .= $this->_report_header($headingText, $indData);
//        if (count($taskData) > 0) {
//            //$html="<div class='text-right'>Date:".date("m/d/Y H:i:s",time())."</div>";
//            // $html.="<div class='alert alert-info text-center'>
//            // $html.="<h3>".$headingText."</h3>
//            $html .= "		<h5>Individual Information: " . ucwords($indData['agency_first_name'] . " " . $indData['agency_last_name']) . "," . $indData['agency_city'] . "," . $indData['agency_state'] . "," . $indData['agency_zip'] . "</h5>
//	</div>";
//            $html .= "<table class='table table-bordered' cellspacing='10' cellpadding='20' width='100%'><tr><th style='padding:0.5%;' width='20%'>Outcome</th>";
//            for ($i = 1; $i <= $number; $i++) {
//                $html .= "<th align='center' style='padding:0.5%;' width='" . $tdWid . "%'>" . $i . "</th>";
//            }
//            $html .= "</tr>";
//            $fArr = array();
//            foreach ($taskData as $task) {
//                if (!in_array($task['oc_frequency'], $fArr)) {
//                    $fArr[] = $task['oc_frequency'];
//                    $html .= "<tr><td style='padding:0.5%;' colspan='" . $totalColspan . "'><b>" . $task['oc_frequency'] . "</b></td></tr>";
//                }
//                $html .= "<tr><td style='padding:0.5%;' width='20%'>" . ucwords($task['oc_description']) . "</td>";
//                for ($i = 1; $i <= $number; $i++) {
//                    if (date("j", strtotime($task['created_at'])) == $i) {
//                        if ($task['is_completed'] == "Yes") {
//                            $html .= "<td style='padding:0.5%;' align='center' width='" . $tdWid . "%'><img src='" . HTTP_IMG_URL . "/yes.png'/><td>";
//                        } else {
//                            $html .= "<td style='padding:0.5%;' align='center' width='" . $tdWid . "%'><img src='" . HTTP_IMG_URL . "/no.png'/></td>";
//                        }
//                    } else if ($i < $number) {
//                        $html .= "<td style='padding:0.5%;' width='" . $tdWid . "%'></td>";
//                    }
//                }
//                $html .= "</tr>";
//            }
//            $html .= "</table>";
//            if ($ids == "All" && $type != "Cleaning") {
//                $html .= "<pagebreak />";
//            }
//        } else {
//            $html .= "<h4><center><strong><i> No DATA FOUND </strong></i></center></h4> </div>";
//        }
//        return $html;
//    }
    
    // Groceries/household Form
	public function groceriesAction(){	
		global $healthSession; 
  		$this->view->pageHeading = "Groceries/Household";
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		if(empty($indid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		$getAssignedBalance=$this->SuperModel->Super_Get("_uhs_groceries_initial_balance","gr_form_id='".$formid."' and gr_individual_id='".$indid."'","fetch",array("order"=>"grid DESC"));
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		$this->view->permissions=$permissions;
		$this->view->indid=$indid;
		$this->view->formid=$formid;
		$this->view->id=$id;
		$this->view->getAssignedBalance=$getAssignedBalance;
  	}
	
	public function getgroceriesAction(){
		if(check_is_ajax($this->_request)){
			$this->_redirect(APPLICATION_URL);
		}
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		$subuser=$dstarts=$dends=$month=$year="";
		if(isset($_REQUEST['subuser']) && !empty($_REQUEST['subuser'])){
			$subuser=$_REQUEST['subuser'];
		}
		if(isset($_REQUEST['dstarts']) && !empty($_REQUEST['dstarts'])){
			$dstarts=$_REQUEST['dstarts'];
		}
		if(isset($_REQUEST['dends']) && !empty($_REQUEST['dends'])){
			$dends=$_REQUEST['dends'];
		}
		if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
			$month=$_REQUEST['month'];
		}
		if(isset($_REQUEST['year']) && !empty($_REQUEST['year'])){
			$year=$_REQUEST['year'];
		}
 		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('groceries_id','groceries_added_user','groceries_service_date','groceries_starting_balance','groceries_amt_spend','groceries_ending_balance','groceries_address','groceries_upload','groceries_activity_description','groceries_added_date','groceries_latitude','groceries_longitude','groceries_modified_date','groceries_modified_by','groceries_modified_date');
		$sIndexColumn = 'groceries_id';
		$sTable = '_uhs_groceries';
		$sLimit = "";
		if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' ){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		if ( isset( $_GET['iSortCol_0'] ) )
		{
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
			{
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
				{
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
		
		if(empty($subuser)){
			$indParentUsers="";
			if($this->view->user->agency_user_type=="Agency"){
				$systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_id,"fetchAll",array("fields"=>"agency_id"));
				$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
				$indParentUsers=implode_r(",",$systemUsers);
                                if($sWhere){
                                    $sWhere.=" and groceries_added_user IN(".$indParentUsers.") and groceries_individual_id='".$indid."'"; 
                                }
                                else{
                                        $sWhere.=" where groceries_added_user IN(".$indParentUsers.") and groceries_individual_id='".$indid."'"; 
                                }
                                
			}
			else{
				$indParentUsers=$this->view->user->agency_id;
                                if($sWhere){
                                    $sWhere.=" and groceries_individual_id='".$indid."'"; 
                                }
                                else{
                                        $sWhere.=" where groceries_individual_id='".$indid."'"; 
                                }
			}
			
		}
		else{
			if($sWhere){
				$sWhere.=" and groceries_added_user IN(".$subuser.") and groceries_individual_id='".$indid."'"; 
			}
			else{
				$sWhere.=" where groceries_added_user IN(".$subuser.") and groceries_individual_id='".$indid."'"; 
			}
		}
		if(!empty($dstarts)){
			$sWhere.=" and DATE(groceries_service_date) >='".$dstarts."'";
		}
		if(!empty($dends)){
			$sWhere.=" and DATE(groceries_service_date) <='".$dends."'";
		}
		if(!empty($month)){
			$sWhere.=" and MONTH(groceries_service_date)='".$month."'";
		}
		if(!empty($year)){
			$sWhere.=" and YEAR(groceries_service_date)='".$year."'";
		}
		if(!empty($id) && $id!=0){
			$sWhere.=" and groceries_id=".$id;
		}
                
                if(empty($month) && empty($year)){
                    if(!empty($sWhere)){
                            $sWhere.=" and MONTH(groceries_added_date)=MONTH(CURDATE()) and YEAR(groceries_added_date)=YEAR(CURDATE())";
                    }else{
                            $sWhere.=" where MONTH(groceries_added_date)=MONTH(CURDATE()) and YEAR(groceries_added_date)=YEAR(CURDATE())";
                    }
                }
                $sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
 		$qry = $this->dbObj->query($sQuery)->fetchAll();
		$sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
		$output = array(
 				"iTotalRecords" => $iTotal,
				"iTotalDisplayRecords" => $iFilteredTotal,
				"aaData" => array()
			);
		$j=0;
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		foreach($qry as $row1){
			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['groceries_added_user']."'","fetch");
			$modifierData=array();
			if($row1['groceries_modified_by']!=0){
				$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['groceries_modified_by']."'","fetch");
			}
			$row=array();
 			$row[] = $j+1;
			$row[]='<input class="elem_ids checkboxes" type="checkbox" name="records['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';
			$row[]=formatDate($row1['groceries_service_date']); 
			$row[]=$row1['groceries_starting_balance'];
			$row[]=$row1['groceries_amt_spend'];
			$row[]=$row1['groceries_ending_balance']; 
			$lat="'".$row1['groceries_latitude']."'";
			$long="'".$row1['groceries_longitude']."'";
			$address="'".trim(preg_replace('/\s\s+/', ' ',$row1['groceries_address']))."'";
			$row[]=ucwords($row1['groceries_address']).' <i class="fa fa-map-marker markers" title="View Address on Map" onclick="showMap('.$lat.','.$long.','.$address.');"></i>';
			if(!empty($row1['groceries_upload'])){
				$row[]="<a target='_blank' href='".HTTP_STAMP_PATH."/".$row1['groceries_upload']."'>".formatDocumentName($row1['groceries_upload'])."</a>";
			}else{
				$row[]="NA";
			}
			$row[]=$row1['groceries_activity_description'];
			$userType=printUserType($creatorData);
  			$row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
			$row[]=formatDateTimeNew($row1['groceries_added_date']); 
			if(!empty($modifierData)){
				$userType=printUserType($modifierData);
  				$row[]=ucwords($modifierData['agency_first_name']." ".$modifierData['agency_last_name'])."&nbsp;".$userType;
				$row[]=formatDateTimeNew($row1['groceries_modified_date']); 
			}
			else{ 
				$row[]="-";
				$row[]="-";
			}
			$type='"GROCERIES"';
			if(($permissions=="Edit" || $permissions=="Both") && !isFormAssigned($formid,$indid) && date("m")==date("m",strtotime($row1['groceries_added_date']))){
				$row[]="<a style='margin-top:5px;' href='javascript:void(1);' onclick='showDiffrentForms(".$indid.",".$formid.",".$row1[$sIndexColumn].",".$type.");' class='btn btn-xs btn-default'>Edit</a>";
			}
			else{
				$row[]="<b>NA</b>";
			}
 			$output['aaData'][] = $row;
			$j++;
		}
		echo json_encode($output);
		exit();
	}
	
	public function viewassignedgroceriesamountAction(){	
		global $healthSession; 
  		$this->view->pageHeading = "Initial Balance";
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		if(empty($indid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		if(isFormAssigned($formid,$indid)){
			$healthSession->errorMsg="Please assign form to individual first.";
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_groceries_logs");
		}
		$amtData=$this->SuperModel->Super_Get("_uhs_groceries","groceries_form_id=".$formid.' and groceries_individual_id='.$indid.'',"fetch",array("fields"=>"SUM(groceries_amt_spend) as totalSpent"));
		$TotalAssignedAmount=$this->SuperModel->Super_Get("_uhs_groceries_initial_balance","gr_form_id=".$formid." and gr_individual_id=".$indid."","fetch",array("order"=>"grid DESC"));
		
		$this->view->amtData=$amtData;
		$this->view->TotalAssignedAmount=$TotalAssignedAmount;
		$this->view->indid=$indid;
		$this->view->formid=$formid;
  	}
	
	public function getassignedgroceriesamountsAction(){
		if(check_is_ajax($this->_request)){
			$this->_redirect(APPLICATION_URL);
		}
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
			$month=$_REQUEST['month'];
		}
		if(isset($_REQUEST['year']) && !empty($_REQUEST['year'])){
			$year=$_REQUEST['year'];
		}
 		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('grid','gr_form_id','gr_individual_id','gr_initial_balance','gr_remaining_balance','gr_added_date','gr_added_by','gr_modified_on','gr_modified_by');
		$sIndexColumn = 'grid';
		$sTable = '_uhs_groceries_initial_balance';
		$sLimit = "";
		if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' ){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		if ( isset( $_GET['iSortCol_0'] ) )
		{
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
			{
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
				{
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
	
		if($sWhere){
            $sWhere.=" and gr_form_id=".$formid." and gr_individual_id='".$indid."'"; 
        }
      	else{
        	$sWhere.=" where gr_form_id=".$formid." and gr_individual_id='".$indid."'";  
        }
		if(!empty($month)){
			$sWhere.=" and MONTH(gr_added_date)=".$month; 
		}
		if(!empty($year)){
			$sWhere.=" and YEAR(gr_added_date)='".$year."'"; 
		}

		if(empty($month) && empty($year)){
                    if(!empty($sWhere)){
                        $sWhere.=" and MONTH(gr_added_date)=MONTH(CURDATE()) and YEAR(gr_added_date)=YEAR(CURDATE())";
                    }else{
                        $sWhere.=" where MONTH(gr_added_date)=MONTH(CURDATE()) and YEAR(gr_added_date)=YEAR(CURDATE())";
                    }
                }

		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
 		$qry = $this->dbObj->query($sQuery)->fetchAll();
		$sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
		$output = array(
 				"iTotalRecords" => $iTotal,
				"iTotalDisplayRecords" => $iFilteredTotal,
				"aaData" => array()
			);
		$j=0;
		foreach($qry as $row1){
			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$row1['gr_added_by']);
			$modifierData=array();
			if($row1['gr_modified_by']!=0){
				$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['gr_modified_by']."'","fetch");
			}
			$row=array();
 			$row[] = $j+1;
			$row[]='<input class="elem_ids checkboxes" type="checkbox" name="'.$sTable.'['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';
		    $row[]=$row1['gr_initial_balance'];
			$row[]=$row1['gr_remaining_balance'];
			$userType=printUserType($creatorData);
			$row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
			$row[]=formatDate($row1['gr_added_date']);
			if(!empty($modifierData)){
				$userType=printUserType($modifierData);
				$row[]=ucwords($modifierData['agency_first_name']." ".$modifierData['agency_last_name'])."&nbsp;".$userType;
				$row[]=formatDateTime($row1['gr_modified_on']);
			}
			else{
				$row[]="-";
				$row[]="-";
			}
			if(date("m")==date("m",strtotime($row1['gr_added_date']))){
		   		 $row[]="<a style='margin-top:5px;' href='javascript:void(1);' onclick=showDiffrentForms(".$indid.",".$formid.",".$row1[$sIndexColumn].",'AssignedGroceriesBalance'); class='btn btn-xs btn-default'>Edit</a>";
			}
			else{
				$row[]="<b>NA</b>";
			}
 			$output['aaData'][] = $row;
			$j++;
		}
		echo json_encode($output);
		exit();
	}
	
	public function savegroceriesAction(){
		global $healthSession,$systemusers;
		$formid=$this->_getParam("formid");
		$indid=$this->_getParam("indid");
		$id=$this->_getParam("id");
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		if($permissions=="View Only"){
			$healthSession->errorMsg="You don't have permission to access this page.";
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_groceries_logs");
		}
		$getAssignedBalance=$this->SuperModel->Super_Get("_uhs_groceries_initial_balance","gr_form_id='".$formid."' and gr_individual_id='".$indid."'","fetch",array("order"=>"grid DESC"));
		if(empty($getAssignedBalance)){
			$healthSession->errorMsg="You can't add financial log";
			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_groceries_logs");
		}
		$form=new Application_Form_CustomForms();
		$form->Groceries($indid,$formid,$id);
		if($this->getRequest()->isPost()){
			$posted_data = $this->getRequest()->getPost();
			unset($posted_data['MAX_FILE_SIZE']);
   			if($form->isValid($posted_data)){
				$getBalance=$this->SuperModel->Super_Get("_uhs_groceries_initial_balance","gr_form_id=".$formid." and gr_individual_id=".$indid."","fetch",array("order"=>"grid DESC"));
				if(!empty($id)){
					$getfoodData=$this->SuperModel->Super_Get("_uhs_groceries","groceries_form_id=".$formid." and groceries_id!=".$id." and groceries_individual_id=".$indid."","fetchAll",array("order"=>"groceries_id DESC"));
				}
				else{
					$getfoodData=$this->SuperModel->Super_Get("_uhs_groceries","groceries_form_id=".$formid." and groceries_individual_id=".$indid."","fetchAll",array("order"=>"groceries_id DESC"));
				}
				$remainBal=$getBalance['gr_remaining_balance'];
				if(count($getfoodData)>0){
						$totalBal=0;
						foreach($getfoodData as $fin){
							$totalBal+=$fin['groceries_amt_spend'];
						}
						$remainBal=$getBalance['gr_remaining_balance']-$totalBal;
				}
				if($remainBal!=$posted_data['groceries_remaining_balance']){ 
					$posted_data['groceries_remaining_balance']=$remainBal;
					if($posted_data['groceries_amt_spend']>$remainBal){
						$healthSession->errorMsg="Starting balance is not enough";
						$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_groceries_logs");
					}
					$posted_data['groceries_ending_balance']=round($remainBal-$posted_data['groceries_amt_spend'],2);
				}
				$posted_data['groceries_service_date']=date("Y-m-d",strtotime($posted_data['groceries_service_date']));
				if(empty($id)){
					 $indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
					 $agencyData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indData['agency_user_agency_id']);
					 $posted_data['groceries_agency_id']=$agencyData['agency_id'];
					 $posted_data['groceries_individual_id']=$indid;
					 $posted_data['groceries_form_id']=$formid;
					 $posted_data['groceries_added_date']=date('Y-m-d H:i:s');
					 $posted_data['groceries_modified_date']=NULL;
					 $posted_data['groceries_added_user']=$this->view->user->subuser_id; //$this->view->user->agency_id;
					 $isInserted = $this->SuperModel->Super_Insert("_uhs_groceries",$posted_data);
					 if($isInserted->success){
						if(in_array($this->view->user->agency_user_type,$systemusers) && checkNotifySettings($this->view->user->agency_user_agency_id,"form-".$formid)){
							$notifyData=array("notification_user_id"=>$this->view->user->agency_user_agency_id,"notification_type"=>"form-".$formid,"notification_type_id"=>$isInserted->inserted_id,"notification_by_user_id"=>$this->view->user->agency_id,"notification_date"=>date("Y-m-d H:i:s"));
							$isNotify=$this->SuperModel->Super_Insert("_uhs_notifications",$notifyData);
						}
						$healthSession->successMsg  = "Groceries has been added successfully.";
					 }else{
						$healthSession->errorMsg  = $isInserted->message;
					 }
				}
				else{
					$foodData=$this->SuperModel->Super_Get("_uhs_groceries","groceries_id=".$id);
					if(!empty($foodData['groceries_upload']) && $foodData['groceries_upload']!=$posted_data['groceries_upload'] && file_exists(STAMP_PATH.'/'.$foodData['groceries_upload'])){
						unlink(STAMP_PATH.'/'.$foodData['groceries_upload']);
					}
					$posted_data['groceries_modified_date']=date('Y-m-d H:i:s');
					$posted_data['groceries_modified_by']=$this->view->user->subuser_id;
					$isInserted = $this->SuperModel->Super_Insert("_uhs_groceries",$posted_data,"groceries_id=".$id);
					if($isInserted->success){
						$healthSession->successMsg  ="Groceries has been updated successfully.";
					 }else{
						$healthSession->errorMsg  = $isInserted->message;
					 }
				}
				 
   			}else{
				$healthSession->errorMsg = " Please check information again.";
 			}
		 }
		 $this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_groceries_logs");
	}
	
	public function saveassignedgroceriesamtAction(){
		global $healthSession;
		$formid=$this->_getParam("formid");
		$indid=$this->_getParam("indid");
		$id=$this->_getParam("id");
		$form=new Application_Form_CustomForms();
		$form->assignedGroceriesBalance($indid,$formid,$id);
		if($this->getRequest()->isPost()){
			$posted_data = $this->getRequest()->getPost();
   			if($form->isValid($posted_data)){
				$indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
				$agencyData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indData['agency_user_agency_id']);
				if(empty($id)){
					 $foodamtData=$this->SuperModel->Super_Get("_uhs_groceries_initial_balance","gr_individual_id='".$indid."' and gr_form_id='".$formid."'","fetch",array("order"=>"grid DESC"));
					 //$foodamtData=$this->SuperModel->Super_Get("_uhs_food_initial_balance","MONTH(fb_added_date)=MONTH(CURDATE()) and fb_individual_id='".$indid."' and fb_form_id='".$formid."'","fetch",array("order"=>"fbid DESC"));
					 $posted_data['gr_initial_balance']=abs($posted_data['gr_initial_balance']);
					 if(!empty($foodamtData)){
						$posted_data['gr_remaining_balance']=floatval($foodamtData['gr_remaining_balance'])+floatval($posted_data['gr_initial_balance']);
					 }
					 else{
						$posted_data['gr_remaining_balance']=$posted_data['gr_initial_balance'];	
					 }
					 $posted_data['gr_agency_id']=$agencyData['agency_id'];
					 $posted_data['gr_individual_id']=$indid;
					 $posted_data['gr_form_id']=$formid;
					 $posted_data['gr_added_by']=$this->view->user->subuser_id;
					 $posted_data['gr_added_date']=date('Y-m-d');
					 $isInserted = $this->SuperModel->Super_Insert("_uhs_groceries_initial_balance",$posted_data);
					 if($isInserted->success){
						$healthSession->successMsg  = "Initial Balance has been added successfully.";
					 }else{
						$healthSession->errorMsg  = $isInserted->message;
					 }
				}
				else{
					$posted_data['gr_modified_on']=date('Y-m-d H:i:s');
					$posted_data['gr_modified_by']=$this->view->user->subuser_id;
					$posted_data['gr_initial_balance']=abs(round($posted_data['gr_initial_balance']));
					$posted_data['gr_remaining_balance']=round($posted_data['gr_initial_balance']);	
					$isInserted = $this->SuperModel->Super_Insert("_uhs_groceries_initial_balance",$posted_data,"grid=".$id);
					if($isInserted->success){
						 $foodamtData=$this->SuperModel->Super_Get("_uhs_groceries_initial_balance","gr_individual_id='".$indid."' and gr_form_id='".$formid."'","fetchAll",array("order"=>"grid ASC"));
						  if(count($foodamtData) > 0){
							$totalBal=0;
							for($i=0;$i<count($foodamtData);$i++){
								$totalBal+=$foodamtData[$i]['gr_initial_balance'];
								if($i==0){
									$remainBal=$foodamtData[$i]['gr_initial_balance'];
								}
								else if($i<count($foodamtData)-1 && $i>0){
									$remainBal=$foodamtData[$i-1]['gr_initial_balance']+$foodamtData[$i]['gr_initial_balance'];
								}
								else{
									$remainBal=$totalBal;
								}
								$upArr=array('gr_remaining_balance'=>$remainBal);
								$isUpdate=$this->SuperModel->Super_Insert("_uhs_groceries_initial_balance",$upArr,"grid=".$foodamtData[$i]['grid']);
							}
						}
						$healthSession->successMsg  ="Initial Balance has been updated successfully.";
					 }else{
						$healthSession->errorMsg  = $isInserted->message;
					}
				}
   			}else{
				$healthSession->errorMsg = " Please check information again.";
 			}
		 }
		 $this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_assigned_groceries_balance");
	}
	
	public function removegroceriesAction(){
		global $healthSession;
		$indid=$this->_getParam('indid');
		$formid=$this->_getParam('formid');
 		$this->_helper->layout->disableLayout();
		$this->_helper->viewRenderer->setNoRender(true);
		$formData = $this->getRequest()->getPost();
		if(isset($formData['records']) && count($formData['records'])) {
			foreach($formData['records'] as $key=>$values){
  				$isDel=$this->SuperModel->Super_Delete('_uhs_groceries',"groceries_id=".$values);
 				$healthSession->successMsg="Groceries(s) has been deleted successfully.";
			}
		}
		else{
			$healthSession->errorMsg = "Invalid Request.";
		}
		$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_groceries_logs");
	}
	
	public function removeassignedgroceriesamtAction(){
		global $healthSession;
		$indid=$this->_getParam('indid');
		$formid=$this->_getParam('formid');
 		$this->_helper->layout->disableLayout();
		$this->_helper->viewRenderer->setNoRender(true);
		$formData = $this->getRequest()->getPost();
		if(isset($formData['_uhs_groceries_initial_balance']) && count($formData['_uhs_groceries_initial_balance'])) {
			foreach($formData['_uhs_groceries_initial_balance'] as $key=>$values){
  				$isDel=$this->SuperModel->Super_Delete('_uhs_groceries_initial_balance',"grid=".$values);
			}
			$foodamtData=$this->SuperModel->Super_Get("_uhs_groceries_initial_balance","gr_individual_id='".$indid."' and gr_form_id='".$formid."'","fetchAll",array("order"=>"grid ASC"));
			if(count($foodamtData) > 0){
							$totalBal=0;
							for($i=0;$i<count($foodamtData);$i++){
								$totalBal+=$foodamtData[$i]['gr_initial_balance'];
								if($i==0){
									$remainBal=$foodamtData[$i]['gr_initial_balance'];
								}
								else if($i<count($foodamtData)-1 && $i>0){
									$remainBal=$foodamtData[$i-1]['gr_initial_balance']+$foodamtData[$i]['gr_initial_balance'];
								}
								else{
									$remainBal=$totalBal;
								}
								$upArr=array('gr_remaining_balance'=>$remainBal);
								$isUpdate=$this->SuperModel->Super_Insert("_uhs_groceries_initial_balance",$upArr,"grid=".$foodamtData[$i]['grid']);
							}
						}
			$healthSession->successMsg="Assigned Groceries Amount Log(s) has been deleted successfully.";
		}
		else{
			$healthSession->errorMsg="Invalid Request.";
		}
		$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_assigned_groceries_balance");
	}
	
	public function savegroceriesdocumentAction(){
		global $healthSession;
		$formid=$this->_getParam('formid');
		$extarr=explode(".",$_FILES['upload_file']['name']);
		$ext=array('doc','docx','xls','xlsx','pdf','DOC','DOCX','XLS','XLSX','PDF','jpg','JPG','png','PNG','jpeg','JPEG');
		if(!in_array($extarr[count($extarr)-1],$ext)){
			echo 'extention error';
		}
		else{
			$is_uploaded = $this->_handle_document($formid);
			if(count($is_uploaded->media_path)>0){
				echo json_encode($is_uploaded->media_path);
			}
			else{
				echo json_encode('error');
			}
		}
		exit();
	}
	
	private function _groceries_log($indData,$ids,$formid,$extra=array()){
		global $months;
		$userCond="";
		if($this->view->user->agency_user_type!="Agency"){ $userCond="groceries_added_user='".$this->view->user->agency_id."' and ";}
		if($ids!=="All"){
			$data=$this->SuperModel->Super_Get("_uhs_groceries","groceries_id In(".$ids.")","fetchAll");
		}
		else{
			$data=$this->SuperModel->Super_Get("_uhs_groceries","".$userCond." groceries_individual_id=".$indData['agency_id']." and MONTH(groceries_service_date)=".$extra['month']." and YEAR(groceries_service_date)='".$extra['year']."'","fetchAll");
		}
		$html="";
		
		if(count($data)>0){
			$html.= $this->_report_header("Groceries",$indData);
			$html.="<h5>Individual Information: ".ucwords($indData['agency_first_name']." ".$indData['agency_last_name']).",".$indData['agency_city'].",".$indData['agency_state'].",".$indData['agency_zip']."</h5>
			 	   </div>";
			$html.="<table class='table table-bordered' cellspacing='10' cellpadding='20' width='100%'>
					<tr>
						<th style='padding:0.3%;' width='12.5%'>Date Of Service</th>
						<th style='padding:0.3%;' width='12.5%'>Account</th>
						<th style='padding:0.3%;' width='12.5%'>Credit($)</th>
						<th style='padding:0.3%;' width='12.5%'>Amount Spend($)</th>
						<th style='padding:0.3%;' width='12.5%'>Ending Balance($)</th>
						<th style='padding:0.3%;' width='12.5%'>Where</th>
						<th style='padding:0.3%;' width='12.5%'>Activity Description</th>
						<th style='padding:0.3%;' width='12.5%'>Created By</th>
						<th style='padding:0.3%;' width='12.5%'>Created On</th>
				   </tr>";
			foreach($data as $data){
				$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$data['groceries_added_user']);
				$html.="<tr>
							<td style='padding:0.3%;'>".formatDate($data['groceries_service_date'])."</td>
							<td style='padding:0.3%;'>Groceries</td>
							<td style='padding:0.3%;'>".$data['groceries_remaining_balance']."</td>
							<td style='padding:0.3%;'>".$data['groceries_amt_spend']."</td>
							<td style='padding:0.3%;'>".$data['groceries_ending_balance']."</td>
							<td style='padding:0.3%;'>".ucwords($data['groceries_address'])."</td>
							<td style='padding:0.3%;'>".$data['groceries_activity_description']."</td>
							<td style='padding:0.3%;'>".ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."</td>
							<td style='padding:0.3%;'>".formatDateTimeNew($data['groceries_added_date'])."</td>
				  	  </tr>";	
			}
			$html.="</table>";
			if($ids=="All"){
				$html.="<pagebreak />";
			}
		}else{
			$html.= "";
		}
		return $html;
	}
	


    // END Outcome
    
    /* Manage Digest List */
    public function digestlistAction(){
            $this->view->pageHeading = "Manage Xoomia Digest";
    }
    public function getdigestlistsAction(){
            $this->dbObj = Zend_Registry::get('db');
            $aColumns = array( 'help_id','help_title','help_media','help_desc','help_added_date','help_image');
            $sIndexColumn = 'help_id';
            $sTable = '_uhs_digest';
            $sLimit = "";
            if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' ){
                    $sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
            }
            $sOrder = "";
            if ( isset( $_GET['iSortCol_0'] ) ){
                    $sOrder = "ORDER BY  ";
                    for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ ){
                            if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" ){
                                    $sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
                                            ($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
                            }
                    }
                    $sOrder = substr_replace( $sOrder, "", -2 );
                    if ( $sOrder == "ORDER BY" ){
                            $sOrder = "";
                    }
            }
            $sWhere = "";
            if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
                    $sWhere = "WHERE (";
                    for ( $i=0 ; $i<count($aColumns) ; $i++ ){
                            $sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; 
                    }
                    $sWhere = substr_replace( $sWhere, "", -3 );
                    $sWhere .= ')';
            }
            for ( $i=0 ; $i<count($aColumns) ; $i++ ){
                    if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' ){
                            if ( $sWhere == "" ){
                                    $sWhere = "WHERE ";
                            }
                            else{
                                    $sWhere .= " AND ";
                            }
                            $sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%'";
                    }
            }
            $sQuery = " SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM   $sTable $sWhere $sOrder $sLimit";
            $qry = $this->dbObj->query($sQuery)->fetchAll();
            $sQuery = "SELECT FOUND_ROWS() as fcnt";
            $aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
            $iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
            $sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
            $rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
            $iTotal = $rResultTotal[0]['cnt'];
            $output = array(
                            "iTotalRecords" => $iTotal,
                            "iTotalDisplayRecords" => $iFilteredTotal,
                            "aaData" => array()
                    );
            $j=0;
            foreach($qry as $row1){
                    $row=array();
                    $row[] = $j+1;
                    $row[]='<input class="elem_ids checkboxes"  type="checkbox" name="'.$sTable.'['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';
                    $row[]=ucwords($row1['help_title']);
                    $help_image="";
                    $help_media="";
                    $help_desc="";
                    
                    if(!empty($row1['help_image'])){
                            $help_image='<a style="margin-top:5px; display:block;" href="'.HTTP_DIGEST_IMAGES_PATH.'/'.$row1['help_image'].'" target="_blank">'.formatDocumentName($row1['help_image']).'</a>';
                    }
                    else{
                            $help_image="";
                    }
                    if(!empty($row1['help_media'])){
                            $help_media='<a style="margin-top:5px; display:block;" href="'.HTTP_DIGEST_VIDEO_PATH.'/'.$row1['help_media'].'" target="_blank">'.formatDocumentName($row1['help_media']).'</a>';
                    }
                    else{
                            $help_media="";
                    }
                    if(!empty($row1['help_desc'])){
                            $strlen = strlen($row1['help_desc']);
                            if($strlen > 100){
                                $str = substr($row1['help_desc'],0, 100);
                                $help_desc= $str."..."." "."<a href='#' onclick='readMore($row1[$sIndexColumn]);'>Read more</a>";
                            }else{
                                $help_desc= $row1['help_desc'];
                            }
                            
                    }
                    else{
                            $help_desc="";
                    }
                    $row[]='<span id="rdm_'.$row1[$sIndexColumn].'">'.$help_desc." ".$help_image." ".$help_media.'</span>'.'<span style="display:none;"id="rdms_'.$row1[$sIndexColumn].'">'.$row1['help_desc']." ".$help_image." ".$help_media.'</span>';
                    $row[]="";
                    $row[]=formatDateTime($row1['help_added_date']);
                    $row[]="";
                    $row[]="";
                    //$row[]='<a class="btn btn-xs btn-default" href="'.APPLICATION_URL.'/admin/edit-digest/'.$row1[$sIndexColumn].'"><i class="fa fa-edit"></i> Edit </a>';
                    $output['aaData'][] = $row;
                    $j++;
            }
            echo json_encode($output);
            exit();
    }
    
   public function saveincidenttrendcommentAction(){
		global $healthSession;
		$indid=$_REQUEST['indid'];
		$formid=$_REQUEST['formid'];
		
		$agency_data = $this->SuperModel->Super_Get("_uhs_agency","agency_id=".$this->view->user->agency_id);		
		$commented_by = ucwords($agency_data['agency_first_name']." ".$agency_data['agency_last_name']);
		
		$comment=$_REQUEST['comment']."~~".date('Y-m-d H:i:s')."~~".$commented_by;
		$oldcommentdata=$this->SuperModel->Super_Get("_uhs_incidents_reports"," incident_individual_id=".$indid." and incident_form_id=".$formid,"fetchAll");
		if(!empty($oldcommentdata[0]['incident_trend_comment'])){
		  $appendcommentData = $oldcommentdata[0]['incident_trend_comment']."|!|".$comment;		
	    }else{
			$appendcommentData = $comment;			
		}
		$data = array("incident_trend_comment"=>$appendcommentData);
		$isUpdate=$this->SuperModel->Super_Insert("_uhs_incidents_reports",$data,"incident_individual_id=".$indid." and incident_form_id=".$formid);
		if($isUpdate->success){
			echo "1";
		}else{
			echo "0";
		}
		exit();
	}
	
	public function getincidenttrendcommentAction(){
		global $healthSession;
		$indid=$_REQUEST['indid'];
		$formid=$_REQUEST['formid'];
		$data=$this->SuperModel->Super_Get("_uhs_incidents_reports"," incident_individual_id=".$indid." and incident_form_id=".$formid,"fetchAll");
		if(!empty($data[0]['incident_trend_comment'])){
			echo $data[0]['incident_trend_comment'];
		}else{
			echo "0";
		}
		exit();
	}
	
	public function incidenttrendemailformAction(){
		global $healthSesion;
		$indid=$_REQUEST['indid'];
		$formid=$_REQUEST['formid'];
		$month=$_REQUEST['month'];
		$year=$_REQUEST['year'];
		//$chart=$_REQUEST['chart'];
		$form=new Application_Form_CustomForms();
		$form->incidenttrendEmail($indid,$formid,$month,$year);
		echo "Send Incident Trend Report"."~~".$form;
		exit();
	}
	
		public function sendincidenttrendemailAction(){
		global $healthSession;
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$month=$this->_getParam("month");
		$year=$this->_getParam("year");
		$form=new Application_Form_CustomForms();
		$form->incidenttrendEmail($indid,$formid,$month,$year);
		if($this->getRequest()->isPost()){
			$posted_data = $this->getRequest()->getPost();
   			if($form->isValid($posted_data)){ 
				$incidentData=$this->SuperModel->Super_Get("_uhs_incidents_reports","MONTH(report_created_on)='".$month."' and YEAR(report_created_on)='".$year."' and incident_individual_id=".$indid." and incident_form_id=".$formid, "fetchAll");
				$data=$this->SuperModel->Super_Get("_uhs_incidents_reports"," incident_individual_id=".$indid." and incident_form_id=".$formid,"fetchAll");
				if(!empty($data[0]['incident_trend_comment'])){
					$comment = $data[0]['incident_trend_comment'];
				}
				$agency_email=$this->view->user->agency_email; //19-feb-2018
				$emailData['receiver_emails']=$posted_data['receiver_emails'];
				$emailData['email_subject']=$posted_data['email_subject'];
				$emailData['email_msg']=$posted_data['email_msg'];
				$emailData['agency_email'] = $agency_email;//19-feb-2018
			//	$chart = $posted_data['trendchart'];
				$isSend=$this->modelEmail->sendIncidenttrendReport($incidentData,$indid,$emailData,$comment);
				if($isSend->success){
                                    
                                        //Start code added by amit on 07-may-2018 with save send email info
                                        if(!empty($posted_data['receiver_emails'])){
                                            $receiver_emails= $posted_data['receiver_emails'];
                                            $receiver_emails= explode(",", $receiver_emails);
                                            $msg_group_code=getRandomString(6);
                                            foreach ($receiver_emails as $key => $receiver_email) {
                                                $receiver_email = trim($receiver_email);
                                                $agencyData=$this->SuperModel->Super_Get("_uhs_agency","agency_email='".$receiver_email."'","fetch");
                                                if(!empty($agencyData)){
                                                    $msg_receiver_id="";
                                                    $msg_receiver_id = $agencyData['agency_id'];
                                                    $posted_data_msg['msg_sender_id']=$this->view->user->subuser_id;
                                                    $posted_data_msg['msg_send_date']=date('Y-m-d H:i:s');
                                                    $posted_data_msg['msg_receiver_id']=$msg_receiver_id;
                                                    $posted_data_msg['msg_group_code'] = $msg_group_code;
                                                    $posted_data_msg['msg_subject'] = $posted_data['email_subject'];
                                                    $posted_data_msg['msg_text'] = $posted_data['email_msg'];
                                                    $isInserted = $this->SuperModel->Super_Insert("_uhs_messages",$posted_data_msg);
                                                    if($isInserted->success){
                                                         $healthSession->successMsg="Message has been sent successfully.";
                                                    }else{
                                                           $healthSession->errorMsg  = $isInserted->message;
                                                    }
                                                }
                                            }
                                        }
                                        //Start code added by amit on 07-may-2018 with save send email info
                                    
                                        $healthSession->successMsg  = "Incident report has been sent successfully.";
				}
				else{
					$healthSession->errorMsg = " Please check information again.";
				}
   			}else{
				$healthSession->errorMsg = " Please check information again.";
 			}
		 }
		 $this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_incident_reports");
	}	
        
        // Start code added by amit on 16-May-2018 with HPC Notes 
        
	public function personalcarenoteAction(){
		global $healthSession,$systemusers; 
  		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		if(empty($indid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		if($this->view->user->agency_user_type == "Agency") {
                    $agencyid=$this->view->user->agency_id;
                    $ratioview_data = $this->SuperModel->Super_Get("_uhs_ratio_view", "ratio_agency_id='".$agencyid."' AND ratio_indid='".$indid."' AND ratio_form_id='".$formid."' ", "fetch");
                    if(!empty($ratioview_data)){
                        $this->view->ratio_status = $ratioview_data['ratio_status'];
                        $this->view->ratio_id = $ratioview_data['ratio_id'];
                    }else {
                        $this->view->ratio_status = 0;
                        $this->view->ratio_id = 0;
                     }
               } elseif(in_array($this->view->user->agency_user_type,$systemusers)) {
                       $agencyid=$this->view->user->agency_user_agency_id;
                       $ratioview_data = $this->SuperModel->Super_Get("_uhs_ratio_view", "ratio_agency_id='".$agencyid."' AND ratio_indid='".$indid."' AND ratio_form_id='".$formid."' ", "fetch");
                       if(!empty($ratioview_data)){
                          $this->view->ratio_status = $ratioview_data['ratio_status'];
                       } else {
                        $this->view->ratio_status = 0;
                       }
               }
                $this->view->permissions=$permissions;
		$this->view->indid=$indid;
		$this->view->formid=$formid;
		$this->view->id=$id;
                if($formid==27){
                    $this->view->pageHeading = "ADS Notes";
                    $this->view->type="Ads";
                } else {
                    $this->view->pageHeading = "HPC Notes";
                    $this->view->type="Care";
                }
                $this->view->agency_user_type=$this->view->user->agency_user_type;
                
	}
        
        
        
        public function gethpcnoteAction(){
                global $systemusers;
		if(check_is_ajax($this->_request)){
			$this->_redirect(APPLICATION_URL);
		}
		$type=$this->_getParam('type');
                
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
                if($this->view->user->agency_user_type=="Agency"){
                    $ratioview_status=0;
                    $agencyid=$this->view->user->agency_id;
                    $ratioview_data = $this->SuperModel->Super_Get("_uhs_ratio_view", "ratio_agency_id='".$agencyid."' AND ratio_indid='".$indid."' AND ratio_form_id='".$formid."' ", "fetch");
                    if(!empty($ratioview_data) && !empty($ratioview_data['ratio_status'])){
                            $ratioview_status=$ratioview_data['ratio_status'];
                    }
                }elseif(in_array($this->view->user->agency_user_type,$systemusers)) {
                    $ratioview_status=0;
                    $agencyid=$this->view->user->agency_user_agency_id;
                    $ratioview_data = $this->SuperModel->Super_Get("_uhs_ratio_view", "ratio_agency_id='".$agencyid."' AND ratio_indid='".$indid."' AND ratio_form_id='".$formid."' ", "fetch");
                    if(!empty($ratioview_data) && !empty($ratioview_data['ratio_status'])){
                            $ratioview_status=$ratioview_data['ratio_status'];
                    } 
                }
                
                
		if($formid==27){
                    $type="Ads";
                } else {
                    $type='Care';
                }
		$subuser=$dstarts=$dends="";
		if(isset($_REQUEST['subuser']) && !empty($_REQUEST['subuser'])){
			$subuser=$_REQUEST['subuser'];
		}
		if(isset($_REQUEST['dstarts']) && !empty($_REQUEST['dstarts'])){
			$dstarts=$_REQUEST['dstarts'];
		}
		if(isset($_REQUEST['dends']) && !empty($_REQUEST['dends'])){
			$dends=$_REQUEST['dends'];
		}
		if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
			$month=$_REQUEST['month'];
		}
		if(isset($_REQUEST['year']) && !empty($_REQUEST['year'])){
			$year=$_REQUEST['year'];
		}
                
                $this->dbObj = Zend_Registry::get('db');
		$aColumns = array('task_id','task_form_id','task_agency_id','task_individual_id','task_added_user','task_support_id','is_task_done','task_comments','task_added_date','task_type','task_results','is_task_entry_completed','task_total_service_time','task_start_time','task_end_time','task_modified_by','task_modified_on','task_staff_no','task_individual_no');
		$sIndexColumn = 'task_id';
		$sTable = '_uhs_task_entries';
		$sLimit = "";
		if(isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength']!='-1'){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		if ( isset( $_GET['iSortCol_0'] ) ){
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
			{
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
				{
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
		
			$indParentUsers="";
			if($this->view->user->agency_user_type=="Agency"){
				$systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_id,"fetchAll",array("fields"=>"agency_id"));
				$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
				$indParentUsers=implode_r(",",$systemUsers);
			}
			else{
				$systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_user_agency_id,"fetchAll",array("fields"=>"agency_id"));
				$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
				$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_user_agency_id;
				$indParentUsers=implode_r(",",$systemUsers);
				//$indParentUsers=$this->view->user->agency_id.",".$this->view->user->agency_user_agency_id;
			}
			if($sWhere){
				$sWhere.=" and task_added_user IN(".$indParentUsers.") and task_individual_id='".$indid."' and task_type='".$type."'"; 
			}
			else{
				$sWhere.=" where task_added_user IN(".$indParentUsers.") and task_individual_id='".$indid."' and task_type='".$type."'"; 
			}
		
		
                        if(!empty($dstarts)){
                                $sWhere.=" and DATE(task_added_date) >='".$dstarts."'";
                        }
                        if(!empty($dends)){
                                $sWhere.=" and DATE(task_added_date) <='".$dends."'";
                        }
                        if(!empty($month)){
                                $sWhere.=" and MONTH(task_added_date)='".$month."'";
                        }
                        if(!empty($year)){
                                $sWhere.=" and YEAR(task_added_date)='".$year."'";
                        }
                        if(!empty($id) && $id!=0){
                                $sWhere.=" and task_id=".$id;
                        }
		
                    if(!empty($sWhere)){
                        $sWhere.=" and MONTH(task_added_date)=MONTH(CURDATE()) and YEAR(task_added_date)=YEAR(CURDATE())";
                    }else{
                        $sWhere.=" where MONTH(task_added_date)=MONTH(CURDATE()) and YEAR(task_added_date)=YEAR(CURDATE())";
                    }
               
		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
 		$qry = $this->dbObj->query($sQuery)->fetchAll();
		$sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
		$output = array(
 				"iTotalRecords" => $iTotal,
				"iTotalDisplayRecords" => $iFilteredTotal,
				"aaData" => array()
			);
		$j=0;
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		foreach($qry as $row1){
			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['task_added_user']."'","fetch");
			$suportData=$this->SuperModel->Super_Get("_uhs_supports","support_id=".$row1['task_support_id'],"fetch");
			$modifierData=array();
			if($row1['task_modified_by']!=0){
				$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['task_modified_by']."'","fetch");
			}
			$taskStatus="";
			if($row1['is_task_entry_completed']=='0'){ $taskStatus="<br/><span class='badge badge-danger'>Not Completed</span>";}
			$row=array();
 			$row[] = $j+1;
			$row[]='<input class="elem_ids checkboxes" type="checkbox" name="_uhs_task_entries['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';
                        
                        $row[]=$suportData['support_description'].$taskStatus;
			if($this->view->user->agency_user_type=="Agency" || (in_array($this->view->user->agency_user_type,$systemusers))){
                            if(!empty($ratioview_status)){
                                if($formid==2){
                                    $row[]=isEmpty($row1['task_start_time'],"-");
                                    $row[]=isEmpty($row1['task_end_time'],"-");
                                    $row[]=isEmpty($row1['task_total_service_time'],'-');
                                }
                                if($formid==27){
                                    $row[]=isEmpty($row1['task_start_time'],"-");
                                    $row[]=isEmpty($row1['task_end_time'],"-");
                                    $row[]=isEmpty($row1['task_total_service_time'],'-');
                                }
                            }
                        }
			
			$bclass="";
			if($row1['is_task_done']=="Yes" || $row1['is_task_done']=="Administered" || $row1['is_task_done']=="+"){ 
                            $bclass="badge-success";
                        }
                        else{
                            $bclass="badge-danger";
                        }
                        if($row1['is_task_done']=="Yes"){
                                $is_task_done_val = "Completed";
                        } else if($row1['is_task_done']=="No"){
                                $is_task_done_val = "Not Completed";
                        } else{
                            $is_task_done_val = $row1['is_task_done'];
                        }
                        
			$row[]="<span class='badges badge ".$bclass."'>".ucwords($is_task_done_val)."</span>";
			//$row[]=isEmpty($row1['task_comments']);
                        
                        if($this->view->user->agency_user_type=="Agency" || (in_array($this->view->user->agency_user_type,$systemusers))){
                            if(!empty($ratioview_status)){
                                $row[]=$row1['task_staff_no']." : ".$row1['task_individual_no'];
                            }
                        }
			
                        
			$userType=printUserType($creatorData); 
			$row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
			//$row[]=formatDateTimeNew($row1['task_added_date'])."<span style='display:none;'>".$row1['task_added_date']."</span>"; 
			$row[]=formatDate(date('Y-m-d', strtotime($row1['task_added_date'])));
			
                        if($formid==27){
                            $row[]=date('H:i a', strtotime($row1['task_added_date']));
                        } else {
                            $row[]=date('H:i:s', strtotime($row1['task_added_date']));
                        }
                        $row[]=isEmpty($row1['task_comments']);
                        $row[]=$row1['shift'];
                        if($this->view->user->agency_user_type=="Agency" || (in_array($this->view->user->agency_user_type,$systemusers))){
                            if(!empty($ratioview_status)){
                                $row[]="Staff"." ".$row1['task_staff_no']." :  Individual ".$row1['task_individual_no'];
                            }
                        }
			
                        if(!empty($modifierData)){
				$userType=printUserType($modifierData);
				$row[]=ucwords($modifierData['agency_first_name']." ".$modifierData['agency_last_name'])."&nbsp;".$userType;
				$row[]=formatDateTime($row1['task_modified_on']);
			}else{
				$row[]="-";
				$row[]="-";
			}
                        $row[]=$row1['task_added_date'];
                        $output['aaData'][] = $row;
			$j++;
		}
                
                ///////////////////////////////////////////////////  BY amit
                $type=$this->_getParam('type');
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		$subuser=$dstarts=$dends="";
		if(isset($_REQUEST['subuser']) && !empty($_REQUEST['subuser'])){
			$subuser=$_REQUEST['subuser'];
		}
		if(isset($_REQUEST['dstarts']) && !empty($_REQUEST['dstarts'])){
			$dstarts=$_REQUEST['dstarts'];
		}
		if(isset($_REQUEST['dends']) && !empty($_REQUEST['dends'])){
			$dends=$_REQUEST['dends'];
		}
		if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
			$month=$_REQUEST['month'];
		}
		if(isset($_REQUEST['year']) && !empty($_REQUEST['year'])){
			$year=$_REQUEST['year'];
		}
 		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('usc_id','support_id','shift','comment','shift_option','is_amended','indid','formid','start_time','end_time','total_units','staff_ration','individual_ration','added_by','created_at','modified_by','modified_on');
		$sIndexColumn = 'usc_id';
		$sTable = '_uhs_supports_charting';
		$sLimit = "";
		if(isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength']!='-1'){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		if ( isset( $_GET['iSortCol_0'] ) ){
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
			{
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
				{
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
		if(empty($subuser)){
			$indParentUsers="";
			if($this->view->user->agency_user_type=="Agency"){
				$systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_id,"fetchAll",array("fields"=>"agency_id"));
				$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
				$indParentUsers=implode_r(",",$systemUsers);
			}
			else{
				$systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_user_agency_id,"fetchAll",array("fields"=>"agency_id"));
				$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
				$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_user_agency_id;
				$indParentUsers=implode_r(",",$systemUsers);
				//$indParentUsers=$this->view->user->agency_id.",".$this->view->user->agency_user_agency_id;
			}
			if($sWhere){
				$sWhere.=" and added_by IN(".$indParentUsers.") and indid='".$indid."' and formid='".$formid."'"; 
			}
			else{
				$sWhere.=" where added_by IN(".$indParentUsers.") and indid='".$indid."' and formid='".$formid."'"; 
			}
		}
		else{
			if($sWhere){
				$sWhere.=" and added_by IN(".$subuser.") and indid='".$indid."' and formid='".$formid."'"; 
			}
			else{
				$sWhere.=" where added_by IN(".$subuser.") and indid='".$indid."' and formid='".$formid."'"; 
			}
		}
		if(!empty($dstarts)){
			$sWhere.=" and DATE(created_at) >='".$dstarts."'";
		}
		if(!empty($dends)){
			$sWhere.=" and DATE(created_at) <='".$dends."'";
		}
		if(!empty($month)){
			$sWhere.=" and MONTH(created_at)='".$month."'";
		}
		if(!empty($year)){
			$sWhere.=" and YEAR(created_at)='".$year."'";
		}
		if(!empty($id) && $id!=0){
			$sWhere.=" and task_id=".$id;
		}
		if(empty($month) && empty($year)){
                    if(!empty($sWhere)){
                        $sWhere.=" and MONTH(created_at)=MONTH(CURDATE()) and YEAR(created_at)=YEAR(CURDATE())";
                    }else{
                        $sWhere.=" where MONTH(created_at)=MONTH(CURDATE()) and YEAR(created_at)=YEAR(CURDATE())";
                    }
                }
		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
 		$qry = $this->dbObj->query($sQuery)->fetchAll();
		$sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
//		$output = array(
// 				"iTotalRecords" => $iTotal,
//				"iTotalDisplayRecords" => $iFilteredTotal,
//				"aaData" => array()
//			);
                
                
                
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		foreach($qry as $row1){
			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['added_by']."'","fetch");
			$suportData=$this->SuperModel->Super_Get("_uhs_supports","support_id=".$row1['support_id'],"fetch");
			$modifierData=array();
			if($row1['modified_by']!=0){
				$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['modified_by']."'","fetch");
			}
			$taskStatus="";
			//if($row1['is_task_entry_completed']=='0'){ $taskStatus="<br/><span class='badge badge-danger'>Not Completed</span>";}
			$row=array();
 			$row[] = $j+1;
			$row[]='<input class="elem_ids checkboxes" type="checkbox" name="_uhs_supports_charting['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';
                        $row[]=$suportData['support_description'].$taskStatus;
			if($this->view->user->agency_user_type=="Agency" || (in_array($this->view->user->agency_user_type,$systemusers))){
                            if(!empty($ratioview_status)){
                                if($formid==2){
                                    $row[]=isEmpty($row1['start_time'],"-");
                                    $row[]=isEmpty($row1['end_time'],"-");
                                    $row[]=isEmpty($row1['total_units'],'-');
                                }
                                if($formid==27){
                                    $row[]=isEmpty($row1['start_time'],"-");
                                    $row[]=isEmpty($row1['end_time'],"-");
                                    $row[]=isEmpty($row1['total_units'],'-');
                                }
                            }
                        }
			
			$bclass="";
			
                        if($row1['shift_option']=="C" || $row1['shift_option']=="A" || $row1['shift_option']=="+"){ 
                            $bclass="badge-success";
                        }
                        else{
                            $bclass="badge-danger";
                        }
                        if($row1['shift_option']=="C"){
                                $shift_option_val = "Completed";
                        } else if($row1['shift_option']=="NC"){
                                $shift_option_val = "Not Completed";
                        }
                        else if($row1['shift_option']=="A"){
                                $shift_option_val = "Administered";
                        }
                         else if($row1['shift_option']=="NA"){
                                $shift_option_val = "Not Administered";
                        }
                        else if($row1['shift_option']=="R"){
                                $shift_option_val = "Refuse";
                        }
                        else{
                            $shift_option_val = $row1['shift_option'];
                        }
                        $is_amended="";
                        if($row1['is_amended'] == 1){
                            $is_amended="Amended";
                        }
                        $row[]="<span class='badges badge ".$bclass."'>".ucwords($shift_option_val)."</span><BR>$is_amended";
			if($this->view->user->agency_user_type=="Agency" || (in_array($this->view->user->agency_user_type,$systemusers))){
                            if(!empty($ratioview_status)){
                                $row[]=$row1['staff_ration']." : ".$row1['individual_ration'];
                            }
                        }
                        
                        
			$userType=printUserType($creatorData); 
			$row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
			//$row[]=formatDateTimeNew($row1['created_at'])."<span style='display:none;'>".$row1['created_at']."</span>"; 
			$row[]=formatDate(date('Y-m-d', strtotime($row1['created_at'])));
                        if($formid==27){
                            $row[]=date('H:i a', strtotime($row1['created_at']));
                        } else {
                            $row[]=date('H:i:s', strtotime($row1['created_at']));
                        }
                        $row[]=isEmpty($row1['comment']);
			$row[]=$row1['shift'];
                        if($this->view->user->agency_user_type=="Agency" || (in_array($this->view->user->agency_user_type,$systemusers))){
                            if(!empty($ratioview_status)){
                                $row[]="Staff ".$row1['staff_ration']." :  Individual ".$row1['individual_ration'];
                            }
                        }
			
			
			if(!empty($modifierData)){
				$userType=printUserType($modifierData);
				$row[]=ucwords($modifierData['agency_first_name']." ".$modifierData['agency_last_name'])."&nbsp;".$userType;
				$row[]=formatDateTime($row1['modified_on']);
			}else{
				$row[]="-";
                                if(!empty($row1['modified_on'])){
                                    $row[]=formatDateTime($row1['modified_on']);
                                } else {
                                    $row[]="-";
                                }
			}
                        $row[]=$row1['created_at'];
                        $output['aaData'][] = $row;
			$j++;
		}
                
                
                
                ///////////////////////////////////////////////////  BY amit
                //prd($output);
                $sortarray = array();
                
                foreach ($output['aaData'] as $key => $row)
                {
                    $sortarray[$key] = $row[16];
                }
                array_multisort($sortarray, SORT_DESC, $output['aaData']);
                echo json_encode($output);
		exit();
	}
        
        public function sendhpcnotemailAction(){
            
            if($this->getRequest()->isPost()){
                ini_set('memory_limit', '-1');
                ini_set('max_execution_time', 500);
                $data = $this->getRequest()->getPost();
                global $healthSession;
                
                $indid=$this->_getParam("indid");
                $formid=$this->_getParam("formid");
                $id=$this->_getParam("id");
                if($formid==27){
                    $type='Ads';
                } else {
                    $type='Care';
                }
 		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('task_id','task_form_id','task_agency_id','task_individual_id','task_added_user','task_support_id','is_task_done','task_comments','task_added_date','task_type','task_results','is_task_entry_completed','task_total_service_time','task_start_time','task_end_time','task_modified_by','task_modified_on');
		$sIndexColumn = 'task_id';
		$sTable = '_uhs_task_entries';
		$sLimit = "";
		
		$sWhere = "";
		
                $indParentUsers="";
                if($this->view->user->agency_user_type=="Agency"){
                        $systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_id,"fetchAll",array("fields"=>"agency_id"));
                        $systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
                        $indParentUsers=implode_r(",",$systemUsers);
                }
                else{
                        $systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_user_agency_id,"fetchAll",array("fields"=>"agency_id"));
                        $systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
                        $systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_user_agency_id;
                        $indParentUsers=implode_r(",",$systemUsers);
                        //$indParentUsers=$this->view->user->agency_id.",".$this->view->user->agency_user_agency_id;
                }
                if($sWhere){
                        $sWhere.=" and task_added_user IN(".$indParentUsers.") and task_individual_id='".$indid."' and task_type='".$type."'"; 
                }
                else{
                        $sWhere.=" where task_added_user IN(".$indParentUsers.") and task_individual_id='".$indid."' and task_type='".$type."'"; 
                }
//		if(!empty($id) && $id!=0){
//			$sWhere.=" and task_id=".$id;
//		}
		if(!empty($sWhere)){
                    $sWhere.=" and MONTH(task_added_date)=MONTH(CURDATE()) and YEAR(task_added_date)=YEAR(CURDATE())";
                }else{
                    $sWhere.=" where MONTH(task_added_date)=MONTH(CURDATE()) and YEAR(task_added_date)=YEAR(CURDATE())";
                }
               
		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sLimit";
 		$qry = $this->dbObj->query($sQuery)->fetchAll();
		$row=array();
                if(!empty($qry)){
                    foreach($qry as $row1){

                            $row[]= $row1[$sIndexColumn];
                    }
                }
                
                $aColumns = array('usc_id','support_id','shift','comment','shift_option','is_amended','indid','formid','start_time','end_time','total_units','staff_ration','individual_ration','added_by','created_at');
		$sIndexColumn = 'usc_id';
		$sTable = '_uhs_supports_charting';
		$sLimit = "";
		$sOrder = "";
		$sWhere = "";
		$indParentUsers="";
                if($this->view->user->agency_user_type=="Agency"){
                        $systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_id,"fetchAll",array("fields"=>"agency_id"));
                        $systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
                        $indParentUsers=implode_r(",",$systemUsers);
                }
                else{
                        $systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_user_agency_id,"fetchAll",array("fields"=>"agency_id"));
                        $systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
                        $systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_user_agency_id;
                        $indParentUsers=implode_r(",",$systemUsers);
                        //$indParentUsers=$this->view->user->agency_id.",".$this->view->user->agency_user_agency_id;
                }
                if($sWhere){
                        $sWhere.=" and added_by IN(".$indParentUsers.") and indid='".$indid."' and formid='".$formid."'"; 
                }
                else{
                        $sWhere.=" where added_by IN(".$indParentUsers.") and indid='".$indid."' and formid='".$formid."'"; 
                }
		
//		if(!empty($id) && $id!=0){
//			$sWhere.=" and usc_id=".$id;
//		}
		if(empty($month) && empty($year)){
                    if(!empty($sWhere)){
                        $sWhere.=" and MONTH(created_at)=MONTH(CURDATE()) and YEAR(created_at)=YEAR(CURDATE())";
                    }else{
                        $sWhere.=" where MONTH(created_at)=MONTH(CURDATE()) and YEAR(created_at)=YEAR(CURDATE())";
                    }
                }
		$sQuery1 = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sLimit";
 		$qry1 = $this->dbObj->query($sQuery1)->fetchAll();
                
                $row3=array();
                if(!empty($qry1)){
                    foreach($qry1 as $row2){
                        $row3[]= $row2[$sIndexColumn];
                    }
                }
                if(empty($indid) || empty($formid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		$indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
		$idall="";
                $html="";
                $extra=array("month"=>"","year"=>"");
                if(!empty($row) && !empty($row3)){
                    $idte=implode(",",$row);
                    $idsc=implode(",",$row3);
                    if($formid==27){
                        $html.=$this->_charting_task_join_log($indData,$idte,$idsc,$idall,$formid,"Ads",$extra);
                    } else {
                        $html.=$this->_charting_task_join_log($indData,$idte,$idsc,$idall,$formid,"Care",$extra);
                    }
                    
                } elseif(!empty($row) && empty($row3)){
                    $idte=implode(",",$row);
                    $idsc="";
                    if($formid==27){
                       $html.=$this->_charting_task_join_log($indData,$idte,$idsc,$idall,$formid,"Ads",$extra);
                    } else {
                        $html.=$this->_charting_task_join_log($indData,$idte,$idsc,$idall,$formid,"Care",$extra);
                    }
                    
                }
                elseif(empty($row) && !empty($row3)){
                    $idte="";
                    $idsc=implode(",",$row3);
                   if($formid==27){
                        $html.=$this->_charting_task_join_log($indData,$idte,$idsc,$idall,$formid,"Ads",$extra);
                    } else {
                         $html.=$this->_charting_task_join_log($indData,$idte,$idsc,$idall,$formid,"Care",$extra);
                    }
                    
                }
                    require_once ROOT_PATH.'/private/mpdf/mpdf.php';
                    $mpdf=new mPDF('utf-8', 'A2');
                    //$mpdf->showImageErrors = true;
                    ini_set("memory_limit","500M");
                    $stylesheet = file_get_contents(APPLICATION_URL.'/public/plugins/bootstrap/css/bootstrap.css');
                   // $stylesheet = file_get_contents(APPLICATION_URL.'/public/front_css/style_custom.css');
                    $mpdf->SetTitle($this->view->site_configs['site_name'] . " | " . ucwords($indData['agency_first_name'] . " " . $indData['agency_last_name']) . " Forms");
                    $mpdf->WriteHTML($stylesheet,1);
                    $mpdf->WriteHTML($html,2);
                    $mpdf->Output('/home/xoomia/public_html/public/pdf/hpcnote.pdf','F'); 
                    //$mpdf->Output('/var/www/html/xoomia/branches/public/pdf/hpcnote.pdf','F'); 

                    $recipients = $data['receiver_emails'];
                    $email_to = explode(',', $recipients);

                    $count = count($email_to);
                   // $mail = new Zend_Mail();
//                    $config = array('ssl' => 'tls',
//                    'port' => 587,'auth'=>'login','username'=>'test4rvtech@gmail.com','password'=>'RVtechtest#123');
//                    $transport = new Zend_Mail_Transport_Smtp('smtp.gmail.com', $config);

                    $config=array('auth'=>'login','username'=>'rv_test@xoomia.com','password'=>'rvtech@123');
                    $transport=new Zend_Mail_Transport_Smtp('xoomia.com',$config);  

                    $Mc = 1;
                    foreach ($email_to as $toemail) {

                        if($Mc >= $count) 
                           {
                                    $maildddd = str_replace(' ', '', $toemail);
                                    $ReceiverName = str_replace(' ', '', $toemail);
                                            $mail = new Zend_Mail();
                                            $mail->setBodyHtml($data['email_msg']);
                                            $mail->setFrom('client@xoomia.com', 'xoomia.com');
                                            $mail->addTo($maildddd,$ReceiverName);
                                            $mail->setSubject($data['email_subject']);
                                            $content = file_get_contents("/home/xoomia/public_html/public/pdf/hpcnote.pdf"); 
                                            //$content = file_get_contents("/var/www/html/xoomia/branches/public/pdf/hpcnote.pdf"); 
                                            $attachment = new Zend_Mime_Part($content);
                                            $attachment->type = 'application/pdf';
                                            $attachment->disposition = Zend_Mime::DISPOSITION_ATTACHMENT;
                                            $attachment->encoding = Zend_Mime::ENCODING_BASE64;
                                            $attachment->filename = 'hpcnote.pdf'; // name of file
                                            $mail->addAttachment($attachment);                  
                                            $transport->send($mail);
                                            echo 'done';
                               }  
                    $Mc++;
                    }
                    $healthSession->successMsg="Data has been email successfully";
                    if($id==1){
                        $this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_personal_care");
                    } else {
                        $this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_personal_care_notes");
                    }
                    exit();
            }
        }
        
        // End code added by amit on 16-May-2018 with HPC Notes 
        
        
    // Start code added by amit on 17-may-2018 with da & dad functionality   
    public function adddailyactvityAction(){
        
        global $healthSession;
        $formid=24;
        $id=$this->_getParam("id");
        if(empty($id)){
            $id=0;
        }
        
        $form=new Application_Form_CustomForms();
        $headingText="Add List of Activity";
        $document="";
        $form->dailyActivity($formid,$id);
        if(empty($id)){
            $id="";
        }
        if(!empty($id)){
            $headingText="Edit List of Activity";
            $logData=$this->SuperModel->Super_Get("_uhs_daily_activity","da_id=".$id,"fetch");
            if(!empty($logData)){
                    $form->populate($logData);
            }
        }
       
        $this->view->pageHeading=$headingText;
        $this->view->form=$form;		
        $this->view->id=$id;	
        $this->view->url=APPLICATION_URL.'/save-daily-activity/'.$formid.'/'.$id;
    }
    public function savedailyactivityAction(){
            global $healthSession;
            global $systemusers;
            $formid=$this->_getParam("formid");
            $id=$this->_getParam("id");
            $form=new Application_Form_CustomForms();
            $form->dailyActivity($formid,$id);
            if($this->getRequest()->isPost()){
                $posted_data = $this->getRequest()->getPost();
                //if($form->isValid($posted_data)){
                    if($this->view->user->agency_user_type =="Agency"){ 
                        $agency_id= $this->view->user->agency_id;
                        if($this->view->user->is_subuser == 1){
                            $agency_id= $this->view->user->agency_user_agency_id;
                        }

                    }
                    elseif(in_array($this->view->user->agency_user_type,$systemusers)){

                        $agency_id= $this->view->user->agency_user_agency_id;
                    }
                    if(empty($id)){
                               //prd($posted_data);
                            foreach($posted_data['da_activity_location'] as $key =>$value){

                                $posted_data1['da_agency_id']=$agency_id;
                                //$posted_data1['da_individual_id']=$indid;
                                $posted_data1['da_form_id']=$formid;
                                $posted_data1['da_added_by']=$this->view->user->subuser_id;
                                $posted_data1['da_added_date']=date('Y-m-d');
                                $posted_data1['da_frequency']=$posted_data['da_frequency'][$key];
                                $posted_data1['da_activity']=$posted_data['da_activity'][$key];
                                if($posted_data['da_activity_location'][$key] == "Other"){
                                    $posted_data1['da_activity_location']=$posted_data['da_activity_location'][$key];
                                    $posted_data1['da_activity_location_other']=$posted_data['da_activity_location_other'][$key];
                                }else{
                                    $posted_data1['da_activity_location']=$posted_data['da_activity_location'][$key];
                                }

                                $isInserted = $this->SuperModel->Super_Insert("_uhs_daily_activity",$posted_data1);
                                if($isInserted->success){
                                       $healthSession->successMsg  = "List of activity has been added successfully.";
                                }else{
                                       $healthSession->errorMsg  = $isInserted->message;
                                  }

                            } 
                    }
                    else{
                            
                            //$posted_data1['da_individual_id']=$indid;
                            $posted_data1['da_modified_by']=$this->view->user->subuser_id;
                            $posted_data1['da_frequency']=$posted_data['da_frequency'][0];
                            $posted_data1['da_activity']=$posted_data['da_activity'][0];
                            

                            if($posted_data['da_activity_location'][0] == "Other"){
                                    $posted_data1['da_activity_location']=$posted_data['da_activity_location'][0];
                                    $posted_data1['da_activity_location_other']=$posted_data['da_activity_location_other'][0];
                                }else{
                                    $posted_data1['da_activity_location']=$posted_data['da_activity_location'][0];
                                }
                            $isInserted = $this->SuperModel->Super_Insert("_uhs_daily_activity",$posted_data1,"da_id=".$id);
                            if($isInserted->success){
                                $healthSession->successMsg  ="List of activity has been updated successfully.";
                            }else{
                                $healthSession->errorMsg  = $isInserted->message;
                            }
                    }

                //}else{
                      //  $healthSession->errorMsg = " Please check information again.";
                //}
        }
        $this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_view_daily_activity");
    }
    public function viewdailyactivityAction(){	
		global $healthSession; 
		global $systemusers; 
  		$this->view->pageHeading = "List of Activity";
		if($this->view->user->agency_user_type =="Agency"){ 
                    $agency_id= $this->view->user->agency_id;
                    if($this->view->user->is_subuser == 1){
                        $agency_id= $this->view->user->agency_user_agency_id;
                    }

                }
                elseif(in_array($this->view->user->agency_user_type,$systemusers)){

                    $agency_id= $this->view->user->agency_user_agency_id;
                }
//		if(empty($indid)){
//			$healthSession->errorMsg="Invalid Access";
//			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
//		}
//		if(isFormAssigned($formid,$indid)){
//			$healthSession->errorMsg="Please assign form to individual first.";
//			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_forms");
//		}
		
		$this->view->agencyid=$agency_id;
                
  	}
	
	function getdailyactivityAction(){
		if(check_is_ajax($this->_request)){
			$this->_redirect(APPLICATION_URL);
		}
		$agency_id=$this->_getParam("agencyid");
                $formid=24;
		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('da_id','da_form_id','da_agency_id','da_individual_id','da_modified_by','da_added_date','da_activity','da_frequency','da_activity_location','da_added_by');
		$sIndexColumn = 'da_id';
		$sTable = '_uhs_daily_activity';
		$sLimit = "";
		if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' ){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		if ( isset( $_GET['iSortCol_0'] ) )
		{
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
			{
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
				{
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
	
		if($sWhere){
                    $sWhere.=" and da_form_id=".$formid." and da_agency_id='".$agency_id."'"; 
                    $sWhere.=" and MONTH(da_added_date)=MONTH(CURDATE()) and YEAR(da_added_date)=YEAR(CURDATE())";
                }
                else{
                        $sWhere.=" where da_form_id=".$formid." and da_agency_id='".$agency_id."'";
                        $sWhere.=" and MONTH(da_added_date)=MONTH(CURDATE()) and YEAR(da_added_date)=YEAR(CURDATE())";
                }
                
                $sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
                
                $qry = $this->dbObj->query($sQuery)->fetchAll();
                
                $sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
		$output = array(
 				"iTotalRecords" => $iTotal,
				"iTotalDisplayRecords" => $iFilteredTotal,
				"aaData" => array()
			);
		$j=0;
		foreach($qry as $row1){
			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$row1['da_added_by']);
			
                        if($this->view->user->agency_user_type =="Agency"){ 
                            $daddata=$this->SuperModel->Super_Get("_uhs_dad","dad_da_id=".$row1['da_id']." and dad_agency_id='".$this->view->user->agency_id."' and DATE(dad_added_date)='".date('Y-m-d')."'","fetch");
                        } else {
                            $daddata=$this->SuperModel->Super_Get("_uhs_dad","dad_da_id=".$row1['da_id']." and dad_added_user='".$this->view->user->agency_id."' and DATE(dad_added_date)='".date('Y-m-d')."'","fetch");
                        }
                        $modifierData=array();
			if($row1['da_modified_by']!=0){
				$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$row1['da_modified_by']);
			}
			$row=array();
 			$row[] = $j+1;
			$row[]='<input class="elem_ids checkboxes" type="checkbox" name="'.$sTable.'['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';
                        $row[]=$row1['da_frequency'];
                        $row[]=$row1['da_activity'].'&nbsp;&nbsp;<i title="Activity"></i>';
                        
			$row[]=$row1['da_activity_location'];
			$userType=printUserType($creatorData);
			$row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
			$your_date = date("m/d/Y", strtotime($row1['da_added_date'])); 
			$row[]=$your_date;
			if(!empty($modifierData)){
				$userType=printUserType($modifierData);
				$row[]=ucwords($modifierData['agency_first_name']." ".$modifierData['agency_last_name'])."&nbsp;".$userType;
			
			}
			else{
				$row[]="-";
				
			}
                        $editLink="";
			if($this->view->user->agency_user_type=="Agency"){
                            //$editLink = "&nbsp;<a href='javascript:void(1);' style='margin-top:5px;' onClick='showSupportForm(" . $indid . "," . $formid . "," . $row1['support_id'] . ");' class='btn btn-xs btn-default'>Edit Support</a>";
                            $url = APPLICATION_URL."/edit-daily-activity/".$row1[$sIndexColumn];
                            $editLink = "<a style='margin-top:5px;' href='".$url."' class='btn btn-xs btn-default'>Edit</a><BR>";
			}
                        if(!empty($daddata)){
                            
                            if(date("m")==date("m",strtotime($row1['da_added_date']))){
				//$row[]="<a style='margin-top:5px;' href='javascript:void(1);' onClick=showDiffrentForms(".$indid.",".$formid.",".$row1[$sIndexColumn].",'AssignedMileage') class='btn btn-xs btn-default'>Edit</a>";
				$url1 = APPLICATION_URL."/edit-dad/".$daddata['dad_id'];
                                $row[]=$editLink."&nbsp;<a style='margin-top:5px;' href='".$url1."' class='btn btn-xs btn-default'>Edit Documentation</a>";
                            }else{
                                    $row[]="<b>NA</b>";
                            }
                            
                            
                        }else{
                            if(date("m")==date("m",strtotime($row1['da_added_date']))){
				//$row[]="<a style='margin-top:5px;' href='javascript:void(1);' onClick=showDiffrentForms(".$indid.",".$formid.",".$row1[$sIndexColumn].",'AssignedMileage') class='btn btn-xs btn-default'>Edit</a>";
				$url1 = APPLICATION_URL."/add-dad/".$row1[$sIndexColumn];
                                $row[]=$editLink."&nbsp;<a style='margin-top:5px;' href='".$url1."' class='btn btn-xs btn-default'>Add Documentation</a>";
                            }else{
                                    $row[]="<b>NA</b>";
                            }
                            
                        }
			
 			$output['aaData'][] = $row;
			$j++;
		}
		echo json_encode($output);
		exit();
	}
        public function removedailyactivityAction(){
		global $healthSession;
		$this->_helper->layout->disableLayout();
		$this->_helper->viewRenderer->setNoRender(true);
		$formData = $this->getRequest()->getPost();
                if(isset($formData['_uhs_daily_activity']) && count($formData['_uhs_daily_activity'])) {
			foreach($formData['_uhs_daily_activity'] as $key=>$values){
  				$isDel=$this->SuperModel->Super_Delete('_uhs_daily_activity',"da_id=".$values);
 				$healthSession->successMsg="List of activity has been deleted successfully.";
			}
                }
		else{
			$healthSession->errorMsg="Invalid Request.";
		}
		$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_view_daily_activity");
	}
        public function adddadAction(){
        
        global $healthSession;
        global $systemusers;
        $formid=23;
        $id=$this->_getParam("id");
        $daid=$this->_getParam("daid");
        if($this->view->user->agency_user_type =="Agency"){ 
            $type= $this->view->user->agency_user_type;
            $agency_id= $this->view->user->agency_id;
        }
        elseif(in_array($this->view->user->agency_user_type,$systemusers)){
            $type= $this->view->user->agency_user_type;
            $agency_id= $this->view->user->agency_user_agency_id;
        }
        if(empty($id)){
            $id=0;
        }
        if(empty($daid)){
            $daid="";
        }
        
        $form=new Application_Form_CustomForms();
        $headingText="Add Group Activity Documentation";
        $document="";
        $form->dailyActivityDocumentation($agency_id,$type,$id,$daid);
        
        $this->view->activity="";
//        if(!empty($daid)){
//            $data=$this->SuperModel->Super_Get("_uhs_daily_activity","da_id=".$daid,"fetch");
//            $this->view->activity=$data['da_activity'];
//            
//        }
        
        if(!empty($id)){
            $headingText="Edit Group Activity Documentation";
            $logData=$this->SuperModel->Super_Get("_uhs_dad","dad_id=".$id,"fetch");
            if(!empty($logData)){
                    $logData['dad_da_id']=$logData['dad_da_id'];
                    $logData['dad_service_date']=date('m/d/Y',strtotime($logData['dad_service_date']));
                    $form->populate($logData);
            }
        }
       
        $this->view->pageHeading=$headingText;
        $this->view->form=$form;		
        $this->view->id=$id;	
        $this->view->url=APPLICATION_URL.'/save-dad/'.$formid.'/'.$id.'/'.$daid;
    }
    public function savedadAction(){
            global $healthSession;
            global $systemusers;
            $formid=$this->_getParam("formid");
             $id=$this->_getParam("id");
             $dailyactid=$this->_getParam("daid");
            if($this->view->user->agency_user_type =="Agency"){ 
            
                $type= $this->view->user->agency_user_type;
                $agency_id= $this->view->user->agency_id;
            
            }
            elseif(in_array($this->view->user->agency_user_type,$systemusers)){
                $type= $this->view->user->agency_user_type;
                $agency_id= $this->view->user->agency_user_agency_id;
            }
            $form=new Application_Form_CustomForms();
            $form->dailyActivityDocumentation($agency_id, $type,$id,"");
            if($this->getRequest()->isPost()){
                $posted_data = $this->getRequest()->getPost();
                unset($posted_data['bttnsubmit']);
               
               // if($form->isValid($posted_data)){
                   if(empty($id)){ 
                            $dad_group_code=getRandomString(6);
                            foreach($posted_data['dad_participant'] as $index =>$participantId){
                                if(!empty($participantId)){
                                    $indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$participantId,"fetch");
                                    $agencyData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indData['agency_user_agency_id']);
                                    $posted_data1['dad_group_code'] = $dad_group_code;
                                    $posted_data1['dad_agency_id']=$agencyData['agency_id'];
                                    $posted_data1['dad_individual_id']=$participantId;
                                    $posted_data1['dad_form_id']=$formid;
                                    $posted_data1['dad_added_user']=$this->view->user->subuser_id;
                                    $posted_data1['dad_added_date']=date('Y-m-d H:i:s');
                                    $posted_data1['dad_da_id']=$posted_data['dad_da_id'];
                                    $posted_data1['dad_service_date']=date("Y-m-d",strtotime($posted_data['dad_service_date']));
                                    $posted_data1['dad_location_service']=$posted_data['dad_location_service'];
                                    $posted_data1['dad_start_time']=$posted_data['dad_start_time'];
                                    $posted_data1['dad_end_time']=$posted_data['dad_end_time'];
                                    $posted_data1['dad_staff']=$posted_data['dad_staff'];
                                    $posted_data1['dad_group_size']=$posted_data['dad_group_size'];
                                    $participantIds = "";
                                    $flag=0;
                                    foreach($posted_data['dad_participant'] as $index =>$participant){
                                        if(!empty($participant)){
                                            if($flag > 0){
                                                $addComma=",";
                                            }else{
                                                $addComma="";
                                            }
                                            $participantIds .=$addComma.$posted_data['dad_participant'][$index];
                                            $flag++;
                                        }

                                    }
                                    $posted_data1['dad_participant']=$participantIds;
                                    $posted_data1['dad_comment']=$posted_data['dad_comment'];
                                    $posted_data1['dad_total_service_time']=$posted_data['dad_total_service_time'];
                                    if($posted_data['dad_location_address'] == "Other"){
                                        $posted_data1['dad_location_address']=$posted_data['dad_location_address'];
                                        $posted_data1['dad_location_address_other']=$posted_data['dad_location_address_other'];
                                    }else{
                                        $posted_data1['dad_location_address']=$posted_data['dad_location_address'];
                                    }
                                    $isInserted = $this->SuperModel->Super_Insert("_uhs_dad",$posted_data1);
                                    if($isInserted->success){
                                           $healthSession->successMsg  = "Group activity documentation has been added successfully.";
                                    }else{
                                           $healthSession->errorMsg  = $isInserted->message;
                                      }

                                }
                            }
                    }
                    else{
                            
                            $posted_data1['dad_da_id']=$posted_data['dad_da_id'];
                            $posted_data1['dad_service_date']=date("Y-m-d",strtotime($posted_data['dad_service_date']));
                            $posted_data1['dad_location_service']=$posted_data['dad_location_service'];
                            $posted_data1['dad_start_time']=$posted_data['dad_start_time'];
                            $posted_data1['dad_end_time']=$posted_data['dad_end_time'];
                            $posted_data1['dad_staff']=$posted_data['dad_staff'];
                            $posted_data1['dad_group_size']=$posted_data['dad_group_size'];
                            $participantIds = "";
//                            $flag=0;
//                            foreach($posted_data['dad_participant'] as $index =>$participantId){
//                                if(!empty($participantId)){
//                                    if($flag > 0){
//                                        $addComma=",";
//                                    }else{
//                                        $addComma="";
//                                    }
//                                    $participantIds .=$addComma.$posted_data['dad_participant'][$index];
//                                    $flag++;
//                                }
//                                
//                            }
//                            if(!empty($participantIds)){
//                                    $posted_data1['dad_participant']=$participantIds;
//                            }
                            $posted_data1['dad_comment']=$posted_data['dad_comment'];
                            $posted_data1['dad_total_service_time']=$posted_data['dad_total_service_time'];
                            if($posted_data['dad_location_address'] == "Other"){
                                    $posted_data1['dad_location_address']=$posted_data['dad_location_address'];
                                    $posted_data1['dad_location_address_other']=$posted_data['dad_location_address_other'];
                                }else{
                                    $posted_data1['dad_location_address']=$posted_data['dad_location_address'];
                                }
                            $posted_data1['dad_modified_by']=$this->view->user->subuser_id;
                            $posted_data1['dad_modified_on']=date('Y-m-d H:i:s');
                            
                            $isInserted = $this->SuperModel->Super_Insert("_uhs_dad",$posted_data1,"dad_id=".$id);
                            if($isInserted->success){
                                $healthSession->successMsg  ="Group activity Documentation has been updated successfully.";
                            }else{
                                $healthSession->errorMsg  = $isInserted->message;
                            }
                    }

               // }else{
                    //    $healthSession->errorMsg = " Please check information again.";
               // }
        }
        if(!empty($dailyactid)){
            $this->_helper->getHelper("Redirector")->gotoRoute(array("daid"=>$dailyactid),"front_add_dad");
        } else {
            if(!empty($id)){
                $this->_helper->getHelper("Redirector")->gotoRoute(array("id"=>$id),"front_edit_dad");
            }
            else {
                $this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_add_dad");
            }
        }
        
    }
    public function viewdadAction(){	
        
		global $healthSession; 
  		$this->view->pageHeading = "Group Activity Documentation";
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
                $id=$this->_getParam("id");
		if(empty($indid)){
			$healthSession->errorMsg="Invalid Access";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		$this->view->permissions=$permissions;
		$this->view->indid=$indid;
		$this->view->formid=$formid;
                $this->view->id=$id;
                
  	}
	
	public function getdadAction(){
                if(check_is_ajax($this->_request)){
			$this->_redirect(APPLICATION_URL);
		}
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		$subuser=$dstarts=$dends=$month=$year="";
		if(isset($_REQUEST['subuser']) && !empty($_REQUEST['subuser'])){
			$subuser=$_REQUEST['subuser'];
		}
		if(isset($_REQUEST['dstarts']) && !empty($_REQUEST['dstarts'])){
			$dstarts=$_REQUEST['dstarts'];
		}
		if(isset($_REQUEST['dends']) && !empty($_REQUEST['dends'])){
			$dends=$_REQUEST['dends'];
		}
		if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
			$month=$_REQUEST['month'];
		}
		if(isset($_REQUEST['year']) && !empty($_REQUEST['year'])){
			$year=$_REQUEST['year'];
		}
 		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('dad_id','dad_form_id','dad_individual_id','dad_modified_by','dad_added_date','dad_da_id','dad_service_date','dad_location_service','dad_added_user','dad_start_time','dad_end_time','dad_staff','dad_group_size','dad_participant','dad_comment','dad_modified_by','dad_modified_on','dad_total_service_time');
		$sIndexColumn = 'dad_id';
		$sTable = '_uhs_dad';
		$sLimit = "";
		if(isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength']!='-1'){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		if ( isset( $_GET['iSortCol_0'] ) ){
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
			{
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
				{
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
		if(empty($subuser)){
			$indParentUsers="";
			if($this->view->user->agency_user_type=="Agency"){
				$systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_id,"fetchAll",array("fields"=>"agency_id"));
				$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
				$indParentUsers=implode_r(",",$systemUsers);
                                
			}
			else{
				$systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_user_agency_id,"fetchAll",array("fields"=>"agency_id"));
				$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
				//$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_user_agency_id;
				$indParentUsers=implode_r(",",$systemUsers);
				//$indParentUsers=$this->view->user->agency_id.",".$this->view->user->agency_user_agency_id;
                        }
                        if($sWhere){
                                    $sWhere.=" and dad_added_user IN(".$indParentUsers.") and dad_individual_id='".$indid."'"; 
                                }
                                else{
                                        $sWhere.=" where dad_added_user IN(".$indParentUsers.") and dad_individual_id='".$indid."'"; 
                                }
			
		}
		else{
			if($sWhere){
				$sWhere.=" and dad_added_user IN(".$subuser.") and dad_individual_id='".$indid."'"; 
			}
			else{
				$sWhere.=" where dad_added_user IN(".$subuser.") and dad_individual_id='".$indid."'"; 
			}
		}
		if(!empty($dstarts)){
			$sWhere.=" and DATE(dad_added_date) >='".$dstarts."'";
		}
		if(!empty($dends)){
			$sWhere.=" and DATE(dad_added_date) <='".$dends."'";
		}
		if(!empty($month)){
			$sWhere.=" and MONTH(dad_added_date)='".$month."'";
		}
		if(!empty($year)){
			$sWhere.=" and YEAR(dad_added_date)='".$year."'";
		}
//		if(!empty($id) && $id!=0){
//			$sWhere.=" and dad_id=".$id;
//		}
                if(empty($month) && empty($year)){
                    if(!empty($sWhere)){
                        $sWhere.=" and MONTH(dad_added_date)=MONTH(CURDATE()) and YEAR(dad_added_date)=YEAR(CURDATE())";
                    }else{
                        $sWhere.=" where MONTH(dad_added_date)=MONTH(CURDATE()) and YEAR(dad_added_date)=YEAR(CURDATE())";
                    }
                }
                
                $sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
                
                $qry = $this->dbObj->query($sQuery)->fetchAll();
                
                $sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
		$output = array(
 				"iTotalRecords" => $iTotal,
				"iTotalDisplayRecords" => $iFilteredTotal,
				"aaData" => array()
			);
		$j=0;
		foreach($qry as $row1){
			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$row1['dad_added_user']);
                        $dailyActivityData=$this->SuperModel->Super_Get("_uhs_daily_activity","da_id=".$row1['dad_da_id'],"fetch");
			$modifierData=array();
			if($row1['dad_modified_by']!=0){
				$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$row1['dad_modified_by']);
			}
			$row=array();
 			$row[] = $j+1;
			$row[]='<input class="elem_ids checkboxes" type="checkbox" name="'.$sTable.'['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';
                        $row[]=formatDate($row1['dad_service_date']);
                        $row[]=$row1['dad_location_service'];
                        $row[]=$dailyActivityData['da_activity'];
                        
                        
			$row[]=$row1['dad_start_time'];
			$row[]=$row1['dad_end_time'];
                        
                        if(!empty($row1['dad_total_service_time'])){
                            $row[]=$row1['dad_total_service_time'];
                        }else{
                            $row[]="-";
                        }
			
			
			
			$userType=printUserType($creatorData);
			$row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
			$your_date = date("m/d/Y H:i:s", strtotime($row1['dad_added_date'])); 
			$row[]=$your_date;
                        $row[]=$row1['dad_comment'];
                        $participantData="";
                        $flag = 0;
                        if(!empty($row1['dad_participant'])){
                            $implode = explode(",",$row1['dad_participant']);
                            
                            for($i = 0; $i < count($implode); $i++){
                                if($flag > 0){
                                    $addComma = " , ";
                                }
                                else{
                                    $addComma = "";
                                };
                                $indidData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$implode[$i]);
                                $participantData .=$addComma.ucwords($indidData['agency_first_name']." ".$indidData['agency_last_name']);
                            
                                $flag++;
                            }
                        }
                        $row[]=$participantData;
                        $row[]=$dailyActivityData['da_frequency'];
                        $row[]=$row1['dad_staff']." : ".$row1['dad_group_size'];
			if(!empty($modifierData)){
				$userType=printUserType($modifierData);
				$row[]=ucwords($modifierData['agency_first_name']." ".$modifierData['agency_last_name'])."&nbsp;".$userType;
                                $row[]=$row1['dad_modified_on'];
			}
			else{
				$row[]="-";
				$row[]="-";
				
			}
                        if($this->view->user->agency_user_type=="Agency"){
			if(date("m")==date("m",strtotime($row1['dad_added_date']))){
				//$row[]="<a style='margin-top:5px;' href='javascript:void(1);' onClick=showDiffrentForms(".$indid.",".$formid.",".$row1[$sIndexColumn].",'AssignedMileage') class='btn btn-xs btn-default'>Edit</a>";
				$url = APPLICATION_URL."/edit-dad/".$row1[$sIndexColumn];
                                $row[]="<a style='margin-top:5px;' href='".$url."' class='btn btn-xs btn-default'>Edit</a>";
			}else{
				$row[]="<b>NA</b>";
			}
			}else{
				$row[]="<b>NA</b>";
			}
 			$output['aaData'][] = $row;
			$j++;
		}
		echo json_encode($output);
		exit();
	}
        public function removedadAction(){
		global $healthSession;
                $indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$this->_helper->layout->disableLayout();
		$this->_helper->viewRenderer->setNoRender(true);
		$formData = $this->getRequest()->getPost();
                if(isset($formData['_uhs_dad']) && count($formData['_uhs_dad'])) {
			foreach($formData['_uhs_dad'] as $key=>$values){
				$logData=$this->SuperModel->Super_Get('_uhs_dad',"dad_id=".$values,"fetch");
				if(is_null($logData['dad_group_code'])){
				  $isDel=$this->SuperModel->Super_Delete('_uhs_dad',"dad_id=".$values);
				}else{
  				  $isDel=$this->SuperModel->Super_Delete('_uhs_dad',"dad_group_code='".$logData['dad_group_code']."'");
			     }
 				$healthSession->successMsg="Group activity has been deleted successfully.";
			}
                }
		else{
			$healthSession->errorMsg="Invalid Request.";
		}
                if(!empty($indid)){
                    $this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_view_dad");
                } else {
                    $this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_view_all_dad");
                }
		
	}

        // End code added by amit on 17-may-2018 with da & dad functionality
        
        // End code added by amit on 17-may-2018 with vehicle  & record a trip functionality
        
        public function vehiclesAction(){ 
		global $healthSession,$systemusers;
		$this->view->pageHeading="Vehicles";		
  	}
    
        public function addvehicleAction(){ 
		global $healthSession,$systemusers;
		$this->view->pageHeading="Add Vehicle";
		$agency_id=$this->view->user->agency_id;
 		$form=new Application_Form_CustomForms();
		$form->vehicle();
 		if($this->getRequest()->isPost()) {
			$posted_data = $this->getRequest()->getPost();
	
   			 if($form->isValid($posted_data)){
				 	
			     unset($posted_data['bttnsubmit']);								 								
				 $posted_data['ve_added_by']=$this->view->user->subuser_id;
				 $posted_data['ve_added_date']=date('Y-m-d H:i:s');
				 $posted_data['ve_agency_id']=$agency_id;				 
			     $isInserted = $this->SuperModel->Super_Insert("_uhs_vehicle",$posted_data);	
				 if($isInserted->success){
				   $healthSession->successMsg  = "Vehicle has been added successfully.";
				   $this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_vehicle");
                 }else{
                       $healthSession->errorMsg  = $isInserted->message;
                  }
   	 		}else{
				 $healthSession->errorMsg = " Please check information again.";
 			 }
		 }
  		 $this->view->form =$form;
  	}
  	
  	public function getvehiclesAction(){
		if(check_is_ajax($this->_request)){
			$this->_redirect(APPLICATION_URL);
		}
 		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('ve_id,ve_agency_id','ve_added_by','ve_licence_plate_number','ve_vin_number','ve_description','ve_added_date','ve_modified_by');
		$sIndexColumn = 've_id';
		$sTable = '_uhs_vehicle';
		$sLimit = "";
		if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' ){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		if ( isset( $_GET['iSortCol_0'])){
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ ){
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" ){
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if(isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ ){
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		for($i=0 ; $i<count($aColumns) ; $i++ ){
			if(isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' ){
				if($sWhere == ""){
					$sWhere = "WHERE ";
				}
				else{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
                $agency_id=$this->view->user->agency_id;


		if($sWhere){
                    $sWhere.=" and ve_agency_id='".$agency_id."'"; 
                }
                else{
                $sWhere.=" where ve_agency_id='".$agency_id."'"; 
                }

		
		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
 		$qry = $this->dbObj->query($sQuery)->fetchAll();
		$sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
		$output = array(
 				"iTotalRecords" => $iTotal,
				"iTotalDisplayRecords" => $iFilteredTotal,
				"aaData" => array()
			);
		$loginusertype = $this->view->user->agency_user_type;
		$j=0;
		foreach($qry as $row1){
			//print_r($row1); exit;
			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$row1['ve_added_by']);
                        $modifierData=array();
			if($row1['ve_modified_by']!=0){
				$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$row1['ve_modified_by']);
			}
			$row=array();
 			$row[] = $j+1;
			$row[]='<input class="elem_ids checkboxes" '.$disableClass.' type="checkbox" name="'.$sTable.'['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';
			$row[]=$row1['ve_licence_plate_number'];
			$row[]=$row1['ve_vin_number'];
			$row[]=$row1['ve_description'];
			$userType=printUserType($creatorData);
			$row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
			$row[]=$row1['ve_added_date'];
			$row[] = "<a style='margin-top:5px;' href='".APPLICATION_URL."/edit-vehicle/".$row1['ve_id']."' class='btn btn-xs btn-default'>Edit</a><BR>";
 			$output['aaData'][] = $row;
			$j++;
		}
		echo json_encode($output);
		exit();
	}
      
        public function removevehicleAction(){
		global $healthSession;
 		$this->_helper->layout->disableLayout();
		$this->_helper->viewRenderer->setNoRender(true);
		$vehicleData = $this->getRequest()->getPost();
                //prd($vehicleData);
		if(isset($vehicleData['_uhs_vehicle']) && count($vehicleData['_uhs_vehicle'])) {
			foreach($vehicleData['_uhs_vehicle'] as $key=>$values){
  				$isAdd=$this->SuperModel->Super_Delete('_uhs_vehicle',"ve_id=".$values);
 				$healthSession->successMsg="Vehicle(s) has been deleted successfully.";
			}
		}
		else{
			$healthSession->errorMsg = "Invalid Request for delete.";
		}
 		$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_vehicle");
	} 		 	

        public function editvehicleAction(){
		global $healthSession; 
		$agency_id=$this->view->user->agency_id;
		$this->view->pageHeading = "Edit Vehicle";
		
 		$vehicle_id=$this->_getParam('ve_id');
		$content=$this->SuperModel->Super_Get("_uhs_vehicle","ve_id='".$vehicle_id."'","fetch");

 		$form = new Application_Form_CustomForms();
		$form->vehicle();
		$form->populate($content);
		$this->view->form=$form;
                if($this->getRequest()->isPost()) {
			$posted_data = $this->getRequest()->getPost();
	
   			 if($form->isValid($posted_data)){
				 	
			     unset($posted_data['bttnsubmit']);								 								
				 $posted_data['ve_added_by']=$this->view->user->subuser_id;
				 $posted_data['ve_added_date']=date('Y-m-d H:i:s');
				 $posted_data['ve_agency_id']=$agency_id;				 
			     $isUpdated = $this->SuperModel->Super_Insert("_uhs_vehicle",$posted_data,"ve_id='".$vehicle_id."'");	
				 if($isUpdated->success){
				   $healthSession->successMsg  = "Vehicle has been Updated successfully.";
				   $this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_vehicle");
                 }else{
                       $healthSession->errorMsg  = $isInserted->message;
                  }
   	 		}else{
				 $healthSession->errorMsg = " Please check information again.";
 			 }
		}
		$this->view->form =$form;
		
        }
        
        
        
        public function addcarinspectionAction(){
       
            global $healthSession;
            global $systemusers;
            $formid=25;
            //$indid=$this->_getParam("indid");
            $id=$this->_getParam("id");
            //$id=0;

    //        if(empty($indid)){
    //            $healthSession->errorMsg="Invalid Access";
    //            $this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
    //        }
            $form=new Application_Form_CustomForms();
            $headingText="Vehicle inspection log";
            $document="";


            if($this->view->user->agency_user_type =="Agency"){ 
                $agency_id= $this->view->user->agency_id;
                if($this->view->user->is_subuser == 1){
                    $agency_id= $this->view->user->agency_user_agency_id;
                }

            }
            elseif(in_array($this->view->user->agency_user_type,$systemusers)){

                //$agency_id= $this->view->user->agency_user_agency_id;
                $agency_id=$this->view->user->agency_id;
            }

            //$agency_id=$this->view->user->agency_id;

            $form->carInspection($agency_id);
            if(empty($id)){
                $id=0;
            }
            if(!empty($id)){
                $headingText="Vehicle inspection log";
                $logData=$this->SuperModel->Super_Get("_uhs_car_inspection","ci_id=".$id,"fetch");
                if(!empty($logData)){
                        $logData['ci_inspection_date']=date('m/d/Y',strtotime($logData['ci_inspection_date']));
                        $form->populate($logData);
                }
            }

            $this->view->pageHeading=$headingText;
            $this->view->form=$form;		
            $this->view->id=$id;	
            //$this->view->indid=$indid;
            $this->view->url=APPLICATION_URL.'/save-car-inspection/'.$formid.'/'.$id;
        }

    
    
     public function savecarinspectionAction(){
            global $healthSession;
            global $systemusers;
            $formid=$this->_getParam("formid");
            //$indid=$this->_getParam("indid");
            $id=$this->_getParam("id");
            $form=new Application_Form_CustomForms();
            
            if($this->view->user->agency_user_type =="Agency"){ 
                $agency_id= $this->view->user->agency_id;
                if($this->view->user->is_subuser == 1){
                    $agency_id= $this->view->user->agency_user_agency_id;
                }

            }
            elseif(in_array($this->view->user->agency_user_type,$systemusers)){

                //$agency_id= $this->view->user->agency_user_agency_id;
                $agency_id=$this->view->user->agency_id;
                
            }
            $form->carInspection($agency_id);
            if($this->getRequest()->isPost()){
                $posted_data = $this->getRequest()->getPost();

                unset($posted_data['bttnsubmit']);
               //   prd($posted_data);
               // die;
                if($form->isValid($posted_data)){
                    
                    if(empty($id)){
                        $posted_data['ci_code']=getRandomString(6);
                        if(in_array($this->view->user->agency_user_type,$systemusers)){
                         $posted_data['ci_agency_id']=$this->view->user->agency_user_agency_id;
                        } else{
                         $posted_data['ci_agency_id']=$agency_id;
                        }
                        //$posted_data['ci_individual_id']=$indid;
                        $posted_data['ci_form_id']=$formid;
                        $posted_data['ci_added_by']=$this->view->user->subuser_id;
                        $posted_data['ci_added_date']=date('Y-m-d H:i:s');
                        $posted_data['ci_inspection_date']=date("Y-m-d",strtotime($posted_data['ci_inspection_date']));
                        $isInserted = $this->SuperModel->Super_Insert("_uhs_car_inspection",$posted_data);
                        if($isInserted->success){
                               $healthSession->successMsg  = "Vehicle Inspection log has been added successfully.";
                        }else{
                               $healthSession->errorMsg  = $isInserted->message;
                        }
                    }
                    else{
                            $posted_data['ci_modified_by']=$this->view->user->subuser_id;
                            $posted_data['ci_modified_on']=date('Y-m-d');
                            $posted_data['ci_inspection_date']=date("Y-m-d",strtotime($posted_data['ci_inspection_date']));
                            $isInserted = $this->SuperModel->Super_Insert("_uhs_car_inspection",$posted_data,"ci_id=".$id);
                            if($isInserted->success){
                                $healthSession->successMsg  ="Vehicle Inspection log been updated successfully.";
                            }else{
                                $healthSession->errorMsg  = $isInserted->message;
                            }
                    }

                }else{
                        $healthSession->errorMsg = " Please check information again.";
                }
        }
        $this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_view_car_inspection");
    }
    

    
    public function viewcarinspectionAction(){	
        

		global $healthSession; 
                global $systemusers;
                $indid=$this->_getParam("indid");
                $this->view->pageHeading = "Vehicle inspection log";
		
                if($this->view->user->agency_user_type =="Agency"){ 
                    $agency_id= $this->view->user->agency_id;
                    if($this->view->user->is_subuser == 1){
                        $agency_id= $this->view->user->agency_user_agency_id;
                    }

                }
                elseif(in_array($this->view->user->agency_user_type,$systemusers)){

                    $agency_id= $this->view->user->agency_user_agency_id;

                }
               
                $this->view->agencyid=$agency_id;
                $this->view->indid=$indid;
                $this->view->formid=25;
//		if(empty($indid)){
//			$healthSession->errorMsg="Invalid Access";
//			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
//		}
//		if(isFormAssigned($formid,$indid)){
//			$healthSession->errorMsg="Please assign form to individual first.";
//			$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_forms");
//		}
		
		
                
  	}
	      public function getcarinspectionAction(){
                if(check_is_ajax($this->_request)){
			$this->_redirect(APPLICATION_URL);
		}
                $agency_id=$this->_getParam("agencyid");
                $formid=25;
                $subuser=$dstarts=$dends=$wcode=$month=$year=$lpn_id="";
		if(isset($_REQUEST['subuser']) && !empty($_REQUEST['subuser'])){
			$subuser=$_REQUEST['subuser'];
		}
		if(isset($_REQUEST['dstarts']) && !empty($_REQUEST['dstarts'])){
			$dstarts=$_REQUEST['dstarts'];
		}
		if(isset($_REQUEST['dends']) && !empty($_REQUEST['dends'])){
			$dends=$_REQUEST['dends'];
		}
		if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
			$month=$_REQUEST['month'];
		}
		if(isset($_REQUEST['year']) && !empty($_REQUEST['year'])){
			$year=$_REQUEST['year'];
		}	
		if(isset($_REQUEST['lpn_id']) && !empty($_REQUEST['lpn_id'])){
			$lpn_id=$_REQUEST['lpn_id'];
		}	
		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('ci_id','ci_form_id','ci_agency_id','ci_individual_id','ci_inspection_date','ci_modified_by','ci_modified_on','ci_added_date','ci_added_by','ci_communication','ci_lights','ci_secure_storage_space','ci_fire_extinguisher','ci_windshield_washer_wipers','ci_emergency_equipment','ci_mirrors','ci_horn','ci_tires','ci_brakes','ci_seat_belt','ci_wheelchair_fasteners','ci_restraints','ci_ramp_hydraulic_lift','ci_license_plate_number','ci_code');
		$sIndexColumn = 'ci_id';
		$sTable = '_uhs_car_inspection';
		$sLimit = "";
		if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' ){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		if ( isset( $_GET['iSortCol_0'] ) )
		{
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
			{
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
				{
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
                
                
                ////////////////////
                if(empty($subuser)){
			$indParentUsers="";
			if($this->view->user->agency_user_type=="Agency"){
				$systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_id,"fetchAll",array("fields"=>"agency_id"));
				$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
				$indParentUsers=implode_r(",",$systemUsers);
                               
                                if($sWhere){
                                    $sWhere.=" and ci_added_by IN(".$indParentUsers.")"; 
                                }
                                else{
                                    $sWhere.=" where ci_added_by IN(".$indParentUsers.")"; 
                                }
			}
			else{
                            $indParentUsers=$this->view->user->agency_user_agency_id;
                            if($sWhere){
                                $sWhere.=" and ci_agency_id IN(".$indParentUsers.")";
                            }
                            else{
                                $sWhere.=" where ci_agency_id IN(".$indParentUsers.")"; 
                            }
			}
		}
		else{
			if($sWhere){
                            $sWhere.=" and ci_added_by IN(".$subuser.")"; 
                        }
			else{
                            $sWhere.=" where ci_added_by IN(".$subuser.")";
                        }
		}
		if(!empty($dstarts)){
			$sWhere.=" and DATE(ci_inspection_date) >='".$dstarts."'";
		}
		if(!empty($dends)){
			$sWhere.=" and DATE(ci_inspection_date) <='".$dends."'";
		}
		if(!empty($month)){
			$sWhere.=" and MONTH(ci_inspection_date)='".$month."'";
		}
		if(!empty($year)){
			$sWhere.=" and YEAR(ci_inspection_date)='".$year."'";
		}
		if(!empty($lpn_id)){
			$sWhere.=" and ci_license_plate_number='".$lpn_id."'";
		}
		
//		if(!empty($id) && $id!=0){
//			$sWhere.=" and ci_id=".$id;
//		}
		if(empty($month) && empty($year) && empty($dstarts) && empty($dends) && empty($lpn_id) && empty($subuser)){
                    if(!empty($sWhere)){
                        $sWhere.=" and MONTH(ci_added_date)=MONTH(CURDATE()) and YEAR(ci_added_date)=YEAR(CURDATE())";
                    }else{
                        $sWhere.=" where MONTH(ci_added_date)=MONTH(CURDATE()) and YEAR(ci_added_date)=YEAR(CURDATE())";
                    }
                }
                /////////////////////
                
//		if($sWhere){
//                    $sWhere.=" and ci_form_id=".$formid." and ci_agency_id='".$agency_id."'"; 
//                }
//                else{
//                        $sWhere.=" where ci_form_id=".$formid." and ci_agency_id='".$agency_id."'";  
//                }
		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
                
                $qry = $this->dbObj->query($sQuery)->fetchAll();
                
                $sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
		$output = array(
 				"iTotalRecords" => $iTotal,
				"iTotalDisplayRecords" => $iFilteredTotal,
				"aaData" => array()
			);
		$j=0;
		foreach($qry as $row1){
			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$row1['ci_added_by']);
			//$daddata=$this->SuperModel->Super_Get("_uhs_dad","dad_da_id=".$row1['da_id']." and dad_added_user='".$this->view->user->agency_id."' and DATE(dad_added_date)='".date('Y-m-d')."'","fetch");
                        $cidatas=$this->SuperModel->Super_Get("_uhs_vehicle","ve_id='".$row1['ci_license_plate_number']."'","fetch");
                        $modifierData=array();
			if($row1['ci_modified_by']!=0){
				$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$row1['ci_modified_by']);
			}
			$row=array();
 			$row[] = $j+1;
			$row[]='<input class="elem_ids checkboxes" type="checkbox" name="records['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';
                        $row[]=formatDate($row1['ci_inspection_date']);
                        $row[]=$row1['ci_code'];
                        
			
			$row[]=$cidatas['ve_licence_plate_number'];
			$userType=printUserType($creatorData);
			$row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
			$your_date = date("m/d/Y H:i:s", strtotime($row1['ci_added_date'])); 
			$row[]=$your_date;
                        
                        if($row1['ci_secure_storage_space']){
                            $row[] ="Clear";
                        }else{
                            $row[]="Not clear";
                        }
                        
                        if($row1['ci_communication']){
                            $row[] ="Working";
                        }else{
                            $row[]="Not working";
                        }
                        
                        if($row1['ci_fire_extinguisher']){
                             $row[] ="Yes";
                        }else{
                            $row[]="No";
                        }
                        
                        if($row1['ci_lights']){
                             $row[] ="Yes";
                        }else{
                            $row[]="No";
                        }
                        
                         if($row1['ci_windshield_washer_wipers']){
                             $row[] ="Yes";
                        }else{
                            $row[]="No";
                        }
                        
                        if($row1['ci_emergency_equipment']){
                            $row[] ="Secured";
                        }else{
                            $row[]="Not secured";
                        }
                        
                        if($row1['ci_mirrors']){
                             $row[] ="Yes";
                        }else{
                            $row[]="No";
                        }
                        
                        if($row1['ci_horn']){
                             $row[] ="Yes";
                        }else{
                            $row[]="No";
                        }
                        
                        if($row1['ci_tires']){
                             $row[] ="Yes";
                        }else{
                            $row[]="No";
                        }
                        
                         if($row1['ci_brakes']){
                             $row[] ="Yes";
                        }else{
                            $row[]="No";
                        }
                        
                         if($row1['ci_seat_belt']){
                             $row[] ="Yes";
                        }else{
                            $row[]="No";
                        }
                        
                        
                        
                        if($row1['ci_wheelchair_fasteners']){
                             $row[]="Working";
                        }else{
                           $row[]="Not working"; 
                        }
                        
                        if($row1['ci_restraints']){
                            $row[] ="Yes";
                        }else{
                            $row[]="No";
                        }
                        
                        if($row1['ci_ramp_hydraulic_lift']){
                            $row[] ="working";
                        }else{
                            $row[]="Not working"; 
                        }
                        
                        
			if(!empty($modifierData)){
				$userType=printUserType($modifierData);
				$row[]=ucwords($modifierData['agency_first_name']." ".$modifierData['agency_last_name'])."&nbsp;".$userType;
                                $row[]=formatDate($row1['ci_modified_on']);
			}
			else{
				$row[]="-";
				$row[]="-";
				
			}
                        $editLink="";
			if($this->view->user->agency_user_type=="Agency"){
                            //$editLink = "&nbsp;<a href='javascript:void(1);' style='margin-top:5px;' onClick='showSupportForm(" . $indid . "," . $formid . "," . $row1['support_id'] . ");' class='btn btn-xs btn-default'>Edit Support</a>";
                            $url = APPLICATION_URL."/edit-car-inspection/".$row1[$sIndexColumn];
                            $editLink = "<a style='margin-top:5px;' href='".$url."' class='btn btn-xs btn-default'>Edit</a><BR>";
			}
//                        if(!empty($daddata)){
//                            
//                            if(date("m")==date("m",strtotime($row1['da_added_date']))){
//				//$row[]="<a style='margin-top:5px;' href='javascript:void(1);' onClick=showDiffrentForms(".$indid.",".$formid.",".$row1[$sIndexColumn].",'AssignedMileage') class='btn btn-xs btn-default'>Edit</a>";
//				$url1 = APPLICATION_URL."/edit-dad/".$indid."/".$formid."/".$daddata['dad_id']."/".$row1[$sIndexColumn];
//                                $row[]=$editLink."&nbsp;<a style='margin-top:5px;' href='".$url1."' class='btn btn-xs btn-default'>Edit Documentation</a>";
//                            }else{
//                                    $row[]="<b>NA</b>";
//                            }
//                            
//                            
//                        }else{
                            if(date("m")==date("m",strtotime($row1['ci_added_date']))){
				//$row[]="<a style='margin-top:5px;' href='javascript:void(1);' onClick=showDiffrentForms(".$indid.",".$formid.",".$row1[$sIndexColumn].",'AssignedMileage') class='btn btn-xs btn-default'>Edit</a>";
				$url1 = APPLICATION_URL."/add-record-atrip/".$row1[$sIndexColumn];
                                $row[]=$editLink."&nbsp;<a style='margin-top:5px;' href='".$url1."' class='btn btn-xs btn-default'>Record a trip</a>";
                            }else{
                                    $row[]="<b>NA</b>";
                            }
                            
                        //}
			
 			$output['aaData'][] = $row;
			$j++;
		}
		echo json_encode($output);
		exit();
	}
        
        
        
        
        
//       public function getcarinspectionAction(){
//                if(check_is_ajax($this->_request)){
//			$this->_redirect(APPLICATION_URL);
//		}
//                $agency_id=$this->_getParam("agencyid");
//                $formid=25;
//                
//                
//		$this->dbObj = Zend_Registry::get('db');
//		$aColumns = array('ci_id','ci_form_id','ci_agency_id','ci_individual_id','ci_inspection_date','ci_modified_by','ci_modified_on','ci_added_date','ci_added_by','ci_communication','ci_lights','ci_secure_storage_space','ci_fire_extinguisher','ci_windshield_washer_wipers','ci_emergency_equipment','ci_mirrors','ci_horn','ci_tires','ci_brakes','ci_seat_belt','ci_wheelchair_fasteners','ci_restraints','ci_ramp_hydraulic_lift','ci_license_plate_number','ci_code');
//		$sIndexColumn = 'ci_id';
//		$sTable = '_uhs_car_inspection';
//		$sLimit = "";
//		if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' ){
//			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
//		}
//		$sOrder = "";
//		if ( isset( $_GET['iSortCol_0'] ) )
//		{
//			$sOrder = "ORDER BY  ";
//			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
//			{
//				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
//				{
//					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
//						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
//				}
//			}
//			
//			$sOrder = substr_replace( $sOrder, "", -2 );
//			if ( $sOrder == "ORDER BY" ){
//				$sOrder = "";
//			}
//		}
//		$sWhere = "";
//		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
//			$sWhere = "WHERE (";
//			for ( $i=0 ; $i<count($aColumns) ; $i++ )
//			{
//				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
//			}
//			$sWhere = substr_replace( $sWhere, "", -3 );
//			$sWhere .= ')';
//		}
//		for ( $i=0 ; $i<count($aColumns) ; $i++ )
//		{
//			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
//			{
//				if ( $sWhere == "" )
//				{
//					$sWhere = "WHERE ";
//				}
//				else
//				{
//					$sWhere .= " AND ";
//				}
//				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
//			}
//		}
//                
//		if($sWhere){
//                    $sWhere.=" and ci_form_id=".$formid." and ci_agency_id='".$agency_id."'"; 
//                }
//                else{
//                        $sWhere.=" where ci_form_id=".$formid." and ci_agency_id='".$agency_id."'";  
//                }
//		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
//                
//                $qry = $this->dbObj->query($sQuery)->fetchAll();
//                
//                $sQuery = "SELECT FOUND_ROWS() as fcnt";
//		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
//		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
//		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
//		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
//		$iTotal = $rResultTotal[0]['cnt'];
//		$output = array(
// 				"iTotalRecords" => $iTotal,
//				"iTotalDisplayRecords" => $iFilteredTotal,
//				"aaData" => array()
//			);
//		$j=0;
//		foreach($qry as $row1){
//			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$row1['ci_added_by']);
//			//$daddata=$this->SuperModel->Super_Get("_uhs_dad","dad_da_id=".$row1['da_id']." and dad_added_user='".$this->view->user->agency_id."' and DATE(dad_added_date)='".date('Y-m-d')."'","fetch");
//                        $cidatas=$this->SuperModel->Super_Get("_uhs_vehicle","ve_id='".$row1['ci_license_plate_number']."'","fetch");
//                        $modifierData=array();
//			if($row1['ci_modified_by']!=0){
//				$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$row1['ci_modified_by']);
//			}
//			$row=array();
// 			$row[] = $j+1;
//			$row[]='<input class="elem_ids checkboxes" type="checkbox" name="records['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';
//                        $row[]=formatDate($row1['ci_inspection_date']);
//                        $row[]=$row1['ci_code'];
//                        
//			
//			$row[]=$cidatas['ve_licence_plate_number'];
//			$userType=printUserType($creatorData);
//			$row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
//			$your_date = date("m/d/Y H:i:s", strtotime($row1['ci_added_date'])); 
//			$row[]=$your_date;
//                        
//                        if($row1['ci_secure_storage_space']){
//                            $row[] ="Clear";
//                        }else{
//                            $row[]="Not clear";
//                        }
//                        
//                        if($row1['ci_communication']){
//                            $row[] ="Working";
//                        }else{
//                            $row[]="Not working";
//                        }
//                        
//                        if($row1['ci_fire_extinguisher']){
//                             $row[] ="Yes";
//                        }else{
//                            $row[]="No";
//                        }
//                        
//                        if($row1['ci_lights']){
//                             $row[] ="Yes";
//                        }else{
//                            $row[]="No";
//                        }
//                        
//                         if($row1['ci_windshield_washer_wipers']){
//                             $row[] ="Yes";
//                        }else{
//                            $row[]="No";
//                        }
//                        
//                        if($row1['ci_emergency_equipment']){
//                            $row[] ="Secured";
//                        }else{
//                            $row[]="Not secured";
//                        }
//                        
//                        if($row1['ci_mirrors']){
//                             $row[] ="Yes";
//                        }else{
//                            $row[]="No";
//                        }
//                        
//                        if($row1['ci_horn']){
//                             $row[] ="Yes";
//                        }else{
//                            $row[]="No";
//                        }
//                        
//                        if($row1['ci_tires']){
//                             $row[] ="Yes";
//                        }else{
//                            $row[]="No";
//                        }
//                        
//                         if($row1['ci_brakes']){
//                             $row[] ="Yes";
//                        }else{
//                            $row[]="No";
//                        }
//                        
//                         if($row1['ci_seat_belt']){
//                             $row[] ="Yes";
//                        }else{
//                            $row[]="No";
//                        }
//                        
//                        
//                        
//                        if($row1['ci_wheelchair_fasteners']){
//                             $row[]="Working";
//                        }else{
//                           $row[]="Not working"; 
//                        }
//                        
//                        if($row1['ci_restraints']){
//                            $row[] ="Yes";
//                        }else{
//                            $row[]="No";
//                        }
//                        
//                        if($row1['ci_ramp_hydraulic_lift']){
//                            $row[] ="working";
//                        }else{
//                            $row[]="Not working"; 
//                        }
//                        
//                        
//			if(!empty($modifierData)){
//				$userType=printUserType($modifierData);
//				$row[]=ucwords($modifierData['agency_first_name']." ".$modifierData['agency_last_name'])."&nbsp;".$userType;
//                                $row[]=formatDate($row1['ci_modified_on']);
//			}
//			else{
//				$row[]="-";
//				$row[]="-";
//				
//			}
//                        $editLink="";
//			if($this->view->user->agency_user_type=="Agency"){
//                            //$editLink = "&nbsp;<a href='javascript:void(1);' style='margin-top:5px;' onClick='showSupportForm(" . $indid . "," . $formid . "," . $row1['support_id'] . ");' class='btn btn-xs btn-default'>Edit Support</a>";
//                            $url = APPLICATION_URL."/edit-car-inspection/".$row1[$sIndexColumn];
//                            $editLink = "<a style='margin-top:5px;' href='".$url."' class='btn btn-xs btn-default'>Edit</a><BR>";
//			}
////                        if(!empty($daddata)){
////                            
////                            if(date("m")==date("m",strtotime($row1['da_added_date']))){
////				//$row[]="<a style='margin-top:5px;' href='javascript:void(1);' onClick=showDiffrentForms(".$indid.",".$formid.",".$row1[$sIndexColumn].",'AssignedMileage') class='btn btn-xs btn-default'>Edit</a>";
////				$url1 = APPLICATION_URL."/edit-dad/".$indid."/".$formid."/".$daddata['dad_id']."/".$row1[$sIndexColumn];
////                                $row[]=$editLink."&nbsp;<a style='margin-top:5px;' href='".$url1."' class='btn btn-xs btn-default'>Edit Documentation</a>";
////                            }else{
////                                    $row[]="<b>NA</b>";
////                            }
////                            
////                            
////                        }else{
//                            if(date("m")==date("m",strtotime($row1['ci_added_date']))){
//				//$row[]="<a style='margin-top:5px;' href='javascript:void(1);' onClick=showDiffrentForms(".$indid.",".$formid.",".$row1[$sIndexColumn].",'AssignedMileage') class='btn btn-xs btn-default'>Edit</a>";
//				$url1 = APPLICATION_URL."/add-record-atrip/".$row1[$sIndexColumn];
//                                $row[]=$editLink."&nbsp;<a style='margin-top:5px;' href='".$url1."' class='btn btn-xs btn-default'>Record a trip</a>";
//                            }else{
//                                    $row[]="<b>NA</b>";
//                            }
//                            
//                        //}
//			
// 			$output['aaData'][] = $row;
//			$j++;
//		}
//		echo json_encode($output);
//		exit();
//	}
        
        
        
        // Recor A Trip
                        
                        
        public function recordatripAction(){	
		global $healthSession; 
  		$this->view->pageHeading = "Record a trip";
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		
		$this->view->permissions=$permissions;
		$this->view->indid=$indid;
		$this->view->formid=$formid;
		$this->view->id=$id;
		
  	}


public function addrecordatripAction(){
        
        global $healthSession;
        global $systemusers;
        
        $formid=26;
        $id=$this->_getParam("id");
        $ci_id=$this->_getParam("ci_id");
		if($this->view->user->agency_user_type =="Agency"){ 
            
            $type= $this->view->user->agency_user_type;
            $agency_id= $this->view->user->agency_id;
            if($this->view->user->is_subuser == 1){
                $agency_id= $this->view->user->agency_user_agency_id;
            }
            
        }
        elseif(in_array($this->view->user->agency_user_type,$systemusers)){
            $type= $this->view->user->agency_user_type;
            $agency_id= $this->view->user->agency_user_agency_id;
        }
        $form=new Application_Form_CustomForms();
        $headingText="";
        $document="";
        if(empty($id)){
            $id=0;
        }
        if(empty($ci_id)){
            $ci_id="";
        }
        if(!empty($id)){
            $headingText="Edit";
        }
        $this->view->trip_choose_one=0;
        $headingText.=" Record a trip";
        $form->recordATirpForm($agency_id,$type,$formid,$id,$ci_id);
        if(!empty($id)){
            $logData=$this->SuperModel->Super_Get("_uhs_record_a_trip","trip_id=".$id,"fetch");
            if(!empty($logData)){
//                if(!empty($logData['trip_choose_individual_id'])){
//                        $implode = explode(",",$logData['trip_choose_individual_id']);
//                        for($i = 0; $i < count($implode); $i++){
//                            $temp[]=$implode[$i];
//                        }
//                    }
                $logData['trip_choose_ci_id'] = $logData['trip_choose_ci_id'];
                $logData['trip_choose_individual_id'] = $logData['trip_individual_id'];
                //prd($logData);
                $logData['trip_service_date']=date('m/d/Y',strtotime($logData['trip_service_date']));
                $this->view->trip_choose_one=$logData['trip_choose_one'];
                
                $form->populate($logData);
            }
        }
        if(empty($id)){
            $id="";
        }
        $this->view->pageHeading=$headingText;
        $this->view->form=$form;		
        $this->view->id=$id;
        //$this->view->indid=$indid;
        $this->view->formid=$formid;
    }
	public function saverecordatripAction(){
                global $healthSession,$systemusers;
                    $formid=$this->_getParam("formid");
                    $id=$this->_getParam("id");
                    if($this->view->user->agency_user_type =="Agency"){ 
			$type= $this->view->user->agency_user_type;
                        $agency_id= $this->view->user->agency_id;
                        if($this->view->user->is_subuser == 1){
                            $agency_id= $this->view->user->agency_user_agency_id;
                        }
                    }
                    elseif(in_array($this->view->user->agency_user_type,$systemusers)){
                        $type= $this->view->user->agency_user_type;
                        $agency_id= $this->view->user->agency_user_agency_id;
                    }
                $form=new Application_Form_CustomForms();
		$form->recordATirpForm($agency_id,$type,$formid,$id);
		
		if($this->getRequest()->isPost()){
			$posted_data = $this->getRequest()->getPost();
                        
			unset($posted_data['bttnsubmit']);
                        
   			//if($form->isValid($posted_data)){
                               
				$posted_data['trip_service_date']=date("Y-m-d",strtotime($posted_data['trip_service_date']));
				$maxAddMore = 7;
				if(empty($id)){
                                        $recordatrip_group_code=getRandomString(6);
					$participantIds = "";
					$flag=0;
					foreach($posted_data['trip_choose_individual_id'] as $index =>$mlog_choose_individual_id){
						if(!empty($mlog_choose_individual_id)){
							if($flag > 0){
								$addComma=",";
							}else{
								$addComma="";
							}
							$participantIds .=$addComma.$posted_data['trip_choose_individual_id'][$index];
							$flag++;
						}

					}
                                        
                                        foreach($posted_data['trip_choose_individual_id'] as $index =>$choose_indid){
                                            if(!empty($choose_indid)){
                                                $indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$choose_indid,"fetch");
                                                $agencyData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indData['agency_user_agency_id']);
                                                $posted_data['trip_code']=getRandomString(6);
                                                $posted_data['trip_group_code']=$recordatrip_group_code;
                                                $posted_data['trip_agency_id']=$agencyData['agency_id'];
                                                $posted_data['trip_individual_id']=$choose_indid;
                                                $posted_data['trip_form_id']=$formid;
                                                $posted_data['trip_added_date']=date('Y-m-d H:i:s');
                                                $posted_data['trip_modified']=NULL;
                                                $posted_data['trip_added_user']=$this->view->user->subuser_id; //$this->view->user->agency_id;
                                                $posted_data['trip_choose_individual_id']=$participantIds;
//                                                
                                                if($posted_data['chosse_your_trip'] == 1 || $posted_data['chosse_your_trip'] == 2) {
                                                        for($i = 1; $i <= $maxAddMore; $i++){
                                                               $posted_data['trip_to_latitude'.$i]="";
                                                               $posted_data['trip_to_longitude'.$i]="";
                                                       }
                                                } else if($posted_data['chosse_your_trip'] == 3){
                                                       $posted_data['trip_to_latitude']="";
                                                       $posted_data['trip_to_longitude']="";
                                                }
                                                $isInserted = $this->SuperModel->Super_Insert("_uhs_record_a_trip",$posted_data);
                                                if($isInserted->success){
                                                       if(in_array($this->view->user->agency_user_type,$systemusers) && checkNotifySettings($this->view->user->agency_user_agency_id,"form-".$formid)){
                                                               $notifyData=array("notification_user_id"=>$this->view->user->agency_user_agency_id,"notification_type"=>"form-".$formid,"notification_type_id"=>$isInserted->inserted_id,"notification_by_user_id"=>$this->view->user->agency_id,"notification_date"=>date("Y-m-d H:i:s"));
                                                               $isNotify=$this->SuperModel->Super_Insert("_uhs_notifications",$notifyData);
                                                       }
                                                       $healthSession->successMsg  = "Record a trip has been added successfully.";
                                                }else{
                                                       $healthSession->errorMsg  = $isInserted->message;
                                                }
                                            }

                                        }
				}
				else{
                                         unset($posted_data['trip_choose_individual_id']);
					if($posted_data['chosse_your_trip'] == 1 || $posted_data['chosse_your_trip'] == 2) {
						for($i = 1; $i <= $maxAddMore; $i++){
							$posted_data['trip_to_location'.$i]="";
							$posted_data['trip_to_latitude'.$i]="";
							$posted_data['trip_to_longitude'.$i]="";
							$posted_data['trip_to_comment'.$i]="";
						}
						
					} else if($posted_data['chosse_your_trip'] == 3){
						$posted_data['trip_to_location']="";
						$posted_data['trip_to_latitude']="";
						$posted_data['trip_to_longitude']="";
						
					}
					$posted_data['trip_modified_by']=$this->view->user->subuser_id;
					$posted_data['trip_modified']=date('Y-m-d H:i:s');
					$isInserted = $this->SuperModel->Super_Insert("_uhs_record_a_trip",$posted_data,"trip_id=".$id);
					if($isInserted->success){
						$healthSession->successMsg  ="Record a trip has been updated successfully.";
					 }else{
						$healthSession->errorMsg  = $isInserted->message;
					 }
				}
				 
   			//}else{
				//$healthSession->errorMsg = " Please check information again.";
 			//}
		 }
                 
		 $this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_add_record_atrip");
	}



	
	public function getrecordsatripAction(){
		if(check_is_ajax($this->_request)){
			$this->_redirect(APPLICATION_URL);
		}
		$indid=$this->_getParam("indid");
		$formid=$this->_getParam("formid");
		$id=$this->_getParam("id");
		$subuser=$dstarts=$dends=$wcode="";
		if(isset($_REQUEST['subuser']) && !empty($_REQUEST['subuser'])){
			$subuser=$_REQUEST['subuser'];
		}
		if(isset($_REQUEST['dstarts']) && !empty($_REQUEST['dstarts'])){
			$dstarts=$_REQUEST['dstarts'];
		}
		if(isset($_REQUEST['dends']) && !empty($_REQUEST['dends'])){
			$dends=$_REQUEST['dends'];
		}
		if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
			$month=$_REQUEST['month'];
		}
		if(isset($_REQUEST['year']) && !empty($_REQUEST['year'])){
			$year=$_REQUEST['year'];
		}	
		if(isset($_REQUEST['trip_id']) && !empty($_REQUEST['trip_id'])){
			$trip_id=$_REQUEST['trip_id'];
		}	
		if(isset($_REQUEST['ci_id']) && !empty($_REQUEST['ci_id'])){
			$ci_id=$_REQUEST['ci_id'];
		}	
		if(isset($_REQUEST['indiv_id']) && !empty($_REQUEST['indiv_id'])){
			$indiv_id=$_REQUEST['indiv_id'];
		}	
 		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('trip_id','trip_added_user','trip_individual_id','trip_service_date','trip_from_location','trip_to_location','trip_total_miles','trip_activity_description','trip_added_date','trip_from_latitude','trip_from_longitude','trip_to_latitude','trip_to_longitude','trip_starting_mileage','trip_remaining_mileage','trip_modified','trip_ending_mileage','trip_modified_by','trip_modified','chosse_your_trip','trip_to_location1','trip_to_location2','trip_to_location3','trip_to_latitude1','trip_to_latitude2','trip_to_latitude3','trip_to_latitude4','trip_to_latitude5','trip_to_latitude6','trip_to_latitude7','trip_to_longitude1','trip_to_longitude2','trip_to_longitude3','trip_to_longitude4','trip_to_longitude5','trip_to_longitude6','trip_to_longitude7','trip_choose_ci_id','trip_choose_individual_id','trip_start_time','trip_end_time','trip_total_service_time','trip_code');
		$sIndexColumn = 'trip_id';
		$sTable = '_uhs_record_a_trip';
		$sLimit = "";
		if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' ){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		if ( isset( $_GET['iSortCol_0'] ) )
		{
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
			{
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
				{
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
		if(empty($subuser)){
			$indParentUsers="";
			if($this->view->user->agency_user_type=="Agency"){
				$systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_id,"fetchAll",array("fields"=>"agency_id"));
				$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
				$indParentUsers=implode_r(",",$systemUsers);
                                if(!empty($indiv_id)){
                                    $indid = $indiv_id;
                                }
                                if($sWhere){
                                    $sWhere.=" and trip_added_user IN(".$indParentUsers.") and trip_individual_id='".$indid."'"; 
                                }
                                else{
                                    $sWhere.=" where trip_added_user IN(".$indParentUsers.") and trip_individual_id='".$indid."'"; 
                                }
			}
			else{
                            $indParentUsers=$this->view->user->agency_id;
                            if($sWhere){
                                $sWhere.=" and trip_added_user IN(".$indParentUsers.") and trip_individual_id='".$indid."'";
                            }
                            else{
                                $sWhere.=" where trip_added_user IN(".$indParentUsers.") and trip_individual_id='".$indid."'"; 
                            }
			}
		}
		else{
			if($sWhere){
                            $sWhere.=" and trip_added_user IN(".$subuser.") and trip_individual_id='".$indid."'"; 
                        }
			else{
                            $sWhere.=" where trip_added_user IN(".$subuser.") and trip_individual_id='".$indid."'";
                        }
		}
		if(!empty($dstarts)){
			$sWhere.=" and DATE(trip_service_date) >='".$dstarts."'";
		}
		if(!empty($dends)){
			$sWhere.=" and DATE(trip_service_date) <='".$dends."'";
		}
		if(!empty($month)){
			$sWhere.=" and MONTH(trip_service_date)='".$month."'";
		}
		if(!empty($year)){
			$sWhere.=" and YEAR(trip_service_date)='".$year."'";
		}
		if(!empty($trip_id)){
			$sWhere.=" and trip_id='".$trip_id."'";
		}
		if(!empty($ci_id)){
			$sWhere.=" and trip_choose_ci_id='".$ci_id."'";
		}
		if(!empty($id) && $id!=0){
			$sWhere.=" and trip_id=".$id;
		}
		if(empty($month) && empty($year) && empty($dstarts) && empty($dends) && empty($trip_id) && empty($ci_id) && empty($subuser) && empty($indiv_id)){
                    if(!empty($sWhere)){
                        $sWhere.=" and MONTH(trip_added_date)=MONTH(CURDATE()) and YEAR(trip_added_date)=YEAR(CURDATE())";
                    }else{
                        $sWhere.=" where MONTH(trip_added_date)=MONTH(CURDATE()) and YEAR(trip_added_date)=YEAR(CURDATE())";
                    }
                }
		/*if(empty($sOrder)){
			$sOrder.="order by trip_added_date DESC, trip_modified DESC";
		}*/
		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";

 		$qry = $this->dbObj->query($sQuery)->fetchAll();
		$sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
		$output = array(
 				"iTotalRecords" => $iTotal,
				"iTotalDisplayRecords" => $iFilteredTotal,
				"aaData" => array()
			);
		$j=0;
		$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		foreach($qry as $row1){
			
			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['trip_added_user']."'","fetch");
			
                        $vedatas=$this->SuperModel->Super_Get("_uhs_car_inspection","ci_id='".$row1['trip_choose_ci_id']."'","fetch");
                        $cidatas=$this->SuperModel->Super_Get("_uhs_vehicle","ve_id='".$vedatas['ci_license_plate_number']."'","fetch");
                       //$cidatas=$this->SuperModel->Super_Get("_uhs_car_inspection","ci_id='".$row1['trip_choose_ci_id']."'","fetch");
                        $ci_id = $vedatas['ci_id'];
                        $modifierData=array();
			if($row1['trip_modified_by']!=0){
				$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['trip_modified_by']."'","fetch");
			}
			$row=array();
 			$row[] = $j+1;
			$row[]='<input class="elem_ids checkboxes" type="checkbox" name="records['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';
			$row[]=formatDate($row1['trip_service_date']); 
			$row[]=$row1['trip_code'];
			$Flat="'".$row1['trip_from_latitude']."'";
			$Flong="'".$row1['trip_from_longitude']."'";
			$From="'".trim(preg_replace('/\s\s+/', ' ',$row1['trip_from_location']))."'";
			$row[]=ucwords($row1['trip_from_location']).'<i class="fa fa-map-marker markers pull-right" title="View Address on Map" onclick="showMap('.$Flat.','.$Flong.','.$From.');"></i>';
			
			if($row1['chosse_your_trip'] == 1 || $row1['chosse_your_trip'] == 2 || $row1['chosse_your_trip'] == 0){
				$Tlat="'".$row1['trip_to_latitude']."'";
				$Tlong="'".$row1['trip_to_longitude']."'";
				$To="'".trim(preg_replace('/\s\s+/', ' ',$row1['trip_to_location']))."'";
				$row[]=ucwords($row1['trip_to_location']).'<i class="fa fa-map-marker markers pull-right" title="View Address on Map" onclick="showMap('.$Tlat.','.$Tlong.','.$To.');"></i>';
				//$row[]=ucwords($row1['trip_to_location']).'<i class="fa fa-map-marker markers" style="padding-left:10px;" title="View Address on Map" onclick="showMap('.$Tlat.','.$Tlong.','.$To.');"></i>';
			
                                $row[]="<a href='javascript:void(1);'  onClick='showVehicleInspInfo(".$ci_id.")'>View VI Info</a>";
                        } elseif($row1['chosse_your_trip'] == 3){
				$Tlat1="'".$row1['trip_to_latitude1']."'";
				$Tlong1="'".$row1['trip_to_longitude1']."'";
				$To1="'".trim(preg_replace('/\s\s+/', ' ',$row1['trip_to_location1']))."'";
				$row[]= ucwords($row1['trip_to_location1']).'<i class="fa fa-map-marker markers pull-right" title="View Address on Map" onclick="showMap('.$Tlat1.','.$Tlong1.','.$To1.');"></i>';
				
				$loc1=ucwords($row1['trip_to_location1']).'<i class="fa fa-map-marker markers" style="padding-left:10px;" title="View Address on Map" onclick="showMap('.$Tlat1.','.$Tlong1.','.$To1.');"></i>';
				$Tlat2="'".$row1['trip_to_latitude2']."'";
				$Tlong2="'".$row1['trip_to_longitude2']."'";
				$To2="'".trim(preg_replace('/\s\s+/', ' ',$row1['trip_to_location2']))."'";
				
				$Tlat3="'".$row1['trip_to_latitude3']."'";
				$Tlong3="'".$row1['trip_to_longitude3']."'";
				$To3="'".trim(preg_replace('/\s\s+/', ' ',$row1['trip_to_location3']))."'";
				
				$loc2=ucwords($row1['trip_to_location2']).'<i class="fa fa-map-marker markers" style="padding-left:10px;" title="View Address on Map" onclick="showMap('.$Tlat2.','.$Tlong2.','.$To2.');"></i>';
				$loc3=ucwords($row1['trip_to_location3']).'<i class="fa fa-map-marker markers" style="padding-left:10px;" title="View Address on Map" onclick="showMap('.$Tlat3.','.$Tlong3.','.$To3.');"></i>';
				
				//$row[]= $loc1." , ".$loc2." , ".$loc3;
                                $row[]="<a href='javascript:void(1);'  onClick='showVehicleInspInfo(".$ci_id.")'>View VI Info</a>";
			}
			
			
			if($row1['chosse_your_trip'] == 1 || $row1['chosse_your_trip'] == 2 || $row1['chosse_your_trip'] == 0){
				$row[]=$row1['trip_total_miles'].'<form class="getdirform" method="get" target="iFrame">
					<input id="origin'.$row1['trip_id'].'" value="'.$row1['trip_from_location'].'" name="origin'.$row1['trip_id'].'" type="hidden"/>
					<input id="destination'.$row1['trip_id'].'" value="'.$row1['trip_to_location'].'" name="destination'.$row1['trip_id'].'" type="hidden"/>
					<input id="key" type="hidden" name="key" value="AIzaSyB7V6-2XNLLucSV2IlVU4ES40B7pmR3NzE">
					<input style="margin-top:12px;" class="btn btn-xs btn btn-success frm" type="button" value="Get Direction" onclick="showDirectionMap('.$row1['trip_id'].');"/>
					</form>';
			} else {
				$row[]=$row1['trip_total_miles'];
			} 
                        $chossetrip ="NA";
                        
                            if($row1['chosse_your_trip'] != 3){
                                $chossetrip=$row1['chosse_your_trip'];
                            }
                        
                         
                        $row[]=$chossetrip;
                        if(!empty($cidatas['ve_description'])){
                            $ve_description= " - ".$cidatas['ve_description'];
                        }
                        if(!empty($cidatas['ve_vin_number'])){
                            $vin_number= " - ".$cidatas['ve_vin_number'];
                        }
                        $row[]=$cidatas['ve_licence_plate_number'].$ve_description.$vin_number; 
                        $row[]=$row1['trip_remaining_mileage'];
                        $row[]=number_format($row1['trip_ending_mileage']);
                          $flag = 0;
                        if(!empty($row1['trip_choose_individual_id']) && $row1['trip_choose_individual_id'] !='Array'){
                            $implode = explode(",",$row1['trip_choose_individual_id']);
                            
                            for($i = 0; $i < count($implode); $i++){
                                if($flag > 0){
                                    $addComma = " , ";
                                }
                                else{
                                    $addComma = "";
                                };
                                $indidData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$implode[$i]);
                                $mlog_choose_indid_id .=$addComma.ucwords($indidData['agency_first_name']." ".$indidData['agency_last_name']);
                            
                                $flag++;
                            }
                        }else{
                                $indidData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$row1['trip_individual_id']);
                                $mlog_choose_indid_id =ucwords($indidData['agency_first_name']." ".$indidData['agency_last_name']);
                        }
                        $row[]=$mlog_choose_indid_id;
                        
//                        $indidData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$row1['trip_individual_id']);
//                        $trip_choose_indid_id =ucwords($indidData['agency_first_name']." ".$indidData['agency_last_name']);
//                        $row[]=$trip_choose_indid_id;
                        $row[]=$row1['trip_start_time']; 
                        $row[]=$row1['trip_end_time'];
                        $row[]=$row1['trip_total_service_time'];
                        
		    $row[]=$row1['trip_activity_description'];
			$userType=printUserType($creatorData);
  			$row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
			$your_date = date("m/d/Y H:i:s", strtotime($row1['trip_added_date'])); 
			$row[]=$your_date;
			if(!empty($modifierData)){
				$userType=printUserType($modifierData);
				$row[]=ucwords($modifierData['agency_first_name']." ".$modifierData['agency_last_name'])."&nbsp;".$userType;
				$row[]=formatDateTimeNew($row1['trip_modified']);
			}else{
				$row[]="-";
				$row[]="-";
			}
			$type='"Mileage"';
			if(($permissions=="Edit" || $permissions=="Both") && !isFormAssigned($formid,$indid) && date("m")==date("m",strtotime($row1['trip_added_date']))){
				$url =  APPLICATION_URL."/edit-record-atrip/".$row1[$sIndexColumn];
				$row[]="<a style='margin-top:5px;' href='".$url."' class='btn btn-xs btn-default'>Edit</a>";
			}
			else{
				$row[]="<b>NA</b>";
			}
                        $output['aaData'][] = $row;
			$j++;
		}
                
		echo json_encode($output);
		exit();
	}
	
//	public function removerecordatripAction(){
//		global $healthSession;
//		$indid=$this->_getParam('indid');
//		$formid=$this->_getParam('formid');
// 		$this->_helper->layout->disableLayout();
//		$this->_helper->viewRenderer->setNoRender(true);
//		$formData = $this->getRequest()->getPost();
//		if(isset($formData['records']) && count($formData['records'])) {
//			foreach($formData['records'] as $key=>$values){
//  				$isDel=$this->SuperModel->Super_Delete('_uhs_record_a_trip',"trip_id=".$values);
// 				$healthSession->successMsg=" Report A Trip has been deleted successfully.";
//			}
//		}
//		else{
//			$healthSession->errorMsg = "Invalid Request.";
//		}
//		$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_view_record_atrip");
//	}
        
        
        public function removerecordatripAction(){
		global $healthSession;
		$indid=$this->_getParam('indid');
		$formid=$this->_getParam('formid');
 		$this->_helper->layout->disableLayout();
		$this->_helper->viewRenderer->setNoRender(true);
		$formData = $this->getRequest()->getPost();
		if(isset($formData['records']) && count($formData['records'])) {
			foreach($formData['records'] as $key=>$values){
				$logData=$this->SuperModel->Super_Get('_uhs_record_a_trip',"trip_id=".$values,"fetch");
				if(is_null($logData['trip_group_code'])){
				  $isDel=$this->SuperModel->Super_Delete('_uhs_record_a_trip',"trip_id=".$values);
				}else{
  				  $isDel=$this->SuperModel->Super_Delete('_uhs_record_a_trip',"trip_group_code='".$logData['trip_group_code']."'");
			    }
 				$healthSession->successMsg=" Report a trip has been deleted successfully.";
			}
		}
		else{
			$healthSession->errorMsg = "Invalid Request.";
		}
                if(!empty($indid) && !empty($formid)){
                    $this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_view_record_atrip");
                } else {
                    $this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_view_all_record_atrip");
                }
	}
                        
        
        // End code added by amit on 17-may-2018 with vehicle & record a trip functionality
      
   //Group ClockIn timing sheet   
      public function clockinAction(){	
        global $healthSession;
        global $systemusers;
        $id=$this->_getParam("id");
       
		if($this->view->user->agency_user_type =="Agency"){ 
            
            $type= $this->view->user->agency_user_type;
            $agency_id= $this->view->user->agency_id;
            if($this->view->user->is_subuser == 1){
                $agency_id= $this->view->user->agency_user_agency_id;
            }
            
        }
        elseif(in_array($this->view->user->agency_user_type,$systemusers)){
            $type= $this->view->user->agency_user_type;
            $agency_id= $this->view->user->agency_user_agency_id;
        }   
        $rec = $this->SuperModel->Super_Get("_uhs_timing_sheets","service_agency_id='".$agency_id."' and service_added_user='".$this->view->user->agency_id."' and service_type = 'Group'","fetch",array("order"=>"sheet_id DESC",'limit'=>1));
       
        $form=new Application_Form_CustomForms();            
			if($rec['is_sheet_completed']=="1" || empty($rec)){
			 $this->view->pageHeading="Add Group Clock In Sheet";
			 $form->grouptimingSheets($agency_id,$type,$id);
			 $this->view->form=$form;
			}else{
				$healthSession->errorMsg="You are currently clocked in. You will need to clock out before performing this function";
				$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
			}
		    
	   }
	   
	public function clockoutAction(){	
		global $healthSession;
		global $systemusers;
		$id=$this->_getParam("id");
		if($this->view->user->agency_user_type =="Agency"){ 
			
			$type= $this->view->user->agency_user_type;
			$agency_id= $this->view->user->agency_id;
			if($this->view->user->is_subuser == 1){
				$agency_id= $this->view->user->agency_user_agency_id;
			}
			
		}
		elseif(in_array($this->view->user->agency_user_type,$systemusers)){
			$type= $this->view->user->agency_user_type;
			$agency_id= $this->view->user->agency_user_agency_id;
		}    
		$rec = $this->SuperModel->Super_Get("_uhs_timing_sheets","service_agency_id='".$agency_id."' and service_added_user='".$this->view->user->agency_id."' and service_type = 'Group'","fetch",array("order"=>"sheet_id DESC",'limit'=>1));
		 $form=new Application_Form_CustomForms();      
		 $this->view->pageHeading="Edit Group Clock In Sheet";
		 if(empty($rec)){
			 $healthSession->errorMsg="You will need to clock In before performing this function";
			 $this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		 }else{
			  if(empty($id) || $id==0){
				  $id = $rec['sheet_id'];
		      }
		 $form->grouptimingSheets($agency_id,$type,$id);
		 $logData=$this->SuperModel->Super_Get("_uhs_timing_sheets","sheet_id=".$id,"fetch");
		 if(!empty($logData)){
			$logData['service_date']=date('m/d/Y',strtotime($logData['service_date']));
			if(!empty($logData['service_individual_id'])){
					$implode = explode(",",$logData['service_individual_id']);
					for($i = 0; $i < count($implode); $i++){
						$temp[]=$implode[$i];
					}
				}
		  }
		$implode_ration = explode(":",$logData['service_ration']);
		$logData['service_individual_id'] = $temp;
		$logData['service_ration'] = $implode_ration[0];
		$this->view->service_rations = $implode_ration[1];
		$form->populate($logData);
		$this->view->form=$form;
		$this->view->id = $id;	
	   }
    }
	   
	   	public function saveclockinAction(){
            global $healthSession,$systemusers;
                   
            if($this->view->user->agency_user_type =="Agency"){ 
				$type= $this->view->user->agency_user_type;
				$agency_id= $this->view->user->agency_id;
				if($this->view->user->is_subuser == 1){
					$agency_id= $this->view->user->agency_user_agency_id;
				}
            }elseif(in_array($this->view->user->agency_user_type,$systemusers)){
				$type= $this->view->user->agency_user_type;
				$agency_id= $this->view->user->agency_user_agency_id;
            }  
           $formid=3;  
           $form=new Application_Form_CustomForms();      
           $form->grouptimingSheets($agency_id,$type);       
		   if($this->getRequest()->isPost()){
				$posted_data = $this->getRequest()->getPost();
				unset($posted_data['bttnsubmit']);
				
				if($form->isValid($posted_data)){
				     $posted_data['service_date']=date("Y-m-d",strtotime($posted_data['service_date']));
				     $id = $posted_data['sheet_id'];
				if(empty($id)){
					 $individual_id="";
					  foreach($posted_data['service_individual_id'] as $key=>$value){
						  $individual_id .= $value.",";
					  }
				     $indid = rtrim($individual_id,',');
				     $posted_data['service_individual_id']=$indid;
					 $posted_data['service_agency_id']=$agency_id;
					 $posted_data['service_ration']=$posted_data['service_ration'].":".$posted_data['service_rations'];
					 $posted_data['service_type'] = 'Group';
					 $posted_data['service_form_id']=$formid;
					 $posted_data['sheet_added_date']=date('Y-m-d H:i:s');
					 $posted_data['service_added_user']=$this->view->user->subuser_id; //$this->view->user->agency_id;
					 unset($posted_data['service_rations']);
					// prd($posted_data);
					 //$isAlreadyTimeExist=$this->SuperModel->Super_Get("_uhs_timing_sheets","service_individual_id='".$indid."' and service_type='Group' and service_start_time='".$posted_data['service_start_time']."' and service_date='".$posted_data['service_date']."'");
					//if(empty($isAlreadyTimeExist)){
					 	$isInserted = $this->SuperModel->Super_Insert("_uhs_timing_sheets",$posted_data);
						 if($isInserted->success){
							if(in_array($this->view->user->agency_user_type,$systemusers) && checkNotifySettings($this->view->user->agency_user_agency_id,"form-".$formid)){
								$notifyData=array("notification_user_id"=>$this->view->user->agency_user_agency_id,"notification_type"=>"form-".$formid,"notification_type_id"=>$isInserted->inserted_id,"notification_by_user_id"=>$this->view->user->agency_id,"notification_date"=>date("Y-m-d H:i:s"));
								$isNotify=$this->SuperModel->Super_Insert("_uhs_notifications",$notifyData);
							}
							$healthSession->successMsg="Group Time sheet has been added successfully.";
						 }else{
							$healthSession->errorMsg=$isInserted->message;
						 }
					//}
					//else{
						//~ $creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$isAlreadyTimeExist['service_added_user'],"fetch");
						//~ if($creatorData['agency_id']!=$this->view->user->agency_id){
							//~ $healthSession->errorMsg=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])." has already selected this time.";
						//~ }
						//~ else{
							//~ $healthSession->errorMsg="You have already selected this time.";
						//~ }
					//}
				}
				else{
					 $individual_id="";
					  foreach($posted_data['service_individual_id'] as $key=>$value)
					  {
						  $individual_id .= $value.",";
					  }
				     $indid = rtrim($individual_id,',');
				    $posted_data['service_individual_id']=$indid;
					$posted_data['is_sheet_completed']='1';
					$posted_data['sheet_modified_by']=$this->view->user->subuser_id;
					$posted_data['sheet_modified_on']=date('Y-m-d H:i:s');
					 $posted_data['service_ration']=$posted_data['service_ration'].":".$posted_data['service_rations'];
					 unset($posted_data['service_rations']);
					//prd($posted_data);
					//$isAlreadyTimeExist=$this->SuperModel->Super_Get("_uhs_timing_sheets","service_individual_id='".$indid."' and service_type='Group' and service_start_time='".$posted_data['service_start_time']."' and service_date='".$posted_data['service_date']."' and sheet_id!=".$id);
					//if(empty($isAlreadyTimeExist)){
						$isInserted = $this->SuperModel->Super_Insert("_uhs_timing_sheets",$posted_data,"sheet_id=".$id);
						if($isInserted->success){
							$healthSession->successMsg="Time sheet has been updated successfully.";
						 }else{
							$healthSession->errorMsg=$isInserted->message;
						 }
					//}else{
						//~ $creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$isAlreadyTimeExist['service_added_user'],"fetch");
						//~ if($creatorData['agency_id']!=$this->view->user->agency_id){
							//~ $healthSession->errorMsg=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])." has already selected this time.";
						//~ }
						//~ else{
							//~ $healthSession->errorMsg="You have already selected this time.";
						//~ }
					//}
				}
				 
   			}else{
				$healthSession->errorMsg="Please check information again.";
 			}
		 }
                 
		 $this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_group_timing_sheets");
	}
	public function grouptimingsheetsAction(){	
		global $healthSession; 
		$id=$this->_getParam("id");
  		$this->view->pageHeading = "Group Time Sheet";
  		$this->view->id = $id;

  	}
  	public function getgroputimingsheetsAction(){
		if(check_is_ajax($this->_request)){
			$this->_redirect(APPLICATION_URL);
		}
		$id=$this->_getParam("id");
		$subuser=$dstarts=$dends=$wcode="";
		if(isset($_REQUEST['subuser']) && !empty($_REQUEST['subuser'])){
			$subuser=$_REQUEST['subuser'];
		}
		if(isset($_REQUEST['dstarts']) && !empty($_REQUEST['dstarts'])){
			$dstarts=$_REQUEST['dstarts'];
			//$dstarts = date("Y-m-d", strtotime($_REQUEST['dstarts']));
		}
		if(isset($_REQUEST['dends']) && !empty($_REQUEST['dends'])){
			$dends=$_REQUEST['dends'];
			//$dends = date("Y-m-d", strtotime($_REQUEST['dends']));
		}	
		if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
			$month=$_REQUEST['month'];
		}
		if(isset($_REQUEST['year']) && !empty($_REQUEST['year'])){
			$year=$_REQUEST['year'];
		}	
		if(isset($_REQUEST['wcode']) && !empty($_REQUEST['wcode'])){
			$wcode=$_REQUEST['wcode'];
		}	
 		$this->dbObj = Zend_Registry::get('db');
		$aColumns = array('sheet_id','service_added_user','service_ration','service_individual_id','service_type','service_date','service_start_time','service_end_time','service_work_code','service_total_hours','total_miles_used','sheet_added_date','is_sheet_completed','service_other_work_code','sheet_modified_by','sheet_modified_on');
		$sIndexColumn = 'sheet_id';
		$sTable = '_uhs_timing_sheets';
		$sLimit = "";
		if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' ){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		
		if ( isset( $_GET['iSortCol_0'] ) )
		{
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
			{
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
				{
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		
		$sWhere = "";
		
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
		
		if(empty($subuser)){
			$indParentUsers="";
			if($this->view->user->agency_user_type=="Agency"){
                            $systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_id,"fetchAll",array("fields"=>"agency_id"));
                            $systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
                            $indParentUsers=implode_r(",",$systemUsers);
				if($sWhere){
				$sWhere.=" and service_added_user IN(".$indParentUsers.") and service_type='Group'"; 
				}else{
					$sWhere.=" where service_added_user IN(".$indParentUsers.") and service_type='Group'"; 
				}
                        }
                        else{
				$sharedUsers=isSharedModule("individual");
				if($sWhere){
					$sWhere.=" and service_individual_id IN(".$sharedUsers.") and service_type='Group'"; 
				}else{
					$sWhere.=" where service_individual_id IN(".$sharedUsers.") and service_type='Group'"; 
				}
				//~ $systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_user_agency_id,"fetchAll",array("fields"=>"agency_id"));
				//~ $systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_user_agency_id;
				//~ $indParentUsers=implode_r(",",$systemUsers);
				//~ //prd($indParentUsers);
				//~ if($sWhere){
				//~ $sWhere.=" and service_added_user='".$this->view->user->agency_id."' and service_type='Group'"; 
				//~ }else{
					//~ $sWhere.=" where service_added_user='".$this->view->user->agency_id."' and service_type='Group'"; 
				//~ }
                }
		}else{
			if($sWhere){
				$sWhere.=" and service_added_user IN(".$subuser.") and service_type='Group'"; 
			}
			else{
				$sWhere.=" where service_added_user IN(".$subuser.") and service_type='Group'"; 
			}
		}
		if(!empty($wcode)){
			$sWhere.=" and service_work_code='".$wcode."'";
		}
		if(!empty($dstarts)){
			$sWhere.=" and DATE(service_date) >='".$dstarts."'";
		}
		if(!empty($dends)){
			$sWhere.=" and DATE(service_date) <='".$dends."'";
		}
		if(!empty($month)){
			$sWhere.=" and MONTH(service_date)='".$month."'";
		}
		if(!empty($year)){
			$sWhere.=" and YEAR(service_date)='".$year."'";
		}
		if(!empty($id) && $id!=0){
			$sWhere.=" and sheet_id=".$id;
		}
		if(empty($month) && empty($year)){
                    if(!empty($sWhere)){
                    	if(empty($dstarts) && empty($dends)){
                            $sWhere.=" and MONTH(sheet_added_date)=MONTH(CURDATE()) and YEAR(sheet_added_date)=YEAR(CURDATE())";
                        }
                    }else{
                        $sWhere.=" where MONTH(sheet_added_date)=MONTH(CURDATE()) and YEAR(sheet_added_date)=YEAR(CURDATE())";
                    }
        }
		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
 		$qry = $this->dbObj->query($sQuery)->fetchAll();
		$sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
		$output = array(
 				"iTotalRecords" => $iTotal,
				"iTotalDisplayRecords" => $iFilteredTotal,
				"aaData" => array()
			);
		$j=0;
		//$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		foreach($qry as $row1){
			if(!empty($row1['service_individual_id'])){
				$name= "";
				$explode = explode(",",$row1['service_individual_id']);
				for($i = 0; $i < count($explode); $i++){
					$agencyData = $this->SuperModel->Super_Get("_uhs_agency","agency_id='".$explode[$i]."'","fetch");
					$name.=ucwords($agencyData['agency_first_name']." ".$agencyData['agency_last_name']).", ";
				}
            }
            $individuals_name=rtrim($name,' ,');
			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['service_added_user']."'","fetch");
			$modifierData=array();
			if($row1['sheet_modified_by']!=0){
				$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['sheet_modified_by']."'","fetch");
			}
			$row=array();
 			$row[] = $j+1;
			$row[]='<input class="elem_ids checkboxes" type="checkbox" name="records['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';
			$row[]=formatDate($row1['service_date']);
			$row[]=$individuals_name;
			if($row1['service_work_code']=="Other"){
				$row[]=ucwords($row1['service_work_code']."-".$row1['service_other_work_code']);
			}
			else{
				$row[]=ucwords($row1['service_work_code']);
			}
			$row[]=$row1['service_start_time'];
			$row[]=isEmpty($row1['service_end_time'],"-"); 
		    $row[]=isEmpty($row1['service_total_hours'],"-");
		    $row[]=$row1['service_ration'];
			$row[]=round($row1['total_miles_used'],2);
			$userType=printUserType($creatorData);
  			$row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
			$row[]=formatDateTimeNew($row1['sheet_added_date']); 
			
			if(!empty($modifierData)){
				$userType=printUserType($modifierData);
				$row[]=ucwords($modifierData['agency_first_name']." ".$modifierData['agency_last_name'])."&nbsp;".$userType;
				$row[]=formatDateTime($row1['sheet_modified_on']);
			}
			else{
				$row[]="-";
				$row[]="-";
			}
			$type='"TimingSheet"';
			$cStatus="";$editLink="NA";
			if($row1['is_sheet_completed']=='0'){
				$cStatus="<br/><span style='margin-top:5px;' class='badge badge-danger'>Not Completed</span>";
				//if(($permissions=="Edit" || $permissions=="Both") && !isFormAssigned($formid,$indid)){
					//$editLink="<a style='margin-top:5px;' href='javascript:void(1);' onclick='showDiffrentForms(".$indid.",".$formid.",".$row1[$sIndexColumn].",".$type.");' class='btn btn-xs btn-default'>Edit</a>";
					if($this->view->user->agency_user_type=="Agency" || $row1['service_added_user']==$this->view->user->agency_id){
					  $editLink="<a href='".APPLICATION_URL."/clock-out-group/".$row1['sheet_id']."' style='margin-top:5px;' class='btn btn-xs btn-default'>Edit</a>";
				    }
				//}
		    }else{
				$cStatus="<br/><span style='margin-top:5px;' class='badges badge badge-success'>Completed</span>";
					if($this->view->user->agency_user_type=="Agency" || $row1['service_added_user']==$this->view->user->agency_id){
					  $editLink="<a href='".APPLICATION_URL."/clock-out-group/".$row1['sheet_id']."' style='margin-top:5px;' class='btn btn-xs btn-default'>Edit</a>";
				    }
			}
			
			$row[]=$editLink.$cStatus;
 			$output['aaData'][] = $row;
			$j++;
		}
		echo json_encode($output);
		exit();
	}
	
	public function removegrouptimingsheetsAction(){
		global $healthSession;		
 		$this->_helper->layout->disableLayout();
		$this->_helper->viewRenderer->setNoRender(true);
		$formData = $this->getRequest()->getPost();
		if(isset($formData['records']) && count($formData['records'])) {
			foreach($formData['records'] as $key=>$values){
  				$isDel=$this->SuperModel->Super_Delete('_uhs_timing_sheets',"sheet_id=".$values);
 				$healthSession->successMsg=" Group Time Sheet(s) has been deleted successfully.";
			}
		}
		else{
			$healthSession->errorMsg = "Invalid Request.";
		}
		$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_group_timing_sheets");
	}
	public function grouptimingsheetreportAction(){
		global $healthSession;	
		$formData = $this->getRequest()->getPost();
		$pdfTitle="";
        if(!empty($formData)){
			$extra=array("month"=>$formData['months'],"year"=>$formData['years']);
            if(!empty($formData['records'])){
				$ids=implode(",",$formData['records']);
			}
			else{
				$ids="All";
			}
		    $html .= $this->_group_timing_sheet($ids,$extra);
            $pdfTitle = $this->view->site_configs['site_name'] . " |Group TimeSheet";
           
			if(!empty($html)){
				require_once ROOT_PATH.'/private/mpdf/mpdf.php';
				$mpdf=new mPDF('utf-8', 'A4-L');
				$stylesheet = file_get_contents(APPLICATION_URL.'/public/plugins/bootstrap/css/bootstrap.css');
				$mpdf->SetTitle($pdfTitle);
				$mpdf->WriteHTML($stylesheet,1);
				$mpdf->WriteHTML($html,2);
				$mpdf->Output();
				exit();
		    }else{
				$healthSession->errorMsg="No logs found.";
				$this->_helper->getHelper("Redirector")->gotoRoute(array(),'front_group_timing_sheets');
			}
		 }else{
			   $this->_helper->getHelper("Redirector")->gotoRoute(array(),'front_group_timing_sheets');
		  }
	}
	
	private function _group_timing_sheet($ids,$extra=array()){
		global $months;
		$userCond="";
		if($this->view->user->agency_user_type!="Agency"){ $userCond="service_added_user='".$this->view->user->agency_id."' and ";}
		if($ids!=="All"){
			$data=$this->SuperModel->Super_Get("_uhs_timing_sheets","sheet_id In(".$ids.")","fetchAll");
		}		
		$html="";
		if(count($data)>0){
			$html .= '<table style= "width:100%">
					<tr>
						<td> 
							<div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
								<h4 class="magin0">Company Information</h4><br>
								<p><b>Company:</b>'. ucwords($this->view->user->agency_company_name).'</p>
								
								<p><b>Provider No:</b>'. $this->view->user->agency_provider_number.'</p>
								
								<p><b>Name:</b>'. ucwords($this->view->user->agency_first_name. '  ' . $this->view->user->agency_last_name).'</p>
								
								<p><b>Address:</b>'. ucwords($this->view->user->agency_address1 .', '. $this->view->user->agency_city.', '. $this->view->user->agency_state.', '. $this->view->user->agency_zip).'</p>
								
								<p><b>ContactContact:</b>'. $this->view->user->agency_contact.'</p>
							</div>
						</td>
					</tr>
				</table>	
			    <br/>';
			$html.="<div class='text-right'>Date:".date("m/d/Y H:i:s",time())."</div><div class='alert alert-info text-center'><h3>Group TimeSheet</h3></div>";
			$html.="<table class='table table-bordered' cellspacing='10' cellpadding='20' width='100%'>
					<tr>
						<th style='padding:0.3%;' width='12.5%'>Date Of Service</th>
						<th style='padding:0.3%;' width='12.5%'>Individual(s)</th>
						<th style='padding:0.3%;' width='12.5%'>Work Code</th>
						<th style='padding:0.3%;' width='12.5%'>Start Time</th>
						<th style='padding:0.3%;' width='12.5%'>End Time</th>
						<th style='padding:0.3%;' width='12.5%'>Total Hours</th>
						<th style='padding:0.3%;' width='12.5%'>Ration</th>
						<th style='padding:0.3%;' width='12.5%'>Miles Used</th>
						<th style='padding:0.3%;' width='12.5%'>Created By</th>
						<th style='padding:0.3%;' width='12.5%'>Created On</th>
				   </tr>";
			foreach($data as $data){
				$explode = explode(",",$data['service_individual_id']);
				$name = "";
				for($i = 0; $i < count($explode); $i++){
					$agencyData = $this->SuperModel->Super_Get("_uhs_agency","agency_id='".$explode[$i]."'","fetch");
					$name.=ucwords($agencyData['agency_first_name']." ".$agencyData['agency_last_name']).", ";
				}
                $individuals_name=rtrim($name,' ,');
				$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$data['service_added_user']);
				$html.="<tr>
							<td style='padding:0.3%;'>".formatDate($data['service_date'])."</td>
							<td style='padding:0.3%;'>".$individuals_name."</td>
							<td style='padding:0.3%;'>".ucwords($data['service_work_code'])."</td>
							<td style='padding:0.3%;'>".$data['service_start_time']."</td>
							<td style='padding:0.3%;'>".$data['service_end_time']."</td>
							<td style='padding:0.3%;'>".$data['service_total_hours']."</td>
							<td style='padding:0.3%;'>".$data['service_ration']."</td>
							<td style='padding:0.3%;'>".$data['total_miles_used']."</td>
							<td style='padding:0.3%;'>".ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."</td>
							<td style='padding:0.3%;'>".formatDateTimeNew($data['sheet_added_date'])."</td>
				  	  </tr>";	
			}
			$html.="</table>";
			if($ids=="All"){
				$html.="<pagebreak />";
			}
		}else{
			$html.= "";
		}
		return $html;
	}
    
       public function gettaskchartformAction(){
		global $healthSession;
		$indid=$this->_getParam('indid');
		$formid=$this->_getParam('formid');
		$supportid=$this->_getParam('supportid');
		$editid=$this->_getParam('editid');
		$type=$this->_getParam('type');
		$page=$this->_getParam('page');
		$form=new Application_Form_CustomForms();
		$form->taskchart($indid,$formid,$supportid,$editid,$type,$page);
                $shift_option="";
		if(!empty($editid)){
			$taskData=$this->SuperModel->Super_Get("_uhs_supports_charting","usc_id=".$editid,"fetch");
                        $shift_option=$taskData['shift_option'];
                        
                        $form->populate($taskData);
			//~ if($formid==2){
				//~ $form->task_total_service_time->setValue($taskData['task_total_service_time']);
			//~ }
		}
		$helper='<div id="flash-message" class="alert alert-danger flash-message-alert-container" style="display:none;"></div>';
		echo "Task Of The Day"."~~".$helper."~~".$form."~~".$shift_option;
		exit();
	}
        public function savetaskchartformAction() {
            
            global $healthSession,$systemusers;
            $indid=$this->_getParam('indid');
            $formid=$this->_getParam('formid');
            $supportid=$this->_getParam('supportid');
            $editid=$this->_getParam('editid');
            $type=$this->_getParam('type');
            $page=$this->_getParam('page');
            $permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
            if($permissions=="View Only"){
                    $healthSession->errorMsg="You don't have permission to access this page.";
                    if($type=="Care"){
                            $this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_personal_care");
                    }
            }
            $form=new Application_Form_CustomForms();
            $form->taskchart($indid,$formid,$supportid,$editid,$type,$page);

            if($this->getRequest()->isPost()){
                $posted_data = $this->getRequest()->getPost();
                if($form->isValid($posted_data)){
                    if(!empty($editid)){
                        $usc_id = $editid;

                        $updated_data['shift_option'] = $posted_data['shift_option'];
                        
                        if($posted_data['shift_option'] == "NC" || $posted_data['shift_option'] == "NA" || $posted_data['shift_option'] == "R" || $posted_data['shift_option'] == "-"){
                            $updated_data['start_time'] = "";
                            $updated_data['end_time'] = "";
                            $updated_data['total_units'] =0;
                            $updated_data['staff_ration'] = 0;
                            $updated_data['individual_ration'] = 0;
                        }else{
                            $updated_data['start_time'] = $posted_data['start_time'];
                            $updated_data['end_time'] = $posted_data['end_time'];
                            $updated_data['total_units'] = $posted_data['total_units'];
                            $updated_data['staff_ration'] = $posted_data['staff_ration'];
                            $updated_data['individual_ration'] = $posted_data['individual_ration'];
                        }
                        $updated_data['comment'] = $posted_data['comment'];
                        $updated_data['modified_by']=$this->view->user->subuser_id;
                        $updated_data['modified_on']=date('Y-m-d H:i:s');
                        $updated_data['shift']=$posted_data['shift'];
//                        if(!empty($posted_data['support_shift'])){
//                            $arr=array();
//                            foreach($posted_data['support_shift'] as $key=>$val){
//                                $arr[$val]=$val;
//                            }
//                            $posted_d = array();
//                            $posted_dt = array();
//                            $posted_dt['support_shift'][0] = "";
//                            if(in_array(1, $arr)){
//                                $posted_dt['support_shift'][1] = 1;
//                            }else{
//                               $posted_dt['support_shift'][1] = "";
//                            }
//                            if(in_array(2, $arr)){
//                                $posted_dt['support_shift'][2] = 2;
//                            }else{
//                               $posted_dt['support_shift'][2] = "";
//                            }
//                            if(in_array(3, $arr)){
//                                $posted_dt['support_shift'][3] = 3;
//                            }else{
//                               $posted_dt['support_shift'][3] = "";
//                            }
//
//
//                            $posted_d['support_shift'] = json_encode($posted_dt['support_shift']);
//                            $this->SuperModel->Super_Insert("_uhs_supports", $posted_d, "support_id=" . $supportid);
//                        }else{
//                             $posted_d = array();
//                             $posted_dt = array();
//                             $posted_dt['support_shift'][0] = "";
//                             $posted_dt['support_shift'][1] = "";
//                             $posted_dt['support_shift'][2] = "";
//                             $posted_dt['support_shift'][3] = "";
//                             $posted_d['support_shift'] = json_encode($posted_dt['support_shift']);
//                             $this->SuperModel->Super_Insert("_uhs_supports", $posted_d, "support_id=" . $supportid);
//                        }
                                        
                        $isInserted = $this->SuperModel->Super_Insert("_uhs_supports_charting", $updated_data, "usc_id = $usc_id");
                        if ($isInserted->success) {
                            $healthSession->successMsg = "Supports has been updated successfully.";
                        } else {
                            $healthSession->errorMsg = $isInserted->message;
                        }
                        $this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_add_personal_care");
                    }   
                }
            }
        }
        
        
        
        public function removetasksndchartAction(){
		global $healthSession;
		if($this->view->user->agency_user_type!="Agency"){
			$healthSession->errorMsg="You don't have permission to access this page.";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
		}
                $flag1=0;
                $flag2=0;
		$indid=$this->_getParam('indid');
		$formid=$this->_getParam('formid');
		$type=$this->_getParam('type');
		$id=$this->_getParam('id');
                
 		$this->_helper->layout->disableLayout();
		$this->_helper->viewRenderer->setNoRender(true);
		$formData = $this->getRequest()->getPost();
                if(isset($formData['_uhs_task_entries']) && count($formData['_uhs_task_entries'])) { 
			foreach($formData['_uhs_task_entries'] as $key=>$values){
  				$isAdd=$this->SuperModel->Super_Delete('_uhs_task_entries',"task_id=".$values);
 				$healthSession->successMsg="Task(s) has been deleted successfully.";
			}
                        $flag1=1;
		}
                if(isset($formData['_uhs_supports_charting']) && count($formData['_uhs_supports_charting'])) { 
			foreach($formData['_uhs_supports_charting'] as $key=>$values){
  				$isAdd=$this->SuperModel->Super_Delete('_uhs_supports_charting',"usc_id=".$values);
 				$healthSession->successMsg="Task(s) has been deleted successfully.";
			}
                        $flag2=1;
		}
                
                if(!($flag1 == 1 || $flag2 == 1)){
			$healthSession->errorMsg = "Invalid Request.";
		}
 		if($type=="Care"){
                    if($id ==1){
                        $this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_personal_care");
                    } else if($id==2){
                        $this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_personal_care_notes");
                    }
		}
 		if($type=="Ads"){
                    if($id ==1){
                        $this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_personal_care");
                    } else if($id==2){
                        $this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_personal_care_notes");
                    }
		}
		
	}
        
        

        function _charting_task_join_log($indData,$idte,$idsc,$idall,$formid,$type,$extra=array()){
			
                       global $months;
			$userCond="";
			$taskData=NULL;
		   
			$data=NULL;
			
			if($this->view->user->agency_user_type!="Agency"){ $userCond="task_added_user='".$this->view->user->agency_id."' and ";$userCondChart="added_by='".$this->view->user->agency_id."' and ";}
			if($idall!=="All"){
				if(!empty($idte)){
					$taskData=$this->SuperModel->Super_Get("_uhs_task_entries","task_id IN(".$idte.") and support_frequency IN(select support_frequency from _uhs_supports group by support_frequency) ","fetchAll",array("join"=>"_uhs_supports","joincondition"=>"support_id=task_support_id","joinfields"=>"*","order"=>"support_frequency ASC"));
				}
				if(!empty($idsc)){
					$chartDatas=$this->SuperModel->Super_Get("_uhs_supports_charting","usc_id IN(".$idsc.") and support_frequency IN(select support_frequency from _uhs_supports group by support_frequency) ","fetchAll",array("join"=>"_uhs_supports","joincondition"=>"_uhs_supports.support_id=_uhs_supports_charting.support_id","joinfields"=>"*","order"=>"support_frequency ASC"));
				}
			}
			else{
				$taskData=$this->SuperModel->Super_Get("_uhs_task_entries","".$userCond." task_individual_id=".$indData['agency_id']." and task_type='".$type."' and MONTH(task_added_date)=".$extra['month']." and YEAR(task_added_date)='".$extra['year']."' and support_frequency IN(select support_frequency from _uhs_supports group by support_frequency) ","fetchAll",array("join"=>"_uhs_supports","joincondition"=>"support_id=task_support_id","joinfields"=>"*","order"=>"support_frequency ASC"));
				
				$chartDatas=$this->SuperModel->Super_Get("_uhs_supports_charting","".$userCond." indid=".$indData['agency_id']." and formid='".$formid."' and MONTH(created_at)=".$extra['month']." and YEAR(created_at)='".$extra['year']."' and support_frequency IN(select support_frequency from _uhs_supports group by support_frequency) ","fetchAll",array("join"=>"_uhs_supports","joincondition"=>"_uhs_supports.support_id=_uhs_supports_charting.support_id","joinfields"=>"*","order"=>"support_frequency ASC"));
			}
			
			if(!empty($chartDatas)){
				foreach($chartDatas as $chartData){
					$temp['task_added_user']=$chartData['added_by'];
					$temp['task_added_date']=$chartData['created_at'];
					$temp['is_task_done']=$chartData['shift_option'];
					$temp['support_frequency']=$chartData['support_frequency'];
					$temp['support_description']=$chartData['support_description'];
					$temp['task_start_time']=$chartData['start_time'];
					$temp['task_end_time']=$chartData['end_time'];
					$temp['task_total_service_time']=$chartData['total_units'];
					$temp['task_comments']=$chartData['comment'];
					$temp['support_shift']=$chartData['support_shift'];
					$temp['task_staff_no']=$chartData['staff_ration'];
					$temp['task_individual_no']=$chartData['individual_ration'];
					$temp['shift']=$chartData['shift'];
					$data[]=$temp;
				}
			}
			if(!empty($taskData) && !empty($data)){
				$taskData= array_merge($taskData,$data);
				$support_frequency = array();
				foreach ($taskData as $key => $row)
				{
					$support_frequency[$key] = $row['support_frequency'];
				}
				array_multisort($support_frequency, SORT_DESC, $taskData);
			} elseif(!empty($data)){
				$taskData=$data;
			}
			
                        $sortarray = array();
                        foreach ($taskData as $key => $row)
                        {
                            $sortarray[$key] = $row['task_added_date'];
                        }
                        array_multisort($sortarray, SORT_DESC, $taskData);
                        
                        //prd($taskData);
			$number = date('t');
			$totalColspan=$number+1;
			$headingText=$html="";
			if($type=="Care"){$headingText="Documentation of Homemaker Personal Care";}
			if($type=="Ads"){$headingText="Documentation of Adult Day Support";}
			$tdWid=round(90/$number,2);
			$html="";
			if(count($taskData)>0){
				$html.= $this->_report_header($headingText,$indData);
                                if($formid == 27){
                                } else {
                                     $html.="<h5>Individual Information: ".ucwords($indData['agency_first_name']." ".$indData['agency_last_name']).",".$indData['agency_city'].",".$indData['agency_state'].",".$indData['agency_zip']."</h5>";
                                }
				
				$html.="</div>
                                <div class='col-lg-10 col-md-10 col-sm-10 col-xs-12 padding0'>
                                    <div class'col-lg-9 col-md-9 col-sm-9 col-xs-12 text-left padding0'>
                                        <span style='color:#13bca6'>'C'</span>=Completed &nbsp;
                                        <span style='color:#13bca6'>'NC'</span>=Not Completed &nbsp;
                                        <span style='color:#13bca6'>'A'</span>=Administered &nbsp;
                                        <span style='color:#13bca6'>'NA'</span>=Not Administered &nbsp;
                                        <span style='color:#13bca6'> 'R'</span>=Refuse &nbsp;
                                    </div>
                                </div>
                                <div class='clearfix'>&nbsp;</div>";
				
				$html.="<table width='140%'>";
				for($i=0;$i<count($taskData);$i++){
					$taskcreatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$taskData[$i]['task_added_user']."'","fetch");
					$taskcreatername = $taskcreatorData['agency_first_name']." ".$taskcreatorData['agency_last_name'];
					$shift_data = json_decode($taskData[$i]['support_shift']);
					$shift="";
					foreach($shift_data as $sh_data){
						if($sh_data){
							$shift.= $sh_data.',';
						}
					}
					
					$support_shift = rtrim($shift,',');
					$ration = $taskData[$i]['task_staff_no']." : ".$taskData[$i]['task_individual_no'];
					
					
					$html.="<tr><td style='font-size: 20px;'>".($i+1)." ".$taskData[$i]['support_description']."</td></tr>";
					$html.="<tr>
					            <td style='font-size: 20px;' width='40%'><b>Support Frequency: </b>".$taskData[$i]['support_frequency']."</td>
					            <td style='font-size: 20px;' width='15%'><b>Start Time: </b>".$taskData[$i]['task_start_time']."</td>
					            <td style='font-size: 20px;' width='15%'><b>End Time: </b>".$taskData[$i]['task_end_time']."</td>
					            <td style='font-size: 20px;' width='10%'><b>Unit: </b>".$taskData[$i]['task_total_service_time']."</td>
					            <td style='font-size: 20px;' width='20%'><b>Task Completion: </b>".$taskData[$i]['is_task_done']."</td>
					            <td style='font-size: 20px;' width='20%'><b>Recorded By: </b>".$taskcreatername."|".$taskcreatorData['agency_user_type']."</td>
					            <td style='font-size: 20px;' width='20%'><b>Recorded On: </b>".formatDateTime($taskData[$i]['task_added_date'])."</td>
					        </tr>";
					  $html.="<tr>
					            <td style='font-size: 20px;'><b>Comment: </b>".$taskData[$i]['task_comments']."</td>
					            <td style='font-size: 20px;'><b>Shift: </b>".$taskData[$i]['shift']."</td>
					            <td style='font-size: 20px;'><b>Ration: </b>".$ration."</td>
					            <td></td>
					        </tr>
                                                <tr><td width='140%' style='height:30px;border-bottom:1px solid black;' colspan='8'></td></tr>
                                                <tr><td width='140%' style='height:30px;' colspan='8'></td></tr>";
				}                               
				$html.="</table>";
                if($idall=="All"){
					$html.="<pagebreak />";
				}
			}else{
			$html.= "";
		}
		return $html;
	}
       
	
	
	
	
	
//  weekly report functionality code : START
//  $start and $end must be unix timestamps (any range)
//  returns an array of arrays with 'start' and 'end' elements set 
//  for each week (or part of week) for the given interval
//  return values are also in timestamps

    function generateweeks($start, $end) {
        $ret = array();
        $start = $this->E2D($start);
        $end = $this->E2D($end);

        $ns = $this->nextSunday($start);

        while (true) {
            if ($ns >= $end) {
                $this->insert($ret, $start, $end);
                return $ret;
            }
            $this->insert($ret, $start, $ns);
            $start = $ns + 1;
            $ns += 7;
        }
    }

    function generateReport($weeks) {
        foreach ($weeks as $key => $week) {
            //echo fDate($week['start']).' '.fDate($week['end']).'<br><br>';
            $detailArr[$key]['start'] = $this->fDateMy($week['start']);
            $detailArr[$key]['end'] = $this->fDateMy($week['end']);
        }
        return $detailArr;
    }

    function checkIfFirstDayMonday($weeks, $start) {
        $firstDay = date("D", $start);

        if ($firstDay == "Mon" || $firstDay == "Sun") {
            $weeksReport = $this->generateReport($weeks);
            $firstSaturday = date("Y-m-d", strtotime("first saturday", $start));

            $weeksReport[0]['end']['date'] = $firstSaturday;
            unset($weeksReport[1]);
            $weeksReport = array_values($weeksReport);
        } else {
            $weeksReport = $this->generateReport($weeks);
        }

        return $weeksReport;
    }

// helper function to append the array and convert back to unix timestamp
    function insert(&$arr, $start, $end) {
        $arr[] = array('start' => $this->D2E($start), 'end' => $this->D2E($end));
    }

// recives any date on CD format returns next Sunday on CD format
    function nextSunday($Cdate) {
        return $Cdate + 5 - $Cdate % 7;
    }

// recives any date on CD format returns previous Monday on CD format // finaly not used here
    function prevMonday($Cdate) {
        return $Cdate - $Cdate % 7;
    }

// recives timestamp returns CD
    function E2D($what) {
        return floor($what / 86400) + 2;
    }

// floor may be optional in some circunstances
// recives CD returns timestamp

    function D2E($what) {
        return ($what - 2) * 86400;
    }

// 24*60*60
// just format the timestamp for output, you can adapt it to your needs

    function fDate($what) {
        return date('D Y-m-d', $what);
    }

    function fDateMy($what) {
        $detail['day'] = date('D', $what);
        $detail['date'] = date('Y-m-d', $what);
        return $detail;
    }
    // weekly report functionality code : END

	function array_column(array $input, $columnKey, $indexKey = null) {
        $array = array();
        foreach ($input as $value) {
            if ( !array_key_exists($columnKey, $value)) {
                trigger_error("Key \"$columnKey\" does not exist in array");
                return false;
            }
            if (is_null($indexKey)) {
                $array[] = $value[$columnKey];
            }
            else {
                if ( !array_key_exists($indexKey, $value)) {
                    trigger_error("Key \"$indexKey\" does not exist in array");
                    return false;
                }
                if ( ! is_scalar($value[$indexKey])) {
                    trigger_error("Key \"$indexKey\" does not contain scalar value");
                    return false;
                }
                $array[$value[$indexKey]] = $value[$columnKey];
            }
        }
        return $array;
    }

	public function incidenttrendreportAction() {
        global $healthSession;
        $agency_id = $_SESSION['UHS_AUTH']['storage']->agency_id;

        $this->dbObj = Zend_Registry::get('db');
        $sQuery = "SELECT * FROM _uhs_agency WHERE agency_user_agency_id = $agency_id and agency_user_type = 'Individual' ORDER BY agency_first_name ASC";
        $trendsData = $this->dbObj->query($sQuery)->fetchAll();

      
        foreach ($trendsData as $key => $rawData) {
            $indRawData[$key]['id'] = $rawData['agency_id'];
            $indRawData[$key]['name'] = $rawData['agency_first_name'] . " " . $rawData['agency_last_name'];
        }     
        $indFilter = $this->array_column($indRawData, 'name', 'id');
        $first_day_this_month = date('m/01/Y'); // hard-coded '01' for first day
        $last_day_this_month  = date('m/t/Y');
        if($this->getRequest()->isPost()){
		  $fdate = date("Y-m-d", strtotime($_POST['fdate']));
          $todate = date("Y-m-d", strtotime($_POST['todate']));
		}else{
          $fdate = date('Y-m-01'); // hard-coded '01' for first day
          $todate  = date('Y-m-t');
	    }
        $currentMonth = formatDate($first_day_this_month)." To ".formatDate($last_day_this_month);

        $this->view->pageHeading = "Incident Trend Report";
        $this->view->indFilter = $indFilter;
        $this->view->currentMonth = $currentMonth;
      
         
        $trenddata = $this->_trendheader($fdate,$todate);
		$this->view->sum = $trenddata['sum']." Incidents during Trend Period";
		$this->view->incidenttypedata = $trenddata['incidentdata'];
    }
    
    public function getincidenttrendreportAction() {
        $this->dbObj = Zend_Registry::get('db');
        $aColumns = array('agency_id', 'agency_first_name', 'agency_last_name', 'agency_address1', 'agency_address2', 'agency_city', 'agency_zip', 'agency_contact', 'agency_email', 'agency_company_name', 'agency_code', 'agency_status', 'agency_user_agency_id', 'agency_draft_status', 'agency_created_by', 'agency_modified_on', 'agency_modified_by', 'agency_is_manager');
        $sIndexColumn = 'agency_id';
        $sTable = '_uhs_agency';
        $sLimit = "";
        if (isset($_GET['iDisplayStart']) && $_GET['iDisplayLength'] != '-1') {
            $sLimit = "LIMIT " . intval($_GET['iDisplayStart']) . ", " . intval($_GET['iDisplayLength']);
        }
        $sOrder = "";
        if (isset($_GET['iSortCol_0'])) {
            $sOrder = "ORDER BY  ";
            for ($i = 0; $i < intval($_GET['iSortingCols']); $i++) {
                if ($_GET['bSortable_' . intval($_GET['iSortCol_' . $i])] == "true") {
                    $sOrder .= "" . $aColumns[intval($_GET['iSortCol_' . $i])] . " " .
                            ($_GET['sSortDir_' . $i] === 'asc' ? 'asc' : 'desc') . ", ";
                }
            }
            $sOrder = substr_replace($sOrder, "", -2);
            if ($sOrder == "ORDER BY") {
                $sOrder = "";
            }
        }
        $sWhere = "";
        if (isset($_GET['sSearch']) and $_GET['sSearch'] != "") {
            $sWhere = "WHERE (";
            for ($i = 0; $i < count($aColumns); $i++) {
                $sWhere .= "" . $aColumns[$i] . " LIKE '%" . $_GET["sSearch"] . "%' OR "; // NEW CODE
            }
            $sWhere = substr_replace($sWhere, "", -3);
            $sWhere .= ')';
        }
        for ($i = 0; $i < count($aColumns); $i++) {
            if (isset($_GET['bSearchable_' . $i]) and $_GET['bSearchable_' . $i] == "true" and $_GET['sSearch_' . $i] != '') {
                if ($sWhere == "") {
                    $sWhere = "WHERE ";
                } else {
                    $sWhere .= " AND ";
                }
                $sWhere .= "" . $aColumns[$i] . " LIKE '%" . $_GET['sSearch_' . $i] . "%' ";
            }
        }
       $indParentUsers="";
			if($this->view->user->agency_user_type=="Agency"){
				$systemUsers=$this->SuperModel->Get_AllIndividuals($this->view->user->agency_id);
			    foreach($systemUsers as $sysusers){
					$system .= $sysusers['agency_id'].',';
				}
				$indParentUsers=rtrim($system,',');
				
			}
			else{
				$indParentUsers=$this->view->user->agency_id;
			}
			if($sWhere){
				$sWhere.=" and agency_id IN(".$indParentUsers.")"; 
			}else{
				$sWhere.=" where agency_id IN(".$indParentUsers.")"; 
			}    
        date_default_timezone_set('America/New_York');
        $first_day_this_month = date('Y-m-01'); // hard-coded '01' for first day
        $last_day_this_month  = date('Y-m-t');

        $sQuery = " SELECT SQL_CALC_FOUND_ROWS " . str_replace(" , ", " ", implode(", ", $aColumns)) . " FROM  $sTable $sWhere $sOrder $sLimit";
        $qry = $this->dbObj->query($sQuery)->fetchAll();
        $sQuery = "SELECT FOUND_ROWS() as fcnt";
        $aResultFilterTotal = $this->dbObj->query($sQuery)->fetchAll();
        $iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
        $sQuery = "SELECT COUNT(`" . $sIndexColumn . "`) as cnt FROM $sTable ";
        $rResultTotal = $this->dbObj->query($sQuery)->fetchAll();
        $iTotal = $rResultTotal[0]['cnt'];
        $output = array(
            "iTotalRecords" => $iTotal,
            "iTotalDisplayRecords" => $iFilteredTotal,
            "aaData" => array()
        );
        $j = 0;
        
        $agency_id = $_SESSION['UHS_AUTH']['storage']->agency_id;
        $where = '';
        $where .= "WHERE incident_individual_id IN(".$indParentUsers.")";
        $where .= "AND incident_date BETWEEN '" . $first_day_this_month . "' AND '" . $last_day_this_month . "'";
        $this->dbObj = Zend_Registry::get('db');
        $testQuery = "SELECT incident_individual_id FROM _uhs_incidents_reports $where";
        $staffData = $this->dbObj->query($testQuery)->fetchAll();
        $staffData = $this->array_column($staffData, 'incident_individual_id');
        $staffData = array_unique($staffData);
        $staffData = array_values($staffData);
        foreach ($staffData as $key => $raw_data) {
            $this->dbObj = Zend_Registry::get('db');
            $testQuery = "SELECT agency_id,agency_first_name,agency_last_name,agency_address1,agency_address2,agency_city,agency_zip,agency_contact,agency_email,agency_company_name,agency_code,agency_status,agency_user_agency_id,agency_draft_status,agency_created_by,agency_modified_on,agency_modified_by,agency_is_manager FROM _uhs_agency WHERE agency_id = $raw_data";
            $staffDataFull[$key] = $this->dbObj->query($testQuery)->fetch();
        }
        foreach ($staffDataFull as $row1) {
            $parentData = $this->SuperModel->Super_Get("_uhs_agency", "agency_id=" . $row1['agency_created_by']);
            $modifierData = array();
            if ($row1['agency_modified_by'] != 0) {
                $modifierData = $this->SuperModel->Super_Get("_uhs_agency", "agency_id=" . $row1['agency_modified_by']);
            }
            $row = array();
            $row[] = $j + 1;
            $row[] = '<input class="elem_ids checkboxes"  type="checkbox" name="' . $sTable . '[' . $row1[$sIndexColumn] . ']"  value="' . $row1[$sIndexColumn] . '" indiv_id="' . $row1[$agency_id] . '">';
            // first name
            $row[] = ucwords($row1['agency_first_name']);
            // last name
            $row[] = ucwords($row1['agency_last_name']);

            $staff_id = $row1['agency_id'];

            $where1 = '';
            $where1 .= "WHERE incident_individual_id=$staff_id";
            $where1 .= " AND (incident_date BETWEEN '" . $first_day_this_month . "' AND '" . $last_day_this_month . "')";
            $sQuery = "SELECT * FROM _uhs_incidents_reports $where1";
            $incidentData = $this->dbObj->query($sQuery)->fetchAll();
            $trends=array();
		    $uimui=array();
			$a=$as=$ia=$me=$e=$d=$s=$all=$an=$mp=$l=$ita=$mt=$me=$rl=$rc=$ns=$rf=$ot=0;
			$ui=$mui=0;
			$insArr=array();
			foreach($incidentData as $incident){
			  if(!empty($incident['is_included_claims'])){
				  $incidentClaims=unserialize($incident['is_included_claims']);
				  if(in_array("MUI",$incidentClaims)){
					  $uimui[]=array("name"=>"MUI","y"=>$mui+1);
				  }
				  if(in_array("UI",$incidentClaims)){
					  $uimui[]=array("name"=>"UI","y"=>$ui+1);
				  }
			  }
			  if(!empty($incident['incident_types'])){
					$incidentTypes=unserialize($incident['incident_types']);
					if(in_array("Abuse",$incidentTypes)){
						$trends[]=array("name"=>"Abuse","y"=>$a+1);
					}
					if(in_array("Attempted Suicide",$incidentTypes)){
						$trends[]=array("name"=>"Attempted Suicide","y"=>$as+1);
					}
					if(in_array("Individual Aggression toward Staff",$incidentTypes)){
						$trends[]=array("name"=>"Individual Aggression toward Staff","y"=>$ia+1);
					}
					if(in_array("Medical Emergency",$incidentTypes)){ 
						$trends[]=array("name"=>"Medical Emergency","y"=>$me+1);
					}
					if(in_array("Exploitation",$incidentTypes)){
						$trends[]=array("name"=>"Exploitation","y"=>$e+1);
					}
					if(in_array("Seizure",$incidentTypes)){
						$trends[]=array("name"=>"Seizure","y"=>$s+1);
					}
					if(in_array("Death",$incidentTypes)){
						$trends[]=array("name"=>"Death","y"=>$d+1);
					}
					if(in_array("Alleged Abuse",$incidentTypes)){
						$trends[]=array("name"=>"Alleged Abuse","y"=>$all+1);
					}
					if(in_array("Alleged Neglect",$incidentTypes)){
						$trends[]=array("name"=>"Alleged Neglect","y"=>$an+1);
					}
					if(in_array("Missing Person",$incidentTypes)){
						$trends[]=array("name"=>"Missing Person","y"=>$mp+1);
					}
					if(in_array("Law Enforcement Involvement",$incidentTypes)){
						$trends[]=array("name"=>"Law Enforcement Involvement","y"=>$l+1);
					}
					if(in_array("Individual to Individual Aggression",$incidentTypes)){
						$trends[]=array("name"=>"Individual to Individual Aggression","y"=>$ita+1);
					}
					if(in_array("Misappropriation (Theft / Fraud)",$incidentTypes)){
						$trends[]=array("name"=>"Misappropriation (Theft / Fraud)","y"=>$mt+1);
					}
					if(in_array("Medication Error",$incidentTypes)){
						$trends[]=array("name"=>"Medication Error","y"=>$me+1);
					}
					if(in_array("Relocation",$incidentTypes)){
						$trends[]=array("name"=>"Relocation","y"=>$rl+1);
					}
					if(in_array("Right Code Violation",$incidentTypes)){
						$trends[]=array("name"=>"Right Code Violation","y"=>$rc+1);
					}
					if(in_array("No Shows (Transportation Only)",$incidentTypes)){
						$trends[]=array("name"=>"No Shows (Transportation Only)","y"=>$ns+1);
					}
					if(in_array("Refusal",$incidentTypes)){
						$trends[]=array("name"=>"Refusal","y"=>$rf+1);
					}
					if(in_array("Other",$incidentTypes)){
						$trends[]=array("name"=>"Other","y"=>$ot+1);
					}
			  }   
			}
			$results=array();
			foreach($trends as $value){
			  if(!isset($results[$value['name']])){
				 $results[$value['name']]=0;
			  }
			  $results[$value['name']]+=$value['y'];
			}
			$resArr=array();
			foreach($results as $key=>$res){
				$resArr[]=array("name"=>$key,"y"=>$res);
			}
			
			$results1=array();
			foreach($uimui as $value){
			  if(!isset($results1[$value['name']])){
				 $results1[$value['name']]=0;
			  }
			  $results1[$value['name']]+=$value['y'];
			}
			$resArr1=array();
			foreach($results1 as $key=>$res){
				$resArr1[]=array("name"=>$key,"y"=>$res);
			}
			
	  if(count($incidentData)>0){
		  $row[] = count($incidentData);
		  $row[] = isset($resArr1[0]['y']) ? $resArr1[0]['y'] : 0;
		  $row[] = isset($resArr1[1]['y']) ? $resArr1[1]['y'] : 0;
	   }else{
		  $row[] = 0;
		  $row[] = 0;
		  $row[] = 0;
	   }         
            
            $this->dbObj = Zend_Registry::get('db');
            
            $where2 = '';
            $where2 .= "WHERE incident_individual_id=$staff_id";
            $where2 .= " AND (incident_date BETWEEN '" . $first_day_this_month . "' AND '" . $last_day_this_month . "')";
            $testQuery = "SELECT * FROM _uhs_incidents_reports $where2";
            $incident_data = $this->dbObj->query($testQuery)->fetchAll();
            //prd($incident_data);
            // incident data  table
            $table = '';
            $table .= "<table style='margin: 0px auto;'><tr role='row'>";
                foreach($resArr as $incidenttypedata){
			     //~ $color = '';
				 //~ if($incidenttypedata['name']=="Abuse"){$color='background-color:Salmon;';}if($incidenttypedata['name']=="Attempted Suicide"){$color='background-color:Pink;';}if($incidenttypedata['name']=="Exploitation"){$color='background-color:DarkOrange;';}if($incidenttypedata['name']=="Medical Emergency"){$color='background-color:MediumOrchid;';}if($incidenttypedata['name']=="Individual Aggression toward Staff"){$color='background-color:YellowGreen;';}
				 //~ if($incidenttypedata['name']=="Seizure"){$color='background-color:Green;';}if($incidenttypedata['name']=="Death"){$color='background-color:RosyBrown;';}if($incidenttypedata['name']=="Right Code Violation"){$color='background-color:Gold;';}if($incidenttypedata['name']=="Relocation"){$color='background-color:BlueViolet;';}if($incidenttypedata['name']=="Other"){$color='background-color:LightSlateGray;';}
				 //~ if($incidenttypedata['name']=="Alleged Abuse"){$color='background-color:Aqua;';}if($incidenttypedata['name']=="Alleged Neglect"){$color='background-color:DeepPink;';}if($incidenttypedata['name']=="Medication Error"){$color='background-color:Plum;';}if($incidenttypedata['name']=="Refusal"){$color='background-color:MediumSlateBlue;';}if($incidenttypedata['name']=="Behavioral Incident"){$color='background-color:MediumSpringGreen;';}
				 //~ if($incidenttypedata['name']=="Missing Person"){$color='background-color:Teal;';}if($incidenttypedata['name']=="Law Enforcement Involvement"){$color='background-color:Crimson;';}if($incidenttypedata['name']=="Individual to Individual Aggression"){$color='background-color:Fuchsia;';}if($incidenttypedata['name']=="Misappropriation (Theft / Fraud)"){$color='background-color:GreenYellow;';}if($incidenttypedata['name']=="No Shows (Transportation Only)"){$color='background-color:Chocolate;';}
				     $color = '';
					 if($incidenttypedata['name']=="Abuse"){$color='Salmon';}if($incidenttypedata['name']=="Attempted Suicide"){$color='1b2077';}if($incidenttypedata['name']=="Exploitation"){$color='DarkOrange';}if($incidenttypedata['name']=="Medical Emergency"){$color='MediumOrchid';}if($incidenttypedata['name']=="Individual Aggression toward Staff"){$color='YellowGreen';}
					 if($incidenttypedata['name']=="Seizure"){$color='Green';}if($incidenttypedata['name']=="Death"){$color='RosyBrown';}if($incidenttypedata['name']=="Right Code Violation"){$color='e71ea4';}if($incidenttypedata['name']=="Relocation"){$color='BlueViolet';}if($incidenttypedata['name']=="Other"){$color='LightSlateGray';}
					 if($incidenttypedata['name']=="Alleged Abuse"){$color='Aqua';}if($incidenttypedata['name']=="Alleged Neglect"){$color='DeepPink';}if($incidenttypedata['name']=="Medication Error"){$color='Plum';}if($incidenttypedata['name']=="Refusal"){$color='MediumSlateBlue';}if($incidenttypedata['name']=="Behavioral Incident"){$color='MediumSpringGreen';}
					 if($incidenttypedata['name']=="Missing Person"){$color='Teal';}if($incidenttypedata['name']=="Law Enforcement Involvement"){$color='Crimson';}if($incidenttypedata['name']=="Individual to Individual Aggression"){$color=' #6e2c00 ';}if($incidenttypedata['name']=="Misappropriation (Theft / Fraud)"){$color='3eab0b';}if($incidenttypedata['name']=="No Shows (Transportation Only)"){$color='Chocolate';}
					 $table .= "<th style='padding-left: 15px !important;'><font color='$color'>$incidenttypedata[y] $incidenttypedata[name] </font></th>";
				}
                $table.="</tr></table>";

            $table .= "<table id='sample_1' class='table table-striped table-bordered table-hover dataTable no-footer dtr-inline collapsed' role='grid'>
            <thead>
                <tr role='row'>
                    <th tabindex='0' aria-controls='sample_1' rowspan='1' colspan='1'>Tracking #</th>
                    <th tabindex='0' aria-controls='sample_1' rowspan='1' colspan='1'>Incident Date</th>
                    <th tabindex='0' aria-controls='sample_1' rowspan='1' colspan='1'>Incident Location</th>
                    <th tabindex='0' aria-controls='sample_1' rowspan='1' colspan='1'>Incident Type</th>
                </tr>
            </thead>
            <tbody>";

            if (count($incident_data) > 0) {
                foreach ($incident_data as $raw_data) {
					$incident_types = unserialize($raw_data['incident_types']);
					$inci = '';
					foreach($incident_types as $inci_data){
						$inci .= $inci_data.", ";
					}
					$inci_rec = rtrim($inci,", ");
                    $incident_tracking_number = $raw_data['incident_tracking_number'];
                    $incident_date = $raw_data['incident_date'];
                    $incident_location = $raw_data['incident_location'];
                    $incident_types = $inci_rec;
                    
                    $table .= "<tr role='row' class='odd'>
                        <td style='padding-left: 8px !important;'>$incident_tracking_number</td>
                        <td>$incident_date</td>
                        <td>$incident_location</td>
                        <td>$incident_types</td>
                    </tr>";
                }
            } else {
                $table .= "<tr role='row' class='odd'>
                            <td colspan='8' style='text-align: center;'>No Data</td>
                    </tr>";
            }

            $table .= "</tbody></table>";
            $row[] = $table;
            $status = $row1['agency_status'] == 1 ? "checked='checked'" : " ";
            $inviteLink = "";
            if ($row1['agency_draft_status'] == 0) {
                $inviteLink = '&nbsp;<a class="btn btn-xs btn-default" href="' . APPLICATION_URL . '/agencydashboard/reinvite/agency_id/' . $row1['agency_code'] . '/type/' . $type . '"><i class="fa fa-envelope"></i> Re-Invite </a>';
            }

            $output['aaData'][] = $row;
            $j++;
        }
        echo json_encode($output);
        exit();
    }
	
	
	public function getincidenttrendreportfilterAction() {
        $this->dbObj = Zend_Registry::get('db');
        $aColumns = array('agency_id', 'agency_first_name', 'agency_last_name', 'agency_address1', 'agency_address2', 'agency_city', 'agency_zip', 'agency_contact', 'agency_email', 'agency_company_name', 'agency_code', 'agency_status', 'agency_user_agency_id', 'agency_draft_status', 'agency_created_by', 'agency_modified_on', 'agency_modified_by', 'agency_is_manager');
        $sIndexColumn = 'agency_id';
        $sTable = '_uhs_agency';
        $sLimit = "";
        if (isset($_GET['iDisplayStart']) && $_GET['iDisplayLength'] != '-1') {
            $sLimit = "LIMIT " . intval($_GET['iDisplayStart']) . ", " . intval($_GET['iDisplayLength']);
        }
        $sOrder = "";
        if (isset($_GET['iSortCol_0'])) {
            $sOrder = "ORDER BY  ";
            for ($i = 0; $i < intval($_GET['iSortingCols']); $i++) {
                if ($_GET['bSortable_' . intval($_GET['iSortCol_' . $i])] == "true") {
                    $sOrder .= "" . $aColumns[intval($_GET['iSortCol_' . $i])] . " " .
                            ($_GET['sSortDir_' . $i] === 'asc' ? 'asc' : 'desc') . ", ";
                }
            }
            $sOrder = substr_replace($sOrder, "", -2);
            if ($sOrder == "ORDER BY") {
                $sOrder = "";
            }
        }
        $sWhere = "";
        if (isset($_GET['sSearch']) and $_GET['sSearch'] != "") {
            $sWhere = "WHERE (";
            for ($i = 0; $i < count($aColumns); $i++) {
                $sWhere .= "" . $aColumns[$i] . " LIKE '%" . $_GET["sSearch"] . "%' OR "; // NEW CODE
            }
            $sWhere = substr_replace($sWhere, "", -3);
            $sWhere .= ')';
        }
        for ($i = 0; $i < count($aColumns); $i++) {
            if (isset($_GET['bSearchable_' . $i]) and $_GET['bSearchable_' . $i] == "true" and $_GET['sSearch_' . $i] != '') {
                if ($sWhere == "") {
                    $sWhere = "WHERE ";
                } else {
                    $sWhere .= " AND ";
                }
                $sWhere .= "" . $aColumns[$i] . " LIKE '%" . $_GET['sSearch_' . $i] . "%' ";
            }
        }
         $indParentUsers="";
			if($this->view->user->agency_user_type=="Agency"){
				$systemUsers=$this->SuperModel->Get_AllIndividuals($this->view->user->agency_id);
			    foreach($systemUsers as $sysusers){
					$system .= $sysusers['agency_id'].',';
				}
				$indParentUsers=rtrim($system,',');
				
			}
			else{
				$indParentUsers=$this->view->user->agency_id;
			}
			if($sWhere){
				$sWhere.=" and agency_id IN(".$indParentUsers.")"; 
			}else{
				$sWhere.=" where agency_id IN(".$indParentUsers.")"; 
			} 
        $sQuery = " SELECT SQL_CALC_FOUND_ROWS " . str_replace(" , ", " ", implode(", ", $aColumns)) . " FROM  $sTable $sWhere $sOrder $sLimit";
        $qry = $this->dbObj->query($sQuery)->fetchAll();
        $sQuery = "SELECT FOUND_ROWS() as fcnt";
        $aResultFilterTotal = $this->dbObj->query($sQuery)->fetchAll();
        $iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
        $sQuery = "SELECT COUNT(`" . $sIndexColumn . "`) as cnt FROM $sTable ";
        $rResultTotal = $this->dbObj->query($sQuery)->fetchAll();
        $iTotal = $rResultTotal[0]['cnt'];
        $output = array(
            "iTotalRecords" => $iTotal,
            "iTotalDisplayRecords" => $iFilteredTotal,
            "aaData" => array()
        );
        $j = 0;
		$agency_id = $_SESSION['UHS_AUTH']['storage']->agency_id;
         $indid = $_POST['indid'];
         $fdate = $_POST['fdate'];
         $todate = $_POST['todate'];
        $where = "";
        $where .= "WHERE incident_individual_id IN(".$indParentUsers.")";
        if($indid){
			 $where .= " AND incident_individual_id = $indid";
		}
                
        if ($fdate != '' || $todate != '') {
            if ($fdate != '' && $todate != '') {
                $fdate = date("Y-m-d", strtotime($fdate));
                $todate = date("Y-m-d", strtotime($todate));
                $where .= " AND (incident_date BETWEEN '" . $fdate . "' AND '" . $todate . "')";
            } 
            //~ elseif ($fdate != '') {
                //~ $fdate = date("Y-m-d", strtotime($fdate));
                //~ $where .= " AND incident_date >= $fdate";
            //~ } elseif ($todate != '') {
                //~ $todate = date("Y-m-d", strtotime($todate));
                //~ $where .= " AND incident_date <= $todate";
            //~ }
        }
        $this->dbObj = Zend_Registry::get('db');
        $testQuery = "SELECT * FROM _uhs_incidents_reports $where";
        $incidenttrendData = $this->dbObj->query($testQuery)->fetchAll();
        $incidenttrendData = $this->array_column($incidenttrendData, 'incident_individual_id');
        $incidenttrendData = array_unique($incidenttrendData);

        $staffData = [];
        foreach ($incidenttrendData as $key => $raw_data) {
            $staffData[$key] = $this->SuperModel->Super_Get("_uhs_agency", "agency_id=$raw_data");
        }
        foreach ($staffData as $row1) {
            if ($j == 5) {
                //break;
            }
            $parentData = $this->SuperModel->Super_Get("_uhs_agency", "agency_id=" . $row1['agency_created_by']);
            $modifierData = array();
            if ($row1['agency_modified_by'] != 0) {
                $modifierData = $this->SuperModel->Super_Get("_uhs_agency", "agency_id=" . $row1['agency_modified_by']);
            }
            $row = array();
            $row[] = $j + 1;
            $row[] = '<input class="elem_ids checkboxes"  type="checkbox" name="' . $sTable . '[' . $row1[$sIndexColumn] . ']"  value="' . $row1[$sIndexColumn] . '">';
            // first name
            $row[] = ucwords($row1['agency_first_name']);
            // last name
            $row[] = ucwords($row1['agency_last_name']);

            $staff_id = $row1['agency_id'];
            
            $where2 = "";
            $where2 .= "WHERE incident_individual_id = $staff_id";
            if ($indid) {
                $where2 .= " AND incident_individual_id = $indid";
            }
           
            if ($fdate != '' || $todate != '') {
                if ($fdate != '' && $todate != '') {
                    $fdate = date("Y-m-d", strtotime($fdate));
                    $todate = date("Y-m-d", strtotime($todate));
                    $where2 .= " AND (incident_date BETWEEN '" . $fdate . "' AND '" . $todate . "')";
                } 
                //~ elseif ($fdate != '') {
                    //~ $fdate = date("Y-m-d", strtotime($fdate));
                    //~ $where2 .= " AND incident_date >= $fdate";
                //~ } elseif ($todate != '') {
                    //~ $todate = date("Y-m-d", strtotime($todate));
                    //~ $where2 .= " AND incident_date <= $todate";
                //~ }
            }

            $testQuery = "SELECT * FROM _uhs_incidents_reports $where2";
            $incidentData = $this->dbObj->query($testQuery)->fetchAll();

            $trends=array();
		    $uimui=array();
			$a=$as=$ia=$me=$e=$d=$s=$all=$an=$mp=$l=$ita=$mt=$me=$rl=$rc=$ns=$rf=$ot=0;
			$ui=$mui=0;
			$insArr=array();
			foreach($incidentData as $incident){
			  if(!empty($incident['is_included_claims'])){
				  $incidentClaims=unserialize($incident['is_included_claims']);
				  if(in_array("MUI",$incidentClaims)){
					  $uimui[]=array("name"=>"MUI","y"=>$mui+1);
				  }
				  if(in_array("UI",$incidentClaims)){
					  $uimui[]=array("name"=>"UI","y"=>$ui+1);
				  }
			  }
			  if(!empty($incident['incident_types'])){
					$incidentTypes=unserialize($incident['incident_types']);
					if(in_array("Abuse",$incidentTypes)){
						$trends[]=array("name"=>"Abuse","y"=>$a+1);
					}
					if(in_array("Attempted Suicide",$incidentTypes)){
						$trends[]=array("name"=>"Attempted Suicide","y"=>$as+1);
					}
					if(in_array("Individual Aggression toward Staff",$incidentTypes)){
						$trends[]=array("name"=>"Individual Aggression toward Staff","y"=>$ia+1);
					}
					if(in_array("Medical Emergency",$incidentTypes)){ 
						$trends[]=array("name"=>"Medical Emergency","y"=>$me+1);
					}
					if(in_array("Exploitation",$incidentTypes)){
						$trends[]=array("name"=>"Exploitation","y"=>$e+1);
					}
					if(in_array("Seizure",$incidentTypes)){
						$trends[]=array("name"=>"Seizure","y"=>$s+1);
					}
					if(in_array("Death",$incidentTypes)){
						$trends[]=array("name"=>"Death","y"=>$d+1);
					}
					if(in_array("Alleged Abuse",$incidentTypes)){
						$trends[]=array("name"=>"Alleged Abuse","y"=>$all+1);
					}
					if(in_array("Alleged Neglect",$incidentTypes)){
						$trends[]=array("name"=>"Alleged Neglect","y"=>$an+1);
					}
					if(in_array("Missing Person",$incidentTypes)){
						$trends[]=array("name"=>"Missing Person","y"=>$mp+1);
					}
					if(in_array("Law Enforcement Involvement",$incidentTypes)){
						$trends[]=array("name"=>"Law Enforcement Involvement","y"=>$l+1);
					}
					if(in_array("Individual to Individual Aggression",$incidentTypes)){
						$trends[]=array("name"=>"Individual to Individual Aggression","y"=>$ita+1);
					}
					if(in_array("Misappropriation (Theft / Fraud)",$incidentTypes)){
						$trends[]=array("name"=>"Misappropriation (Theft / Fraud)","y"=>$mt+1);
					}
					if(in_array("Medication Error",$incidentTypes)){
						$trends[]=array("name"=>"Medication Error","y"=>$me+1);
					}
					if(in_array("Relocation",$incidentTypes)){
						$trends[]=array("name"=>"Relocation","y"=>$rl+1);
					}
					if(in_array("Right Code Violation",$incidentTypes)){
						$trends[]=array("name"=>"Right Code Violation","y"=>$rc+1);
					}
					if(in_array("No Shows (Transportation Only)",$incidentTypes)){
						$trends[]=array("name"=>"No Shows (Transportation Only)","y"=>$ns+1);
					}
					if(in_array("Refusal",$incidentTypes)){
						$trends[]=array("name"=>"Refusal","y"=>$rf+1);
					}
					if(in_array("Other",$incidentTypes)){
						$trends[]=array("name"=>"Other","y"=>$ot+1);
					}
			  }   
			}
			$results=array();
			foreach($trends as $value){
			  if(!isset($results[$value['name']])){
				 $results[$value['name']]=0;
			  }
			  $results[$value['name']]+=$value['y'];
			}
			$resArr=array();
			foreach($results as $key=>$res){
				$resArr[]=array("name"=>$key,"y"=>$res);
			}
			
			$results1=array();
			foreach($uimui as $value){
			  if(!isset($results1[$value['name']])){
				 $results1[$value['name']]=0;
			  }
			  $results1[$value['name']]+=$value['y'];
			}
			$resArr1=array();
			foreach($results1 as $key=>$res){
				$resArr1[]=array("name"=>$key,"y"=>$res);
			}
			
	  if(count($incidentData)>0){
		  $row[] = count($incidentData);
		  $row[] = isset($resArr1[0]['y']) ? $resArr1[0]['y'] : 0;
		  $row[] = isset($resArr1[1]['y']) ? $resArr1[1]['y'] : 0;
	   }else{
		  $row[] = 0;
		  $row[] = 0;
		  $row[] = 0;
	   }         
           

            $where1 = "";
            $where1 .= " WHERE incident_individual_id=$staff_id";
            if ($indid) {
                $where1 .= " AND incident_individual_id = $indid";
            }
            if ($fdate != '' || $todate != '') {
                if ($fdate != '' && $todate != '') {
                    $fdate = date("Y-m-d", strtotime($fdate));
                    $todate = date("Y-m-d", strtotime($todate));
                    $where1 .= " AND (incident_date BETWEEN '" . $fdate . "' AND '" . $todate . "')";
                } 
                //~ elseif ($fdate != '') {
                    //~ $fdate = date("Y-m-d", strtotime($fdate));
                    //~ $where1 .= " AND incident_date >= $fdate";
                //~ } elseif ($todate != '') {
                    //~ $todate = date("Y-m-d", strtotime($todate));
                    //~ $where1 .= " AND incident_date <= $todate";
                //~ }
            }
            
            
            

            $this->dbObj = Zend_Registry::get('db');
            $testQuery = "SELECT * FROM _uhs_incidents_reports $where1";
            $incident_data = $this->dbObj->query($testQuery)->fetchAll();
            //prd($incident_data);
            // incident data  table
            $table = '';
            $table .= "<table style='margin: 0px auto;'><tr role='row'>";
                foreach($resArr as $incidenttypedata){
					 $color = '';
					 if($incidenttypedata['name']=="Abuse"){$color='Salmon';}if($incidenttypedata['name']=="Attempted Suicide"){$color='1b2077';}if($incidenttypedata['name']=="Exploitation"){$color='DarkOrange';}if($incidenttypedata['name']=="Medical Emergency"){$color='MediumOrchid';}if($incidenttypedata['name']=="Individual Aggression toward Staff"){$color='YellowGreen';}
					 if($incidenttypedata['name']=="Seizure"){$color='Green';}if($incidenttypedata['name']=="Death"){$color='RosyBrown';}if($incidenttypedata['name']=="Right Code Violation"){$color='e71ea4';}if($incidenttypedata['name']=="Relocation"){$color='BlueViolet';}if($incidenttypedata['name']=="Other"){$color='LightSlateGray';}
					 if($incidenttypedata['name']=="Alleged Abuse"){$color='Aqua';}if($incidenttypedata['name']=="Alleged Neglect"){$color='DeepPink';}if($incidenttypedata['name']=="Medication Error"){$color='Plum';}if($incidenttypedata['name']=="Refusal"){$color='MediumSlateBlue';}if($incidenttypedata['name']=="Behavioral Incident"){$color='MediumSpringGreen';}
					 if($incidenttypedata['name']=="Missing Person"){$color='Teal';}if($incidenttypedata['name']=="Law Enforcement Involvement"){$color='Crimson';}if($incidenttypedata['name']=="Individual to Individual Aggression"){$color=' #6e2c00 ';}if($incidenttypedata['name']=="Misappropriation (Theft / Fraud)"){$color='3eab0b';}if($incidenttypedata['name']=="No Shows (Transportation Only)"){$color='Chocolate';}
					 $table .= "<th style='padding-left: 15px !important;'><font color='$color'>$incidenttypedata[y] $incidenttypedata[name] </font></th>";
				}
                $table.="</tr></table>";

            $table .= "<table id='sample_1' class='table table-striped table-bordered table-hover dataTable no-footer dtr-inline collapsed' role='grid'>
            <thead>
                <tr role='row'>
                    <th tabindex='0' aria-controls='sample_1' rowspan='1' colspan='1'>Tracking #</th>
                    <th tabindex='0' aria-controls='sample_1' rowspan='1' colspan='1'>Incident Date</th>
                    <th tabindex='0' aria-controls='sample_1' rowspan='1' colspan='1'>Incident Location</th>
                    <th tabindex='0' aria-controls='sample_1' rowspan='1' colspan='1'>Incident Type</th>
                    <th tabindex='0' aria-controls='sample_1' rowspan='1' colspan='1'>Comment</th>
                </tr>
            </thead>
            <tbody>";

            if (count($incident_data) > 0) {
                foreach ($incident_data as $raw_data) {
					$incident_types = unserialize($raw_data['incident_types']);
					$inci = '';
					foreach($incident_types as $inci_data){
						$inci .= $inci_data.", ";
					}
					$inci_rec = rtrim($inci,", ");
                    $incident_tracking_number = $raw_data['incident_tracking_number'];
                    $incident_date = $raw_data['incident_date'];
                    $incident_location = $raw_data['incident_location'];
                    $incident_types = $inci_rec;
                    $incident_trend_comment = $raw_data['incident_trend_comment'];
                    
                    $table .= "<tr role='row' class='odd'>
                        <td style='padding-left: 8px !important;'>$incident_tracking_number</td>
                        <td>$incident_date</td>
                        <td>$incident_location</td>
                        <td>$incident_types</td>
                        <td>$incident_trend_comment</td>
                    </tr>";
                }
            } else {
                $table .= "<tr role='row' class='odd'>
                            <td colspan='8' style='text-align: center;'>No Data</td>
                    </tr>";
            }

            $table .= "</tbody></table>";
            $row[] = $table;
            $status = $row1['agency_status'] == 1 ? "checked='checked'" : " ";
            //$row[] = '<div class="danger-toggle-button"><input type="checkbox" class="toggle status-' . (int) $row1['agency_status'] . ' "  ' . $status . '  id="' . $sTable . '-' . $row1[$sIndexColumn] . '" /></div>';

            $inviteLink = "";
            if ($row1['agency_draft_status'] == 0) {
                $inviteLink = '&nbsp;<a class="btn btn-xs btn-default" href="' . APPLICATION_URL . '/agencydashboard/reinvite/agency_id/' . $row1['agency_code'] . '/type/' . $type . '"><i class="fa fa-envelope"></i> Re-Invite </a>';
            }
            $output['aaData'][] = $row;
            $j++;
        }
        echo json_encode($output);
        exit();
    }
    
	public function incidenttrendreportexportAction() {
        $agency_id = $_SESSION['UHS_AUTH']['storage']->agency_id;
        $indid = $this->_getParam('staffid');
        $fdate = $this->_getParam('from');
        $todate = $this->_getParam('to');
        
        $indParentUsers="";
			$systemUsers=$this->SuperModel->Get_AllIndividuals($this->view->user->agency_id);
			foreach($systemUsers as $sysusers){
				$system .= $sysusers['agency_id'].',';
			}
			$indParentUsers=rtrim($system,',');
			
			$sWhere='';
		    $sWhere.=" where agency_id IN(".$indParentUsers.")";    
      
        if($indid == '' && $fdate == '' && $todate == '') {
            // current week data : START

            date_default_timezone_set('America/New_York');
            $first_day_this_month = date('Y-m-01'); // hard-coded '01' for first day
            $last_day_this_month  = date('Y-m-t');

            $agency_id = $_SESSION['UHS_AUTH']['storage']->agency_id;
            $where = '';
            $where .= "WHERE incident_individual_id IN(".$indParentUsers.")";
            $where .= " AND (incident_date BETWEEN '" . $first_day_this_month . "' AND '" . $last_day_this_month . "')";
            $this->dbObj = Zend_Registry::get('db');
            $testQuery = "SELECT * FROM _uhs_incidents_reports $where";
            $staffDataFull = $this->dbObj->query($testQuery)->fetchAll();
        } else {
            if($indid == 0) {
                $indid = NULL;
            }
           
            if($fdate == "empty") {
                $fdate = '';
            }
            if($todate == "empty") {
                $todate = '';
            }
            
            $where = "";
            $where .= "WHERE incident_individual_id IN(".$indParentUsers.")";
           if(!is_null($indid)){
                //$where .= " AND service_individual_id = $indid";
                $where .= " AND incident_individual_id = $indid";
            }
           
            if ($fdate != '' || $todate != '') {
                if ($fdate != '' && $todate != '') {
                    $fdate = str_replace("q" ,"-", $fdate);
                    $todate = str_replace("q" ,"-", $todate);
                    
                    $tempFdate = explode("-", $fdate);
                    $tempToDate = explode("-", $todate);
                    
                    $fdate = $tempFdate[2]."-".$tempFdate[0]."-".$tempFdate[1];
                    $todate = $tempToDate[2]."-".$tempToDate[0]."-".$tempToDate[1];
                    
                    $fdate = date("Y-m-d", strtotime($fdate));
                    $todate = date("Y-m-d", strtotime($todate));
                    $where .= " AND (incident_date BETWEEN '" . $fdate . "' AND '" . $todate . "')";
                } elseif ($fdate != '') {
                    $fdate = str_replace("q" ,"-", $fdate);
                    $tempFdate = explode("-", $fdate);
                    $fdate = $tempFdate[2]."-".$tempFdate[0]."-".$tempFdate[1];
                    $fdate = date("Y-m-d", strtotime($fdate));
                    $where .= " AND incident_date >= $fdate";
                } elseif ($todate != '') {
                    $todate = str_replace("q" ,"-", $todate);
                    $tempToDate = explode("-", $todate);
                    $todate = $tempToDate[2]."-".$tempToDate[0]."-".$tempToDate[1];
                    $todate = date("Y-m-d", strtotime($todate));
                    $where .= " AND incident_date <= $todate";
                }
            }

            $this->dbObj = Zend_Registry::get('db');
            $testQuery = "SELECT * FROM _uhs_incidents_reports $where";
            $staffDataFull = $this->dbObj->query($testQuery)->fetchAll();
            
        }
        if(count($staffDataFull) > 0) {
            foreach ($staffDataFull as $key => $csv_raw_data) {
                $testQuery = "SELECT agency_first_name,agency_last_name FROM _uhs_agency WHERE agency_id = ".$csv_raw_data['incident_individual_id'];
                $caregiverData = $this->dbObj->query($testQuery)->fetch();
                
                $incident_types = unserialize($csv_raw_data['incident_types']);
				$inci = '';
				foreach($incident_types as $inci_data){
					$inci .= $inci_data.", ";
				}
				$inci_rec = rtrim($inci,", ");
                $csvData[$key]['id'] = $key + 1;
                $csvData[$key]['first_name'] = $caregiverData['agency_first_name'];
                $csvData[$key]['last_name'] = $caregiverData['agency_last_name'];
                $csvData[$key]['incident_tracking_number'] = $csv_raw_data['incident_tracking_number'];
                $csvData[$key]['incident_date'] = $csv_raw_data['incident_date'];
                $csvData[$key]['incident_location'] = $csv_raw_data['incident_location'];
                $csvData[$key]['incident_types'] = $inci_rec;
                
            }
        } else {
            $csvData = [];
        }
        //echo '<pre>';
        //print_r($csvData);die;
        header('Content-Type: text/csv; charset=utf-8');  
        header('Content-Disposition: attachment; filename=data.csv');  
        $output = fopen("php://output", "w");  
        //fputcsv($output, array('sheet_id', 'service_form_id', 'service_agency_id', 'service_individual_id', 'service_added_user', 'service_date', 'service_start_time', 'service_end_time', 'service_work_code', 'service_other_work_code', 'service_total_hours', 'total_miles_used', 'sheet_added_date', 'is_sheet_completed', 'location', 'sheet_modified_by', 'sheet_modified_on')); 
        fputcsv($output, array('ID', 'First Name', 'Last Name', 'Tracking #', 'Incident Date', 'Incident Location', 'Incident Type')); 
        foreach ($csvData as $dataFull) {
            fputcsv($output, $dataFull);  
        }
        fclose($output); die;
    }
    
    public function incidenttrendreportprintAction() {
		global $healthSession;
        $agency_id = $_SESSION['UHS_AUTH']['storage']->agency_id;
        $indid = $this->_getParam('staffid');
        $fdate = $this->_getParam('from');
        $todate = $this->_getParam('to');
        
        $indParentUsers="";
			$systemUsers=$this->SuperModel->Get_AllIndividuals($this->view->user->agency_id);
			foreach($systemUsers as $sysusers){
				$system .= $sysusers['agency_id'].',';
			}
			$indParentUsers=rtrim($system,',');
			
			$sWhere='';
		    $sWhere.=" where agency_id IN(".$indParentUsers.")";    
      
        if($indid == '' && $fdate == '' && $todate == '') {
            // current week data : START

            date_default_timezone_set('America/New_York');
            $first_day_this_month = date('Y-m-01'); // hard-coded '01' for first day
            $last_day_this_month  = date('Y-m-t');
            $trenddata = $this->_trendheader($first_day_this_month,$last_day_this_month);
            
            $agency_id = $_SESSION['UHS_AUTH']['storage']->agency_id;
            $where = '';
            $where .= "WHERE incident_individual_id IN(".$indParentUsers.")";
            $where .= " AND (incident_date BETWEEN '" . $first_day_this_month . "' AND '" . $last_day_this_month . "')";
            $this->dbObj = Zend_Registry::get('db');
            $testQuery = "SELECT * FROM _uhs_incidents_reports $where";
            $staffDataFull = $this->dbObj->query($testQuery)->fetchAll();
        } else {
            if($indid == 0) {
                $indid = NULL;
            }
           
            if($fdate == "empty") {
                $fdate = '';
            }
            if($todate == "empty") {
                $todate = '';
            }
            
            $where = "";
            $where .= "WHERE incident_individual_id IN(".$indParentUsers.")";
            if(!is_null($indid)){
                //$where .= " AND service_individual_id = $indid";
                $where .= " AND incident_individual_id = $indid";
            }
           
            if ($fdate != '' || $todate != '') {
                if ($fdate != '' && $todate != '') {
                    $fdate = str_replace("q" ,"-", $fdate);
                    $todate = str_replace("q" ,"-", $todate);
                    
                    $tempFdate = explode("-", $fdate);
                    $tempToDate = explode("-", $todate);
                    
                    $fdate = $tempFdate[2]."-".$tempFdate[0]."-".$tempFdate[1];
                    $todate = $tempToDate[2]."-".$tempToDate[0]."-".$tempToDate[1];
                    
                    $fdate = date("Y-m-d", strtotime($fdate));
                    $todate = date("Y-m-d", strtotime($todate));
                    $where .= " AND (incident_date BETWEEN '" . $fdate . "' AND '" . $todate . "')";
                } elseif ($fdate != '') {
                    $fdate = str_replace("q" ,"-", $fdate);
                    $tempFdate = explode("-", $fdate);
                    $fdate = $tempFdate[2]."-".$tempFdate[0]."-".$tempFdate[1];
                    $fdate = date("Y-m-d", strtotime($fdate));
                    $where .= " AND incident_date >= $fdate";
                } elseif ($todate != '') {
                    $todate = str_replace("q" ,"-", $todate);
                    $tempToDate = explode("-", $todate);
                    $todate = $tempToDate[2]."-".$tempToDate[0]."-".$tempToDate[1];
                    $todate = date("Y-m-d", strtotime($todate));
                    $where .= " AND incident_date <= $todate";
                }
                 $trenddata = $this->_trendheader($fdate,$todate);
            }

            $this->dbObj = Zend_Registry::get('db');
            $testQuery = "SELECT * FROM _uhs_incidents_reports $where";
            $staffDataFull = $this->dbObj->query($testQuery)->fetchAll();
            
        }
       
        
        if(count($staffDataFull) > 0) {
			$html="";
			$pdfTitle=$this->view->site_configs['site_name']." | Incident Trend Report";
		    $html.= $this->_print_header("Incident Trend Report",$fdate,$todate);
			$html.="</div>
			   <div class='text-center'><h3>".$trenddata['sum']." Incidents during Trend Period</h3></div>
			    <div class='text-center'>".$trenddata['incidentdata']."</div>
			    <table class='table table-bordered' cellspacing='10' cellpadding='20' width='100%'>
					<tr>
						<th style='padding:0.3%;' width='12.5%'>ID</th>
						<th style='padding:0.3%;' width='12.5%'>First Name</th>
						<th style='padding:0.3%;' width='12.5%'>Last Name</th>
						<th style='padding:0.3%;' width='12.5%'># Tracking</th>
						<th style='padding:0.3%;' width='12.5%'>Incident date</th>
						<th style='padding:0.3%;' width='12.5%'>Incident Location</th>
						<th style='padding:0.3%;' width='12.5%'>Incident Type</th>
				   </tr>";
			 foreach ($staffDataFull as $key => $csv_raw_data) {
				$testQuery = "SELECT agency_first_name,agency_last_name FROM _uhs_agency WHERE agency_id = ".$csv_raw_data['incident_individual_id'];
                $caregiverData = $this->dbObj->query($testQuery)->fetch();
                
                $incident_types = unserialize($csv_raw_data['incident_types']);
				$inci = '';
				foreach($incident_types as $inci_data){
					$inci .= $inci_data.", ";
				}
				$inci_rec = rtrim($inci,", ");
                $csvData[$key]['id'] = $key + 1;
                $csvData[$key]['first_name'] = $caregiverData['agency_first_name'];
                $csvData[$key]['last_name'] = $caregiverData['agency_last_name'];
                $csvData[$key]['incident_tracking_number'] = $csv_raw_data['incident_tracking_number'];
                $csvData[$key]['incident_date'] = $csv_raw_data['incident_date'];
                $csvData[$key]['incident_location'] = $csv_raw_data['incident_location'];
                $csvData[$key]['incident_types'] = $inci_rec;
				$html.="<tr>
							<td style='padding:0.3%;'>".$csvData[$key]['id']."</td>
							<td style='padding:0.3%;'>".$csvData[$key]['first_name']."</td>
							<td style='padding:0.3%;'>".$csvData[$key]['last_name']."</td>
							<td style='padding:0.3%;'>".$csvData[$key]['incident_tracking_number']."</td>
							<td style='padding:0.3%;'>".$csvData[$key]['incident_date']."</td>
							<td style='padding:0.3%;'>".$csvData[$key]['incident_location']."</td>
							<td style='padding:0.3%;'>".$csvData[$key]['incident_types']."</td>
				  	  </tr>";	
			}
			$html.="</table>";
          if(!empty($html)){
			require_once ROOT_PATH.'/private/mpdf/mpdf.php';
			$mpdf=new mPDF('utf-8', 'A4-L');
			$stylesheet = file_get_contents(APPLICATION_URL.'/public/plugins/bootstrap/css/bootstrap.css');
			$mpdf->SetTitle($pdfTitle);
			$mpdf->WriteHTML($stylesheet,1);
			$mpdf->WriteHTML($html,2);
			$mpdf->Output();
			exit();
		 }else{
				$healthSession->errorMsg="No logs found.";
			}
        }else{
			$healthSession->errorMsg="No logs found.";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_incident_trend_report");
		}         
    }
    private function _print_header($title,$fdate,$todate){   
		date_default_timezone_set('America/New_York');
		if($fdate=="" && $todate==""){
		  $first_day_this_month = date('m/01/Y'); // hard-coded '01' for first day
          $last_day_this_month  = date('m/t/Y');
	    }else{
			$first_day_this_month = date($fdate);
            $last_day_this_month  = date($todate);
		}
        $currentMonth = formatDate($first_day_this_month)." To ".formatDate($last_day_this_month);   
		$html="";
		$html .= '<table style= "width:100%">
					<tr>
						<td> 
							<div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
								<h4 class="magin0">Company Information</h4><br>
								<p><b>Company:</b>'. ucwords($this->view->user->agency_company_name).'</p>
								
								<p><b>Provider No:</b>'. $this->view->user->agency_provider_number.'</p>
								
								<p><b>Name:</b>'. ucwords($this->view->user->agency_first_name. '  ' . $this->view->user->agency_last_name).'</p>
								
								<p><b>Address:</b>'. ucwords($this->view->user->agency_address1 .', '. $this->view->user->agency_city.', '. $this->view->user->agency_state.', '. $this->view->user->agency_zip).'</p>
								
								<p><b>ContactContact:</b>'. $this->view->user->agency_contact.'</p>
							</div>
						</td>
					</tr>
				</table>	
							<br/>';
			$html.="<div class='text-right'>Date:".date("m/d/Y H:i:s",time())."</div><div class='alert alert-info text-center'><h3>$title($currentMonth)</h3>";
			return $html;

	}
	
	public function incidenttrendreportemailformAction(){
		global $healthSesion;
		$indid=$_REQUEST['indid'];
		$fdate=$_REQUEST['fdate'];
		$todate=$_REQUEST['todate'];
		if($indid != '' && $fdate != '' && $todate != ''){
			$fdate = date("Y-m-d", strtotime($fdate));
			$todate = date("Y-m-d", strtotime($todate));
		}
		else{
			$fdate = date('Y-m-01'); // hard-coded '01' for first day
            $todate  = date('Y-m-t');
	   }
		$form=new Application_Form_CustomForms();
		$form->incidenttrendReportEmail($fdate,$todate,$indid);
		echo "Send Incident Trend Report"."~~".$form;
		exit();
	}
	
	public function sendincidenttrendreportemailAction(){
		global $healthSession;
		$indid=$this->_getParam("indid");
		$fdate=$this->_getParam("fdate");
		$todate=$this->_getParam("todate");
		$first_day_this_month = date($fdate);
        $last_day_this_month  = date($todate);
		$currentMonth = formatDate($first_day_this_month)." To ".formatDate($last_day_this_month);  
		
		$indParentUsers="";
		
		if($indid == 0){
            $systemUsers=$this->SuperModel->Get_AllIndividuals($this->view->user->agency_id);
			foreach($systemUsers as $sysusers){
				$system .= $sysusers['agency_id'].',';
			}
	        $indParentUsers=rtrim($system,',');
		}else{
			$indParentUsers=$indid;
		}
		$form=new Application_Form_CustomForms();
		$form->incidenttrendReportEmail($fdate,$todate,$indid);
		if($this->getRequest()->isPost()){
			$posted_data = $this->getRequest()->getPost();
   			if($form->isValid($posted_data)){ 
				
				$incidentData=$this->SuperModel->Super_Get("_uhs_incidents_reports","(incident_date BETWEEN '" . $fdate . "' AND '" . $todate . "') and incident_individual_id IN(".$indParentUsers.")", "fetchAll");
				$agency_email=$this->view->user->agency_email; //19-feb-2018
				$emailData['receiver_emails']=$posted_data['receiver_emails'];
				$emailData['email_subject']=$posted_data['email_subject'];
				$emailData['email_msg']=$posted_data['email_msg'];
				$emailData['agency_email'] = $agency_email;//19-feb-2018
				$isSend=$this->modelEmail->sendIncidenttrendReportEmail($incidentData,$emailData,$currentMonth);
				if($isSend->success){
                  $healthSession->successMsg  = "Incident report has been sent successfully.";
				}
				else{
					$healthSession->errorMsg = " Please check information again.";
				}
   			}else{
				$healthSession->errorMsg = " Please check information again.";
 			}
		 }
		 $this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_incident_trend_report");
	}	
        
    public function gettaskdataAction(){
            global $healthSession;
            $formid=$this->_getParam('formid');
            $supportid=$this->_getParam('supportid');
            $editid=$this->_getParam('editid');
            $type=$this->_getParam('type');
            $addeduserid=$this->_getParam('addeduserid');
            $shift=$this->_getParam('shift');
            $taskDatas=$this->SuperModel->Super_Get("_uhs_task_entries","task_support_id=".$supportid." and task_type='".$type."' and task_added_user='".$addeduserid."' and DATE(task_added_date)='".date('Y-m-d')."'","fetchAll");
            $temp = array();
            $shiftmatch=0;
            if(!empty($taskDatas)){
               foreach($taskDatas as $taskData){
                   $temp[]=$taskData['shift'];
               }
               if(in_array($shift,$temp)){
                   $shiftmatch=1;
               }
           }
            echo $shiftmatch;
            exit;
            
        }
        public function removecarinspectionAction(){
		global $healthSession;
		$indid=$this->_getParam('indid');
		$formid=$this->_getParam('formid');
 		$this->_helper->layout->disableLayout();
		$this->_helper->viewRenderer->setNoRender(true);
		$formData = $this->getRequest()->getPost();
                if(isset($formData['records']) && count($formData['records'])) {
			foreach($formData['records'] as $key=>$values){
  				$isDel=$this->SuperModel->Super_Delete('_uhs_car_inspection',"ci_id=".$values);
 				$healthSession->successMsg="Car inspection has been deleted successfully.";
			}
                }
		else{
			$healthSession->errorMsg="Invalid Request.";
		}
		$this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"front_view_car_inspection");
	}
	
        private function _vehicle_inspection_log($indData,$ids,$formid,$extra=array()){
		
                global $months;
		$userCond="";
		if($this->view->user->agency_user_type!="Agency"){
			$userCond="ci_added_by='".$this->view->user->agency_id."' and ";
                } else {
                    $userCond="ci_agency_id='".$this->view->user->agency_id."' and ";
                }
		$html="";
		if($ids !=="All"){
                    $data=$this->SuperModel->Super_Get("_uhs_car_inspection","ci_id In(".$ids.")","fetchAll",array("order"=>"ci_id desc"));
		}
		else{
                    $data=$this->SuperModel->Super_Get("_uhs_car_inspection","".$userCond." ci_individual_id=".$indData['agency_id']." and MONTH(ci_added_date)=".$extra['month']." and YEAR(ci_added_date)='".$extra['year']."'","fetchAll",array("order"=>"ci_id desc"));
		}
                if(count($data)>0){
                        $html.= $this->_report_header("Vehicle Inspection Log",$indData);
			$html.="
						<h5>Individual Information: ".ucwords($indData['agency_first_name']." ".$indData['agency_last_name']).",".$indData['agency_city'].",".$indData['agency_state'].",".$indData['agency_zip']."</h5>
			 	   </div>";
			$html.="<table class='table table-bordered' cellspacing='10' cellpadding='20' width='100%'>
					<tr>
						<th style='padding:0.3%;' width='16.6%'>Date Of Inspection</th>
						<th style='padding:0.3%;' width='16.6%'>Inspection Id</th>
						<th style='padding:0.3%;' width='16.6%'>Licence Plate #</th>
						<th style='padding:0.3%;' width='16.6%'>Vehicle Identification Number</th>
						<th style='padding:0.3%;' width='16.6%'>Created By</th>
						<th style='padding:0.3%;' width='16.6%'>Created On</th>
				   </tr>";
			foreach($data as $data){
				$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$data['ci_added_by']);
				$myVehicleData=$this->SuperModel->Super_Get("_uhs_vehicle","ve_id=".$data['ci_license_plate_number']);
				$html.="<tr>
							<td style='padding:0.3%;'>".formatDate($data['ci_inspection_date'])."</td>
							<td style='padding:0.3%;'>".$data['ci_code']."</td>
							<td style='padding:0.3%;'>".$myVehicleData['ve_licence_plate_number']."</td>
							<td style='padding:0.3%;'>".$myVehicleData['ve_vin_number']."</td>
							<td style='padding:0.3%;'>".ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."</td>
							<td style='padding:0.3%;'>".formatDateTimeNew($data['ci_added_date'])."</td>
				  	  </tr>";	
				$html.="<tr><td colspan=6>
                                    <span>Secure storage space: ";
                                    if($data['ci_secure_storage_space']){
                                       $html.="<strong>Clear</strong>";
                                    } else {
                                       $html.="<strong>Not clear</strong>";
                                    }
                                    $html.="</span>&nbsp;&nbsp;&nbsp;";
                                    $html.="<span>  Two-Way Communication: ";
                                    if($data['ci_communication']){
                                        $html.="<strong>Working</strong>";
                                    }else{
                                        $html.="<strong>Not working</strong>";
                                    }
                                    $html.="</span>&nbsp;&nbsp;&nbsp;";
                                    $html.="<span> Lights: ";
                                    if($data['ci_lights']){
                                         $html.="<strong>Yes</strong>";
                                    }else{
                                        $html.="<strong>No</strong>";
                                    }
                                    $html.="</span>&nbsp;&nbsp;&nbsp;";
                                    $html.="<span> Windshield washer/wipers: ";
                                    if($data['ci_windshield_washer_wipers']){
                                        $html.="<strong>Yes</strong>";
                                    }else{
                                        $html.="<strong>No</strong>";
                                    }
                                    $html.="</span>&nbsp;&nbsp;&nbsp;";
                                    $html.="<span> Emergency equipment: ";
                                    if($data['ci_emergency_equipment']){
                                        $html.="<strong>Secured</strong>";
                                    }else{
                                        $html.="<strong>Not secured</strong>";
                                    }
                                    $html.="</span>&nbsp;&nbsp;&nbsp;";
                                    $html.="<span> Mirrors: ";
                                    if($data['ci_mirrors']){
                                         $html.="<strong>Yes</strong>";
                                    }else{
                                        $row[]="No";
                                        $html.="<strong>No</strong>";
                                    }
                                    $html.="</span>&nbsp;&nbsp;&nbsp;";
                                    $html.="<span> Horn: ";
                                    if($data['ci_horn']){
                                         $html.="<strong>Yes</strong>";
                                    }else{
                                        $html.="<strong>No</strong>";
                                    }
                                    $html.="</span>&nbsp;&nbsp;&nbsp;";
                                    $html.="<span> Tires: ";
                                    if($data['ci_tires']){
                                         $html.="<strong>Yes</strong>";
                                    }else{
                                        $html.="<strong>No</strong>";
                                    }
                                    $html.="</span>&nbsp;&nbsp;&nbsp;";
                                    $html.="<span> Brakes: ";
                                     if($data['ci_brakes']){
                                         $html.="<strong>Yes</strong>";
                                    }else{
                                        $html.="<strong>No</strong>";
                                    }
                                    $html.="</span>&nbsp;&nbsp;&nbsp;";
                                    $html.="<span> Seat belt: ";
                                     if($data['ci_seat_belt']){
                                         $html.="<strong>Yes</strong>";
                                    }else{
                                        $html.="<strong>No</strong>";
                                    }
                                    $html.="</span>&nbsp;&nbsp;&nbsp;";
                                    $html.="<span> Wheelchair fasteners: ";
                                    if($data['ci_wheelchair_fasteners']){
                                         $html.="<strong>Working</strong>";
                                    }else{
                                       $html.="<strong>Not working</strong>";
                                    }
                                    $html.="</span>&nbsp;&nbsp;&nbsp;";
                                    $html.="<span> Restraints: ";
                                    if($data['ci_restraints']){
                                        $html.="<strong>Yes</strong>";
                                    }else{
                                        $html.="<strong>No</strong>";
                                    }
                                    $html.="</span>&nbsp;&nbsp;&nbsp;";
                                    $html.="<span> Fire extinguisher and an emergency first-aid kit that are safely secured: ";
                                    if($data['ci_fire_extinguisher']){
                                         $html.="<strong>Yes</strong>";
                                    }else{
                                        $html.="<strong>No</strong>";
                                    }
                                    $html.="</span>&nbsp;&nbsp;&nbsp;";
                                    $html.="<span> Access ramp or hydraulic lift: ";
                                    if($data['ci_ramp_hydraulic_lift']){
                                        $html.="<strong>working</strong>";
                                    }else{
                                         $html.="<strong>Not working</strong>";
                                    }
                                    $html.="</span>&nbsp;&nbsp;&nbsp;";
                                    
                                    
                                   $html.="</td></tr>";	
			}
			$html.="</table>";
			if($ids=="All"){
				$html.="<pagebreak />";
			}
		}else{
			//$html.= "<h4><center><strong><i> No DATA FOUND </strong></i></center></h4> </div>";
		}
		return $html;
	}
	public function incidenttrendreportcommentformAction(){
		global $healthSesion;
		$fdate=$_REQUEST['fdate'];
		$todate=$_REQUEST['todate'];
		if($fdate != '' && $todate != ''){
			$current_fdate = date("m/d/Y", strtotime($fdate));
			$current_todate = date("m/d/Y", strtotime($todate));
			
			$fdate = date("Y-m-d", strtotime($fdate));
			$todate = date("Y-m-d", strtotime($todate));
		}
		else{
			 $current_fdate = date('m/01/Y'); // hard-coded '01' for first day
             $current_todate  = date('m/t/Y');
             
             $fdate = date('Y-m-01'); // hard-coded '01' for first day
             $todate  = date('Y-m-t');
	   }
	   
	    $commentData=$this->SuperModel->Super_Get("_uhs_incident_trend_report_comment","trend_comment_from='".$fdate."' and trend_comment_to='".$todate."'","fetch");
        if(!empty($commentData)){
			echo "1";
			exit();
		}else{
			$form=new Application_Form_CustomForms();
			$form->incidenttrendReportComment($fdate,$todate);
			$currentMonth = formatDate($current_fdate)." To ".formatDate($current_todate);  
			echo "Send Incident Trend Report(".$currentMonth.")~~".$form;
			exit();
	    }
	}
	
	public function saveincidenttrendreportcommentAction(){
		global $healthSesion;
		$fdate=$this->_getParam("fdate");
		$todate=$this->_getParam("todate");
		$form=new Application_Form_CustomForms();
		$form->incidenttrendReportComment($fdate,$todate);
		if($this->getRequest()->isPost()){
			$posted_data = $this->getRequest()->getPost();
   			if($form->isValid($posted_data)){ 
				    $posted_data['trend_comment_from']=$fdate;
					$posted_data['trend_report_comment']=$posted_data['trend_report_comment'];
					$posted_data['trend_comment_to']=$todate;
					$posted_data['comment_added_user']=$this->view->user->subuser_id;
					$posted_data['comment_agency_id']=$this->view->user->agency_id;
					$posted_data['report_comment_created_on']=date('Y-m-d H:i:s');
					
					$isInserted=$this->SuperModel->Super_Insert("_uhs_incident_trend_report_comment",$posted_data);
					if($isInserted->success){
							$healthSession->successMsg="Comment has been added successfully.";
				    }else{
							$healthSession->errorMsg=$isInserted->message;
				     }
					
   			}else{
				$healthSession->errorMsg = " Please check information again.";
 			}
		 }
		 $this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_incident_trend_report");
	}


   private function _trendheader($first_day_this_month,$last_day_this_month){
         $aColumns = array('agency_id', 'agency_first_name', 'agency_last_name', 'agency_address1', 'agency_address2', 'agency_city', 'agency_zip', 'agency_contact', 'agency_email', 'agency_company_name', 'agency_code', 'agency_status', 'agency_user_agency_id', 'agency_draft_status', 'agency_created_by', 'agency_modified_on', 'agency_modified_by', 'agency_is_manager');
         $sTable = '_uhs_agency';
         $indParentUsers="";
			if($this->view->user->agency_user_type=="Agency"){
				$systemUsers=$this->SuperModel->Get_AllIndividuals($this->view->user->agency_id);
			    foreach($systemUsers as $sysusers){
					$system .= $sysusers['agency_id'].',';
				}
				$indParentUsers=rtrim($system,',');
				
			}
			else{
				$indParentUsers=$this->view->user->agency_id;
			}
			
        if($indid){
			$indParentUsers = $indid;
		}
        $agency_id = $_SESSION['UHS_AUTH']['storage']->agency_id;
        $where = '';
        $where .= "WHERE incident_individual_id IN(".$indParentUsers.")";
        $where .= "AND (incident_date BETWEEN '" . $first_day_this_month . "' AND '" . $last_day_this_month . "')";
        $this->dbObj = Zend_Registry::get('db');
        $testQuery = "SELECT incident_individual_id FROM _uhs_incidents_reports $where";
        $staffData = $this->dbObj->query($testQuery)->fetchAll();
        $staffData = $this->array_column($staffData, 'incident_individual_id');
        $staffData = array_unique($staffData);
        $staffData = array_values($staffData);

        foreach ($staffData as $key => $raw_data) {
            $this->dbObj = Zend_Registry::get('db');
            $testQuery = "SELECT agency_id,agency_first_name,agency_last_name,agency_address1,agency_address2,agency_city,agency_zip,agency_contact,agency_email,agency_company_name,agency_code,agency_status,agency_user_agency_id,agency_draft_status,agency_created_by,agency_modified_on,agency_modified_by,agency_is_manager FROM _uhs_agency WHERE agency_id = $raw_data";
            $staffDataFull[$key] = $this->dbObj->query($testQuery)->fetch();
        }
        $common_array =array();
        foreach($staffDataFull as $row1){
		
            $staff_id = $row1['agency_id'];

            $where1 = '';
            $where1 .= "WHERE incident_individual_id=$staff_id";
            $where1 .= " AND (incident_date BETWEEN '" . $first_day_this_month . "' AND '" . $last_day_this_month . "')";
            $sQuery = "SELECT * FROM _uhs_incidents_reports $where1";
            $incidentData = $this->dbObj->query($sQuery)->fetchAll();
            $trends=array();
		    $uimui=array();
			$a=$as=$ia=$me=$e=$d=$s=$all=$an=$mp=$l=$ita=$mt=$me=$rl=$rc=$ns=$rf=$ot=0;
			$insArr=array();
			foreach($incidentData as $incident){
			  if(!empty($incident['incident_types'])){
					$incidentTypes=unserialize($incident['incident_types']);
					if(in_array("Abuse",$incidentTypes)){
						$trends[]=array("name"=>"Abuse","y"=>$a+1);
					}
					if(in_array("Attempted Suicide",$incidentTypes)){
						$trends[]=array("name"=>"Attempted Suicide","y"=>$as+1);
					}
					if(in_array("Individual Aggression toward Staff",$incidentTypes)){
						$trends[]=array("name"=>"Individual Aggression toward Staff","y"=>$ia+1);
					}
					if(in_array("Medical Emergency",$incidentTypes)){ 
						$trends[]=array("name"=>"Medical Emergency","y"=>$me+1);
					}
					if(in_array("Exploitation",$incidentTypes)){
						$trends[]=array("name"=>"Exploitation","y"=>$e+1);
					}
					if(in_array("Seizure",$incidentTypes)){
						$trends[]=array("name"=>"Seizure","y"=>$s+1);
					}
					if(in_array("Death",$incidentTypes)){
						$trends[]=array("name"=>"Death","y"=>$d+1);
					}
					if(in_array("Alleged Abuse",$incidentTypes)){
						$trends[]=array("name"=>"Alleged Abuse","y"=>$all+1);
					}
					if(in_array("Alleged Neglect",$incidentTypes)){
						$trends[]=array("name"=>"Alleged Neglect","y"=>$an+1);
					}
					if(in_array("Missing Person",$incidentTypes)){
						$trends[]=array("name"=>"Missing Person","y"=>$mp+1);
					}
					if(in_array("Law Enforcement Involvement",$incidentTypes)){
						$trends[]=array("name"=>"Law Enforcement Involvement","y"=>$l+1);
					}
					if(in_array("Individual to Individual Aggression",$incidentTypes)){
						$trends[]=array("name"=>"Individual to Individual Aggression","y"=>$ita+1);
					}
					if(in_array("Misappropriation (Theft / Fraud)",$incidentTypes)){
						$trends[]=array("name"=>"Misappropriation (Theft / Fraud)","y"=>$mt+1);
					}
					if(in_array("Medication Error",$incidentTypes)){
						$trends[]=array("name"=>"Medication Error","y"=>$me+1);
					}
					if(in_array("Relocation",$incidentTypes)){
						$trends[]=array("name"=>"Relocation","y"=>$rl+1);
					}
					if(in_array("Right Code Violation",$incidentTypes)){
						$trends[]=array("name"=>"Right Code Violation","y"=>$rc+1);
					}
					if(in_array("No Shows (Transportation Only)",$incidentTypes)){
						$trends[]=array("name"=>"No Shows (Transportation Only)","y"=>$ns+1);
					}
					if(in_array("Refusal",$incidentTypes)){
						$trends[]=array("name"=>"Refusal","y"=>$rf+1);
					}
					if(in_array("Other",$incidentTypes)){
						$trends[]=array("name"=>"Other","y"=>$ot+1);
					}
			  }   
			}
			$results=array();
			foreach($trends as $value){
			  if(!isset($results[$value['name']])){
				 $results[$value['name']]=0;
			  }
			  $results[$value['name']]+=$value['y'];
			}
			
			foreach($results as $key=>$res){
				$common_array[]=array("name"=>$key,"y"=>$res);
			}
			
	   }
        $results1=array();
			foreach($common_array as $value){
			  if(!isset($results1[$value['name']])){
				 $results1[$value['name']]=0;
			  }
			  $results1[$value['name']]+=$value['y'];
			}
			$final_common_array = array();
			foreach($results1 as $key=>$res){
				$final_common_array[]=array("name"=>$key,"y"=>$res);
			}
		$data = '| ';
		$sum = 0;
		foreach($final_common_array as $incidenttypedata){
			 $color = '';
			 if($incidenttypedata['name']=="Abuse"){$color='Salmon';}if($incidenttypedata['name']=="Attempted Suicide"){$color='1b2077';}if($incidenttypedata['name']=="Exploitation"){$color='DarkOrange';}if($incidenttypedata['name']=="Medical Emergency"){$color='MediumOrchid';}if($incidenttypedata['name']=="Individual Aggression toward Staff"){$color='YellowGreen';}
			 if($incidenttypedata['name']=="Seizure"){$color='Green';}if($incidenttypedata['name']=="Death"){$color='RosyBrown';}if($incidenttypedata['name']=="Right Code Violation"){$color='e71ea4';}if($incidenttypedata['name']=="Relocation"){$color='BlueViolet';}if($incidenttypedata['name']=="Other"){$color='LightSlateGray';}
			 if($incidenttypedata['name']=="Alleged Abuse"){$color='Aqua';}if($incidenttypedata['name']=="Alleged Neglect"){$color='DeepPink';}if($incidenttypedata['name']=="Medication Error"){$color='Plum';}if($incidenttypedata['name']=="Refusal"){$color='MediumSlateBlue';}if($incidenttypedata['name']=="Behavioral Incident"){$color='MediumSpringGreen';}
			 if($incidenttypedata['name']=="Missing Person"){$color='Teal';}if($incidenttypedata['name']=="Law Enforcement Involvement"){$color='Crimson';}if($incidenttypedata['name']=="Individual to Individual Aggression"){$color=' #6e2c00 ';}if($incidenttypedata['name']=="Misappropriation (Theft / Fraud)"){$color='3eab0b';}if($incidenttypedata['name']=="No Shows (Transportation Only)"){$color='Chocolate';}
			$data .= "<b><font color='$color'>".$incidenttypedata['y']." ".$incidenttypedata['name']." </font></b>| ";
			$sum += $incidenttypedata['y'];
		}
		
		return array('sum'=>$sum,'incidentdata'=>$data);
	}
		
        
  public function getincidenttrendreportfilterdivdataAction(){
	  global $healthSession;
         $first_day_this_month = $_POST['fdate'];
         $last_day_this_month = $_POST['todate'];
         if($first_day_this_month !="" && $last_day_this_month != ""){
		    $first_day_this_month = date("Y-m-d", strtotime($_POST['fdate']));
            $last_day_this_month = date("Y-m-d", strtotime($_POST['todate']));
            
		  }else{
            $first_day_this_month = date('Y-m-01'); // hard-coded '01' for first day
            $last_day_this_month  = date('Y-m-t');
	      }
	    
		$aColumns = array('agency_id', 'agency_first_name', 'agency_last_name', 'agency_address1', 'agency_address2', 'agency_city', 'agency_zip', 'agency_contact', 'agency_email', 'agency_company_name', 'agency_code', 'agency_status', 'agency_user_agency_id', 'agency_draft_status', 'agency_created_by', 'agency_modified_on', 'agency_modified_by', 'agency_is_manager');
         $sTable = '_uhs_agency';
         $indParentUsers="";
			if($this->view->user->agency_user_type=="Agency"){
				$systemUsers=$this->SuperModel->Get_AllIndividuals($this->view->user->agency_id);
			    foreach($systemUsers as $sysusers){
					$system .= $sysusers['agency_id'].',';
				}
				$indParentUsers=rtrim($system,',');
				
			}
			else{
				$indParentUsers=$this->view->user->agency_id;
			}
			
        
        $agency_id = $_SESSION['UHS_AUTH']['storage']->agency_id;
        $where = "";
        $indid = $_POST['indid'];
        
        $where .= "WHERE incident_individual_id IN(".$indParentUsers.")";
        if($indid){
			 $where .= " AND incident_individual_id = $indid";
		}
		$where .= " AND (incident_date BETWEEN '" . $first_day_this_month . "' AND '" . $last_day_this_month . "')";
        $this->dbObj = Zend_Registry::get('db');
        $testQuery = "SELECT incident_individual_id FROM _uhs_incidents_reports $where";
        $staffData = $this->dbObj->query($testQuery)->fetchAll();
          
        $staffData = $this->array_column($staffData, 'incident_individual_id');
        $staffData = array_unique($staffData);
        $staffData = array_values($staffData);

        foreach ($staffData as $key => $raw_data) {
            $this->dbObj = Zend_Registry::get('db');
            $testQuery = "SELECT agency_id,agency_first_name,agency_last_name,agency_address1,agency_address2,agency_city,agency_zip,agency_contact,agency_email,agency_company_name,agency_code,agency_status,agency_user_agency_id,agency_draft_status,agency_created_by,agency_modified_on,agency_modified_by,agency_is_manager FROM _uhs_agency WHERE agency_id = $raw_data";
            $staffDataFull[$key] = $this->dbObj->query($testQuery)->fetch();
        }
        $common_array =array();
        foreach($staffDataFull as $row1){
		
            $staff_id = $row1['agency_id'];

            $where1 = '';
            $where1 .= "WHERE incident_individual_id=$staff_id";
            $where1 .= " AND (incident_date BETWEEN '" . $first_day_this_month . "' AND '" . $last_day_this_month . "')";
            $sQuery = "SELECT * FROM _uhs_incidents_reports $where1";
            $incidentData = $this->dbObj->query($sQuery)->fetchAll();
            $trends=array();
		    $uimui=array();
			$a=$as=$ia=$me=$e=$d=$s=$all=$an=$mp=$l=$ita=$mt=$me=$rl=$rc=$ns=$rf=$ot=0;
			$insArr=array();
			foreach($incidentData as $incident){
			  if(!empty($incident['incident_types'])){
					$incidentTypes=unserialize($incident['incident_types']);
					if(in_array("Abuse",$incidentTypes)){
						$trends[]=array("name"=>"Abuse","y"=>$a+1);
					}
					if(in_array("Attempted Suicide",$incidentTypes)){
						$trends[]=array("name"=>"Attempted Suicide","y"=>$as+1);
					}
					if(in_array("Individual Aggression toward Staff",$incidentTypes)){
						$trends[]=array("name"=>"Individual Aggression toward Staff","y"=>$ia+1);
					}
					if(in_array("Medical Emergency",$incidentTypes)){ 
						$trends[]=array("name"=>"Medical Emergency","y"=>$me+1);
					}
					if(in_array("Exploitation",$incidentTypes)){
						$trends[]=array("name"=>"Exploitation","y"=>$e+1);
					}
					if(in_array("Seizure",$incidentTypes)){
						$trends[]=array("name"=>"Seizure","y"=>$s+1);
					}
					if(in_array("Death",$incidentTypes)){
						$trends[]=array("name"=>"Death","y"=>$d+1);
					}
					if(in_array("Alleged Abuse",$incidentTypes)){
						$trends[]=array("name"=>"Alleged Abuse","y"=>$all+1);
					}
					if(in_array("Alleged Neglect",$incidentTypes)){
						$trends[]=array("name"=>"Alleged Neglect","y"=>$an+1);
					}
					if(in_array("Missing Person",$incidentTypes)){
						$trends[]=array("name"=>"Missing Person","y"=>$mp+1);
					}
					if(in_array("Law Enforcement Involvement",$incidentTypes)){
						$trends[]=array("name"=>"Law Enforcement Involvement","y"=>$l+1);
					}
					if(in_array("Individual to Individual Aggression",$incidentTypes)){
						$trends[]=array("name"=>"Individual to Individual Aggression","y"=>$ita+1);
					}
					if(in_array("Misappropriation (Theft / Fraud)",$incidentTypes)){
						$trends[]=array("name"=>"Misappropriation (Theft / Fraud)","y"=>$mt+1);
					}
					if(in_array("Medication Error",$incidentTypes)){
						$trends[]=array("name"=>"Medication Error","y"=>$me+1);
					}
					if(in_array("Relocation",$incidentTypes)){
						$trends[]=array("name"=>"Relocation","y"=>$rl+1);
					}
					if(in_array("Right Code Violation",$incidentTypes)){
						$trends[]=array("name"=>"Right Code Violation","y"=>$rc+1);
					}
					if(in_array("No Shows (Transportation Only)",$incidentTypes)){
						$trends[]=array("name"=>"No Shows (Transportation Only)","y"=>$ns+1);
					}
					if(in_array("Refusal",$incidentTypes)){
						$trends[]=array("name"=>"Refusal","y"=>$rf+1);
					}
					if(in_array("Other",$incidentTypes)){
						$trends[]=array("name"=>"Other","y"=>$ot+1);
					}
			  }   
			}
			$results=array();
			foreach($trends as $value){
			  if(!isset($results[$value['name']])){
				 $results[$value['name']]=0;
			  }
			  $results[$value['name']]+=$value['y'];
			}
			
			foreach($results as $key=>$res){
				$common_array[]=array("name"=>$key,"y"=>$res);
			}
			
	   }
        $results1=array();
			foreach($common_array as $value){
			  if(!isset($results1[$value['name']])){
				 $results1[$value['name']]=0;
			  }
			  $results1[$value['name']]+=$value['y'];
			}
			$final_common_array = array();
			foreach($results1 as $key=>$res){
				$final_common_array[]=array("name"=>$key,"y"=>$res);
			}
		$data = '| ';
		$sum = 0;
		foreach($final_common_array as $incidenttypedata){
			 $color = '';
			 if($incidenttypedata['name']=="Abuse"){$color='Salmon';}if($incidenttypedata['name']=="Attempted Suicide"){$color='1b2077';}if($incidenttypedata['name']=="Exploitation"){$color='DarkOrange';}if($incidenttypedata['name']=="Medical Emergency"){$color='MediumOrchid';}if($incidenttypedata['name']=="Individual Aggression toward Staff"){$color='YellowGreen';}
			 if($incidenttypedata['name']=="Seizure"){$color='Green';}if($incidenttypedata['name']=="Death"){$color='RosyBrown';}if($incidenttypedata['name']=="Right Code Violation"){$color='e71ea4';}if($incidenttypedata['name']=="Relocation"){$color='BlueViolet';}if($incidenttypedata['name']=="Other"){$color='LightSlateGray';}
			 if($incidenttypedata['name']=="Alleged Abuse"){$color='Aqua';}if($incidenttypedata['name']=="Alleged Neglect"){$color='DeepPink';}if($incidenttypedata['name']=="Medication Error"){$color='Plum';}if($incidenttypedata['name']=="Refusal"){$color='MediumSlateBlue';}if($incidenttypedata['name']=="Behavioral Incident"){$color='MediumSpringGreen';}
			 if($incidenttypedata['name']=="Missing Person"){$color='Teal';}if($incidenttypedata['name']=="Law Enforcement Involvement"){$color='Crimson';}if($incidenttypedata['name']=="Individual to Individual Aggression"){$color=' #6e2c00 ';}if($incidenttypedata['name']=="Misappropriation (Theft / Fraud)"){$color='3eab0b';}if($incidenttypedata['name']=="No Shows (Transportation Only)"){$color='Chocolate';}
			$data .= "<b><font color='$color'>".$incidenttypedata['y']." ".$incidenttypedata['name']." </font></b>| ";
			$sum += $incidenttypedata['y'];
		}

	     //~ $trenddata = $this->_trendheader($fdate,$todate);
	      echo json_encode(array('sum'=>$sum,'incidentdata'=>$data));
	      exit();
  }      

  public function getincidenttrendreportcommentAction(){
	 global $healthSesion;
		$fdate=$_REQUEST['fdate'];
		$todate=$_REQUEST['todate'];
		if($fdate != '' && $todate != ''){
			$fdate = date("Y-m-d", strtotime($fdate));
			$todate = date("Y-m-d", strtotime($todate));
		}else{ 
            $fdate = date('Y-m-01'); // hard-coded '01' for first day
            $todate  = date('Y-m-t');
	   } 
	    $commentData=$this->SuperModel->Super_Get("_uhs_incident_trend_report_comment","trend_comment_from='".$fdate."' and trend_comment_to='".$todate."'","fetch");
        if(!empty($commentData)){
		  echo json_encode(array('comment'=>$commentData['trend_report_comment']));
	      exit();
		}else{
			echo "0";
			exit();
		}
  }
  
    public function sendoutcomerecordemailAction(){
      
        if($this->getRequest()->isPost()){
            ini_set('memory_limit', '-1');
            ini_set('max_execution_time', 500);
            $data = $this->getRequest()->getPost();
            global $healthSession;
             $indid = $this->_getParam("indid");
            $formid = $this->_getParam("formid");
            $type = $this->_getParam("type");
            $this->dbObj = Zend_Registry::get('db');
            $subuser = $dstarts = $dends = $month = $year = "";
            $aColumns = array('record_id', 'indid', 'formid', 'oc_id', 'oc_description', 'oc_action_step', 'is_completed', 'outcome_comment','added_by','created_at','modified_at','modified_by','modified_on');
            $sIndexColumn = 'record_id';
            $sTable = '_uhs_record_outcome_form';
            $sLimit = "";
            $sOrder = "";
            $sWhere = "";

           
            $indParentUsers = "";
            if ($this->view->user->agency_user_type == "Agency") {
                $systemUsers = $this->SuperModel->Super_Get("_uhs_agency", "agency_user_agency_id=" . $this->view->user->agency_id, "fetchAll", array("fields" => "agency_id"));
                $systemUsers[count($systemUsers)]['agency_id'] = $this->view->user->agency_id;
                $indParentUsers = implode_r(",", $systemUsers);
            } else {
                $systemUsers = $this->SuperModel->Super_Get("_uhs_agency", "agency_user_agency_id=" . $this->view->user->agency_user_agency_id, "fetchAll", array("fields" => "agency_id"));
                $systemUsers[count($systemUsers)]['agency_id'] = $this->view->user->agency_id;
                $systemUsers[count($systemUsers)]['agency_id'] = $this->view->user->agency_user_agency_id;
                $indParentUsers = implode_r(",", $systemUsers);
                //$indParentUsers=$this->view->user->agency_id.",".$this->view->user->agency_user_agency_id;
            }
            if ($sWhere) {
                $sWhere .= " and added_by IN(" . $indParentUsers . ") and indid='" . $indid . "' and formid='" . $formid . "'";
            } else {
                $sWhere .= " where added_by IN(" . $indParentUsers . ") and indid='" . $indid . "' and formid='" . $formid . "'";
            }
             $sQuery = "SELECT SQL_CALC_FOUND_ROWS " . str_replace(" , ", " ", implode(", ", $aColumns)) . " FROM  $sTable $sWhere $sOrder $sLimit";
            $qry = $this->dbObj->query($sQuery)->fetchAll();
            $row=array();
            $ids="";
            if(!empty($qry)){
                foreach($qry as $row1){
                    $row[]= $row1[$sIndexColumn];
                }
                $ids=implode(",",$row);
            }
            $html="";
            $type="Record";
            $extra=array("month"=>"","year"=>"");
            $indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
            //prd($indData);
            $html.=$this->_record_log($indData, $ids, $formid, $type, $extra);
            require_once ROOT_PATH.'/private/mpdf/mpdf.php';
            $mpdf=new mPDF('utf-8', 'A2');
            ini_set("memory_limit","500M");
            $stylesheet = file_get_contents(APPLICATION_URL.'/public/plugins/bootstrap/css/bootstrap.css');
           // $stylesheet = file_get_contents(APPLICATION_URL.'/public/front_css/style_custom.css');
            $mpdf->SetTitle($this->view->site_configs['site_name'] . " | " . ucwords($indData['agency_first_name'] . " " . $indData['agency_last_name']) . " Forms");
            $mpdf->WriteHTML($stylesheet,1);
            $mpdf->WriteHTML($html,2);
            $mpdf->Output('/home/xoomia/public_html/public/pdf/outcome.pdf','F'); 
            //$mpdf->Output('/var/www/html/xoomialive/branches/public/pdf/outcome.pdf','F'); 

            $recipients = $data['receiver_emails'];
            $email_to = explode(',', $recipients);
            $count = count($email_to);
            $config=array('auth'=>'login','username'=>'rv_test@xoomia.com','password'=>'rvtech@123');
            $transport=new Zend_Mail_Transport_Smtp('xoomia.com',$config);  
            $Mc = 1;
            foreach ($email_to as $toemail) {
                if($Mc >= $count) 
                   {
                        $maildddd = str_replace(' ', '', $toemail);
                        $ReceiverName = str_replace(' ', '', $toemail);
                        $mail = new Zend_Mail();
                        $mail->setBodyHtml($data['email_msg']);
                        $mail->setFrom('client@xoomia.com', 'xoomia.com');
                        $mail->addTo($maildddd,$ReceiverName);
                        $mail->setSubject($data['email_subject']);
                        $content = file_get_contents("/home/xoomia/public_html/public/pdf/outcome.pdf"); 
                       // $content = file_get_contents("/var/www/html/xoomialive/branches/public/pdf/outcome.pdf"); 
                        $attachment = new Zend_Mime_Part($content);
                        $attachment->type = 'application/pdf';
                        $attachment->disposition = Zend_Mime::DISPOSITION_ATTACHMENT;
                        $attachment->encoding = Zend_Mime::ENCODING_BASE64;
                        $attachment->filename = 'outcome.pdf'; // name of file
                        $mail->addAttachment($attachment);                  
                        $transport->send($mail);
                        echo 'done';
                    }  
            $Mc++;
            }
            $healthSession->successMsg="Data has been email successfully";
            $this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"record_outcome_log_view");
            exit();
        }
        exit();
    }
    public function sleeppdfprintAction(){
            ini_set('memory_limit', '-1');
            ini_set('max_execution_time', 500);
            global $healthSession;
            $router = "sleep_pdf_print";
            $indid = $this->_getParam("indid");
            $formid = $this->_getParam("formid");
            $id = $this->_getParam("id");
            
            $sWhere="";
            $indParentUsers = "";
            if ($this->view->user->agency_user_type == "Agency") {
                $systemUsers = $this->SuperModel->Super_Get("_uhs_agency", "agency_user_agency_id=" . $this->view->user->agency_id, "fetchAll", array("fields" => "agency_id"));
                $systemUsers[count($systemUsers)]['agency_id'] = $this->view->user->agency_id;
                $indParentUsers = implode_r(",", $systemUsers);
            } else {
                $systemUsers = $this->SuperModel->Super_Get("_uhs_agency", "agency_user_agency_id=" . $this->view->user->agency_user_agency_id, "fetchAll", array("fields" => "agency_id"));
                $systemUsers[count($systemUsers)]['agency_id'] = $this->view->user->agency_id;
                $systemUsers[count($systemUsers)]['agency_id'] = $this->view->user->agency_user_agency_id;
                $indParentUsers = implode_r(",", $systemUsers);
                //$indParentUsers=$this->view->user->agency_id.",".$this->view->user->agency_user_agency_id;
            }
            if ($sWhere) {
                $sWhere .= " and created_by IN(" . $indParentUsers . ") and user_id='" . $indid . "'";
            } else {
                $sWhere .= " where created_by IN(" . $indParentUsers . ") and user_id='" . $indid . "'";
            }
            $this->dbObj = Zend_Registry::get('db');
            $testQuery = "SELECT * FROM _uhs_form_sleep $sWhere";
            $sleepData = $this->dbObj->query($testQuery)->fetchAll();
            $sleepinfo = array();
            $ids="";
            if(!empty($sleepData)){
                foreach ($sleepData as $sleep) {
                    $sleepinfo[] = $sleep['sleep_id'];
                }
                $ids=implode(",",$sleepinfo);
            }
            $indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
             
            $html="";
            $extra=array("month"=>"","year"=>"");
            $html.=$this->_sleep_log($indData,$ids,$formid,$extra);
           
                require_once ROOT_PATH.'/private/mpdf/mpdf.php';
                $mpdf=new mPDF('utf-8', 'A4-L');
                $stylesheet = file_get_contents(APPLICATION_URL.'/public/plugins/bootstrap/css/bootstrap.css');
                //$stylesheet = file_get_contents(APPLICATION_URL . '/public/front_css/style_custom.css');
                $mpdf->SetTitle('Sleep Logs');
                $mpdf->WriteHTML($stylesheet,1);
                $mpdf->WriteHTML($html,2);
                $mpdf->Output(); 
            
            exit();
    }
    public function sendsleeppdfmailAction(){
        if($this->getRequest()->isPost()){
            ini_set('memory_limit', '-1');
            ini_set('max_execution_time', 500);
            $data = $this->getRequest()->getPost();
            global $healthSession;
            $indid = $this->_getParam("indid");
            $formid = $this->_getParam("formid");
            $id = $this->_getParam("id");
            $sWhere="";
            $indParentUsers = "";
            if ($this->view->user->agency_user_type == "Agency") {
                $systemUsers = $this->SuperModel->Super_Get("_uhs_agency", "agency_user_agency_id=" . $this->view->user->agency_id, "fetchAll", array("fields" => "agency_id"));
                $systemUsers[count($systemUsers)]['agency_id'] = $this->view->user->agency_id;
                $indParentUsers = implode_r(",", $systemUsers);
            } else {
                $systemUsers = $this->SuperModel->Super_Get("_uhs_agency", "agency_user_agency_id=" . $this->view->user->agency_user_agency_id, "fetchAll", array("fields" => "agency_id"));
                $systemUsers[count($systemUsers)]['agency_id'] = $this->view->user->agency_id;
                $systemUsers[count($systemUsers)]['agency_id'] = $this->view->user->agency_user_agency_id;
                $indParentUsers = implode_r(",", $systemUsers);
                //$indParentUsers=$this->view->user->agency_id.",".$this->view->user->agency_user_agency_id;
            }
            if ($sWhere) {
                $sWhere .= " and created_by IN(" . $indParentUsers . ") and user_id='" . $indid . "'";
            } else {
                $sWhere .= " where created_by IN(" . $indParentUsers . ") and user_id='" . $indid . "'";
            }
            $this->dbObj = Zend_Registry::get('db');
            $testQuery = "SELECT * FROM _uhs_form_sleep $sWhere";
            $sleepData = $this->dbObj->query($testQuery)->fetchAll();
            $sleepinfo = array();
            $ids="";
            if(!empty($sleepData)){
                foreach ($sleepData as $sleep) {
                    $sleepinfo[] = $sleep['sleep_id'];
                }
                $ids=implode(",",$sleepinfo);
            }
            $indData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$indid,"fetch");
            
            $html="";
            $extra=array("month"=>"","year"=>"");
            $html.=$this->_sleep_log($indData,$ids,$formid,$extra);
             
            require_once ROOT_PATH.'/private/mpdf/mpdf.php';
            $mpdf=new mPDF('utf-8', 'A2');
            ini_set("memory_limit","500M");
            $stylesheet = file_get_contents(APPLICATION_URL.'/public/plugins/bootstrap/css/bootstrap.css');
           // $stylesheet = file_get_contents(APPLICATION_URL.'/public/front_css/style_custom.css');
            $mpdf->SetTitle($this->view->site_configs['site_name'] . " | " . ucwords($indData['agency_first_name'] . " " . $indData['agency_last_name']) . " Forms");
            $mpdf->WriteHTML($stylesheet,1);
            $mpdf->WriteHTML($html,2);
            $mpdf->Output('/home/xoomia/public_html/public/pdf/sleep.pdf','F'); 
            //$mpdf->Output('/var/www/html/xoomialive/branches/public/pdf/sleep.pdf','F'); 

            $recipients = $data['receiver_emails'];
            $email_to = explode(',', $recipients);
            $count = count($email_to);
            $config=array('auth'=>'login','username'=>'rv_test@xoomia.com','password'=>'rvtech@123');
            $transport=new Zend_Mail_Transport_Smtp('xoomia.com',$config);  
            $Mc = 1;
            foreach ($email_to as $toemail) {
                if($Mc >= $count) 
                   {
                        $maildddd = str_replace(' ', '', $toemail);
                        $ReceiverName = str_replace(' ', '', $toemail);
                        $mail = new Zend_Mail();
                        $mail->setBodyHtml($data['email_msg']);
                        $mail->setFrom('client@xoomia.com', 'xoomia.com');
                        $mail->addTo($maildddd,$ReceiverName);
                        $mail->setSubject($data['email_subject']);
                        $content = file_get_contents("/home/xoomia/public_html/public/pdf/sleep.pdf"); 
                        //$content = file_get_contents("/var/www/html/xoomialive/branches/public/pdf/sleep.pdf"); 
                        $attachment = new Zend_Mime_Part($content);
                        $attachment->type = 'application/pdf';
                        $attachment->disposition = Zend_Mime::DISPOSITION_ATTACHMENT;
                        $attachment->encoding = Zend_Mime::ENCODING_BASE64;
                        $attachment->filename = 'sleep.pdf'; // name of file
                        $mail->addAttachment($attachment);                  
                        $transport->send($mail);
                        echo 'done';
                    }  
            $Mc++;
            }
            $healthSession->successMsg="Data has been email successfully";
            $this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"add_sleep");
            exit();
        }
        exit();
    }
    
           public function viewalldadAction(){	

            global $healthSession; 
            $this->view->pageHeading = "Group Activity Documentation  Logs";
//            $indid=$this->_getParam("indid");
//            $formid=$this->_getParam("formid");
//            $id=$this->_getParam("id");
//            if(empty($indid)){
//                    $healthSession->errorMsg="Invalid Access";
//                    $this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
//            }
//            $permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
//            $this->view->permissions=$permissions;
//            $this->view->indid=$indid;
//            $this->view->formid=$formid;
//            $this->view->id=$id;
                
  	}
	
	public function getalldadAction(){
            if(check_is_ajax($this->_request)){
                    $this->_redirect(APPLICATION_URL);
            }
//            $indid=$this->_getParam("indid");
//            $formid=$this->_getParam("formid");
//            $id=$this->_getParam("id");
            $subuser=$dstarts=$dends="";
            if(isset($_REQUEST['subuser']) && !empty($_REQUEST['subuser'])){
                    $subuser=$_REQUEST['subuser'];
            }
            if(isset($_REQUEST['county']) && !empty($_REQUEST['county'])){
			$county=$_REQUEST['county'];
		    }
            if(isset($_REQUEST['dstarts']) && !empty($_REQUEST['dstarts'])){
                    $dstarts=$_REQUEST['dstarts'];
            }
            if(isset($_REQUEST['dends']) && !empty($_REQUEST['dends'])){
                    $dends=$_REQUEST['dends'];
            }
            if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
                    $month=$_REQUEST['month'];
            }
            if(isset($_REQUEST['year']) && !empty($_REQUEST['year'])){
                    $year=$_REQUEST['year'];
            }
            $this->dbObj = Zend_Registry::get('db');
            $aColumns = array('dad_id','dad_form_id','dad_group_code','dad_individual_id','dad_modified_by','dad_added_date','dad_da_id','dad_service_date','dad_location_service','dad_added_user','dad_start_time','dad_end_time','dad_staff','dad_group_size','dad_participant','dad_comment','dad_modified_by','dad_modified_on','dad_total_service_time');
            $sIndexColumn = 'dad_id';
            $sTable = '_uhs_dad';
            $sLimit = "";
            if(isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength']!='-1'){
                    $sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
            }
            $sOrder = "";
            if ( isset( $_GET['iSortCol_0'] ) ){
                    $sOrder = "ORDER BY  ";
                    for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
                    {
                            if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
                            {
                                    $sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
                                            ($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
                            }
                    }

                    $sOrder = substr_replace( $sOrder, "", -2 );
                    if ( $sOrder == "ORDER BY" ){
                            $sOrder = "";
                    }
            }
            $sWhere = "";
            if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
                    $sWhere = "WHERE (";
                    for ( $i=0 ; $i<count($aColumns) ; $i++ )
                    {
                            $sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
                    }
                    $sWhere = substr_replace( $sWhere, "", -3 );
                    $sWhere .= ')';
            }
            for ( $i=0 ; $i<count($aColumns) ; $i++ )
            {
                    if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
                    {
                            if ( $sWhere == "" )
                            {
                                    $sWhere = "WHERE ";
                            }
                            else
                            {
                                    $sWhere .= " AND ";
                            }
                            $sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
                    }
            }
            if(empty($subuser)){
                    $indParentUsers="";
                    if($this->view->user->agency_user_type=="Agency"){
                            $systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_id,"fetchAll",array("fields"=>"agency_id"));
                            $systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
                            $indParentUsers=implode_r(",",$systemUsers);

                    }
                    else{
                            $systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_user_agency_id,"fetchAll",array("fields"=>"agency_id"));
                            $systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
                            $systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_user_agency_id;
                            $indParentUsers=implode_r(",",$systemUsers);
                            //$indParentUsers=$this->view->user->agency_id.",".$this->view->user->agency_user_agency_id;
                    }
                    if($sWhere){
                                $sWhere.=" and dad_added_user IN(".$indParentUsers.")"; 
                            }
                            else{
                                    $sWhere.=" where dad_added_user IN(".$indParentUsers.")"; 
                            }

            }
            else{
                if($sWhere){
                        $sWhere.=" and dad_added_user IN(".$subuser.")"; 
                }
                else{
                        $sWhere.=" where dad_added_user IN(".$subuser.")"; 
                }
            }
            if(!empty($dstarts)){
                    $sWhere.=" and DATE(dad_added_date) >='".$dstarts."'";
            }
            if(!empty($dends)){
                    $sWhere.=" and DATE(dad_added_date) <='".$dends."'";
            }
            if(!empty($month)){
                    $sWhere.=" and MONTH(dad_added_date)='".$month."'";
            }
            if(!empty($year)){
                    $sWhere.=" and YEAR(dad_added_date)='".$year."'";
            }
//		if(!empty($id) && $id!=0){
//			$sWhere.=" and dad_id=".$id;
         $indUsers="";
         if(!empty($county)){
			$systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_county='".$county."'","fetchAll",array("fields"=>"agency_id"));
			if(count($systemUsers) > 0){
				$indUsers=implode_r(",",$systemUsers);			
				$sWhere.=" and dad_individual_id IN(".$indUsers.")"; 
			}else{
				$sWhere.=" and dad_individual_id IN(0)";
			}
		 }
//		}
            if(empty($month) && empty($year) && empty($dstarts) && empty($dends)){
                if(!empty($sWhere)){
                    $sWhere.=" and MONTH(dad_added_date)=MONTH(CURDATE()) and YEAR(dad_added_date)=YEAR(CURDATE()) group by dad_group_code";
                }else{
                    $sWhere.=" where MONTH(dad_added_date)=MONTH(CURDATE()) and YEAR(dad_added_date)=YEAR(CURDATE()) group by dad_group_code";
                }
            } else {
                if($sWhere){
                            $sWhere.=" group by dad_group_code"; 
                }
                else{
                        $sWhere.=" where group by dad_group_code"; 
                }
            }

            $sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";

            $qry = $this->dbObj->query($sQuery)->fetchAll();
            $sQuery = "SELECT FOUND_ROWS() as fcnt";
            $aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
            $iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
            $sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
            $rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
            $iTotal = $rResultTotal[0]['cnt'];
            $output = array(
                            "iTotalRecords" => $iTotal,
                            "iTotalDisplayRecords" => $iFilteredTotal,
                            "aaData" => array()
                    );
            $j=0;
            foreach($qry as $row1){
                    $creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$row1['dad_added_user']);
                    $dailyActivityData=$this->SuperModel->Super_Get("_uhs_daily_activity","da_id=".$row1['dad_da_id'],"fetch");
                    $modifierData=array();
                    if($row1['dad_modified_by']!=0){
                            $modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$row1['dad_modified_by']);
                    }
                    $row=array();
                    $row[] = $j+1;
                    $row[]='<input class="elem_ids checkboxes" type="checkbox" name="'.$sTable.'['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';
                    $row[]=formatDate($row1['dad_service_date']);
                    $row[]=$row1['dad_location_service'];
                    $row[]=$dailyActivityData['da_activity'];
                    

                    $row[]=$row1['dad_start_time'];
                    $row[]=$row1['dad_end_time'];

                    if(!empty($row1['dad_total_service_time'])){
                        $row[]=$row1['dad_total_service_time'];
                    }else{
                        $row[]="-";
                    }

                    

                    $userType=printUserType($creatorData);
                    $row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
                    $your_date = date("m/d/Y H:i:s", strtotime($row1['dad_added_date'])); 
                    $row[]=$your_date;
                    $row[]=$row1['dad_comment'];
                    $participantData="";
                    $flag = 0;
                    if(!empty($row1['dad_participant'])){
                        $implode = explode(",",$row1['dad_participant']);

                        for($i = 0; $i < count($implode); $i++){
                            if($flag > 0){
                                $addComma = " , ";
                            }
                            else{
                                $addComma = "";
                            };
                            $indidData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$implode[$i]);
                            $participantData .=$addComma.ucwords($indidData['agency_first_name']." ".$indidData['agency_last_name']);

                            $flag++;
                        }
                    }
                    $row[]=$participantData;
                    $row[]=$dailyActivityData['da_frequency'];
                    $row[]=$row1['dad_staff']." : ".$row1['dad_group_size'];
                    if(!empty($modifierData)){
                            $userType=printUserType($modifierData);
                            $row[]=ucwords($modifierData['agency_first_name']." ".$modifierData['agency_last_name'])."&nbsp;".$userType;
                            $row[]=$row1['dad_modified_on'];
                    }
                    else{
                            $row[]="-";
                            $row[]="-";

                    }
                    if($this->view->user->agency_user_type=="Agency"){
                    if(date("m")==date("m",strtotime($row1['dad_added_date']))){
                            //$row[]="<a style='margin-top:5px;' href='javascript:void(1);' onClick=showDiffrentForms(".$indid.",".$formid.",".$row1[$sIndexColumn].",'AssignedMileage') class='btn btn-xs btn-default'>Edit</a>";
                            $url = APPLICATION_URL."/edit-dad/".$row1[$sIndexColumn];
                            $row[]="<a style='margin-top:5px;' href='".$url."' class='btn btn-xs btn-default'>Edit</a>";
                    }else{
                            $row[]="<b>NA</b>";
                    }
                    }else{
                            $row[]="<b>NA</b>";
                    }
                    $output['aaData'][] = $row;
                    $j++;
            }
            echo json_encode($output);
            exit();
	}
        
         private function _dad_all_log($ids,$formid,$extra=array()){
			
            global $months;
			$userCond="";
			if($this->view->user->agency_user_type!="Agency"){ $userCond="dad_agency_id='".$this->view->user->agency_user_agency_id."'";} else{
                            $userCond="dad_agency_id='".$this->view->user->agency_id."'";
                        }
			
                        //$dadData=$this->SuperModel->Super_Get("_uhs_dad","".$userCond." and MONTH(dad_added_date)=".$extra['month']." and YEAR(dad_added_date)='".$extra['year']."'","fetchAll");
                        $dadData=$this->SuperModel->Super_Get("_uhs_dad","".$userCond."","fetchAll",array("group"=>"dad_group_code","order"=>"dad_id desc"));	
			$number = date('t');
			$totalColspan=$number+1;
			$headingText=$html="";
			$headingText="Group Activity Documentation";
			$tdWid=round(90/$number,2);
			$html="";
			if(count($dadData)>0){
				//$html.= $this->_report_header($headingText,$indData);
                            
                //$html.="<div style='text-align:center'><h5><b>Daily Activity Documentation Logs</b></h5></div>";
                $html .= '<table style= "width:100%">
					<tr>
						<td> 
							<div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
								<h4 class="magin0">Company Information</h4><br>
								<p><b>Company:</b>'. ucwords($this->view->user->agency_company_name).'</p>
								
								<p><b>Provider No:</b>'. $this->view->user->agency_provider_number.'</p>
								
								<p><b>Name:</b>'. ucwords($this->view->user->agency_first_name. '  ' . $this->view->user->agency_last_name).'</p>
								
								<p><b>Address:</b>'. ucwords($this->view->user->agency_address1 .', '. $this->view->user->agency_city.', '. $this->view->user->agency_state.', '. $this->view->user->agency_zip).'</p>
								
								<p><b>ContactContact:</b>'. $this->view->user->agency_contact.'</p>
							</div>
						</td>
					</tr>
				</table>	
							<br/>';
		       
            $html.="<div class='text-right'>Date:".date("m/d/Y H:i:s",time())."</div><div class='alert alert-info text-center'><h3><b>Group Activity Documentation Logs</b></h3></div>";
				$html.="<table width='130%'>";
				for($i=0;$i<count($dadData);$i++){

					$dad_participant="";
					$flag = 0;
					if(!empty($dadData[$i]['dad_participant'])){
					   $implode = explode(",",$dadData[$i]['dad_participant']);
					   for($j = 0; $j < count($implode); $j++){
						   if($flag > 0){
							   $addComma = " , ";
							}
							else{
							   $addComma = "";
							};
							$indid_Data=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$implode[$j]."'","fetch");
																		   
							   $dad_participant .=$addComma.ucwords($indid_Data['agency_first_name']." ".$indid_Data['agency_last_name']);
							   $flag++;
							
							
					  }
					}else{
						$indidData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$dadData[$i]['dad_individual_id']);
						$dad_participant =ucwords($indidData['agency_first_name']." ".$indidData['agency_last_name']);
					}

                                    
					$dadcreatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$dadData[$i]['dad_added_user']."'","fetch");
					$dadcreatername = $dadcreatorData['agency_first_name']." ".$dadcreatorData['agency_last_name'];
					$daData=$this->SuperModel->Super_Get("_uhs_daily_activity","da_id='".$dadData[$i]['dad_da_id']."'","fetch");
					$ration = $dadData[$i]['dad_staff']." : ".$dadData[$i]['dad_group_size'];
					
                                       
                                        
                                        $html.="<tr><td style='font-size: 25px;'>".($i+1)." ".$daData['da_frequency']."</td></tr>";
					$html.="<tr>
					            <td style='font-size: 25px;' width='30%'><b>Support Frequency: </b><BR>".$daData['da_frequency']."</td>
					            <td style='font-size: 25px;' width='30%'><b>Date of service: </b><BR>".formatDateTime($dadData[$i]['dad_service_date'])."</td>
					            <td style='font-size: 25px;' width='30%'><b>Location of service: </b><BR>".$dadData[$i]['dad_location_service']."</td>
					            <td style='font-size: 25px;' width='20%'><b>Activity: </b><BR>".$daData['da_activity']."</td>
					            <td style='font-size: 25px;' width='20%'><b>Start Time: </b><BR>".$dadData[$i]['dad_start_time']."</td>
					            
					            
					            <td style='font-size: 25px;' width='22%'><b>Recorded By: </b><BR>".$dadcreatername."|".$dadData['agency_user_type']."</td>
					            <td style='font-size: 25px;' width='22%'><b>Recorded On: </b><BR>".formatDateTime($dadData[$i]['dad_added_date'])."</td>
					        </tr>";
					  $html.="<tr>
                                                    <td style='font-size: 25px;'><b>Comment: </b><BR>".$dadData[$i]['dad_comment']."</td>
                                                        <td style='font-size: 25px;'><b>End Time: </b><BR>".$dadData[$i]['dad_end_time']."</td>
                                                    <td style='font-size: 25px;'><b>Total Time: </b><BR>".$dadData[$i]['dad_total_service_time']."</td>
					            
					            <td style='font-size: 25px;'><b>Staff: </b><BR>".$dadData[$i]['dad_staff']."</td>
					            <td style='font-size: 25px;'><b>Group Size: </b><BR>".$dadData[$i]['dad_group_size']."</td>
					            <td></td>
					        </tr>
                                                <tr>
                                                    <td colspan=8 style='font-size: 25px;padding:0.3%;border:0px;'><b>Individual : &nbsp;&nbsp;</b>".$dad_participant."</td>
                                                <tr>
                                            <tr><td width='140%' style='height:30px;border-bottom:1px solid black;' colspan='8'></td></tr>
                                            <tr><td width='140%' style='height:30px;' colspan='8'></td></tr>";
				}                               
				$html.="</table>";
                if($idall=="All"){
					$html.="<pagebreak />";
				}
			}else{
			$html.= "";
		}
		return $html;
	}
        
        // Diffrent Reports
	public function dadreportsAction(){
		global $healthSession;
		$router=$pdfTitle="";
                $formid =22;
		$router="front_view_all_dad";
		$ids="All";
                // Daily Activity Documentation  Logs
                $extra=array();
                $html.=$this->_dad_all_log($ids,$formid,$extra);
                $pdfTitle=$this->view->site_configs['site_name']." | Daily Activity Documentation  Logs";
                $router="front_view_all_dad";


                if(!empty($html)){
                    require_once ROOT_PATH.'/private/mpdf/mpdf.php';
                    $mpdf=new mPDF('utf-8', 'A4-L');
                    $stylesheet = file_get_contents(APPLICATION_URL.'/public/plugins/bootstrap/css/bootstrap.css');
                    $mpdf->SetTitle($pdfTitle);
                    $mpdf->WriteHTML($stylesheet,1);
                    $mpdf->WriteHTML($html,2);
                    $mpdf->Output();
                    exit();
                }
                else{
                    $healthSession->errorMsg="No logs found.";
                    $this->_helper->getHelper("Redirector")->gotoRoute(array(),$router);
                }
		
	}
	
	   //05 July 18       
    public function dailyactivityreportAction(){
		$formData = $this->getRequest()->getPost();
		$router = 'front_view_all_dad';
		if(!empty($formData['_uhs_dad'])){
		   $ids=implode(",",$formData['_uhs_dad']);
	    }else{
		   $ids="All";
		}
		ini_set('memory_limit','256M');
        ini_set('max_execution_time', 300);
		
		$userCond="";
		if($this->view->user->agency_user_type!="Agency"){ 
			$userCond="dad_agency_id='".$this->view->user->agency_user_agency_id."'";
		} else{
            $userCond="dad_agency_id='".$this->view->user->agency_id."'";
        }	
        //$dadData=$this->SuperModel->Super_Get("_uhs_dad","".$userCond." and MONTH(dad_added_date)=".$extra['month']." and YEAR(dad_added_date)='".$extra['year']."'","fetchAll");
        if($ids !="All"){
            $dadData=$this->SuperModel->Super_Get("_uhs_dad","dad_id IN(".$ids.")","fetchAll",array("group"=> "dad_group_code","order"=>"dad_id desc"));	
        } 
        //~ else {
            //~ $dadData=$this->SuperModel->Super_Get("_uhs_dad","".$userCond."","fetchAll",array("group"=>"dad_group_code","order"=>"dad_id desc"));	
        //~ }

			$number = date('t');
			$totalColspan=$number+1;
			$headingText=$html="";
			$headingText="Daily Activity Documentation";
			$tdWid=round(90/$number,2);
			$html="";
			if(count($dadData)>0){
				//$html.= $this->_report_header($headingText,$indData);
                            
                //$html.="<div style='text-align:center'><h5><b>Daily Activity Documentation Logs</b></h5></div>";
                $html .= '<table style= "width:100%">
					<tr>
						<td> 
							<div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
								<h4 class="magin0">Company Information</h4><br>
								<p><b>Company:</b>'. ucwords($this->view->user->agency_company_name).'</p>
								
								<p><b>Provider No:</b>'. $this->view->user->agency_provider_number.'</p>
								
								<p><b>Name:</b>'. ucwords($this->view->user->agency_first_name. '  ' . $this->view->user->agency_last_name).'</p>
								
								<p><b>Address:</b>'. ucwords($this->view->user->agency_address1 .', '. $this->view->user->agency_city.', '. $this->view->user->agency_state.', '. $this->view->user->agency_zip).'</p>
								
								<p><b>ContactContact:</b>'. $this->view->user->agency_contact.'</p>
							</div>
						</td>
					</tr>
				</table>	
							<br/>';
		       
            $html.="<div class='text-right'>Date:".date("m/d/Y H:i:s",time())."</div><div class='alert alert-info text-center'><h3><b>Group Activity Documentation Logs</b></h3></div>";
				$html.="<table width='130%'>";
				for($i=0;$i<count($dadData);$i++){
					$dad_participant="";
					$flag = 0;
					if(!empty($dadData[$i]['dad_participant'])){
					   $implode = explode(",",$dadData[$i]['dad_participant']);
					   for($j = 0; $j < count($implode); $j++){
						   if($flag > 0){
							   $addComma = " , ";
							}
							else{
							   $addComma = "";
							};
							   $indid_Data=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$implode[$j]."'","fetch");
																		   
							   $dad_participant .=$addComma.ucwords($indid_Data['agency_first_name']." ".$indid_Data['agency_last_name']);
							   $flag++;
							
							
					  }
					}else{
						$indidData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$dadData[$i]['dad_individual_id']);
						$dad_participant =ucwords($indidData['agency_first_name']." ".$indidData['agency_last_name']);
					}
                                    
					$dadcreatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$dadData[$i]['dad_added_user']."'","fetch");
					$dadcreatername = $dadcreatorData['agency_first_name']." ".$dadcreatorData['agency_last_name'];
					$daData=$this->SuperModel->Super_Get("_uhs_daily_activity","da_id='".$dadData[$i]['dad_da_id']."'","fetch");
					$ration = $dadData[$i]['dad_staff']." : ".$dadData[$i]['dad_group_size'];
					
                                       
                                        
                                        $html.="<tr><td style='font-size: 25px;'>".($i+1)." ".$daData['da_frequency']."</td></tr>";
					$html.="<tr>
					            <td style='font-size: 25px;' width='30%'><b>Support Frequency: </b><BR>".$daData['da_frequency']."</td>
					            <td style='font-size: 25px;' width='30%'><b>Date of service: </b><BR>".formatDateTime($dadData[$i]['dad_service_date'])."</td>
					            <td style='font-size: 25px;' width='30%'><b>Location of service: </b><BR>".$dadData[$i]['dad_location_service']."</td>
					            <td style='font-size: 25px;' width='20%'><b>Activity: </b><BR>".$daData['da_activity']."</td>
					            <td style='font-size: 25px;' width='20%'><b>Start Time: </b><BR>".$dadData[$i]['dad_start_time']."</td>
					            
					            
					            <td style='font-size: 25px;' width='22%'><b>Recorded By: </b><BR>".$dadcreatername."|".$dadData['agency_user_type']."</td>
					            <td style='font-size: 25px;' width='22%'><b>Recorded On: </b><BR>".formatDateTime($dadData[$i]['dad_added_date'])."</td>
					        </tr>";
					  $html.="<tr>
                                                    <td style='font-size: 25px;'><b>Comment: </b><BR>".$dadData[$i]['dad_comment']."</td>
                                                        <td style='font-size: 25px;'><b>End Time: </b><BR>".$dadData[$i]['dad_end_time']."</td>
                                                    <td style='font-size: 25px;'><b>Total Time: </b><BR>".$dadData[$i]['dad_total_service_time']."</td>
					            
					            <td style='font-size: 25px;'><b>Staff: </b><BR>".$dadData[$i]['dad_staff']."</td>
					            <td style='font-size: 25px;'><b>Group Size: </b><BR>".$dadData[$i]['dad_group_size']."</td>
					            <td></td>
					        </tr>
                                                <tr>
                                                    <td colspan=8 style='font-size: 25px;padding:0.3%;border:0px;'><b>Individual : &nbsp;&nbsp;</b>".$dad_participant."</td>
                                                <tr>
                                            <tr><td width='140%' style='height:30px;border-bottom:1px solid black;' colspan='8'></td></tr>
                                            <tr><td width='140%' style='height:30px;' colspan='8'></td></tr>";
				}                               
				$html.="</table>";
		       
	
		if(!empty($html)){
			ini_set('max_execution_time', 300);
			ini_set("memory_limit","500M");
			require_once ROOT_PATH.'/private/mpdf/mpdf.php';
			$mpdf=new mPDF('utf-8', 'A4-L');
			$stylesheet = file_get_contents(APPLICATION_URL.'/public/plugins/bootstrap/css/bootstrap.css');
			$mpdf->SetTitle($pdfTitle);
			$mpdf->WriteHTML($stylesheet,1);
			$mpdf->WriteHTML($html,2);
			$mpdf->Output();
			exit();
		}else{
			$healthSession->errorMsg="No logs found.";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),$router);
		}
	}else{
			$html.= "<h4><center><strong><i> No DATA FOUND </strong></i></center></h4>";
		}
	}
        
        //9_july nmt
  
        public function vehicleinspectionreportsAction(){
                global $healthSession;
		$router=$pdfTitle="";
		$router="front_view_car_inspection";
                $formData = $this->getRequest()->getPost();
                $userCond="";
		$html="";
		if($this->view->user->agency_user_type!="Agency"){ 
			$userCond="ci_added_by='".$this->view->user->agency_id."'";
		}else{
			$userCond="ci_agency_id='".$this->view->user->agency_id."'";
		}
                if(!empty($formData['records'])){
                    $ids=implode(",",$formData['records']);
                    $datas=$this->SuperModel->Super_Get("_uhs_car_inspection","ci_id IN(".$ids.")","fetchAll",array("order"=>"ci_id desc"));
                }
                else{
                    $datas=$this->SuperModel->Super_Get("_uhs_car_inspection","".$userCond."","fetchAll",array("order"=>"ci_id desc"));	
                }
                //prd($datas);
                if(count($datas)>0){
		   $html .= '<table style= "width:100%">
					<tr>
						<td> 
							<div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
								<h4 class="magin0">Company Information</h4><br>
								<p><b>Company:</b>'. ucwords($this->view->user->agency_company_name).'</p>
								
								<p><b>Provider No:</b>'. $this->view->user->agency_provider_number.'</p>
								
								<p><b>Name:</b>'. ucwords($this->view->user->agency_first_name. '  ' . $this->view->user->agency_last_name).'</p>
								
								<p><b>Address:</b>'. ucwords($this->view->user->agency_address1 .', '. $this->view->user->agency_city.', '. $this->view->user->agency_state.', '. $this->view->user->agency_zip).'</p>
								
								<p><b>ContactContact:</b>'. $this->view->user->agency_contact.'</p>
							</div>
						</td>
					</tr>
				</table>	
							<br/>';
		       
                        $html.="<div class='text-right'>Date:".date("m/d/Y H:i:s",time())."</div><div class='alert alert-info text-center'><h3><b>Vehicle Inspection Reports</b></h3></div>";
            		

			$html.="<table class='table table-bordered' cellspacing='10' cellpadding='20' width='130%'>
					<tr>
						<th style='padding:0.3%;' width='16.6%'>Date Of Inspection</th>
						<th style='padding:0.3%;' width='16.6%'>Inspection Id</th>
						<th style='padding:0.3%;' width='16.6%'>Licence Plate #</th>
						<th style='padding:0.3%;' width='16.6%'>Vehicle Identification Number</th>
						<th style='padding:0.3%;' width='16.6%'>Created By</th>
						<th style='padding:0.3%;' width='16.6%'>Created On</th>
				   </tr>";
				  
			foreach($datas as $data){
				$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$data['ci_added_by']);
				$myVehicleData=$this->SuperModel->Super_Get("_uhs_vehicle","ve_id=".$data['ci_license_plate_number']);
				$html.="<tr>
							<td style='padding:0.3%;'>".formatDate($data['ci_inspection_date'])."</td>
							<td style='padding:0.3%;'>".$data['ci_code']."</td>
							<<td style='padding:0.3%;'>".$myVehicleData['ve_licence_plate_number']."</td>
							<td style='padding:0.3%;'>".$myVehicleData['ve_vin_number']."</td>
							<td style='padding:0.3%;'>".ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."</td>
							<td style='padding:0.3%;'>".formatDateTimeNew($data['ci_added_date'])."</td>
				  	  </tr>";

				$html.="<tr><td colspan=6>
                                    <span>Secure storage space: ";
                                    if($data['ci_secure_storage_space']){
                                       $html.="<strong>Clear</strong>";
                                    } else {
                                       $html.="<strong>Not clear</strong>";
                                    }
                                    				  	  
                                    $html.="</span>&nbsp;&nbsp;&nbsp;";
                                    $html.="<span>  Two-Way Communication: ";
                                    if($data['ci_communication']){
                                        $html.="<strong>Working</strong>";
                                    }else{
                                        $html.="<strong>Not working</strong>";
                                    }
                                    $html.="</span>&nbsp;&nbsp;&nbsp;";
                                    $html.="<span> Lights: ";
                                    if($data['ci_lights']){
                                         $html.="<strong>Yes</strong>";
                                    }else{
                                        $html.="<strong>No</strong>";
                                    }
                                    $html.="</span>&nbsp;&nbsp;&nbsp;";
                                    $html.="<span> Windshield washer/wipers: ";
                                    if($data['ci_windshield_washer_wipers']){
                                        $html.="<strong>Yes</strong>";
                                    }else{
                                        $html.="<strong>No</strong>";
                                    }
                                    $html.="</span>&nbsp;&nbsp;&nbsp;";
                                    $html.="<span> Emergency equipment: ";
                                    if($data['ci_emergency_equipment']){
                                        $html.="<strong>Secured</strong>";
                                    }else{
                                        $html.="<strong>Not secured</strong>";
                                    }
                                    $html.="</span>&nbsp;&nbsp;&nbsp;";
                                    $html.="<span> Mirrors: ";
                                    if($data['ci_mirrors']){
                                         $html.="<strong>Yes</strong>";
                                    }else{
                                        $row[]="No";
                                        $html.="<strong>No</strong>";
                                    }
                                    $html.="</span>&nbsp;&nbsp;&nbsp;";
                                    $html.="<span> Horn: ";
                                    if($data['ci_horn']){
                                         $html.="<strong>Yes</strong>";
                                    }else{
                                        $html.="<strong>No</strong>";
                                    }
                                    $html.="</span>&nbsp;&nbsp;&nbsp;";
                                    $html.="<span> Tires: ";
                                    if($data['ci_tires']){
                                         $html.="<strong>Yes</strong>";
                                    }else{
                                        $html.="<strong>No</strong>";
                                    }
                                    $html.="</span>&nbsp;&nbsp;&nbsp;";
                                    $html.="<span> Brakes: ";
                                     if($data['ci_brakes']){
                                         $html.="<strong>Yes</strong>";
                                    }else{
                                        $html.="<strong>No</strong>";
                                    }
                                    $html.="</span>&nbsp;&nbsp;&nbsp;";
                                    $html.="<span> Seat belt: ";
                                     if($data['ci_seat_belt']){
                                         $html.="<strong>Yes</strong>";
                                    }else{
                                        $html.="<strong>No</strong>";
                                    }
                                    $html.="</span>&nbsp;&nbsp;&nbsp;";
                                    $html.="<span> Wheelchair fasteners: ";
                                    if($data['ci_wheelchair_fasteners']){
                                         $html.="<strong>Working</strong>";
                                    }else{
                                       $html.="<strong>Not working</strong>";
                                    }
                                    $html.="</span>&nbsp;&nbsp;&nbsp;";
                                    $html.="<span> Restraints: ";
                                    if($data['ci_restraints']){
                                        $html.="<strong>Yes</strong>";
                                    }else{
                                        $html.="<strong>No</strong>";
                                    }
                                    $html.="</span>&nbsp;&nbsp;&nbsp;";
                                    $html.="<span> Fire extinguisher and an emergency first-aid kit that are safely secured: ";
                                    if($data['ci_fire_extinguisher']){
                                         $html.="<strong>Yes</strong>";
                                    }else{
                                        $html.="<strong>No</strong>";
                                    }
                                    $html.="</span>&nbsp;&nbsp;&nbsp;";
                                    $html.="<span> Access ramp or hydraulic lift: ";
                                    if($data['ci_ramp_hydraulic_lift']){
                                        $html.="<strong>working</strong>";
                                    }else{
                                         $html.="<strong>Not working</strong>";
                                    }
                                    $html.="</span>&nbsp;&nbsp;&nbsp;";
                                    $html.="</td></tr><tr><td colspan='6'>&nbsp;</td></tr>";	
                                    
                                   
			}
			$html.="</table>";
			
		}else{
			$html.= "<h4><center><strong><i> No DATA FOUND </strong></i></center></h4>";
		}
		$pdfTitle=$this->view->site_configs['site_name']." | Vehicle Inspection Reports";
		$router="front_view_car_inspection";


		if(!empty($html)){
			require_once ROOT_PATH.'/private/mpdf/mpdf.php';
			ini_set('max_execution_time', 300);
                        ini_set("memory_limit","500M");
			$mpdf=new mPDF('utf-8', 'A4-L');
			$stylesheet = file_get_contents(APPLICATION_URL.'/public/plugins/bootstrap/css/bootstrap.css');
			$mpdf->SetTitle($pdfTitle);
			$mpdf->WriteHTML($stylesheet,1);
			$mpdf->WriteHTML($html,2);
			$mpdf->Output();
			exit();
		}
		else{
			$healthSession->errorMsg="No logs found.";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),$router);
		}
		
	}
        
        
        
        
    private function _rat_all_log($ids,$formid,$extra=array()){
                ini_set('memory_limit','256M');
                ini_set('max_execution_time', 300);
		global $months;
                $userCond="";
                if($this->view->user->agency_user_type!="Agency"){ $userCond="trip_agency_id='".$this->view->user->agency_user_agency_id."'";} else{
                    $userCond="trip_agency_id='".$this->view->user->agency_id."'";
                }
                if($ids !="All"){
                    $data=$this->SuperModel->Super_Get("_uhs_record_a_trip","trip_id IN(".$ids.")","fetchAll",array("group"=> "trip_group_code","order"=>"trip_id desc"));	
                } else {
                    $data=$this->SuperModel->Super_Get("_uhs_record_a_trip","".$userCond."","fetchAll",array("group"=>"trip_group_code","order"=>"trip_id desc"));	
                }
                $html="";
		if(count($data)>0){
			//$html.= $this->_report_header("Record A trip",$indData);
			// $html="<div class='text-right'>Date:".date("m/d/Y H:i:s",time())."</div>";
			// $html.="<div class='alert alert-info text-center'><h3>Mileage Log</h3>
			 $html .= '<table style= "width:100%">
					<tr>
						<td> 
							<div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
								<h4 class="magin0">Company Information</h4><br>
								<p><b>Company:</b>'. ucwords($this->view->user->agency_company_name).'</p>
								
								<p><b>Provider No:</b>'. $this->view->user->agency_provider_number.'</p>
								
								<p><b>Name:</b>'. ucwords($this->view->user->agency_first_name. '  ' . $this->view->user->agency_last_name).'</p>
								
								<p><b>Address:</b>'. ucwords($this->view->user->agency_address1 .', '. $this->view->user->agency_city.', '. $this->view->user->agency_state.', '. $this->view->user->agency_zip).'</p>
								
								<p><b>ContactContact:</b>'. $this->view->user->agency_contact.'</p>
							</div>
						</td>
					</tr>
				</table>	
							<br/>';
		       
            $html.="<div class='text-right'>Date:".date("m/d/Y H:i:s",time())."</div><div class='alert alert-info text-center'><h4><b>Record a trip Logs</b></h4></div>";

			$html.="<table class='table table-bordered' cellspacing='10' cellpadding='20' width='100%'>
					<tr>
						<th style='padding:0.3%;' width='14.28%'>Date Of Service</th>
						<th style='padding:0.3%;' width='14.28%'>From Location</th>
						<th style='padding:0.3%;' width='14.28%'>To Location</th>
						<th style='padding:0.3%;' width='14.28%'>Total Miles</th>
						<th style='padding:0.3%;' width='14.28%'>Comment</th>
						<th style='padding:0.3%;' width='14.28%'>Created By</th>
						<th style='padding:0.3%;' width='14.28%'>Created On</th>
				   </tr>";
			foreach($data as $data){
                            
                                $mlog_choose_indid_id="";
                                $flag = 0;
                                if(!empty($data['trip_choose_individual_id']) && $data['trip_choose_individual_id'] !='Array'){
                                    $implode = explode(",",$data['trip_choose_individual_id']);

                                    for($i = 0; $i < count($implode); $i++){
                                        if($flag > 0){
                                            $addComma = " , ";
                                        }
                                        else{
                                            $addComma = "";
                                        };
                                        $indidData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$implode[$i]);
                                        $mlog_choose_indid_id .=$addComma.ucwords($indidData['agency_first_name']." ".$indidData['agency_last_name']);

                                        $flag++;
                                    }
                                }else{
                                        $indidData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$data['trip_individual_id']);
                                        $mlog_choose_indid_id =ucwords($indidData['agency_first_name']." ".$indidData['agency_last_name']);
                                }
                            
                            
				$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$data['trip_added_user']);
				$html.="<tr>
							<td style='padding:0.3%;'>".formatDate($data['trip_service_date'])."</td>
							<td style='padding:0.3%;'>".ucwords($data['trip_from_location'])."</td>";
                                                        if($data['chosse_your_trip'] == 0 || $data['chosse_your_trip'] == 1 || $data['chosse_your_trip'] == 2){
                                                            $loaction ="";
                                                            $loaction .= $data['trip_to_location'];
                                                        }else{
                                                            $loaction="";
                                                            $j=1;
                                                            for($k=1;$k<=7;$k++){
                                                                $multloc= "trip_to_location".$k;
                                                                if(!empty($data[$multloc])){
                                                                    $loaction .=  "<strong>".$j." - </strong>".$data[$multloc]."<br>";
                                                                    $j++;
                                                                }
                                                            }
                                                        }
							$html.="<td style='padding:0.3%;'>".ucwords($loaction)."</td>
							<td style='padding:0.3%;'>".$data['trip_total_miles']."</td>
							<td style='padding:0.3%;'>".$data['trip_activity_description']."</td>
							<td style='padding:0.3%;'>".ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."</td>
							<td style='padding:0.3%;'>".formatDateTimeNew($data['trip_added_date'])."</td>
				  	  </tr>
					  <tr>
						    <td colspan=7 style='padding:0.3%;border:0px;'><b>Individual : &nbsp;&nbsp;</b>".$mlog_choose_indid_id."</td>
					  <tr>
					  <tr><td colspan='7'>&nbsp;</td></tr>";
			}
			$html.="</table>";
			if($ids=="All"){
				$html.="<pagebreak />";
			}
		}else{
			$html.= "";
		}
		return $html;
	}
      // Diffrent Reports
	public function ratreportsAction(){
		global $healthSession;
		$router=$pdfTitle="";
                $formid =26;
                $formData = $this->getRequest()->getPost();
                $html="";
		$router='front_view_all_record_atrip';
                if(!empty($formData['records'])){
                    $ids=implode(",",$formData['records']);
                }
                else{
                    $ids="All";
                }
                // Daily Activity Documentation  Logs
                $extra=array();
                $html.=$this->_rat_all_log($ids,$formid,$extra);
                $pdfTitle=$this->view->site_configs['site_name']." | Record a trip  logs";
                if(!empty($html)){
                    require_once ROOT_PATH.'/private/mpdf/mpdf.php';
                    $mpdf=new mPDF('utf-8', 'A4-L');
                    $stylesheet = file_get_contents(APPLICATION_URL.'/public/plugins/bootstrap/css/bootstrap.css');
                    $mpdf->SetTitle($pdfTitle);
                    $mpdf->WriteHTML($stylesheet,1);
                    $mpdf->WriteHTML($html,2);
                    $mpdf->Output();
                    exit();
                }
                else{
                    global $healthSession;
		    $healthSession->errorMsg="No Logs Found.";
                    $this->_helper->getHelper("Redirector")->gotoRoute(array(),$router);
                    //$healthSession->errorMsg="No logs found.";
                }
		
	}
        
 //03 July 18       
    public function recordatripreportsAction(){
		$formData = $this->getRequest()->getPost();
		$router = 'front_view_all_record_atrip';
		if(!empty($formData['records'])){
		   $ids=implode(",",$formData['records']);
	    }else{
		   $ids="All";
		}
		ini_set('memory_limit','256M');
        ini_set('max_execution_time', 300);
		$userCond="";
		if($this->view->user->agency_user_type!="Agency"){ $userCond="trip_added_user='".$this->view->user->agency_id."' and ";}
		if($ids!=="All"){
			$data=$this->SuperModel->Super_Get("_uhs_record_a_trip","trip_id In(".$ids.")","fetchAll");
		}
		//~ else{
			//~ $data=$this->SuperModel->Super_Get("_uhs_mileage_logs","".$userCond." trip_individual_id=".$indData['agency_id']." and MONTH(trip_service_date)=".$extra['month']." and YEAR(trip_service_date)='".$extra['year']."'","fetchAll");
		//~ }
		$html="";
		
		if(count($data)>0){
			$html .= '<table style= "width:100%">
					<tr>
						<td> 
							<div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
								<h4 class="magin0">Company Information</h4><br>
								<p><b>Company:</b>'. ucwords($this->view->user->agency_company_name).'</p>
								
								<p><b>Provider No:</b>'. $this->view->user->agency_provider_number.'</p>
								
								<p><b>Name:</b>'. ucwords($this->view->user->agency_first_name. '  ' . $this->view->user->agency_last_name).'</p>
								
								<p><b>Address:</b>'. ucwords($this->view->user->agency_address1 .', '. $this->view->user->agency_city.', '. $this->view->user->agency_state.', '. $this->view->user->agency_zip).'</p>
								
								<p><b>ContactContact:</b>'. $this->view->user->agency_contact.'</p>
							</div>
						</td>
					</tr>
				</table>	
							<br/>';
		       
            $html.="<div class='text-right'>Date:".date("m/d/Y H:i:s",time())."</div><div class='alert alert-info text-center'><h3><b>Record a trip Report</b></h3></div>";
			$html.="<table class='table table-bordered' cellspacing='10' cellpadding='20' width='100%'>
					<tr>
						<th style='padding:0.3%;' width='14.28%'>Date Of Service</th>
						<th style='padding:0.3%;' width='14.28%'>From Location</th>
						<th style='padding:0.3%;' width='14.28%'>To Location</th>
						<th style='padding:0.3%;' width='14.28%'>Total Miles</th>
						<th style='padding:0.3%;' width='14.28%'>Comment</th>
						<th style='padding:0.3%;' width='14.28%'>Created By</th>
						<th style='padding:0.3%;' width='14.28%'>Created On</th>
				   </tr>";
			foreach($data as $data){
				
				$mlog_choose_indid_id="";
				$flag = 0;
				if(!empty($data['trip_choose_individual_id']) && $data['trip_choose_individual_id'] !='Array'){
					$implode = explode(",",$data['trip_choose_individual_id']);

					for($i = 0; $i < count($implode); $i++){
						if($flag > 0){
							$addComma = " , ";
						}
						else{
							$addComma = "";
						};
						$indidData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$implode[$i]);
						$mlog_choose_indid_id .=$addComma.ucwords($indidData['agency_first_name']." ".$indidData['agency_last_name']);

						$flag++;
					}
				}else{
						$indidData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$data['trip_individual_id']);
						$mlog_choose_indid_id =ucwords($indidData['agency_first_name']." ".$indidData['agency_last_name']);
				}
                                
				$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$data['trip_added_user']);
				$html.="<tr>
							<td style='padding:0.3%;'>".formatDate($data['trip_service_date'])."</td>
							<td style='padding:0.3%;'>".ucwords($data['trip_from_location'])."</td>";
                                                        if($data['chosse_your_trip'] == 0 || $data['chosse_your_trip'] == 1 || $data['chosse_your_trip'] == 2){
                                                            $loaction ="";
                                                            $loaction .= $data['trip_to_location'];
                                                        }else{
                                                            $loaction="";
                                                            $j=1;
                                                            for($k=1;$k<=7;$k++){
                                                                $multloc= "trip_to_location".$k;
                                                                if(!empty($data[$multloc])){
                                                                    $loaction .=  "<strong>".$j." - </strong>".$data[$multloc]."<br>";
                                                                    $j++;
                                                                }
                                                            }
                                                        }
							$html.="<td style='padding:0.3%;'>".ucwords($loaction)."</td>
							<td style='padding:0.3%;'>".$data['trip_total_miles']."</td>
							<td style='padding:0.3%;'>".$data['trip_activity_description']."</td>
							<td style='padding:0.3%;'>".ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."</td>
							<td style='padding:0.3%;'>".formatDateTimeNew($data['trip_added_date'])."</td>
				  	  </tr>	
				  	  <tr>
                            <td colspan=7 style='padding:0.3%;border:0px;'><b>Individual : &nbsp;&nbsp;</b>".$mlog_choose_indid_id."</td>
                      <tr>
                      <tr><td colspan='7'>&nbsp;</td></tr>";
			}
	    $html.="</table>";	
		if(!empty($html)){
			ini_set('max_execution_time', 300);
			ini_set("memory_limit","500M");
			require_once ROOT_PATH.'/private/mpdf/mpdf.php';
			$mpdf=new mPDF('utf-8', 'A4-L');
			$stylesheet = file_get_contents(APPLICATION_URL.'/public/plugins/bootstrap/css/bootstrap.css');
			$mpdf->SetTitle($pdfTitle);
			$mpdf->WriteHTML($stylesheet,1);
			$mpdf->WriteHTML($html,2);
			$mpdf->Output();
			exit();
		}else{
			$healthSession->errorMsg="No logs found.";
			$this->_helper->getHelper("Redirector")->gotoRoute(array(),$router);
		}
	}else{
			$html.= "<h4><center><strong><i> No DATA FOUND </strong></i></center></h4>";
		}
	}   
        
        
            public function getrecordatripAction(){
		if(check_is_ajax($this->_request)){
			$this->_redirect(APPLICATION_URL);
		}
		$subuser=$dstarts=$dends=$wcode="";
		if(isset($_REQUEST['subuser']) && !empty($_REQUEST['subuser'])){
			$subuser=$_REQUEST['subuser'];
		}
		if(isset($_REQUEST['county']) && !empty($_REQUEST['county'])){
			$county=$_REQUEST['county'];
		}
		if(isset($_REQUEST['dstarts']) && !empty($_REQUEST['dstarts'])){
			$dstarts=$_REQUEST['dstarts'];
		}
		if(isset($_REQUEST['dends']) && !empty($_REQUEST['dends'])){
			$dends=$_REQUEST['dends'];
		}
		if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
			$month=$_REQUEST['month'];
		}
		if(isset($_REQUEST['year']) && !empty($_REQUEST['year'])){
			$year=$_REQUEST['year'];
		}	
                $this->dbObj = Zend_Registry::get('db');
		$aColumns = array('trip_id','trip_added_user','trip_agency_id','trip_individual_id','trip_service_date','trip_from_location','trip_to_location','trip_total_miles','trip_activity_description','trip_added_date','trip_from_latitude','trip_from_longitude','trip_to_latitude','trip_to_longitude','trip_starting_mileage','trip_remaining_mileage','trip_modified','trip_ending_mileage','trip_modified_by','trip_modified','chosse_your_trip','trip_to_location1','trip_to_location2','trip_to_location3','trip_to_latitude1','trip_to_latitude2','trip_to_latitude3','trip_to_latitude4','trip_to_latitude5','trip_to_latitude6','trip_to_latitude7','trip_to_longitude1','trip_to_longitude2','trip_to_longitude3','trip_to_longitude4','trip_to_longitude5','trip_to_longitude6','trip_to_longitude7','trip_choose_ci_id','trip_choose_individual_id','trip_start_time','trip_end_time','trip_total_service_time','trip_code','trip_group_code');
		$sIndexColumn = 'trip_id';
		$sTable = '_uhs_record_a_trip';
		$sLimit = "";
		if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' ){
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );
		}
		$sOrder = "";
		if ( isset( $_GET['iSortCol_0'] ) )
		{
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
			{
				if ( $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
				{
					$sOrder .= "".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".
						($_GET['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";
				}
			}
			
			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ){
				$sOrder = "";
			}
		}
		$sWhere = "";
		if ( isset($_GET['sSearch']) and $_GET['sSearch'] != "" ){
			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ )
			{
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET["sSearch"]."%' OR "; // NEW CODE
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}
		for ( $i=0 ; $i<count($aColumns) ; $i++ )
		{
			if ( isset($_GET['bSearchable_'.$i]) and $_GET['bSearchable_'.$i] == "true" and $_GET['sSearch_'.$i] != '' )
			{
				if ( $sWhere == "" )
				{
					$sWhere = "WHERE ";
				}
				else
				{
					$sWhere .= " AND ";
				}
				$sWhere .= "".$aColumns[$i]." LIKE '%".$_GET['sSearch_'.$i]."%' ";
			}
		}
		
		if(empty($subuser)){
                    
			$indParentUsers="";
			if($this->view->user->agency_user_type=="Agency"){
                $agency_id=$this->view->user->agency_id;
				$systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_user_agency_id=".$this->view->user->agency_id,"fetchAll",array("fields"=>"agency_id"));
				$systemUsers[count($systemUsers)]['agency_id']=$this->view->user->agency_id;
				$indParentUsers=implode_r(",",$systemUsers);
				if($sWhere){
					$sWhere.=" and trip_added_user IN(".$indParentUsers.") and trip_agency_id=".$agency_id.""; 
				}
				else{
					$sWhere.=" where trip_added_user IN(".$indParentUsers.") and trip_agency_id=".$agency_id.""; 
				}
                                
			}
			else{
				$indParentUsers=$this->view->user->agency_id;
				$agency_user_agency_id=$this->view->user->agency_user_agency_id;
				if($sWhere){
					$sWhere.=" and trip_added_user IN(".$indParentUsers.") and trip_agency_id=".$agency_user_agency_id."";
				}
				else{
					$sWhere.=" where trip_added_user IN(".$indParentUsers.") and trip_agency_id=".$agency_user_agency_id.""; 
				}
                            
			}
		}
		else{
			if($sWhere){
               $sWhere.=" and trip_added_user IN(".$subuser.")"; 
            }else{
               $sWhere.=" where trip_added_user IN(".$subuser.")";
            }
		}
		
		if(!empty($dstarts)){
			$sWhere.=" and DATE(trip_service_date) >='".$dstarts."'";
		}
		if(!empty($dends)){
			$sWhere.=" and DATE(trip_service_date) <='".$dends."'";
		}
		if(!empty($month)){
			$sWhere.=" and MONTH(trip_service_date)='".$month."'";
		}
		if(!empty($year)){
			$sWhere.=" and YEAR(trip_service_date)='".$year."'";
		}
		if(!empty($id) && $id!=0){
			$sWhere.=" and trip_id=".$id;
		}
		$indUsers="";
        if(!empty($county)){
			$systemUsers=$this->SuperModel->Super_Get("_uhs_agency","agency_county='".$county."'","fetchAll",array("fields"=>"agency_id"));
			if(count($systemUsers) > 0){
				$indUsers=implode_r(",",$systemUsers);			
				$sWhere.=" and trip_individual_id IN(".$indUsers.")"; 
			}else{
				$sWhere.=" and trip_individual_id IN(0)";
			}
		}
		if(empty($month) && empty($year) && empty($dstarts) && empty($dends) && empty($county) && empty($subuser)){
			if(!empty($sWhere)){
				$sWhere.=" and MONTH(trip_added_date)=MONTH(CURDATE()) and YEAR(trip_added_date)=YEAR(CURDATE()) group by trip_group_code";
			}else{
				$sWhere.=" where MONTH(trip_added_date)=MONTH(CURDATE()) and YEAR(trip_added_date)=YEAR(CURDATE()) group by trip_group_code";
			}
        }else{
			if(!empty($sWhere)){
                     $sWhere.=" group by trip_group_code"; 
			}else{
			   $sWhere.=" where group by trip_group_code"; 
			}
		}
		
		/*if(empty($sOrder)){
			$sOrder.="order by trip_added_date DESC, trip_modified DESC";
		}*/
		//prd($sWhere);
		$sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
 		$qry = $this->dbObj->query($sQuery)->fetchAll();
 	   // prd($qry);
		$sQuery = "SELECT FOUND_ROWS() as fcnt";
		$aResultFilterTotal =  $this->dbObj->query($sQuery)->fetchAll(); 
		$iFilteredTotal = $aResultFilterTotal[0]['fcnt'];
		$sQuery = "SELECT COUNT(`".$sIndexColumn."`) as cnt FROM $sTable ";
		$rResultTotal = $this->dbObj->query($sQuery)->fetchAll(); 
		$iTotal = $rResultTotal[0]['cnt'];
		$output = array(
 				"iTotalRecords" => $iTotal,
				"iTotalDisplayRecords" => $iFilteredTotal,
				"aaData" => array()
			);
		$j=0;
		//$permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
		foreach($qry as $row1){
			//prd($row1);
			$creatorData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['trip_added_user']."'","fetch");
			$cidatas=$this->SuperModel->Super_Get("_uhs_vehicle","ve_id='".$row1['trip_choose_ci_id']."'","fetch");


                        //$cidatas=$this->SuperModel->Super_Get("_uhs_car_inspection","ci_id='".$row1['trip_choose_ci_id']."'","fetch");
                        $modifierData=array();
			if($row1['trip_modified_by']!=0){
				$modifierData=$this->SuperModel->Super_Get("_uhs_agency","agency_id='".$row1['trip_modified_by']."'","fetch");
			}
			$row=array();
 			$row[] = $j+1;
			$row[]='<input class="elem_ids checkboxes" type="checkbox" name="records['.$row1[$sIndexColumn].']"  value="'.$row1[$sIndexColumn].'">';
			$row[]=formatDate($row1['trip_service_date']); 
			$row[]=$row1['trip_code'];
			$Flat="'".$row1['trip_from_latitude']."'";
			$Flong="'".$row1['trip_from_longitude']."'";
			$From="'".trim(preg_replace('/\s\s+/', ' ',$row1['trip_from_location']))."'";
			$row[]=ucwords($row1['trip_from_location']).'<i class="fa fa-map-marker markers pull-right" title="View Address on Map" onclick="showMap('.$Flat.','.$Flong.','.$From.');"></i>';
			
			if($row1['chosse_your_trip'] == 1 || $row1['chosse_your_trip'] == 2 || $row1['chosse_your_trip'] == 0){
				$Tlat="'".$row1['trip_to_latitude']."'";
				$Tlong="'".$row1['trip_to_longitude']."'";
				$To="'".trim(preg_replace('/\s\s+/', ' ',$row1['trip_to_location']))."'";
				$row[]=ucwords($row1['trip_to_location']).'<i class="fa fa-map-marker markers pull-right" title="View Address on Map" onclick="showMap('.$Tlat.','.$Tlong.','.$To.');"></i>';
				$row[]=ucwords($row1['trip_to_location']).'<i class="fa fa-map-marker markers" style="padding-left:10px;" title="View Address on Map" onclick="showMap('.$Tlat.','.$Tlong.','.$To.');"></i>';
			} elseif($row1['chosse_your_trip'] == 3){
				$Tlat1="'".$row1['trip_to_latitude1']."'";
				$Tlong1="'".$row1['trip_to_longitude1']."'";
				$To1="'".trim(preg_replace('/\s\s+/', ' ',$row1['trip_to_location1']))."'";
				$row[]= ucwords($row1['trip_to_location1']).'<i class="fa fa-map-marker markers pull-right" title="View Address on Map" onclick="showMap('.$Tlat1.','.$Tlong1.','.$To1.');"></i>';
				
				$loc1=ucwords($row1['trip_to_location1']).'<i class="fa fa-map-marker markers" style="padding-left:10px;" title="View Address on Map" onclick="showMap('.$Tlat1.','.$Tlong1.','.$To1.');"></i>';
				$Tlat2="'".$row1['trip_to_latitude2']."'";
				$Tlong2="'".$row1['trip_to_longitude2']."'";
				$To2="'".trim(preg_replace('/\s\s+/', ' ',$row1['trip_to_location2']))."'";
				
				$Tlat3="'".$row1['tripto_latitude3']."'";
				$Tlong3="'".$row1['trip_to_longitude3']."'";
				$To3="'".trim(preg_replace('/\s\s+/', ' ',$row1['trip_to_location3']))."'";
				
				$loc2=ucwords($row1['trip_to_location2']).'<i class="fa fa-map-marker markers" style="padding-left:10px;" title="View Address on Map" onclick="showMap('.$Tlat2.','.$Tlong2.','.$To2.');"></i>';
				$loc3=ucwords($row1['trip_to_location3']).'<i class="fa fa-map-marker markers" style="padding-left:10px;" title="View Address on Map" onclick="showMap('.$Tlat3.','.$Tlong3.','.$To3.');"></i>';
				
				$row[]= $loc1." , ".$loc2." , ".$loc3;
			}
			
			if($row1['chosse_your_trip'] == 1 || $row1['chosse_your_trip'] == 2 || $row1['chosse_your_trip'] == 0){
				$row[]=$row1['trip_total_miles'].'<form class="getdirform" method="get" target="iFrame">
					<input id="origin'.$row1['trip_id'].'" value="'.$row1['trip_from_location'].'" name="origin'.$row1['trip_id'].'" type="hidden"/>
					<input id="destination'.$row1['trip_id'].'" value="'.$row1['trip_to_location'].'" name="destination'.$row1['trip_id'].'" type="hidden"/>
					<input id="key" type="hidden" name="key" value="AIzaSyB7V6-2XNLLucSV2IlVU4ES40B7pmR3NzE">
					<input style="margin-top:12px;" class="btn btn-xs btn btn-success frm" type="button" value="Get Direction" onclick="showDirectionMap('.$row1['trip_id'].');"/>
					</form>';
			} else {
				$row[]=$row1['trip_total_miles'];
			} 
              
                        $chossetrip ="NA";
                        
                            if($row1['chosse_your_trip'] != 3){
                                $chossetrip=$row1['chosse_your_trip'];
                            }
                        
                         
                        $row[]=$chossetrip;
                        if(!empty($cidatas['ve_description'])){
                            $ve_description= " - ".$cidatas['ve_description'];
                        }
                        if(!empty($cidatas['ve_vin_number'])){
                            $vin_number= " - ".$cidatas['ve_vin_number'];
                        }
                 
                        $row[]=$cidatas['ve_licence_plate_number'].$ve_description.$vin_number; 
                        $row[]=$row1['trip_remaining_mileage'];
                        $row[]=number_format($row1['trip_ending_mileage']);
                        $mlog_choose_indid_id="";
                        $flag = 0;
                        if(!empty($row1['trip_choose_individual_id']) && $row1['trip_choose_individual_id'] !='Array'){
                            $implode = explode(",",$row1['trip_choose_individual_id']);
                            
                            for($i = 0; $i < count($implode); $i++){
                                if($flag > 0){
                                    $addComma = " , ";
                                }
                                else{
                                    $addComma = "";
                                };
                                $indidData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$implode[$i]);
                                $mlog_choose_indid_id .=$addComma.ucwords($indidData['agency_first_name']." ".$indidData['agency_last_name']);
                            
                                $flag++;
                            }
                        }else{
                                $indidData=$this->SuperModel->Super_Get("_uhs_agency","agency_id=".$row1['trip_individual_id']);
                                $mlog_choose_indid_id =ucwords($indidData['agency_first_name']." ".$indidData['agency_last_name']);
                        }
                       
                              
                        $row[]=$mlog_choose_indid_id;
                        $row[]=$row1['trip_start_time']; 
                        $row[]=$row1['trip_end_time'];
                        $row[]=$row1['trip_total_service_time'];
                        
		    $row[]=$row1['trip_activity_description'];
			$userType=printUserType($creatorData);
  			$row[]=ucwords($creatorData['agency_first_name']." ".$creatorData['agency_last_name'])."<br/>".$userType;
			$your_date = date("m/d/Y H:i:s", strtotime($row1['trip_added_date'])); 
			$row[]=$your_date;
			if(!empty($modifierData)){
				$userType=printUserType($modifierData);
				$row[]=ucwords($modifierData['agency_first_name']." ".$modifierData['agency_last_name'])."&nbsp;".$userType;
				$row[]=formatDateTimeNew($row1['trip_modified']);
			}else{
				$row[]="-";
				$row[]="-";
			}
			$type='"Mileage"';
			//if(($permissions=="Edit" || $permissions=="Both") && !isFormAssigned($formid,$indid) && date("m")==date("m",strtotime($row1['mlog_added_date']))){
			if(date("m")==date("m",strtotime($row1['trip_added_date']))){
				$url =  APPLICATION_URL."/edit-record-atrip/".$row1[$sIndexColumn];
				$row[]="<a style='margin-top:5px;' href='".$url."' class='btn btn-xs btn-default'>Edit</a>";
			}
			else{
				$row[]="<b>NA</b>";
			}
 			$output['aaData'][] = $row;
			$j++;
		}
                
		echo json_encode($output);
		exit();
	}
        
        public function viewallrecordatripAction(){
            global $healthSession; 
            $this->view->pageHeading = "Record a trip";
	}
        
        public function behavoirpdfprinthistoryAction() {

            $indid=$this->_getParam("indid");
            $formid=$this->_getParam("formid");
            $month=$this->_getParam("month");
            $year=$this->_getParam("year");
            $id=$this->_getParam("id");

            $html = $this->behavoirpdfhistoryHtmlAction($indid,$formid,$id,$month,$year);


            require_once ROOT_PATH.'/private/mpdf/mpdf.php';
                            $mpdf=new mPDF('utf-8', 'A4-L');
                            $stylesheet = file_get_contents(APPLICATION_URL.'/public/plugins/bootstrap/css/bootstrap.css');
                            //$stylesheet = file_get_contents(APPLICATION_URL . '/public/front_css/style_custom.css');
                            $mpdf->SetTitle('Behavoir Support Log');
                            $mpdf->WriteHTML($stylesheet,1);
                            $mpdf->WriteHTML($html,2);
                            $mpdf->Output(); 
                            exit();


            }
            public function behavoirpdfhistoryAction() {
                        $indid=$this->_getParam("indid");
                         $formid=$this->_getParam("formid");
                         $month=$this->_getParam("month");
                         $year=$this->_getParam("year");
                         $id=$this->_getParam("id");

                         $html = $this->behavoirpdfhistoryHtmlAction($indid,$formid,$id,$month,$year);

                         $permissions=checkPermissions("individual",$indid,$this->view->user->agency_id);
                                $this->view->permissions=$permissions;
                                  if(empty($indid)){
                                          $healthSession->errorMsg="Invalid Access";
                                          $this->_helper->getHelper("Redirector")->gotoRoute(array(),"front_agency_dashboard");
                                  }
                global $healthSession;
                      if(!empty($html)){
                                        require_once ROOT_PATH.'/private/mpdf/mpdf.php';
                                    $mpdf=new mPDF('utf-8', 'A2');
                                    //$mpdf->showImageErrors = true;
                                        $stylesheet = file_get_contents(APPLICATION_URL.'/public/plugins/bootstrap/css/bootstrap.css');

                                        $mpdf->SetTitle('Behavoir Support Log');
                                        $mpdf->WriteHTML($stylesheet,1);
                                        $mpdf->WriteHTML($html,2);
                                       // $mpdf->Output('/home/xoomia/public_html/public/pdf/behavior.pdf','F'); 
                                        $mpdf->Output('/var/www/html/xoomia/branches/public/pdf/behavior.pdf','F'); 
                              //$mpdf->Output(); 

                                        //echo $html;
                                        //die;
                                //	echo "sdfsdf";

                    if($this->getRequest()->isPost()){
                            $data = $this->getRequest()->getPost();
                          
                $recipients = $data['msg_to'];
                $email_to = explode(',', $recipients);

                $count = count($email_to);
                 $config=array('auth'=>'login','username'=>'rv_test@xoomia.com','password'=>'rvtech@123');
                $transport=new Zend_Mail_Transport_Smtp('xoomia.com',$config);  


                $Mc = 1;
                foreach ($email_to as $toemail) {

                    if($Mc >= $count) 
                       {
                                $maildddd = str_replace(' ', '', $toemail);
                                $ReceiverName = str_replace(' ', '', $toemail);
                                        $mail = new Zend_Mail();
                                        $mail->setBodyHtml($data['msg_text']);
                                        $mail->setFrom('client@xoomia.com', 'xoomia.com');
                                        $mail->addTo($maildddd,$ReceiverName);
                                        $mail->setSubject($data['msg_subject']);
                                        //$content = file_get_contents("/home/xoomia/public_html/public/pdf/behavior.pdf"); 
                                        $content = file_get_contents("/var/www/html/xoomia/branches/public/pdf/behavior.pdf"); 
                                        $attachment = new Zend_Mime_Part($content);
                                        $attachment->type = 'application/pdf';
                                        $attachment->disposition = Zend_Mime::DISPOSITION_ATTACHMENT;
                                        $attachment->encoding = Zend_Mime::ENCODING_BASE64;
                                        $attachment->filename = 'behavior.pdf'; // name of file
                                        $mail->addAttachment($attachment);                  
                                        $transport->send($mail);
                                        echo 'done';
                             }  
                $Mc++;
                }


                    $healthSession->successMsg="Data has been email successfully";

                    $this->_helper->getHelper("Redirector")->gotoRoute(array("indid"=>$indid,"formid"=>$formid),"behavoir_supports_histroy");

                             }


			exit();
		}

            }
            public function behavoirpdfhistoryHtmlAction($indid,$formid,$id,$month,$year) {

		/* $indid=$this->_getParam("indid");
		 $formid=$this->_getParam("formid");
		 $id=$this->_getParam("id");*/

                $sltdate=$year."-".$month;
                    
                global $rotines,$time_array,$weekArray; $agency_id=$this->agency_id; 
                $SuperModel = new Application_Model_SuperModel();

                 $this->dbObj = Zend_Registry::get('db');
                    $aColumns = array('behavior_support_id','behavior_form_id','behavior_agency_id','behavior_individual_id','behavior_added_user','bahavior_heading','bahavior_description','bahavior_selection','bahavior_shift','bahavior_added_date','bahavior_modified_by','bahavior_modified_on', 'bahavior_shift_1', 'bahavior_shift_2', 'bahavior_shift_3');

                    $sIndexColumn = 'behavior_support_id';
                    $sTable = '_uhs_behavior_support_log';
                    $sLimit = "";
                    $sWhere.=" where behavior_individual_id='".$indid."'"; 
                    $sQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumns))." FROM  $sTable $sWhere $sOrder $sLimit";
                    $qry = $this->dbObj->query($sQuery)->fetchAll();

                 $agencyDataid = $this->dbObj->query("select * from _uhs_agency where agency_id =".$indid)->fetchAll();
                 $spanData = $this->dbObj->query("select * from _uhs_spend_dates where agency_id=".$indid." AND spend_status = 1")->fetch();
                   if(isset($spanData)){ 
                                    if(!empty($spanData['spend_from_date']) && !empty($spanData['spend_to_date'])){
                                       $exlpode_from_date = explode("/",$spanData['spend_from_date']);
                                                           $spend_from_date =  $exlpode_from_date[1]."/". $exlpode_from_date[0]."/". $exlpode_from_date[2];
                                                           $exlpode_to_date = explode("/",$spanData['spend_to_date']);
                                                           $spend_to_date =  $exlpode_to_date[1]."/". $exlpode_to_date[0]."/". $exlpode_to_date[2];
                                                           $date =  $spend_from_date." - ".$spend_to_date;
                                    }else{ $date = "NA";}
                                }else{ $date =  "NA";}
                 $agencyData = $this->dbObj->query("select * from _uhs_agency where agency_id =".$agencyDataid[0]['agency_user_agency_id'])->fetchAll();

                if(!empty($agencyDataid[0]['agency_address1']) && !empty($agencyDataid[0]['agency_city']) && !empty($agencyDataid[0]['agency_state']) && !empty($agencyDataid[0]['agency_zip'])){
                                $iadd = ucwords($agencyDataid[0]['agency_address1'].",".$agencyDataid[0]['agency_city'].",".$agencyDataid[0]['agency_state'].",".$agencyDataid[0]['agency_zip']);

                        }else{ $iadd = "NA";}

                $name = $agencyData[0]['agency_first_name']." ".$agencyData[0]['agency_last_name'];

                 if(!empty($agencyData[0]['agency_address1']) && !empty($agencyData[0]['agency_city']) && !empty($agencyData[0]['agency_state']) && !empty($agencyData[0]['agency_zip'])){

                     $address = ucwords($agencyData[0]['agency_address1'].",".$agencyData[0]['agency_city'].",".$agencyData[0]['agency_state'].",".$agencyData[0]['agency_zip']);

                    }else{ $address = "NA";} 

                $anme = $agencyDataid[0]['agency_first_name'].' '.$agencyDataid[0]['agency_last_name'];

                $html = "";
                $html .='<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 profile-container"><div class="clearfix"></div>';

                 //~ $html .='<div class="well">
                        //~ <div class="col-xs-5">
                            //~ <h4 class="magin0">Company Information</h4><br/>
                            //~ <div class="col-xs-2">';

                                                  //~ $html .='<img class="img-responsive" src="'.HTTP_AGENCY_IMG_PATH.'/160/default-icon.png" alt="pharmacy" />';

                        //~ $html .='</div>
                        //~ <div class="col-xs-8">
                        //~ <p style="font-size:12px;"><b>Company Name:</b>'.$agencyData[0]["agency_company_name"].'</p>
                        //~ <p style="font-size:12px;"><b>Provider No:</b>'.$agencyData[0]["agency_provider_number"].'</p>
                        //~ <p style="font-size:12px;"><b>Name:</b>'.$name.'</p>
                        //~ <p style="font-size:12px;"><b>Address: </b>'.$address.'</p>
                        //~ <p style="font-size:12px;"><b>Contact: </b>'.$agencyData[0]["agency_contact"].'</p>
                            //~ </div>
                        //~ </div>
                        //~ <div class="col-xs-5">
                            //~ <h4 class="magin0">Individual Information</h4><br/>
                            //~ <div class="col-xs-2">';

                                          //~ $html .='<img class="img-responsive" src="'.HTTP_AGENCY_IMG_PATH.'/160/default-icon.png" alt="pharmacy" />';

                            //~ $html .='</div>
                            //~ <div class="col-xs-8">
                //~ <p style="font-size:12px;"><b>Individual Id:</b>'.$agencyDataid[0]["agency_individual_assign_code"].'</p>
                //~ <p style="font-size:12px;"><b>Medicaid Number:</b>'.$agencyDataid[0]["agency_medicaid_number"].'</p>
                //~ <p style="font-size:12px;"><b>Name:</b>'.$anme.'</p>
                //~ <p style="font-size:12px;"><b>Address: </b>'.$iadd.'</p>
                //~ <p style="font-size:12px;"><b>Individual Service Plan: </b>'.$date.'</p>
                //~ <p style="font-size:12px;"><b>Contact: </b>'.$agencyDataid[0]["agency_contact"].'</p>
                //~ </div>
                        //~ </div>
                        //~ <div class="clearfix"></div>
                   //~ </div>';

                   $html .= '<div class="well"><table style= "width:100%">
                                                        <tr>
                                                                <td> 
                                                                        <div class="col-xs-5">
                                                                                <h4 class="magin0">Company Information</h4><br>
                                                                                <div class="col-xs-2"><img class="img-responsive" src="'.HTTP_AGENCY_IMG_PATH.'/160/default-icon.png" alt="pharmacy" /></div>
                                                                                <div class="col-xs-8"><p><b>Company Name:</b>'. $agencyData[0]["agency_company_name"].'</p>

                                                                                <p><b>Provider No:</b>'. $agencyData[0]["agency_provider_number"].'</p>

                                                                                <p><b>Name:</b>'.$name.'</p>

                                                                                <p><b>Address:</b>'.$address.'</p>

                                                                                <p><b>Contact:</b>'. $agencyData[0]["agency_contact"].'</p></div>
                                                                        </div>
                                                                </td>

                                                                <td>
                                                                        <div class="col-xs-5">
                                                                                <h4 class="magin0">Individual Information</h4><br>
                                                                            <div class="col-xs-2"><img class="img-responsive" src="'.HTTP_AGENCY_IMG_PATH.'/160/default-icon.png" alt="pharmacy" /></div>
                                                                                <div class="col-xs-8"><p><b>Individual Id:</b>'.$agencyDataid[0]["agency_individual_assign_code"].'</p>
                                                                                <p><b>Medicaid Number: </b>'.$agencyDataid[0]["agency_medicaid_number"].'</p>
                                                                                <p><b>Name: </b>'.$anme.'</p>
                                                                                <p><b>Address:</b>'.$iadd.'</p>
                                                                                <p><b>Contact:</b>'.$agencyDataid[0]["agency_contact"].'</p>
                                                                                <p><b>Individual Plan Dates:</b>'.$date.'</p></div>
                                                                        </div>	
                                                                </td>
                                                        </tr>
                                                </table></div>';	

                $html .='<div class="col-lg-9 col-md-9 col-sm-9 col-xs-12 text-left padding0">
                    <span style="color:#13bca6;">"Y"</span>=Yes &nbsp; 
                    <span style="color:#13bca6;">"N"</span>=No &nbsp; 
                    <span style="color:#13bca6;">"NA"</span>=Not Available &nbsp; 
                    <span style="color:#13bca6;">"O"</span>=Other &nbsp; 
                </div>';

                  $html .='<div class="clearfix">&nbsp;</div><div class="col-xs-12 table-responsive profile-container cstmcss" style="padding-left:0;">
                     <table  width="100%" cellpadding="0" cellspacing="0" class="">
                        <tbody>
                          <tr>
                            <td><table style="border:1px solid #000;margin-bottom:10px;" width="100%" cellpadding="100" cellspacing="100" class="boldfont">
                                <tr>
                                  <td style="width:30%">'.ucwords($agencyData[0]['agency_company_name']).'</td>
                                  <td style="width:70%">'.date("F/Y", strtotime($sltdate)).'</td>
                                </tr>
                              </table></td>
                          </tr>';


                  if($qry!="" && count($qry)>0){
                       foreach($qry as $supportdata){

                  $assignedby = $supportdata['behavior_added_user'];
                   $agencyDataid = $this->dbObj->query("select * from _uhs_agency where agency_id =".$assignedby)->fetchAll();

                          $html .='<tr class="toprow" style="border-top:1px solid #000;">
                            <td>
                                <table style="border-top:1px solid;" width="100%" cellpadding="0" cellspacing="0" class="bordertopmar textuppercase">
                                      <tr>
                              <td class="lefttr">
                                                  <table width="100%" border="0" cellpadding="0" cellspacing="0">
                   <tr class="boldfont">

                   <td width="100%" colspan="2" valign="top">Heading:'.$supportdata['bahavior_heading'].'</td></tr>
                                     <tr>
                               <td width="100%" valign="top"></td>
                                                <td valign="top"></td></tr>
                <tr><td colspan="2"> Support:'.$supportdata['bahavior_description'].'</td></tr>

                   </table></td>
                   <td class="verticle_align_top righttr">
                   <table width="100%" border="0" cellpadding="0" cellspacing="0" class="">
                        <tr class="marborderclass" style="border-top:none !important">
                            <td class="marborderrightclass" style="width:7%;"> Shift </td>';

                      for($j=1;$j<=date('t',strtotime($sltdate));$j++){
                                $date=date("Y",strtotime($sltdate))."-".date('m',strtotime($sltdate))."-".$j;

                           if($j==date('d',strtotime($sltdate))){$tod='today_date_class';
                                             }
                              else{ $tod='';}
                      $html .='<td class="marborderrightclass '.$tod.'">'.$j.'<br/> <small style="font-size:50% !important;">('.date('D',strtotime($date)).')</small> </td>';
                      }
                    $html .='</tr>';

                if($supportdata['bahavior_shift'] == 'none' or $supportdata['bahavior_shift'] == null) { 
                  $html .='<tr><td class="marborderrightclass" style="width:7%;"> </td>';
                   for($j=1;$j<=date('t',strtotime($sltdate));$j++){
                                $date=date("Y" ,strtotime($sltdate))."-".date('m' ,strtotime($sltdate))."-".$j;

                            if($j==date('d', strtotime($sltdate))){$tod='today_date_class';
                                            }
                              else{ $tod='';} 
                      $html .='<td class="marborderrightclass"> &nbsp; </td>';
                                        }
                  $html .='</tr>';
                 }
                if($supportdata['bahavior_shift'] == 'none') { 
                $time = "";
                $html .='<tr><td class="marborderrightclass" style="width:7%;">'.$time.'</td>';
                for($j=1;$j<=date('t',strtotime($sltdate));$j++){
                                $date=date("Y",strtotime($sltdate))."-".date('m',strtotime($sltdate))."-".$j;
                                 if($j < 10) {
                                      $datedb =date("Y" ,strtotime($sltdate))."-".date('m' ,strtotime($sltdate))."-0".$j;
                                 }
                                 else {
                                     $datedb =date("Y" ,strtotime($sltdate))."-".date('m' ,strtotime($sltdate))."-".$j;
                                 }
                         if($j==date('d',strtotime($sltdate))){$tod='today_date_class';
                     } else{ $tod='';} 

                    $aColumnss = array('behavior_services_code' , 'bahavior_counter' , 'behavior_services_date');
                    $ssTable = '_uhs_behavior_support_services';
                   $sWhere="where behavior_services_date='".$datedb."' and behavior_support_id = '".$supportdata['behavior_support_id']."' and behavior_services_time = '".$time."'"; 
                      $ssQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumnss))." FROM  $ssTable $sWhere";
                    $qryd = $this->dbObj->query($ssQuery)->fetchAll();
                if($j==date('d',strtotime($sltdate))) { 
                        $coden = $qryd[0]['behavior_services_code'];
                 if($coden) {
                       $codeC = "#867d70";
                  }
                 elseif($coden == "") {
                  $codeC = "#fff";
                 }

                $html .='<td class="marborderrightclass"  style="background-color:'.$codeC.';color: #fff;">';

                 if(empty($qryd[0]['behavior_services_code'])) {
                   }
                   else {
                      if($qryd[0]['behavior_services_code'] !='counter') {
                          $html .= $qryd[0]['behavior_services_code'];
                      }
                      else { 
                 $html .=$qryd[0]["bahavior_counter"];
                      }
                   }
                $html .='</td>';
                 } else { 
                                $coden = $qryd[0]['behavior_services_code'];
                 if($coden) {
                       $codeC = "#867d70";
                  }
                 elseif($coden == "") {
                  $codeC = "#fff";
                 }
                 $html .='<td class="marborderrightclass"  style="background-color:'.$codeC.';color: #fff;">';
                     if($qryd[0]['behavior_services_code'] !='counter') {
                          $html .= $qryd[0]['behavior_services_code'];
                      }
                      else {
                        $html .= $qryd[0]['bahavior_counter']; 

                      }

                    $html .='</td>';
                      } 
                  }
                 $html .= '</tr>';
                }


                if($supportdata['bahavior_shift_1'] == '1') {   
                $time = $supportdata['bahavior_shift_1'];
                $html .='<tr><td class="marborderrightclass" style="width:7%;">'.$time.'</td>';
                for($j=1;$j<=date('t',strtotime($sltdate));$j++){
                                $date=date("Y",strtotime($sltdate))."-".date('m',strtotime($sltdate))."-".$j;
                                 if($j < 10) {
                                      $datedb =date("Y",strtotime($sltdate))."-".date('m',strtotime($sltdate))."-0".$j;
                                 }
                                 else {
                                     $datedb =date("Y",strtotime($sltdate))."-".date('m',strtotime($sltdate))."-".$j;
                                 }
                          if($j==date('d',strtotime($sltdate))){$tod='today_date_class';
                           } else{ $tod='';}
                   $aColumnss = array('behavior_services_code' , 'bahavior_counter');
                   $ssTable = '_uhs_behavior_support_services';
                   $sWhere="where behavior_services_date='".$datedb."' and behavior_support_id = '".$supportdata['behavior_support_id']."' and behavior_services_time = '".$time."'"; 
                      $ssQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumnss))." FROM  $ssTable $sWhere";
                    $qryd = $this->dbObj->query($ssQuery)->fetchAll();
                if($j==date('d',strtotime($sltdate))) { 
                $coden = $qryd[0]['behavior_services_code'];
                 if($coden) {
                       $codeC = "#867d70";
                  }
                 elseif($coden == "") {
                  $codeC = "#fff";
                 }
                $html .='<td class="marborderrightclass"  style="background-color:'.$codeC.';color: #fff;">'; 
                 if(empty($qryd[0]['behavior_services_code'])) {

                   }
                   else {
                    if($qryd[0]['behavior_services_code'] !='counter') { 
                      $html .= $qryd[0]['behavior_services_code'];
                           }
                      else { 
                  $html .= $qryd[0]['bahavior_counter'];
                   }
                   }
                $html .='</td>';
                   } else { 
                $coden = $qryd[0]['behavior_services_code'];
                 if($coden) {
                       $codeC = "#867d70";
                  }
                 elseif($coden == "") {
                  $codeC = "#fff";
                 }
                 $html .='<td class="marborderrightclass"  style="background-color:'.$codeC.';color: #fff;">'; 
                 if($qryd[0]['behavior_services_code'] !='counter') { 
                         $html .= $qryd[0]['behavior_services_code']; 
                     }
                      else { 
                          $html .= $qryd[0]['bahavior_counter'];
                    }
                   $html .='</td>';
                            } 
                      }
                  $html .='</tr>';
                if($supportdata['bahavior_shift_2'] != NULL) { 
                  $html .='<tr><td class="marborderrightclass" style="width:7%;">  </td>';
                   for($j=1;$j<=date('t',strtotime($sltdate));$j++){
                                $date=date("Y",strtotime($sltdate))."-".date('m',strtotime($sltdate))."-".$j;

                           if($j==date('d',strtotime($sltdate))){$tod='today_date_class';
                                           }
                              else{ $tod='';}
                      $html .='<td class="marborderrightclass"> &nbsp; </td>';
                                          }
                  $html .='</tr>';
                  } 
                 } 


                if($supportdata['bahavior_shift_2'] == '2') {   
                $time = $supportdata['bahavior_shift_2'];
                $html .='<tr><td class="marborderrightclass" style="width:7%;">'.$time.'</td>';
                for($j=1;$j<=date('t',strtotime($sltdate));$j++){
                                $date=date("Y",strtotime($sltdate))."-".date('m',strtotime($sltdate))."-".$j;
                                 if($j < 10) {
                                      $datedb =date("Y",strtotime($sltdate))."-".date('m',strtotime($sltdate))."-0".$j;
                                 }
                                 else {
                                     $datedb =date("Y",strtotime($sltdate))."-".date('m',strtotime($sltdate))."-".$j;
                                 }
                          if($j==date('d',strtotime($sltdate))){$tod='today_date_class';
                           } else{ $tod='';}
                   $aColumnss = array('behavior_services_code' , 'bahavior_counter');
                   $ssTable = '_uhs_behavior_support_services';
                   $sWhere="where behavior_services_date='".$datedb."' and behavior_support_id = '".$supportdata['behavior_support_id']."' and behavior_services_time = '".$time."'"; 
                      $ssQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumnss))." FROM  $ssTable $sWhere";
                    $qryd = $this->dbObj->query($ssQuery)->fetchAll();
                if($j==date('d',strtotime($sltdate))) { 
                $coden = $qryd[0]['behavior_services_code'];
                 if($coden) {
                       $codeC = "#867d70";
                  }
                 elseif($coden == "") {
                  $codeC = "#fff";
                 }
                $html .='<td class="marborderrightclass"  style="background-color:'.$codeC.';color: #fff;">'; 
                 if(empty($qryd[0]['behavior_services_code'])) {

                   }
                   else {
                    if($qryd[0]['behavior_services_code'] !='counter') { 
                      $html .= $qryd[0]['behavior_services_code'];
                           }
                      else { 
                  $html .= $qryd[0]['bahavior_counter'];
                   }
                   }
                $html .='</td>';
                   } else { 
                $coden = $qryd[0]['behavior_services_code'];
                 if($coden) {
                       $codeC = "#867d70";
                  }
                 elseif($coden == "") {
                  $codeC = "#fff";
                 }
                 $html .='<td class="marborderrightclass"  style="background-color:'.$codeC.';color: #fff;">'; 
                 if($qryd[0]['behavior_services_code'] !='counter') { 
                         $html .= $qryd[0]['behavior_services_code']; 
                     }
                      else { 
                          $html .= $qryd[0]['bahavior_counter'];
                    }
                   $html .='</td>';
                            } 
                      }
                  $html .='</tr>';
                if($supportdata['bahavior_shift_3'] != NULL) { 
                  $html .='<tr><td class="marborderrightclass" style="width:7%;">  </td>';
                   for($j=1;$j<=date('t',strtotime($sltdate));$j++){
                                $date=date("Y",strtotime($sltdate))."-".date('m',strtotime($sltdate))."-".$j;

                           if($j==date('d',strtotime($sltdate))){$tod='today_date_class';
                                           }
                              else{ $tod='';}
                      $html .='<td class="marborderrightclass"> &nbsp; </td>';
                                          }
                  $html .='</tr>';
                  } 
                 } 


                if($supportdata['bahavior_shift_3'] == '3') { 

                if($supportdata['bahavior_shift_2'] == NULL) { 

                 $html .='<tr><td class="marborderrightclass" style="width:7%;">  </td>';
                    for($j=1;$j<=date('t',strtotime($sltdate));$j++){
                                $date=date("Y",strtotime($sltdate))."-".date('m',strtotime($sltdate))."-".$j;

                          if($j==date('d',strtotime($sltdate))){$tod='today_date_class';
                                        }
                              else{ $tod='';}
                     $html .='<td class="marborderrightclass"> &nbsp; </td>';
                                    }
                 $html .='</tr>';
                  } 


                $time = $supportdata['bahavior_shift_3'];
                $html .='<tr><td class="marborderrightclass" style="width:7%;">'.$time.'</td>';
                for($j=1;$j<=date('t',strtotime($sltdate));$j++){
                                $date=date("Y",strtotime($sltdate))."-".date('m',strtotime($sltdate))."-".$j;
                                 if($j < 10) {
                                      $datedb =date("Y",strtotime($sltdate))."-".date('m',strtotime($sltdate))."-0".$j;
                                 }
                                 else {
                                     $datedb =date("Y",strtotime($sltdate))."-".date('m',strtotime($sltdate))."-".$j;
                                 }
                          if($j==date('d',strtotime($sltdate))){$tod='today_date_class';
                           } else{ $tod='';}
                   $aColumnss = array('behavior_services_code' , 'bahavior_counter');
                   $ssTable = '_uhs_behavior_support_services';
                   $sWhere="where behavior_services_date='".$datedb."' and behavior_support_id = '".$supportdata['behavior_support_id']."' and behavior_services_time = '".$time."'"; 
                      $ssQuery = "SELECT SQL_CALC_FOUND_ROWS ".str_replace(" , ", " ", implode(", ", $aColumnss))." FROM  $ssTable $sWhere";
                    $qryd = $this->dbObj->query($ssQuery)->fetchAll();
                if($j==date('d')) { 
                $coden = $qryd[0]['behavior_services_code'];
                 if($coden) {
                       $codeC = "#867d70";
                  }
                 elseif($coden == "") {
                  $codeC = "#fff";
                 }
                $html .='<td class="marborderrightclass"  style="background-color:'.$codeC.';color: #fff;">'; 
                 if(empty($qryd[0]['behavior_services_code'])) {

                   }
                   else {
                    if($qryd[0]['behavior_services_code'] !='counter') { 
                      $html .= $qryd[0]['behavior_services_code'];
                           }
                      else { 
                  $html .= $qryd[0]['bahavior_counter'];
                   }
                   }
                $html .='</td>';
                   } else { 
                $coden = $qryd[0]['behavior_services_code'];
                 if($coden) {
                       $codeC = "#867d70";
                  }
                 elseif($coden == "") {
                  $codeC = "#fff";
                 }
                 $html .='<td class="marborderrightclass"  style="background-color:'.$codeC.';color: #fff;">'; 
                 if($qryd[0]['behavior_services_code'] !='counter') { 
                         $html .= $qryd[0]['behavior_services_code']; 
                     }
                      else { 
                          $html .= $qryd[0]['bahavior_counter'];
                    }
                   $html .='</td>';
                            } 
                      }
                  $html .='</tr>';
                 } 


                 $html .='</table></td>
                                  </tr>
                              </table></td>
                          </tr>
                          <tr class="'.$class.'">
                            <td><table  width="100%" border="0" cellpadding="0" cellspacing="0" class="">
                                <tbody>
                                  <tr>
                                    <td><table width="100%" border="0" cellpadding="0" cellspacing="0" class="">
                                        <tr>
                                          <td style="width:35%"></td>
                                          <td style="width:65%"> &nbsp;  </td>
                                        </tr>
                                      </table></td>
                                  </tr>
                                </tbody>
                              </table></td>
                          </tr>
                           <tr class="'.$class.'">
                            <td style="height:15px;"></td>
                           </tr>';
                           }}       

                           $html .='<tr>
                            <td style="height:15px;"></td>
                           </tr>
                        </tbody>
                     </table>';

                $html .='<table style="width: 100%">
                   <tr style="border-top: 2px solid">
                    <th>Documenting By</th>
                    </tr>';
                     foreach ( $agencyDataid as  $agencyData) { 
                     $html .='<tr>
                      <td>'.$agencyData["agency_first_name"].' '.$agencyData["agency_last_name"].'</br>
                        <span class="agcd">'.$agencyData["agency_user_type"].'</span>

                      </td>
                    </tr>';
                  } 

                $html .='</table>';

                     $html .='</div>
                   </div>
                   </div>
                   <div class="clearfix">&nbsp;</div>
                </div>
                </div>';
                         // die;

                $html .='<link href="http://localhost/xoomia/public/plugins/bootstrap/css/bootstrap.css" media="screen" rel="stylesheet" type="text/css" >';


                return $html;




        }
        
        
        public function setamendviewAction() {
            $indid = $this->_getParam("indid");
            $formid = $this->_getParam("formid");
            $status = $this->_getParam("status");
            $id = $this->_getParam("id");
           
            $posted_data['am_agency_id'] = $_SESSION['UHS_AUTH']['storage']->agency_id;
            $posted_data['am_indid'] = $indid;
            $posted_data['am_form_id'] = $formid;
            if(empty($status)){
                $posted_data['am_status'] = 1;
            }else{
                $posted_data['am_status'] = 0;
            }
            
            
            if(!empty($id)) {
                $isInserted = $this->SuperModel->Super_Insert("_uhs_amend_view", $posted_data, "am_id = $id");
            }
            else {
                $isInserted = $this->SuperModel->Super_Insert("_uhs_amend_view", $posted_data);
            }
            if ($isInserted->success) {
                $healthSession->successMsg = "Amend view has been updated successfully.";
            } else {
                $healthSession->errorMsg = $isInserted->message;
            }

            $res['status'] = 'true';
            echo json_encode($res);
            die;
    }
        public function setratioviewAction() {
            $indid = $this->_getParam("indid");
            $formid = $this->_getParam("formid");
            $status = $this->_getParam("status");
            $id = $this->_getParam("id");
           
            $posted_data['ratio_agency_id'] = $_SESSION['UHS_AUTH']['storage']->agency_id;
            $posted_data['ratio_indid'] = $indid;
            $posted_data['ratio_form_id'] = $formid;
            if(empty($status)){
                $posted_data['ratio_status'] = 1;
            }else{
                $posted_data['ratio_status'] = 0;
            }
            
            
            if(!empty($id)) {
                $isInserted = $this->SuperModel->Super_Insert("_uhs_ratio_view", $posted_data, "ratio_id = $id");
            }
            else {
                $isInserted = $this->SuperModel->Super_Insert("_uhs_ratio_view", $posted_data);
            }
            if ($isInserted->success) {
                $healthSession->successMsg = "Ratio view has been updated successfully.";
            } else {
                $healthSession->errorMsg = $isInserted->message;
            }

            $res['status'] = 'true';
            echo json_encode($res);
            die;
    }
}
